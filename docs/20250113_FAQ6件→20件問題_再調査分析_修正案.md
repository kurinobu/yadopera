# FAQ6ä»¶â†’20ä»¶å•é¡Œ å†èª¿æŸ»åˆ†æãƒ»ä¿®æ­£æ¡ˆ

**ä½œæˆæ—¥æ™‚**: 2025å¹´1æœˆ13æ—¥  
**ç›®çš„**: æ–°è¦ç™»éŒ²ç›´å¾Œã«FAQãŒ6ä»¶ã—ã‹è¡¨ç¤ºã•ã‚Œãªã„ãŒã€æ™‚é–“ã‚’ç½®ã„ã¦ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨20ä»¶è¡¨ç¤ºã•ã‚Œã‚‹å•é¡Œã®å†èª¿æŸ»åˆ†æã¨ä¿®æ­£æ¡ˆæç¤º  
**çŠ¶æ…‹**: ğŸ” **å†èª¿æŸ»åˆ†æå®Œäº†ã€ä¿®æ­£æ¡ˆæç¤ºå®Œäº†**

---

## 1. å•é¡Œã®å†ç¢ºèª

### 1.1 å ±å‘Šå†…å®¹

- **æ–°è¦ç™»éŒ²ç›´å¾Œ**: FAQãŒ6ä»¶ã—ã‹è¡¨ç¤ºã•ã‚Œãªã„
- **æ™‚é–“ã‚’ç½®ã„ã¦ãƒªãƒ­ãƒ¼ãƒ‰**: FAQãŒ20ä»¶è¡¨ç¤ºã•ã‚Œã‚‹
- **ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰å¾Œï¼‰**: APIã¯20ä»¶ã‚’è¿”ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

### 1.2 ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã®è©³ç´°ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰å¾Œï¼‰

```
âœ… FAQå–å¾—æˆåŠŸ: {count: 20, categories: {...}, data: Array(20)}
ğŸ“‹ FaqList: props.faqs received: {count: 20, categories: {...}, faqs: Array(20)}
ğŸ“‹ FaqList: total FAQs in props: 20
ğŸ” getFaqsByCategory(basic): found 8 items
ğŸ” getFaqsByCategory(facilities): found 5 items
ğŸ” getFaqsByCategory(location): found 1 items
ğŸ” getFaqsByCategory(trouble): found 6 items
```

**è©•ä¾¡**: 
- âœ… ãƒªãƒ­ãƒ¼ãƒ‰å¾Œã¯APIãŒ20ä»¶ã‚’æ­£ã—ãè¿”ã—ã¦ã„ã‚‹
- âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚‚20ä»¶ã‚’æ­£ã—ãå—ã‘å–ã£ã¦ã„ã‚‹
- âš ï¸ **å•é¡Œ**: æ–°è¦ç™»éŒ²ç›´å¾Œã¯6ä»¶ã—ã‹è¡¨ç¤ºã•ã‚Œãªã„

---

## 2. æ ¹æœ¬åŸå› ã®å†åˆ†æ

### 2.1 ã‚¿ã‚¤ãƒŸãƒ³ã‚°å•é¡Œã®ç¢ºå®š

**å•é¡Œã®æœ¬è³ª**:
1. **æ–°è¦ç™»éŒ²ç›´å¾Œ**: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ãŒã¾ã å®Œäº†ã—ã¦ã„ãªã„
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã¯6ä»¶ã—ã‹ç™»éŒ²ã•ã‚Œã¦ã„ãªã„ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ãŒé€”ä¸­ï¼‰
   - APIã¯6ä»¶ã‚’è¿”ã™
   - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯6ä»¶ã‚’è¡¨ç¤º

2. **æ™‚é–“ãŒçµŒã£ã¦ã‹ã‚‰ãƒªãƒ­ãƒ¼ãƒ‰**: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ãŒå®Œäº†
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã¯20ä»¶ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹
   - APIã¯20ä»¶ã‚’è¿”ã™
   - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯20ä»¶ã‚’è¡¨ç¤º

**è©•ä¾¡**: âœ… **ã‚¿ã‚¤ãƒŸãƒ³ã‚°å•é¡ŒãŒç¢ºå®š**

### 2.2 ãªãœ6ä»¶ãªã®ã‹ï¼Ÿ

**å¯èƒ½æ€§1: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ãŒé€”ä¸­ã§å¤±æ•—ã—ãŸ**
- ä¸€éƒ¨ã®FAQä½œæˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã€å‡¦ç†ãŒä¸­æ–­ã•ã‚ŒãŸ
- çµæœã¨ã—ã¦6ä»¶ã—ã‹ç™»éŒ²ã•ã‚Œã¦ã„ãªã„

**å¯èƒ½æ€§2: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ãŒã¾ã é€²è¡Œä¸­**
- ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ãŒéåŒæœŸã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹
- æ–°è¦ç™»éŒ²ç›´å¾Œã«FAQä¸€è¦§ã‚’å–å¾—ã—ãŸæ™‚ç‚¹ã§ã¯ã€ã¾ã 6ä»¶ã—ã‹ä½œæˆã•ã‚Œã¦ã„ãªã„
- ãã®å¾Œã€æ®‹ã‚Šã®14ä»¶ãŒä½œæˆã•ã‚Œã¦åˆè¨ˆ20ä»¶ã«ãªã£ãŸ

**å¯èƒ½æ€§3: é‡è¤‡ã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚‹ã‚¹ã‚­ãƒƒãƒ—**
- ä¸€éƒ¨ã®FAQãŒé‡è¤‡ã‚¨ãƒ©ãƒ¼ï¼ˆ`ValueError`ï¼‰ã§ã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸ
- çµæœã¨ã—ã¦6ä»¶ã—ã‹ç™»éŒ²ã•ã‚Œã¦ã„ãªã„

**è©•ä¾¡**: âš ï¸ **å¯èƒ½æ€§2ãŒæœ€ã‚‚æœ‰åŠ›**ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ãŒã¾ã é€²è¡Œä¸­ï¼‰

### 2.3 ç¾åœ¨ã®å®Ÿè£…ã®å•é¡Œç‚¹

#### 2.3.1 ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã®å®Ÿè£…

**å®Ÿè£…**: `backend/app/services/auth_service.py`

```python
@staticmethod
async def register_facility_async_faqs(
    facility_id: int,
    user_id: int,
    subscription_plan: str
):
    # FAQä¸€æ‹¬ä½œæˆï¼ˆ20ä»¶ï¼‰
    await FAQService(db).bulk_create_faqs(facility_id, faq_requests, user_id)
    await db.commit()
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
    await delete_cache_pattern(f"faq:list:*facility_id={facility_id}*")
    
    # 5ç§’å¾…ã£ã¦ã‹ã‚‰å†åº¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
    await asyncio.sleep(5)
    await delete_cache_pattern(f"faq:list:*facility_id={facility_id}*")
```

**å•é¡Œç‚¹**:
- ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ãŒéåŒæœŸã§å®Ÿè¡Œã•ã‚Œã‚‹
- å‡¦ç†ãŒå®Œäº†ã™ã‚‹ã¾ã§ã«æ™‚é–“ãŒã‹ã‹ã‚‹ï¼ˆ20ä»¶ã®FAQä½œæˆ + åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ç”Ÿæˆï¼‰
- æ–°è¦ç™»éŒ²ç›´å¾Œã«FAQä¸€è¦§ã‚’å–å¾—ã™ã‚‹ã¨ã€ã¾ã å‡¦ç†ãŒå®Œäº†ã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹

#### 2.3.2 FAQå–å¾—APIã®å®Ÿè£…

**å®Ÿè£…**: `backend/app/services/faq_service.py`

```python
async def get_faqs(
    self,
    facility_id: int,
    category: Optional[str] = None,
    is_active: Optional[bool] = None
) -> List[FAQResponse]:
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã‚‹
    cached_faqs = await get_cache(cache_key_str)
    if cached_faqs is not None:
        return [FAQResponse(**faq_dict) for faq_dict in cached_faqs]
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—
    query = select(FAQ).where(FAQ.facility_id == facility_id)
    # ...
    result = await self.db.execute(query)
    faqs = result.scalars().all()
    
    # æ–½è¨­ä½œæˆã‹ã‚‰30ç§’ä»¥å†…ã®å ´åˆã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜ã—ãªã„
    facility = await self.db.get(Facility, facility_id)
    if facility:
        time_since_creation = datetime.now(timezone.utc) - facility.created_at
        if time_since_creation < timedelta(seconds=30):
            return faq_responses  # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜ã—ãªã„
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
    await set_cache(cache_key_str, faq_dicts, FAQ_CACHE_TTL)
    return faq_responses
```

**å•é¡Œç‚¹**:
- æ–½è¨­ä½œæˆã‹ã‚‰30ç§’ä»¥å†…ã®å ´åˆã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜ã—ãªã„
- ã—ã‹ã—ã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…æ©Ÿã—ãªã„
- çµæœã¨ã—ã¦ã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ãŒå®Œäº†ã™ã‚‹å‰ã«FAQä¸€è¦§ã‚’å–å¾—ã™ã‚‹ã¨ã€ã¾ã 6ä»¶ã—ã‹è¿”ã•ã‚Œãªã„

---

## 3. å¤§åŸå‰‡ã«æº–æ‹ ã—ãŸä¿®æ­£æ¡ˆ

### 3.1 ä¿®æ­£æ–¹é‡

**å¤§åŸå‰‡**:
1. **æ ¹æœ¬çš„ãªè§£æ±º**: ã‚¿ã‚¤ãƒŸãƒ³ã‚°å•é¡Œã‚’æ ¹æœ¬çš„ã«è§£æ±ºã™ã‚‹
2. **ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹é€ **: è¤‡é›‘ãªå®Ÿè£…ã‚’é¿ã‘ã‚‹
3. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®é‡è¦–**: æœ€åˆã®å°è±¡ã‚’æãªã‚ãªã„
4. **èª æ„ã‚ã‚‹å¯¾å¿œ**: ã§ããªã„å ´åˆã¯ã€ã§ãã‚‹é™åº¦ã§è¡¨ç¤ºã™ã‚‹ã‹ã€ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ã‚’è¡¨ç¤ºã™ã‚‹

### 3.2 ä¿®æ­£æ¡ˆ1: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†å®Œäº†å¾…æ©Ÿï¼ˆæœ€å„ªå…ˆï¼‰

**æ¦‚è¦**:
FAQä¸€è¦§å–å¾—APIã§ã€æ–½è¨­ä½œæˆã‹ã‚‰30ç§’ä»¥å†…ã®å ´åˆã€æœŸå¾…ã•ã‚Œã‚‹FAQæ•°ï¼ˆ20ä»¶ï¼‰ã¨å®Ÿéš›ã®FAQæ•°ã‚’æ¯”è¼ƒã—ã€ä¸€è‡´ã—ãªã„å ´åˆã¯æœ€å¤§30ç§’ã¾ã§å¾…æ©Ÿï¼ˆãƒãƒ¼ãƒªãƒ³ã‚°ï¼‰ã—ã¾ã™ã€‚

**å®Ÿè£…**:
```python
async def get_faqs(
    self,
    facility_id: int,
    category: Optional[str] = None,
    is_active: Optional[bool] = None
) -> List[FAQResponse]:
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã‚‹
    cached_faqs = await get_cache(cache_key_str)
    if cached_faqs is not None:
        return [FAQResponse(**faq_dict) for faq_dict in cached_faqs]
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—
    query = select(FAQ).where(FAQ.facility_id == facility_id)
    # ...
    result = await self.db.execute(query)
    faqs = result.scalars().all()
    
    # æ–½è¨­ä½œæˆã‹ã‚‰30ç§’ä»¥å†…ã®å ´åˆã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…æ©Ÿ
    facility = await self.db.get(Facility, facility_id)
    if facility:
        time_since_creation = datetime.now(timezone.utc) - facility.created_at
        if time_since_creation < timedelta(seconds=30):
            # æœŸå¾…ã•ã‚Œã‚‹FAQæ•°ã‚’å–å¾—
            expected_count = get_initial_faq_count(facility.subscription_plan)
            actual_count = len(faqs)
            
            # æœŸå¾…å€¤ã¨ä¸€è‡´ã—ãªã„å ´åˆã€æœ€å¤§30ç§’ã¾ã§å¾…æ©Ÿï¼ˆãƒãƒ¼ãƒªãƒ³ã‚°ï¼‰
            if actual_count < expected_count:
                import asyncio
                max_wait_time = 30  # æœ€å¤§30ç§’
                poll_interval = 0.5  # 0.5ç§’ã”ã¨ã«ãƒãƒ¼ãƒªãƒ³ã‚°
                elapsed_time = 0
                
                while actual_count < expected_count and elapsed_time < max_wait_time:
                    await asyncio.sleep(poll_interval)
                    elapsed_time += poll_interval
                    
                    # å†åº¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—
                    result = await self.db.execute(query)
                    faqs = result.scalars().all()
                    actual_count = len(faqs)
                
                # å¾…æ©Ÿå¾Œã®çµæœã‚’å†æ§‹ç¯‰
                faq_responses = []
                for faq in faqs:
                    translations = [
                        FAQTranslationResponse(...)
                        for trans in faq.translations
                    ]
                    faq_responses.append(FAQResponse(...))
                
                # å¾…æ©Ÿå¾Œã‚‚æœŸå¾…å€¤ã«é”ã—ã¦ã„ãªã„å ´åˆã¯ã€ç¾åœ¨ã®ä»¶æ•°ã‚’è¿”ã™
                logger.info(
                    f"FAQ retrieval after polling: facility_id={facility_id}, "
                    f"expected={expected_count}, actual={actual_count}, "
                    f"elapsed_time={elapsed_time:.2f}s"
                )
                return faq_responses
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ï¼ˆæ–½è¨­ä½œæˆã‹ã‚‰30ç§’ä»¥ä¸ŠçµŒéã—ã¦ã„ã‚‹å ´åˆã®ã¿ï¼‰
    faq_dicts = [faq.model_dump() for faq in faq_responses]
    await set_cache(cache_key_str, faq_dicts, FAQ_CACHE_TTL)
    return faq_responses
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… **æ ¹æœ¬çš„ãªè§£æ±º**: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…æ©Ÿã™ã‚‹ãŸã‚ã€ç¢ºå®Ÿã«20ä»¶ã‚’è¿”ã™
- âœ… **ã‚·ãƒ³ãƒ—ãƒ«**: æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã‚’æœ€å°é™ã®ä¿®æ­£ã§å¯¾å¿œå¯èƒ½
- âœ… **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“**: æœ€åˆã‹ã‚‰20ä»¶ãŒè¡¨ç¤ºã•ã‚Œã‚‹

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- âš ï¸ **APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®é…å»¶**: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ãŒå®Œäº†ã™ã‚‹ã¾ã§ã€æœ€å¤§30ç§’å¾…æ©Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
- âš ï¸ **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ10ç§’ï¼‰ã‚’è¶…ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹

**è©•ä¾¡**: âš ï¸ **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå•é¡ŒãŒã‚ã‚‹**

### 3.3 ä¿®æ­£æ¡ˆ2: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†å®Œäº†ãƒ•ãƒ©ã‚°ï¼ˆæ¨å¥¨ï¼‰

**æ¦‚è¦**:
æ–½è¨­ãƒ†ãƒ¼ãƒ–ãƒ«ã«`faq_initialization_completed`ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ ã—ã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ãŒå®Œäº†ã—ãŸã‚‰`True`ã«è¨­å®šã—ã¾ã™ã€‚FAQä¸€è¦§å–å¾—APIã§ã¯ã€ã“ã®ãƒ•ãƒ©ã‚°ãŒ`False`ã®å ´åˆã¯ã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…æ©Ÿï¼ˆãƒãƒ¼ãƒªãƒ³ã‚°ï¼‰ã—ã¾ã™ã€‚

**å®Ÿè£…**:

1. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®å¤‰æ›´**:
```python
# backend/app/models/facility.py
class Facility(Base):
    # ... (æ—¢å­˜ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰)
    faq_initialization_completed: bool = Column(Boolean, default=False, nullable=False)
```

2. **ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã®ä¿®æ­£**:
```python
@staticmethod
async def register_facility_async_faqs(
    facility_id: int,
    user_id: int,
    subscription_plan: str
):
    async with AsyncSessionLocal() as db:
        try:
            # FAQä¸€æ‹¬ä½œæˆ
            await FAQService(db).bulk_create_faqs(facility_id, faq_requests, user_id)
            await db.commit()
            
            # ãƒ•ãƒ©ã‚°ã‚’Trueã«è¨­å®š
            facility = await db.get(Facility, facility_id)
            if facility:
                facility.faq_initialization_completed = True
                await db.commit()
            
            # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
            await delete_cache_pattern(f"faq:list:*facility_id={facility_id}*")
        except Exception as e:
            logger.error(...)
```

3. **FAQå–å¾—APIã®ä¿®æ­£**:
```python
async def get_faqs(
    self,
    facility_id: int,
    category: Optional[str] = None,
    is_active: Optional[bool] = None
) -> List[FAQResponse]:
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã‚‹
    cached_faqs = await get_cache(cache_key_str)
    if cached_faqs is not None:
        return [FAQResponse(**faq_dict) for faq_dict in cached_faqs]
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—
    query = select(FAQ).where(FAQ.facility_id == facility_id)
    # ...
    result = await self.db.execute(query)
    faqs = result.scalars().all()
    
    # æ–½è¨­æƒ…å ±ã‚’å–å¾—
    facility = await self.db.get(Facility, facility_id)
    if facility and not facility.faq_initialization_completed:
        # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…æ©Ÿï¼ˆãƒãƒ¼ãƒªãƒ³ã‚°ï¼‰
        import asyncio
        max_wait_time = 30  # æœ€å¤§30ç§’
        poll_interval = 0.5  # 0.5ç§’ã”ã¨ã«ãƒãƒ¼ãƒªãƒ³ã‚°
        elapsed_time = 0
        
        while not facility.faq_initialization_completed and elapsed_time < max_wait_time:
            await asyncio.sleep(poll_interval)
            elapsed_time += poll_interval
            
            # æ–½è¨­æƒ…å ±ã‚’å†å–å¾—
            await self.db.refresh(facility)
            
            # FAQã‚‚å†å–å¾—
            result = await self.db.execute(query)
            faqs = result.scalars().all()
        
        # å¾…æ©Ÿå¾Œã®çµæœã‚’å†æ§‹ç¯‰
        faq_responses = []
        for faq in faqs:
            translations = [
                FAQTranslationResponse(...)
                for trans in faq.translations
            ]
            faq_responses.append(FAQResponse(...))
        
        return faq_responses
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
    faq_dicts = [faq.model_dump() for faq in faq_responses]
    await set_cache(cache_key_str, faq_dicts, FAQ_CACHE_TTL)
    return faq_responses
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… **æ ¹æœ¬çš„ãªè§£æ±º**: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…æ©Ÿã™ã‚‹ãŸã‚ã€ç¢ºå®Ÿã«20ä»¶ã‚’è¿”ã™
- âœ… **ç¢ºå®Ÿãªæ¤œçŸ¥**: ãƒ•ãƒ©ã‚°ã§å®Œäº†ã‚’ç¢ºå®Ÿã«æ¤œçŸ¥ã§ãã‚‹
- âœ… **ã‚·ãƒ³ãƒ—ãƒ«**: å®Ÿè£…ãŒæ¯”è¼ƒçš„ç°¡å˜

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- âš ï¸ **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®å¤‰æ›´**: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¿…è¦
- âš ï¸ **APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®é…å»¶**: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ãŒå®Œäº†ã™ã‚‹ã¾ã§ã€æœ€å¤§30ç§’å¾…æ©Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
- âš ï¸ **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ10ç§’ï¼‰ã‚’è¶…ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹

**è©•ä¾¡**: âš ï¸ **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå•é¡ŒãŒã‚ã‚‹**

### 3.4 ä¿®æ­£æ¡ˆ3: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆæ¨å¥¨ï¼‰

**æ¦‚è¦**:
ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯å¾…æ©Ÿã›ãšã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§å®šæœŸçš„ã«FAQä¸€è¦§ã‚’å–å¾—ã—ã€æœŸå¾…å€¤ï¼ˆ20ä»¶ï¼‰ã¨ä¸€è‡´ã™ã‚‹ã¾ã§ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™ã€‚é€²è¡Œä¸­ã®å ´åˆã¯ã€ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

**å®Ÿè£…**:

1. **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã®ä¿®æ­£ï¼ˆé€²è¡Œä¸­çŠ¶æ…‹ã‚’è¿”ã™ï¼‰**:
```python
@router.get("", response_model=FAQListResponse)
async def get_faqs(
    category: Optional[str] = Query(None),
    is_active: Optional[bool] = Query(None),
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    facility_id = current_user.facility_id
    faq_service = FAQService(db)
    faqs = await faq_service.get_faqs(
        facility_id=facility_id,
        category=category,
        is_active=is_active
    )
    
    # æ–½è¨­æƒ…å ±ã‚’å–å¾—
    facility = await db.get(Facility, facility_id)
    if facility:
        time_since_creation = datetime.now(timezone.utc) - facility.created_at
        expected_count = get_initial_faq_count(facility.subscription_plan)
        actual_count = len(faqs)
        
        # æ–½è¨­ä½œæˆã‹ã‚‰30ç§’ä»¥å†…ã§ã€æœŸå¾…å€¤ã¨ä¸€è‡´ã—ãªã„å ´åˆã¯é€²è¡Œä¸­ã¨ã¿ãªã™
        if time_since_creation < timedelta(seconds=30) and actual_count < expected_count:
            return FAQListResponse(
                faqs=faqs,
                total=actual_count,
                is_initializing=True  # é€²è¡Œä¸­ãƒ•ãƒ©ã‚°
            )
    
    return FAQListResponse(faqs=faqs, total=len(faqs))
```

2. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ä¿®æ­£**:
```typescript
// frontend/src/views/admin/FaqManagement.vue
const fetchFaqs = async () => {
  try {
    loading.value = true
    error.value = null
    const data = await faqApi.getFaqs()
    
    // é€²è¡Œä¸­ã®å ´åˆã€ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’é–‹å§‹
    if (data.is_initializing && data.total < 20) {
      const expectedCount = 20
      const pollInterval = 2000 // 2ç§’ã”ã¨ã«ãƒãƒ¼ãƒªãƒ³ã‚°
      const maxPollTime = 30000 // æœ€å¤§30ç§’
      const startTime = Date.now()
      
      const poll = async () => {
        if (Date.now() - startTime > maxPollTime) {
          // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ç¾åœ¨ã®ä»¶æ•°ã‚’è¡¨ç¤º
          faqs.value = data.faqs
          loading.value = false
          return
        }
        
        try {
          const newData = await faqApi.getFaqs()
          if (!newData.is_initializing && newData.total >= expectedCount) {
            // å®Œäº†: æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
            faqs.value = newData.faqs
            loading.value = false
          } else {
            // ã¾ã é€²è¡Œä¸­: å†åº¦ãƒãƒ¼ãƒªãƒ³ã‚°
            setTimeout(poll, pollInterval)
          }
        } catch (err) {
          // ã‚¨ãƒ©ãƒ¼: ç¾åœ¨ã®ä»¶æ•°ã‚’è¡¨ç¤º
          faqs.value = data.faqs
          loading.value = false
        }
      }
      
      // åˆå›ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’é–‹å§‹
      setTimeout(poll, pollInterval)
      
      // é€²è¡Œä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      faqs.value = data.faqs
      // ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    } else {
      // é€šå¸¸ã®è¡¨ç¤º
      faqs.value = data.faqs
      loading.value = false
    }
  } catch (err: any) {
    console.error('Failed to fetch FAQs:', err)
    error.value = err.response?.data?.detail || 'FAQä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'
    loading.value = false
  }
}
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… **æ ¹æœ¬çš„ãªè§£æ±º**: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ãŒå®Œäº†ã™ã‚‹ã¾ã§ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§å¾…æ©Ÿ
- âœ… **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå•é¡Œã®å›é¿**: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯å¾…æ©Ÿã—ãªã„ãŸã‚ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„
- âœ… **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“**: é€²è¡Œä¸­ã®å ´åˆã¯ã€ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ã‚’è¡¨ç¤ºã§ãã‚‹
- âœ… **ã‚·ãƒ³ãƒ—ãƒ«**: å®Ÿè£…ãŒæ¯”è¼ƒçš„ç°¡å˜

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- âš ï¸ **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å®Ÿè£…**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å®Ÿè£…ãŒå¿…è¦
- âš ï¸ **APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å¤‰æ›´**: `FAQListResponse`ã«`is_initializing`ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

**è©•ä¾¡**: âœ… **æ¨å¥¨**ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå•é¡Œã‚’å›é¿ã§ãã‚‹ï¼‰

---

## 4. æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£é †åº

1. **ä¿®æ­£æ¡ˆ3: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒãƒ¼ãƒªãƒ³ã‚°**ï¼ˆæœ€å„ªå…ˆï¼‰
   - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå•é¡Œã‚’å›é¿ã§ãã‚‹
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’å‘ä¸Šã§ãã‚‹
   - å®Ÿè£…ãŒæ¯”è¼ƒçš„ç°¡å˜

2. **ä¿®æ­£æ¡ˆ2: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†å®Œäº†ãƒ•ãƒ©ã‚°**ï¼ˆæ¬¡å„ªå…ˆï¼‰
   - ç¢ºå®Ÿãªå®Œäº†æ¤œçŸ¥ãŒå¯èƒ½
   - ãŸã ã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®å¤‰æ›´ãŒå¿…è¦

3. **ä¿®æ­£æ¡ˆ1: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†å®Œäº†å¾…æ©Ÿ**ï¼ˆéæ¨å¥¨ï¼‰
   - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå•é¡ŒãŒã‚ã‚‹

---

## 5. ã¾ã¨ã‚

### 5.1 å•é¡Œã®æ ¹æœ¬åŸå› 

**ç¢ºå®š**: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ãŒå®Œäº†ã™ã‚‹å‰ã«FAQä¸€è¦§ã‚’å–å¾—ã—ãŸãŸã‚ã€6ä»¶ã—ã‹è¡¨ç¤ºã•ã‚Œãªã‹ã£ãŸã€‚

### 5.2 ä¿®æ­£æ–¹é‡

1. **ä¿®æ­£æ¡ˆ3ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒãƒ¼ãƒªãƒ³ã‚°ï¼‰**ã‚’æœ€å„ªå…ˆã§å®Ÿæ–½
2. å¿…è¦ã«å¿œã˜ã¦**ä¿®æ­£æ¡ˆ2ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†å®Œäº†ãƒ•ãƒ©ã‚°ï¼‰**ã‚’è£œåŠ©çš„ã«å®Ÿæ–½

### 5.3 æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

1. **æ–°è¦ç™»éŒ²ç›´å¾Œã‹ã‚‰20ä»¶ãŒè¡¨ç¤ºã•ã‚Œã‚‹**
2. **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„**
3. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ãŒå‘ä¸Šã™ã‚‹**

---

**çŠ¶æ…‹**: ğŸ” **å†èª¿æŸ»åˆ†æå®Œäº†ã€ä¿®æ­£æ¡ˆæç¤ºå®Œäº†**  
**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤ºã‚’å¾…ã¤ï¼ˆä¿®æ­£ã¯å®Ÿæ–½ã—ãªã„ï¼‰

