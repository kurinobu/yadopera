# Phase 1・Phase 2: ステップ5 ゲスト画面詳細テスト 確認方法調査分析レポート

**作成日**: 2025年12月14日  
**実施者**: AI Assistant  
**対象**: ステップ5（Docker環境でのゲスト画面詳細テスト）の確認方法が分からない項目の調査分析  
**状態**: 📋 **調査分析完了**

---

## 1. 調査概要

### 1.1 調査目的

ステップ5のゲスト画面詳細テストで、確認方法が分からない、または問題がある項目について調査分析を行い、確認方法を提示する。

### 1.2 調査対象項目

1. **PWA対応が正常に動作することを確認** → 確認方法が分からない
2. **固定フッターが正常に表示されることを確認** → 固定フッターは存在しないが今のところ問題なし
3. **RAG統合型AI応答が正常に動作することを確認** → 確認方法が分からない
4. **フィードバックが正常に送信されることを確認** → 確認方法が分からない
5. **トークン入力機能が正常に動作することを確認** → コピーをタップしても何も反応が無いのでコピーできたのかどうか判断できない
6. **PWAインストールプロンプトが正常に表示されることを確認** → 確認方法が分からない。そもそもこの機能が何なのかわからないので説明してください

---

## 2. 各項目の調査分析結果

### 2.1 PWA対応が正常に動作することを確認

#### 2.1.1 PWAとは

**PWA（Progressive Web App）**とは、Webアプリケーションをネイティブアプリのように動作させる技術です。

**主な特徴**:
- **オフライン対応**: インターネット接続がなくても動作する（Service Workerを使用）
- **インストール可能**: ホーム画面に追加して、アプリのように起動できる
- **高速読み込み**: キャッシュを使用して高速に読み込める
- **プッシュ通知**: ブラウザでプッシュ通知を受け取れる（実装されていない場合もある）

#### 2.1.2 実装状況

**実装ファイル**:
- `frontend/vite.config.ts`: VitePWAプラグインの設定
- `frontend/src/composables/usePWA.ts`: PWA機能のComposable
- `frontend/src/components/common/PWAInstallPrompt.vue`: PWAインストールプロンプトコンポーネント

**実装内容**:
- ✅ Service Workerが自動登録される（`registerType: 'autoUpdate'`）
- ✅ Manifest.jsonが生成される
- ✅ オフライン対応（Workboxを使用）

#### 2.1.3 確認方法

**方法1: Service Workerの確認（ブラウザ開発者ツール）**

1. **ブラウザ開発者ツールを開く**:
   - Chrome/Edge: `F12` または `Ctrl+Shift+I` (Windows) / `Cmd+Option+I` (Mac)
   - Firefox: `F12` または `Ctrl+Shift+I` (Windows) / `Cmd+Option+I` (Mac)

2. **Applicationタブ（Chrome/Edge）またはStorageタブ（Firefox）を開く**

3. **Service Workersセクションを確認**:
   - Service Workerが登録されていることを確認
   - ステータスが「activated」であることを確認

4. **Manifestセクションを確認**:
   - Manifest.jsonが読み込まれていることを確認
   - アプリ名、アイコン、テーマカラーが正しく設定されていることを確認

**方法2: オフライン動作の確認**

1. **ブラウザ開発者ツールを開く**

2. **Networkタブを開く**

3. **オフラインモードを有効にする**:
   - Chrome/Edge: Networkタブで「Offline」を選択
   - Firefox: Networkタブで「Offline」を選択

4. **ページをリロード**:
   - オフラインでもページが表示されることを確認（Service Workerがキャッシュを使用）

5. **オフラインモードを無効にする**:
   - Networkタブで「Online」を選択

**方法3: インストール可能な状態の確認**

1. **ブラウザのアドレスバーにインストールアイコンが表示されることを確認**:
   - Chrome/Edge: アドレスバー右側に「インストール」アイコンが表示される
   - Firefox: アドレスバー右側に「インストール」アイコンが表示される

2. **PWAインストールプロンプトが表示されることを確認**:
   - ゲスト画面にアクセス
   - 画面下部にPWAインストールプロンプトが表示される（条件を満たす場合）

**確認項目**:
- [ ] Service Workerが登録されている
- [ ] Manifest.jsonが読み込まれている
- [ ] オフラインでもページが表示される（キャッシュが機能している）
- [ ] インストールアイコンが表示される（条件を満たす場合）

---

### 2.2 固定フッターが正常に表示されることを確認

#### 2.2.1 調査結果

**実装状況**:
- ❌ **固定フッターは実装されていない**

**現在の実装**:
- `frontend/src/views/guest/Chat.vue`では、メッセージ入力欄が画面下部に固定されている
- ただし、これは「固定フッター」ではなく、「メッセージ入力欄」である

**コード確認**:
```vue
<!-- メッセージ入力（固定フッター） -->
<div class="flex-shrink-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 px-4 py-3">
  <MessageInput
    :disabled="isLoading"
    placeholder="メッセージを入力..."
    @submit="handleMessageSubmit"
  />
</div>
```

**コメント**: 「固定フッター」というコメントがあるが、実際にはメッセージ入力欄である。

#### 2.2.2 確認方法

**現在の実装では固定フッターは存在しないため、確認不要**

**代替確認項目**:
- [ ] メッセージ入力欄が画面下部に固定されている
- [ ] メッセージ入力欄が常に表示されている（スクロールしても表示される）
- [ ] メッセージ入力欄が正常に動作する

**備考**:
- ユーザー報告: 「固定フッターは存在しないが今のところ問題なし」
- 現在の実装で問題ないと判断されるため、確認不要

---

### 2.3 RAG統合型AI応答が正常に動作することを確認

#### 2.3.1 RAGとは

**RAG（Retrieval-Augmented Generation）**とは、検索拡張生成のことで、以下の処理を行います：

1. **埋め込みベクトル生成**: 質問文をベクトル化（OpenAI Embeddings API）
2. **類似FAQ検索**: pgvectorで類似FAQを検索（Top 3）
3. **コンテキスト構築**: 検索結果と施設情報を組み合わせてコンテキストを作成
4. **AI回答生成**: GPT-4o miniで回答を生成

#### 2.3.2 実装状況

**実装ファイル**:
- `backend/app/ai/engine.py`: RAGChatEngineクラス
- `backend/app/ai/vector_search.py`: pgvector検索実装
- `backend/app/services/chat_service.py`: チャットサービス

**処理フロー**:
```
質問受付
  ↓
埋め込みベクトル生成（OpenAI Embeddings API）
  ↓
pgvector検索（Top 3 FAQ取得）
  ↓
コンテキスト構築
  ↓
GPT-4o mini回答生成
  ↓
信頼度スコア計算
  ↓
エスカレーション判定
```

#### 2.3.3 確認方法

**方法1: ブラウザ開発者ツールでネットワークリクエストを確認**

1. **ブラウザ開発者ツールを開く**（`F12`）

2. **Networkタブを開く**

3. **チャット画面で質問を送信**（例: "What time is check-in?"）

4. **APIリクエストを確認**:
   - `POST /api/v1/chat` リクエストを確認
   - レスポンス時間を確認（3秒以内であることを確認）

5. **レスポンスを確認**:
   - レスポンスに`ai_confidence`が含まれていることを確認
   - レスポンスに`matched_faq_ids`が含まれていることを確認（RAG検索結果）

**方法2: バックエンドログを確認**

1. **Dockerコンテナのログを確認**:
   ```bash
   docker-compose logs -f backend
   ```

2. **質問を送信**（例: "What time is check-in?"）

3. **ログを確認**:
   - 埋め込みベクトル生成のログ
   - pgvector検索のログ
   - GPT-4o mini回答生成のログ
   - 信頼度スコア計算のログ

**方法3: データベースで確認**

1. **データベースに接続**:
   ```bash
   docker-compose exec postgres psql -U yadopera_user -d yadopera
   ```

2. **メッセージテーブルを確認**:
   ```sql
   SELECT id, content, ai_confidence, matched_faq_ids, created_at 
   FROM messages 
   WHERE role = 'assistant' 
   ORDER BY created_at DESC 
   LIMIT 5;
   ```

3. **確認項目**:
   - `ai_confidence`が設定されている（0.0-1.0の範囲）
   - `matched_faq_ids`が設定されている（RAG検索でFAQがヒットした場合）

**方法4: FAQ検索結果の確認**

1. **質問を送信**（例: "What time is check-in?"）

2. **データベースでFAQ検索結果を確認**:
   ```sql
   -- 最新のメッセージのmatched_faq_idsを確認
   SELECT id, content, matched_faq_ids 
   FROM messages 
   WHERE role = 'assistant' 
   ORDER BY created_at DESC 
   LIMIT 1;
   
   -- matched_faq_idsに含まれるFAQを確認
   SELECT id, question, answer, category 
   FROM faqs 
   WHERE id IN (matched_faq_idsの値);
   ```

**確認項目**:
- [ ] APIリクエストが正常に送信される
- [ ] レスポンス時間が3秒以内である
- [ ] レスポンスに`ai_confidence`が含まれている
- [ ] レスポンスに`matched_faq_ids`が含まれている（RAG検索結果）
- [ ] バックエンドログにRAG処理のログが出力されている
- [ ] データベースに`matched_faq_ids`が保存されている

---

### 2.4 フィードバックが正常に送信されることを確認

#### 2.4.1 実装状況

**実装ファイル**:
- `frontend/src/components/guest/FeedbackButtons.vue`: フィードバックUI
- `frontend/src/api/chat.ts`: フィードバックAPIクライアント
- `backend/app/api/v1/chat.py`: フィードバックAPIエンドポイント
- `backend/app/services/chat_service.py`: フィードバック保存処理

**処理フロー**:
```
👍👎ボタンをクリック
  ↓
POST /api/v1/chat/feedback
  ↓
バックエンドでフィードバックを保存
  ↓
guest_feedbackテーブルに保存
```

#### 2.4.2 確認方法

**方法1: ブラウザ開発者ツールでネットワークリクエストを確認**

1. **ブラウザ開発者ツールを開く**（`F12`）

2. **Networkタブを開く**

3. **チャット画面で👍👎ボタンをクリック**

4. **APIリクエストを確認**:
   - `POST /api/v1/chat/feedback` リクエストを確認
   - リクエストボディを確認:
     ```json
     {
       "message_id": 123,
       "feedback_type": "positive" または "negative"
     }
     ```

5. **レスポンスを確認**:
   - ステータスコードが`200 OK`であることを確認
   - レスポンスボディを確認:
     ```json
     {
       "id": 456,
       "message_id": 123,
       "feedback_type": "positive",
       "created_at": "2025-12-14T12:34:56Z"
     }
     ```

**方法2: データベースで確認**

1. **データベースに接続**:
   ```bash
   docker-compose exec postgres psql -U yadopera_user -d yadopera
   ```

2. **フィードバックテーブルを確認**:
   ```sql
   SELECT id, message_id, facility_id, feedback_type, created_at 
   FROM guest_feedback 
   ORDER BY created_at DESC 
   LIMIT 5;
   ```

3. **確認項目**:
   - フィードバックが保存されている
   - `message_id`が正しい
   - `feedback_type`が正しい（`positive`または`negative`）
   - `created_at`が現在時刻に近い

**方法3: UIで確認**

1. **チャット画面で👍👎ボタンをクリック**

2. **UIの変化を確認**:
   - 「ありがとうございます / Thank you!」メッセージが表示される
   - ボタンが無効化される（`feedbackSent = true`）
   - ボタンの色が変わる（選択されたフィードバックタイプの色）

**方法4: バックエンドログを確認**

1. **Dockerコンテナのログを確認**:
   ```bash
   docker-compose logs -f backend
   ```

2. **👍👎ボタンをクリック**

3. **ログを確認**:
   - `Feedback saved: feedback_id=..., message_id=..., type=...` のログが出力される

**確認項目**:
- [ ] APIリクエストが正常に送信される
- [ ] レスポンスステータスが`200 OK`である
- [ ] データベースにフィードバックが保存されている
- [ ] UIに「ありがとうございます / Thank you!」メッセージが表示される
- [ ] ボタンが無効化される
- [ ] バックエンドログにフィードバック保存のログが出力される

---

### 2.5 トークン入力機能が正常に動作することを確認（コピー機能の問題）

#### 2.5.1 問題の報告

**問題**: コピーをタップしても何も反応が無いのでコピーできたのかどうか判断できない

#### 2.5.2 実装状況

**実装ファイル**:
- `frontend/src/components/guest/SessionTokenDisplay.vue`: セッション統合トークン表示コンポーネント

**実装内容**:
```typescript
const handleCopy = async () => {
  if (!props.token) {
    return
  }

  try {
    await navigator.clipboard.writeText(props.token)
    emit('copy', props.token)
    // TODO: トースト通知を表示（Week 4で実装）
  } catch (error) {
    console.error('Copy failed:', error)
  }
}
```

**問題点**:
- ✅ コピー機能は実装されている（`navigator.clipboard.writeText`）
- ❌ **トースト通知が実装されていない**（TODOコメント）
- ❌ コピー成功時の視覚的フィードバックがない

#### 2.5.3 確認方法

**方法1: クリップボードを直接確認**

1. **セッション統合トークンを表示**（チャット画面）

2. **「コピー / Copy」ボタンをクリック**

3. **クリップボードを確認**:
   - テキストエディタやメモ帳を開く
   - `Ctrl+V` (Windows) / `Cmd+V` (Mac) で貼り付け
   - トークンが貼り付けられることを確認

**方法2: ブラウザ開発者ツールでコンソールを確認**

1. **ブラウザ開発者ツールを開く**（`F12`）

2. **Consoleタブを開く**

3. **「コピー / Copy」ボタンをクリック**

4. **コンソールを確認**:
   - `Token copied: [トークン]` のログが出力される（`handleTokenCopy`関数で出力）
   - エラーが出力されていないことを確認

**方法3: ブラウザ開発者ツールでネットワークリクエストを確認**

1. **ブラウザ開発者ツールを開く**（`F12`）

2. **Networkタブを開く**

3. **「コピー / Copy」ボタンをクリック**

4. **ネットワークリクエストを確認**:
   - ネットワークリクエストは発生しない（コピーはクライアント側の処理）

**方法4: エラーの確認**

1. **ブラウザ開発者ツールを開く**（`F12`）

2. **Consoleタブを開く**

3. **「コピー / Copy」ボタンをクリック**

4. **エラーを確認**:
   - `Copy failed: [エラー内容]` が出力されていないことを確認
   - エラーが出力されている場合、原因を確認

**確認項目**:
- [ ] クリップボードにトークンがコピーされる
- [ ] コンソールに`Token copied: [トークン]`のログが出力される
- [ ] エラーが出力されていない

**問題点**:
- ❌ **トースト通知が実装されていない**ため、コピー成功時の視覚的フィードバックがない
- ✅ コピー機能自体は正常に動作している（クリップボードにコピーされる）

**改善提案**:
- トースト通知を実装する（Week 4で実装予定）
- または、一時的にボタンのテキストを「コピー済み / Copied」に変更する

---

### 2.6 PWAインストールプロンプトが正常に表示されることを確認

#### 2.6.1 PWAインストールプロンプトとは

**PWAインストールプロンプト**とは、PWAアプリをホーム画面に追加するためのプロンプトです。

**機能**:
- ゲストがアプリをホーム画面に追加できる
- オフラインでも利用できる
- ネイティブアプリのように起動できる

**表示条件**:
1. **HTTPS接続**（またはlocalhost）
2. **Manifest.jsonが正しく設定されている**
3. **Service Workerが登録されている**
4. **`beforeinstallprompt`イベントが発火する**（ブラウザが判断）

**注意**: ブラウザによって表示条件が異なる場合があります。

#### 2.6.2 実装状況

**実装ファイル**:
- `frontend/src/composables/usePWA.ts`: PWA機能のComposable
- `frontend/src/components/common/PWAInstallPrompt.vue`: PWAインストールプロンプトコンポーネント
- `frontend/src/layouts/GuestLayout.vue`: ゲストレイアウト（PWAインストールプロンプトを表示）

**実装内容**:
- ✅ `beforeinstallprompt`イベントをリッスン
- ✅ インストール可能な状態を管理
- ✅ インストールプロンプトを表示
- ✅ インストール処理を実装

#### 2.6.3 確認方法

**方法1: ブラウザ開発者ツールで確認**

1. **ブラウザ開発者ツールを開く**（`F12`）

2. **Applicationタブ（Chrome/Edge）またはStorageタブ（Firefox）を開く**

3. **Manifestセクションを確認**:
   - Manifest.jsonが読み込まれていることを確認
   - アプリ名、アイコン、テーマカラーが正しく設定されていることを確認

4. **Service Workersセクションを確認**:
   - Service Workerが登録されていることを確認
   - ステータスが「activated」であることを確認

**方法2: ブラウザのアドレスバーで確認**

1. **ゲスト画面にアクセス**（`http://localhost:5173/f/test-facility?location=entrance`）

2. **ブラウザのアドレスバーを確認**:
   - Chrome/Edge: アドレスバー右側に「インストール」アイコンが表示される（条件を満たす場合）
   - Firefox: アドレスバー右側に「インストール」アイコンが表示される（条件を満たす場合）

**方法3: PWAインストールプロンプトの表示確認**

1. **ゲスト画面にアクセス**

2. **画面下部を確認**:
   - PWAインストールプロンプトが表示される（条件を満たす場合）
   - プロンプトの内容:
     - 「アプリをインストール」タイトル
     - 「やどぺらをホーム画面に追加して、オフラインでも利用できます。」説明文
     - 「インストール」ボタン
     - 「後で」ボタン
     - 「閉じる」ボタン（×アイコン）

3. **プロンプトの動作確認**:
   - 「インストール」ボタンをクリック → インストールダイアログが表示される
   - 「後で」ボタンをクリック → プロンプトが非表示になる（localStorageに保存）
   - 「閉じる」ボタンをクリック → プロンプトが非表示になる（localStorageに保存）

**方法4: ブラウザ開発者ツールでコンソールを確認**

1. **ブラウザ開発者ツールを開く**（`F12`）

2. **Consoleタブを開く**

3. **ゲスト画面にアクセス**

4. **コンソールを確認**:
   - `beforeinstallprompt`イベントが発火していることを確認（条件を満たす場合）
   - エラーが出力されていないことを確認

**方法5: インストール後の確認**

1. **PWAインストールプロンプトで「インストール」ボタンをクリック**

2. **インストールダイアログで「インストール」をクリック**

3. **ホーム画面を確認**:
   - アプリアイコンがホーム画面に追加される
   - アプリ名が「やどぺら」であることを確認

4. **アプリを起動**:
   - ホーム画面のアプリアイコンをタップ
   - アプリが起動することを確認
   - スタンドアロンモードで表示されることを確認

**確認項目**:
- [ ] Manifest.jsonが読み込まれている
- [ ] Service Workerが登録されている
- [ ] ブラウザのアドレスバーに「インストール」アイコンが表示される（条件を満たす場合）
- [ ] PWAインストールプロンプトが表示される（条件を満たす場合）
- [ ] 「インストール」ボタンが正常に動作する
- [ ] 「後で」ボタンが正常に動作する
- [ ] 「閉じる」ボタンが正常に動作する
- [ ] インストール後、ホーム画面にアプリアイコンが追加される

**注意事項**:
- PWAインストールプロンプトは、ブラウザが判断して表示するため、必ずしも表示されるとは限りません
- 表示条件を満たしていても、ブラウザが既にインストール済みと判断した場合は表示されません
- 一度「後で」または「閉じる」をクリックした場合、localStorageに保存され、次回アクセス時には表示されません（localStorageをクリアすると再表示される）

---

## 3. 確認方法のまとめ

### 3.1 各項目の確認方法一覧

| 項目 | 確認方法 | 優先度 |
|------|----------|--------|
| **PWA対応** | 1. Service Workerの確認（開発者ツール）<br>2. オフライン動作の確認<br>3. インストール可能な状態の確認 | 高 |
| **固定フッター** | 確認不要（実装されていない） | - |
| **RAG統合型AI応答** | 1. ネットワークリクエストの確認<br>2. バックエンドログの確認<br>3. データベースの確認<br>4. FAQ検索結果の確認 | 高 |
| **フィードバック送信** | 1. ネットワークリクエストの確認<br>2. データベースの確認<br>3. UIの確認<br>4. バックエンドログの確認 | 高 |
| **トークンコピー機能** | 1. クリップボードの確認<br>2. コンソールログの確認<br>3. エラーの確認 | 中 |
| **PWAインストールプロンプト** | 1. Manifest.jsonの確認<br>2. Service Workerの確認<br>3. プロンプトの表示確認<br>4. インストール後の確認 | 中 |

### 3.2 確認手順の推奨順序

1. **PWA対応の確認**（Service Worker、Manifest.json）
2. **RAG統合型AI応答の確認**（ネットワークリクエスト、データベース）
3. **フィードバック送信の確認**（ネットワークリクエスト、データベース、UI）
4. **トークンコピー機能の確認**（クリップボード、コンソールログ）
5. **PWAインストールプロンプトの確認**（プロンプトの表示、動作確認）

---

## 4. 問題点と改善提案

### 4.1 トークンコピー機能の問題

**問題**: コピーをタップしても何も反応が無いのでコピーできたのかどうか判断できない

**原因**: トースト通知が実装されていない（TODOコメント）

**改善提案**:
1. **トースト通知を実装する**（Week 4で実装予定）
2. **または、一時的にボタンのテキストを「コピー済み / Copied」に変更する**

### 4.2 固定フッターの問題

**問題**: 固定フッターは存在しないが今のところ問題なし

**対応**: 確認不要（実装されていないが、問題ないと判断される）

---

## 5. まとめ

### 5.1 調査結果

すべての項目について、確認方法を提示しました。

### 5.2 確認方法の特徴

- **PWA対応**: Service Worker、Manifest.json、オフライン動作の確認
- **RAG統合型AI応答**: ネットワークリクエスト、データベース、バックエンドログの確認
- **フィードバック送信**: ネットワークリクエスト、データベース、UI、バックエンドログの確認
- **トークンコピー機能**: クリップボード、コンソールログの確認（トースト通知は未実装）
- **PWAインストールプロンプト**: Manifest.json、Service Worker、プロンプトの表示確認

### 5.3 次のステップ

1. 各項目の確認方法に従って、テストを実施
2. 問題点があれば、改善提案に従って修正を検討

---

**調査完了日**: 2025年12月14日  
**状態**: 📋 **調査分析完了（確認方法提示完了）**


