# ステージングデプロイ準備 確認事項

**作成日時**: 2025年1月13日  
**目的**: ステージング環境へのデプロイ前の確認事項と準備  
**状態**: ✅ **準備完了**

---

## 1. 変更内容のサマリー

### 1.1 バックエンド変更（5ファイル）

| ファイル | 変更内容 |
|---------|---------|
| `backend/app/api/v1/admin/faqs.py` | FAQ一覧取得APIに`is_initializing`フラグを追加 |
| `backend/app/schemas/faq.py` | `FAQListResponse`に`is_initializing`フィールドを追加 |
| `backend/app/services/auth_service.py` | バックグラウンド処理のFAQ自動登録ロジック修正 |
| `backend/app/services/faq_service.py` | キャッシュ保存制御ロジック追加 |
| `backend/app/api/v1/auth.py` | バックグラウンドタスク対応 |

### 1.2 フロントエンド変更（5ファイル）

| ファイル | 変更内容 |
|---------|---------|
| `frontend/src/api/faq.ts` | `getFaqs`の戻り値に`is_initializing`フラグを追加 |
| `frontend/src/views/admin/FaqManagement.vue` | ポーリングロジック追加（バックグラウンド処理完了まで待機） |
| `frontend/src/components/admin/FaqList.vue` | デバッグログ追加 |
| `frontend/src/api/axios.ts` | タイムアウト設定変更（10秒） |
| `frontend/src/views/admin/Register.vue` | 料金プランドロップダウン順序修正 |

---

## 2. マイグレーションの必要性

**✅ マイグレーション不要**

- データベーススキーマの変更なし
- 既存のテーブル構造に影響なし
- マイグレーションコマンドの実行不要

---

## 3. デプロイ前の確認事項

### 3.1 バックエンド確認事項

- [x] コード変更が完了している
- [x] リンターエラーがない
- [x] ローカル環境で動作確認済み（全プランで20件表示）
- [ ] 環境変数の確認（既存の設定で問題なし）
- [ ] `render.yaml`の確認（変更不要）

### 3.2 フロントエンド確認事項

- [x] コード変更が完了している
- [x] リンターエラーがない
- [x] ローカル環境で動作確認済み（全プランで20件表示）
- [ ] `render.yaml`の確認（変更不要）
- [ ] ビルドエラーの確認

### 3.3 環境変数確認

**バックエンド（Render.com）**:
- `DATABASE_URL`: 既存設定で問題なし
- `REDIS_URL`: 既存設定で問題なし
- `OPENAI_API_KEY`: 既存設定で問題なし
- `SECRET_KEY`: 既存設定で問題なし
- `CORS_ORIGINS`: 既存設定で問題なし
- `ENVIRONMENT`: `staging`（既存設定）
- `DEBUG`: `False`（既存設定）
- `LOG_LEVEL`: `INFO`（既存設定）

**フロントエンド（Render.com Static Site）**:
- `VITE_API_BASE_URL`: `https://yadopera-backend-staging.onrender.com`（既存設定）
- `VITE_ENVIRONMENT`: `staging`（既存設定）

---

## 4. デプロイ手順

### 4.1 バックエンドデプロイ

1. **変更をコミット**:
   ```bash
   git add .
   git commit -m "feat: 新規登録時のFAQ自動登録を20件に統一 + フロントエンドポーリング実装"
   ```

2. **developブランチにプッシュ**:
   ```bash
   git push origin develop
   ```

3. **Render.comで自動デプロイを確認**:
   - Render.comダッシュボードで`yadopera-backend-staging`のデプロイ状況を確認
   - デプロイログでエラーがないか確認

### 4.2 フロントエンドデプロイ

1. **変更をコミット**（バックエンドと同じコミット）:
   ```bash
   git add .
   git commit -m "feat: 新規登録時のFAQ自動登録を20件に統一 + フロントエンドポーリング実装"
   ```

2. **developブランチにプッシュ**:
   ```bash
   git push origin develop
   ```

3. **Render.comで自動デプロイを確認**:
   - Render.comダッシュボードで`yadopera-frontend-staging`のデプロイ状況を確認
   - ビルドログでエラーがないか確認

---

## 5. デプロイ後の確認事項

### 5.1 バックエンド確認

- [ ] ヘルスチェック: `https://yadopera-backend-staging.onrender.com/api/v1/health`
- [ ] API動作確認: 新規登録APIの動作確認
- [ ] ログ確認: エラーログがないか確認

### 5.2 フロントエンド確認

- [ ] ページ表示確認: `https://yadopera-frontend-staging.onrender.com`
- [ ] 新規登録テスト: 全プランで20件のFAQが表示されることを確認
- [ ] ポーリング動作確認: バックグラウンド処理完了まで待機することを確認

### 5.3 統合テスト

- [ ] **Freeプラン**: 新規登録後、20件のFAQが表示される（日本語のみ）
- [ ] **Miniプラン**: 新規登録後、20件のFAQが表示される（日本語+英語）
- [ ] **Smallプラン**: 新規登録後、20件のFAQが表示される（日本語+英語+中国語）
- [ ] **Standardプラン**: 新規登録後、20件のFAQが表示される（日本語+英語+中国語+フランス語）
- [ ] **Premiumプラン**: 新規登録後、20件のFAQが表示される（全言語）

---

## 6. 注意事項

### 6.1 バックグラウンド処理の完了時間

- **ローカル環境**: 約5-10秒
- **ステージング環境**: 約15-30秒（データベース接続が遅い可能性がある）

### 6.2 ポーリング設定

- **ポーリング間隔**: 2秒
- **最大待機時間**: 30秒
- **タイムアウト時**: 現在の件数を表示

### 6.3 キャッシュの動作

- 施設作成から30秒以内の場合、キャッシュを保存しない
- バックグラウンド処理完了後、キャッシュを無効化
- 5秒待ってから再度キャッシュを無効化

---

## 7. ロールバック手順（必要に応じて）

### 7.1 バックアップの場所

- **バックアップディレクトリ**: `backups/20260113_152927_frontend_polling/`
- **バックアップファイル**:
  - `backend/app/api/v1/admin/faqs.py`
  - `backend/app/schemas/faq.py`
  - `frontend/src/views/admin/FaqManagement.vue`
  - `frontend/src/api/faq.ts`

### 7.2 ロールバック方法

1. バックアップファイルを元の場所にコピー
2. 変更をコミット
3. developブランチにプッシュ
4. Render.comで自動デプロイを確認

---

## 8. まとめ

### 8.1 準備完了項目

- ✅ コード変更完了
- ✅ リンターエラーなし
- ✅ ローカル環境で動作確認済み
- ✅ マイグレーション不要
- ✅ 環境変数確認済み
- ✅ バックアップ作成済み

### 8.2 次のステップ

1. 変更をコミット・プッシュ
2. Render.comで自動デプロイを確認
3. デプロイ後の動作確認
4. 統合テストの実施

---

**状態**: ✅ **デプロイ準備完了**  
**次のステップ**: ユーザーがデプロイを開始

