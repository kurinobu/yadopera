# Phase 1・Phase 2: ステージング環境テストデータ問題 完全調査分析

**作成日時**: 2025年12月15日 13時45分30秒  
**実施者**: AI Assistant  
**対象**: ステージング環境のテストデータ問題（「check-in」関連データが残存）  
**状態**: 📋 **完全調査分析完了**

---

## 1. 問題の概要

### 1.1 症状

**ユーザー報告**:
- 未解決質問リストに「What time is check-in?」「チェックインの時間は何時ですか？」が表示されている
- FAQ改善提案に「Q: What time is check-in?」が表示されている

**影響**: **重大** - テストデータとして不適切な質問が表示されている

### 1.2 実施した対応（過去）

**対応内容**:
- `backend/create_staging_test_data.py`に既存の「check-in」関連データの削除処理を追加
- メッセージ、FAQ提案、FAQ、未解決エスカレーションの削除処理を実装
- スクリプトを実行（複数回）

**結果**:
- ❌ ユーザーが報告している表示がまだ残っている
- ❌ 削除処理が不十分である可能性

---

## 2. 完全調査分析

### 2.1 既存の削除処理の確認

**`backend/create_staging_test_data.py`の削除処理**:

1. **メッセージの削除**（256-285行目）
   - `Message.content.ilike("%check-in%")`で検索
   - `Message.content.ilike("%チェックイン%")`で検索
   - ✅ 実装済み

2. **FAQ提案の削除**（289-311行目）
   - `FAQSuggestion.suggested_question.ilike("%check-in%")`で検索
   - `FAQSuggestion.suggested_question.ilike("%チェックイン%")`で検索
   - ✅ 実装済み

3. **FAQの削除**（315-336行目）
   - `FAQ.question.ilike("%check-in%")`で検索
   - `FAQ.question.ilike("%チェックイン%")`で検索
   - ✅ 実装済み

4. **エスカレーションの削除**（340-399行目）
   - 「check-in」関連のメッセージを含む会話に紐づいているエスカレーションを削除
   - ✅ 実装済み

5. **未解決エスカレーションの削除**（401-479行目）
   - 未解決エスカレーションに紐づいている会話の最初のユーザーメッセージが「check-in」関連の場合、エスカレーションとメッセージを削除
   - ✅ 実装済み

**問題点**:
- 削除処理は実装されているが、**削除順序に問題がある可能性**
- **外部キー制約**を考慮していない（エスカレーションを削除する前に、関連する夜間対応キューやゲストフィードバックを削除していない）
- **重複削除処理**がある（6番目の処理が2回実装されている：401-437行目と439-479行目）

### 2.2 既存の削除スクリプトの確認

**`backend/delete_checkin_data.py`**:
- ✅ より完全な削除処理が実装されている
- ✅ 外部キー制約を考慮した削除順序（夜間対応キュー → エスカレーション → メッセージ → ゲストフィードバック → 会話 → FAQ提案 → FAQ）
- ✅ 重複を除去する処理がある

**`backend/check_checkin_data.py`**:
- ✅ データベースを直接確認して「check-in」関連データを特定するスクリプト
- ✅ メッセージ、FAQ提案、FAQ、未解決エスカレーションを確認

### 2.3 未解決質問リストの取得ロジック

**`backend/app/services/escalation_service.py`の`get_unresolved_questions`メソッド**（328-387行目）:
- 未解決のエスカレーションを取得
- 各エスカレーションに紐づく会話の最初のユーザーメッセージを取得
- メッセージの内容（`message.content`）を質問として返却

**問題点**:
- **メッセージが削除されていない場合、未解決質問リストに表示される**
- **エスカレーションが削除されていない場合、未解決質問リストに表示される**

### 2.4 FAQ改善提案の取得ロジック

**`backend/app/api/v1/admin/faq_suggestions.py`**:
- FAQ改善提案は、未解決質問リストから生成される
- 未解決質問リストに「check-in」関連の質問が含まれている場合、FAQ改善提案にも表示される

---

## 3. 根本原因の特定

### 3.1 直接的な原因

1. **削除処理の実行タイミングの問題**
   - `create_staging_test_data.py`の削除処理は、テストデータ作成**前**に実行される
   - しかし、**既存のデータが完全に削除されていない可能性がある**

2. **削除順序の問題**
   - 外部キー制約を考慮していない
   - エスカレーションを削除する前に、関連する夜間対応キューやゲストフィードバックを削除していない

3. **重複削除処理の問題**
   - 6番目の処理が2回実装されている（401-437行目と439-479行目）
   - 2回目の処理が正しく動作していない可能性がある

4. **削除処理の不十分さ**
   - `delete_checkin_data.py`のような完全な削除処理が`create_staging_test_data.py`に実装されていない

### 3.2 根本的な原因

1. **削除処理の実装が不十分**
   - `create_staging_test_data.py`の削除処理は、`delete_checkin_data.py`と比較して不十分
   - 外部キー制約を考慮していない
   - 重複を除去する処理がない

2. **削除処理の実行が不確実**
   - 削除処理が実行されても、データが残っている可能性がある
   - 削除後の確認処理がない

---

## 4. 解決策

### 4.1 即座に実施すべき対応

1. **`delete_checkin_data.py`を実行して完全削除**
   - より完全な削除処理が実装されている
   - 外部キー制約を考慮した削除順序
   - 重複を除去する処理がある

2. **削除後の確認**
   - `check_checkin_data.py`を実行して、削除が完了したことを確認

3. **`create_staging_test_data.py`の削除処理を改善**
   - `delete_checkin_data.py`の削除処理を参考に、より完全な削除処理を実装
   - 外部キー制約を考慮した削除順序に修正
   - 重複削除処理を削除

### 4.2 長期的な対策

1. **削除処理の統一**
   - `create_staging_test_data.py`と`delete_checkin_data.py`の削除処理を統一
   - 共通の削除関数を作成

2. **削除後の確認処理の追加**
   - 削除処理実行後、自動的に確認処理を実行
   - 削除が完了していない場合はエラーを出力

---

## 5. 実施手順

### 5.1 バックアップの取得

1. **データベースバックアップの取得**
   - ステージング環境のデータベースバックアップを取得
   - バックアップファイル名: `database_backup_checkin_cleanup_20251215_134530.sql`

### 5.2 削除処理の実行

1. **`delete_checkin_data.py`を実行**
   - ステージング環境のデータベースに接続
   - 「check-in」関連データを完全削除

2. **削除後の確認**
   - `check_checkin_data.py`を実行
   - 削除が完了したことを確認

### 5.3 `create_staging_test_data.py`の改善

1. **削除処理の改善**
   - `delete_checkin_data.py`の削除処理を参考に、より完全な削除処理を実装
   - 外部キー制約を考慮した削除順序に修正
   - 重複削除処理を削除

2. **削除後の確認処理の追加**
   - 削除処理実行後、自動的に確認処理を実行

---

## 6. まとめ

### 6.1 問題の要約

**問題**: ステージング環境のテストデータに「check-in」関連の質問が残存している

**原因**:
1. `create_staging_test_data.py`の削除処理が不十分
2. 外部キー制約を考慮していない
3. 削除順序に問題がある
4. 重複削除処理がある

### 6.2 解決策

1. **即座に実施**: `delete_checkin_data.py`を実行して完全削除
2. **確認**: `check_checkin_data.py`を実行して削除完了を確認
3. **改善**: `create_staging_test_data.py`の削除処理を改善

---

**Document Version**: v1.0  
**Author**: AI Assistant  
**Last Updated**: 2025-12-15 13:45:30  
**Status**: 📋 **完全調査分析完了、修正準備完了**
