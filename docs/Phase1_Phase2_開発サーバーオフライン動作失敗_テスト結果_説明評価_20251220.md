# Phase 1・Phase 2: 開発サーバーオフライン動作失敗 テスト結果・説明・評価

**作成日時**: 2025年12月20日 11時29分11秒  
**実施者**: AI Assistant  
**目的**: 開発サーバー（5173）でのオフライン動作テスト結果の説明と評価  
**状態**: 📋 **テスト結果分析完了・説明・評価完了**

**重要**: 指示があるまで修正を実施しません。説明と評価のみです。

---

## 1. テスト結果の詳細

### 1.1 実施したテスト

**テストケース**: オフライン時の施設情報取得エラー（Welcome.vue）

**実施手順**:
1. ブラウザで`http://localhost:5173/f/test-facility?location=entrance`にアクセス
2. 開発者ツールの`Network`タブで`Offline`モードを有効化
3. ページをリロード（`F5`キー）
4. エラーメッセージを確認

**テスト結果**:
- ❌ **言語選択ページが再表示されない**
- ❌ Chromeのデフォルトオフラインエラーページが表示される
- ❌ エラーメッセージ: 「インターネットに接続されていません」
- ❌ エラーコード: `ERR_INTERNET_DISCONNECTED`

### 1.2 比較対象の動作

**プレビューサーバー（4173）**:
- ✅ オフライン時に言語選択ページが再表示される
- ✅ Service Workerが正常に動作している

**ステージング環境**:
- ✅ オフライン時に言語選択ページが再表示される
- ✅ Service Workerが正常に動作している

**開発サーバー（5173）**:
- ❌ オフライン時に言語選択ページが再表示されない
- ❌ Chromeのデフォルトオフラインエラーページが表示される

---

## 2. 原因分析

### 2.1 直接原因

**原因**: **開発サーバー（`npm run dev`）ではService Workerが登録されない**

**詳細**:
- 開発サーバー（`npm run dev`）は、ソースコードを直接実行する（Viteの開発モード）
- Service Workerはビルド済みファイル（`dist/`）に含まれている
- 開発サーバーでは、ビルド済みファイルが提供されていない
- そのため、Service Workerが登録されず、オフライン時に静的リソースがキャッシュから読み込まれない
- 結果として、Chromeのデフォルトオフラインエラーページが表示される

### 2.2 根本原因

**根本原因**: **開発モードと本番ビルドの違い**

**開発モード（`npm run dev`）**:
- ポート: `5173`
- 動作: ソースコードを直接実行（Viteの開発モード）
- Service Worker: **自動登録されない**
- 理由: `vite-plugin-pwa`は開発モードではService Workerを登録しない設定になっている（デフォルト動作）

**本番ビルド（`npm run build` + `npm run preview`）**:
- ポート: `4173`
- 動作: ビルド済みファイル（`dist/`）を提供
- Service Worker: **自動登録される**
- 理由: ビルド済みファイルには`registerSW.js`が含まれており、`index.html`から読み込まれる

**ステージング環境**:
- 動作: ビルド済みファイル（`dist/`）を提供
- Service Worker: **自動登録される**
- 理由: ビルド済みファイルがデプロイされている

### 2.3 以前の調査結果との整合性

**以前の調査結果**:
- `docs/Phase1_Phase2_開発サーバーオフライン動作失敗_原因分析_説明評価_20251219.md`
- `docs/Phase1_Phase2_ServiceWorker未登録_原因分析_説明評価_20251219.md`

**結論**:
- 開発サーバーでService Workerが登録されないのは、**予想される動作**である可能性が高い
- プレビューサーバー（`localhost:4173`）では正常に動作している
- ステージング環境でも正常に動作している

**今回のテスト結果との整合性**:
- ✅ **以前の調査結果と完全に一致**
- ✅ 開発サーバー（5173）ではオフライン動作が失敗
- ✅ プレビューサーバー（4173）ではオフライン動作が成功
- ✅ ステージング環境ではオフライン動作が成功

---

## 3. 説明・評価

### 3.1 問題の説明

**問題**: 開発サーバー（`localhost:5173`）でオフライン動作が失敗している

**状況**:
- プレビューサーバー（`localhost:4173`）では成功している
- ステージング環境では成功している
- 開発サーバー（`localhost:5173`）では失敗している
- オフライン時にChromeのデフォルトオフラインエラーページが表示される

**影響**:
- 開発サーバーでのオフライン動作確認ができない
- ただし、プレビューサーバーでの確認は可能
- ステージング環境での確認も可能

### 3.2 評価

**評価**: ⚠️ **予想される動作（正常な動作）**

**理由**:
1. **開発サーバーでの動作**: ⚠️ **予想される動作**
   - 開発サーバー（`npm run dev`）では、Service Workerが自動登録されないのは正常な動作
   - これは、開発モードと本番ビルドの違いによるもの
   - `vite-plugin-pwa`のデフォルト動作として、開発モードではService Workerを登録しない

2. **プレビューサーバーでの動作**: ✅ **正常**
   - プレビューサーバー（`npm run preview`）では、Service Workerが正常に登録されている
   - オフライン動作も正常に動作している

3. **ステージング環境での動作**: ✅ **正常**
   - ステージング環境では、Service Workerが正常に登録されている
   - オフライン動作も正常に動作している

4. **開発サーバーでのオフライン動作確認**: ⚠️ **制限がある**
   - 開発サーバーでのオフライン動作確認は制限がある
   - プレビューサーバーまたはステージング環境での確認を推奨

**結論**: 
- 開発サーバーでオフライン動作が失敗するのは、**予想される動作（正常な動作）**である
- プレビューサーバー（`localhost:4173`）での確認を推奨
- ステージング環境でも正常に動作していることを確認済み

---

## 4. 技術的な詳細

### 4.1 VitePWAプラグインの動作

**`vite.config.ts`の設定**:
```typescript
VitePWA({
  registerType: 'autoUpdate',
  workbox: {
    globPatterns: ['**/*.{js,css,html,ico,png,svg}'],
    navigateFallback: '/index.html',
    navigateFallbackDenylist: [/^\/api\//],
    runtimeCaching: [
      // ...
    ]
  },
  // devOptionsが設定されていない
})
```

**問題点**:
- `devOptions`が設定されていない
- デフォルトでは、開発モード（`npm run dev`）ではService Workerが登録されない

**解決方法（オプション）**:
- `devOptions.enabled: true`を設定することで、開発モードでもService Workerを有効化できる
- ただし、開発効率が低下する可能性がある

### 4.2 Service Workerの登録プロセス

**本番ビルド（`npm run build`）**:
1. `dist/registerSW.js`が生成される
2. `dist/index.html`に`<script src="/registerSW.js"></script>`が追加される
3. ブラウザが`registerSW.js`を読み込む
4. `registerSW.js`が`sw.js`を登録する
5. Service Workerが有効化される

**開発モード（`npm run dev`）**:
1. `dist/registerSW.js`が生成されない（ビルドされていない）
2. `index.html`に`registerSW.js`のスクリプトタグが追加されない
3. Service Workerが登録されない

### 4.3 オフライン時の動作

**Service Workerが登録されている場合（プレビューサーバー・ステージング環境）**:
1. オフライン時にページをリロード
2. Service Workerが`navigateFallback: '/index.html'`を使用
3. キャッシュから`index.html`を読み込む
4. アプリケーションが起動し、言語選択ページが表示される

**Service Workerが登録されていない場合（開発サーバー）**:
1. オフライン時にページをリロード
2. Service Workerがないため、キャッシュから読み込めない
3. ネットワークリクエストが失敗（`ERR_INTERNET_DISCONNECTED`）
4. Chromeのデフォルトオフラインエラーページが表示される

---

## 5. 推奨事項

### 5.1 オフライン動作の確認方法

**推奨される確認方法**:

1. **プレビューサーバー（`localhost:4173`）での確認**: 🔴 **最高優先度**
   - URL: `http://localhost:4173/f/test-facility?location=entrance`
   - Service Workerが登録されている
   - オフライン動作が正常に動作する

2. **ステージング環境での確認**: 🟡 **中優先度**
   - URL: `https://yadopera-frontend-staging.onrender.com/f/test-facility?location=entrance`
   - Service Workerが登録されている
   - オフライン動作が正常に動作する（確認済み）

**開発サーバー（`localhost:5173`）での確認**:
- ⚠️ **制限がある**: Service Workerが登録されないため、オフライン動作の確認は制限がある
- ✅ **推奨しない**: プレビューサーバーまたはステージング環境での確認を推奨

### 5.2 開発サーバーでService Workerを有効化する場合（オプション）

**方法**: `vite.config.ts`に`devOptions`を追加

**設定例**:
```typescript
VitePWA({
  registerType: 'autoUpdate',
  devOptions: {
    enabled: true,
    type: 'module'
  },
  workbox: {
    // ...
  }
})
```

**注意事項**:
- 開発効率が低下する可能性がある
- HMR（Hot Module Replacement）との競合が発生する可能性がある
- 開発サーバーの起動時間が長くなる可能性がある

**推奨事項**:
- 開発サーバーでService Workerを有効化する必要がある場合のみ設定する
- 通常は、プレビューサーバーまたはステージング環境での確認を推奨

---

## 6. まとめ

### 6.1 テスト結果のまとめ

**開発サーバー（5173）**:
- ❌ オフライン時に言語選択ページが再表示されない
- ❌ Chromeのデフォルトオフラインエラーページが表示される
- ❌ Service Workerが登録されていない

**プレビューサーバー（4173）**:
- ✅ オフライン時に言語選択ページが再表示される
- ✅ Service Workerが正常に動作している

**ステージング環境**:
- ✅ オフライン時に言語選択ページが再表示される
- ✅ Service Workerが正常に動作している

### 6.2 評価

**評価**: ⚠️ **予想される動作（正常な動作）**

**理由**:
- 開発サーバーでオフライン動作が失敗するのは、予想される動作である
- プレビューサーバーでは正常に動作している
- ステージング環境でも正常に動作している
- 以前の調査結果と完全に一致している

### 6.3 推奨事項

**オフライン動作の確認方法**:
1. **プレビューサーバー（`localhost:4173`）での確認**: 🔴 **最高優先度**
2. **ステージング環境での確認**: 🟡 **中優先度**

**開発サーバーでのオフライン動作確認**:
- ⚠️ **制限がある**: Service Workerが登録されないため、オフライン動作の確認は制限がある
- ✅ **推奨しない**: プレビューサーバーまたはステージング環境での確認を推奨

---

**テスト結果分析完了日時**: 2025年12月20日 11時29分11秒  
**状態**: 📋 **テスト結果分析完了・説明・評価完了**

**重要**: 指示があるまで修正を実施しません。説明と評価のみです。
