# Phase 1・Phase 2: オフライン動作確認結果 完全調査分析・修正案

**作成日時**: 2025年12月19日 11時26分17秒  
**実施者**: AI Assistant  
**目的**: ブラウザテスト結果の完全調査分析と修正案の提示  
**状態**: 📋 **完全調査分析完了・修正案提示完了**

**重要**: 指示があるまで修正を実施しません。調査分析と修正案の提示のみです。

---

## 1. 問題の詳細

### 1.1 ユーザーが報告した問題

**問題**: 改善が見られない

**発生状況**:
- 言語選択ページでオフライン設定しリロード → 再表示確認
- 言語選択ボタンをクリック → 「施設情報の取得に失敗しました」エラーが発生

**期待されていた動作**:
- オフライン時に「現在オフラインです。インターネット接続を確認してください。」と表示される
- 修正前の「施設情報の取得に失敗しました」ではなく、適切なメッセージが表示される

### 1.2 スクリーンショットから確認した内容

**Consoleタブのエラー**:
1. **Service Workerスクリプトの読み込みエラー**:
   ```
   An unknown error occurred when fetching the script.
   Uncaught (in promise) NetworkError: Failed to execute 'importScripts' on 'WorkerGlobalScope': 
   The script at 'http://localhost:4173/workbox-c31f4fe3.js' failed to load.
   ```
   - Service Workerが`workbox-c31f4fe3.js`を読み込めていない
   - これにより、Service Workerが正しく機能していない可能性がある

2. **施設情報取得エラー**:
   ```
   Facility fetch error: 
   {code: 'NETWORK_ERROR', message: 'ネットワークエラーが発生しました。接続を確認してください。', details: {...}}
   ```
   - アプリケーション側でエラーを捕捉し、`NETWORK_ERROR`コードを生成している

3. **ネットワークエラー（ブラウザ側）**:
   ```
   GET http://localhost:8000/api/v1/facility/test-facility net::ERR_INTERNET_DISCONNECTED
   ```
   - バックエンドAPIへのリクエストが、ネットワーク切断により失敗

**Networkタブの内容**:
- `workbox-c31f4fe3.js`が失敗（`net::E...`）
- `test-facility`（xhr）が失敗（`net::E...`）
- 他の静的リソースは`200`で正常にロードされている

**UIの表示内容**:
- 「施設情報の取得に失敗しました」が表示されている
- 修正後のコードでは「現在オフラインです。インターネット接続を確認してください。」と表示されるはずだが、修正前のメッセージが表示されている

---

## 2. 完全調査分析

### 2.1 問題1: Service Workerスクリプトの読み込みエラー

**問題**: `workbox-c31f4fe3.js`が読み込めない

**原因分析**:
1. **オフライン時にService Workerスクリプトが読み込めない**
   - Service Worker（`sw.js`）は`workbox-c31f4fe3.js`を`importScripts`で読み込もうとしている
   - オフライン時、このスクリプトがキャッシュに存在しない場合、読み込めない
   - Service Workerが正しく機能しないと、`NetworkFirst`戦略も機能しない

2. **Service Workerの登録タイミングの問題**
   - Service Workerは、オンライン時に登録される必要がある
   - オフライン時に初めてアクセスした場合、Service Workerが登録されない可能性がある

**影響**:
- Service Workerが正しく機能しない
- `NetworkFirst`戦略が機能しない
- オフライン時にキャッシュから提供されない

### 2.2 問題2: エラーメッセージが修正前のまま

**問題**: 「施設情報の取得に失敗しました」が表示されている

**原因分析**:
1. **`navigator.onLine`の制限**
   - `navigator.onLine`は、開発者ツールの「Offline」モードを検出できない可能性がある
   - 開発者ツールの「Offline」モードは、実際のネットワーク接続状態を変更するのではなく、ネットワークリクエストをブロックするだけ
   - そのため、`navigator.onLine`は`true`のままである可能性がある

2. **エラーハンドリングのロジック**
   - 修正後のコードでは、`isOffline.value || err.code === 'NETWORK_ERROR'`の条件でオフライン時のメッセージを表示する
   - しかし、`isOffline.value`が`false`のままである可能性がある
   - `err.code === 'NETWORK_ERROR'`は正しく動作しているが、`else`節で汎用的なメッセージが表示されている可能性がある

**確認が必要な点**:
- `isOffline.value`の値が正しく更新されているか
- エラーハンドリングのロジックが正しく実行されているか

### 2.3 問題3: useOfflineコンポーザブルの動作

**問題**: `navigator.onLine`が開発者ツールの「Offline」モードを検出できない

**原因分析**:
1. **`navigator.onLine`の仕様**
   - `navigator.onLine`は、実際のネットワーク接続状態を反映する
   - 開発者ツールの「Offline」モードは、ネットワークリクエストをブロックするだけで、`navigator.onLine`を変更しない
   - そのため、`navigator.onLine`は`true`のままである可能性がある

2. **`online`/`offline`イベントの動作**
   - `online`/`offline`イベントは、`navigator.onLine`の値が変更されたときに発火する
   - 開発者ツールの「Offline」モードでは、`navigator.onLine`が変更されないため、イベントが発火しない
   - そのため、`isOffline.value`が更新されない

**影響**:
- `isOffline.value`が`false`のままである
- オフライン時のメッセージが表示されない
- エラーハンドリングのロジックが正しく動作しない

### 2.4 根本原因の分析

**根本原因1: `navigator.onLine`の制限**
- `navigator.onLine`は、開発者ツールの「Offline」モードを検出できない
- 開発者ツールの「Offline」モードは、ネットワークリクエストをブロックするだけで、`navigator.onLine`を変更しない
- そのため、`useOffline`コンポーザブルが正しく動作しない

**根本原因2: Service Workerスクリプトの読み込みエラー**
- オフライン時に`workbox-c31f4fe3.js`が読み込めない
- Service Workerが正しく機能しない
- `NetworkFirst`戦略が機能しない

**根本原因3: エラーハンドリングのロジック**
- `isOffline.value`が`false`のままであるため、オフライン時のメッセージが表示されない
- `err.code === 'NETWORK_ERROR'`は正しく動作しているが、`else`節で汎用的なメッセージが表示されている可能性がある

---

## 3. 説明・評価

### 3.1 問題の説明

**問題**: 改善が見られない

**状況**:
- エラーメッセージが修正前のまま（「施設情報の取得に失敗しました」）
- Service Workerスクリプトが読み込めない
- `useOffline`コンポーザブルが正しく動作していない

**影響**:
- オフライン時に適切なメッセージが表示されない
- ユーザーがオフライン状態であることを理解できない
- ユーザー体験が低下する

### 3.2 評価

**評価**: ⚠️ **問題が確認された**

**理由**:
1. **Service Workerの動作**: ❌ **問題が発生**
   - Service Workerスクリプトが読み込めない
   - Service Workerが正しく機能していない

2. **オフライン検出機能**: ❌ **正しく動作していない**
   - `navigator.onLine`が開発者ツールの「Offline」モードを検出できない
   - `isOffline.value`が`false`のままである

3. **エラーハンドリング**: ⚠️ **部分的に機能**
   - `err.code === 'NETWORK_ERROR'`は正しく動作している
   - しかし、`isOffline.value`が`false`のため、オフライン時のメッセージが表示されない

**結論**: 
- `navigator.onLine`の制限により、オフライン検出機能が正しく動作していない
- Service Workerスクリプトの読み込みエラーにより、Service Workerが正しく機能していない
- エラーハンドリングのロジックを改善する必要がある

---

## 4. 大原則への準拠

### 4.1 大原則の確認

**大原則**:
1. **根本解決 > 暫定解決**: 一時的な対処よりも根本的な解決を優先
2. **シンプル構造 > 複雑構造**: 複雑な実装よりもシンプルで理解しやすい構造を優先
3. **統一・同一化 > 特殊独自**: 特殊な実装よりも統一されたパターンを優先
4. **具体的 > 一般**: 抽象的な実装よりも具体的で明確な実装を優先
5. **安全は確保しながら拙速**: MVPアプローチと安全性のバランスを取る。安全を確保しながら迅速に進める

### 4.2 大原則への準拠評価

**根本解決 > 暫定解決**: ✅ **準拠**
- `navigator.onLine`の制限を回避する根本的な解決を提案する
- 一時的な回避策ではなく、根本的な解決

**シンプル構造 > 複雑構造**: ✅ **準拠**
- エラーハンドリングのロジックを改善するシンプルな実装を提案する
- 複雑な実装は不要

**統一・同一化 > 特殊独自**: ✅ **準拠**
- 既存のエラーハンドリングパターンと統一
- 特殊な実装は不要

**具体的 > 一般**: ✅ **準拠**
- 具体的なエラーメッセージ（オフライン時、ネットワークエラー時、サーバーエラー時）を表示
- 抽象的な実装は不要

**安全は確保しながら拙速**: ✅ **準拠**
- 既存のエラーハンドリングを活用することで、安全性を確保
- シンプルな実装により、迅速に進める

---

## 5. 修正案

### 5.1 修正案1: エラーハンドリングの改善（推奨）

**目的**: `navigator.onLine`の制限を回避し、ネットワークエラー時に適切なメッセージを表示する

**実装内容**:
1. `err.code === 'NETWORK_ERROR'`の場合、常にオフライン時のメッセージを表示する
2. `isOffline.value`のチェックを削除するか、補助的なチェックとして使用する

**修正箇所**: `frontend/src/views/guest/Welcome.vue`

**修正前**:
```typescript
catch (err: any) {
  // オフライン時のエラーメッセージ
  if (isOffline.value || err.code === 'NETWORK_ERROR') {
    error.value = '現在オフラインです。インターネット接続を確認してください。'
  } else if (err.code === 'TIMEOUT_ERROR') {
    error.value = 'リクエストがタイムアウトしました。接続を確認して再度お試しください。'
  } else if (err.code === 'SERVER_ERROR') {
    error.value = 'サーバーエラーが発生しました。しばらくしてから再度お試しください。'
  } else {
    error.value = '施設情報の取得に失敗しました'
  }
  console.error('Facility fetch error:', err)
}
```

**修正後**:
```typescript
catch (err: any) {
  // オフライン時のエラーメッセージ
  // NETWORK_ERRORの場合は、navigator.onLineの値に関わらずオフライン時のメッセージを表示
  if (err.code === 'NETWORK_ERROR') {
    error.value = '現在オフラインです。インターネット接続を確認してください。'
  } else if (err.code === 'TIMEOUT_ERROR') {
    error.value = 'リクエストがタイムアウトしました。接続を確認して再度お試しください。'
  } else if (err.code === 'SERVER_ERROR') {
    error.value = 'サーバーエラーが発生しました。しばらくしてから再度お試しください。'
  } else {
    error.value = '施設情報の取得に失敗しました'
  }
  console.error('Facility fetch error:', err)
}
```

**期待される効果**:
- `NETWORK_ERROR`の場合、常にオフライン時のメッセージが表示される
- `navigator.onLine`の制限を回避できる
- ユーザーに適切な情報を提供できる

**大原則への準拠**: ✅ **すべて準拠**

### 5.2 修正案2: Service Workerスクリプトのプリキャッシュ（検討）

**目的**: オフライン時にService Workerスクリプトが読み込めるようにする

**実装内容**:
1. `workbox-c31f4fe3.js`をプリキャッシュに含める
2. `vite.config.ts`の`globPatterns`に`workbox-*.js`を追加する

**修正箇所**: `frontend/vite.config.ts`

**修正内容**:
```typescript
workbox: {
  globPatterns: ['**/*.{js,css,html,ico,png,svg}'],
  // workboxスクリプトもプリキャッシュに含める
  additionalManifestEntries: [
    { url: '/workbox-*.js', revision: null }
  ],
  // ...
}
```

**期待される効果**:
- オフライン時にService Workerスクリプトが読み込める
- Service Workerが正しく機能する

**大原則への準拠**: ⚠️ **検討が必要**
- `vite-plugin-pwa`の設定を変更する必要がある
- 慎重に検討する必要がある

### 5.3 推奨される修正案

**推奨**: **修正案1（エラーハンドリングの改善）**

**理由**:
1. **根本解決**: `navigator.onLine`の制限を回避する根本的な解決
2. **シンプル構造**: シンプルな実装
3. **統一・同一化**: 既存のエラーハンドリングパターンと統一
4. **具体的**: 具体的なエラーメッセージを表示
5. **安全は確保しながら拙速**: 既存のエラーハンドリングを活用することで、安全性を確保

**修正案2について**:
- 修正案1を実装した後、必要に応じて検討する
- 現時点では、修正案1の実装を優先する

---

## 6. 修正案の詳細

### 6.1 修正案1: エラーハンドリングの改善

#### 6.1.1 `Welcome.vue`の修正

**修正箇所**: `frontend/src/views/guest/Welcome.vue`

**修正内容**:
1. `isOffline.value`のチェックを削除
2. `err.code === 'NETWORK_ERROR'`の場合、常にオフライン時のメッセージを表示

**修正後のコード**:
```typescript
catch (err: any) {
  // オフライン時のエラーメッセージ
  // NETWORK_ERRORの場合は、navigator.onLineの値に関わらずオフライン時のメッセージを表示
  if (err.code === 'NETWORK_ERROR') {
    error.value = '現在オフラインです。インターネット接続を確認してください。'
  } else if (err.code === 'TIMEOUT_ERROR') {
    error.value = 'リクエストがタイムアウトしました。接続を確認して再度お試しください。'
  } else if (err.code === 'SERVER_ERROR') {
    error.value = 'サーバーエラーが発生しました。しばらくしてから再度お試しください。'
  } else {
    error.value = '施設情報の取得に失敗しました'
  }
  console.error('Facility fetch error:', err)
}
```

#### 6.1.2 `Chat.vue`の修正

**修正箇所**: `frontend/src/views/guest/Chat.vue`

**修正内容**:
1. `isOffline.value`のチェックを削除（メッセージ送信ブロックは残す）
2. `err.code === 'NETWORK_ERROR'`の場合、常にオフライン時のメッセージを表示

**修正後のコード**:
```typescript
catch (err: any) {
  // オフライン時のエラーメッセージ
  // NETWORK_ERRORの場合は、navigator.onLineの値に関わらずオフライン時のメッセージを表示
  if (err.code === 'NETWORK_ERROR') {
    error.value = '現在オフラインです。インターネット接続を確認してください。'
  } else if (err.code === 'TIMEOUT_ERROR') {
    error.value = 'リクエストがタイムアウトしました。接続を確認して再度お試しください。'
  } else if (err.code === 'SERVER_ERROR') {
    error.value = 'サーバーエラーが発生しました。しばらくしてから再度お試しください。'
  } else {
    error.value = '施設情報の取得に失敗しました'
  }
  console.error('[Chat.vue] onMounted: 施設情報取得エラー', err)
  return
}
```

**メッセージ送信時のエラーハンドリング**:
```typescript
catch (err: any) {
  console.error('[Chat.vue] handleMessageSubmit: エラー', err, {
    messagesCount: messages.value.length,
    messages: messages.value
  })
  
  // オフライン時のエラーメッセージ
  // NETWORK_ERRORの場合は、navigator.onLineの値に関わらずオフライン時のメッセージを表示
  if (err.code === 'NETWORK_ERROR') {
    error.value = '現在オフラインです。インターネット接続を確認してください。'
  } else if (err.code === 'TIMEOUT_ERROR') {
    error.value = 'リクエストがタイムアウトしました。接続を確認して再度お試しください。'
  } else if (err.code === 'SERVER_ERROR') {
    error.value = 'サーバーエラーが発生しました。しばらくしてから再度お試しください。'
  } else {
    error.value = err.message || 'メッセージの送信に失敗しました'
  }
}
```

### 6.2 修正案2: Service Workerスクリプトのプリキャッシュ（検討）

**修正箇所**: `frontend/vite.config.ts`

**修正内容**:
1. `workbox-*.js`をプリキャッシュに含める
2. `globPatterns`に`workbox-*.js`を追加する

**注意**: `vite-plugin-pwa`の設定を確認し、適切な方法で実装する必要がある

---

## 7. 修正案の評価

### 7.1 修正案1の評価

**評価**: ✅ **推奨**

**理由**:
1. **根本解決**: `navigator.onLine`の制限を回避する根本的な解決
2. **シンプル構造**: シンプルな実装
3. **統一・同一化**: 既存のエラーハンドリングパターンと統一
4. **具体的**: 具体的なエラーメッセージを表示
5. **安全は確保しながら拙速**: 既存のエラーハンドリングを活用することで、安全性を確保

### 7.2 修正案2の評価

**評価**: ⚠️ **検討が必要**

**理由**:
1. **Service Workerスクリプトのプリキャッシュ**: `vite-plugin-pwa`の設定を変更する必要がある
2. **実装の複雑さ**: 実装が複雑になる可能性がある
3. **修正案1の優先**: 修正案1を実装した後、必要に応じて検討する

---

## 8. まとめ

### 8.1 問題の原因

**直接原因**: **`navigator.onLine`の制限**
- `navigator.onLine`は、開発者ツールの「Offline」モードを検出できない
- 開発者ツールの「Offline」モードは、ネットワークリクエストをブロックするだけで、`navigator.onLine`を変更しない
- そのため、`isOffline.value`が`false`のままである

**根本原因**: **エラーハンドリングのロジック**
- `isOffline.value`に依存しているため、`navigator.onLine`の制限の影響を受ける
- `err.code === 'NETWORK_ERROR'`は正しく動作しているが、`isOffline.value`のチェックにより、オフライン時のメッセージが表示されない

### 8.2 評価

**評価**: ⚠️ **問題が確認された**

**理由**:
- `navigator.onLine`の制限により、オフライン検出機能が正しく動作していない
- エラーハンドリングのロジックを改善する必要がある

### 8.3 推奨される修正案

**推奨**: **修正案1（エラーハンドリングの改善）**

**実装内容**:
1. `Welcome.vue`のエラーハンドリングを改善
2. `Chat.vue`のエラーハンドリングを改善
3. `isOffline.value`のチェックを削除し、`err.code === 'NETWORK_ERROR'`の場合、常にオフライン時のメッセージを表示

**期待される効果**:
- `NETWORK_ERROR`の場合、常にオフライン時のメッセージが表示される
- `navigator.onLine`の制限を回避できる
- ユーザーに適切な情報を提供できる

**大原則への準拠**: ✅ **すべて準拠**

---

**完全調査分析完了日時**: 2025年12月19日 11時26分17秒  
**状態**: 📋 **完全調査分析完了・修正案提示完了**

**重要**: 指示があるまで修正を実施しません。調査分析と修正案の提示のみです。

