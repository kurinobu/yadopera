# Phase 2: 問題1 ローカル環境ログイン不可 - 完全調査分析・修正案

**作成日時**: 2025年12月13日 19:05 JST  
**調査者**: AI Assistant  
**緊急度**: ⚠️ **高** - ローカル環境でログインできない

---

## 1. 問題の概要

### 1.1 報告された問題

**問題**: ローカル環境でログインできない

**状況**:
- フロントエンド: `http://localhost:5173/`
- バックエンド: `http://localhost:8000`
- ログインボタンをクリックすると「ネットワークエラーが発生しました。接続を確認してください。」と表示される

### 1.2 発生しているエラー

**エラー1: CORSエラー**
```
Access to XMLHttpRequest at 'http://localhost:8000/api/v1/auth/me' from origin 'http://localhost:5173' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.
```

**エラー2: 500 Internal Server Error**
```
POST http://localhost:8000/api/v1/auth/login net::ERR_FAILED 500 (Internal Server Error)
GET http://localhost:8000/api/v1/auth/me net::ERR_FAILED 500 (Internal Server Error)
```

---

## 2. 完全調査分析結果

### 2.1 コードベースの確認結果

#### 2.1.1 CORS設定の確認

**確認結果**:
- ✅ `backend/app/core/config.py`の25行目: デフォルト値は`"http://localhost:5173,http://localhost:3000"`
- ✅ `backend/app/main.py`の18-24行目: CORSミドルウェアが正しく設定されている
- ✅ `backend/.env`ファイル: `CORS_ORIGINS=http://localhost:5173,http://localhost:3000`が設定されている
- ❌ **`docker-compose.yml`の`backend`サービスに`CORS_ORIGINS`環境変数が設定されていない**

**問題の根本原因**:
- Docker Composeの環境変数は`.env`ファイルよりも優先される
- `docker-compose.yml`の`backend`サービスに`CORS_ORIGINS`環境変数が設定されていないため、Dockerコンテナ内で`.env`ファイルが読み込まれていない可能性がある
- または、環境変数の読み込み順序の問題で、`CORS_ORIGINS`が正しく設定されていない

#### 2.1.2 認証処理の確認

**確認結果**:
- ✅ `backend/app/api/v1/auth.py`: ログインAPIエンドポイントが正しく実装されている
- ✅ `backend/app/services/auth_service.py`: 認証サービスが正しく実装されている
- ✅ `backend/app/core/security.py`: パスワード検証が正しく実装されている
- ✅ `backend/app/core/jwt.py`: JWTトークンの生成・検証が正しく実装されている
- ✅ `backend/app/api/deps.py`: `get_current_user`関数が正しく実装されている

**問題の根本原因**:
- 500エラーが発生しているが、バックエンドのログにエラーが表示されていない
- 考えられる原因：
  1. **CORSエラーが先に発生し、500エラーが隠れている可能性**
  2. **データベース接続エラー**
  3. **JWTトークンの生成/検証エラー**
  4. **認証処理のエラー**

---

## 3. 根本原因の特定

### 3.1 CORSエラーの根本原因

**根本原因**: `docker-compose.yml`の`backend`サービスに`CORS_ORIGINS`環境変数が設定されていない

**詳細**:
- Docker Composeの環境変数は`.env`ファイルよりも優先される
- `docker-compose.yml`の`backend`サービスに`CORS_ORIGINS`環境変数が設定されていないため、Dockerコンテナ内で`.env`ファイルが読み込まれていない、または環境変数の読み込み順序の問題で`CORS_ORIGINS`が正しく設定されていない

**証拠**:
- `docker-compose.yml`の`backend`サービスの環境変数:
  ```yaml
  environment:
    - DATABASE_URL=postgresql://yadopera_user:yadopera_password@postgres:5432/yadopera
    - REDIS_URL=redis://redis:6379/0
    - ENVIRONMENT=development
    - DEBUG=True
    - OPENAI_API_KEY=${OPENAI_API_KEY}
  ```
  - `CORS_ORIGINS`が設定されていない

### 3.2 500エラーの根本原因

**根本原因**: CORSエラーが先に発生し、500エラーが隠れている可能性が高い

**詳細**:
- CORSエラーが発生すると、ブラウザがリクエストをブロックするため、バックエンドにリクエストが到達しない
- しかし、500エラーも同時に発生している可能性がある
- まずCORSエラーを解決してから、500エラーの原因を調査する必要がある

---

## 4. 修正案

### 4.1 修正案1: `docker-compose.yml`に`CORS_ORIGINS`環境変数を追加（根本解決）★推奨

**目的**: Docker Composeの環境変数で`CORS_ORIGINS`を明示的に設定する

**実施内容**:
1. `docker-compose.yml`の`backend`サービスの環境変数に`CORS_ORIGINS`を追加

**修正ファイル**: `docker-compose.yml`

**修正内容**:
```yaml
backend:
  build:
    context: ./backend
    dockerfile: Dockerfile
  container_name: yadopera-backend
  environment:
    - DATABASE_URL=postgresql://yadopera_user:yadopera_password@postgres:5432/yadopera
    - REDIS_URL=redis://redis:6379/0
    - ENVIRONMENT=development
    - DEBUG=True
    - OPENAI_API_KEY=${OPENAI_API_KEY}
    - CORS_ORIGINS=http://localhost:5173,http://localhost:3000  # 追加
    - SECRET_KEY=${SECRET_KEY}  # 追加（.envから読み込む）
  ports:
    - "8000:8000"
  volumes:
    - ./backend:/app
  depends_on:
    postgres:
      condition: service_healthy
    redis:
      condition: service_healthy
  command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

**大原則への準拠**:
- ✅ **根本解決**: Docker Composeの環境変数で`CORS_ORIGINS`を明示的に設定することで、CORSエラーを根本的に解決
- ✅ **シンプル構造**: 環境変数を追加するだけ
- ✅ **統一・同一化**: すべての環境変数を`docker-compose.yml`で管理
- ✅ **安全/確実**: 環境変数を明示的に設定することで、確実にCORS設定が適用される

**期待される結果**:
- CORSエラーが解消される
- ログインAPIが正常に動作する
- 500エラーの原因が明確になる（CORSエラーが解消された後）

---

## 5. 修正実施手順

### 5.1 修正案1の実施

**ステップ1: `docker-compose.yml`を修正**

1. `docker-compose.yml`の`backend`サービスの環境変数に以下を追加:
   ```yaml
   - CORS_ORIGINS=http://localhost:5173,http://localhost:3000
   - SECRET_KEY=${SECRET_KEY}
   ```

**ステップ2: Docker Composeを再起動**

```bash
# バックエンドサービスを再起動
docker-compose restart backend

# または、すべてのサービスを再起動
docker-compose down
docker-compose up -d
```

**ステップ3: 動作確認**

1. ブラウザで `http://localhost:5173/admin/login` にアクセス
2. ログインボタンをクリック
3. CORSエラーが解消されているか確認
4. ログインが成功するか確認

---

## 6. 500エラーの追加調査（CORSエラー解決後）

### 6.1 500エラーの原因調査

CORSエラーが解消された後、500エラーの原因を調査する必要があります。

**調査項目**:
1. バックエンドのログを確認
   ```bash
   docker-compose logs backend --tail 100
   ```
2. データベース接続を確認
3. JWTトークンの生成・検証を確認
4. 認証処理のエラーを確認

---

## 7. まとめ

### 7.1 問題の要約

**問題**: ローカル環境でログインできない

**根本原因**:
1. **CORSエラー**: `docker-compose.yml`の`backend`サービスに`CORS_ORIGINS`環境変数が設定されていない
2. **500エラー**: CORSエラーが先に発生し、500エラーの原因が隠れている可能性がある

### 7.2 修正案

**修正案1（推奨）**: `docker-compose.yml`に`CORS_ORIGINS`環境変数を追加

**大原則への準拠**: ✅ **完全準拠**

### 7.3 次のステップ

1. **修正案1を実施**
   - `docker-compose.yml`に`CORS_ORIGINS`環境変数を追加
   - Docker Composeを再起動

2. **動作確認**
   - CORSエラーが解消されているか確認
   - ログインが成功するか確認

3. **500エラーの追加調査（必要に応じて）**
   - CORSエラーが解消された後、500エラーの原因を調査

---

**状態**: ✅ **完全調査分析完了 → 修正案提示完了**

