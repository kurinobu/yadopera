# Phase 2: ブラウザテスト結果 現状把握・残る課題一覧

**作成日**: 2025年12月2日  
**実施者**: Auto (AI Assistant)  
**対象**: Phase 2 ステップ1（管理画面・ゲスト画面の動作確認）  
**状態**: 🔍 **現状把握完了 → 残る課題一覧**

---

## 1. テスト結果の説明と評価

### 1.1 管理画面の状況

#### 動作している機能
- ✅ ダッシュボードの表示（総質問数、自動応答率、平均信頼度など）
- ✅ FAQ一覧の表示（4件のFAQが表示されている）
- ✅ 未解決質問リストの表示（2件）
- ✅ ゲストフィードバック連動FAQの表示（👎評価が2回以上ついた回答）

#### 動作していない機能
- ❌ 新規FAQ登録後の画面反映（登録は成功しているが、画面にすぐには反映されない）
- ❌ FAQ削除機能（削除は成功しているが、画面に反映されない）
- ❌ 未解決質問リストからのFAQ追加（FAQ提案の承認エラー）
- ❌ ゲストフィードバック連動FAQからのFAQ改善提案（FAQ提案の生成エラー）

---

### 1.2 ゲスト画面の状況

#### 動作している機能
- ✅ 施設情報の表示（名前、電話番号、メールアドレス、チェックイン/アウト時間）
- ✅ メッセージ送信機能（メッセージは正常に送信されている）
- ✅ メッセージ表示機能（ユーザーメッセージとAI応答が表示されている）
- ✅ 緊急連絡先の表示

#### 動作していない機能
- ❌ よくある質問の表示（「よくある質問はありません」と表示されている）
- ❌ 正常なAI応答の生成（フォールバックメッセージが表示されている）

---

## 2. 残る課題の完全な列挙

### 2.1 管理画面の課題

#### 課題1: 新規FAQ登録後の画面反映問題

**問題の詳細**:
- 新規FAQを登録しても、画面にすぐには反映されない
- バックエンドログから、FAQ作成は成功している（`POST /api/v1/admin/faqs HTTP/1.1" 201 Created`）
- フロントエンドは`fetchFaqs()`を呼んでいるが、画面が更新されない

**評価**: **中** - 機能は動作しているが、UXが悪い

**考えられる原因**:
1. フロントエンドの`fetchFaqs()`が正常に動作していない
2. キャッシュの問題（Redisキャッシュが無効化されていない、またはフロントエンドのキャッシュ）
3. フロントエンドの状態管理の問題（Piniaストアが更新されていない）

---

#### 課題2: FAQ削除機能の画面反映問題

**問題の詳細**:
- FAQ一覧から削除ボタンをタップし、「はい」と答えるが削除されず一覧は変更されない
- バックエンドログから、FAQ削除は成功している（`DELETE /api/v1/admin/faqs/1 HTTP/1.1" 204 No Content`）
- フロントエンドは`fetchFaqs()`を呼んでいるが、画面が更新されない

**評価**: **中** - 機能は動作しているが、UXが悪い

**考えられる原因**:
1. フロントエンドの`fetchFaqs()`が正常に動作していない
2. キャッシュの問題（Redisキャッシュが無効化されていない、またはフロントエンドのキャッシュ）
3. フロントエンドの状態管理の問題（Piniaストアが更新されていない）

---

#### 課題3: 未解決質問リストからのFAQ追加エラー

**問題の詳細**:
- 「承認してFAQに追加」ボタンをタップするとエラーが表示される
- エラーメッセージ: `FAQ suggestion not found: suggestion_id=1. Please refresh the page and try again.`
- HTTPステータス: `400 Bad Request`

**評価**: **重大** - 機能が完全に動作しない

**根本原因**:
- フロントエンドが存在しない提案ID（suggestion_id=1）を参照している
- データベースに該当するFAQ提案が存在しない
- フロントエンドのFAQ提案一覧とデータベースの状態が不一致

**考えられる原因**:
1. フロントエンドが古い提案IDを参照している（キャッシュの問題）
2. 提案が削除された、または別の施設に属している
3. フロントエンドのFAQ提案一覧取得処理に問題がある

---

#### 課題4: ゲストフィードバック連動FAQからのFAQ改善提案エラー

**問題の詳細**:
- 「FAQ改善提案」ボタンを押すとエラーが表示される
- エラーメッセージ: `Message not found: message_id=201`
- HTTPステータス: `400 Bad Request`

**評価**: **重大** - 機能が完全に動作しない

**根本原因**:
- フロントエンドが存在しないメッセージID（message_id=201）を参照している
- データベースに該当するメッセージが存在しない
- フロントエンドのメッセージ一覧とデータベースの状態が不一致

**考えられる原因**:
1. フロントエンドが古いメッセージIDを参照している（キャッシュの問題）
2. メッセージが削除された、または別の施設に属している
3. フロントエンドのメッセージ一覧取得処理に問題がある

---

### 2.2 ゲスト画面の課題

#### 課題5: よくある質問が表示されない問題

**問題の詳細**:
- ゲスト画面で「よくある質問はありません」と表示されている
- 管理画面には4件のFAQが表示されているが、ゲスト画面には表示されない

**評価**: **重大** - 主要機能が動作しない

**根本原因**:
- `backend/app/services/facility_service.py`の`get_facility_public_info`メソッドで、`top_questions`が空リストのまま（実装されていない）
- コメント: `# よくある質問TOP3（Week 1では空リスト、Week 2で実装）`

**コード確認**:
```python
# よくある質問TOP3（Week 1では空リスト、Week 2で実装）
top_questions: List[str] = []
```

**考えられる原因**:
1. バックエンドで`top_questions`の取得処理が実装されていない
2. FAQからTOP3を取得する処理が必要

---

#### 課題6: フォールバックメッセージが表示される問題

**問題の詳細**:
- メッセージ送信後、フォールバックメッセージが表示される
- メッセージ: "Sorry, the automatic support system is temporarily unavailable. Please contact the staff directly for assistance."
- 信頼度: 70%と表示されているが、実際にはフォールバックメッセージ

**評価**: **重大** - 主要機能が動作しない

**根本原因**:
- OpenAI APIキーが無効
- エラーログ: `Incorrect API key provided: your_ope************here`
- 埋め込み生成と回答生成の両方でエラーが発生している

**ログ確認**:
```
OpenAI Embeddings API error
openai.AuthenticationError: Error code: 401 - {'error': {'message': 'Incorrect API key provided: your_ope************here. You can find your API key at https://platform.openai.com/account/api-keys.', 'type': 'invalid_request_error', 'param': None, 'code': 'invalid_api_key'}}
```

**考えられる原因**:
1. `.env`ファイルに`OPENAI_API_KEY`が正しく設定されていない
2. Dockerコンテナに環境変数が正しく渡されていない
3. APIキーが無効または期限切れ

---

### 2.3 データ整合性の課題

#### 課題7: フロントエンドとバックエンドのデータ不一致

**問題の詳細**:
- フロントエンドが存在しないID（suggestion_id=1, message_id=201）を参照している
- データベースの状態とフロントエンドの表示が不一致

**評価**: **重大** - データ整合性の問題

**考えられる原因**:
1. フロントエンドのキャッシュが古い
2. フロントエンドのデータ取得処理に問題がある
3. データベースの状態が変更されたが、フロントエンドが更新されていない

---

## 3. 課題の優先順位

### 3.1 最優先（重大）

1. **課題6: フォールバックメッセージが表示される問題**
   - OpenAI APIキーの設定が必要
   - これが解決されないと、AI機能が完全に動作しない

2. **課題5: よくある質問が表示されない問題**
   - バックエンドで`top_questions`の取得処理を実装する必要がある
   - 主要機能の一つ

3. **課題3: 未解決質問リストからのFAQ追加エラー**
   - フロントエンドとバックエンドのデータ不一致
   - 機能が完全に動作しない

4. **課題4: ゲストフィードバック連動FAQからのFAQ改善提案エラー**
   - フロントエンドとバックエンドのデータ不一致
   - 機能が完全に動作しない

### 3.2 高優先（中）

5. **課題1: 新規FAQ登録後の画面反映問題**
   - 機能は動作しているが、UXが悪い
   - フロントエンドの状態管理の問題

6. **課題2: FAQ削除機能の画面反映問題**
   - 機能は動作しているが、UXが悪い
   - フロントエンドの状態管理の問題

### 3.3 中優先

7. **課題7: フロントエンドとバックエンドのデータ不一致**
   - データ整合性の問題
   - 他の課題の根本原因の可能性がある

---

## 4. 結果の説明と評価

### 4.1 全体的な評価

**現状**: **部分的に動作している状態**

- **動作している機能**: ダッシュボード表示、FAQ一覧表示、メッセージ送信・表示
- **動作していない機能**: FAQ追加・削除の画面反映、FAQ提案の承認・生成、よくある質問の表示、正常なAI応答の生成

### 4.2 主要な問題点

1. **OpenAI APIキーの設定問題**:
   - 最も重要な問題
   - これが解決されないと、AI機能が完全に動作しない

2. **バックエンドの未実装機能**:
   - `top_questions`の取得処理が実装されていない
   - よくある質問が表示されない

3. **フロントエンドの状態管理問題**:
   - FAQ追加・削除後の画面反映が正常に動作していない
   - データ取得後の状態更新に問題がある可能性

4. **データ整合性の問題**:
   - フロントエンドとバックエンドのデータ不一致
   - キャッシュの問題の可能性

---

## 5. 次のステップ（修正案提示前の準備）

### 5.1 調査が必要な項目

1. **OpenAI APIキーの設定状況**:
   - `.env`ファイルの確認
   - Dockerコンテナの環境変数の確認

2. **フロントエンドの状態管理**:
   - `FaqManagement.vue`の`fetchFaqs()`の動作確認
   - Piniaストアの状態更新の確認

3. **データベースの状態**:
   - `faq_suggestions`テーブルのデータ確認
   - `messages`テーブルのデータ確認

4. **キャッシュの状態**:
   - Redisキャッシュの確認
   - フロントエンドのキャッシュの確認

---

## 6. まとめ

### 6.1 残る課題の総数

**合計7つの課題**:
- 重大: 4つ（課題3, 4, 5, 6）
- 中: 2つ（課題1, 2）
- 中優先: 1つ（課題7）

### 6.2 主要な問題領域

1. **OpenAI APIキーの設定**（課題6）
2. **バックエンドの未実装機能**（課題5）
3. **フロントエンドの状態管理**（課題1, 2）
4. **データ整合性**（課題3, 4, 7）

### 6.3 修正の優先順位

1. **最優先**: OpenAI APIキーの設定（課題6）
2. **高優先**: よくある質問の表示機能の実装（課題5）
3. **高優先**: FAQ提案の承認・生成エラーの解決（課題3, 4）
4. **中優先**: FAQ追加・削除後の画面反映問題の解決（課題1, 2）

---

**Document Version**: v1.0  
**Author**: Auto (AI Assistant)  
**Last Updated**: 2025-12-02  
**Status**: ✅ **現状把握完了 → 残る課題一覧完了**


