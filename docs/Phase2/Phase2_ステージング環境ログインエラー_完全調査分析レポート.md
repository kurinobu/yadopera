# Phase 2: ステージング環境ログインエラー 完全調査分析レポート

**作成日**: 2025年12月13日  
**作成者**: Auto (AI Assistant)  
**目的**: ステージング環境でのログインエラー（Incorrect email or password）の原因を完全に調査分析し、大原則に準拠した修正案を提示する

---

## 1. エラーの概要

### 1.1 エラーの発生状況

**エラーメッセージ**: `Incorrect email or password`  
**HTTPステータス**: `401 (Unauthorized)`  
**エンドポイント**: `POST https://yadopera-backend-staging.onrender.com/api/v1/auth/login`

**テストユーザー情報**:
- メールアドレス: `test@example.com`
- パスワード: `testpassword123`

### 1.2 エラーの発生箇所

**フロントエンド**: `https://yadopera-frontend-staging.onrender.com/admin/login`  
**バックエンド**: `https://yadopera-backend-staging.onrender.com/api/v1/auth/login`

---

## 2. 根本原因の分析

### 2.1 考えられる原因

#### 2.1.1 パスワードハッシュの不一致

**可能性**: ⚠️ **高い**

**詳細**:
- ステージング環境のデータベースにテストユーザーが存在しない
- テストユーザーのパスワードハッシュが正しく生成されていない
- パスワードハッシュの生成方法が変更された

**確認方法**:
- ステージング環境のデータベースでテストユーザーを確認
- パスワードハッシュの生成方法を確認

#### 2.1.2 テストユーザーが存在しない

**可能性**: ⚠️ **高い**

**詳細**:
- ステージング環境のデータベースにテストユーザーが作成されていない
- マイグレーションが実行されていない
- テストデータ作成スクリプトが実行されていない

**確認方法**:
- ステージング環境のデータベースでテストユーザーを確認
- マイグレーションの実行状況を確認

#### 2.1.3 パスワード検証ロジックの問題

**可能性**: ⚠️ **低い**

**詳細**:
- パスワード検証ロジックに問題がある
- `bcrypt`の互換性問題

**確認方法**:
- パスワード検証ロジックを確認
- `bcrypt`のバージョンを確認

---

## 3. 調査結果

### 3.1 テストユーザー作成スクリプトの確認

**ファイル**: `backend/create_test_data.py`

**確認内容**:
- テストユーザーの作成ロジック: ✅ 正しい
- パスワードハッシュの生成: ✅ 正しい（`hash_password("testpassword123")`）
- エラーハンドリング: ✅ 適切（`bcrypt`の互換性問題に対応）

**問題点**:
- ⚠️ ステージング環境でこのスクリプトが実行されていない可能性がある

### 3.2 ステージング環境のデータベース状態

**確認が必要な項目**:
1. テストユーザーが存在するか
2. パスワードハッシュが正しく生成されているか
3. マイグレーションが実行されているか

**確認方法**:
- ステージング環境のデータベースに直接接続して確認
- または、バックエンドのログを確認

---

## 4. 修正案

### 4.1 修正案1: ステージング環境でテストユーザーを作成する（根本的解決）★推奨

**目的**: ステージング環境のデータベースにテストユーザーを作成する

**実施内容**:

#### 4.1.1 ステージング環境のデータベースに接続

**方法1: Render.comのPostgreSQLに直接接続**
```bash
# Render.comのPostgreSQL接続情報を取得
# RailwayのPostgreSQLを使用している場合、Railwayの接続情報を使用
```

**方法2: バックエンドからテストデータ作成スクリプトを実行**
```bash
# ステージング環境の環境変数を設定
export DATABASE_URL="postgresql://user:password@host:port/database"
export REDIS_URL="redis://default:password@host:port"

# テストデータ作成スクリプトを実行
cd backend
python create_test_data.py
```

#### 4.1.2 テストユーザーの確認

**確認項目**:
- テストユーザーが存在するか
- パスワードハッシュが正しく生成されているか
- ユーザーがアクティブか（`is_active = true`）

**メリット**:
- ✅ 根本的解決: ステージング環境にテストユーザーを作成
- ✅ 大原則への準拠: 根本解決 > 暫定解決
- ✅ 安全/確実: テストユーザーを確実に作成

**デメリット**:
- ⚠️ ステージング環境のデータベースに接続する必要がある

**所要時間**: 約10分

---

### 4.2 修正案2: パスワードをリセットする（暫定解決）

**目的**: 既存のテストユーザーのパスワードをリセットする

**実施内容**:

#### 4.2.1 ステージング環境のデータベースでパスワードをリセット

```sql
-- ステージング環境のデータベースに接続
-- テストユーザーのパスワードをリセット
UPDATE users 
SET password_hash = '$2b$12$...'  -- 新しいパスワードハッシュ
WHERE email = 'test@example.com';
```

**メリット**:
- ✅ 即座にログインできる

**デメリット**:
- ❌ 暫定解決: 根本的な問題（テストユーザーが存在しない）を解決しない
- ❌ 大原則に反する: 根本解決ではなく、暫定解決

**推奨度**: ❌ **推奨しない**（暫定解決のため、根本解決を優先）

---

### 4.3 修正案3: テストデータ作成スクリプトを自動実行する（将来的な対策）

**目的**: デプロイ時に自動的にテストデータを作成する

**実施内容**:

#### 4.3.1 デプロイスクリプトにテストデータ作成を追加

```yaml
# render.yaml または GitHub Actions
build:
  commands:
    - pip install -r requirements.txt
    - alembic upgrade head
    - python create_test_data.py  # 追加
```

**メリット**:
- ✅ 自動化: デプロイ時に自動的にテストデータを作成
- ✅ 統一・同一化: すべての環境で同じテストデータを作成

**デメリット**:
- ⚠️ 既存データとの競合の可能性
- ⚠️ 本番環境では実行しない必要がある

**推奨度**: ⚠️ **中程度**（将来的な対策として検討）

---

## 5. 推奨される修正案

### 5.1 修正案1を推奨（根本的解決）

**理由**:
1. ✅ **根本的解決**: ステージング環境にテストユーザーを作成
2. ✅ **大原則への準拠**: 根本解決 > 暫定解決
3. ✅ **安全/確実**: テストユーザーを確実に作成

**実施手順**:
1. ステージング環境のデータベース接続情報を取得
2. `backend/create_test_data.py`を実行
3. テストユーザーが作成されたことを確認
4. ログインをテスト

---

## 6. PWAアイコンとvite.svgの404エラー

### 6.1 エラーの概要

**エラーメッセージ**:
- `GET https://yadopera-frontend-staging.onrender.com/pwa-192x192.png 404 (Not Found)`
- `GET https://yadopera-frontend-staging.onrender.com/vite.svg 404 (Not Found)`

### 6.2 原因の分析

**根本原因**: **PWAアイコンとvite.svgが`frontend/public`ディレクトリに存在しない**

**確認結果**:
- `frontend/public`ディレクトリ: 存在するが、空
- `pwa-192x192.png`: 存在しない
- `pwa-512x512.png`: 存在しない
- `vite.svg`: 存在しない

**アーキテクチャ設計書の確認**:
- アーキテクチャ設計書（v0.3）では、`pwa-192x192.png`と`pwa-512x512.png`が`frontend/public`に配置されることが想定されている
- `vite.config.ts`では、PWAアイコンが`pwa-192x192.png`と`pwa-512x512.png`として参照されている
- `index.html`では、`vite.svg`がファビコンとして参照されている

**評価**: ❌ **実装がアーキテクチャ設計書に準拠していなかった**

### 6.3 修正案

#### 6.3.1 PWAアイコンとvite.svgを作成する（根本的解決）★推奨

**目的**: PWAアイコンとvite.svgを作成し、`frontend/public`ディレクトリに配置する

**実施内容**:
1. PWAアイコン（`pwa-192x192.png`, `pwa-512x512.png`）を作成
   - 192x192ピクセルと512x512ピクセルのPNG画像を作成
   - 「やどぺら」のロゴまたはアイコンを使用
2. `vite.svg`を作成（または既存のものを使用）
   - ViteのデフォルトSVGアイコンを使用、または「やどぺら」のロゴを使用
3. `frontend/public`ディレクトリに配置

**メリット**:
- ✅ 根本的解決: PWAアイコンとvite.svgを提供
- ✅ 大原則への準拠: 根本解決 > 暫定解決
- ✅ アーキテクチャ設計書への準拠: PWAアイコンとvite.svgを提供

**デメリット**:
- ⚠️ アイコン画像を作成する必要がある

**所要時間**: 約10分（アイコン作成を含む）

---

#### 6.3.2 暫定解決: PWAアイコンとvite.svgの参照を削除する（推奨しない）

**目的**: PWAアイコンとvite.svgの参照を削除し、404エラーを回避する

**実施内容**:
1. `vite.config.ts`からPWAアイコンの参照を削除
2. `index.html`から`vite.svg`の参照を削除

**デメリット**:
- ❌ 暫定解決: PWAアイコンとvite.svgを提供しない
- ❌ 大原則に反する: 根本解決ではなく、回避策
- ❌ アーキテクチャ設計書に準拠していない

**推奨度**: ❌ **推奨しない**（暫定解決のため、根本解決を優先）

---

## 7. 調査結果のまとめ

### 7.1 ログインエラーの根本原因

**ステージング環境のデータベースにテストユーザーが存在しない、またはパスワードハッシュが正しく生成されていない**

### 7.2 修正案

**修正案1（推奨）**: ステージング環境でテストユーザーを作成する
- 根本的解決
- 大原則への準拠

### 7.3 PWAアイコンとvite.svgの404エラー

**根本原因**: PWAアイコンとvite.svgが`frontend/public`ディレクトリに存在しない

**修正案**: PWAアイコンとvite.svgを作成し、`frontend/public`ディレクトリに配置する

---

## 8. 解決状況（2025-12-13更新）

### 8.1 問題2: ステージング環境でテストユーザーが存在しない ✅ **解決済み**

**解決日**: 2025年12月13日  
**解決方法**: `backend/create_staging_test_data.py`を実行してテストユーザーを作成

**テストユーザー情報**:
- メールアドレス: `test@example.com`
- パスワード: `testpassword123`
- ユーザーID: 87
- 施設ID: 347
- 施設slug: `test-facility`

**状態**: ✅ ログイン可能

### 8.2 問題3: PWAアイコンとvite.svgの404エラー ✅ **解決済み**

**解決日**: 2025年12月13日  
**解決方法**: `frontend/public`ディレクトリに以下のファイルを作成

**作成したファイル**:
- `frontend/public/pwa-192x192.png`
- `frontend/public/pwa-512x512.png`
- `frontend/public/vite.svg`
- `frontend/public/favicon.ico`

**状態**: ✅ 404エラー解消

---

## 9. 大原則への準拠

- ✅ **根本解決**: ステージング環境にテストユーザーを作成し、PWAアイコンとvite.svgを提供
- ✅ **安全/確実**: テストユーザーを確実に作成し、PWAアイコンとvite.svgを提供
- ✅ **統一・同一化**: すべての環境で同じテストデータを作成

---

## 10. 参考資料

- `backend/create_test_data.py`
- `backend/create_staging_test_data.py`（ステージング環境用）
- `frontend/vite.config.ts`
- `frontend/index.html`
- `docs/Phase1/Phase1_ローカル環境動作確認レポート.md`
- `docs/Phase2/Phase2_引き継ぎ書_20251213.md`

---

**状態**: ✅ **問題2と問題3は解決済み（2025-12-13）**

