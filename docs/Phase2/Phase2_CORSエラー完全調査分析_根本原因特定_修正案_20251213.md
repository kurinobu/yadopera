# Phase 2: CORSエラー完全調査分析・根本原因特定・修正案

**作成日時**: 2025年12月13日  
**調査者**: AI Assistant  
**目的**: CORSエラーの完全な調査分析を行い、根本原因を特定し、大原則に準拠した修正案を提示する

---

## 1. 問題の概要

### 1.1 報告された問題

**問題**: CORSエラーが発生している

**エラーメッセージ**:
```
Access to XMLHttpRequest at 'http://localhost:8000/api/v1/auth/login' from origin 'http://localhost:5173' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.
```

**発生環境**:
- フロントエンド: `http://localhost:5173`
- バックエンド: `http://localhost:8000`
- Docker Compose環境

---

## 2. 完全調査分析結果

### 2.1 CORS設定の確認

#### 2.1.1 コードベースの確認

**`backend/app/main.py`**:
```python
# CORS設定
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins_list,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```
- ✅ CORSミドルウェアが正しく設定されている

**`backend/app/core/config.py`**:
```python
# CORS (comma-separated string to List[str])
cors_origins: str = "http://localhost:5173,http://localhost:3000"

@property
def cors_origins_list(self) -> List[str]:
    """CORS originsをリストに変換"""
    return [origin.strip() for origin in self.cors_origins.split(",")]
```
- ✅ デフォルト値は正しく設定されている

**`docker-compose.yml`**:
```yaml
environment:
  - CORS_ORIGINS=http://localhost:5173,http://localhost:3000
```
- ✅ 環境変数が正しく設定されている

#### 2.1.2 実行時環境の確認

**環境変数の確認**:
```bash
docker-compose exec backend env | grep -i "cors\|origin"
CORS_ORIGINS=http://localhost:5173,http://localhost:3000
```
- ✅ 環境変数が正しく設定されている

**設定値の確認**:
```bash
docker-compose exec backend python -c "from app.core.config import settings; print(f'CORS_ORIGINS: {settings.cors_origins_list}')"
CORS_ORIGINS: ['http://localhost:5173', 'http://localhost:3000']
```
- ✅ 設定値が正しく読み込まれている

### 2.2 OPTIONSリクエスト（プリフライト）の確認

**テスト結果**:
```bash
curl -v -X OPTIONS http://localhost:8000/api/v1/auth/login \
  -H "Origin: http://localhost:5173" \
  -H "Access-Control-Request-Method: POST"
```

**レスポンスヘッダー**:
```
< access-control-allow-methods: DELETE, GET, HEAD, OPTIONS, PATCH, POST, PUT
< access-control-max-age: 600
< access-control-allow-credentials: true
< access-control-allow-origin: http://localhost:5173
```

**結果**: ✅ **OPTIONSリクエスト（プリフライト）は正常に動作している**
- CORSヘッダーが正しく返されている
- `access-control-allow-origin: http://localhost:5173` が含まれている

### 2.3 POSTリクエストの確認

**テスト結果**:
```bash
curl -v -X POST http://localhost:8000/api/v1/auth/login \
  -H "Origin: http://localhost:5173" \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"testpassword123"}'
```

**レスポンス**:
```
< HTTP/1.1 500 Internal Server Error
```

**結果**: ❌ **POSTリクエストで500エラーが発生している**

### 2.4 バックエンドログの確認

**エラーログ**:
```
ValueError: password cannot be longer than 72 bytes, truncate manually if necessary (e.g. my_password[:72])
```

**エラーの発生箇所**:
```
File "/app/app/core/security.py", line 45, in verify_password
    return pwd_context.verify(plain_password, hashed_password)
File "/usr/local/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 421, in _finalize_backend_mixin
    if detect_wrap_bug(IDENT_2A):
File "/usr/local/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 380, in detect_wrap_bug
    if verify(secret, bug_hash):
File "/usr/local/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 655, in _calc_checksum
    hash = _bcrypt.hashpw(secret, config)
ValueError: password cannot be longer than 72 bytes, truncate manually if necessary (e.g. my_password[:72])
```

**根本原因**: **bcrypt 5.0.0とpasslib 1.7.4の互換性問題**

### 2.5 bcryptバージョンの確認

**requirements.txt**:
```txt
bcrypt==4.1.2  # bcrypt 5.0.0とpasslib 1.7.4の互換性問題を回避
```

**実際のインストールバージョン**:
```bash
docker-compose exec backend python -c "import bcrypt; print(f'bcrypt version: {bcrypt.__version__}')"
bcrypt version: 5.0.0
```

**結果**: ❌ **requirements.txtには`bcrypt==4.1.2`が指定されているが、実際には`bcrypt 5.0.0`がインストールされている**

---

## 3. 根本原因の特定

### 3.1 根本原因1: bcrypt 5.0.0のインストール

**問題**:
- `requirements.txt`には`bcrypt==4.1.2`が指定されているが、実際には`bcrypt 5.0.0`がインストールされている
- bcrypt 5.0.0では、72バイトを超えるパスワードに対してより厳格なエラーチェックが実装されている
- passlibの内部処理（`detect_wrap_bug`）で、72バイトを超えるテスト用パスワードが使用されると、エラーが発生する

**影響**:
- ログインAPIが500エラーを返す
- パスワード検証が正常に動作しない

### 3.2 根本原因2: 500エラー時のCORSヘッダー欠如

**問題**:
- 500エラーが発生すると、FastAPIのエラーハンドラーが実行される
- エラーハンドラーが返すレスポンスにCORSヘッダーが含まれていない可能性がある
- ブラウザがCORSエラーとして解釈している

**影響**:
- ブラウザのコンソールにCORSエラーが表示される
- 実際のエラー（500エラー）が隠される

### 3.3 根本原因3: Dockerイメージの再ビルド不足

**問題**:
- `requirements.txt`を変更したが、Dockerイメージを再ビルドしていない
- 既存のDockerイメージには`bcrypt 5.0.0`がインストールされている
- `docker-compose up -d`だけでは、`requirements.txt`の変更が反映されない

**影響**:
- `requirements.txt`の変更がコンテナに反映されない
- 互換性問題が継続する

---

## 4. 大原則への準拠評価

### 4.1 大原則の確認

1. **根本解決 > 暫定解決**
   - 一時的な回避策ではなく、根本原因を解決する
   - パッチワーク的な修正を避け、設計レベルでの解決を優先

2. **シンプル構造 > 複雑構造**
   - 過度に複雑な実装を避け、理解しやすく保守しやすい構造を選択
   - 不要な抽象化や過剰な設計を避ける

3. **統一・同一化 > 特殊独自**
   - 既存のパターンや規約に従い、統一された実装を優先
   - 特殊な実装や独自の方法を避け、標準的なアプローチを採用

4. **具体的 > 一般**
   - 抽象的な説明ではなく、具体的な実装方法や手順を明確にする
   - 曖昧な表現を避け、実行可能な具体的な内容を記載

5. **拙速 < 安全確実**
   - 速度よりも安全性と確実性を優先
   - テストを省略せず、十分な検証を行ってから本番環境に反映

### 4.2 現在の状況の大原則準拠評価

| 原則 | 評価 | 理由 |
|------|------|------|
| **根本解決 > 暫定解決** | ❌ 準拠していない | bcrypt 5.0.0がインストールされており、互換性問題が発生している |
| **シンプル構造 > 複雑構造** | ✅ 準拠 | CORS設定はシンプルで理解しやすい |
| **統一・同一化 > 特殊独自** | ❌ 準拠していない | `requirements.txt`と実際のインストールバージョンが不一致 |
| **具体的 > 一般** | ✅ 準拠 | 設定は具体的に記載されている |
| **拙速 < 安全確実** | ❌ 準拠していない | Dockerイメージの再ビルドが行われていない |

---

## 5. 大原則準拠修正案

### 5.1 修正案1: bcrypt 4.1.2へのダウングレード（根本解決）★推奨

**目的**: `requirements.txt`の指定と一致させ、bcrypt 5.0.0とpasslib 1.7.4の互換性問題を根本的に解決する

**実施内容**:

1. **Dockerイメージの再ビルド**
   ```bash
   docker-compose build backend
   docker-compose up -d backend
   ```

2. **bcryptバージョンの確認**
   ```bash
   docker-compose exec backend python -c "import bcrypt; print(f'bcrypt version: {bcrypt.__version__}')"
   ```
   - 期待される結果: `bcrypt version: 4.1.2`

3. **ログインAPIの動作確認**
   ```bash
   curl -X POST http://localhost:8000/api/v1/auth/login \
     -H "Content-Type: application/json" \
     -d '{"email":"test@example.com","password":"testpassword123"}'
   ```
   - 期待される結果: 200 OK（JWTトークンが返される）

**大原則への準拠**:
- ✅ **根本解決**: bcrypt 5.0.0とpasslib 1.7.4の互換性問題を根本的に解決
- ✅ **シンプル構造**: Dockerイメージの再ビルドのみ
- ✅ **統一・同一化**: `requirements.txt`と実際のインストールバージョンを一致させる
- ✅ **具体的**: 具体的なコマンドと手順を提示
- ✅ **安全確実**: Dockerイメージの再ビルドにより、確実にbcrypt 4.1.2がインストールされる

**期待される結果**:
- bcrypt 4.1.2がインストールされる
- ログインAPIが正常に動作する（500エラーが解消される）
- CORSエラーが解消される（500エラーが解消されるため）

### 5.2 修正案2: エラーハンドラーにCORSヘッダーを追加（補助的修正）

**目的**: 500エラーが発生した場合でも、CORSヘッダーを含むレスポンスを返すようにする

**実施内容**:

1. **`backend/app/main.py`のエラーハンドラーを修正**
   ```python
   @app.exception_handler(Exception)
   async def general_exception_handler(request: Request, exc: Exception):
       """
       予期しないエラーハンドラー
       アーキテクチャ設計書の標準エラーフォーマットに準拠
       """
       logger.critical(
           f"Unhandled exception: {exc}",
           extra={
               "path": request.url.path,
               "method": request.method
           },
           exc_info=True
       )
       # CORSヘッダーを追加
       headers = {}
       origin = request.headers.get("origin")
       if origin and origin in settings.cors_origins_list:
           headers["Access-Control-Allow-Origin"] = origin
           headers["Access-Control-Allow-Credentials"] = "true"
       
       return JSONResponse(
           status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
           content={
               "error": {
                   "code": "INTERNAL_ERROR",
                   "message": "An unexpected error occurred. Please try again later.",
                   "details": {}
               }
           },
           headers=headers  # CORSヘッダーを追加
       )
   ```

**大原則への準拠**:
- ⚠️ **暫定対応**: 根本原因（bcryptの互換性問題）を解決していない
- ✅ **シンプル構造**: エラーハンドラーにCORSヘッダーを追加するだけ
- ✅ **統一・同一化**: 既存のエラーハンドラーパターンに従う
- ✅ **具体的**: 具体的なコードを提示
- ✅ **安全確実**: エラーレスポンスにもCORSヘッダーを追加することで、CORSエラーを防ぐ

**評価**: ⚠️ **補助的な修正**（根本原因を解決していないため、修正案1と併用することを推奨）

---

## 6. 推奨される修正方針

### 6.1 最優先修正: 修正案1（bcrypt 4.1.2へのダウングレード）

**理由**:
1. **根本解決**: bcrypt 5.0.0とpasslib 1.7.4の互換性問題を根本的に解決
2. **シンプル構造**: Dockerイメージの再ビルドのみ
3. **統一・同一化**: `requirements.txt`と実際のインストールバージョンを一致させる
4. **具体的**: 具体的なコマンドと手順を提示
5. **安全確実**: Dockerイメージの再ビルドにより、確実にbcrypt 4.1.2がインストールされる

### 6.2 補助的修正: 修正案2（エラーハンドラーにCORSヘッダーを追加）

**理由**:
- 500エラーが発生した場合でも、CORSヘッダーを含むレスポンスを返すようにする
- ただし、根本原因を解決していないため、修正案1と併用することを推奨

---

## 7. 修正実施手順

### 7.1 ステップ1: Dockerイメージの再ビルド

```bash
cd /Users/kurinobu/projects/yadopera
docker-compose build backend
docker-compose up -d backend
```

**確認コマンド**:
```bash
docker-compose logs backend --tail 50
docker-compose exec backend python -c "import bcrypt; print(f'bcrypt version: {bcrypt.__version__}')"
```

**期待される結果**:
- バックエンドが正常に起動する
- `bcrypt version: 4.1.2` が表示される

### 7.2 ステップ2: ログインAPIの動作確認

```bash
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"testpassword123"}'
```

**期待される結果**:
- 200 OKが返される
- JWTトークンが含まれるレスポンスが返される

### 7.3 ステップ3: CORSエラーの確認

1. ブラウザで `http://localhost:5173/admin/login` にアクセス
2. ブラウザの開発者ツール（Consoleタブ）でCORSエラーが発生していないか確認
3. ログイン処理が正常に動作するか確認

**期待される結果**:
- CORSエラーが発生しない
- ログインが成功する

### 7.4 ステップ4（オプション）: エラーハンドラーにCORSヘッダーを追加

修正案2を実施する場合は、`backend/app/main.py`のエラーハンドラーを修正する

---

## 8. まとめ

### 8.1 根本原因の特定

1. **bcrypt 5.0.0のインストール**
   - `requirements.txt`には`bcrypt==4.1.2`が指定されているが、実際には`bcrypt 5.0.0`がインストールされている
   - bcrypt 5.0.0とpasslib 1.7.4の互換性問題が発生している

2. **500エラー時のCORSヘッダー欠如**
   - 500エラーが発生すると、エラーハンドラーが返すレスポンスにCORSヘッダーが含まれていない
   - ブラウザがCORSエラーとして解釈している

3. **Dockerイメージの再ビルド不足**
   - `requirements.txt`を変更したが、Dockerイメージを再ビルドしていない

### 8.2 推奨される修正方針

**最優先**: 修正案1（bcrypt 4.1.2へのダウングレード）

**理由**:
- 根本原因を解決する
- シンプルで確実な修正方法
- 大原則に完全準拠

### 8.3 大原則への準拠評価（修正後）

| 原則 | 評価 | 理由 |
|------|------|------|
| **根本解決 > 暫定解決** | ✅ 完全準拠 | bcrypt 5.0.0とpasslib 1.7.4の互換性問題を根本的に解決 |
| **シンプル構造 > 複雑構造** | ✅ 完全準拠 | Dockerイメージの再ビルドのみ |
| **統一・同一化 > 特殊独自** | ✅ 完全準拠 | `requirements.txt`と実際のインストールバージョンを一致させる |
| **具体的 > 一般** | ✅ 完全準拠 | 具体的なコマンドと手順を提示 |
| **拙速 < 安全確実** | ✅ 完全準拠 | Dockerイメージの再ビルドにより、確実にbcrypt 4.1.2がインストールされる |

---

**状態**: ✅ **完全調査分析完了 → 根本原因特定完了 → 大原則準拠修正案提示完了**


