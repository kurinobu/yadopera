# Phase 1・Phase 2: オフライン検出機能修正 実施完了・テスト方法

**作成日時**: 2025年12月20日 11時15分07秒  
**実施者**: AI Assistant  
**目的**: オフライン検出機能の修正を実施し、Docker環境でのテスト方法を説明  
**状態**: ✅ **修正実施完了・テスト準備完了**

---

## 1. 実施した修正

### 1.1 修正内容

**修正箇所**:
1. `frontend/src/views/guest/Chat.vue`の施設情報取得時のエラーハンドリング（219-236行目）
2. `frontend/src/views/guest/Chat.vue`のメッセージ送信時のエラーハンドリング（464-481行目）
3. `frontend/src/views/guest/Welcome.vue`の施設情報取得時のエラーハンドリング（107-124行目）

**修正内容**:
- `NETWORK_ERROR`コードの場合、`isOffline.value`をチェック
- `isOffline.value === true` → オフラインメッセージを表示
- `isOffline.value === false` → ネットワークエラーメッセージを表示

### 1.2 バックアップファイル

**作成日時**: 2025年12月20日 11時15分07秒

- `frontend/src/views/guest/Chat.vue.bak_20251220_111507`
- `frontend/src/views/guest/Welcome.vue.bak_20251220_111507`

---

## 2. Docker環境の確認

### 2.1 現在のDocker環境状態

**確認日時**: 2025年12月20日 11時15分07秒

**実行結果**:
```
NAME                IMAGE                    COMMAND                  SERVICE    CREATED        STATUS                PORTS
yadopera-backend    yadopera-backend         "uvicorn app.main:ap…"   backend    25 hours ago   Up 25 hours           0.0.0.0:8000->8000/tcp
yadopera-frontend   yadopera-frontend        "docker-entrypoint.s…"   frontend   28 hours ago   Up 28 hours           0.0.0.0:4173->4173/tcp, 0.0.0.0:5173->5173/tcp
yadopera-postgres   pgvector/pgvector:pg15   "docker-entrypoint.s…"   postgres   4 days ago     Up 4 days (healthy)   0.0.0.0:5433->5432/tcp
yadopera-redis      redis:7.2-alpine         "docker-entrypoint.s…"   redis      4 days ago     Up 4 days (healthy)   0.0.0.0:6379->6379/tcp
```

**評価**: ✅ **すべてのコンテナが正常に起動中**

### 2.2 アクセスURL

**重要**: 今回のテストは**5173（開発サーバー）で実行**してください。4173（プレビューサーバー）ではテストしません。

**理由**:
- **5173（開発サーバー）**: 修正が自動反映される（HMR機能により即座に反映）
- **4173（プレビューサーバー）**: ビルド済みのコードを表示するため、修正を反映するには再ビルドが必要

**アクセスURL**:
- **フロントエンド（開発サーバー）**: `http://localhost:5173` ⭐ **今回のテストはこちらを使用**
- **フロントエンド（プレビューサーバー）**: `http://localhost:4173` ❌ **今回は使用しない**
- **バックエンドAPI**: `http://localhost:8000`
- **ゲスト画面**: `http://localhost:5173/f/test-facility?location=entrance` ⭐ **今回のテストはこちらを使用**
- **管理画面ログイン**: `http://localhost:5173/admin/login`

---

## 3. ビルドとテスト準備

### 3.1 フロントエンドのビルド確認

**コマンド**:
```bash
cd /Users/kurinobu/projects/yadopera
docker-compose exec frontend npm run build
```

**注意**: 開発サーバー（`npm run dev`）が起動している場合、ビルドは不要です。HMR（Hot Module Replacement）により、変更が自動的に反映されます。

### 3.2 開発サーバーの状態確認

**コマンド**:
```bash
docker-compose logs frontend | tail -20
```

**確認項目**:
- 開発サーバーが正常に起動しているか
- エラーがないか
- HMR機能が有効になっているか

---

## 4. テスト方法

### 4.1 テスト環境の準備

#### 4.1.1 Docker環境の起動確認

**コマンド**:
```bash
cd /Users/kurinobu/projects/yadopera
docker-compose ps
```

**確認項目**:
- すべてのコンテナが`Up`状態であること
- ポートが正しくマッピングされていること

#### 4.1.2 ブラウザの開発者ツールを開く

**重要**: 
- **5173（開発サーバー）でアクセス**してください。4173（プレビューサーバー）ではテストしません。
- **ルートパス `/` は定義されていません**。直接ゲスト画面または管理画面のURLにアクセスしてください。

**正しいアクセスURL**:
- ゲスト画面: `http://localhost:5173/f/test-facility?location=entrance` ⭐ **このURLを使用
- 管理画面: `http://localhost:5173/admin/login`

**手順**:
1. ChromeまたはFirefoxで`http://localhost:5173/f/test-facility?location=entrance`にアクセス ⭐ **5173を使用、ゲスト画面URLを使用**
2. `F12`キーまたは`右クリック → 検証`で開発者ツールを開く
3. `Console`タブと`Network`タブを開く

**注意**: `http://localhost:5173`に直接アクセスすると404エラーが表示されます。これは正常な動作です（ルートパス `/` が定義されていないため）。

### 4.2 テストケース1: オフライン時の施設情報取得エラー

**目的**: オフライン時に施設情報取得エラーが発生した場合、オフラインメッセージが表示されることを確認

**重要**: **5173（開発サーバー）でアクセス**してください。

**手順**:
1. ブラウザで`http://localhost:5173/f/test-facility?location=entrance`にアクセス ⭐ **5173を使用**
2. 開発者ツールの`Network`タブで`Offline`モードを有効化
3. ページをリロード（`F5`キー）
4. エラーメッセージを確認

**期待される結果**:
- エラーメッセージ: 「現在オフラインです。インターネット接続を確認してください。」
- コンソールログ: `[Welcome.vue] NETWORK_ERROR検出 + オフライン状態: オフラインメッセージを表示`

**確認方法**:
- エラーメッセージが表示されているか
- コンソールログに`isOffline.value: true`が表示されているか
- エラーメッセージが「現在オフラインです。インターネット接続を確認してください。」であるか

### 4.3 テストケース2: ネットワークエラー時の施設情報取得エラー

**目的**: オンラインだがネットワークエラーが発生した場合、ネットワークエラーメッセージが表示されることを確認

**重要**: **5173（開発サーバー）でアクセス**してください。

**手順**:
1. ブラウザで`http://localhost:5173/f/test-facility?location=entrance`にアクセス ⭐ **5173を使用**
2. 開発者ツールの`Network`タブで`Offline`モードを無効化（オンライン状態を維持）
3. バックエンドコンテナを停止: `docker-compose stop backend`
4. ページをリロード（`F5`キー）
5. エラーメッセージを確認

**期待される結果**:
- エラーメッセージ: 「ネットワークエラーが発生しました。接続を確認して再度お試しください。」
- コンソールログ: `[Welcome.vue] NETWORK_ERROR検出 + オンライン状態: ネットワークエラーメッセージを表示`

**確認方法**:
- エラーメッセージが表示されているか
- コンソールログに`isOffline.value: false`が表示されているか
- エラーメッセージが「ネットワークエラーが発生しました。接続を確認して再度お試しください。」であるか

**注意**: テスト後、バックエンドコンテナを再起動: `docker-compose start backend`

### 4.4 テストケース3: オフライン時のメッセージ送信エラー（Chat.vue）

**目的**: オフライン時にメッセージ送信エラーが発生した場合、オフラインメッセージが表示されることを確認

**重要**: **5173（開発サーバー）でアクセス**してください。

**手順**:
1. ブラウザで`http://localhost:5173/f/test-facility?location=entrance`にアクセス ⭐ **5173を使用**
2. チャット画面に遷移（メッセージを入力して送信）
3. 開発者ツールの`Network`タブで`Offline`モードを有効化
4. メッセージを入力して送信
5. エラーメッセージを確認

**期待される結果**:
- エラーメッセージ: 「現在オフラインです。インターネット接続を確認してください。」
- コンソールログ: `[Chat.vue] NETWORK_ERROR検出 + オフライン状態: オフラインメッセージを表示`

**確認方法**:
- エラーメッセージが表示されているか
- コンソールログに`isOffline.value: true`が表示されているか
- エラーメッセージが「現在オフラインです。インターネット接続を確認してください。」であるか

### 4.5 テストケース4: ネットワークエラー時のメッセージ送信エラー（Chat.vue）

**目的**: オンラインだがネットワークエラーが発生した場合、ネットワークエラーメッセージが表示されることを確認

**重要**: **5173（開発サーバー）でアクセス**してください。

**手順**:
1. ブラウザで`http://localhost:5173/f/test-facility?location=entrance`にアクセス ⭐ **5173を使用**
2. チャット画面に遷移（メッセージを入力して送信）
3. 開発者ツールの`Network`タブで`Offline`モードを無効化（オンライン状態を維持）
4. バックエンドコンテナを停止: `docker-compose stop backend`
5. メッセージを入力して送信
6. エラーメッセージを確認

**期待される結果**:
- エラーメッセージ: 「ネットワークエラーが発生しました。接続を確認して再度お試しください。」
- コンソールログ: `[Chat.vue] NETWORK_ERROR検出 + オンライン状態: ネットワークエラーメッセージを表示`

**確認方法**:
- エラーメッセージが表示されているか
- コンソールログに`isOffline.value: false`が表示されているか
- エラーメッセージが「ネットワークエラーが発生しました。接続を確認して再度お試しください。」であるか

**注意**: テスト後、バックエンドコンテナを再起動: `docker-compose start backend`

### 4.6 テストケース5: タイムアウトエラー

**目的**: タイムアウトエラーが発生した場合、タイムアウトメッセージが表示されることを確認

**重要**: **5173（開発サーバー）でアクセス**してください。

**手順**:
1. ブラウザで`http://localhost:5173/f/test-facility?location=entrance`にアクセス ⭐ **5173を使用**
2. 開発者ツールの`Network`タブで`Throttling`を`Slow 3G`に設定
3. ページをリロード（`F5`キー）
4. エラーメッセージを確認（タイムアウトが発生した場合）

**期待される結果**:
- エラーメッセージ: 「リクエストがタイムアウトしました。接続を確認して再度お試しください。」
- コンソールログ: `[Welcome.vue] TIMEOUT_ERROR検出`または`[Chat.vue] TIMEOUT_ERROR検出`

**注意**: タイムアウトは30秒以内に発生しない場合があります。タイムアウトを確実に発生させるには、バックエンドのタイムアウト設定を変更するか、ネットワークを完全に切断する必要があります。

### 4.7 テストケース6: サーバーエラー

**目的**: サーバーエラーが発生した場合、サーバーエラーメッセージが表示されることを確認

**重要**: **5173（開発サーバー）でアクセス**してください。

**手順**:
1. ブラウザで`http://localhost:5173/f/test-facility?location=entrance`にアクセス ⭐ **5173を使用**
2. バックエンドコンテナでエラーを発生させる（例: データベース接続エラー）
3. ページをリロード（`F5`キー）
4. エラーメッセージを確認

**期待される結果**:
- エラーメッセージ: 「サーバーエラーが発生しました。しばらくしてから再度お試しください。」
- コンソールログ: `[Welcome.vue] SERVER_ERROR検出`または`[Chat.vue] SERVER_ERROR検出`

**注意**: サーバーエラーを確実に発生させるには、バックエンドのコードを一時的に変更する必要があります。

---

## 5. テスト結果の記録

### 5.1 テスト結果テンプレート

**テストケース**: [テストケース名]

**実施日時**: [YYYY年MM月DD日 HH時MM分SS秒]

**実施環境**:
- Docker環境: ✅ 正常起動
- フロントエンドURL: `http://localhost:5173` ⭐ **5173（開発サーバー）を使用**
- バックエンドURL: `http://localhost:8000`
- **注意**: 4173（プレビューサーバー）は使用しない

**テスト結果**:
- [ ] 期待される結果と一致
- [ ] 期待される結果と不一致（詳細を記録）

**確認項目**:
- [ ] エラーメッセージが表示されている
- [ ] コンソールログが正しく出力されている
- [ ] `isOffline.value`の値が正しい
- [ ] エラーメッセージの内容が正しい

**問題点**（あれば）:
- [問題点の詳細]

---

## 6. トラブルシューティング

### 6.1 Docker環境が起動しない場合

**問題**: `docker-compose ps`でコンテナが起動していない

**解決方法**:
```bash
cd /Users/kurinobu/projects/yadopera
docker-compose up -d
```

### 6.2 フロントエンドが表示されない場合

**問題**: `http://localhost:5173`にアクセスすると404エラーが表示される

**重要**: 
- **5173（開発サーバー）でアクセス**してください。4173（プレビューサーバー）ではテストしません。
- **ルートパス `/` は定義されていません**。直接ゲスト画面または管理画面のURLにアクセスしてください。

**正しいアクセスURL**:
- ゲスト画面: `http://localhost:5173/f/test-facility?location=entrance`
- 管理画面: `http://localhost:5173/admin/login`

**解決方法**:
1. フロントエンドコンテナのログを確認: `docker-compose logs frontend`
2. コンテナを再起動: `docker-compose restart frontend`
3. **正しいURLでアクセス**: `http://localhost:5173/f/test-facility?location=entrance`（ゲスト画面）または`http://localhost:5173/admin/login`（管理画面）

**注意**: `http://localhost:5173`に直接アクセスすると404エラーが表示されます。これは正常な動作です（ルートパス `/` が定義されていないため）。

### 6.3 バックエンドAPIが応答しない場合

**問題**: バックエンドAPIにアクセスできない

**解決方法**:
1. バックエンドコンテナのログを確認: `docker-compose logs backend`
2. コンテナを再起動: `docker-compose restart backend`
3. ヘルスチェック: `curl http://localhost:8000/api/v1/health`

### 6.4 オフラインモードが機能しない場合

**問題**: 開発者ツールの`Offline`モードを有効化しても、`isOffline.value`が`false`のまま

**解決方法**:
1. ブラウザを再読み込み（`F5`キー）
2. `navigator.onLine`の値を確認: コンソールで`navigator.onLine`を実行
3. `online`/`offline`イベントが発火しているか確認: コンソールでイベントリスナーを確認

---

## 7. 次のステップ

### 7.1 テスト完了後の作業

1. **テスト結果の記録**: すべてのテストケースの結果を記録
2. **問題点の修正**: 問題点があれば修正を実施
3. **コミット・プッシュ**: 修正をコミット・プッシュ（指示がある場合）

### 7.2 本番環境への反映

**注意**: 本番環境への反映はPhase 4で実施すべき（引き継ぎ書より）

**現在のフェーズ**: Phase 1・Phase 2（MVP開発・PoC準備）

**本番環境デプロイ**: Phase 4（PoC成功後の本格展開準備）

---

**修正実施完了日時**: 2025年12月20日 11時15分07秒  
**状態**: ✅ **修正実施完了・テスト準備完了**

**重要**: テストを実施して、期待される動作を確認してください。

