# 館内ルール・周辺情報・禁止事項 実装計画書

**作成日時**: 2026年1月20日  
**作成者**: AI Assistant  
**目的**: 館内ルール・周辺情報・禁止事項の3項目（各500文字、合計1500文字）の実装計画をまとめる  
**状態**: ✅ **実装完了・デプロイ完了（2026-01-20）**

---

## 1. 実装概要

### 1.1 最終決定

**実装内容**:
- **館内ルール**: 500文字
- **周辺情報**: 500文字
- **禁止事項**: 500文字（新規追加）
- **合計**: 1500文字

**理由**:
1. 現状の不整合を解消（データベース・UI・プロンプトの文字数制限を統一）
2. 情報の分類が明確になる（館内ルール、周辺情報、禁止事項）
3. AI応答の精度向上（禁止事項を明確にすることで、AIがより適切に回答できる）
4. 段階的な機能拡張（ローンチ時は500文字×2、その後禁止事項を追加）

---

## 2. 現状の問題点

### 2.1 不整合の解消

**現状の問題**:
- **データベース**: 館内ルール・周辺情報それぞれ1000文字まで保存可能
- **UI**: 「1000文字以内（AI応答のコンテキストに使用されます）」と表示
- **プロンプト**: 実際には500文字のみ使用（`[:500]`で切り詰め）
- **結果**: ユーザーが1000文字入力しても、実際には500文字しか使われない

**解決策**:
- データベース・UI・プロンプトの文字数制限を500文字に統一
- 禁止事項を新規追加（500文字）

---

## 3. 実装内容

### 3.1 データベースの拡張

#### マイグレーションの作成

**ファイル**: `backend/alembic/versions/XXX_add_prohibited_items.py`

```python
"""add prohibited_items to facilities

Revision ID: XXX
Revises: YYY
Create Date: 2026-01-20

"""
from alembic import op
import sqlalchemy as sa

# revision identifiers, used by Alembic.
revision = 'XXX'
down_revision = 'YYY'
branch_labels = None
depends_on = None

def upgrade() -> None:
    # 禁止事項カラムを追加
    op.add_column('facilities', sa.Column('prohibited_items', sa.Text(), nullable=True))
    
    # 既存データの館内ルール・周辺情報を500文字に切り詰める
    op.execute("""
        UPDATE facilities 
        SET house_rules = LEFT(house_rules, 500) 
        WHERE LENGTH(house_rules) > 500
    """)
    op.execute("""
        UPDATE facilities 
        SET local_info = LEFT(local_info, 500) 
        WHERE LENGTH(local_info) > 500
    """)

def downgrade() -> None:
    op.drop_column('facilities', 'prohibited_items')
```

#### モデルの更新

**ファイル**: `backend/app/models/facility.py`

```python
# 既存のカラム（変更なし）
house_rules = Column(Text)  # 500文字（制限はスキーマで定義）
local_info = Column(Text)   # 500文字（制限はスキーマで定義）

# 新規追加
prohibited_items = Column(Text)  # 500文字（制限はスキーマで定義）
```

---

### 3.2 バックエンドの実装

#### スキーマの更新

**ファイル**: `backend/app/schemas/facility.py`

```python
class FacilitySettingsUpdateRequest(BaseModel):
    """
    施設設定更新リクエスト
    """
    name: Optional[str] = Field(None, min_length=1, max_length=255)
    email: Optional[str] = Field(None, max_length=255)
    phone: Optional[str] = Field(None, max_length=50)
    address: Optional[str] = None
    wifi_ssid: Optional[str] = Field(None, max_length=100)
    wifi_password: Optional[str] = Field(None, max_length=100, description="変更時のみ")
    check_in_time: Optional[str] = Field(None, description="時刻形式（HH:MM）")
    check_out_time: Optional[str] = Field(None, description="時刻形式（HH:MM）")
    house_rules: Optional[str] = Field(None, max_length=500, description="館内ルール（500文字以内）")
    local_info: Optional[str] = Field(None, max_length=500, description="周辺情報（500文字以内）")
    prohibited_items: Optional[str] = Field(None, max_length=500, description="禁止事項（500文字以内）")  # 新規追加
    staff_absence_periods: Optional[List[StaffAbsencePeriod]] = None
```

**ファイル**: `backend/app/schemas/facility.py` (FacilitySettingsResponse)

```python
class FacilitySettingsResponse(BaseModel):
    """
    施設設定レスポンス
    """
    facility: FacilitySettingsFacility

class FacilitySettingsFacility(BaseModel):
    id: int
    name: str
    slug: str
    email: str
    phone: Optional[str] = None
    address: Optional[str] = None
    wifi_ssid: Optional[str] = None
    wifi_password: Optional[str] = None  # マスク表示用
    check_in_time: Optional[str] = None  # "HH:MM"形式
    check_out_time: Optional[str] = None  # "HH:MM"形式
    house_rules: Optional[str] = None
    local_info: Optional[str] = None
    prohibited_items: Optional[str] = None  # 新規追加
    languages: List[str]
    timezone: str
    subscription_plan: str
    monthly_question_limit: Optional[int] = None
    is_active: bool
    created_at: str
    updated_at: str
```

#### APIエンドポイントの更新

**ファイル**: `backend/app/api/v1/admin/facility.py`

```python
@router.put("/settings", response_model=FacilitySettingsResponse)
async def update_facility_settings(
    request: FacilitySettingsUpdateRequest,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    # ... 既存のコード ...
    
    # 館内ルール・周辺情報の更新（既存）
    if "house_rules" in update_data:
        facility.house_rules = update_data["house_rules"]
    if "local_info" in update_data:
        facility.local_info = update_data["local_info"]
    
    # 禁止事項の更新（新規追加）
    if "prohibited_items" in update_data:
        facility.prohibited_items = update_data["prohibited_items"]
    
    # ... 既存のコード ...
```

#### プロンプトの更新

**ファイル**: `backend/app/ai/engine.py`

```python
def _build_context(
    self,
    facility: Facility,
    similar_faqs: List[FAQ],
    question: str,
    language: str = "en"
) -> str:
    # ... 既存のコード ...
    
    # 施設基本情報（約150トークン）
    facility_info = f"""
Facility: {facility.name}
Check-in: {facility.check_in_time}
Check-out: {facility.check_out_time}
WiFi SSID: {facility.wifi_ssid or "Not available"}
House Rules: {(facility.house_rules or "")[:500]}
Local Info: {(facility.local_info or "")[:500]}
Prohibited Items: {(facility.prohibited_items or "")[:500]}  # 新規追加
"""
    
    # ... 既存のコード ...
```

**ファイル**: `backend/app/ai/prompts.py`

```python
def build_rag_prompt(
    facility: Facility,
    similar_faqs: List[FAQ],
    question: str
) -> str:
    # 施設基本情報（約150トークン）
    facility_info = f"""
- Name: {facility.name}
- Check-in: {facility.check_in_time}
- Check-out: {facility.check_out_time}
- WiFi SSID: {facility.wifi_ssid or "Not available"}
- House Rules: {(facility.house_rules or "")[:500]}
- Local Info: {(facility.local_info or "")[:500]}
- Prohibited Items: {(facility.prohibited_items or "")[:500]}  # 新規追加
"""
    
    # ... 既存のコード ...
```

---

### 3.3 フロントエンドの実装

#### 型定義の更新

**ファイル**: `frontend/src/types/facility.ts`

```typescript
export interface FacilitySettingsFacility {
  id: number
  name: string
  slug: string
  email: string
  phone?: string
  address?: string
  wifi_ssid?: string
  wifi_password?: string  // マスク表示用
  check_in_time?: string  // "HH:MM"形式
  check_out_time?: string  // "HH:MM"形式
  house_rules?: string
  local_info?: string
  prohibited_items?: string  // 新規追加
  languages: string[]
  timezone: string
  subscription_plan: string
  monthly_question_limit: number
  is_active: boolean
  created_at: string
  updated_at: string
}

export interface FacilitySettingsUpdateRequest {
  name?: string
  email?: string
  phone?: string
  address?: string
  wifi_ssid?: string
  wifi_password?: string
  check_in_time?: string
  check_out_time?: string
  house_rules?: string
  local_info?: string
  prohibited_items?: string  // 新規追加
  staff_absence_periods?: StaffAbsencePeriod[]
}
```

#### UIの更新

**ファイル**: `frontend/src/views/admin/FacilitySettings.vue`

```vue
<template>
  <!-- ... 既存のコード ... -->
  
  <!-- 館内ルール・周辺情報・禁止事項セクション -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
      館内ルール・周辺情報・禁止事項
    </h2>
    <div class="space-y-4">
      <Input
        v-model="formData.house_rules"
        type="textarea"
        label="館内ルール"
        placeholder="例: 禁煙、門限23:00、静粛時間22:00-8:00、ゴミ出しは毎週火曜日・金曜日"
        :rows="4"
        :maxlength="500"
        hint="500文字以内（AI応答のコンテキストに使用されます）"
        :error="errors.house_rules"
      />
      <Input
        v-model="formData.local_info"
        type="textarea"
        label="周辺情報"
        placeholder="例: 最寄り駅: 京都駅（徒歩10分）、コンビニ: セブンイレブン（徒歩3分）、レストラン: 多数あり"
        :rows="4"
        :maxlength="500"
        hint="500文字以内（AI応答のコンテキストに使用されます）"
        :error="errors.local_info"
      />
      <Input
        v-model="formData.prohibited_items"
        type="textarea"
        label="禁止事項"
        placeholder="例: 喫煙、大声、飲酒、ペットの持ち込み、外部からの持ち込み飲食物"
        :rows="4"
        :maxlength="500"
        hint="500文字以内（AI応答のコンテキストに使用されます）"
        :error="errors.prohibited_items"
      />
    </div>
  </div>
  
  <!-- ... 既存のコード ... -->
</template>

<script setup lang="ts">
// ... 既存のコード ...

// フォームデータ
const formData = ref<{
  name: string
  email: string
  phone: string
  address: string
  wifi_ssid: string
  wifi_password: string
  check_in_time: string
  check_out_time: string
  house_rules: string
  local_info: string
  prohibited_items: string  // 新規追加
  staff_absence_periods: StaffAbsencePeriod[]
}>({
  name: '',
  email: '',
  phone: '',
  address: '',
  wifi_ssid: '',
  wifi_password: '',
  check_in_time: '',
  check_out_time: '',
  house_rules: '',
  local_info: '',
  prohibited_items: '',  // 新規追加
  staff_absence_periods: []
})

// ... 既存のコード ...

// 施設設定を取得
const fetchSettings = async () => {
  try {
    loading.value = true
    const response = await facilityApi.getFacilitySettings()
    settings.value = response
    
    // フォームデータに設定
    formData.value = {
      name: response.facility.name,
      email: response.facility.email,
      phone: response.facility.phone || '',
      address: response.facility.address || '',
      wifi_ssid: response.facility.wifi_ssid || '',
      wifi_password: '',
      check_in_time: response.facility.check_in_time || '',
      check_out_time: response.facility.check_out_time || '',
      house_rules: response.facility.house_rules || '',
      local_info: response.facility.local_info || '',
      prohibited_items: response.facility.prohibited_items || '',  // 新規追加
      staff_absence_periods: response.facility.staff_absence_periods || []
    }
  } catch (err: any) {
    console.error('Failed to fetch facility settings:', err)
    alert('施設設定の取得に失敗しました')
  } finally {
    loading.value = false
  }
}

// ... 既存のコード ...
</script>
```

---

## 4. 実装ステップ

### ステップ1: データベースの拡張

1. **マイグレーションファイルの作成**
   - `backend/alembic/versions/XXX_add_prohibited_items.py`を作成
   - `prohibited_items`カラムを追加
   - 既存データの館内ルール・周辺情報を500文字に切り詰める

2. **マイグレーションの実行**
   ```bash
   cd backend
   alembic upgrade head
   ```

3. **モデルの更新**
   - `backend/app/models/facility.py`に`prohibited_items`カラムを追加

### ステップ2: バックエンドの実装

1. **スキーマの更新**
   - `backend/app/schemas/facility.py`を更新
   - `FacilitySettingsUpdateRequest`に`prohibited_items`を追加
   - `FacilitySettingsFacility`に`prohibited_items`を追加
   - 館内ルール・周辺情報の`max_length`を500に変更

2. **APIエンドポイントの更新**
   - `backend/app/api/v1/admin/facility.py`を更新
   - 禁止事項の更新処理を追加

3. **プロンプトの更新**
   - `backend/app/ai/engine.py`を更新
   - `backend/app/ai/prompts.py`を更新
   - 禁止事項をプロンプトに追加

### ステップ3: フロントエンドの実装

1. **型定義の更新**
   - `frontend/src/types/facility.ts`を更新
   - `FacilitySettingsFacility`に`prohibited_items`を追加
   - `FacilitySettingsUpdateRequest`に`prohibited_items`を追加

2. **UIの更新**
   - `frontend/src/views/admin/FacilitySettings.vue`を更新
   - 禁止事項の入力フォームを追加
   - 館内ルール・周辺情報の`maxlength`を500に変更
   - フォームデータに`prohibited_items`を追加

3. **APIクライアントの更新**
   - `frontend/src/api/facility.ts`を確認（必要に応じて更新）

### ステップ4: テスト

1. **バックエンドテスト**
   - マイグレーションのテスト
   - APIエンドポイントのテスト
   - プロンプト生成のテスト

2. **フロントエンドテスト**
   - UIの表示確認
   - 入力・保存の動作確認
   - バリデーションの確認

3. **統合テスト**
   - 館内ルール・周辺情報・禁止事項の保存・取得
   - AI応答での使用確認

### ステップ5: ドキュメントの更新

1. **利用マニュアルの更新**
   - `frontend/src/views/admin/Manual.vue`を更新
   - 館内ルール・周辺情報・禁止事項の説明を追加

2. **その他のドキュメント**
   - 必要に応じて他のドキュメントを更新

---

## 5. 注意事項

### 5.1 既存データの移行

**既存データの処理**:
- 館内ルール・周辺情報が500文字を超える場合、500文字に切り詰める
- マイグレーション内で自動処理

**ユーザーへの通知**:
- 既存データが500文字を超える場合、警告を表示することを検討
- ただし、マイグレーションで自動処理するため、必須ではない

### 5.2 バリデーション

**フロントエンド**:
- `maxlength="500"`で入力制限
- 文字数カウンターの表示を検討

**バックエンド**:
- `max_length=500`でバリデーション
- エラーメッセージの表示

### 5.3 プロンプトのトークン数

**現状**:
- 施設基本情報: 約150トークン
- 館内ルール: 最大500文字
- 周辺情報: 最大500文字
- 禁止事項: 最大500文字（新規追加）

**影響**:
- プロンプトのトークン数が増加する可能性がある
- ただし、各項目は500文字に制限されているため、大幅な増加はない見込み

---

## 6. 実装チェックリスト

### データベース
- [ ] マイグレーションファイルの作成
- [ ] マイグレーションの実行
- [ ] モデルの更新

### バックエンド
- [ ] スキーマの更新（`facility.py`）
- [ ] APIエンドポイントの更新（`facility.py`）
- [ ] プロンプトの更新（`engine.py`, `prompts.py`）

### フロントエンド
- [ ] 型定義の更新（`facility.ts`）
- [ ] UIの更新（`FacilitySettings.vue`）
- [ ] APIクライアントの確認

### テスト
- [ ] バックエンドテスト
- [ ] フロントエンドテスト
- [ ] 統合テスト

### ドキュメント
- [ ] 利用マニュアルの更新
- [ ] その他のドキュメントの更新

---

## 7. 参照文書

- `docs/20260120_料金プランと館内ルール周辺情報のビジネス整合性_調査分析レポート.md`: 調査分析レポート
- `docs/20260120_館内ルール周辺情報とFAQの関係_調査分析レポート.md`: 館内ルール・周辺情報とFAQの関係
- `backend/app/models/facility.py`: 施設モデル
- `backend/app/schemas/facility.py`: 施設スキーマ
- `backend/app/api/v1/admin/facility.py`: 施設APIエンドポイント
- `backend/app/ai/engine.py`: AIエンジン
- `backend/app/ai/prompts.py`: プロンプト生成
- `frontend/src/views/admin/FacilitySettings.vue`: 施設設定画面

---

**作成完了日時**: 2026年1月20日  
**実装予定**: 次回セッション  
**実装優先度**: 高

