# Phase 1・Phase 2: オフライン検出機能 完全調査分析・大原則準拠修正案

**作成日時**: 2025年12月20日 11時08分52秒  
**実施者**: AI Assistant  
**目的**: `isOffline`の使用状況とエラーハンドリングの組み合わせを完全に調査分析し、期待する表示と動作を確認して、大原則に準拠した修正案を提示  
**状態**: 📋 **完全調査分析完了・修正案提示完了**

**重要**: 指示があるまで修正を実施しません。調査分析と修正案の提示のみです。

---

## 1. 調査目的

### 1.1 問題の背景

**指摘事項**:
- 「オフライン検出機能は実装済みだが、Chat.vueでisOfflineが未使用の可能性がある。エラーハンドリングは実装済みだが、isOfflineとの組み合わせが必要。」

**調査項目**:
1. `Chat.vue`での`isOffline`の使用状況
2. `Welcome.vue`での`isOffline`の使用状況
3. 現在のエラーハンドリングの実装状況
4. `isOffline`とエラーコードの組み合わせの必要性
5. 期待される表示と動作

---

## 2. コードベース調査結果

### 2.1 `useOffline.ts`コンポーザブルの実装状況

**ファイル**: `frontend/src/composables/useOffline.ts`

**実装内容**:
```typescript
export function useOffline() {
  const isOffline = ref(!navigator.onLine)

  const updateOnlineStatus = () => {
    isOffline.value = !navigator.onLine
  }

  onMounted(() => {
    window.addEventListener('online', updateOnlineStatus)
    window.addEventListener('offline', updateOnlineStatus)
  })

  onUnmounted(() => {
    window.removeEventListener('online', updateOnlineStatus)
    window.removeEventListener('offline', updateOnlineStatus)
  })

  return {
    isOffline
  }
}
```

**評価**: ✅ **実装済み・正常**

---

### 2.2 `Chat.vue`での`isOffline`の使用状況

**ファイル**: `frontend/src/views/guest/Chat.vue`

#### 2.2.1 インポートと取得

**138行目**:
```typescript
const { isOffline } = useOffline()
```

**評価**: ✅ **インポート済み・取得済み**

#### 2.2.2 使用箇所の確認

**1. メッセージ送信時のオフライン検出（392-396行目）**:
```typescript
// オフライン時のメッセージ送信をブロック
if (isOffline.value) {
  error.value = '現在オフラインです。メッセージを送信できません。インターネット接続を確認してください。'
  console.warn('[Chat.vue] handleMessageSubmit: オフライン状態のため送信をブロック')
  return
}
```

**評価**: ✅ **使用されている**

#### 2.2.3 未使用箇所の確認

**1. 施設情報取得時のエラーハンドリング（201-237行目）**:
```typescript
catch (err: any) {
  // ... デバッグログ ...
  
  const errorCode = err?.code || err?.error?.code || err?.response?.data?.error?.code
  
  if (errorCode === 'NETWORK_ERROR' || String(errorCode) === 'NETWORK_ERROR') {
    error.value = '現在オフラインです。インターネット接続を確認してください。'
  } else if (errorCode === 'TIMEOUT_ERROR' || String(errorCode) === 'TIMEOUT_ERROR') {
    error.value = 'リクエストがタイムアウトしました。接続を確認して再度お試しください。'
  } else if (errorCode === 'SERVER_ERROR' || String(errorCode) === 'SERVER_ERROR') {
    error.value = 'サーバーエラーが発生しました。しばらくしてから再度お試しください。'
  } else {
    error.value = '施設情報の取得に失敗しました'
  }
}
```

**問題点**: ❌ **`isOffline`を使用していない**
- エラーコードのみをチェックしている
- `isOffline.value`との組み合わせがない

**2. メッセージ送信時のエラーハンドリング（442-482行目）**:
```typescript
catch (err: any) {
  // ... デバッグログ ...
  
  const errorCode = err?.code || err?.error?.code || err?.response?.data?.error?.code
  
  if (errorCode === 'NETWORK_ERROR' || String(errorCode) === 'NETWORK_ERROR') {
    error.value = '現在オフラインです。インターネット接続を確認してください。'
  } else if (errorCode === 'TIMEOUT_ERROR' || String(errorCode) === 'TIMEOUT_ERROR') {
    error.value = 'リクエストがタイムアウトしました。接続を確認して再度お試しください。'
  } else if (errorCode === 'SERVER_ERROR' || String(errorCode) === 'SERVER_ERROR') {
    error.value = 'サーバーエラーが発生しました。しばらくしてから再度お試しください。'
  } else {
    error.value = err.message || 'メッセージの送信に失敗しました'
  }
}
```

**問題点**: ❌ **`isOffline`を使用していない**
- エラーコードのみをチェックしている
- `isOffline.value`との組み合わせがない

---

### 2.3 `Welcome.vue`での`isOffline`の使用状況

**ファイル**: `frontend/src/views/guest/Welcome.vue`

#### 2.3.1 インポートと取得

**63行目**:
```typescript
const { isOffline } = useOffline()
```

**評価**: ✅ **インポート済み・取得済み**

#### 2.3.2 使用箇所の確認

**1. メッセージ送信時のオフライン検出（152-155行目）**:
```typescript
// オフライン時のメッセージ送信をブロック
if (isOffline.value) {
  error.value = '現在オフラインです。メッセージを送信できません。インターネット接続を確認してください。'
  return
}
```

**評価**: ✅ **使用されている**

#### 2.3.3 未使用箇所の確認

**1. 施設情報取得時のエラーハンドリング（89-124行目）**:
```typescript
catch (err: any) {
  // ... デバッグログ ...
  
  const errorCode = err?.code || err?.error?.code || err?.response?.data?.error?.code
  
  if (errorCode === 'NETWORK_ERROR' || String(errorCode) === 'NETWORK_ERROR') {
    error.value = '現在オフラインです。インターネット接続を確認してください。'
  } else if (errorCode === 'TIMEOUT_ERROR' || String(errorCode) === 'TIMEOUT_ERROR') {
    error.value = 'リクエストがタイムアウトしました。接続を確認して再度お試しください。'
  } else if (errorCode === 'SERVER_ERROR' || String(errorCode) === 'SERVER_ERROR') {
    error.value = 'サーバーエラーが発生しました。しばらくしてから再度お試しください。'
  } else {
    error.value = '施設情報の取得に失敗しました'
  }
}
```

**問題点**: ❌ **`isOffline`を使用していない**
- エラーコードのみをチェックしている
- `isOffline.value`との組み合わせがない

---

## 3. 現在のエラーハンドリングの実装状況

### 3.1 エラーコードの生成

**ファイル**: `frontend/src/api/axios.ts`

**78-86行目**:
```typescript
// ネットワークエラー
return Promise.reject({
  code: 'NETWORK_ERROR',
  message: 'ネットワークエラーが発生しました。接続を確認してください。',
  details: {
    url: error.config?.url,
    method: error.config?.method
  }
})
```

**72-75行目**:
```typescript
// タイムアウトエラー
if (error.code === 'ECONNABORTED' || error.message?.includes('timeout')) {
  return Promise.reject({
    code: 'TIMEOUT_ERROR',
    message: 'リクエストがタイムアウトしました。接続を確認して再度お試しください。'
  })
}
```

**評価**: ✅ **エラーコードは正しく生成されている**

### 3.2 エラーハンドリングの問題点

**問題点1: `isOffline`とエラーコードの組み合わせがない**

**現在の実装**:
- `NETWORK_ERROR`コードのみをチェック
- `isOffline.value`をチェックしていない

**影響**:
- オフライン状態とネットワークエラーを区別できない
- オンラインだがネットワークエラーの場合も「オフラインです」と表示される
- ユーザーに正確な情報を伝えられない

**問題点2: エラーメッセージの統一性がない**

**現在の実装**:
- 施設情報取得時: 「現在オフラインです。インターネット接続を確認してください。」
- メッセージ送信時: 「現在オフラインです。インターネット接続を確認してください。」
- メッセージ送信ブロック時: 「現在オフラインです。メッセージを送信できません。インターネット接続を確認してください。」

**影響**:
- メッセージが統一されていない
- ユーザーが混乱する可能性がある

---

## 4. 期待される表示と動作

### 4.1 オフライン時の表示と動作

**条件**:
- `isOffline.value === true` または `NETWORK_ERROR`コード

**期待される表示**:
```
現在オフラインです / Currently Offline

インターネット接続を確認してください / Please check your internet connection
```

**期待される動作**:
1. 施設情報取得時にエラーが発生した場合、オフラインメッセージを表示
2. メッセージ送信をブロック（既に実装済み）
3. メッセージ送信時にエラーが発生した場合、オフラインメッセージを表示

### 4.2 ネットワークエラー（オンラインだが接続エラー）の表示と動作

**条件**:
- `isOffline.value === false` かつ `NETWORK_ERROR`コード

**期待される表示**:
```
ネットワークエラーが発生しました / Network Error

接続を確認して再度お試しください / Please check your connection and try again
```

**期待される動作**:
1. 施設情報取得時にエラーが発生した場合、ネットワークエラーメッセージを表示
2. メッセージ送信時にエラーが発生した場合、ネットワークエラーメッセージを表示

### 4.3 タイムアウトエラーの表示と動作

**条件**:
- `TIMEOUT_ERROR`コード

**期待される表示**:
```
リクエストがタイムアウトしました / Request Timeout

接続を確認して再度お試しください / Please check your connection and try again
```

**期待される動作**:
1. 施設情報取得時にエラーが発生した場合、タイムアウトメッセージを表示
2. メッセージ送信時にエラーが発生した場合、タイムアウトメッセージを表示

### 4.4 サーバーエラーの表示と動作

**条件**:
- `SERVER_ERROR`コード

**期待される表示**:
```
サーバーでエラーが発生しました / Server Error

しばらく時間をおいてから再度お試しください / Please try again later
```

**期待される動作**:
1. 施設情報取得時にエラーが発生した場合、サーバーエラーメッセージを表示
2. メッセージ送信時にエラーが発生した場合、サーバーエラーメッセージを表示

---

## 5. 根本原因の分析

### 5.1 直接原因

**直接原因1: `isOffline`とエラーコードの組み合わせがない**
- 施設情報取得時のエラーハンドリングで`isOffline`を使用していない
- メッセージ送信時のエラーハンドリングで`isOffline`を使用していない
- エラーコードのみに依存している

**直接原因2: エラーメッセージの統一性がない**
- メッセージが統一されていない
- オフライン時とネットワークエラー時の区別がない

### 5.2 根本原因

**根本原因1: エラーハンドリングロジックの不備**
- `isOffline`とエラーコードを組み合わせるロジックが実装されていない
- オフライン状態とネットワークエラーを区別するロジックがない

**根本原因2: 設計方針の不統一**
- メッセージ送信時のブロックでは`isOffline`を使用しているが、エラーハンドリングでは使用していない
- 統一されたエラーハンドリングロジックがない

---

## 6. 大原則への準拠確認

### 6.1 根本解決 > 暫定解決

**評価**: ✅ **準拠**
- `isOffline`とエラーコードを組み合わせることで、根本的に解決する
- オフライン状態とネットワークエラーを正確に区別できる

### 6.2 シンプル構造 > 複雑構造

**評価**: ✅ **準拠**
- エラーハンドリングロジックを統一することで、シンプルな構造になる
- 複雑な条件分岐を避け、明確なロジックにする

### 6.3 統一・同一化 > 特殊独自

**評価**: ✅ **準拠**
- `Chat.vue`と`Welcome.vue`で同じエラーハンドリングロジックを使用する
- 既存のエラーハンドリングパターンと統一する

### 6.4 具体的 > 一般

**評価**: ✅ **準拠**
- 具体的なエラーメッセージを表示する
- オフライン時、ネットワークエラー時、タイムアウト時、サーバーエラー時で異なるメッセージを表示する

### 6.5 拙速 < 安全確実

**評価**: ✅ **準拠**
- 既存のエラーハンドリングを改善することで、安全性を確保する
- テストを実施してから本番環境に反映する

---

## 7. 修正案

### 7.1 修正案1: `isOffline`とエラーコードの組み合わせ（推奨）

**目的**: オフライン状態とネットワークエラーを正確に区別する

**実装内容**:

#### 7.1.1 `Chat.vue`の施設情報取得時のエラーハンドリング修正

**修正箇所**: 201-237行目

**修正前**:
```typescript
catch (err: any) {
  // ... デバッグログ ...
  
  const errorCode = err?.code || err?.error?.code || err?.response?.data?.error?.code
  
  if (errorCode === 'NETWORK_ERROR' || String(errorCode) === 'NETWORK_ERROR') {
    error.value = '現在オフラインです。インターネット接続を確認してください。'
  } else if (errorCode === 'TIMEOUT_ERROR' || String(errorCode) === 'TIMEOUT_ERROR') {
    error.value = 'リクエストがタイムアウトしました。接続を確認して再度お試しください。'
  } else if (errorCode === 'SERVER_ERROR' || String(errorCode) === 'SERVER_ERROR') {
    error.value = 'サーバーエラーが発生しました。しばらくしてから再度お試しください。'
  } else {
    error.value = '施設情報の取得に失敗しました'
  }
}
```

**修正後**:
```typescript
catch (err: any) {
  // ... デバッグログ ...
  
  const errorCode = err?.code || err?.error?.code || err?.response?.data?.error?.code
  
  // オフライン時またはネットワークエラー時の処理
  if (errorCode === 'NETWORK_ERROR' || String(errorCode) === 'NETWORK_ERROR') {
    if (isOffline.value) {
      // オフライン時
      error.value = '現在オフラインです。インターネット接続を確認してください。'
    } else {
      // オンラインだがネットワークエラー
      error.value = 'ネットワークエラーが発生しました。接続を確認して再度お試しください。'
    }
  } else if (errorCode === 'TIMEOUT_ERROR' || String(errorCode) === 'TIMEOUT_ERROR') {
    error.value = 'リクエストがタイムアウトしました。接続を確認して再度お試しください。'
  } else if (errorCode === 'SERVER_ERROR' || String(errorCode) === 'SERVER_ERROR') {
    error.value = 'サーバーエラーが発生しました。しばらくしてから再度お試しください。'
  } else {
    error.value = '施設情報の取得に失敗しました'
  }
}
```

#### 7.1.2 `Chat.vue`のメッセージ送信時のエラーハンドリング修正

**修正箇所**: 442-482行目

**修正前**:
```typescript
catch (err: any) {
  // ... デバッグログ ...
  
  const errorCode = err?.code || err?.error?.code || err?.response?.data?.error?.code
  
  if (errorCode === 'NETWORK_ERROR' || String(errorCode) === 'NETWORK_ERROR') {
    error.value = '現在オフラインです。インターネット接続を確認してください。'
  } else if (errorCode === 'TIMEOUT_ERROR' || String(errorCode) === 'TIMEOUT_ERROR') {
    error.value = 'リクエストがタイムアウトしました。接続を確認して再度お試しください。'
  } else if (errorCode === 'SERVER_ERROR' || String(errorCode) === 'SERVER_ERROR') {
    error.value = 'サーバーエラーが発生しました。しばらくしてから再度お試しください。'
  } else {
    error.value = err.message || 'メッセージの送信に失敗しました'
  }
}
```

**修正後**:
```typescript
catch (err: any) {
  // ... デバッグログ ...
  
  const errorCode = err?.code || err?.error?.code || err?.response?.data?.error?.code
  
  // オフライン時またはネットワークエラー時の処理
  if (errorCode === 'NETWORK_ERROR' || String(errorCode) === 'NETWORK_ERROR') {
    if (isOffline.value) {
      // オフライン時
      error.value = '現在オフラインです。インターネット接続を確認してください。'
    } else {
      // オンラインだがネットワークエラー
      error.value = 'ネットワークエラーが発生しました。接続を確認して再度お試しください。'
    }
  } else if (errorCode === 'TIMEOUT_ERROR' || String(errorCode) === 'TIMEOUT_ERROR') {
    error.value = 'リクエストがタイムアウトしました。接続を確認して再度お試しください。'
  } else if (errorCode === 'SERVER_ERROR' || String(errorCode) === 'SERVER_ERROR') {
    error.value = 'サーバーエラーが発生しました。しばらくしてから再度お試しください。'
  } else {
    error.value = err.message || 'メッセージの送信に失敗しました'
  }
}
```

#### 7.1.3 `Welcome.vue`の施設情報取得時のエラーハンドリング修正

**修正箇所**: 89-124行目

**修正前**:
```typescript
catch (err: any) {
  // ... デバッグログ ...
  
  const errorCode = err?.code || err?.error?.code || err?.response?.data?.error?.code
  
  if (errorCode === 'NETWORK_ERROR' || String(errorCode) === 'NETWORK_ERROR') {
    error.value = '現在オフラインです。インターネット接続を確認してください。'
  } else if (errorCode === 'TIMEOUT_ERROR' || String(errorCode) === 'TIMEOUT_ERROR') {
    error.value = 'リクエストがタイムアウトしました。接続を確認して再度お試しください。'
  } else if (errorCode === 'SERVER_ERROR' || String(errorCode) === 'SERVER_ERROR') {
    error.value = 'サーバーエラーが発生しました。しばらくしてから再度お試しください。'
  } else {
    error.value = '施設情報の取得に失敗しました'
  }
}
```

**修正後**:
```typescript
catch (err: any) {
  // ... デバッグログ ...
  
  const errorCode = err?.code || err?.error?.code || err?.response?.data?.error?.code
  
  // オフライン時またはネットワークエラー時の処理
  if (errorCode === 'NETWORK_ERROR' || String(errorCode) === 'NETWORK_ERROR') {
    if (isOffline.value) {
      // オフライン時
      error.value = '現在オフラインです。インターネット接続を確認してください。'
    } else {
      // オンラインだがネットワークエラー
      error.value = 'ネットワークエラーが発生しました。接続を確認して再度お試しください。'
    }
  } else if (errorCode === 'TIMEOUT_ERROR' || String(errorCode) === 'TIMEOUT_ERROR') {
    error.value = 'リクエストがタイムアウトしました。接続を確認して再度お試しください。'
  } else if (errorCode === 'SERVER_ERROR' || String(errorCode) === 'SERVER_ERROR') {
    error.value = 'サーバーエラーが発生しました。しばらくしてから再度お試しください。'
  } else {
    error.value = '施設情報の取得に失敗しました'
  }
}
```

### 7.2 修正案の期待される効果

**効果1: オフライン状態とネットワークエラーの正確な区別**
- `isOffline.value === true`かつ`NETWORK_ERROR`コード → オフラインメッセージ
- `isOffline.value === false`かつ`NETWORK_ERROR`コード → ネットワークエラーメッセージ

**効果2: エラーメッセージの統一**
- `Chat.vue`と`Welcome.vue`で同じエラーハンドリングロジックを使用
- オフライン時、ネットワークエラー時、タイムアウト時、サーバーエラー時で異なるメッセージを表示

**効果3: ユーザー体験の向上**
- ユーザーに正確な情報を伝えられる
- オフライン状態とネットワークエラーを区別できる

### 7.3 大原則への準拠

**根本解決 > 暫定解決**: ✅ **準拠**
- `isOffline`とエラーコードを組み合わせることで、根本的に解決する

**シンプル構造 > 複雑構造**: ✅ **準拠**
- エラーハンドリングロジックを統一することで、シンプルな構造になる

**統一・同一化 > 特殊独自**: ✅ **準拠**
- `Chat.vue`と`Welcome.vue`で同じエラーハンドリングロジックを使用する

**具体的 > 一般**: ✅ **準拠**
- 具体的なエラーメッセージを表示する

**拙速 < 安全確実**: ✅ **準拠**
- 既存のエラーハンドリングを改善することで、安全性を確保する

---

## 8. まとめ

### 8.1 調査結果のまとめ

**実装状況**:
- ✅ `useOffline.ts`コンポーザブル: 実装済み・正常
- ✅ `Chat.vue`での`isOffline`取得: 実装済み
- ✅ `Welcome.vue`での`isOffline`取得: 実装済み
- ✅ メッセージ送信時のオフライン検出: 実装済み（`Chat.vue`、`Welcome.vue`）
- ❌ 施設情報取得時のエラーハンドリング: `isOffline`未使用
- ❌ メッセージ送信時のエラーハンドリング: `isOffline`未使用

**問題点**:
1. `isOffline`とエラーコードの組み合わせがない
2. オフライン状態とネットワークエラーを区別できない
3. エラーメッセージの統一性がない

### 8.2 修正案のまとめ

**推奨修正案**: **修正案1（`isOffline`とエラーコードの組み合わせ）**

**修正箇所**:
1. `Chat.vue`の施設情報取得時のエラーハンドリング（201-237行目）
2. `Chat.vue`のメッセージ送信時のエラーハンドリング（442-482行目）
3. `Welcome.vue`の施設情報取得時のエラーハンドリング（89-124行目）

**期待される効果**:
- オフライン状態とネットワークエラーの正確な区別
- エラーメッセージの統一
- ユーザー体験の向上

**大原則への準拠**: ✅ **すべて準拠**

---

**完全調査分析完了日時**: 2025年12月20日 11時08分52秒  
**状態**: 📋 **完全調査分析完了・修正案提示完了**

**重要**: 指示があるまで修正を実施しません。調査分析と修正案の提示のみです。
