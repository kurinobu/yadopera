# 開発者管理ページ ローカルテスト手順書

**作成日**: 2026年1月24日  
**目的**: 開発者管理ページのローカル環境での動作確認  
**状態**: ✅ **テスト準備完了**

---

## 1. テスト前の準備

### 1.1 環境変数設定

**ファイル**: `backend/.env`

以下の環境変数を追加してください：

```env
# 開発者認証
DEVELOPER_PASSWORD=TestPassword123!
DEVELOPER_SESSION_EXPIRE_HOURS=24
```

**設定方法**:
```bash
cd /Users/kurinobu/projects/yadopera/backend
echo "DEVELOPER_PASSWORD=TestPassword123!" >> .env
echo "DEVELOPER_SESSION_EXPIRE_HOURS=24" >> .env
```

**注意**: 本番環境では、より強力なパスワードを使用してください（20文字以上、大文字・小文字・数字・記号を含む）。

### 1.2 サービス起動確認

以下のコマンドでサービスが起動していることを確認：

```bash
docker-compose ps
```

**確認項目**:
- [ ] `yadopera-backend` が起動している（STATUS: Up）
- [ ] `yadopera-frontend` が起動している（STATUS: Up）
- [ ] `yadopera-postgres` が起動している（STATUS: Up, healthy）
- [ ] `yadopera-redis` が起動している（STATUS: Up, healthy）

### 1.3 バックエンド再起動（環境変数反映のため）

環境変数を追加した後、バックエンドを再起動：

```bash
docker-compose restart backend
```

---

## 2. テスト手順

### 2.1 開発者ログインページへのアクセス

**URL**: `http://localhost:5173/developer/login`

**確認項目**:
- [ ] ログインページが表示される
- [ ] パスワード入力フィールドが表示される
- [ ] ログインボタンが表示される

### 2.2 開発者ログイン

**テストケース1: 正しいパスワードでログイン**

1. パスワード入力フィールドに `TestPassword123!` を入力
2. ログインボタンをクリック
3. ダッシュボードページにリダイレクトされることを確認

**確認項目**:
- [ ] ログインが成功する
- [ ] ダッシュボードページ（`/developer/dashboard`）にリダイレクトされる
- [ ] エラーメッセージが表示されない

**テストケース2: 誤ったパスワードでログイン**

1. パスワード入力フィールドに `WrongPassword` を入力
2. ログインボタンをクリック
3. エラーメッセージが表示されることを確認

**確認項目**:
- [ ] ログインが失敗する
- [ ] エラーメッセージが表示される（"Incorrect password" または "ログインに失敗しました"）
- [ ] ログインページに留まる

### 2.3 ダッシュボード表示

**URL**: `http://localhost:5173/developer/dashboard`

**確認項目**:
- [ ] システム全体概要が表示される
  - [ ] 総施設数
  - [ ] アクティブ施設数
  - [ ] 総FAQ数
  - [ ] 過去24時間のエラー数（critical, error, warning）
  - [ ] 過去7日間のチャット数
  - [ ] 過去7日間のエスカレーション数
- [ ] 施設一覧が表示される
  - [ ] 施設名
  - [ ] アクティブ状態
  - [ ] FAQ数
  - [ ] 過去7日間のチャット数
  - [ ] 過去7日間のエラー数
  - [ ] 最終管理者ログイン日時

### 2.4 エラーログページ

**URL**: `http://localhost:5173/developer/errors`

**確認項目**:
- [ ] エラーログ一覧が表示される
- [ ] ページネーションが動作する
- [ ] フィルタリング機能が動作する（レベル、施設、日付範囲）
- [ ] エラーログ詳細をクリックすると詳細モーダルが開く
- [ ] スタックトレースが表示される（critical/errorレベルの場合）

**テストケース**:
1. エラーレベルでフィルタリング（critical, error, warning）
2. 施設IDでフィルタリング
3. 日付範囲でフィルタリング
4. ページネーションで次のページに移動

### 2.5 システムヘルスチェック

**URL**: `http://localhost:5173/developer/health`

**確認項目**:
- [ ] データベース接続状態が表示される
- [ ] Redis接続状態が表示される
- [ ] OpenAI API接続状態が表示される
- [ ] 各サービスの応答時間が表示される

### 2.6 トークン期限チェック

**テストケース: トークン期限切れ時の自動ログアウト**

1. 開発者としてログイン
2. ブラウザの開発者ツールで `localStorage.getItem('developer_token')` を確認
3. JWTトークンをデコードして有効期限を確認
4. （オプション）トークンの有効期限を手動で変更して期限切れにする
5. ページをリロードまたは別のページに移動
6. 自動的にログインページにリダイレクトされることを確認

**確認項目**:
- [ ] トークン期限切れ時に自動的にログアウトされる
- [ ] ログインページにリダイレクトされる
- [ ] エラーメッセージが表示されない（または適切なメッセージが表示される）

### 2.7 ログアウト

**テストケース: ログアウト機能**

1. ダッシュボードページでログアウトボタンをクリック
2. ログインページにリダイレクトされることを確認
3. `localStorage.getItem('developer_token')` が `null` であることを確認

**確認項目**:
- [ ] ログアウトが正常に動作する
- [ ] ログインページにリダイレクトされる
- [ ] トークンが削除される

### 2.8 認証保護

**テストケース: 未認証でのアクセス**

1. ログアウト状態で、以下のURLに直接アクセス：
   - `http://localhost:5173/developer/dashboard`
   - `http://localhost:5173/developer/errors`
   - `http://localhost:5173/developer/health`
2. ログインページにリダイレクトされることを確認

**確認項目**:
- [ ] 未認証で保護されたページにアクセスできない
- [ ] ログインページにリダイレクトされる
- [ ] リダイレクト後に元のページに戻れる（`redirect` クエリパラメータ）

---

## 3. API直接テスト（オプション）

### 3.1 開発者ログインAPI

```bash
curl -X POST http://localhost:8000/api/v1/developer/auth/login \
  -H "Content-Type: application/json" \
  -d '{"password": "TestPassword123!"}'
```

**期待されるレスポンス**:
```json
{
  "access_token": "eyJ...",
  "token_type": "bearer",
  "expires_in": 86400
}
```

### 3.2 システム全体概要API

```bash
curl -X GET http://localhost:8000/api/v1/developer/stats/overview \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

### 3.3 エラーログ一覧API

```bash
curl -X GET "http://localhost:8000/api/v1/developer/errors/list?page=1&per_page=50" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

---

## 4. トラブルシューティング

### 4.1 ログインできない

**原因**: 環境変数が設定されていない、またはバックエンドが再起動されていない

**解決方法**:
1. `backend/.env` ファイルに `DEVELOPER_PASSWORD` が設定されているか確認
2. `docker-compose restart backend` でバックエンドを再起動
3. バックエンドログを確認: `docker-compose logs backend --tail=50`

### 4.2 ダッシュボードが表示されない

**原因**: APIエラー、トークン期限切れ、認証エラー

**解決方法**:
1. ブラウザの開発者ツールでネットワークタブを確認
2. APIレスポンスのステータスコードを確認
3. コンソールエラーを確認
4. トークンが有効期限内か確認

### 4.3 エラーログが表示されない

**原因**: データベースにエラーログが存在しない

**解決方法**:
1. 意図的にエラーを発生させてエラーログを生成
2. データベースを直接確認:
   ```bash
   docker-compose exec postgres psql -U yadopera_user -d yadopera -c "SELECT * FROM error_logs LIMIT 10;"
   ```

---

## 5. テストチェックリスト

### 5.1 基本機能

- [ ] 開発者ログインページが表示される
- [ ] 正しいパスワードでログインできる
- [ ] 誤ったパスワードでログインできない
- [ ] ダッシュボードに統計が表示される
- [ ] 施設一覧が表示される
- [ ] エラーログ一覧が表示される
- [ ] システムヘルスチェックが動作する
- [ ] ログアウトできる

### 5.2 セキュリティ

- [ ] 未認証で保護されたページにアクセスできない
- [ ] トークン期限切れで自動ログアウトされる
- [ ] トークンが正しく保存・削除される

### 5.3 UI/UX

- [ ] ページ遷移がスムーズ
- [ ] エラーメッセージが適切に表示される
- [ ] ローディング状態が表示される
- [ ] レスポンシブデザインが動作する（オプション）

---

## 6. テスト完了後の確認

### 6.1 ログ確認

```bash
# バックエンドログ
docker-compose logs backend --tail=100 | grep -E "(error|Error|ERROR|developer)"

# フロントエンドログ
docker-compose logs frontend --tail=100 | grep -E "(error|Error|ERROR)"
```

### 6.2 データベース確認

```bash
# エラーログテーブル
docker-compose exec postgres psql -U yadopera_user -d yadopera -c "SELECT COUNT(*) FROM error_logs;"

# 管理者アクティビティログテーブル
docker-compose exec postgres psql -U yadopera_user -d yadopera -c "SELECT COUNT(*) FROM admin_activity_logs;"

# FAQ閲覧ログテーブル
docker-compose exec postgres psql -U yadopera_user -d yadopera -c "SELECT COUNT(*) FROM faq_view_logs;"
```

---

**Document Version**: v1.0  
**Author**: Auto (AI Assistant)  
**Last Updated**: 2026年1月24日  
**Status**: ✅ **テスト準備完了**

