# ステージング環境データ作成実行手順

**作成日時**: 2026年1月16日 12:50:00  
**目的**: ステージング環境のデータベースにテストデータを作成する手順  
**状態**: 修正案1完了、実行準備完了

---

## 1. 修正完了状況

### ✅ 修正案1: 完了
- `backend/create_staging_monthly_dashboard_test_data.py`: 環境変数対応完了
- `backend/fix_existing_facilities_plan_settings.py`: 環境変数対応完了
- コミット: `72c9946`

### ⏳ 修正案2: 実行待ち
- ステージング環境のデータベースにテストデータを作成

### ⏳ 修正案3: 実行待ち
- 既存データのプラン情報を修正

---

## 2. ステージング環境のデータベースURL取得方法

### 方法1: Render.comダッシュボードから取得（推奨）

1. Render.comダッシュボードにアクセス: https://dashboard.render.com
2. `yadopera-backend-staging` サービスを選択
3. 「Environment」タブを開く
4. `DATABASE_URL` 環境変数の値をコピー
   - 形式: `postgresql://postgres:password@host:port/database`
   - または: `postgresql+asyncpg://postgres:password@host:port/database`

### 方法2: Railwayダッシュボードから取得

1. Railwayダッシュボードにアクセス: https://railway.app
2. プロジェクトを選択
3. PostgreSQLサービスを選択
4. 「Variables」タブで `DATABASE_URL` または `DATABASE_PUBLIC_URL` を確認

---

## 3. 実行手順

### ステップ1: 環境変数を設定

```bash
# ステージング環境のDATABASE_URLを環境変数に設定
# （Render.comまたはRailwayから取得した値を設定）
export DATABASE_URL="postgresql://postgres:password@host:port/database"
```

**重要**: 
- `postgresql://` のままでOK（スクリプト内で `postgresql+asyncpg://` に変換されます）
- パスワードに特殊文字が含まれる場合は適切にエスケープしてください

---

### ステップ2: 既存データのプラン情報を修正（修正案3）

```bash
cd /Users/kurinobu/projects/yadopera
docker-compose exec backend python /app/fix_existing_facilities_plan_settings.py
```

**期待される結果**:
- test41@example.comのプラン情報がMiniプランに修正される
- その他の既存データのプラン情報も正しく設定される

---

### ステップ3: テストデータを作成（修正案2）

```bash
cd /Users/kurinobu/projects/yadopera
docker-compose exec backend python /app/create_staging_monthly_dashboard_test_data.py
```

**期待される結果**:
- test31@example.com: Freeプラン、15件の質問データ
- test41@example.com: Miniプラン、50件の質問データ
- test51@example.com: Smallプラン、100件の質問データ
- test61@example.com: Standardプラン、300件の質問データ
- test71@example.com: Premiumプラン、600件の質問データ

---

### ステップ4: 動作確認

1. ステージング環境のフロントエンドにアクセス
2. test31@example.comでログイン
3. ダッシュボードでデータが表示されることを確認
4. test41@example.comでログイン
5. ダッシュボードでMiniプランとして表示されることを確認

---

## 4. トラブルシューティング

### 問題1: 接続エラー

**症状**: `Connection refused` または `timeout` エラー

**解決方法**:
- DATABASE_URLが正しいか確認
- RailwayのPostgreSQLサービスが稼働中か確認
- ファイアウォール設定を確認

---

### 問題2: 認証エラー

**症状**: `authentication failed` エラー

**解決方法**:
- DATABASE_URLのパスワードが正しいか確認
- パスワードに特殊文字が含まれる場合は適切にエスケープ

---

### 問題3: データが表示されない

**症状**: スクリプトは成功したが、ブラウザでデータが表示されない

**解決方法**:
- ブラウザのキャッシュをクリア
- 強制リロード（Cmd+Shift+R または Ctrl+Shift+R）
- ステージング環境のAPIが正しく動作しているか確認

---

## 5. 次のステップ

1. ✅ 修正案1: 完了
2. ⏳ 修正案2: ステージング環境のデータベースURLを取得して実行
3. ⏳ 修正案3: ステージング環境のデータベースURLを取得して実行
4. ⏳ 動作確認: ブラウザテストを実行

---

**Document Version**: v1.0  
**Author**: Auto (AI Assistant)  
**Last Updated**: 2026年1月16日 12:50:00  
**Status**: 修正案1完了、実行手順準備完了

