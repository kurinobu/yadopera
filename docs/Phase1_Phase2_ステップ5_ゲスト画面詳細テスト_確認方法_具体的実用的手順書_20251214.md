# Phase 1・Phase 2: ステップ5 ゲスト画面詳細テスト 確認方法 具体的実用的手順書

**作成日**: 2025年12月14日  
**実施者**: AI Assistant  
**対象**: ステップ5（Docker環境でのゲスト画面詳細テスト）の確認方法（具体的・実用的な手順）  
**状態**: 📋 **具体的手順提示完了**

---

## 1. 確認可能な項目の確認結果

### 1.1 データベースの確認結果

**確認済み**: ✅ `matched_faq_ids`カラムは存在し、データが保存されている

**確認結果**:
```
 id  | content | ai_confidence | matched_faq_ids | created_at
-----+---------+---------------+-----------------+------------
 348 | ...     | 0.70          | {}              | 2025-12-14
 346 | ...     | 0.70          | {6}             | 2025-12-14
 344 | ...     | 0.70          | {19,15}         | 2025-12-14
```

**結論**: `matched_faq_ids`カラムは正常に動作しており、RAG検索結果が保存されている。

### 1.2 APIレスポンス構造の確認結果

**確認済み**: ✅ `matched_faq_ids`は`message`オブジェクト内に含まれる

**レスポンス構造**:
```json
{
  "message": {
    "id": 123,
    "role": "assistant",
    "content": "回答内容",
    "ai_confidence": 0.70,
    "matched_faq_ids": [6, 19, 15],  // ← ここに含まれる
    "response_time_ms": 1234,
    "created_at": "2025-12-14T12:34:56Z"
  },
  "session_id": "abc123",
  "ai_confidence": 0.70,
  "is_escalated": false,
  "escalation_id": null,
  "escalation": {...}
}
```

**結論**: `POST /api/v1/chat`のレスポンスに`matched_faq_ids`が含まれている。

---

## 2. 各項目の具体的確認手順

### 2.1 PWA対応が正常に動作することを確認

#### 2.1.1 オフライン動作について（重要）

**結論**: ❌ **インターネットに繋がっていない状態でAIは回答できません**

**理由**:
- AI回答生成にはOpenAI APIが必要（インターネット接続必須）
- PWAのオフライン対応は**静的リソース（HTML、CSS、JS）のキャッシュ**のみ
- 動的なAPI呼び出し（AI回答生成）はオフラインでは動作しない

**PWAのオフライン対応の範囲**:
- ✅ ページの表示（HTML、CSS、JSがキャッシュされている）
- ✅ 既に表示されたコンテンツの閲覧
- ❌ AI回答生成（OpenAI APIが必要）
- ❌ 新しいメッセージの送信（API呼び出しが必要）

#### 2.1.2 具体的確認手順

**手順1: Service Workerの確認**

1. **ブラウザでゲスト画面を開く**:
   - `http://localhost:5173/f/test-facility?location=entrance`

2. **開発者ツールを開く**:
   - Windows: `F12` または `Ctrl+Shift+I`
   - Mac: `Cmd+Option+I`

3. **Applicationタブをクリック**（Chrome/Edgeの場合）
   - Firefoxの場合は「Storage」タブ

4. **左側メニューから「Service Workers」をクリック**

5. **確認項目**:
   - Service Workerが表示されている
   - ステータスが「activated」または「running」である
   - スクリプトURLが表示されている（例: `http://localhost:5173/sw.js`）

**手順2: Manifest.jsonの確認**

1. **Applicationタブ（またはStorageタブ）の左側メニューから「Manifest」をクリック**

2. **確認項目**:
   - アプリ名: 「やどぺら」
   - アイコン: 192x192、512x512のアイコンが表示されている
   - テーマカラー: `#ffffff`

**手順3: オフライン動作の確認（静的リソースのみ）**

1. **開発者ツールのNetworkタブを開く**

2. **ネットワークスロットリングを設定**:
   - Networkタブの上部にある「No throttling」をクリック
   - 「Offline」を選択

3. **ページをリロード**（`F5`または`Ctrl+R` / `Cmd+R`）

4. **確認項目**:
   - ✅ ページが表示される（HTML、CSS、JSがキャッシュされている）
   - ❌ AI回答は生成されない（インターネット接続が必要）

5. **ネットワークスロットリングを「Online」に戻す**

**手順4: インストール可能な状態の確認**

1. **ブラウザのアドレスバーを確認**:
   - Chrome/Edge: アドレスバー右側に「インストール」アイコン（📱）が表示される（条件を満たす場合）
   - Firefox: アドレスバー右側に「インストール」アイコンが表示される（条件を満たす場合）

2. **表示されない場合**:
   - HTTPS接続が必要（localhostは例外）
   - Service Workerが登録されている必要がある
   - Manifest.jsonが正しく設定されている必要がある

---

### 2.2 固定フッターが正常に表示されることを確認

**結論**: ✅ **確認不要（実装されていないが問題なし）**

**理由**:
- 固定フッターは実装されていない
- メッセージ入力欄が画面下部に固定されている（これが「固定フッター」として機能している）
- ユーザー報告: 「固定フッターは存在しないが今のところ問題なし」

**確認不要**: この項目はスキップして問題ありません。

---

### 2.3 RAG統合型AI応答が正常に動作することを確認

#### 2.3.1 POST /api/v1/chatのレスポンスの確認方法（具体的手順）

**手順1: ブラウザ開発者ツールでネットワークリクエストを確認**

1. **ブラウザでゲスト画面を開く**:
   - `http://localhost:5173/f/test-facility/chat?location=entrance&lang=en`

2. **開発者ツールを開く**（`F12`）

3. **Networkタブをクリック**

4. **「Preserve log」にチェックを入れる**（ページ遷移後もログを保持）

5. **チャット画面で質問を送信**:
   - 例: "What time is check-in?"
   - メッセージ入力欄に質問を入力
   - Enterキーを押すか、送信ボタンをクリック

6. **Networkタブでリクエストを探す**:
   - フィルターに「chat」と入力（リクエストを絞り込む）
   - `POST /api/v1/chat` というリクエストを探す
   - リクエスト名をクリック

7. **Responseタブをクリック**（レスポンス内容を表示）

8. **レスポンスJSONを確認**:
   ```json
   {
     "message": {
       "id": 123,
       "role": "assistant",
       "content": "Check-in time is 3:00 PM.",
       "ai_confidence": 0.70,
       "matched_faq_ids": [6, 19, 15],  // ← ここを確認
       "response_time_ms": 1234,
       "created_at": "2025-12-14T12:34:56Z"
     },
     "session_id": "abc123",
     "ai_confidence": 0.70,
     "is_escalated": false,
     "escalation_id": null,
     "escalation": {...}
   }
   ```

9. **確認項目**:
   - ✅ `message.matched_faq_ids`が存在する
   - ✅ `matched_faq_ids`が配列である（例: `[6, 19, 15]`）
   - ✅ `matched_faq_ids`が空配列でない（RAG検索でFAQがヒットした場合）

**手順2: レスポンスのJSONをコピーして確認**

1. **ResponseタブでJSONを全選択**（`Ctrl+A` / `Cmd+A`）

2. **コピー**（`Ctrl+C` / `Cmd+C`）

3. **テキストエディタに貼り付け**（`Ctrl+V` / `Cmd+V`）

4. **`matched_faq_ids`を検索**（`Ctrl+F` / `Cmd+F`で「matched_faq_ids」と検索）

5. **確認項目**:
   - ✅ `matched_faq_ids`が存在する
   - ✅ 値が配列形式である（例: `[6, 19, 15]`）

#### 2.3.2 メッセージテーブルのmatched_faq_idsカラムの確認方法（具体的手順）

**手順1: データベースに接続**

1. **ターミナルを開く**

2. **以下のコマンドを実行**:
   ```bash
   cd /Users/kurinobu/projects/yadopera
   docker-compose exec postgres psql -U yadopera_user -d yadopera
   ```

3. **接続成功**: プロンプトが `yadopera=#` に変わる

**手順2: 最新のAI応答メッセージを確認**

1. **以下のSQLクエリを実行**:
   ```sql
   SELECT id, content, ai_confidence, matched_faq_ids, created_at 
   FROM messages 
   WHERE role = 'assistant' 
   ORDER BY created_at DESC 
   LIMIT 5;
   ```

2. **結果を確認**:
   ```
    id  | content | ai_confidence | matched_faq_ids | created_at
   -----+---------+---------------+-----------------+------------
   348 | ...     | 0.70          | {}              | 2025-12-14
   346 | ...     | 0.70          | {6}             | 2025-12-14
   344 | ...     | 0.70          | {19,15}         | 2025-12-14
   ```

3. **確認項目**:
   - ✅ `matched_faq_ids`カラムが存在する
   - ✅ `matched_faq_ids`が配列形式で表示されている（例: `{6}` または `{19,15}`）
   - ✅ 空配列の場合は `{}` と表示される

**手順3: 特定のメッセージIDのmatched_faq_idsを確認**

1. **Networkタブで確認したメッセージIDを取得**（例: `123`）

2. **以下のSQLクエリを実行**:
   ```sql
   SELECT id, content, matched_faq_ids 
   FROM messages 
   WHERE id = 123;
   ```

3. **結果を確認**:
   ```
    id  | content | matched_faq_ids
   -----+---------+-----------------
   123 | ...     | {6, 19, 15}
   ```

**手順4: matched_faq_idsに含まれるFAQを確認**

1. **matched_faq_idsの値を使用してFAQを取得**（例: `{6, 19, 15}`）

2. **以下のSQLクエリを実行**:
   ```sql
   SELECT id, question, answer, category 
   FROM faqs 
   WHERE id IN (6, 19, 15);
   ```

3. **結果を確認**:
   ```
    id | question | answer | category
   ----+----------+--------+----------
    6 | ...      | ...    | facilities
   19 | ...      | ...    | basic
   15 | ...      | ...    | basic
   ```

4. **確認項目**:
   - ✅ FAQが存在する
   - ✅ FAQのカテゴリが表示されている
   - ✅ FAQの質問・回答内容が表示されている

**手順5: データベース接続を終了**

1. **以下のコマンドを実行**:
   ```sql
   \q
   ```

2. **プロンプトが元に戻る**

#### 2.3.3 RAG処理のログの確認方法（具体的手順）

**手順1: バックエンドコンテナのログを確認**

1. **ターミナルを開く**

2. **以下のコマンドを実行**（リアルタイムでログを表示）:
   ```bash
   cd /Users/kurinobu/projects/yadopera
   docker-compose logs -f backend
   ```

3. **別のターミナル（またはブラウザ）で質問を送信**:
   - 例: "What time is check-in?"

4. **ログを確認**:
   - RAG処理に関するログが出力される
   - 例: `Vector search completed: 2/3 FAQs above threshold`

**手順2: 過去のログを確認**

1. **以下のコマンドを実行**（直近50行のログを表示）:
   ```bash
   cd /Users/kurinobu/projects/yadopera
   docker-compose logs --tail 50 backend | grep -E "(RAG|embedding|vector|FAQ|matched)"
   ```

2. **ログを確認**:
   - RAG処理に関するログが出力される
   - エラーログがないことを確認

**手順3: ログの出力場所**

**ログの出力先**:
- **標準出力（stdout）**: Dockerコンテナの標準出力
- **確認方法**: `docker-compose logs backend`

**ログレベル**:
- `logger.debug()`: デバッグ情報（通常は表示されない）
- `logger.info()`: 情報（通常は表示される）
- `logger.warning()`: 警告（表示される）
- `logger.error()`: エラー（表示される）

**RAG処理のログ例**:
```
INFO: Vector search completed: 2/3 FAQs above threshold
INFO: RAG processing completed: response_time_ms=1234
ERROR: Failed to generate embedding for question (エラーの場合)
```

---

### 2.4 フィードバックが正常に送信されることを確認

#### 2.4.1 ネットワークリクエストの確認方法（具体的手順）

**手順1: ブラウザ開発者ツールでネットワークリクエストを確認**

1. **ブラウザでゲスト画面を開く**:
   - `http://localhost:5173/f/test-facility/chat?location=entrance&lang=en`

2. **開発者ツールを開く**（`F12`）

3. **Networkタブをクリック**

4. **「Preserve log」にチェックを入れる**

5. **チャット画面でAI回答が表示されるまで待つ**

6. **👍👎ボタンをクリック**（例: 👍ボタン）

7. **Networkタブでリクエストを探す**:
   - フィルターに「feedback」と入力
   - `POST /api/v1/chat/feedback` というリクエストを探す
   - リクエスト名をクリック

8. **Requestタブをクリック**（リクエスト内容を表示）

9. **Payloadタブ（またはRequest Payload）をクリック**

10. **リクエストJSONを確認**:
    ```json
    {
      "message_id": 123,
      "feedback_type": "positive"
    }
    ```

11. **Responseタブをクリック**（レスポンス内容を表示）

12. **レスポンスJSONを確認**:
    ```json
    {
      "id": 456,
      "message_id": 123,
      "feedback_type": "positive",
      "created_at": "2025-12-14T12:34:56Z"
    }
    ```

13. **確認項目**:
    - ✅ ステータスコードが`200 OK`である
    - ✅ `message_id`が正しい
    - ✅ `feedback_type`が正しい（`positive`または`negative`）
    - ✅ `created_at`が現在時刻に近い

#### 2.4.2 データベースの確認方法（具体的手順）

**手順1: データベースに接続**

1. **ターミナルを開く**

2. **以下のコマンドを実行**:
   ```bash
   cd /Users/kurinobu/projects/yadopera
   docker-compose exec postgres psql -U yadopera_user -d yadopera
   ```

**手順2: 最新のフィードバックを確認**

1. **以下のSQLクエリを実行**:
   ```sql
   SELECT id, message_id, facility_id, feedback_type, created_at 
   FROM guest_feedback 
   ORDER BY created_at DESC 
   LIMIT 5;
   ```

2. **結果を確認**:
   ```
    id  | message_id | facility_id | feedback_type | created_at
   -----+------------+-------------+---------------+------------
   456 | 123        | 2           | positive      | 2025-12-14
   455 | 122        | 2           | negative      | 2025-12-14
   ```

3. **確認項目**:
   - ✅ フィードバックが保存されている
   - ✅ `message_id`が正しい
   - ✅ `feedback_type`が正しい（`positive`または`negative`）
   - ✅ `created_at`が現在時刻に近い

**手順3: データベース接続を終了**

1. **以下のコマンドを実行**:
   ```sql
   \q
   ```

#### 2.4.3 UIの確認方法（具体的手順）

**手順1: フィードバックボタンの動作確認**

1. **チャット画面でAI回答が表示されるまで待つ**

2. **👍👎ボタンをクリック**（例: 👍ボタン）

3. **UIの変化を確認**:
   - ✅ 「ありがとうございます / Thank you!」メッセージが表示される
   - ✅ ボタンが無効化される（クリックできなくなる）
   - ✅ ボタンの色が変わる（選択されたフィードバックタイプの色）

**手順2: フィードバック送信後の状態確認**

1. **👍👎ボタンをクリック後、ページをリロードしない**

2. **同じメッセージの👍👎ボタンを確認**:
   - ✅ ボタンが無効化されている
   - ✅ 「ありがとうございます / Thank you!」メッセージが表示されている

---

### 2.5 トークン入力機能が正常に動作することを確認（コピー機能の問題）

#### 2.5.1 コピー機能の確認方法（具体的手順）

**手順1: クリップボードの確認**

1. **チャット画面でセッション統合トークンを表示**（画面上部に表示される）

2. **「コピー / Copy」ボタンをクリック**

3. **テキストエディタを開く**（メモ帳、テキストエディットなど）

4. **貼り付け**:
   - Windows: `Ctrl+V`
   - Mac: `Cmd+V`

5. **確認項目**:
   - ✅ トークンが貼り付けられる（例: `AB12`）
   - ✅ トークンが4桁英数字である

**手順2: コンソールログの確認**

1. **ブラウザ開発者ツールを開く**（`F12`）

2. **Consoleタブをクリック**

3. **「コピー / Copy」ボタンをクリック**

4. **コンソールを確認**:
   - ✅ `Token copied: [トークン]` のログが出力される
   - ❌ エラーが出力されていない

**手順3: エラーの確認**

1. **ブラウザ開発者ツールを開く**（`F12`）

2. **Consoleタブをクリック**

3. **「コピー / Copy」ボタンをクリック**

4. **エラーを確認**:
   - ❌ `Copy failed: [エラー内容]` が出力されていない
   - ❌ その他のエラーが出力されていない

#### 2.5.2 問題点と改善提案

**問題点**:
- ❌ **トースト通知が実装されていない**（TODOコメント）
- ❌ コピー成功時の視覚的フィードバックがない

**現在の実装**:
```typescript
const handleCopy = async () => {
  await navigator.clipboard.writeText(props.token)
  emit('copy', props.token)
  // TODO: トースト通知を表示（Week 4で実装）
}
```

**改善提案**:
1. **トースト通知を実装する**（Week 4で実装予定）
2. **または、一時的にボタンのテキストを「コピー済み / Copied」に変更する**

**確認方法**:
- クリップボードにトークンがコピーされていることを確認（貼り付けで確認）
- コンソールログで`Token copied: [トークン]`が出力されることを確認

---

### 2.6 PWAインストールプロンプトが正常に表示されることを確認

#### 2.6.1 PWAインストールプロンプトとは（説明）

**PWAインストールプロンプト**とは、PWAアプリをホーム画面に追加するためのプロンプトです。

**機能**:
- ゲストがアプリをホーム画面に追加できる
- 追加後、オフラインでも利用できる（静的リソースのみ）
- ネイティブアプリのように起動できる

**表示条件**:
1. **HTTPS接続**（またはlocalhost）
2. **Manifest.jsonが正しく設定されている**
3. **Service Workerが登録されている**
4. **`beforeinstallprompt`イベントが発火する**（ブラウザが判断）

**注意**: ブラウザによって表示条件が異なる場合があります。また、既にインストール済みの場合は表示されません。

#### 2.6.2 確認方法（具体的手順）

**手順1: Manifest.jsonの確認**

1. **ブラウザでゲスト画面を開く**:
   - `http://localhost:5173/f/test-facility?location=entrance`

2. **開発者ツールを開く**（`F12`）

3. **Applicationタブをクリック**（Chrome/Edgeの場合）
   - Firefoxの場合は「Storage」タブ

4. **左側メニューから「Manifest」をクリック**

5. **確認項目**:
   - ✅ アプリ名: 「やどぺら」
   - ✅ アイコン: 192x192、512x512のアイコンが表示されている
   - ✅ テーマカラー: `#ffffff`

**手順2: Service Workerの確認**

1. **Applicationタブ（またはStorageタブ）の左側メニューから「Service Workers」をクリック**

2. **確認項目**:
   - ✅ Service Workerが表示されている
   - ✅ ステータスが「activated」または「running」である

**手順3: プロンプトの表示確認**

1. **ゲスト画面にアクセス**:
   - `http://localhost:5173/f/test-facility?location=entrance`

2. **画面下部を確認**:
   - PWAインストールプロンプトが表示される（条件を満たす場合）
   - プロンプトの内容:
     - 「アプリをインストール」タイトル
     - 「やどぺらをホーム画面に追加して、オフラインでも利用できます。」説明文
     - 「インストール」ボタン
     - 「後で」ボタン
     - 「閉じる」ボタン（×アイコン）

3. **プロンプトが表示されない場合**:
   - 既にインストール済みの可能性がある
   - ブラウザが表示条件を満たしていない可能性がある
   - 一度「後で」または「閉じる」をクリックした場合、localStorageに保存され、次回アクセス時には表示されない

**手順4: プロンプトの動作確認**

1. **プロンプトが表示されている場合**:
   - 「インストール」ボタンをクリック → インストールダイアログが表示される
   - 「後で」ボタンをクリック → プロンプトが非表示になる（localStorageに保存）
   - 「閉じる」ボタンをクリック → プロンプトが非表示になる（localStorageに保存）

2. **インストールダイアログで「インストール」をクリック**:
   - ホーム画面にアプリアイコンが追加される
   - アプリ名が「やどぺら」であることを確認

**手順5: インストール後の確認**

1. **ホーム画面を確認**:
   - アプリアイコンが追加されている
   - アプリ名が「やどぺら」である

2. **アプリを起動**:
   - ホーム画面のアプリアイコンをタップ
   - アプリが起動することを確認
   - スタンドアロンモードで表示されることを確認（ブラウザのアドレスバーが表示されない）

**手順6: プロンプトが表示されない場合の確認**

1. **localStorageを確認**:
   - 開発者ツールのApplicationタブ（またはStorageタブ）を開く
   - 左側メニューから「Local Storage」をクリック
   - `http://localhost:5173`をクリック
   - `pwa_install_dismissed`というキーが存在するか確認
   - 存在する場合、値を削除してページをリロード

2. **既にインストール済みか確認**:
   - 開発者ツールのConsoleタブを開く
   - 以下のコマンドを実行:
     ```javascript
     window.matchMedia('(display-mode: standalone)').matches
     ```
   - `true`が返される場合、既にインストール済み

---

## 3. 確認手順のまとめ

### 3.1 各項目の確認手順一覧

| 項目 | 確認方法 | 具体的手順 |
|------|----------|------------|
| **PWA対応** | Service Worker、Manifest.json、オフライン動作 | 開発者ツールのApplicationタブで確認 |
| **固定フッター** | 確認不要 | 実装されていないが問題なし |
| **RAG統合型AI応答** | ネットワークリクエスト、データベース、ログ | Networkタブで`POST /api/v1/chat`を確認、SQLで`matched_faq_ids`を確認 |
| **フィードバック送信** | ネットワークリクエスト、データベース、UI | Networkタブで`POST /api/v1/chat/feedback`を確認、SQLで`guest_feedback`を確認 |
| **トークンコピー機能** | クリップボード、コンソールログ | 貼り付けで確認、Consoleタブでログを確認 |
| **PWAインストールプロンプト** | Manifest.json、Service Worker、プロンプト表示 | Applicationタブで確認、画面下部でプロンプトを確認 |

### 3.2 確認手順の推奨順序

1. **RAG統合型AI応答の確認**（Networkタブ、データベース）
2. **フィードバック送信の確認**（Networkタブ、データベース、UI）
3. **トークンコピー機能の確認**（クリップボード、コンソールログ）
4. **PWA対応の確認**（Service Worker、Manifest.json）
5. **PWAインストールプロンプトの確認**（プロンプトの表示、動作確認）

---

## 4. 重要な注意事項

### 4.1 オフライン動作について

**結論**: ❌ **インターネットに繋がっていない状態でAIは回答できません**

**理由**:
- AI回答生成にはOpenAI APIが必要（インターネット接続必須）
- PWAのオフライン対応は静的リソース（HTML、CSS、JS）のキャッシュのみ
- 動的なAPI呼び出し（AI回答生成）はオフラインでは動作しない

**PWAのオフライン対応の範囲**:
- ✅ ページの表示（HTML、CSS、JSがキャッシュされている）
- ✅ 既に表示されたコンテンツの閲覧
- ❌ AI回答生成（OpenAI APIが必要）
- ❌ 新しいメッセージの送信（API呼び出しが必要）

### 4.2 確認方法の補足

**Networkタブでリクエストを探す方法**:
1. Networkタブを開く
2. フィルターにキーワードを入力（例: 「chat」「feedback」）
3. リクエスト名をクリック
4. Requestタブ、Responseタブで内容を確認

**データベースで確認する方法**:
1. `docker-compose exec postgres psql -U yadopera_user -d yadopera`で接続
2. SQLクエリを実行
3. `\q`で終了

**ログを確認する方法**:
1. `docker-compose logs -f backend`でリアルタイムログを表示
2. `docker-compose logs --tail 50 backend`で過去のログを表示

---

## 5. まとめ

### 5.1 確認可能な項目の確認結果

- ✅ `matched_faq_ids`カラムは存在し、データが保存されている
- ✅ APIレスポンスに`matched_faq_ids`が含まれている
- ✅ ログの出力場所が確認できた

### 5.2 具体的確認手順の提示

すべての項目について、具体的で実用的な確認手順を提示しました。

### 5.3 重要な注意事項

- ❌ オフラインではAI回答は生成できない（OpenAI APIが必要）
- ✅ PWAのオフライン対応は静的リソースのキャッシュのみ

---

**調査完了日**: 2025年12月14日  
**状態**: 📋 **具体的手順提示完了**


