# ⚠️ 危険！重要！ PWAインストール後の起動時404エラー 誤認識洗浄方法（大原則準拠）

**作成日時**: 2025年12月22日 15時58分38秒  
**実施者**: AI Assistant  
**目的**: AI Assistantの誤った認識による「汚染状態」を洗浄する方法を提案  
**状態**: ⚠️ **洗浄方法提案完了**

---

## ⚠️ 危険！重要！ 汚染状態の認識

### 汚染の深刻度

**問題の深刻度**: 🔴 **最高（開発全体に影響する可能性）**

**汚染の内容**:
- AI Assistantが「404エラーページを表示する」という誤った期待動作を理解していた
- この誤った認識が複数の文書に反映されている
- この誤った認識に基づいた実装が行われている可能性がある
- 今後の開発で誤った認識が再利用されるリスクがある

### 汚染の影響範囲

**影響を受ける可能性がある領域**:
1. **文書**: 複数のPWA関連文書に誤った認識が反映されている
2. **コード**: コメントや実装に誤った認識が反映されている可能性
3. **修正案**: 誤った認識に基づいた修正案が提示されている
4. **外部調査依頼書**: ChatGPT/Claudeへの調査依頼書に誤った認識が反映されている

---

## ⚠️ 危険！重要！ 大原則準拠の洗浄方法

### 洗浄方法1（推奨）: 誤った記述の削除と正しい記述への置換

**大原則への準拠**: ✅ **根本解決 > 暫定解決**

**実施内容**:
1. **誤った記述の特定**: 「404エラーページを表示」「保存された施設URLがない場合」という記述をすべて特定
2. **誤った記述の削除**: 誤った記述を削除
3. **正しい記述への置換**: 正しい期待動作（「最後にアクセスした施設URLにリダイレクトされる」）に置換
4. **警告の追加**: 誤った認識が含まれていたことを明記

**メリット**:
- ✅ 根本解決: 誤った記述を完全に削除し、正しい記述に置換
- ✅ 再発防止: 誤った記述が残らないため、再利用されるリスクがない
- ✅ 明確性: 正しい期待動作が明確に記載される

**デメリット**:
- 文書の修正作業が必要

### 洗浄方法2: コード内のコメントの修正

**大原則への準拠**: ✅ **根本解決 > 暫定解決**

**実施内容**:
1. **コード内のコメントを確認**: `frontend/src/router/index.ts`などのコメントを確認
2. **誤ったコメントの修正**: 「404エラーページを表示」という誤ったコメントを修正
3. **正しいコメントへの置換**: 正しい期待動作を記載

**メリット**:
- ✅ 根本解決: コード内の誤ったコメントを修正
- ✅ 開発者への明確な指示: 正しい期待動作がコード内に記載される

**デメリット**:
- コードの修正作業が必要

### 洗浄方法3: 実装の確認と修正

**大原則への準拠**: ✅ **根本解決 > 暫定解決**

**実施内容**:
1. **実装の確認**: 誤った認識に基づいた実装がないか確認
2. **実装の修正**: 誤った認識に基づいた実装があれば修正
3. **テスト**: 正しい期待動作が実現されることを確認

**メリット**:
- ✅ 根本解決: 誤った実装を修正
- ✅ 動作の保証: 正しい期待動作が実現される

**デメリット**:
- 実装の修正作業が必要

---

## ⚠️ 危険！重要！ 推奨される洗浄手順

### ステップ1: 誤った記述の完全な特定

**実施内容**:
1. すべてのPWA関連文書を検索
2. 「404エラーページを表示」「保存された施設URLがない場合」という記述を特定
3. リスト化して記録

### ステップ2: 誤った記述の削除と正しい記述への置換

**実施内容**:
1. 誤った記述を削除
2. 正しい期待動作（「最後にアクセスした施設URLにリダイレクトされる」）に置換
3. 警告を追加（誤った認識が含まれていたことを明記）

### ステップ3: コード内のコメントの修正

**実施内容**:
1. `frontend/src/router/index.ts`のコメントを確認
2. 誤ったコメントを修正
3. 正しい期待動作を記載

### ステップ4: 実装の確認と修正

**実施内容**:
1. 誤った認識に基づいた実装がないか確認
2. 実装を修正（必要に応じて）
3. テストを実施

---

## ⚠️ 危険！重要！ 正しい期待動作（再確認）

### 正しい期待動作

**PWAインストール後の起動時（ゲスト）**:
1. ゲストがPWAアイコンをタップ
2. `start_url: "/"`にアクセス
3. `index.html`が返される
4. Vue Routerが初期化される
5. **Vue Routerが`/`のルートにマッチする**
6. **`beforeEnter`ガードが実行される**
7. **localStorageから最後にアクセスした施設URLを取得**
8. **保存された施設URLにリダイレクト**
9. **施設独自の画面が表示される**
10. **ゲストが期待する動作が実現される**

**重要な認識**:
- ✅ **ゲストがPWAアイコンをタップした際、最後にアクセスした施設URLにリダイレクトされることが期待される**
- ❌ **404エラーページを表示することは期待されていない**
- ❌ **「施設URLがない場合」という状況は発生してはいけない（PWAインストールはゲスト側のルートでのみ可能なため）**

---

## ⚠️ 危険！重要！ 再発防止のための注意事項

### 注意事項

1. **期待動作の確認**:
   - 常に「ゲストがPWAアイコンをタップした際、最後にアクセスした施設URLにリダイレクトされる」ことを期待動作として理解する
   - 404エラーページを表示することは期待されていない

2. **「施設URLがない場合」の扱い**:
   - 「施設URLがない場合」という状況は発生してはいけない
   - PWAインストールはゲスト側のルート（`/f/:facilityId`）でのみ可能なため、インストール時には必ず施設URLが存在する
   - この状況を想定した実装は不要

3. **文書作成時の注意**:
   - 期待動作を記載する際は、必ず「最後にアクセスした施設URLにリダイレクトされる」ことを明記する
   - 404エラーページを表示するという記述は避ける（ただし、セキュリティ対策として不正なURLが検出された場合は除く）

---

**Document Version**: v1.0  
**Author**: AI Assistant  
**Last Updated**: 2025年12月22日  
**Status**: ⚠️ **洗浄方法提案完了**

**重要**: この文書は、AI Assistantの誤った認識による「汚染状態」を洗浄する方法を提案しています。推奨される洗浄手順に従って、誤った記述を完全に削除し、正しい記述に置換してください。

