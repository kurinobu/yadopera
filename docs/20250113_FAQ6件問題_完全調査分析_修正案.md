# FAQ6ä»¶å•é¡Œ å®Œå…¨èª¿æŸ»åˆ†æãƒ»ä¿®æ­£æ¡ˆ

**ä½œæˆæ—¥æ™‚**: 2025å¹´1æœˆ13æ—¥  
**ç›®çš„**: æ–°è¦ç™»éŒ²å¾Œã«FAQãŒ6ä»¶ã—ã‹è¡¨ç¤ºã•ã‚Œãªã„å•é¡Œã®å®Œå…¨èª¿æŸ»åˆ†æã¨ä¿®æ­£æ¡ˆæç¤º  
**çŠ¶æ…‹**: ğŸ” **èª¿æŸ»åˆ†æå®Œäº†ã€ä¿®æ­£æ¡ˆæç¤ºå¾…ã¡**

---

## 1. å•é¡Œã®æ¦‚è¦

### 1.1 å ±å‘Šå†…å®¹

- **æœŸå¾…å€¤**: æ–°è¦ç™»éŒ²å¾Œã€FAQãŒ20ä»¶è¡¨ç¤ºã•ã‚Œã‚‹
- **å®Ÿéš›ã®çµæœ**: FAQãŒ6ä»¶ã—ã‹è¡¨ç¤ºã•ã‚Œãªã„
- **ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°**: APIã‹ã‚‰6ä»¶ã®FAQãŒå–å¾—ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

### 1.2 ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã®è©³ç´°

```
âœ” FAQå–å¾—æˆåŠŸ: 6ä»¶
FaqList: props.faqs received: 6ä»¶
getFaqsByCategory (basic): 5ä»¶
getFaqsByCategory (facilities): 0ä»¶
getFaqsByCategory (location): 0ä»¶
getFaqsByCategory (trouble): 1ä»¶
```

**è©•ä¾¡**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯æ­£ã—ãå‹•ä½œã—ã¦ã„ã‚‹ã€‚å•é¡Œã¯**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIãŒ6ä»¶ã—ã‹è¿”ã—ã¦ã„ãªã„**ã€‚

---

## 2. æ ¹æœ¬åŸå› ã®èª¿æŸ»åˆ†æ

### 2.1 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã®å®Ÿè£…ç¢ºèª

#### 2.1.1 FAQå–å¾—API (`/api/v1/admin/faqs`)

**å®Ÿè£…**: `backend/app/api/v1/admin/faqs.py`

```python
@router.get("", response_model=FAQListResponse)
async def get_faqs(
    category: Optional[str] = Query(None),
    is_active: Optional[bool] = Query(None),
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    faq_service = FAQService(db)
    faqs = await faq_service.get_faqs(
        facility_id=facility_id,
        category=category,
        is_active=is_active
    )
    return FAQListResponse(faqs=faqs, total=len(faqs))
```

**è©•ä¾¡**: âœ… APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯æ­£ã—ãå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã€‚`is_active`ãƒ•ã‚£ãƒ«ã‚¿ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§`None`ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãªã—ï¼‰ã€‚

#### 2.1.2 FAQService.get_faqs()ã®å®Ÿè£…

**å®Ÿè£…**: `backend/app/services/faq_service.py`

```python
async def get_faqs(
    self,
    facility_id: int,
    category: Optional[str] = None,
    is_active: Optional[bool] = None
) -> List[FAQResponse]:
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã‚‹
    cached_faqs = await get_cache(cache_key_str)
    if cached_faqs is not None:
        return [FAQResponse(**faq_dict) for faq_dict in cached_faqs]
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—
    query = select(FAQ).where(FAQ.facility_id == facility_id)
    if category:
        query = query.where(FAQ.category == category)
    if is_active is not None:
        query = query.where(FAQ.is_active == is_active)
    
    query = query.options(selectinload(FAQ.translations))
    query = query.order_by(FAQ.priority.desc(), FAQ.created_at.desc())
    
    result = await self.db.execute(query)
    faqs = result.scalars().all()
    # ...
```

**è©•ä¾¡**: âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã¯æ­£ã—ãå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã€‚`is_active`ãŒ`None`ã®å ´åˆã¯ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ãªã„ã€‚

### 2.2 ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã®å®Ÿè£…ç¢ºèª

#### 2.2.1 FAQè‡ªå‹•ç™»éŒ²å‡¦ç† (`register_facility_async_faqs`)

**å®Ÿè£…**: `backend/app/services/auth_service.py`

```python
@staticmethod
async def register_facility_async_faqs(
    facility_id: int,
    user_id: int,
    subscription_plan: str
):
    # æ–™é‡‘ãƒ—ãƒ©ãƒ³ã«åŸºã¥ã„ã¦FAQãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿
    filtered_presets = filter_faq_presets_by_plan(
        FAQ_PRESETS,
        subscription_plan
    )
    
    # ãƒ—ãƒªã‚»ãƒƒãƒˆFAQã‚’FAQRequestã«å¤‰æ›
    faq_requests = []
    for preset in filtered_presets:
        faq_request = FAQRequest(
            category=preset["category"],
            intent_key=preset["intent_key"],
            translations=[...],
            priority=preset["priority"],
            is_active=True
        )
        faq_requests.append(faq_request)
    
    # FAQä¸€æ‹¬ä½œæˆ
    await FAQService(db).bulk_create_faqs(facility_id, faq_requests, user_id)
    await db.commit()
```

**è©•ä¾¡**: âœ… ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã¯æ­£ã—ãå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã€‚`filter_faq_presets_by_plan`ãŒ20ä»¶ã‚’è¿”ã™ã“ã¨ã‚’æœŸå¾…ã—ã¦ã„ã‚‹ã€‚

#### 2.2.2 FAQä¸€æ‹¬ä½œæˆå‡¦ç† (`bulk_create_faqs`)

**å®Ÿè£…**: `backend/app/services/faq_service.py`

```python
async def bulk_create_faqs(
    self,
    facility_id: int,
    faq_requests: List[FAQRequest],
    user_id: int
) -> List[FAQResponse]:
    created_faqs = []
    
    for request in faq_requests:
        try:
            faq_response = await self.create_faq(
                facility_id=facility_id,
                request=request,
                user_id=user_id
            )
            created_faqs.append(faq_response)
        except ValueError as e:
            logger.warning(f"Bulk FAQ creation: skipped due to validation error: {str(e)}")
            continue  # ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚ç¶šè¡Œ
        except Exception as e:
            logger.error(f"Bulk FAQ creation: unexpected error: {str(e)}", exc_info=True)
            continue  # äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ã¯ç¶šè¡Œ
    
    return created_faqs
```

**è©•ä¾¡**: âš ï¸ **å•é¡Œã®å¯èƒ½æ€§**: `create_faq`ã§é‡è¤‡ã‚¨ãƒ©ãƒ¼ï¼ˆ`ValueError`ï¼‰ãŒç™ºç”Ÿã—ãŸå ´åˆã€ãã®FAQã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ç¶šè¡Œã™ã‚‹ã€‚çµæœã¨ã—ã¦ã€ä¸€éƒ¨ã®FAQãŒä½œæˆã•ã‚Œãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

#### 2.2.3 FAQä½œæˆæ™‚ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ (`create_faq`)

**å®Ÿè£…**: `backend/app/services/faq_service.py`

```python
async def create_faq(
    self,
    facility_id: int,
    request: FAQRequest,
    user_id: int
) -> FAQResponse:
    # intent_keyã‚’ç”Ÿæˆï¼ˆæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆï¼‰
    if request.intent_key:
        intent_key = request.intent_key
    else:
        first_translation = request.translations[0]
        intent_key = generate_intent_key(request.category, first_translation.question)
    
    # é‡è¤‡ãƒã‚§ãƒƒã‚¯: åŒã˜facility_idã€åŒã˜intent_keyã®FAQãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    existing_faq_result = await self.db.execute(
        select(FAQ).where(
            FAQ.facility_id == facility_id,
            FAQ.intent_key == intent_key
        )
    )
    existing_faq = existing_faq_result.scalar_one_or_none()
    if existing_faq:
        logger.warning(
            f"Duplicate FAQ detected: facility_id={facility_id}, intent_key={intent_key}, "
            f"existing_faq_id={existing_faq.id}"
        )
        raise ValueError(
            f"FAQ with the same intent_key already exists: faq_id={existing_faq.id}, intent_key={intent_key}. "
            f"Please edit the existing FAQ instead of creating a duplicate."
        )
    # ...
```

**è©•ä¾¡**: âš ï¸ **å•é¡Œã®å¯èƒ½æ€§**: åŒã˜`intent_key`ã®FAQãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã€`ValueError`ã‚’ç™ºç”Ÿã•ã›ã‚‹ã€‚ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã§20ä»¶ã®FAQã‚’ä½œæˆã—ã‚ˆã†ã¨ã—ãŸãŒã€ä¸€éƒ¨ãŒé‡è¤‡ã‚¨ãƒ©ãƒ¼ã§ã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

### 2.3 æ–™é‡‘ãƒ—ãƒ©ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã®å®Ÿè£…ç¢ºèª

#### 2.3.1 `filter_faq_presets_by_plan`ã®å®Ÿè£…

**å®Ÿè£…**: `backend/app/core/plan_limits.py`

```python
def filter_faq_presets_by_plan(
    presets: List[Dict[str, Any]],
    plan: str
) -> List[Dict[str, Any]]:
    # ãƒ—ãƒ©ãƒ³ã®åˆ¶é™ã‚’å–å¾—ï¼ˆè¨€èªãƒ•ã‚£ãƒ«ã‚¿ç”¨ï¼‰
    limits = get_plan_limits(plan)
    allowed_languages = limits["languages"]
    
    # å„ªå…ˆåº¦é †ã«ã‚½ãƒ¼ãƒˆï¼ˆå„ªå…ˆåº¦ãŒé«˜ã„é †ï¼‰
    sorted_presets = sorted(
        presets,
        key=lambda x: x.get("priority", 1),
        reverse=True
    )
    
    # ä¸Šä½20ä»¶ã‚’æŠ½å‡º
    selected_presets = sorted_presets[:20]
    
    # è¨€èªãƒ•ã‚£ãƒ«ã‚¿
    if allowed_languages:
        selected_presets = [
            {
                **preset,
                "translations": [
                    t for t in preset["translations"]
                    if t["language"] in allowed_languages
                ]
            }
            for preset in selected_presets
        ]
        # ãƒ•ã‚£ãƒ«ã‚¿å¾Œã‚‚ç¿»è¨³ãŒæ®‹ã£ã¦ã„ã‚‹FAQã®ã¿ã‚’è¿”ã™
        selected_presets = [
            preset for preset in selected_presets
            if preset["translations"]
        ]
    
    return selected_presets
```

**è©•ä¾¡**: âš ï¸ **å•é¡Œã®å¯èƒ½æ€§**: è¨€èªãƒ•ã‚£ãƒ«ã‚¿å¾Œã€ç¿»è¨³ãŒæ®‹ã£ã¦ã„ãªã„FAQã¯é™¤å¤–ã•ã‚Œã‚‹ã€‚çµæœã¨ã—ã¦ã€20ä»¶æœªæº€ã®FAQãŒè¿”ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

---

## 3. æ ¹æœ¬åŸå› ã®ç¢ºå®š

### 3.1 å•é¡Œã®å¯èƒ½æ€§ï¼ˆå„ªå…ˆé †ä½é †ï¼‰

#### å¯èƒ½æ€§1: è¨€èªãƒ•ã‚£ãƒ«ã‚¿å¾Œã®é™¤å¤–ï¼ˆæœ€æœ‰åŠ›ï¼‰

**åŸå› **:
- `filter_faq_presets_by_plan`ãŒå„ªå…ˆåº¦é †ã«ã‚½ãƒ¼ãƒˆã—ã¦ä¸Šä½20ä»¶ã‚’æŠ½å‡º
- ãã®å¾Œã€è¨€èªãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨
- è¨€èªãƒ•ã‚£ãƒ«ã‚¿å¾Œã€ç¿»è¨³ãŒæ®‹ã£ã¦ã„ãªã„FAQã¯é™¤å¤–ã•ã‚Œã‚‹
- çµæœã¨ã—ã¦ã€20ä»¶æœªæº€ã®FAQãŒè¿”ã•ã‚Œã‚‹

**ç¢ºèªæ–¹æ³•**:
- `FAQ_PRESETS`ã®å†…å®¹ã‚’ç¢ºèª
- `filter_faq_presets_by_plan`ã®æˆ»ã‚Šå€¤ã‚’ç¢ºèª
- è¨€èªãƒ•ã‚£ãƒ«ã‚¿å¾Œã®ä»¶æ•°ã‚’ç¢ºèª

#### å¯èƒ½æ€§2: é‡è¤‡ã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚‹ã‚¹ã‚­ãƒƒãƒ—

**åŸå› **:
- ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã§20ä»¶ã®FAQã‚’ä½œæˆã—ã‚ˆã†ã¨ã—ãŸ
- ä¸€éƒ¨ã®FAQãŒé‡è¤‡ã‚¨ãƒ©ãƒ¼ï¼ˆ`ValueError`ï¼‰ã§ã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸ
- çµæœã¨ã—ã¦ã€6ä»¶ã—ã‹ç™»éŒ²ã•ã‚Œã¦ã„ãªã„

**ç¢ºèªæ–¹æ³•**:
- ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã®ãƒ­ã‚°ã‚’ç¢ºèª
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å®Ÿéš›ã«ä½•ä»¶ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- é‡è¤‡ã‚¨ãƒ©ãƒ¼ã®ãƒ­ã‚°ã‚’ç¢ºèª

#### å¯èƒ½æ€§3: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã®æœªå®Œäº†

**åŸå› **:
- ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ãŒé€”ä¸­ã§å¤±æ•—ã—ãŸ
- çµæœã¨ã—ã¦ã€6ä»¶ã—ã‹ç™»éŒ²ã•ã‚Œã¦ã„ãªã„

**ç¢ºèªæ–¹æ³•**:
- ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã®ãƒ­ã‚°ã‚’ç¢ºèª
- ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª

---

## 4. ç¢ºèªã™ã¹ãäº‹é …

### 4.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å®Ÿéš›ã®çŠ¶æ…‹

**ç¢ºèªSQL**:
```sql
-- æ–½è¨­IDã‚’ç¢ºèªï¼ˆæœ€æ–°ã®æ–½è¨­ã‚’å–å¾—ï¼‰
SELECT id, name, subscription_plan, created_at 
FROM facilities 
ORDER BY created_at DESC 
LIMIT 1;

-- ãã®æ–½è¨­ã®FAQä»¶æ•°ã‚’ç¢ºèª
SELECT COUNT(*) 
FROM faqs 
WHERE facility_id = (SELECT id FROM facilities ORDER BY created_at DESC LIMIT 1);

-- ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®ä»¶æ•°ã‚’ç¢ºèª
SELECT category, COUNT(*) 
FROM faqs 
WHERE facility_id = (SELECT id FROM facilities ORDER BY created_at DESC LIMIT 1)
GROUP BY category;
```

### 4.2 ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã®ãƒ­ã‚°

**ç¢ºèªæ–¹æ³•**:
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ­ã‚°ã‚’ç¢ºèª
- `Background FAQ creation completed`ã®ãƒ­ã‚°ã‚’ç¢ºèª
- `Bulk FAQ creation: skipped due to validation error`ã®ãƒ­ã‚°ã‚’ç¢ºèª

### 4.3 `filter_faq_presets_by_plan`ã®æˆ»ã‚Šå€¤

**ç¢ºèªæ–¹æ³•**:
- `filter_faq_presets_by_plan`ã®æˆ»ã‚Šå€¤ã‚’ãƒ­ã‚°å‡ºåŠ›
- è¨€èªãƒ•ã‚£ãƒ«ã‚¿å‰å¾Œã®ä»¶æ•°ã‚’ç¢ºèª

---

## 5. ä¿®æ­£æ¡ˆï¼ˆå¤§åŸå‰‡æº–æ‹ ï¼‰

### ä¿®æ­£æ¡ˆ1: è¨€èªãƒ•ã‚£ãƒ«ã‚¿å‰ã®ä»¶æ•°ç¢ºä¿ï¼ˆå„ªå…ˆåº¦1ï¼‰

**å•é¡Œ**: è¨€èªãƒ•ã‚£ãƒ«ã‚¿å¾Œã€ç¿»è¨³ãŒæ®‹ã£ã¦ã„ãªã„FAQãŒé™¤å¤–ã•ã‚Œã€20ä»¶æœªæº€ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

**ä¿®æ­£å†…å®¹**:
- `filter_faq_presets_by_plan`ã‚’ä¿®æ­£
- è¨€èªãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨ã—ãŸå¾Œã€20ä»¶ã«ãªã‚‹ã¾ã§è¿½åŠ ã®FAQã‚’æŠ½å‡ºã™ã‚‹

**å®Ÿè£…ä¾‹**:
```python
def filter_faq_presets_by_plan(
    presets: List[Dict[str, Any]],
    plan: str
) -> List[Dict[str, Any]]:
    limits = get_plan_limits(plan)
    allowed_languages = limits["languages"]
    
    # å„ªå…ˆåº¦é †ã«ã‚½ãƒ¼ãƒˆ
    sorted_presets = sorted(
        presets,
        key=lambda x: x.get("priority", 1),
        reverse=True
    )
    
    # è¨€èªãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨
    filtered_presets = []
    for preset in sorted_presets:
        filtered_translations = [
            t for t in preset["translations"]
            if not allowed_languages or t["language"] in allowed_languages
        ]
        if filtered_translations:
            filtered_presets.append({
                **preset,
                "translations": filtered_translations
            })
    
    # 20ä»¶ã«ãªã‚‹ã¾ã§æŠ½å‡º
    return filtered_presets[:20]
```

**è©•ä¾¡**: âœ… ã‚·ãƒ³ãƒ—ãƒ«ã§æ ¹æœ¬çš„ãªè§£æ±ºç­–ã€‚è¨€èªãƒ•ã‚£ãƒ«ã‚¿å¾Œã‚‚20ä»¶ã‚’ç¢ºä¿ã§ãã‚‹ã€‚

### ä¿®æ­£æ¡ˆ2: é‡è¤‡ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ãƒ­ã‚°å‡ºåŠ›ï¼ˆå„ªå…ˆåº¦2ï¼‰

**å•é¡Œ**: é‡è¤‡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€ãã®FAQãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ãŒã€ãƒ­ã‚°ã«è©³ç´°ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

**ä¿®æ­£å†…å®¹**:
- `bulk_create_faqs`ã§é‡è¤‡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€è©³ç´°ãªãƒ­ã‚°ã‚’å‡ºåŠ›
- ã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸFAQã®`intent_key`ã¨ç†ç”±ã‚’è¨˜éŒ²

**å®Ÿè£…ä¾‹**:
```python
async def bulk_create_faqs(
    self,
    facility_id: int,
    faq_requests: List[FAQRequest],
    user_id: int
) -> List[FAQResponse]:
    created_faqs = []
    skipped_faqs = []
    
    for request in faq_requests:
        try:
            faq_response = await self.create_faq(
                facility_id=facility_id,
                request=request,
                user_id=user_id
            )
            created_faqs.append(faq_response)
        except ValueError as e:
            skipped_faqs.append({
                "intent_key": request.intent_key,
                "category": request.category,
                "reason": str(e)
            })
            logger.warning(
                f"Bulk FAQ creation: skipped due to validation error: "
                f"intent_key={request.intent_key}, category={request.category}, error={str(e)}"
            )
            continue
        except Exception as e:
            logger.error(
                f"Bulk FAQ creation: unexpected error: intent_key={request.intent_key}, "
                f"error={str(e)}", exc_info=True
            )
            continue
    
    if skipped_faqs:
        logger.warning(
            f"Bulk FAQ creation: {len(skipped_faqs)} FAQs were skipped: {skipped_faqs}"
        )
    
    logger.info(
        f"Bulk FAQ creation completed: facility_id={facility_id}, "
        f"requested={len(faq_requests)}, created={len(created_faqs)}, skipped={len(skipped_faqs)}"
    )
    
    return created_faqs
```

**è©•ä¾¡**: âœ… å•é¡Œã®åŸå› ã‚’ç‰¹å®šã—ã‚„ã™ããªã‚‹ã€‚ãƒ‡ãƒãƒƒã‚°ã«æœ‰ç”¨ã€‚

### ä¿®æ­£æ¡ˆ3: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ï¼ˆå„ªå…ˆåº¦3ï¼‰

**å•é¡Œ**: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ãŒé€”ä¸­ã§å¤±æ•—ã—ãŸå ´åˆã€ã‚¨ãƒ©ãƒ¼ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

**ä¿®æ­£å†…å®¹**:
- `register_facility_async_faqs`ã§ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å¼·åŒ–
- ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€è©³ç´°ãªãƒ­ã‚°ã‚’å‡ºåŠ›

**å®Ÿè£…ä¾‹**:
```python
@staticmethod
async def register_facility_async_faqs(
    facility_id: int,
    user_id: int,
    subscription_plan: str
):
    async with AsyncSessionLocal() as db:
        try:
            filtered_presets = filter_faq_presets_by_plan(
                FAQ_PRESETS,
                subscription_plan
            )
            
            logger.info(
                f"Background FAQ creation: facility_id={facility_id}, "
                f"plan={subscription_plan}, filtered_presets_count={len(filtered_presets)}"
            )
            
            # ... (æ—¢å­˜ã®å‡¦ç†)
            
            created_faqs = await FAQService(db).bulk_create_faqs(facility_id, faq_requests, user_id)
            await db.commit()
            
            logger.info(
                f"Background FAQ creation completed: facility_id={facility_id}, "
                f"plan={subscription_plan}, requested={len(faq_requests)}, "
                f"created={len(created_faqs)}"
            )
            
            if len(created_faqs) < len(faq_requests):
                logger.warning(
                    f"Background FAQ creation: {len(faq_requests) - len(created_faqs)} FAQs were skipped: "
                    f"facility_id={facility_id}, plan={subscription_plan}"
                )
        except Exception as e:
            logger.error(
                f"Background FAQ creation failed: facility_id={facility_id}, "
                f"plan={subscription_plan}, error={str(e)}",
                exc_info=True
            )
```

**è©•ä¾¡**: âœ… å•é¡Œã®åŸå› ã‚’ç‰¹å®šã—ã‚„ã™ããªã‚‹ã€‚ãƒ‡ãƒãƒƒã‚°ã«æœ‰ç”¨ã€‚

---

## 6. æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£é †åº

1. **ä¿®æ­£æ¡ˆ1: è¨€èªãƒ•ã‚£ãƒ«ã‚¿å‰ã®ä»¶æ•°ç¢ºä¿**ï¼ˆæœ€å„ªå…ˆï¼‰
   - æ ¹æœ¬çš„ãªè§£æ±ºç­–
   - ã‚·ãƒ³ãƒ—ãƒ«ã§ç†è§£ã—ã‚„ã™ã„
   - å¤§åŸå‰‡ã«æº–æ‹ 

2. **ä¿®æ­£æ¡ˆ2: é‡è¤‡ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ãƒ­ã‚°å‡ºåŠ›**ï¼ˆæ¬¡å„ªå…ˆï¼‰
   - å•é¡Œã®åŸå› ã‚’ç‰¹å®šã—ã‚„ã™ããªã‚‹
   - ãƒ‡ãƒãƒƒã‚°ã«æœ‰ç”¨

3. **ä¿®æ­£æ¡ˆ3: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–**ï¼ˆè£œåŠ©çš„ï¼‰
   - å•é¡Œã®åŸå› ã‚’ç‰¹å®šã—ã‚„ã™ããªã‚‹
   - ãƒ‡ãƒãƒƒã‚°ã«æœ‰ç”¨

---

## 7. ã¾ã¨ã‚

### 7.1 å•é¡Œã®æ ¹æœ¬åŸå› 

**æœ€æœ‰åŠ›**: è¨€èªãƒ•ã‚£ãƒ«ã‚¿å¾Œã€ç¿»è¨³ãŒæ®‹ã£ã¦ã„ãªã„FAQãŒé™¤å¤–ã•ã‚Œã€20ä»¶æœªæº€ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

### 7.2 ä¿®æ­£æ–¹é‡

1. **ä¿®æ­£æ¡ˆ1**ã‚’æœ€å„ªå…ˆã§å®Ÿæ–½
2. **ä¿®æ­£æ¡ˆ2**ã¨**ä¿®æ­£æ¡ˆ3**ã‚’è£œåŠ©çš„ã«å®Ÿæ–½

### 7.3 ç¢ºèªäº‹é …

- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å®Ÿéš›ã®çŠ¶æ…‹ã‚’ç¢ºèª
- ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã®ãƒ­ã‚°ã‚’ç¢ºèª
- `filter_faq_presets_by_plan`ã®æˆ»ã‚Šå€¤ã‚’ç¢ºèª

---

**çŠ¶æ…‹**: ğŸ” **èª¿æŸ»åˆ†æå®Œäº†ã€ä¿®æ­£æ¡ˆæç¤ºå®Œäº†**  
**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤ºã‚’å¾…ã¤ï¼ˆä¿®æ­£ã¯å®Ÿæ–½ã—ãªã„ï¼‰

