# Phase 1・Phase 2: 開発サーバーオフライン動作失敗 原因分析・説明・評価

**作成日時**: 2025年12月19日 10時42分30秒  
**実施者**: AI Assistant  
**目的**: 開発サーバー（`localhost:5173`）でのオフライン動作失敗の原因分析と説明・評価  
**状態**: 📋 **分析完了・説明・評価完了**

**重要**: 指示があるまで修正を実施しません。分析と説明のみです。

---

## 1. 問題の詳細

### 1.1 ユーザーが報告した問題

**問題**: 開発サーバー（`localhost:5173`）でオフライン動作が失敗している

**発生状況**:
- プレビューサーバー（`localhost:4173`）では成功を確認
- 開発サーバー（`localhost:5173`）では失敗
- 言語選択画面でオフラインに設定しリロードすると、「インターネットに接続されていません」というエラーが表示される

**スクリーンショットから確認した内容**:
- URL: `localhost:5173/f/test-facility?location=entrance`
- エラーメッセージ: 「インターネットに接続されていません」
- エラーコード: `ERR_INTERNET_DISCONNECTED`
- Networkタブ: 「オフライン」がチェックされている
- リクエスト: `test-facility?location=entrance`が失敗（`net::ERR_INTERNET_DISCONNECTED`）
- 一部のリソース（`data:image/png;base...`）はメモリキャッシュから読み込まれている

### 1.2 重要な発見

**問題点**:
- 開発サーバー（`localhost:5173`）では、オフライン時に静的リソースがキャッシュから読み込まれていない
- Service Workerが登録されていないか、正常に動作していない可能性がある
- プレビューサーバー（`localhost:4173`）では成功しているため、ビルド済みファイルでは正常に動作している

---

## 2. 原因分析

### 2.1 直接原因

**原因**: **開発サーバー（`npm run dev`）ではService Workerが自動登録されない**

**詳細**:
- 開発サーバー（`npm run dev`）は、ソースコードを直接実行する（Viteの開発モード）
- Service Workerはビルド済みファイル（`dist/`）に含まれている
- 開発サーバーでは、ビルド済みファイルが提供されていない
- そのため、Service Workerが登録されず、オフライン時に静的リソースがキャッシュから読み込まれない

### 2.2 根本原因

**根本原因**: **開発モードと本番ビルドの違い**

**開発モード（`npm run dev`）**:
- ポート: `5173`
- 動作: ソースコードを直接実行（Viteの開発モード）
- Service Worker: **自動登録されない**
- 理由: `vite-plugin-pwa`は開発モードではService Workerを登録しない設定になっている可能性がある

**本番ビルド（`npm run build` + `npm run preview`）**:
- ポート: `4173`
- 動作: ビルド済みファイル（`dist/`）を提供
- Service Worker: **自動登録される**
- 理由: ビルド済みファイルには`registerSW.js`が含まれており、`index.html`から読み込まれる

### 2.3 確認した内容

**`vite.config.ts`の設定**:
```typescript
VitePWA({
  registerType: 'autoUpdate',
  // ...
})
```
- `registerType: 'autoUpdate'`が設定されている
- ただし、開発モード（`npm run dev`）では動作しない可能性がある

**`package.json`のスクリプト**:
```json
{
  "scripts": {
    "dev": "vite",
    "build": "vue-tsc && vite build",
    "preview": "vite preview"
  }
}
```
- `dev`: 開発モード（Service Workerが登録されない）
- `build`: 本番ビルド（Service Workerが生成される）
- `preview`: プレビューサーバー（ビルド済みファイルを提供）

---

## 3. 説明・評価

### 3.1 問題の説明

**問題**: 開発サーバー（`localhost:5173`）でオフライン動作が失敗している

**状況**:
- プレビューサーバー（`localhost:4173`）では成功している
- 開発サーバー（`localhost:5173`）では失敗している
- オフライン時に「インターネットに接続されていません」というエラーが表示される

**影響**:
- 開発サーバーでのオフライン動作確認ができない
- ただし、プレビューサーバーでの確認は可能

### 3.2 評価

**評価**: ⚠️ **予想される動作**

**理由**:
1. **開発サーバーでの動作**: ⚠️ **予想される動作**
   - 開発サーバー（`npm run dev`）では、Service Workerが自動登録されないのは正常な動作の可能性がある
   - これは、開発モードと本番ビルドの違いによるものである

2. **プレビューサーバーでの動作**: ✅ **正常**
   - プレビューサーバー（`npm run preview`）では、Service Workerが正常に登録されている
   - オフライン動作も正常に動作している

3. **開発サーバーでのオフライン動作確認**: ⚠️ **制限がある**
   - 開発サーバーでのオフライン動作確認は制限がある
   - プレビューサーバーでの確認を推奨

**結論**: 
- 開発サーバーでオフライン動作が失敗するのは、予想される動作である可能性が高い
- プレビューサーバー（`localhost:4173`）での確認を推奨
- 本番環境（ステージング環境）でも正常に動作する可能性が高い

---

## 4. 以前の調査結果との関連

### 4.1 以前の調査結果

**調査内容**: `docs/Phase1_Phase2_ServiceWorker未登録_原因分析_説明評価_20251219.md`

**発見された問題**:
- 開発サーバー（`localhost:5173`）では、Service Workerが登録されていない
- プレビューサーバー（`localhost:4173`）では、Service Workerが正常に登録されている

**結論**:
- 開発サーバーでService Workerが登録されないのは、正常な動作の可能性がある
- プレビューサーバーでの確認を推奨

### 4.2 今回の問題との関連

**関連性**:
- 今回の問題は、以前の調査結果と一致している
- 開発サーバーではService Workerが登録されないため、オフライン動作が失敗している
- プレビューサーバーではService Workerが正常に登録されているため、オフライン動作が成功している

**重要性**:
- 開発サーバーでのオフライン動作確認は制限がある
- プレビューサーバーでの確認を推奨
- 本番環境（ステージング環境）でも正常に動作する可能性が高い

---

## 5. 次のステップ

### 5.1 推奨される確認方法

**確認方法1: プレビューサーバーでの確認（推奨）**

**手順**:
1. プレビューサーバー（`localhost:4173`）でオフライン動作を確認
2. 開発者ツールのNetworkタブで「Offline」にチェックを入れる
3. ページをリロード（`F5`または`Cmd+R`）
4. 静的リソース（HTML、CSS、JS）が表示されることを確認

**期待される結果**:
- オフライン時に静的リソースがキャッシュから読み込まれる
- ページが正常に表示される

**確認方法2: デプロイ後のステージング環境での確認（推奨）**

**手順**:
1. 修正をコミット・プッシュ
2. Render.comで自動デプロイが完了するまで待つ
3. ステージング環境でオフライン動作を確認

**期待される結果**:
- オフライン時に静的リソースがキャッシュから読み込まれる
- ページが正常に表示される

### 5.2 開発サーバーでのオフライン動作確認について

**制限事項**:
- 開発サーバー（`localhost:5173`）では、Service Workerが自動登録されない
- そのため、オフライン動作の確認は制限がある

**推奨事項**:
- プレビューサーバー（`localhost:4173`）での確認を推奨
- 本番環境（ステージング環境）での確認を推奨

---

## 6. まとめ

### 6.1 問題の原因

**直接原因**: **開発サーバー（`npm run dev`）ではService Workerが自動登録されない**
- 開発サーバーは、ソースコードを直接実行する（Viteの開発モード）
- Service Workerはビルド済みファイル（`dist/`）に含まれている
- 開発サーバーでは、ビルド済みファイルが提供されていない

**根本原因**: **開発モードと本番ビルドの違い**
- 開発モード（`npm run dev`）では、Service Workerが自動登録されない
- 本番ビルド（`npm run build` + `npm run preview`）では、Service Workerが自動登録される

### 6.2 評価

**評価**: ⚠️ **予想される動作**

**理由**:
- 開発サーバーでオフライン動作が失敗するのは、予想される動作である可能性が高い
- プレビューサーバーでは正常に動作している
- 本番環境（ステージング環境）でも正常に動作する可能性が高い

### 6.3 推奨事項

**推奨される確認方法**:
1. **プレビューサーバー（`localhost:4173`）での確認**: 🔴 **最高優先度**
   - オフライン動作の確認
   - 施設情報のキャッシュ確認

2. **デプロイ後のステージング環境での確認**: 🟡 **中優先度**
   - 本番環境と同様の環境で最終確認を行う

**開発サーバーでのオフライン動作確認について**:
- ⚠️ **制限がある**: 開発サーバーでは、Service Workerが自動登録されないため、オフライン動作の確認は制限がある
- ✅ **プレビューサーバーでの確認を推奨**: プレビューサーバーでの確認を推奨

---

**分析完了日時**: 2025年12月19日 10時42分30秒  
**状態**: 📋 **分析完了・説明・評価完了**

**重要**: 指示があるまで修正を実施しません。分析と説明のみです。
