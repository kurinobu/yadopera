# AI自動応答数表示問題 - 完全調査分析・修正案

**作成日時**: 2026年1月14日 17:10:00  
**目的**: 「AI自動応答数が40件のデータを挿入したが、ダッシュボードには50件と表示される」問題の完全調査分析と修正案提示  
**状態**: 調査分析完了、根本原因特定、修正案提示

---

## 1. 問題の説明

### 1.1 問題の内容

- **報告**: MiniプランでAI自動応答数が「40件」のデータを挿入したが、ダッシュボードには「50件」と表示される
- **期待値**: 40件
- **実際の表示**: 50件
- **差分**: +10件（25%の誤差）

---

## 2. 完全根本調査分析

### 2.1 データベース確認結果

**確認結果**:
```
Miniプラン（Facility ID: 37）
  総質問数: 50件 ✅
  AI自動応答数（DB集計）: 40件 ✅
  会話数: 50件 ✅
```

**評価**: データベースには正しく40件のAI自動応答メッセージが存在している ✅

---

### 2.2 Backend APIロジック確認結果

**問題箇所**: `backend/app/services/dashboard_service.py` の `get_ai_automation` メソッド

**現在のロジック（560-561行目）**:
```python
# AI自動応答数 = 総会話数 - エスカレーションされた会話数
ai_responses = max(0, total_conversations - len(escalated_conversation_ids))
```

**問題点**:
1. **会話数をカウントしている**: `total_conversations`（50件）を使用
2. **メッセージ数をカウントしていない**: 実際のAI自動応答メッセージ数（40件）を無視
3. **ロジックの誤り**: 「AI自動応答数」は「会話数」ではなく「AI自動応答メッセージ数」であるべき

**確認結果**:
```
総会話数: 50件
エスカレーションされた会話数: 0件
AI自動応答数（現在のロジック）: 50 - 0 = 50件 ❌
AI自動応答数（正しい値）: 40件 ✅
```

---

### 2.3 根本原因

**根本原因**: `get_ai_automation`メソッドが「会話数」を「AI自動応答数」として返している

**詳細**:
1. **設計上の誤り**: AI自動応答数は「エスカレーションされなかった会話数」ではなく、「AI自動応答メッセージ数（assistantロールのメッセージ数）」であるべき
2. **データの不一致**: 1つの会話に複数のメッセージが含まれる場合、会話数とメッセージ数が一致しない
3. **テストデータとの不一致**: テストデータでは50会話中40会話にAI自動応答メッセージが含まれているが、ロジックは会話数をカウントしている

---

## 3. 大原則準拠評価

### 3.1 根本解決 > 暫定解決

**評価**: ✅ **準拠**
- ロジックの根本原因を特定
- 暫定的な回避策ではなく、設計レベルでの解決を提案

### 3.2 シンプル構造 > 複雑構造

**評価**: ✅ **準拠**
- 修正案は既存のコードパターンに従う
- 過度に複雑な実装を避けている

### 3.3 統一・同一化 > 特殊独自

**評価**: ✅ **準拠**
- 既存のメッセージカウントロジックに従う
- 特殊な実装を避けている

### 3.4 具体的 > 一般

**評価**: ✅ **準拠**
- 具体的な修正コードを提示
- 実行可能な具体的な内容を記載

### 3.5 拙速 < 安全確実

**評価**: ✅ **準拠**
- テストを省略せず、十分な検証を行う
- 安全を確保しながら修正を実施

---

## 4. 修正案

### 4.1 修正案1: AI自動応答数をメッセージ数でカウントする（根本解決・推奨）

**理由**: AI自動応答数は「エスカレーションされなかった会話のAI自動応答メッセージ数」であるべき

**修正ファイル**: `backend/app/services/dashboard_service.py`

**修正箇所**: `get_ai_automation`メソッド（560-561行目）

**修正前**:
```python
# AI自動応答数 = 総会話数 - エスカレーションされた会話数
ai_responses = max(0, total_conversations - len(escalated_conversation_ids))
```

**修正後**:
```python
# エスカレーションされなかった会話IDを取得
non_escalated_conversation_ids = []
if escalated_conversation_ids:
    all_conversations_result = await self.db.execute(
        select(Conversation.id)
        .where(
            Conversation.facility_id == facility_id,
            Conversation.started_at >= month_start_utc,
            Conversation.started_at <= month_end_utc
        )
    )
    all_conversation_ids = [row[0] for row in all_conversations_result.all()]
    non_escalated_conversation_ids = [cid for cid in all_conversation_ids if cid not in escalated_conversation_ids]
else:
    # エスカレーションがなければすべての会話が対象
    all_conversations_result = await self.db.execute(
        select(Conversation.id)
        .where(
            Conversation.facility_id == facility_id,
            Conversation.started_at >= month_start_utc,
            Conversation.started_at <= month_end_utc
        )
    )
    non_escalated_conversation_ids = [row[0] for row in all_conversations_result.all()]

# AI自動応答数 = エスカレーションされなかった会話のAI自動応答メッセージ数
ai_responses = 0
if non_escalated_conversation_ids:
    ai_responses_result = await self.db.execute(
        select(func.count(Message.id))
        .where(
            Message.conversation_id.in_(non_escalated_conversation_ids),
            Message.role == MessageRole.ASSISTANT.value,
            Message.created_at >= month_start_utc,
            Message.created_at <= month_end_utc
        )
    )
    ai_responses = ai_responses_result.scalar() or 0
```

**評価**: ✅ **根本解決**
- AI自動応答数を正しくメッセージ数でカウントする
- エスカレーションされなかった会話のAI自動応答メッセージのみをカウント

---

## 5. 修正実施順序

### ステップ1: バックアップを作成

**理由**: 安全を確保するため

### ステップ2: 修正案1を実行（根本解決）

**理由**: AI自動応答数を正しくメッセージ数でカウントする

### ステップ3: ブラウザテストで確認

**理由**: 修正が正しく反映されているか確認

---

## 6. 修正後の期待結果

### 6.1 Miniプランでの表示

- ✅ AI自動応答数: 40件（正しい値）
- ✅ 総質問数: 50件
- ✅ 自動化率: 80.0%（40 / 50 * 100）

---

## 7. テスト項目

### 7.1 データベース確認

1. **AI自動応答メッセージ数を確認**
   - Miniプラン: 40件
   - エスカレーションされなかった会話のassistantメッセージ数が40件であることを確認

### 7.2 API確認

1. **APIレスポンスを確認**
   - `ai_responses`が40件である
   - `total_questions`が50件である
   - `automation_rate`が80.0%である

### 7.3 ブラウザ確認

1. **ダッシュボード表示を確認**
   - AI自動応答数が40件と表示される
   - 自動化率が80.0%と表示される

---

**Document Version**: v1.0  
**Author**: Auto (AI Assistant)  
**Last Updated**: 2026年1月14日 17:10:00  
**Status**: 調査分析完了、根本原因特定完了、修正案提示完了

