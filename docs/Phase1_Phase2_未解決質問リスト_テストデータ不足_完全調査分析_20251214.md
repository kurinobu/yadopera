# Phase 1・Phase 2: 未解決質問リスト テストデータ不足 完全調査分析

**作成日時**: 2025年12月14日  
**実施者**: AI Assistant  
**対象**: FAQ管理ページの未解決質問リストにテストデータが表示されない問題  
**状態**: 📋 **完全調査分析完了**

---

## 1. 問題の概要

### 1.1 ユーザー報告

**問題**: FAQ管理ページにアクセスしたが、「未解決質問リストから1つ選択」が一つもテストデータが用意されておらず、いずれのテストも実行できなかった

**影響**: **重大** - FAQ自動学習UIのテストが実施できない

---

## 2. 調査結果

### 2.1 テストデータ作成スクリプトの実装状況

**ファイル**: `backend/create_test_data.py`

**実装状況**: ✅ **実装されている**

**実装内容**:
- 122-257行目: 未解決質問のテストデータ作成ロジックが実装されている
- 3件の未解決質問を作成する設計
- 以下のデータを作成:
  1. `Conversation`（会話）
  2. `Message`（ユーザーメッセージ）
  3. `Message`（アシスタントメッセージ、低信頼度）
  4. `Escalation`（未解決、`resolved_at IS NULL`）

**作成される未解決質問**:
1. session_id: `test-session-unresolved-1`
   - 質問: "What time is check-in?"
   - 言語: en
   - trigger_type: low_confidence
   - ai_confidence: 0.5

2. session_id: `test-session-unresolved-2`
   - 質問: "Where is the nearest convenience store?"
   - 言語: en
   - trigger_type: low_confidence
   - ai_confidence: 0.4

3. session_id: `test-session-unresolved-3`
   - 質問: "チェックインの時間は何時ですか？"
   - 言語: ja
   - trigger_type: keyword
   - ai_confidence: 0.6

---

### 2.2 ステップ0の実施完了レポートの確認

**ファイル**: `docs/Phase1_Phase2_ステップ0_環境準備とテストデータ作成_実施完了レポート_20251213.md`

**実施日時**: 2025年12月13日

**実施結果**:
- ✅ テストデータ作成スクリプトが実行された
- ✅ 未解決エスカレーション: 6件作成された
- ✅ 会話: 23件作成された
- ✅ メッセージ: 322件作成された

**作成された未解決質問**:
1. escalation_id: 7（既存）
2. escalation_id: 2（既存）
3. escalation_id: 10（新規作成）

**問題の可能性**:
- ステップ0の実施完了レポートによると、テストデータは作成された
- しかし、ユーザーがFAQ管理ページにアクセスした際に、未解決質問リストが空だった
- これは、以下の可能性がある:
  1. データが削除された
  2. エスカレーションが解決済み（`resolved_at IS NOT NULL`）になった
  3. APIが正しく動作していない
  4. フロントエンドが正しくデータを取得していない
  5. ログインしているユーザーの`facility_id`が異なる

---

### 2.3 未解決質問取得APIの実装確認

**ファイル**: `backend/app/api/v1/admin/escalations.py`

**エンドポイント**: `GET /api/v1/admin/escalations/unresolved-questions`

**実装状況**: ✅ **実装されている**

**実装内容**:
- 104-139行目: 未解決質問リスト取得APIが実装されている
- JWT認証必須
- 現在のユーザーが所属する施設の未解決質問を返却

**サービス**: `backend/app/services/escalation_service.py`

**メソッド**: `get_unresolved_questions()`

**取得条件**:
```python
Escalation.facility_id == facility_id
AND Escalation.resolved_at IS NULL
```

**取得ロジック**:
1. 未解決のエスカレーションを取得（`resolved_at IS NULL`）
2. Conversationをeager load
3. 各エスカレーションに関連する最初のユーザーメッセージを取得
4. `UnresolvedQuestionResponse`形式に変換

**問題の可能性**:
- APIが正しく実装されている
- しかし、データが取得できない場合は、以下の可能性がある:
  1. データベースに未解決エスカレーションが存在しない
  2. エスカレーションの`resolved_at`が`NULL`でない
  3. ユーザーの`facility_id`が異なる
  4. Conversationが存在しない
  5. ユーザーメッセージが存在しない

---

### 2.4 フロントエンドの実装確認

**ファイル**: `frontend/src/views/admin/FaqManagement.vue`

**実装状況**: ✅ **実装されている**

**実装内容**:
- 167-180行目: `fetchUnresolvedQuestions()`メソッドが実装されている
- `unresolvedQuestionsApi.getUnresolvedQuestions()`を呼び出し
- `onMounted`で`fetchUnresolvedQuestions()`を呼び出す

**APIクライアント**: `frontend/src/api/unresolvedQuestions.ts`

**実装内容**:
- `getUnresolvedQuestions()`メソッドが実装されている
- `/admin/escalations/unresolved-questions`エンドポイントを呼び出し

**問題の可能性**:
- フロントエンドが正しく実装されている
- しかし、データが表示されない場合は、以下の可能性がある:
  1. APIがエラーを返している
  2. APIが空の配列を返している
  3. フロントエンドのエラーハンドリングが不十分

---

## 3. 問題の根本原因分析

### 3.1 可能性1: テストデータが作成されていない

**可能性**: 中

**原因**:
- テストデータ作成スクリプトが実行されていない
- テストデータ作成スクリプトがエラーで失敗した

**確認方法**:
```bash
# Docker環境でテストデータ作成スクリプトを実行
docker-compose exec backend python create_test_data.py

# データベースで未解決エスカレーションを確認
docker-compose exec postgres psql -U yadopera_user -d yadopera -c "SELECT COUNT(*) as unresolved_count FROM escalations WHERE resolved_at IS NULL AND facility_id = (SELECT id FROM facilities WHERE slug = 'test-facility');"
```

---

### 3.2 可能性2: エスカレーションが解決済みになっている

**可能性**: 高

**原因**:
- テストデータ作成後に、エスカレーションが解決済み（`resolved_at IS NOT NULL`）になった
- 手動でエスカレーションを解決した
- バッチ処理などでエスカレーションが解決された

**確認方法**:
```bash
# データベースで未解決エスカレーションを確認
docker-compose exec postgres psql -U yadopera_user -d yadopera -c "SELECT id, conversation_id, resolved_at FROM escalations WHERE facility_id = (SELECT id FROM facilities WHERE slug = 'test-facility') ORDER BY created_at DESC LIMIT 10;"
```

---

### 3.3 可能性3: ユーザーのfacility_idが異なる

**可能性**: 中

**原因**:
- ログインしているユーザーの`facility_id`が、テストデータの`facility_id`と異なる
- テストユーザーが異なる施設に所属している

**確認方法**:
```bash
# データベースでユーザーのfacility_idを確認
docker-compose exec postgres psql -U yadopera_user -d yadopera -c "SELECT id, email, facility_id FROM users WHERE email = 'test@example.com';"

# データベースでテスト施設のIDを確認
docker-compose exec postgres psql -U yadopera_user -d yadopera -c "SELECT id, slug FROM facilities WHERE slug = 'test-facility';"
```

---

### 3.4 可能性4: APIがエラーを返している

**可能性**: 中

**原因**:
- APIエンドポイントがエラーを返している
- 認証エラー
- データベース接続エラー

**確認方法**:
- ブラウザの開発者ツール（Networkタブ）でAPIリクエストを確認
- バックエンドのログを確認
- APIエンドポイントを直接呼び出して確認

---

### 3.5 可能性5: ConversationまたはMessageが存在しない

**可能性**: 低

**原因**:
- エスカレーションは存在するが、関連するConversationが存在しない
- Conversationは存在するが、ユーザーメッセージが存在しない

**確認方法**:
```bash
# データベースでエスカレーションとConversationの関連を確認
docker-compose exec postgres psql -U yadopera_user -d yadopera -c "SELECT e.id as escalation_id, e.conversation_id, c.id as conversation_exists FROM escalations e LEFT JOIN conversations c ON e.conversation_id = c.id WHERE e.facility_id = (SELECT id FROM facilities WHERE slug = 'test-facility') AND e.resolved_at IS NULL LIMIT 10;"

# データベースでユーザーメッセージの存在を確認
docker-compose exec postgres psql -U yadopera_user -d yadopera -c "SELECT m.id as message_id, m.conversation_id, m.role FROM messages m WHERE m.conversation_id IN (SELECT conversation_id FROM escalations WHERE facility_id = (SELECT id FROM facilities WHERE slug = 'test-facility') AND resolved_at IS NULL) AND m.role = 'user' ORDER BY m.created_at ASC LIMIT 10;"
```

---

## 4. 確認すべき項目

### 4.1 即座に確認すべき項目

1. **データベースの状態確認**
   - 未解決エスカレーションが存在するか
   - エスカレーションの`resolved_at`が`NULL`であるか
   - ユーザーの`facility_id`が正しいか

2. **APIエンドポイントの動作確認**
   - APIが正しく動作しているか
   - APIがエラーを返していないか
   - APIが空の配列を返していないか

3. **フロントエンドの動作確認**
   - フロントエンドが正しくAPIを呼び出しているか
   - フロントエンドがエラーハンドリングを正しく実装しているか

---

### 4.2 確認コマンド

**データベースの状態確認**:
```bash
# 未解決エスカレーションの確認
docker-compose exec postgres psql -U yadopera_user -d yadopera -c "
SELECT 
    e.id as escalation_id,
    e.conversation_id,
    e.resolved_at,
    c.id as conversation_exists,
    (SELECT COUNT(*) FROM messages WHERE conversation_id = c.id AND role = 'user') as user_message_count
FROM escalations e
LEFT JOIN conversations c ON e.conversation_id = c.id
WHERE e.facility_id = (SELECT id FROM facilities WHERE slug = 'test-facility')
ORDER BY e.created_at DESC
LIMIT 10;
"

# ユーザーのfacility_id確認
docker-compose exec postgres psql -U yadopera_user -d yadopera -c "
SELECT u.id, u.email, u.facility_id, f.slug as facility_slug
FROM users u
LEFT JOIN facilities f ON u.facility_id = f.id
WHERE u.email = 'test@example.com';
"
```

**APIエンドポイントの動作確認**:
```bash
# ログインしてトークンを取得
TOKEN=$(curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"testpassword123"}' \
  | jq -r '.access_token')

# 未解決質問リストを取得
curl -X GET http://localhost:8000/api/v1/admin/escalations/unresolved-questions \
  -H "Authorization: Bearer $TOKEN" \
  | jq .
```

---

## 5. 推奨対応

### 5.1 即座に実施すべき対応

1. **データベースの状態確認**
   - 上記の確認コマンドを実行
   - 未解決エスカレーションが存在するか確認
   - エスカレーションの`resolved_at`が`NULL`であるか確認

2. **テストデータ作成スクリプトの再実行**
   - テストデータ作成スクリプトを再実行
   - データが正しく作成されることを確認

3. **APIエンドポイントの動作確認**
   - APIエンドポイントを直接呼び出して確認
   - エラーが発生していないか確認

---

### 5.2 根本解決策

**問題**: テストデータが作成されていない、または削除された

**解決策**:
1. **テストデータ作成スクリプトの再実行**
   ```bash
   docker-compose exec backend python create_test_data.py
   ```

2. **データベースの状態確認**
   - 未解決エスカレーションが存在することを確認
   - エスカレーションの`resolved_at`が`NULL`であることを確認

3. **APIエンドポイントの動作確認**
   - APIが正しく動作していることを確認
   - データが正しく返されることを確認

---

## 6. まとめ

### 6.1 調査結果サマリー

**テストデータ作成スクリプト**: ✅ **実装されている**
- `backend/create_test_data.py`に未解決質問のテストデータ作成ロジックが実装されている
- 3件の未解決質問を作成する設計

**ステップ0の実施完了レポート**: ✅ **実施された**
- 2025年12月13日にテストデータ作成スクリプトが実行された
- 未解決エスカレーション: 6件作成された

**APIエンドポイント**: ✅ **実装されている**
- `GET /api/v1/admin/escalations/unresolved-questions`が実装されている
- 未解決エスカレーションを取得するロジックが実装されている

**フロントエンド**: ✅ **実装されている**
- `FaqManagement.vue`に未解決質問リストの取得ロジックが実装されている

### 6.2 問題の可能性

**最も可能性が高い原因**:
1. **エスカレーションが解決済みになっている**（`resolved_at IS NOT NULL`）
2. **テストデータが削除された**
3. **ユーザーの`facility_id`が異なる**

### 6.3 推奨対応

**即座に実施すべき対応**:
1. データベースの状態確認
2. テストデータ作成スクリプトの再実行
3. APIエンドポイントの動作確認

---

**Document Version**: v1.0  
**Author**: AI Assistant  
**Last Updated**: 2025-12-14  
**Status**: 📋 **完全調査分析完了**

**重要**: 指示があるまで修正しないでください。調査分析のみ実施しました。


