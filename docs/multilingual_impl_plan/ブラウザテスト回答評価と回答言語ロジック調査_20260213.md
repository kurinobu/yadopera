# ブラウザテスト回答評価と回答言語ロジック調査報告（2026-02-13）

## 1. テスト結果の共有内容（要約）

| 言語 | 質問1（夜間静音） | 質問2（シャワー） | 質問3（最寄り駅） |
|------|------------------|------------------|-------------------|
| zh-TW | 晚上请保持安静… | 淋浴隨時可以使用！… | 很抱歉，我無法提供具體方向… |
| fr | Oui, nous demandons… | Oui, vous pouvez utiliser la douche… | Je vous recommande de demander… |
| ko | 안녕하세요! 저희 호텔에서는… | 네, 언제든지 샤워를… | 죄송하지만, 가까운 역에 대한… |

**韓国語選択で中国語で質問した場合**
- 「浴室在哪里？」→ 中国語で回答（浴室位于您的客房内…）
- 「可不可以使用洗衣机？」→ 中国語で回答（很抱歉，我们没有提供洗衣机…）

---

## 2. 回答の適切性評価

### 2.1 各言語の内容評価

- **繁体中国語（zh-TW）**
  - 静音：夜間の静粛・職員への連絡案内 → **適切**
  - シャワー：いつでも利用可・他に質問があれば連絡を → **適切**
  - 駅：具体的な方向は案内できない・職員に聞くよう案内 → **適切**（プリセットは「館内マップを確認」だが、AIが「案内できない＋職員へ」に言い換えても許容範囲）

- **フランス語（fr）**
  - 静音：夜の静粛依頼・理解への感謝 → **適切**
  - シャワー：いつでも可・必要なら職員に連絡 → **適切**
  - 駅：受付で最寄り駅への道順を聞くよう案内 → **適切**

- **韓国語（ko）**
  - 静音：夜間の静粛ルール・追加質問はいつでも → **適切**
  - シャワー：いつでも利用可 → **適切**
  - 駅：最寄り駅の情報はない・職員に聞けば対応 → **適切**

- **韓国語選択＋中国語質問**
  - 浴室：客室内にある旨・追加の助けは職員へ → **適切**
  - 洗衣机：洗濯機は提供していない・必要なら職員へ → **適切**

**結論：いずれの回答も内容として適切であり、施設情報・FAQに沿った応答になっている。**

---

## 3. 各言語で同じ意味か（言語間の一致）

| 意図 | zh-TW | fr | ko | 一致 |
|------|-------|----|----|------|
| 夜間静音 | 夜間静粛・職員連絡案内 | 夜の静粛依頼・理解感謝 | 夜間静粛ルール・質問はいつでも | ○ 同一趣旨 |
| シャワー | いつでも使用可・他質問は連絡 | いつでも可・必要なら職員へ | いつでも使用可 | ○ 同一趣旨 |
| 最寄り駅 | 方向案内不可・職員へ | 受付で道順を聞くよう案内 | 駅情報なし・職員に問い合わせ | ○ 同一趣旨 |

**結論：3言語とも「静音ルール」「シャワー利用可」「駅は職員に聞く」という意味で一致しており、言語間の齟齬はない。**

---

## 4. 回答言語ロジックの調査

### 4.1 事象の整理

- **事象**：ゲストが**韓国語を選択**した状態で**中国語で質問**すると、回答が**中国語**で返ってきた。
- **期待の可能性**：選択言語（韓国語）で回答が返ることを期待する運用もあり得る。

### 4.2 コード上の流れ（要約）

1. **フロント（ゲストチャット）**
   - `Chat.vue` で `language = computed(() => (route.query.lang as string) || 'en')`
   - 送信時は `sendMessage({ ..., language: language.value })` で **URL の `lang`（選択言語）** を毎回送っている。
   - 韓国語選択なら `lang=ko` → リクエストの `language` は常に `"ko"`。

2. **バックエンド**
   - `chat_service.py`: `request.language` をそのまま `_get_or_create_conversation(..., language=request.language)` と `rag_engine.process_message(..., language=request.language)` に渡している。
   - `engine.py`（RAG）:
     - **コンテキスト**：`_build_context(..., language)` で、**request.language に一致する FAQ 翻訳**だけをコンテキストに載せる（`trans.language == language`）。つまり韓国語選択なら **韓国語の FAQ 文**がコンテキストに入る。
     - **LLM 呼び出し**：`openai_client.generate_response(..., language=language)` に `language` は渡しているが、**プロンプト内で「〇〇語で答えよ」という指示はしていない**。`language` はエラー時のフォールバックメッセージの言語にのみ使われている。

3. **プロンプト内容（engine.py のシステムプロンプト）**
   - 現状は英語のみで、以下のような内容。
   - 「You are a helpful assistant for a guesthouse. Answer guests' questions based on the provided FAQs and facility information. Be friendly, concise (under 200 characters), and helpful. If you cannot answer confidently, suggest contacting staff.」
   - **「選択言語（request.language）で答えよ」「ゲストの選択言語で答えよ」といった指示は一切なし。**

4. **ベクトル検索**
   - `vector_search.py`: `FAQTranslation` を**全言語まとめて**検索（言語フィルタなし）。質問文の埋め込みと最も近い翻訳がヒットする。
   - 中国語で質問すれば、中国語の FAQ 翻訳が高スコアでヒットしうるが、**コンテキストに載せる翻訳は request.language で選ばれる**ため、韓国語選択ならコンテキストは韓国語の FAQ。つまり「質問は中国語・コンテキストの FAQ は韓国語」という組み合わせになり得る。

### 4.3 なぜ中国語で返るか

- プロンプトに**回答言語の指定がない**ため、モデルは主に**質問文の言語**に合わせて返す傾向がある。
- その結果、「選択言語は韓国語（request.language=ko）」でも、**質問が中国語なら中国語で返る**現在の挙動になっている。

### 4.4 Free プランでの挙動（英語で質問した場合）

- **仕様**：Free プランは「1言語（日本語のみ）」とされているが、**チャット API の request.language を決めるのはフロントの `route.query.lang` の有無**。
- **フロント**：`(route.query.lang as string) || 'en'` のため、**URL に `lang` が無ければ `language` は `"en"`** になる。
- **バックエンド**：`request.language` をそのまま使うだけなので、Free でも「英語で質問すると英語で返す」ロジックになる。
  - つまり、**回答言語を決めているのは「選択言語」ではなく「プロンプトの欠如により事実上、質問の言語」**であり、Free でも「日本語のみ」の制約は**表示言語や利用可能 FAQ 言語**には効いていても、**LLM の返答言語を選択言語に縛る実装にはなっていない**。

### 4.5 まとめ（回答言語ロジック）

| 項目 | 内容 |
|------|------|
| 設計意図（コード上） | コンテキストの FAQ は **request.language（選択言語）** で取得している。 |
| 実際の応答言語 | プロンプトに「選択言語で答えよ」が**ない**ため、**質問文の言語**に合わせて返っている。 |
| 韓国語選択＋中国語質問で中国語で返る理由 | 上記の通り、LLM が質問言語に合わせているため。 |
| Free プランで英語質問→英語で返るか | **返りうる**。同じく「回答言語の明示的指定がない」ため、質問が英語なら英語で返す挙動になる。 |

**結論：現状の実装では「選択言語（UI の lang）で回答する」のではなく、「質問文の言語に合わせて回答する」動きになっており、Free プランでも英語で質問すれば英語で返るロジックになっている。**

---

## 5. 今後の修正方針（参考・指示があるまで修正しない）

- **「選択言語で必ず返す」**にしたい場合の候補：
  - システムプロンプト（またはユーザープロンプト）に、**「Always respond in the following language only: [language name/code].」** のように、`request.language` に応じた文言を追加する。
- **Free プランで「日本語のみ」を厳格にしたい場合**：
  - 施設のプランに応じて、バックエンドで `request.language` を上書きする（例: Free なら常に `ja`）か、プロンプトで「回答は日本語のみ」と指定する必要がある。

以上、評価と回答言語ロジックの調査報告とする。**指示があるまでコードの修正は行っていない。**
