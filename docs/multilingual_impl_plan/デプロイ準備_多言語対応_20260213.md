# デプロイ準備（多言語対応）2026-02-13

**対象**: Phase 4 多言語対応（zh-TW, fr, ko）実装のデプロイ準備。  
**方針**: 環境確認・ブランチ戦略・チェックリストを整備。**指示があるまでデプロイは実施しない。**

---

## 1. Docker 環境確認結果

### 1.1 構成

| 項目 | 内容 |
|------|------|
| コンポーズファイル | `docker-compose.yml`（ルート） |
| サービス | postgres（pgvector/pgvector:pg15）, redis（redis:7.2-alpine）, backend, frontend |
| バックエンド | `backend/Dockerfile`（Python 3.11-slim, uvicorn） |
| フロントエンド | `frontend/Dockerfile`（Node 18-alpine, npm run dev） |

### 1.2 確認済み項目

- **docker-compose 構文**: `docker compose config` でエラーなし（検証済み）。
- **バックエンド Dockerfile**: 依存関係 `requirements.txt`、ポート 8000、CJK フォント含む。
- **フロントエンド Dockerfile**: `package.json` / `package-lock.json` で npm install、ポート 5173。
- **ボリューム**: postgres_data, redis_data 永続化。backend/frontend は開発時ホストマウント。
- **ヘルスチェック**: postgres（pg_isready）、redis（redis-cli ping）で depends_on の条件に使用。

### 1.3 環境変数（本番・ステージングで要設定）

バックエンドは `backend/.env` または docker-compose の `environment` で以下を設定すること。

- **必須**: `DATABASE_URL`, `REDIS_URL`, `OPENAI_API_KEY`, `SECRET_KEY`, `CORS_ORIGINS`, `FRONTEND_URL`
- **メール（任意）**: `BREVO_API_KEY`, `ADMIN_NOTIFICATION_EMAIL`
- **開発者画面（任意）**: `DEVELOPER_PASSWORD`, `DEVELOPER_SESSION_EXPIRE_HOURS`

フロントエンドはビルド時 `VITE_API_BASE_URL` を本番/ステージングの API オリジンに合わせること。

### 1.4 ローカルでの起動コマンド（参考）

```bash
# ルートで
docker compose up -d
# バックエンド: http://localhost:8000
# フロント: http://localhost:5173
# DB: localhost:5433 (host)
```

---

## 2. ブランチ戦略（要約定義書 v0.3.1 準拠）

| ブランチ | 用途 | デプロイ先 |
|----------|------|------------|
| **main** | 本番用 | Render.com（本番） |
| **develop** | ステージング・統合 | Railway Hobby（ステージング） |
| **feature/*** | 機能開発 | ローカル／PR 先は develop |

### 2.1 デプロイ時の流れ（指示が出た場合）

1. 多言語対応の変更は **develop** にコミット済みであることを確認。
2. **ステージング**: develop をプッシュ → Railway が自動デプロイ（または手動デプロイ）。
3. ステージングでブラウザテスト（言語選択・チャット・プラン別表示など）を実施。
4. **本番**: 問題なければ develop を **main** にマージ → Render.com で本番デプロイ。

### 2.2 本対応のコミット方針

- 多言語実装・フォールバック追加・ドキュメントは **develop** にコミットしてよい。
- 本番反映は **main マージおよびデプロイの指示後** に実施する。

---

## 3. デプロイ前チェックリスト（指示が出た場合に使用）

以下は「デプロイしてよい」指示を受けた後に実施する想定の一覧である。

- [ ] 単体テスト: `backend`: `pytest`（特に `tests/test_faq_presets.py`, `tests/test_facility_available_languages.py`）
- [ ] Docker ローカル: `docker compose up -d` で 4 サービス起動・API/フロント疎通確認
- [ ] 環境変数: ステージング/本番で `OPENAI_API_KEY`, `SECRET_KEY`, `CORS_ORIGINS`, `FRONTEND_URL` 等が正しいこと
- [ ] DB マイグレーション: 本対応では **不要**（既存スキーマで 5 言語対応済み）
- [ ] ステージングデプロイ: develop プッシュ → ステージング環境で言語選択・チャット動作確認
- [ ] 本番デプロイ: develop → main マージ → 本番デプロイ → 簡易動作確認

---

## 4. 補足

- **既存施設**: 既存登録施設の FAQ は変更されない。zh-TW/fr/ko プリセットが適用されるのは**新規登録時**のみ。
- **抜け対応済み**: 韓国語フォールバックメッセージを `backend/app/ai/fallback.py` に追加済み。
- **デプロイ**: 本ドキュメントでは準備のみ完了。**実際のデプロイは指示があるまで行わない。**

以上。
