# 多言語実装 抜け落ち・矛盾点 調査報告（2026-02-13）

**前提**: ローカル環境でのブラウザテスト完了後、実装内容の再調査を実施。  
**対象**: Phase 4 多言語対応（zh-TW, fr, ko 追加）の実装範囲。

---

## 1. 調査結果サマリー

| 種別 | 件数 | 対応推奨 |
|------|------|----------|
| 抜け（実装漏れ） | 1 | あり |
| 矛盾 | 0 | - |
| ドキュメント・コメントの不整合 | 2 | 任意 |
| 既知の仕様（修正不要） | 1 | 報告のみ |

---

## 2. 抜け落ち（要対応）

### 2.1 韓国語（ko）のフォールバックメッセージ未定義

**箇所**: `backend/app/ai/fallback.py`

**内容**:
- `FALLBACK_MESSAGES` に `"en"`, `"ja"`, `"zh-TW"`, `"fr"` のみ定義されている。
- `"ko"` が未定義のため、`get_fallback_message("ko")` は `FALLBACK_MESSAGES["en"]`（英語）を返す。
- OpenAI API 障害時などに、韓国語選択のゲストに英語のフォールバックが表示される。

**推奨対応**:
- `FALLBACK_MESSAGES` に `"ko"` を追加する（存敬語の短文で「一時利用不可・スタッフへ連絡」の趣旨）。

---

## 3. 矛盾点

- **プラン別言語数と available_languages**: `plan_limits.py` の Free/Mini/Small/Standard/Premium と言語リスト、`facility_service.py` の Premium 時の `["ja","en","zh-TW","fr","ko"]` は整合している。
- **新規登録時のFAQ投入**: `auth_service.py` の `filter_faq_presets_by_plan` → `bulk_create_faqs` の流れで、プラン別言語フィルタが正しく適用されている。
- **フロントの言語フィルタ**: `LanguageSelect.vue` は `response.facility.available_languages` で表示言語を絞っており、バックエンドの `available_languages` と矛盾なし。

**結論**: 機能間の矛盾は検出されなかった。

---

## 4. ドキュメント・コメントの不整合（任意対応）

### 4.1 FAQ スキーマ・API の言語表記

- **箇所**: `backend/app/schemas/faq.py` の `FAQTranslationRequest.language` の説明、`backend/app/api/v1/admin/faqs.py` の docstring。
- **内容**: 「言語コード（en/ja/zh-TW/fr）」とあり、**ko** が記載されていない。
- **影響**: ドキュメント上の不足のみ。API は ko を受け付けており、faq_presets も 5 言語対応済み。
- **推奨**: 説明を「en/ja/zh-TW/fr/ko」に更新することを推奨（任意）。

### 4.2 fallback.py の docstring

- **箇所**: `get_fallback_message(language: str = "en")` の Args 説明。
- **内容**: 「言語コード（'en', 'ja', 'zh-TW', 'fr'）」とあり、**'ko'** が記載されていない。
- **推奨**: ko 追加後、docstring にも 'ko' を追記する（任意）。

---

## 5. 既知の仕様（修正不要・報告のみ）

### 5.1 回答言語が「選択言語」ではなく「質問言語」に依存する挙動

- **内容**: ゲストが選択した UI 言語（例: 韓国語）と異なる言語（例: 中国語）で質問すると、回答が質問言語（中国語）で返る。
- **原因**: RAG のプロンプトに「必ず選択言語で答えよ」という指示がなく、LLM が質問文の言語に合わせて返しているため。
- **詳細**: `docs/multilingual_impl_plan/ブラウザテスト回答評価と回答言語ロジック調査_20260213.md` に記載済み。
- **対応**: 仕様として許容するか、「選択言語で返す」ようにプロンプトを変更するかは別途判断。本調査では「既知の仕様」として報告のみ。

### 5.2 Free プランで URL に lang がない場合のデフォルト

- **内容**: ゲストチャットの `language` は `route.query.lang || 'en'` のため、`lang` 未指定時は `"en"` が送られる。
- **影響**: Free プラン施設でも、チャット URL に `?lang=ja` が付いていなければ、リクエスト言語は `en` になり、コンテキストは英語の FAQ が選ばれうる（施設側は available_languages で ja のみ返すため、言語選択画面では日本語のみ表示）。
- **対応**: 現状は「URL に lang を付与する」運用（言語選択から遷移するため通常は付与される）で許容可能。厳密に「Free は常に ja」にしたい場合は、バックエンドでプランに応じた language 上書きを検討。

---

## 6. 確認済みで問題なしの項目

- **faq_presets.py**: 30 FAQ × 5 言語（ja, en, zh-TW, fr, ko）が一貫して定義されている。
- **plan_limits.py**: Free/Mini/Small/Standard/Premium の言語リストと FAQ 数上限が設計通り。
- **filter_faq_presets_by_plan**: プラン別に正しく言語フィルタされ、テストで検証済み。
- **施設公開 API**: `get_facility_public_info(slug, language)` で top_questions が指定言語で返る。Premium 時は `available_languages = ["ja","en","zh-TW","fr","ko"]`。
- **フロント**: `SUPPORTED_LANGUAGES` に ko 含む 9 言語定義。`LanguageSelect.vue` は `available_languages` でフィルタ表示。
- **CSV 一括登録**: `csv_parser.py` の `LANGUAGE_COLUMNS` に zh-TW, fr, ko が含まれる。
- **単体テスト**: `test_faq_presets.py`, `test_facility_available_languages.py` がプラン別言語を期待通り検証している。

---

## 7. 対応優先度の提案

1. **必須**: 韓国語フォールバックメッセージの追加（`fallback.py`）。
2. **任意**: 上記スキーマ・API・fallback の docstring に ko を追記。

以上。
