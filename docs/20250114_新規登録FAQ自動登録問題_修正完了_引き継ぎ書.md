# 20250114 新規登録FAQ自動登録問題 修正完了 引き継ぎ書

**作成日**: 2025年1月14日  
**対象**: 新規登録時のFAQ自動登録問題（料金プラン制限適用 + 非同期化 + フロントエンドポーリング）  
**状態**: ✅ **修正完了、動作確認完了**

---

## 1. 問題の概要

### 1.1 発見された問題

1. **Freeプランの制限違反**
   - 期待: 日本語のみ、20件
   - 実際: 日本語+英語、30件

2. **ステージング環境でのタイムアウトエラー**
   - 新規登録時に30秒のタイムアウトが発生
   - 60件の埋め込みベクトル生成（30FAQ × 2言語）が同期処理で実行されていた

3. **FAQ表示問題**
   - 初期表示時に期待件数が表示されない
   - リロード後に正しい件数が表示される

### 1.2 根本原因

1. **料金プラン制限の未実装**: `auth_service.py`に料金プラン制限が実装されていなかった
2. **同期処理によるタイムアウト**: FAQ自動登録が同期処理で実行されていた
3. **キャッシュ問題**: バックグラウンド処理完了前にキャッシュが保存されていた
4. **ポーリング未実装**: フロントエンドでバックグラウンド処理の完了を待つ仕組みがなかった

---

## 2. 実施した修正

### 2.1 Step 1: 料金プラン制限の定義ファイル作成

**ファイル**: `backend/app/core/plan_limits.py`

**内容**:
- 料金プランごとのFAQ上限数と対応言語を定義
- 初期自動登録件数の定義（全プランで20件）
- `filter_faq_presets_by_plan`関数の実装

**実装内容**:
```python
PLAN_FAQ_LIMITS = {
    "free": {"max_faqs": 20, "languages": ["ja"]},
    "mini": {"max_faqs": 30, "languages": ["ja", "en"]},
    "small": {"max_faqs": 50, "languages": ["ja", "en", "zh-TW"]},
    "standard": {"max_faqs": 100, "languages": ["ja", "en", "zh-TW", "fr"]},
    "premium": {"max_faqs": None, "languages": None}  # 無制限
}

INITIAL_FAQ_COUNTS = {
    "free": 20,
    "mini": 20,
    "small": 20,
    "standard": 20,
    "premium": 20
}
```

**コミット**: `ステップ1: 料金プラン制限の定義ファイル作成`

---

### 2.2 Step 2: FAQ自動投入処理の修正（料金プラン制限適用 + 非同期化）

**ファイル**: 
- `backend/app/services/auth_service.py`
- `backend/app/api/v1/auth.py`

**内容**:
1. `register_facility`を`register_facility_sync`と`register_facility_async_faqs`に分割
2. `register_facility_async_faqs`を`BackgroundTasks`で実行
3. 料金プラン制限を適用したFAQフィルタリング

**実装内容**:
```python
@staticmethod
async def register_facility_async_faqs(
    facility_id: int,
    user_id: int,
    subscription_plan: str
):
    """FAQ自動投入処理（バックグラウンド実行）"""
    from app.database import AsyncSessionLocal
    from app.data.faq_presets import FAQ_PRESETS
    from app.schemas.faq import FAQRequest
    from app.core.plan_limits import filter_faq_presets_by_plan
    from app.core.cache import delete_cache_pattern
    
    async with AsyncSessionLocal() as db:
        try:
            # 料金プランに基づいてFAQプリセットをフィルタ
            filtered_presets = filter_faq_presets_by_plan(
                FAQ_PRESETS,
                subscription_plan
            )
            
            # FAQ一括作成
            await FAQService(db).bulk_create_faqs(facility_id, faq_requests, user_id)
            await db.commit()
            
            # キャッシュを無効化
            await delete_cache_pattern(f"faq:list:*facility_id={facility_id}*")
        except Exception as e:
            logger.error(f"Background FAQ creation failed: {e}", exc_info=True)
```

**コミット**: `ステップ2: FAQ自動投入処理の修正（料金プラン制限適用 + 非同期化）`

---

### 2.3 Step 3: フロントエンドのタイムアウト時間調整

**ファイル**: `frontend/src/api/axios.ts`

**内容**:
- タイムアウトを30秒から10秒に短縮（施設・ユーザー作成のみを考慮）

**コミット**: `ステップ3: フロントエンドのタイムアウト時間延長（暫定対応）`

---

### 2.4 Step 4: フロントエンドポーリング機能の実装

**ファイル**: `frontend/src/views/admin/FaqManagement.vue`

**内容**:
1. `is_initializing`フラグの追加（バックエンド）
2. フロントエンドでのポーリング実装
3. ポーリング中にUIを即座に更新

**実装内容**:
```typescript
// バックグラウンド処理が進行中の場合、または期待値未満の場合はポーリングを開始
if ((isInitializing && total < 20) || (!isInitializing && total < 20)) {
  const pollInterval = 2000 // 2秒ごとにポーリング
  const maxPollTime = 90000 // 最大90秒
  const startTime = Date.now()
  
  const poll = async () => {
    const newResponse = await faqApi.getFaqs()
    const newData = newResponse.faqs
    const newTotal = newResponse.total
    const newIsInitializing = newResponse.is_initializing
    
    // ポーリング中にFAQ数が増えた場合は、即座にUIを更新
    if (newTotal > faqs.value.length) {
      faqs.value = newData
    }
    
    // バックグラウンド処理の完了を優先チェック
    if (!newIsInitializing && newTotal >= expectedCount) {
      faqs.value = newData
      loading.value = false
      return
    }
    
    // タイムアウトチェック
    if (Date.now() - startTime > maxPollTime) {
      faqs.value = newData
      loading.value = false
      return
    }
    
    setTimeout(poll, pollInterval)
  }
  
  setTimeout(poll, pollInterval)
}
```

**コミット**: 
- `feat: 新規登録時のFAQ自動登録を20件に統一 + フロントエンドポーリング実装`
- `fix: ポーリング中にUIを即座に更新（FAQ数増加時にリアルタイム反映）`
- `fix: フロントエンドのポーリング条件を改善（期待値未満の場合は常にポーリング開始）`
- `fix: ポーリングタイムアウトを90秒に延長 + 完了チェックを優先実行（FAQ20件表示問題の解決）`

---

### 2.5 デバッグログの追加

**ファイル**: `frontend/src/views/admin/FaqManagement.vue`

**内容**:
- `fetchFaqs`の開始時にデバッグログを追加
- `onMounted`の開始時にデバッグログを追加
- エラーハンドリングを強化

**コミット**: `fix: デバッグログ追加とエラーハンドリング強化（FAQ表示問題の原因特定用）`

---

## 3. 修正の効果

### 3.1 解決した問題

1. ✅ **Freeプランの制限違反**: 日本語のみ、20件に修正
2. ✅ **タイムアウトエラー**: 非同期化により解決
3. ✅ **FAQ表示問題**: ポーリング機能により解決
4. ✅ **20件表示**: ポーリングタイムアウトを90秒に延長し、完了チェックを優先実行することで解決

### 3.2 動作確認結果

**ステージング環境でのテスト結果**:
- ✅ 新規登録後、FAQ一覧ページで20件のFAQが表示される
- ✅ ポーリング中にFAQ数が増加する様子がUIに反映される
- ✅ バックグラウンド処理完了後、20件が表示される
- ✅ コンソールログで処理の進行状況が確認できる

**コンソールログの確認**:
```
✅ FAQ取得成功: {count: 1, total: 1, is_initializing: true, ...}
🔄 バックグラウンド処理進行中または期待値未満: ポーリングを開始
🔄 ポーリング結果: {count: 3, total: 3, ...}
📊 FAQ数が増加: UIを更新 {previous: 1, current: 3}
...
📊 FAQ数が増加: UIを更新 {previous: 18, current: 20}
✅ バックグラウンド処理完了: 最新のデータを表示 20
```

---

## 4. 技術的な詳細

### 4.1 バックエンドの変更

**主要な変更ファイル**:
1. `backend/app/core/plan_limits.py` - 新規作成
2. `backend/app/services/auth_service.py` - FAQ自動登録の非同期化
3. `backend/app/api/v1/auth.py` - BackgroundTasksの追加
4. `backend/app/api/v1/admin/faqs.py` - `is_initializing`フラグの追加
5. `backend/app/schemas/faq.py` - `is_initializing`フィールドの追加

**主要な変更内容**:
- 料金プラン制限の実装
- FAQ自動登録の非同期化（BackgroundTasks）
- キャッシュ無効化の実装
- `is_initializing`フラグの追加

### 4.2 フロントエンドの変更

**主要な変更ファイル**:
1. `frontend/src/views/admin/FaqManagement.vue` - ポーリング機能の実装
2. `frontend/src/api/faq.ts` - `is_initializing`フィールドの追加
3. `frontend/src/api/axios.ts` - タイムアウトの調整
4. `frontend/src/views/admin/Register.vue` - ドロップダウンリストの順序修正
5. `frontend/src/components/admin/FaqList.vue` - `getFaqsByCategory`の修正

**主要な変更内容**:
- ポーリング機能の実装
- デバッグログの追加
- エラーハンドリングの強化
- UI更新の即時反映

---

## 5. 今後の改善点

### 5.1 短期的な改善

1. **デバッグログの削除**: 本番環境では不要なデバッグログを削除
2. **エラーハンドリングの改善**: より詳細なエラーメッセージの表示
3. **ユーザーへの通知**: バックグラウンド処理中の通知メッセージ

### 5.2 長期的な改善

1. **バックグラウンド処理の最適化**: 埋め込みベクトル生成の並列化
2. **WebSocketの導入**: ポーリングの代わりにWebSocketを使用
3. **進捗表示**: バックグラウンド処理の進捗を表示

---

## 6. 関連ドキュメント

### 6.1 調査分析レポート

1. `docs/20250113_料金プランFAQ自動登録_調査分析レポート.md`
2. `docs/20250113_ステージング環境タイムアウトエラー_完全調査分析報告書.md`
3. `docs/20250113_新規登録FAQ問題_統合修正案_ステップ計画.md`
4. `docs/20250113_FAQ10件問題_完全調査分析_修正案.md`

### 6.2 実装完了レポート

1. `docs/20250113_ステップ1_料金プラン制限定義ファイル作成_完了報告.md`
2. `docs/20250113_ステップ2_FAQ自動投入処理修正_完了報告.md`
3. `docs/20250113_ステップ3_フロントエンドタイムアウト延長_完了報告.md`

---

## 7. コミット履歴

### 7.1 主要なコミット

1. `ステップ1: 料金プラン制限の定義ファイル作成`
2. `ステップ2: FAQ自動投入処理の修正（料金プラン制限適用 + 非同期化）`
3. `ステップ3: フロントエンドのタイムアウト時間延長（暫定対応）`
4. `feat: 新規登録時のFAQ自動登録を20件に統一 + フロントエンドポーリング実装`
5. `fix: ポーリング中にUIを即座に更新（FAQ数増加時にリアルタイム反映）`
6. `fix: フロントエンドのポーリング条件を改善（期待値未満の場合は常にポーリング開始）`
7. `fix: デバッグログ追加とエラーハンドリング強化（FAQ表示問題の原因特定用）`
8. `fix: ポーリングタイムアウトを90秒に延長 + 完了チェックを優先実行（FAQ20件表示問題の解決）`

### 7.2 最新のコミット

**コミットハッシュ**: `4ef3791`  
**コミットメッセージ**: `fix: ポーリングタイムアウトを90秒に延長 + 完了チェックを優先実行（FAQ20件表示問題の解決）`

---

## 8. 動作確認

### 8.1 確認項目

- ✅ Freeプラン: 日本語のみ、20件表示
- ✅ Miniプラン: 日本語+英語、20件表示
- ✅ Smallプラン: 日本語+英語+中国語、20件表示
- ✅ Standardプラン: 日本語+英語+中国語+フランス語、20件表示
- ✅ Premiumプラン: 全言語、20件表示

### 8.2 テスト環境

- **環境**: ステージング環境（Render.com）
- **ブラウザ**: Google Chrome
- **テスト日**: 2025年1月14日

---

## 9. まとめ

### 9.1 実施内容

1. 料金プラン制限の実装
2. FAQ自動登録の非同期化
3. フロントエンドポーリング機能の実装
4. デバッグログの追加
5. エラーハンドリングの強化

### 9.2 成果

- ✅ 新規登録時のFAQ自動登録が正常に動作する
- ✅ 料金プラン制限が正しく適用される
- ✅ タイムアウトエラーが発生しない
- ✅ 20件のFAQが正しく表示される

### 9.3 状態

**状態**: ✅ **修正完了、動作確認完了**  
**次のステップ**: 本番環境へのデプロイ準備

---

**作成者**: Auto (AI Assistant)  
**最終更新日**: 2025年1月14日

