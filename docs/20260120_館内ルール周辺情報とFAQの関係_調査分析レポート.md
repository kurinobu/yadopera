# 館内ルール・周辺情報とFAQの関係 調査分析レポート

**作成日時**: 2026年1月20日  
**調査者**: AI Assistant  
**目的**: 管理画面の施設設定ページの「館内ルール・周辺情報」と登録したFAQの関係を調査分析し、回答の優先順位や競合を評価する

---

## 1. 調査概要

### 1.1 調査対象

- **館内ルール（house_rules）**: 施設設定ページで登録可能（最大1000文字）
- **周辺情報（local_info）**: 施設設定ページで登録可能（最大1000文字）
- **FAQ**: FAQ管理ページで登録可能（質問・回答・カテゴリ・優先度）

### 1.2 調査範囲

- プロンプト生成ロジック（`backend/app/ai/prompts.py`, `backend/app/ai/engine.py`）
- ベクトル検索ロジック（`backend/app/ai/vector_search.py`）
- FAQ優先度の使用状況（`backend/app/models/faq.py`, `backend/app/services/faq_service.py`）
- 信頼度スコア計算（`backend/app/ai/confidence.py`）

---

## 2. 調査結果

### 2.1 データ保存場所

#### 館内ルール・周辺情報

**保存場所**: `facilities`テーブル
- `house_rules`: `Text`型（最大1000文字）
- `local_info`: `Text`型（最大1000文字）

**更新方法**: 施設設定ページ（`/admin/facility/settings`）から更新可能

**コード参照**:
```python
# backend/app/models/facility.py
house_rules = Column(Text)
local_info = Column(Text)
```

#### FAQ

**保存場所**: `faqs`テーブル（インテントベース構造）
- `faqs`: FAQ本体（カテゴリ、インテントキー、優先度など）
- `faq_translations`: 言語ごとの質問・回答（埋め込みベクトル含む）

**更新方法**: FAQ管理ページ（`/admin/faqs`）から登録・編集・削除可能

**コード参照**:
```python
# backend/app/models/faq.py
class FAQ(Base):
    priority = Column(Integer, default=1)  # 1-5
    category = Column(String(50), nullable=False)
    intent_key = Column(String(100), nullable=False)
```

---

### 2.2 プロンプト生成での使用

#### プロンプト構造

AI回答生成時のプロンプトは以下の順序で構築されます：

```
1. システムプロンプト（約100トークン）
   - AIの役割定義
   - 回答方針（簡潔、親切、200文字以内など）

2. 施設基本情報（約150トークン）
   - Name: {facility.name}
   - Check-in: {facility.check_in_time}
   - Check-out: {facility.check_out_time}
   - WiFi SSID: {facility.wifi_ssid}
   - House Rules: {(facility.house_rules or "")[:500]}  ← 館内ルール（最大500文字）
   - Local Info: {(facility.local_info or "")[:500]}    ← 周辺情報（最大500文字）

3. 関連FAQ Top 3（約300トークン）
   - ベクトル検索で取得されたFAQ（類似度順）
   - Q: {faq.question}\nA: {faq.answer} の形式

4. ゲストの質問（約50トークン）
   - Guest question: {question}
```

**コード参照**:
```234:241:backend/app/ai/engine.py
        # 施設基本情報（約150トークン）
        facility_info = f"""
Facility: {facility.name}
Check-in: {facility.check_in_time}
Check-out: {facility.check_out_time}
WiFi SSID: {facility.wifi_ssid or "Not available"}
House Rules: {(facility.house_rules or "")[:500]}
Local Info: {(facility.local_info or "")[:500]}
"""
```

**プロンプトの順序**:
```255:267:backend/app/ai/engine.py
        # コンテキスト結合
        context = f"""{system_prompt}

## Facility Information:
{facility_info}

## Relevant FAQs:
{faq_context}

## Guest's Question:
{guest_question}

## Your Response:
"""
```

---

### 2.3 FAQ検索の優先順位

#### ベクトル検索（pgvector）

**検索方法**: コサイン類似度によるベクトル検索

**検索ロジック**:
1. ゲストの質問を埋め込みベクトルに変換
2. `faq_translations`テーブルの`embedding`カラムとコサイン類似度を計算
3. 類似度が0.7以上のFAQを取得
4. 同じ`faq_id`の場合は、最も高い類似度のものを使用
5. 類似度の降順でソートし、Top 3を取得

**コード参照**:
```20:97:backend/app/ai/vector_search.py
async def search_similar_faqs(
    facility_id: int,
    embedding: List[float],
    top_k: int = 3,
    threshold: float = 0.7,
    db: AsyncSession = None
) -> List[FAQ]:
    """
    pgvectorで類似FAQ検索（エラーハンドリング付き、インテントベース構造対応）
    コサイン類似度を使用
    """
    # ... ベクトル検索の実装
    # コサイン類似度でソート
    # 閾値以上の類似度のFAQのみ返す
```

**重要な点**:
- **FAQの優先度（priority）は使用されていない**
- ベクトル検索はコサイン類似度のみでソートされる
- 質問との類似度が高いFAQが優先される

#### FAQ優先度の使用状況

**使用箇所**:
1. **FAQリスト取得時**: `faq_service.py`で優先度順にソート
2. **よくある質問TOP3取得時**: `facility_service.py`で優先度順にソート

**使用されない箇所**:
- **AI回答生成時のベクトル検索**: 優先度は使用されない

**コード参照**:
```110:112:backend/app/services/facility_service.py
        ).order_by(
            FAQ.priority.desc(),
            FAQ.created_at.desc()
        ).limit(3)
```

---

### 2.4 回答の優先順位

#### プロンプト内での順序

1. **施設基本情報（館内ルール・周辺情報含む）**: プロンプトの前半に配置
2. **関連FAQ Top 3**: プロンプトの中盤に配置
3. **ゲストの質問**: プロンプトの最後に配置

#### AIの回答生成

**重要な点**:
- **明確な優先順位は定義されていない**
- AIはプロンプト内のすべての情報を統合して回答を生成する
- プロンプトの順序上、施設基本情報が先に来るが、AIは両方の情報を参照する

**システムプロンプト**:
```244:249:backend/app/ai/engine.py
        # システムプロンプト（約100トークン）
        system_prompt = """
You are a helpful assistant for a guesthouse.
Answer guests' questions based on the provided FAQs and facility information.
Be friendly, concise (under 200 characters), and helpful.
If you cannot answer confidently, suggest contacting staff.
"""
```

**指示内容**:
- "Answer guests' questions based on the provided FAQs and facility information."
- FAQと施設情報の両方を参照するように指示されている

---

### 2.5 競合の可能性

#### 競合シナリオ

**シナリオ1: 同じ内容が館内ルールとFAQの両方に存在する場合**

例:
- **館内ルール**: "禁煙、門限23:00、静粛時間22:00-8:00"
- **FAQ**: "Q: 門限は何時ですか？ A: 門限は23:00です"

**影響**:
- プロンプトに両方の情報が含まれる
- AIは両方の情報を参照して回答を生成する
- FAQがベクトル検索で取得された場合、質問との類似度が高いため、FAQの内容が優先される可能性が高い
- ただし、明確な優先順位は定義されていないため、AIの判断に依存する

**シナリオ2: 館内ルールに詳細情報、FAQに簡潔な回答がある場合**

例:
- **館内ルール**: "禁煙、門限23:00、静粛時間22:00-8:00、ゴミ出しは毎週火曜日・金曜日"
- **FAQ**: "Q: 門限は何時ですか？ A: 23:00です"

**影響**:
- プロンプトに両方の情報が含まれる
- AIは両方の情報を統合して回答を生成する可能性がある
- FAQがベクトル検索で取得された場合、質問との類似度が高いため、FAQの内容が優先される可能性が高い

**シナリオ3: 館内ルールに情報があるが、FAQに該当するものがない場合**

例:
- **館内ルール**: "禁煙、門限23:00、静粛時間22:00-8:00"
- **FAQ**: 該当なし（ベクトル検索で類似度0.7以上のFAQが見つからない）

**影響**:
- プロンプトには施設基本情報のみが含まれる
- AIは館内ルールの情報を参照して回答を生成する

---

### 2.6 信頼度スコアへの影響

#### 信頼度スコア計算

**ベーススコア**: 0.7

**ボーナス**:
- FAQ類似度ボーナス: 類似度0.8以上で+0.3、0.7以上で+0.15
- 質問具体性スコア: 固有名詞・数値含む場合+0.1
- 過去同一質問解決率: 80%以上で+0.15
- 施設カスタムFAQヒット: +0.2

**ペナルティ**:
- 回答長ペナルティ: 20文字未満で-0.2
- 不確実性ワード検出: -0.15

**重要な点**:
- **館内ルール・周辺情報は信頼度スコアに直接影響しない**
- 信頼度スコアはFAQの類似度や回答の品質に基づいて計算される
- 館内ルール・周辺情報はプロンプトに含まれるが、信頼度スコア計算には使用されない

**コード参照**:
```38:49:backend/app/ai/confidence.py
    base_confidence = Decimal("0.7")
    
    # FAQ類似度ボーナス（v0.2継続）
    if similar_faqs:
        # 最高類似度を取得（similar_faqsはsearch_similar_faqsから返されるが、
        # similarity属性は直接含まれていないため、暫定的に0.7を仮定）
        # TODO: search_similar_faqsでsimilarityを返すように修正
        max_similarity = Decimal("0.7")  # 暫定値
        if max_similarity >= Decimal("0.8"):
            base_confidence += Decimal("0.3")  # +0.3ボーナス
        elif max_similarity >= Decimal("0.7"):
            base_confidence += Decimal("0.15")  # +0.15ボーナス
```

---

## 3. 評価と分析

### 3.1 回答の優先順位

#### 現状の優先順位

1. **ベクトル検索で取得されたFAQ（類似度0.7以上）**
   - 質問との類似度が高いため、質問との関連性が高い
   - プロンプトの中盤に配置されるが、質問との関連性が高いため、AIが優先的に参照する可能性が高い

2. **館内ルール・周辺情報**
   - 常にプロンプトに含まれる
   - プロンプトの前半に配置されるが、質問との関連性は考慮されない
   - FAQが取得されない場合や、FAQの内容が不十分な場合に参照される

#### 問題点

1. **明確な優先順位が定義されていない**
   - プロンプトの順序上、施設基本情報が先に来るが、AIの判断に依存する
   - FAQがベクトル検索で取得された場合、質問との類似度が高いため、FAQの内容が優先される可能性が高いが、明確ではない

2. **FAQの優先度が使用されていない**
   - FAQには`priority`フィールド（1-5）があるが、AI回答生成時のベクトル検索では使用されていない
   - ベクトル検索はコサイン類似度のみでソートされるため、優先度の高いFAQが優先されない

---

### 3.2 競合の評価

#### 競合の可能性

**高**: 館内ルール・周辺情報とFAQが同じ内容を含む場合、AIがどちらを優先するかは明確ではない

**中**: 館内ルール・周辺情報に詳細情報、FAQに簡潔な回答がある場合、AIが両方を統合して回答を生成する可能性がある

**低**: 館内ルール・周辺情報に情報があるが、FAQに該当するものがない場合、館内ルール・周辺情報が参照される

#### 競合の影響

1. **回答の一貫性**
   - 同じ質問に対して、館内ルール・周辺情報とFAQの内容が異なる場合、AIがどちらを優先するかは明確ではない
   - 回答の一貫性が損なわれる可能性がある

2. **回答の精度**
   - FAQがベクトル検索で取得された場合、質問との類似度が高いため、FAQの内容が優先される可能性が高い
   - ただし、館内ルール・周辺情報の内容がより詳細な場合、AIが両方を統合して回答を生成する可能性がある

3. **メンテナンス性**
   - 館内ルール・周辺情報とFAQの両方に同じ内容を登録する必要がある場合、メンテナンスコストが増加する
   - どちらを更新すべきかが明確ではない

---

### 3.3 改善提案

#### 提案1: FAQ優先度をベクトル検索に反映

**現状**: ベクトル検索はコサイン類似度のみでソートされる

**改善案**: ベクトル検索の結果を優先度で再ソートする

**実装方法**:
```python
# backend/app/ai/vector_search.py
# ベクトル検索の結果を取得後、優先度で再ソート
similar_faqs = sorted(
    similar_faqs,
    key=lambda x: (x.similarity, x.priority),
    reverse=True
)[:top_k]
```

**メリット**:
- 優先度の高いFAQが優先される
- 管理者がFAQの重要度を制御できる

**デメリット**:
- 類似度が低いFAQが優先される可能性がある
- 質問との関連性が損なわれる可能性がある

#### 提案2: プロンプト内での優先順位を明確化

**現状**: プロンプトの順序上、施設基本情報が先に来るが、明確な優先順位は定義されていない

**改善案**: システムプロンプトに優先順位を明示する

**実装方法**:
```python
# backend/app/ai/engine.py
system_prompt = """
You are a helpful assistant for a guesthouse.
Answer guests' questions based on the provided FAQs and facility information.

## Priority order:
1. Relevant FAQs (from vector search) - highest priority
2. Facility Information (house rules, local info) - secondary priority

Be friendly, concise (under 200 characters), and helpful.
If you cannot answer confidently, suggest contacting staff.
"""
```

**メリット**:
- 明確な優先順位が定義される
- 回答の一貫性が向上する

**デメリット**:
- AIの判断を制限する可能性がある
- 柔軟性が損なわれる可能性がある

#### 提案3: 館内ルール・周辺情報とFAQの重複チェック

**現状**: 館内ルール・周辺情報とFAQの重複をチェックする機能がない

**改善案**: FAQ登録時に、館内ルール・周辺情報との重複をチェックし、警告を表示する

**実装方法**:
```python
# backend/app/services/faq_service.py
async def check_duplication_with_facility_info(
    facility_id: int,
    question: str,
    answer: str,
    db: AsyncSession
) -> List[str]:
    """
    館内ルール・周辺情報との重複をチェック
    """
    facility = await get_facility(facility_id, db)
    warnings = []
    
    # 館内ルールとの重複チェック
    if facility.house_rules and answer in facility.house_rules:
        warnings.append("回答内容が館内ルールと重複しています")
    
    # 周辺情報との重複チェック
    if facility.local_info and answer in facility.local_info:
        warnings.append("回答内容が周辺情報と重複しています")
    
    return warnings
```

**メリット**:
- 重複を事前に検出できる
- メンテナンスコストを削減できる

**デメリット**:
- 実装コストがかかる
- 完全な重複検出は困難

---

## 4. 結論

### 4.1 現状の関係

1. **館内ルール・周辺情報とFAQは同じプロンプトに含まれる**
   - プロンプトの順序上、施設基本情報が先に来るが、明確な優先順位は定義されていない
   - AIは両方の情報を統合して回答を生成する

2. **FAQはベクトル検索で取得される**
   - コサイン類似度によるベクトル検索で、質問との類似度が高いFAQが優先される
   - FAQの優先度（priority）は使用されていない

3. **競合の可能性がある**
   - 館内ルール・周辺情報とFAQが同じ内容を含む場合、AIがどちらを優先するかは明確ではない
   - 回答の一貫性が損なわれる可能性がある

### 4.2 推奨事項

1. **FAQ優先度をベクトル検索に反映する**
   - ベクトル検索の結果を優先度で再ソートする
   - 管理者がFAQの重要度を制御できるようにする

2. **プロンプト内での優先順位を明確化する**
   - システムプロンプトに優先順位を明示する
   - 回答の一貫性を向上させる

3. **館内ルール・周辺情報とFAQの重複チェック機能を追加する**
   - FAQ登録時に、館内ルール・周辺情報との重複をチェックし、警告を表示する
   - メンテナンスコストを削減する

### 4.3 今後の検討事項

1. **館内ルール・周辺情報の役割の明確化**
   - 館内ルール・周辺情報は補足情報として使用するのか、主要な情報源として使用するのかを明確にする

2. **FAQと館内ルール・周辺情報の使い分け**
   - どのような情報をFAQに登録し、どのような情報を館内ルール・周辺情報に登録するのかを明確にする

3. **回答の一貫性の向上**
   - 同じ質問に対して、常に同じ回答が返されるようにする
   - 回答の品質を向上させる

---

## 5. 参照文書

- `backend/app/ai/prompts.py`: プロンプト生成ロジック
- `backend/app/ai/engine.py`: AIエンジン実装
- `backend/app/ai/vector_search.py`: ベクトル検索実装
- `backend/app/ai/confidence.py`: 信頼度スコア計算
- `backend/app/models/facility.py`: 施設モデル
- `backend/app/models/faq.py`: FAQモデル
- `backend/app/services/faq_service.py`: FAQサービス
- `docs/Architecture/やどぺら_v0.3_アーキテクチャ設計書.md`: アーキテクチャ設計書

---

**調査完了日時**: 2026年1月20日  
**次回検討事項**: FAQ優先度をベクトル検索に反映する実装、プロンプト内での優先順位の明確化

