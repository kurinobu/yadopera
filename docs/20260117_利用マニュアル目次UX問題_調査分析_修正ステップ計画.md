# 利用マニュアルの目次UX問題 調査分析・修正ステップ計画

**作成日時**: 2026年01月17日  
**対象課題**: 残存課題「5. 利用マニュアルの目次UX問題」  
**優先度**: 中（UX改善のため重要）  
**所要時間**: 約2-3時間（0.5日）

---

## 1. 問題の詳細

### 1.1 問題点

**現在の動作**:
- 目次の章タイトルをタップすると、折りたたみ/展開とリンク先へのジャンプが同時に実行される
- 折りたたみ/展開したいだけなのに、リンク先にジャンプしてしまう
- 開いている詳細を見ようと思ってタップしても、リンク先にジャンプして見ることができない

**ユーザー体験への影響**:
- ユーザー体験を著しく下げている
- 目次の操作性が悪く、使いにくい

### 1.2 影響範囲

**影響を受けるファイル**:
- `frontend/src/components/admin/ManualToc.vue`（目次コンポーネント）

**影響を受けないファイル**:
- `frontend/src/views/admin/Manual.vue`（親コンポーネント、影響なし）
- `frontend/src/components/admin/ManualContent.vue`（本文コンポーネント、影響なし）

**理由**:
- `ManualToc.vue`は独立したコンポーネントで、内部のクリックイベント処理のみを修正する
- `ManualContent.vue`は`section-change`イベントをemitしているが、これはスクロール監視によるもので、目次のクリックとは独立している
- `Manual.vue`は`handleSectionChange`で`activeSection`を更新しているが、これは`ManualContent`からのイベントを受信するだけ

---

## 2. 現在の実装状況

### 2.1 コードベースの現状

**`ManualToc.vue`の実装**（96-102行目）:
```typescript
// 章クリック時の処理
const handleSectionClick = (sectionId: string) => {
  // 折りたたみ/展開をトグル
  expandedSections[sectionId] = !expandedSections[sectionId]

  // スクロール処理（親コンポーネントに通知）
  scrollToSection(sectionId)
}
```

**問題点**:
- 章タイトル全体が`<button>`要素で、クリックすると折りたたみ/展開とスクロールの両方が実行される
- 折りたたみ/展開アイコン（SVG）は章タイトルの右側に表示されているが、クリック領域は章タイトル全体に及んでいる

**テンプレート構造**（6-32行目）:
```vue
<button
  :class="[
    'manual-toc-item w-full text-left',
    activeSection === section.id ? 'active' : ''
  ]"
  @click="handleSectionClick(section.id)"
>
  <div class="flex items-center justify-between">
    <span class="font-medium">{{ section.title }}</span>
    <svg ... ></svg>
  </div>
</button>
```

---

## 3. 修正方針

### 3.1 修正アプローチ

**推奨方式: アイコンボタンとテキストを分離**

1. **アイコンボタン**: 折りたたみ/展開のみを実行
   - クリックイベント: `@click.stop="toggleSection(sectionId)"`
   - `event.stopPropagation()`で親要素へのイベント伝播を防止

2. **章タイトルテキスト**: リンク先へのジャンプのみを実行
   - クリックイベント: `@click="scrollToSection(sectionId)"`
   - 折りたたみ/展開は実行しない

### 3.2 UX改善案

**視覚的な改善**:
- アイコンボタンにホバー時の視覚的フィードバックを追加
- アイコンボタンとテキストの間隔を適切に設定
- アイコンボタンのクリック領域を明確にする（padding追加）

**アクセシビリティ**:
- アイコンボタンに`aria-label`を追加（「折りたたみ/展開」）
- キーボード操作対応（Tabキーでフォーカス移動、Enterキーで実行）

---

## 4. 修正ステップ計画

### ステップ1: バックアップ作成（5分）

```bash
# ManualToc.vueのバックアップを作成
cp frontend/src/components/admin/ManualToc.vue frontend/src/components/admin/ManualToc.vue.bak_$(date +%Y%m%d_%H%M%S)
```

### ステップ2: 関数の分離（15分）

**修正内容**:
- `handleSectionClick`関数を2つに分離:
  - `toggleSection(sectionId)`: 折りたたみ/展開のみ
  - `scrollToSection(sectionId)`: スクロールのみ（既存の`scrollToSection`関数を使用）

**修正後のコード**:
```typescript
// 章の折りたたみ/展開のみ（スクロールなし）
const toggleSection = (sectionId: string) => {
  expandedSections[sectionId] = !expandedSections[sectionId]
}

// 章タイトルクリック時の処理（スクロールのみ）
const handleSectionClick = (sectionId: string) => {
  scrollToSection(sectionId)
}
```

### ステップ3: テンプレートの修正（30分）

**修正内容**:
- 章タイトルボタンの構造を変更:
  - アイコンボタンを独立した`<button>`要素に分離
  - アイコンボタンに`@click.stop="toggleSection(section.id)"`を追加
  - 章タイトルテキストに`@click="handleSectionClick(section.id)"`を追加

**修正後のテンプレート**:
```vue
<div class="flex items-center justify-between">
  <!-- 章タイトルテキスト（クリックでスクロール） -->
  <button
    :class="[
      'manual-toc-item-title flex-1 text-left',
      activeSection === section.id ? 'active' : ''
    ]"
    @click="handleSectionClick(section.id)"
  >
    <span class="font-medium">{{ section.title }}</span>
  </button>
  
  <!-- アイコンボタン（クリックで折りたたみ/展開） -->
  <button
    class="manual-toc-toggle p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
    @click.stop="toggleSection(section.id)"
    :aria-label="expandedSections[section.id] ? '折りたたむ' : '展開する'"
    aria-expanded="expandedSections[section.id]"
  >
    <svg
      :class="[
        'w-4 h-4 transition-transform',
        expandedSections[section.id] ? 'rotate-90' : ''
      ]"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M9 5l7 7-7 7"
      />
    </svg>
  </button>
</div>
```

### ステップ4: スタイリング調整（30分）

**修正内容**:
- アイコンボタンのスタイル調整
- 章タイトルテキストのスタイル調整
- ホバー時の視覚的フィードバック追加

**追加するスタイル**:
```css
.manual-toc-item-title {
  @apply px-4 py-2 rounded-lg transition-colors;
  @apply text-gray-700 dark:text-gray-300;
  @apply hover:bg-gray-100 dark:hover:bg-gray-700;
  @apply cursor-pointer;
}

.manual-toc-item-title.active {
  @apply bg-blue-100 dark:bg-blue-900/30;
  @apply text-blue-700 dark:text-blue-300;
  @apply font-semibold;
}

.manual-toc-toggle {
  @apply ml-2 flex-shrink-0;
  @apply text-gray-500 dark:text-gray-400;
  @apply hover:text-gray-700 dark:hover:text-gray-300;
}
```

### ステップ5: 既存の`handleSectionClick`関数の削除（5分）

**修正内容**:
- 既存の`handleSectionClick`関数を削除し、新しい`toggleSection`関数と`scrollToSection`関数に置き換える

### ステップ6: 構文チェック（10分）

```bash
cd frontend
npm run type-check  # または vue-tsc --noEmit
npm run lint
```

### ステップ7: ブラウザテスト（30分）

**テスト項目**:
1. **折りたたみ/展開の動作確認**:
   - アイコンボタンをクリックして、折りたたみ/展開が正しく動作することを確認
   - スクロールが発生しないことを確認

2. **リンクジャンプの動作確認**:
   - 章タイトルテキストをクリックして、該当章にスクロールすることを確認
   - 折りたたみ/展開が実行されないことを確認

3. **モバイルでの動作確認**:
   - モバイル表示で、アイコンボタンとテキストが正しく表示されることを確認
   - タッチ操作で正しく動作することを確認

4. **アクセシビリティ確認**:
   - キーボード操作（Tabキー、Enterキー）で正しく動作することを確認
   - スクリーンリーダーで正しく読み上げられることを確認

5. **ダークモード確認**:
   - ダークモードで正しく表示されることを確認

### ステップ8: コミット・プッシュ（5分）

```bash
git add frontend/src/components/admin/ManualToc.vue
git commit -m "fix: 利用マニュアルの目次UX改善（折りたたみ/展開とリンクジャンプを分離）"
git push origin develop
```

---

## 5. 他の機能やUIへの影響調査

### 5.1 影響を受ける可能性のある機能

**調査結果**: **影響なし**

**理由**:
1. **`ManualContent.vue`への影響**: なし
   - `ManualContent.vue`は`section-change`イベントをemitしているが、これは`IntersectionObserver`によるスクロール監視によるもの
   - 目次のクリックイベントとは独立している

2. **`Manual.vue`への影響**: なし
   - `Manual.vue`は`handleSectionChange`で`activeSection`を更新しているが、これは`ManualContent`からのイベントを受信するだけ
   - 目次のクリックイベントとは独立している

3. **他のコンポーネントへの影響**: なし
   - `ManualToc.vue`は独立したコンポーネントで、他のコンポーネントから直接参照されていない
   - `Manual.vue`からのみ使用されている

### 5.2 競合・干渉の可能性

**調査結果**: **競合・干渉なし**

**理由**:
1. **イベントハンドリングの独立性**:
   - 折りたたみ/展開とスクロールの処理を分離することで、それぞれが独立して動作する
   - `event.stopPropagation()`でイベント伝播を制御しているため、親要素への影響がない

2. **状態管理の独立性**:
   - `expandedSections`は`ManualToc.vue`内で管理されており、他のコンポーネントに影響しない
   - `activeSection`は`Manual.vue`で管理されており、`ManualContent`からのイベントで更新される

3. **スタイリングの独立性**:
   - スタイルは`scoped`で定義されているため、他のコンポーネントに影響しない

---

## 6. 大原則の遵守確認

### 6.1 大原則との整合性

1. **根本解決 > 暫定解決**: ✅
   - 問題の根本原因（折りたたみ/展開とスクロールが同時実行される）を解決
   - 一時的な回避策ではなく、根本的な修正を実施

2. **シンプル構造 > 複雑構造**: ✅
   - 関数を2つに分離するだけで、シンプルな構造を維持
   - 過度に複雑な実装を避けている

3. **統一・同一化 > 特殊独自**: ✅
   - 既存のパターン（`scrollToSection`関数）を活用
   - 新しいパターン（`toggleSection`関数）を追加するが、既存の構造に合わせている

4. **具体的 > 一般**: ✅
   - 具体的な実装方法を明確に記載
   - コード例を提供している

5. **拙速 < 安全確実**: ✅
   - テストを省略せず、十分な検証を行う
   - ブラウザテスト、アクセシビリティテストを実施

6. **Docker環境必須**: ✅
   - すべての修正・テストはDocker環境で実行する

---

## 7. 重大指示違反の確認

### 7.1 指示違反の可能性

**調査結果**: **指示違反なし**

**理由**:
1. **「指示があるまで修正しない」**: ✅
   - 修正ステップ計画のみを提示
   - 実際の修正は実施していない

2. **「調査分析を完全に行う」**: ✅
   - コードベースの完全調査を実施
   - 他の機能やUIへの影響を事前調査

3. **「修正ステップ計画を提案」**: ✅
   - 詳細な修正ステップ計画を提示
   - 各ステップの所要時間を記載

---

## 8. まとめ

### 8.1 修正内容の要約

**修正方針**:
- 章タイトルのアイコンボタンとテキストを分離
- アイコンボタン: 折りたたみ/展開のみ
- 章タイトルテキスト: リンク先へのジャンプのみ

**修正ファイル**:
- `frontend/src/components/admin/ManualToc.vue`

**所要時間**: 約2-3時間（0.5日）

### 8.2 期待される効果

1. **UX改善**:
   - 折りたたみ/展開とリンクジャンプが独立して動作する
   - ユーザーが意図した操作が正しく実行される

2. **操作性の向上**:
   - アイコンボタンとテキストの役割が明確になる
   - 視覚的なフィードバックが改善される

3. **アクセシビリティの向上**:
   - キーボード操作対応
   - スクリーンリーダー対応

---

**Document Version**: v1.0  
**Author**: Auto (AI Assistant)  
**Last Updated**: 2026年01月17日  
**Status**: ✅ **調査分析完了・修正ステップ計画提示完了（修正は指示があるまで実施しない）**

