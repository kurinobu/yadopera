# 開発者管理ページ ステージング環境テスト手順書

**作成日**: 2026年1月24日  
**環境**: ステージング環境（Render.com）  
**状態**: ✅ **テスト準備完了**

---

## 1. テスト前の準備

### 1.1 ステージング環境URL確認

**ステージング環境URL**:
- **バックエンド**: `https://yadopera-backend-staging.onrender.com`
- **フロントエンド**: `https://yadopera-frontend-staging.onrender.com`
- **開発者ログインページ**: `https://yadopera-frontend-staging.onrender.com/developer/login`

### 1.2 環境変数確認

**Render.comステージング環境で設定が必要な環境変数**:

1. `DEVELOPER_PASSWORD`: 開発者ログインパスワード
   - 推奨: 20文字以上のランダム文字列
   - 大文字、小文字、数字、記号を含む

2. `DEVELOPER_SESSION_EXPIRE_HOURS`: セッション有効期限（時間）
   - デフォルト: 24時間

**設定方法**:
1. Render.comダッシュボードにログイン
2. ステージング環境のサービスを選択
3. 「Environment」タブを開く
4. 環境変数を追加・設定
5. サービスを再起動

### 1.3 データベースマイグレーション確認

**確認コマンド**（Render.comのシェルから実行）:
```bash
# マイグレーション状態確認
alembic current

# テーブル確認
psql $DATABASE_URL -c "SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' AND table_name IN ('error_logs', 'admin_activity_logs', 'faq_view_logs');"
```

**期待される結果**:
- マイグレーション: `96b7b4fa4d3b` (head)
- テーブル: `error_logs`, `admin_activity_logs`, `faq_view_logs` が存在

---

## 2. ブラウザテスト手順

### 2.1 開発者ログインページへのアクセス

**URL**: `https://yadopera-frontend-staging.onrender.com/developer/login`

**確認項目**:
- [ ] ログインページが表示される
- [ ] パスワード入力フィールドが表示される
- [ ] ログインボタンが表示される
- [ ] ページが正常に読み込まれる（エラーなし）

### 2.2 開発者ログイン

**テストケース1: 正しいパスワードでログイン**

1. パスワード入力フィールドに設定した`DEVELOPER_PASSWORD`を入力
2. ログインボタンをクリック
3. ダッシュボードページにリダイレクトされることを確認

**確認項目**:
- [ ] ログインが成功する
- [ ] ダッシュボードページ（`/developer/dashboard`）にリダイレクトされる
- [ ] エラーメッセージが表示されない
- [ ] ブラウザのコンソールにエラーがない

**テストケース2: 誤ったパスワードでログイン**

1. パスワード入力フィールドに `WrongPassword` を入力
2. ログインボタンをクリック
3. エラーメッセージが表示されることを確認

**確認項目**:
- [ ] ログインが失敗する
- [ ] エラーメッセージが表示される（"Incorrect password" または "ログインに失敗しました"）
- [ ] ログインページに留まる
- [ ] ブラウザのコンソールにエラーがない

### 2.3 ダッシュボード表示

**URL**: `https://yadopera-frontend-staging.onrender.com/developer/dashboard`

**確認項目**:
- [ ] システム全体概要が表示される
  - [ ] 総施設数
  - [ ] アクティブ施設数
  - [ ] 総FAQ数
  - [ ] 過去24時間のエラー数（critical, error, warning）
  - [ ] 過去7日間のチャット数
  - [ ] 過去7日間のエスカレーション数
- [ ] 施設一覧が表示される
  - [ ] 施設名
  - [ ] アクティブ状態
  - [ ] FAQ数
  - [ ] 過去7日間のチャット数
  - [ ] 過去7日間のエラー数
  - [ ] 最終管理者ログイン日時
- [ ] ページが正常に読み込まれる（エラーなし）
- [ ] データが正しく表示される（数値が0以上）

### 2.4 エラーログページ

**URL**: `https://yadopera-frontend-staging.onrender.com/developer/errors`

**確認項目**:
- [ ] エラーログ一覧が表示される
- [ ] ページネーションが動作する（エラーログが存在する場合）
- [ ] フィルタリング機能が動作する
  - [ ] エラーレベルでフィルタリング（critical, error, warning）
  - [ ] 施設IDでフィルタリング
  - [ ] 日付範囲でフィルタリング
- [ ] エラーログ詳細をクリックすると詳細モーダルが開く
- [ ] スタックトレースが表示される（critical/errorレベルの場合）
- [ ] ページが正常に読み込まれる（エラーなし）

**テストケース**:
1. エラーレベルでフィルタリング（critical, error, warning）
2. 施設IDでフィルタリング（存在する施設IDを入力）
3. 日付範囲でフィルタリング（過去7日間など）
4. ページネーションで次のページに移動（エラーログが50件以上ある場合）

### 2.5 システムヘルスチェック

**URL**: `https://yadopera-frontend-staging.onrender.com/developer/health`

**確認項目**:
- [ ] データベース接続状態が表示される
  - [ ] ステータス: "healthy" または "unhealthy"
  - [ ] 応答時間が表示される
- [ ] Redis接続状態が表示される
  - [ ] ステータス: "healthy" または "unhealthy"
  - [ ] 応答時間が表示される
- [ ] OpenAI API接続状態が表示される
  - [ ] ステータス: "healthy" または "unhealthy"
  - [ ] 応答時間が表示される
- [ ] ページが正常に読み込まれる（エラーなし）

**期待される結果**:
- データベース: "healthy"（ステージング環境のデータベースに接続できる）
- Redis: "healthy"（ステージング環境のRedisに接続できる）
- OpenAI API: "healthy"（APIキーが正しく設定されている）

### 2.6 トークン期限チェック

**テストケース: トークン期限切れ時の自動ログアウト**

1. 開発者としてログイン
2. ブラウザの開発者ツールで `localStorage.getItem('developer_token')` を確認
3. JWTトークンをデコードして有効期限を確認
4. （オプション）トークンの有効期限を手動で変更して期限切れにする
5. ページをリロードまたは別のページに移動
6. 自動的にログインページにリダイレクトされることを確認

**確認項目**:
- [ ] トークン期限切れ時に自動的にログアウトされる
- [ ] ログインページにリダイレクトされる
- [ ] エラーメッセージが表示されない（または適切なメッセージが表示される）

### 2.7 ログアウト

**テストケース: ログアウト機能**

1. ダッシュボードページでログアウトボタンをクリック
2. ログインページにリダイレクトされることを確認
3. `localStorage.getItem('developer_token')` が `null` であることを確認

**確認項目**:
- [ ] ログアウトが正常に動作する
- [ ] ログインページにリダイレクトされる
- [ ] トークンが削除される

### 2.8 認証保護

**テストケース: 未認証でのアクセス**

1. ログアウト状態で、以下のURLに直接アクセス：
   - `https://yadopera-frontend-staging.onrender.com/developer/dashboard`
   - `https://yadopera-frontend-staging.onrender.com/developer/errors`
   - `https://yadopera-frontend-staging.onrender.com/developer/health`
2. ログインページにリダイレクトされることを確認

**確認項目**:
- [ ] 未認証で保護されたページにアクセスできない
- [ ] ログインページにリダイレクトされる
- [ ] リダイレクト後に元のページに戻れる（`redirect` クエリパラメータ）

---

## 3. API直接テスト（オプション）

### 3.1 開発者ログインAPI

```bash
curl -X POST https://yadopera-backend-staging.onrender.com/api/v1/developer/auth/login \
  -H "Content-Type: application/json" \
  -d '{"password": "YOUR_DEVELOPER_PASSWORD"}'
```

**期待されるレスポンス**:
```json
{
  "access_token": "eyJ...",
  "token_type": "bearer",
  "expires_in": 86400
}
```

### 3.2 システム全体概要API

```bash
curl -X GET https://yadopera-backend-staging.onrender.com/api/v1/developer/stats/overview \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

### 3.3 エラーログ一覧API

```bash
curl -X GET "https://yadopera-backend-staging.onrender.com/api/v1/developer/errors/list?page=1&per_page=50" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

---

## 4. トラブルシューティング

### 4.1 ログインできない

**原因**: 環境変数が設定されていない、またはパスワードが間違っている

**解決方法**:
1. Render.comの環境変数設定を確認
2. `DEVELOPER_PASSWORD`が正しく設定されているか確認
3. サービスを再起動
4. バックエンドログを確認: Render.comのログビューアで確認

### 4.2 ダッシュボードが表示されない

**原因**: APIエラー、トークン期限切れ、認証エラー

**解決方法**:
1. ブラウザの開発者ツールでネットワークタブを確認
2. APIレスポンスのステータスコードを確認
3. コンソールエラーを確認
4. トークンが有効期限内か確認

### 4.3 エラーログが表示されない

**原因**: データベースにエラーログが存在しない、またはマイグレーションが実行されていない

**解決方法**:
1. マイグレーションが実行されているか確認
2. データベースを直接確認:
   ```sql
   SELECT COUNT(*) FROM error_logs;
   ```
3. 意図的にエラーを発生させてエラーログを生成

### 4.4 マイグレーションエラー

**原因**: マイグレーションファイルが正しく適用されていない

**解決方法**:
1. Render.comのシェルからマイグレーションを手動実行:
   ```bash
   alembic upgrade head
   ```
2. マイグレーション状態を確認:
   ```bash
   alembic current
   ```

---

## 5. テストチェックリスト

### 5.1 基本機能

- [ ] 開発者ログインページが表示される
- [ ] 正しいパスワードでログインできる
- [ ] 誤ったパスワードでログインできない
- [ ] ダッシュボードに統計が表示される
- [ ] 施設一覧が表示される
- [ ] エラーログ一覧が表示される
- [ ] システムヘルスチェックが動作する
- [ ] ログアウトできる

### 5.2 セキュリティ

- [ ] 未認証で保護されたページにアクセスできない
- [ ] トークン期限切れで自動ログアウトされる
- [ ] トークンが正しく保存・削除される

### 5.3 UI/UX

- [ ] ページ遷移がスムーズ
- [ ] エラーメッセージが適切に表示される
- [ ] ローディング状態が表示される
- [ ] レスポンシブデザインが動作する（モバイル表示）

### 5.4 パフォーマンス

- [ ] ダッシュボード表示: 3秒以内
- [ ] エラーログ一覧: 2秒以内
- [ ] システムヘルスチェック: 2秒以内

---

## 6. テスト完了後の確認

### 6.1 ログ確認

**Render.comのログビューアで確認**:
- バックエンドログ: エラーがないか確認
- フロントエンドログ: エラーがないか確認

### 6.2 データベース確認

**確認コマンド**:
```sql
-- エラーログテーブル
SELECT COUNT(*) FROM error_logs;

-- 管理者アクティビティログテーブル
SELECT COUNT(*) FROM admin_activity_logs;

-- FAQ閲覧ログテーブル
SELECT COUNT(*) FROM faq_view_logs;
```

### 6.3 本番環境デプロイ前確認

**確認項目**:
- [ ] ステージング環境でのテスト完了
- [ ] 問題なしの確認
- [ ] 環境変数設定完了（本番環境用）
- [ ] データベースバックアップ取得

---

## 7. 次のステップ

### 7.1 テスト完了後

1. テスト結果を記録
2. 問題があれば修正
3. 修正後、再デプロイして再テスト

### 7.2 本番環境デプロイ

**条件**:
- ステージング環境でのテスト完了
- 問題なしの確認

**手順**:
1. `develop`ブランチから`main`ブランチにマージ
2. `main`ブランチにプッシュ
3. Render.com本番環境が自動デプロイ
4. 本番環境での動作確認

---

**Document Version**: v1.0  
**Author**: Auto (AI Assistant)  
**Last Updated**: 2026年1月24日  
**Status**: ✅ **テスト準備完了**

