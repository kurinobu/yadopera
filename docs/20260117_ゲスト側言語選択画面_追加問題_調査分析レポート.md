# ゲスト側言語選択画面 - 追加問題調査分析レポート

**作成日時**: 2026年01月17日  
**目的**: ブラウザテストで発見された追加問題の調査分析  
**状態**: 📋 **調査分析完了**

---

## 1. 問題1: Premiumプランの言語リストについて

### 1.1 問題の詳細

**報告内容**:
- Premiumプランで「全言語表示」となっているが、スペイン語を含む他の言語はどのように決めたのか？
- Standardプラン＋韓国語だけにしてほしい

### 1.2 調査結果

**実装箇所**: `backend/app/services/facility_service.py` (127-131行目)

**現在の実装**:
```python
# Premiumプランの場合、全言語対応
if plan_type == "Premium" or available_languages is None:
    # 全言語対応の場合、将来的な拡張を考慮して主要言語を返す
    # 現時点では英語のみだが、将来的に追加される可能性のある言語を含める
    available_languages = ["ja", "en", "zh-TW", "fr", "es", "de", "ko", "th", "vi"]
```

**問題点**:
- 🔴 **実装者が独自に決めた言語リスト**（ユーザーの要望に基づいていない）
- 🔴 `plan_limits.py`では`premium: {"languages": None}`（無制限）となっているが、`facility_service.py`で独自の言語リストを返している
- 🔴 Standardプラン（`["ja", "en", "zh-TW", "fr"]`）＋韓国語（`["ko"]`）にする必要がある

**修正方針**:
- Standardプランの言語リスト（`["ja", "en", "zh-TW", "fr"]`）に韓国語（`["ko"]`）を追加
- `["ja", "en", "zh-TW", "fr", "ko"]`にする

---

## 2. 問題2: 言語選択後のページ表示について

### 2.1 問題の詳細

**報告内容**:
- 日本語、中国語、フランス語を選択しても、遷移後のページは英語しか表示されていない
- これは正しいのか？FAQの設定をしていないからか？

### 2.2 調査結果

**実装箇所**: 
- `frontend/src/views/guest/Welcome.vue` (66行目)
- `frontend/src/views/guest/Chat.vue` (166行目)
- `backend/app/services/facility_service.py` (122-126行目)

**現在の実装**:

**Welcome.vue**:
```typescript
const language = computed(() => (route.query.lang as string) || 'en')
```

**Chat.vue**:
```typescript
const language = computed(() => (route.query.lang as string) || 'en')
```

**facility_service.py** (TOP3 FAQ取得):
```python
# 英語の翻訳を優先的に取得
translation = next(
    (t for t in faq.translations if t.language == "en"),
    faq.translations[0]  # 英語がない場合は最初の翻訳を使用
)
```

**問題点**:
- 🔴 **TOP3 FAQが常に英語で返されている**
- 🔴 `facility_service.py`で英語の翻訳を優先的に取得しているため、選択した言語に関係なく英語が表示される
- 🔴 Welcome画面やChat画面で選択した言語が使用されていない

**修正方針**:
- `get_facility_public_info`メソッドに`language`パラメータを追加
- 選択した言語の翻訳を優先的に取得する
- 選択した言語の翻訳がない場合、英語をフォールバックとして使用

---

## 3. 問題3: セッションIDの重複エラーについて

### 3.1 問題の詳細

**報告内容**:
- 遷移したページのFAQをタップすると、セッションIDの重複エラーが発生する
- エラー内容: `duplicate key value violates unique constraint "idx_conversations_session_id"`

### 3.2 調査結果

**実装箇所**: 
- `backend/app/models/conversation.py` (20行目)
- `backend/app/services/chat_service.py` (212-285行目)
- `frontend/src/views/guest/Welcome.vue` (140-150行目)

**現在の実装**:

**conversation.py**:
```python
session_id = Column(String(100), unique=True, nullable=False, index=True)
```

**chat_service.py** (`_get_or_create_conversation`):
```python
async def _get_or_create_conversation(
    self,
    facility_id: int,
    session_id: Optional[str],
    language: str,
    location: Optional[str] = None,
    user_agent: Optional[str] = None,
    ip_address: Optional[str] = None
) -> Conversation:
    # 既存の会話を検索
    result = await self.db.execute(
        select(Conversation).where(
            Conversation.session_id == session_id
        )
    )
    conversation = result.scalar_one_or_none()
    
    if conversation:
        # 既存の会話を更新
        conversation.last_activity_at = datetime.utcnow()
        # ...
    else:
        # 新規会話を作成
        conversation = Conversation(
            facility_id=facility_id,
            session_id=session_id,
            # ...
        )
        self.db.add(conversation)
        await self.db.flush()
```

**Welcome.vue** (`handleQuestionClick`):
```typescript
const handleQuestionClick = (question: TopQuestion) => {
  // チャット画面に遷移してメッセージを送信
  router.push({
    name: 'Chat',
    params: { facilityId: facilityId.value },
    query: {
      lang: language.value,
      location: location.value,
      message: question.question
    }
  })
}
```

**問題点**:
- 🔴 **FAQをタップした際に、新しい会話を作成しようとしている**
- 🔴 同じセッションIDで複数回会話を作成しようとしている可能性がある
- 🔴 `_get_or_create_conversation`メソッドで既存の会話をチェックしているが、並行処理やタイミングの問題で重複が発生している可能性がある

**想定される原因**:
1. **並行処理の問題**: 同じセッションIDで複数のリクエストが同時に来た場合、両方とも「既存の会話がない」と判断して新規作成しようとする
2. **トランザクションの問題**: `flush()`の後に`commit()`する前に、別のリクエストが同じセッションIDで会話を作成しようとする
3. **セッションIDの再利用**: 既存のセッションIDが再利用されているが、データベースから削除されていない

**修正方針**:
- `_get_or_create_conversation`メソッドで、既存の会話をチェックする際に、トランザクション内でロックを取得する
- または、`INSERT ... ON CONFLICT DO UPDATE`を使用して、重複時の処理を明確にする
- エラーハンドリングを追加して、重複エラーが発生した場合は既存の会話を取得する

---

## 4. 修正優先度

### 4.1 優先度1: Premiumプランの言語リスト修正

**重大度**: 🟡 中（仕様の不整合）
**影響**: Premiumプランで不要な言語が表示される
**修正時間**: 5分

### 4.2 優先度2: 言語選択後のページ表示修正

**重大度**: 🔴 高（ユーザー体験の問題）
**影響**: 選択した言語が反映されない
**修正時間**: 30分

### 4.3 優先度3: セッションIDの重複エラー修正

**重大度**: 🔴 高（機能障害）
**影響**: FAQをタップした際にエラーが発生する
**修正時間**: 1時間

---

## 5. 修正方針（大原則準拠）

### 5.1 大原則の確認

1. **根本解決 > 暫定解決**: 各問題の根本原因を修正する
2. **シンプル構造 > 複雑構造**: シンプルな修正を採用
3. **統一・同一化 > 特殊独自**: 既存のパターンに従う
4. **具体的 > 一般**: 具体的な修正方法を明確にする
5. **拙速 < 安全確実**: テストを省略せず、十分な検証を行う
6. **Docker環境必須**: すべての修正・テストはDocker環境で実行する

### 5.2 修正ステップ

#### ステップ1: Premiumプランの言語リスト修正（5分）

1. `backend/app/services/facility_service.py`を修正
2. Premiumプランの言語リストを`["ja", "en", "zh-TW", "fr", "ko"]`に変更

#### ステップ2: 言語選択後のページ表示修正（30分）

1. `backend/app/api/v1/facility.py`に`language`パラメータを追加
2. `backend/app/services/facility_service.py`の`get_facility_public_info`メソッドに`language`パラメータを追加
3. 選択した言語の翻訳を優先的に取得するロジックを実装
4. Frontendで選択した言語をAPIリクエストに含める

#### ステップ3: セッションIDの重複エラー修正（1時間）

1. `backend/app/services/chat_service.py`の`_get_or_create_conversation`メソッドを修正
2. 重複エラーのハンドリングを追加
3. トランザクション内でロックを取得するか、`INSERT ... ON CONFLICT DO UPDATE`を使用

---

## 6. まとめ

### 6.1 問題の本質

1. **Premiumプランの言語リスト**: 実装者が独自に決めた言語リスト（ユーザーの要望に基づいていない）
2. **言語選択後のページ表示**: TOP3 FAQが常に英語で返されている（選択した言語が反映されていない）
3. **セッションIDの重複エラー**: 並行処理やタイミングの問題で重複が発生している

### 6.2 修正の必要性

- ✅ **Premiumプランの言語リスト**: 仕様の不整合を修正する必要がある
- ✅ **言語選択後のページ表示**: ユーザー体験を改善する必要がある
- ✅ **セッションIDの重複エラー**: 機能障害を修正する必要がある

---

**Document Version**: v1.0  
**Author**: Auto (AI Assistant)  
**Last Updated**: 2026年01月17日  
**Status**: 📋 **調査分析完了**

