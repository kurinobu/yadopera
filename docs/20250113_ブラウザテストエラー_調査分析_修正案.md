# ブラウザテストエラー調査分析・修正案

**作成日**: 2025年1月13日  
**対象**: ブラウザテストで発生した500エラーとFAQ自動登録件数ロジックの修正  
**目的**: エラーの根本原因を特定し、大原則に準拠した修正案を立案

---

## 1. エラーの概要

### 1.1 発生したエラー

**コンソールエラー**:
- CORSエラー: `Access to XMLHttpRequest at 'http://localhost:8000/api/v1/admin/faqs' from origin 'http://localhost:5173' has been blocked by CORS policy`
- 500 Internal Server Error: `GET http://localhost:8000/api/v1/admin/faqs net::ERR_FAILED 500 (Internal Server Error)`

**バックエンドログエラー**:
```
RuntimeError: Event loop is closed
```

### 1.2 影響範囲

- FAQ一覧取得API (`/api/v1/admin/faqs`) が500エラーで失敗
- フロントエンドでFAQ一覧が表示できない
- 新規登録後のFAQ自動投入処理が正常に動作しない可能性

---

## 2. 根本原因の分析

### 2.1 500エラーの原因

**問題の本質**:
- `auth_service.py`の`_run_async_faq_creation`関数で、新しいイベントループを作成して閉じています
- FastAPIの`BackgroundTasks`は既存のイベントループ内で非同期関数を実行できるため、新しいイベントループを作成する必要はありません
- 新しいイベントループを作成して閉じた後、元のイベントループが閉じられてしまい、`RuntimeError: Event loop is closed`エラーが発生します

**エラーの発生フロー**:
```
1. 新規登録APIが呼び出される
2. BackgroundTasksに`_run_async_faq_creation`が追加される
3. `_run_async_faq_creation`が新しいイベントループを作成
4. 非同期処理を実行
5. イベントループを閉じる
6. 元のイベントループが閉じられる
7. FAQ一覧取得APIが呼び出される
8. → RuntimeError: Event loop is closed
```

**証拠**:
- バックエンドログで`RuntimeError: Event loop is closed`が確認される
- エラーはFAQ一覧取得APIで発生
- 新規登録直後にFAQ一覧を取得しようとすると発生

### 2.2 CORSエラーの原因

**問題の本質**:
- CORS設定は正しく実装されていますが、500エラーが発生したため、CORSヘッダーが正しく返されていません
- 500エラーが解決されれば、CORSエラーも解消されます

### 2.3 FAQ自動登録件数ロジックの問題

**問題の本質**:
- 現在の実装では、プランの上限（`max_faqs`）に基づいてFAQプリセットをフィルタリングしています
- しかし、実際の仕様は以下の通りです：
  - **Freeプラン**: 20件（日本語のみ）
  - **それ以外（Mini, Small, Standard, Premium）**: 全て30件（プランに応じた言語）

**現在の実装の問題**:
- `filter_faq_presets_by_plan`関数が、プランの上限（Small: 50件、Standard: 100件）に基づいてフィルタリングしている
- これにより、Smallプランでは50件、Standardプランでは100件が登録されてしまう
- しかし、FAQプリセットは30件しかないため、実際には30件が登録されるが、ロジックが誤っている

**正しい仕様**:
- 初期自動登録件数は、プランの上限ではなく、固定値：
  - Freeプラン: 20件（日本語のみ）
  - それ以外: 30件（プランに応じた言語）

---

## 3. 修正案

### 3.1 バックグラウンドタスクの修正

**方針**: FastAPIの`BackgroundTasks`は非同期関数を直接実行できるため、新しいイベントループを作成せず、既存のイベントループを使用します。

**修正内容**:

1. **`_run_async_faq_creation`関数を削除**
   - 新しいイベントループを作成する必要がないため

2. **`register_facility`関数の修正**
   - `BackgroundTasks.add_task()`に非同期関数を直接渡す
   - FastAPIが自動的にイベントループ内で実行する

**修正後のコード**:

```python
@staticmethod
async def register_facility(
    db: AsyncSession,
    request: FacilityRegisterRequest,
    background_tasks: Optional[BackgroundTasks] = None
) -> LoginResponse:
    """
    施設登録処理（FAQ自動投入は非同期で実行）
    
    Args:
        db: データベースセッション
        request: 施設登録リクエスト
        background_tasks: バックグラウンドタスク（オプション）
    
    Returns:
        ログインレスポンス（JWTトークン含む）
    
    Raises:
        HTTPException: 登録失敗時
    """
    # 施設・ユーザー作成（同期処理）
    response = await AuthService.register_facility_sync(db, request)
    
    # FAQ自動投入をバックグラウンドで実行
    if background_tasks:
        # FastAPIのBackgroundTasksは非同期関数を直接実行できる
        background_tasks.add_task(
            AuthService.register_facility_async_faqs,
            response.user.facility_id,
            response.user.id,
            request.subscription_plan
        )
    else:
        # バックグラウンドタスクが利用できない場合は同期的に実行（後方互換性）
        logger.warning(
            "BackgroundTasks not available, running FAQ creation synchronously"
        )
        await AuthService.register_facility_async_faqs(
            response.user.facility_id,
            response.user.id,
            request.subscription_plan
        )
    
    return response
```

### 3.2 FAQ自動登録件数ロジックの修正

**方針**: プランの上限ではなく、初期自動登録件数に基づいてフィルタリングします。

**修正内容**:

1. **`plan_limits.py`に初期自動登録件数を定義**
   - `INITIAL_FAQ_COUNTS`: 初期自動登録件数の定義
   - Freeプラン: 20件
   - それ以外: 30件

2. **`filter_faq_presets_by_plan`関数の修正**
   - プランの上限（`max_faqs`）ではなく、初期自動登録件数（`initial_count`）を使用
   - 言語フィルタは既存のロジックを維持

**修正後のコード**:

```python
# 初期自動登録件数の定義
INITIAL_FAQ_COUNTS: Dict[str, int] = {
    "free": 20,      # Freeプラン: 20件
    "mini": 30,      # Miniプラン: 30件
    "small": 30,     # Smallプラン: 30件
    "standard": 30,  # Standardプラン: 30件
    "premium": 30    # Premiumプラン: 30件
}

def get_initial_faq_count(plan: str) -> int:
    """
    初期自動登録件数を取得
    
    Args:
        plan: 料金プラン
    
    Returns:
        初期自動登録件数
    """
    return INITIAL_FAQ_COUNTS.get(plan, 30)  # デフォルトは30件

def filter_faq_presets_by_plan(
    presets: List[Dict[str, Any]],
    plan: str
) -> List[Dict[str, Any]]:
    """
    料金プランに基づいてFAQプリセットをフィルタ（初期自動登録用）
    
    Args:
        presets: FAQプリセットリスト
        plan: 料金プラン
    
    Returns:
        フィルタされたFAQプリセットリスト
    """
    # 初期自動登録件数を取得
    initial_count = get_initial_faq_count(plan)
    
    # プランの制限を取得（言語フィルタ用）
    limits = get_plan_limits(plan)
    allowed_languages = limits["languages"]
    
    # 初期自動登録件数に基づいてフィルタ
    filtered_presets = presets[:initial_count]
    
    # 言語フィルタ
    if allowed_languages:
        filtered_presets = [
            {
                **preset,
                "translations": [
                    t for t in preset["translations"]
                    if t["language"] in allowed_languages
                ]
            }
            for preset in filtered_presets
        ]
        # フィルタ後も翻訳が残っているFAQのみを返す
        filtered_presets = [
            preset for preset in filtered_presets
            if preset["translations"]
        ]
    
    return filtered_presets
```

---

## 4. 修正の優先順位

### 優先度1: バックグラウンドタスクの修正（500エラー解消）
- **影響**: FAQ一覧取得APIが正常に動作しない
- **緊急度**: 高
- **修正内容**: `_run_async_faq_creation`関数を削除し、非同期関数を直接`BackgroundTasks.add_task()`に渡す

### 優先度2: FAQ自動登録件数ロジックの修正
- **影響**: 初期自動登録件数が仕様と異なる
- **緊急度**: 中
- **修正内容**: 初期自動登録件数の定義を追加し、`filter_faq_presets_by_plan`関数を修正

---

## 5. 修正後の期待動作

### 5.1 バックグラウンドタスクの修正後

- ✅ FAQ一覧取得APIが正常に動作する
- ✅ 新規登録後もFAQ一覧が取得できる
- ✅ イベントループエラーが発生しない

### 5.2 FAQ自動登録件数ロジックの修正後

- ✅ Freeプラン: 20件（日本語のみ）が自動登録される
- ✅ Miniプラン: 30件（日本語＋英語）が自動登録される
- ✅ Smallプラン: 30件（日本語＋英語＋中国語）が自動登録される
- ✅ Standardプラン: 30件（日本語＋英語＋中国語＋フランス語）が自動登録される
- ✅ Premiumプラン: 30件（全言語）が自動登録される

---

## 6. テスト項目

### 6.1 バックグラウンドタスクの修正後

1. **新規登録テスト**
   - Freeプランで新規登録
   - 登録後、FAQ一覧取得APIを呼び出す
   - 500エラーが発生しないことを確認

2. **FAQ一覧取得テスト**
   - 既存の施設でFAQ一覧取得APIを呼び出す
   - 正常にレスポンスが返ることを確認

### 6.2 FAQ自動登録件数ロジックの修正後

1. **Freeプランのテスト**
   - Freeプランで新規登録
   - 20件（日本語のみ）が登録されることを確認

2. **Miniプランのテスト**
   - Miniプランで新規登録
   - 30件（日本語＋英語）が登録されることを確認

3. **Smallプランのテスト**
   - Smallプランで新規登録
   - 30件（日本語＋英語＋中国語）が登録されることを確認

4. **Standardプランのテスト**
   - Standardプランで新規登録
   - 30件（日本語＋英語＋中国語＋フランス語）が登録されることを確認

5. **Premiumプランのテスト**
   - Premiumプランで新規登録
   - 30件（全言語）が登録されることを確認

---

## 7. 大原則への準拠

### 7.1 根本解決 > 暫定対応
- ✅ イベントループの問題を根本的に解決（新しいイベントループを作成しない）
- ✅ FAQ自動登録件数ロジックを仕様に準拠させる

### 7.2 シンプルな構造 > 複雑な構造
- ✅ 不要なラッパー関数を削除
- ✅ 初期自動登録件数を明確に定義

### 7.3 安全性と確実性 > 速度
- ✅ エラーハンドリングを維持
- ✅ 後方互換性を考慮（`background_tasks`が利用できない場合の処理）

---

## 8. 修正ファイル一覧

### 8.1 バックグラウンドタスクの修正

- `backend/app/services/auth_service.py`
  - `_run_async_faq_creation`関数を削除
  - `register_facility`関数を修正

### 8.2 FAQ自動登録件数ロジックの修正

- `backend/app/core/plan_limits.py`
  - `INITIAL_FAQ_COUNTS`を追加
  - `get_initial_faq_count`関数を追加
  - `filter_faq_presets_by_plan`関数を修正

---

## 9. まとめ

### 9.1 問題点

1. **500エラー**: バックグラウンドタスクで新しいイベントループを作成して閉じたことが原因
2. **FAQ自動登録件数ロジック**: プランの上限に基づいてフィルタリングしていたが、実際は初期自動登録件数に基づく必要がある

### 9.2 修正内容

1. **バックグラウンドタスク**: 新しいイベントループを作成せず、FastAPIの`BackgroundTasks`に非同期関数を直接渡す
2. **FAQ自動登録件数ロジック**: 初期自動登録件数の定義を追加し、プランの上限ではなく初期自動登録件数に基づいてフィルタリング

### 9.3 期待される効果

- ✅ FAQ一覧取得APIが正常に動作する
- ✅ 初期自動登録件数が仕様に準拠する
- ✅ イベントループエラーが発生しない

