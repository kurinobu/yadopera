# FAQ10件問題 完全調査分析・修正案

**作成日**: 2025年1月13日  
**対象**: ステージング環境でのFAQ表示問題（10件のみ表示、期待値20件）  
**状態**: 🔍 **調査分析完了、修正案提示完了**

---

## 1. 問題の概要

### 1.1 現象

- **期待動作**: 新規登録後、FAQ一覧ページで20件のFAQが表示される
- **実際の動作**: 
  - 開発者ツールのアプリケーションでサイトデータを削除
  - 新規登録しFAQを開く
  - 初期表示: 1件表示
  - ポーリング: FAQ数が1→3→5→7→8→10と増加
  - タイムアウト: 30秒後にタイムアウトし、10件で停止
  - 最終結果: 10件のみ表示（期待値20件に到達していない）

### 1.2 コンソールログの分析

**コンソールログの内容**:
1. `🚀 fetchFaqs: 開始` - デバッグログが表示されている ✅
2. `📡 fetchFaqs: API呼び出し前` - デバッグログが表示されている ✅
3. `📡 fetchFaqs: API呼び出し成功` - `{faqs: Array(1), total: 1, is_initializing: true}` ✅
4. `✅ FAQ取得成功:` - `{count: 1, total: 1, is_initializing: true, ...}` ✅
5. `🔍 ポーリング条件チェック:` - `{isInitializing: true, total: 1, expectedCount: 20, ...}` ✅
6. `🔄 バックグラウンド処理進行中または期待値未満: ポーリングを開始` - ポーリングが開始されている ✅
7. `🔄 ポーリング結果:` - FAQ数が1→3→5→7→8→10と増加 ✅
8. `📊 FAQ数が増加: UIを更新` - UIが更新されている ✅
9. `⏱️ ポーリングタイムアウト: 最後に取得したデータを表示` - `{total: 10, count: 10}` ❌
10. `FaqList: props.faqs received:` - `{count: 10, categories: {...}, faqs: Array(10)}` ❌

**重要な観察**:
- ✅ **ポーリングは正常に動作している**: FAQ数が増加している
- ✅ **UIは更新されている**: ポーリング中にUIが更新されている
- ❌ **タイムアウトが早すぎる**: 30秒でタイムアウトし、10件で停止
- ❌ **バックグラウンド処理が完了していない**: 20件に到達する前にタイムアウトしている

---

## 2. 根本原因の分析

### 2.1 問題点の詳細

**現在の実装** (`frontend/src/views/admin/FaqManagement.vue`):

```typescript
const pollInterval = 2000 // 2秒ごとにポーリング
const maxPollTime = 30000 // 最大30秒 ← これが短すぎる
const startTime = Date.now()

const poll = async () => {
  // ...
  // タイムアウトチェック（ポーリング結果取得後）
  if (Date.now() - startTime > maxPollTime) {
    // タイムアウト: 最後に取得したデータを表示
    console.log('⏱️ ポーリングタイムアウト: 最後に取得したデータを表示', {
      total: newTotal,
      count: newData.length
    })
    faqs.value = newData
    loading.value = false
    return
  }
  // ...
}
```

**問題点**:
1. **タイムアウトが30秒**: バックグラウンド処理（20件のFAQ作成 + 埋め込みベクトル生成）に30秒では不十分
2. **バックグラウンド処理の完了を待っていない**: `is_initializing`が`false`になるまで待っていない
3. **ステージング環境での処理時間**: ステージング環境では、データベース接続やAPI呼び出しに時間がかかる可能性がある

### 2.2 バックグラウンド処理の処理時間

**バックグラウンド処理の内容**:
1. **FAQ一括作成**: 20件のFAQを作成
2. **埋め込みベクトル生成**: 各FAQの翻訳（言語数に応じて）に対して埋め込みベクトルを生成
   - Freeプラン: 日本語のみ（20件 × 1言語 = 20回のAPI呼び出し）
   - Miniプラン以上: 複数言語（20件 × 2言語以上 = 40回以上のAPI呼び出し）

**処理時間の推定**:
- **1件のFAQ作成**: 約1-2秒（埋め込みベクトル生成を含む）
- **20件のFAQ作成**: 約20-40秒
- **ステージング環境**: さらに時間がかかる可能性がある（データベース接続、API呼び出しの遅延）

**結論**: 30秒では不十分で、60秒以上が必要

---

## 3. 根本原因の確定

### 3.1 最有力の原因

**原因**: **ポーリングのタイムアウトが30秒で、バックグラウンド処理が完了する前にタイムアウトしている**

**理由**:
1. **バックグラウンド処理に時間がかかる**: 20件のFAQ作成 + 埋め込みベクトル生成に30秒以上かかる
2. **ステージング環境での処理時間**: ステージング環境では、さらに時間がかかる可能性がある
3. **タイムアウトが早すぎる**: 30秒でタイムアウトし、10件で停止している
4. **バックグラウンド処理は正常に動作している**: ポーリング中にFAQ数が増加している

### 3.2 確認事項

**バックグラウンド処理の完了条件**:
- `is_initializing`が`false`になる
- `total >= expectedCount`（20件）になる

**現在の実装**:
- タイムアウトチェックが先に実行されるため、`is_initializing`が`false`になる前にタイムアウトしている

---

## 4. 修正案

### 4.1 修正案1: ポーリングのタイムアウトを延長（優先度1）

**修正内容**:
1. ポーリングのタイムアウトを30秒から90秒に延長
2. ステージング環境での処理時間を考慮

**実装例**:

```typescript
const pollInterval = 2000 // 2秒ごとにポーリング
const maxPollTime = 90000 // 最大90秒（ステージング環境を考慮）
const startTime = Date.now()

const poll = async () => {
  try {
    const newResponse = await faqApi.getFaqs()
    const newData = newResponse.faqs
    const newTotal = newResponse.total
    const newIsInitializing = newResponse.is_initializing
    
    console.log('🔄 ポーリング結果:', {
      count: newData.length,
      total: newTotal,
      is_initializing: newIsInitializing
    })
    
    // ポーリング中にFAQ数が増えた場合は、即座にUIを更新
    if (newTotal > faqs.value.length) {
      console.log('📊 FAQ数が増加: UIを更新', {
        previous: faqs.value.length,
        current: newTotal
      })
      faqs.value = newData
    }
    
    // バックグラウンド処理の完了を優先チェック
    if (!newIsInitializing && newTotal >= expectedCount) {
      // 完了: 最新のデータを表示
      console.log('✅ バックグラウンド処理完了: 最新のデータを表示', newTotal)
      faqs.value = newData
      loading.value = false
      return
    }
    
    // タイムアウトチェック（完了チェックの後）
    if (Date.now() - startTime > maxPollTime) {
      // タイムアウト: 最後に取得したデータを表示
      console.log('⏱️ ポーリングタイムアウト: 最後に取得したデータを表示', {
        total: newTotal,
        count: newData.length,
        is_initializing: newIsInitializing
      })
      faqs.value = newData
      loading.value = false
      return
    }
    
    // まだ進行中: 再度ポーリング
    setTimeout(poll, pollInterval)
  } catch (err: any) {
    console.error('❌ ポーリングエラー:', err)
    console.error('❌ ポーリングエラー: エラー詳細', {
      message: err.message,
      stack: err.stack,
      response: err.response
    })
    loading.value = false
  }
}
```

**メリット**:
- ✅ **シンプル**: タイムアウトを延長するだけ
- ✅ **確実**: バックグラウンド処理が完了するまで待つことができる
- ✅ **ステージング環境に対応**: ステージング環境での処理時間を考慮

**デメリット**:
- ⚠️ **ユーザー体験**: 90秒待つ必要がある（ただし、ポーリング中にUIは更新される）

**評価**: ✅ **最優先で実施**

---

### 4.2 修正案2: バックグラウンド処理の完了を優先チェック（優先度2）

**修正内容**:
1. タイムアウトチェックの前に、バックグラウンド処理の完了をチェック
2. `is_initializing`が`false`で`total >= expectedCount`の場合、タイムアウトに関係なく完了とする

**実装例**:

```typescript
// バックグラウンド処理の完了を優先チェック
if (!newIsInitializing && newTotal >= expectedCount) {
  // 完了: 最新のデータを表示
  console.log('✅ バックグラウンド処理完了: 最新のデータを表示', newTotal)
  faqs.value = newData
  loading.value = false
  return
}

// タイムアウトチェック（完了チェックの後）
if (Date.now() - startTime > maxPollTime) {
  // タイムアウト: 最後に取得したデータを表示
  console.log('⏱️ ポーリングタイムアウト: 最後に取得したデータを表示', {
    total: newTotal,
    count: newData.length
  })
  faqs.value = newData
  loading.value = false
  return
}
```

**メリット**:
- ✅ **効率的**: バックグラウンド処理が完了したら、すぐに完了とする
- ✅ **ユーザー体験**: タイムアウトを待たずに完了できる

**デメリット**:
- ⚠️ **実装の複雑さ**: チェック順序を変更する必要がある

**評価**: ✅ **補助的な改善**

---

### 4.3 修正案3: バックグラウンド処理の最適化（優先度3）

**修正内容**:
1. 埋め込みベクトル生成を並列化する
2. バッチ処理でAPI呼び出しを最適化する

**評価**: ✅ **長期的な改善**

---

## 5. 修正案の評価

### 5.1 修正案1: ポーリングのタイムアウトを延長

**優先度**: 🔴 **最優先（優先度1）**

**理由**:
- 根本的な問題を解決する
- シンプルで確実
- ステージング環境での処理時間を考慮

**実装コスト**: 低（1行の変更のみ）

**リスク**: 低（タイムアウトを延長するだけ）

---

### 5.2 修正案2: バックグラウンド処理の完了を優先チェック

**優先度**: 🟡 **補助的な改善（優先度2）**

**理由**:
- ユーザー体験を改善する
- バックグラウンド処理が完了したら、すぐに完了とする

**実装コスト**: 低（チェック順序を変更するだけ）

**リスク**: 低

---

## 6. まとめ

### 6.1 問題の根本原因

1. **ポーリングのタイムアウトが30秒**: バックグラウンド処理が完了する前にタイムアウトしている
2. **バックグラウンド処理に時間がかかる**: 20件のFAQ作成 + 埋め込みベクトル生成に30秒以上かかる
3. **ステージング環境での処理時間**: ステージング環境では、さらに時間がかかる可能性がある

### 6.2 修正方針

1. **修正案1を最優先で実施**: ポーリングのタイムアウトを30秒から90秒に延長
2. **修正案2を補助的に実施**: バックグラウンド処理の完了を優先チェック

### 6.3 期待される効果

- ✅ **20件のFAQが表示される**: バックグラウンド処理が完了するまで待つことができる
- ✅ **ユーザー体験の向上**: ポーリング中にUIは更新されるが、完了まで待つことができる
- ✅ **ステージング環境に対応**: ステージング環境での処理時間を考慮

---

**状態**: 🔍 **調査分析完了、修正案提示完了**  
**次のステップ**: ユーザーの指示を待つ（修正は実施しない）

