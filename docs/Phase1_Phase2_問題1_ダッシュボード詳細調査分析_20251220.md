# Phase 1・Phase 2: 問題1 ダッシュボード詳細調査分析

**作成日時**: 2025年12月20日 17:15  
**実施者**: Auto (AI Assistant)  
**対象**: ダッシュボードのグラフとスコアの関係、メッセージと質問の違いについての詳細調査分析  
**状態**: ✅ **調査分析完了**

---

## 1. ユーザーの質問

1. **グラフとスコアは別なのですか？グラフは週次でスコアは総数なのですか？**
2. **「過去7日間のメッセージで使用されたFAQのカテゴリ集計」のメッセージとは具体的に何を指していますか？質問数ではないのですか？**
3. **FAQ管理ページのトップには「週次サマリーとリアルタイムチャット履歴」と記されてます。全て週次の情報なのではないのですか？**
4. **最初のカードには「総質問数」とありますが、これはメッセージとどう異なりますか？**

---

## 2. 詳細調査分析

### 2.1 ダッシュボードの構造

**ファイル**: `frontend/src/views/admin/Dashboard.vue`

**構成**:
1. **週次サマリー統計カード**（4つのカード）
   - 総質問数（過去7日間）
   - 自動応答率
   - 平均信頼度
   - 未解決質問

2. **カテゴリ別円グラフ**
   - カテゴリ別内訳

3. **リアルタイムチャット履歴と夜間対応キュー**

4. **ゲストフィードバック集計**

### 2.2 質問1: グラフとスコアは別なのか？

#### 2.2.1 グラフ（カテゴリ別内訳）

**データソース**: `summary.category_breakdown`

**計算ロジック**: `backend/app/services/dashboard_service.py`

```python:183:229:backend/app/services/dashboard_service.py
# カテゴリ別内訳（matched_faq_idsからFAQカテゴリを集計）
category_breakdown = CategoryBreakdown()

# 過去7日間のAI応答メッセージを取得（matched_faq_idsがNULLでないもの）
ai_messages_with_faqs_result = await self.db.execute(
    select(Message)
    .where(Message.conversation_id.in_(conversation_ids))
    .where(Message.role == MessageRole.ASSISTANT.value)
    .where(Message.matched_faq_ids.isnot(None))
)
ai_messages_with_faqs = ai_messages_with_faqs_result.scalars().all()

# matched_faq_idsからFAQ IDを収集（重複を排除、空配列を除外）
faq_ids = set()
for msg in ai_messages_with_faqs:
    if msg.matched_faq_ids and len(msg.matched_faq_ids) > 0:
        faq_ids.update(msg.matched_faq_ids)

# FAQを取得してカテゴリを集計
if faq_ids:
    faqs_result = await self.db.execute(
        select(FAQ)
        .where(FAQ.id.in_(list(faq_ids)))
        .where(FAQ.facility_id == facility_id)
        .where(FAQ.is_active == True)
    )
    faqs = faqs_result.scalars().all()
    
    # カテゴリ別に集計（各メッセージの最初のマッチしたFAQのカテゴリをカウント）
    category_counts = {"basic": 0, "facilities": 0, "location": 0, "trouble": 0}
    faq_category_map = {faq.id: faq.category for faq in faqs}
    
    for msg in ai_messages_with_faqs:
        if msg.matched_faq_ids and len(msg.matched_faq_ids) > 0:
            # 最初のマッチしたFAQのカテゴリをカウント
            first_faq_id = msg.matched_faq_ids[0]
            if first_faq_id in faq_category_map:
                category = faq_category_map[first_faq_id]
                if category in category_counts:
                    category_counts[category] += 1
    
    category_breakdown = CategoryBreakdown(
        basic=category_counts["basic"],
        facilities=category_counts["facilities"],
        location=category_counts["location"],
        trouble=category_counts["trouble"]
    )
```

**説明**:
- **期間**: 過去7日間（週次）
- **対象**: AI応答メッセージ（`role='assistant'`）で、`matched_faq_ids`がNULLでないもの
- **集計方法**: 各AI応答メッセージの最初のマッチしたFAQのカテゴリをカウント
- **意味**: 過去7日間にAIがFAQを使って回答した回数をカテゴリ別に集計

#### 2.2.2 スコア（総質問数）

**データソース**: `summary.total_questions`

**計算ロジック**: `backend/app/services/dashboard_service.py`

```python:137:146:backend/app/services/dashboard_service.py
# メッセージを取得
messages_result = await self.db.execute(
    select(Message)
    .where(Message.conversation_id.in_(conversation_ids))
    .where(Message.role == MessageRole.USER.value)
)
messages = messages_result.scalars().all()

# 総質問数
total_questions = len(messages)
```

**説明**:
- **期間**: 過去7日間（週次）
- **対象**: ユーザーメッセージ（`role='user'`）
- **集計方法**: 過去7日間のユーザーメッセージの総数
- **意味**: 過去7日間にゲストが送信した質問の総数

#### 2.2.3 回答

**グラフとスコアは別です**:
- **グラフ（カテゴリ別内訳）**: 過去7日間のAI応答メッセージで使用されたFAQのカテゴリを集計
- **スコア（総質問数）**: 過去7日間のユーザーメッセージ（質問）の総数

**両方とも週次（過去7日間）のデータです**:
- グラフもスコアも、同じ期間（過去7日間）のデータを使用
- ただし、集計対象が異なる：
  - グラフ: AI応答メッセージ（FAQを使用した回答）
  - スコア: ユーザーメッセージ（質問）

**数値の関係**:
- 総質問数（スコア）≥ カテゴリ別内訳の合計（グラフ）
- 理由: すべての質問がFAQで回答されるわけではない（エスカレーションされる場合もある）

---

### 2.3 質問2: 「過去7日間のメッセージで使用されたFAQのカテゴリ集計」のメッセージとは？

#### 2.3.1 メッセージの定義

**データモデル**: `backend/app/models/message.py`

```python:21:40:backend/app/models/message.py
class Message(Base):
    """
    メッセージモデル
    """
    __tablename__ = "messages"

    id = Column(Integer, primary_key=True, index=True)
    conversation_id = Column(Integer, ForeignKey("conversations.id", ondelete="CASCADE"), nullable=False, index=True)
    role = Column(String(20), nullable=False)  # 'user', 'assistant', 'system'
    content = Column(Text, nullable=False)
    ai_confidence = Column(DECIMAL(3, 2))  # 0.00-1.00
    matched_faq_ids = Column(ARRAY(Integer))  # 使用したFAQ IDリスト
    tokens_used = Column(Integer)
    response_time_ms = Column(Integer)
    created_at = Column(DateTime(timezone=True), server_default=func.now(), index=True)
```

**メッセージの種類**:
1. **ユーザーメッセージ** (`role='user'`): ゲストが送信した質問
2. **AI応答メッセージ** (`role='assistant'`): AIが生成した回答
3. **システムメッセージ** (`role='system'`): システムが生成したメッセージ

#### 2.3.2 グラフで使用されるメッセージ

**対象**: AI応答メッセージ（`role='assistant'`）で、`matched_faq_ids`がNULLでないもの

**意味**:
- AIがFAQを使って回答したメッセージ
- つまり、AIが生成した回答の中で、FAQを参照したもの

**質問数との違い**:
- **質問数**: ユーザーメッセージ（`role='user'`）の数
- **グラフのメッセージ**: AI応答メッセージ（`role='assistant'`）で、FAQを使用したもの

#### 2.3.3 回答

**「過去7日間のメッセージで使用されたFAQのカテゴリ集計」のメッセージとは**:
- **具体的には**: AI応答メッセージ（`role='assistant'`）で、`matched_faq_ids`がNULLでないもの
- **意味**: AIがFAQを使って回答したメッセージ
- **質問数ではない**: 質問数はユーザーメッセージ（`role='user'`）の数

**説明文の改善提案**:
現在の説明文「過去7日間のメッセージで使用されたFAQのカテゴリ集計」は誤解を招く可能性がある。
より正確な説明文:
- 「過去7日間のAI回答で使用されたFAQのカテゴリ集計」
- 「過去7日間のFAQ使用回数のカテゴリ別内訳」

---

### 2.4 質問3: 全て週次の情報なのではないのか？

#### 2.4.1 ダッシュボードの構成要素

**ファイル**: `frontend/src/views/admin/Dashboard.vue`

**構成**:
1. **週次サマリー統計カード**（過去7日間）
2. **カテゴリ別円グラフ**（過去7日間）
3. **リアルタイムチャット履歴**（最新10件、期間制限なし）
4. **夜間対応キュー**（未解決のもの、期間制限なし）
5. **ゲストフィードバック集計**（全期間）

#### 2.4.2 各要素の期間

**週次サマリー統計カード**:
- **期間**: 過去7日間（週次）
- **データソース**: `get_weekly_summary(facility_id)`

**カテゴリ別円グラフ**:
- **期間**: 過去7日間（週次）
- **データソース**: `summary.category_breakdown`（週次サマリーの一部）

**リアルタイムチャット履歴**:
- **期間**: 期間制限なし（最新10件）
- **データソース**: `get_recent_chat_history(facility_id, limit=10)`

**夜間対応キュー**:
- **期間**: 期間制限なし（未解決のもの）
- **データソース**: `get_overnight_queue(facility_id)`

**ゲストフィードバック集計**:
- **期間**: 全期間
- **データソース**: `get_feedback_stats(facility_id)`

#### 2.4.3 回答

**全て週次の情報ではありません**:
- **週次（過去7日間）**: 週次サマリー統計カード、カテゴリ別円グラフ
- **全期間**: リアルタイムチャット履歴、夜間対応キュー、ゲストフィードバック集計

**ページヘッダーの説明**:
「週次サマリーとリアルタイムチャット履歴」という説明は正確です：
- **週次サマリー**: 週次サマリー統計カード、カテゴリ別円グラフ
- **リアルタイムチャット履歴**: リアルタイムチャット履歴、夜間対応キュー、ゲストフィードバック集計

---

### 2.5 質問4: 総質問数とメッセージの違い

#### 2.5.1 総質問数

**定義**: 過去7日間のユーザーメッセージ（`role='user'`）の総数

**計算ロジック**:
```python:137:146:backend/app/services/dashboard_service.py
# メッセージを取得
messages_result = await self.db.execute(
    select(Message)
    .where(Message.conversation_id.in_(conversation_ids))
    .where(Message.role == MessageRole.USER.value)
)
messages = messages_result.scalars().all()

# 総質問数
total_questions = len(messages)
```

**意味**: ゲストが送信した質問の総数

#### 2.5.2 メッセージ

**定義**: 会話内のすべてのメッセージ（ユーザーメッセージ、AI応答メッセージ、システムメッセージ）

**種類**:
1. **ユーザーメッセージ** (`role='user'`): ゲストが送信した質問
2. **AI応答メッセージ** (`role='assistant'`): AIが生成した回答
3. **システムメッセージ** (`role='system'`): システムが生成したメッセージ

#### 2.5.3 違い

**総質問数**:
- **対象**: ユーザーメッセージ（`role='user'`）のみ
- **期間**: 過去7日間
- **意味**: ゲストが送信した質問の総数

**メッセージ**:
- **対象**: すべてのメッセージ（ユーザー、AI、システム）
- **期間**: 指定なし（文脈による）
- **意味**: 会話内のすべてのメッセージ

**関係**:
- 総質問数 = メッセージの一部（ユーザーメッセージのみ）
- メッセージ = 総質問数 + AI応答メッセージ + システムメッセージ

#### 2.5.4 回答

**総質問数とメッセージの違い**:
- **総質問数**: 過去7日間のユーザーメッセージ（`role='user'`）の総数
- **メッセージ**: 会話内のすべてのメッセージ（ユーザー、AI、システム）

**つまり**:
- 総質問数はメッセージの一部（ユーザーメッセージのみ）
- メッセージには、総質問数（ユーザーメッセージ）の他に、AI応答メッセージ、システムメッセージも含まれる

---

## 3. まとめ

### 3.1 質問への回答

1. **グラフとスコアは別なのですか？グラフは週次でスコアは総数なのですか？**
   - **回答**: グラフとスコアは別です。両方とも週次（過去7日間）のデータですが、集計対象が異なります。
   - **グラフ**: 過去7日間のAI応答メッセージで使用されたFAQのカテゴリを集計
   - **スコア**: 過去7日間のユーザーメッセージ（質問）の総数

2. **「過去7日間のメッセージで使用されたFAQのカテゴリ集計」のメッセージとは具体的に何を指していますか？質問数ではないのですか？**
   - **回答**: AI応答メッセージ（`role='assistant'`）で、`matched_faq_ids`がNULLでないもの。質問数ではありません。
   - **意味**: AIがFAQを使って回答したメッセージ

3. **FAQ管理ページのトップには「週次サマリーとリアルタイムチャット履歴」と記されてます。全て週次の情報なのではないのですか？**
   - **回答**: 全て週次の情報ではありません。
   - **週次（過去7日間）**: 週次サマリー統計カード、カテゴリ別円グラフ
   - **全期間**: リアルタイムチャット履歴、夜間対応キュー、ゲストフィードバック集計

4. **最初のカードには「総質問数」とありますが、これはメッセージとどう異なりますか？**
   - **回答**: 総質問数はメッセージの一部（ユーザーメッセージのみ）です。
   - **総質問数**: 過去7日間のユーザーメッセージ（`role='user'`）の総数
   - **メッセージ**: 会話内のすべてのメッセージ（ユーザー、AI、システム）

### 3.2 改善提案

1. **説明文の改善**:
   - カテゴリ別円グラフの説明文を「過去7日間のAI回答で使用されたFAQのカテゴリ集計」に変更

2. **用語の統一**:
   - 「メッセージ」と「質問」の使い分けを明確にする
   - ユーザーメッセージ = 質問
   - AI応答メッセージ = 回答

---

**次のステップ**: ユーザーの指示を待ちます。

