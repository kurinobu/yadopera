# ステージング環境データ表示問題 - 完全調査分析・修正案

**作成日時**: 2026年1月16日 12:48:00  
**目的**: ステージング環境でデータが表示されない問題の完全調査分析と修正案  
**状態**: 根本原因特定完了、修正案準備完了

---

## 1. 問題の説明

### 1.1 報告された問題

- **test31@example.com**: ログインしてもデータが表示されない（全て0）
- **test41@example.com**: ログインしてもデータが表示されない（全て0）、かつFreeプランと表示される（Miniプランであるべき）

### 1.2 現在の状況

- **ローカル環境（Docker）**: データが正しく存在し、APIも正常に動作している
- **ステージング環境（Render.com + Railway）**: データが表示されない

---

## 2. 原因の完全調査分析

### 2.1 根本原因の特定

#### 根本原因1: テストデータ作成スクリプトがローカル環境のデータベースにのみ接続している

**確認結果**:
- ローカル環境のデータベース（`postgresql://yadopera_user:yadopera_password@postgres:5432/yadopera`）にはデータが正しく存在
- ステージング環境のデータベース（Railway Hobby PostgreSQL）には接続していない

**証拠**:
- `docker-compose exec backend python` で実行したスクリプトは、`docker-compose.yml` で定義されたPostgreSQLに接続
- `settings.database_url` は `.env` ファイルまたは環境変数から読み込まれるが、Docker環境では `docker-compose.yml` の環境変数が優先される

**影響**:
- テストデータはローカル環境のデータベースにのみ挿入されている
- ステージング環境のデータベースにはテストデータが存在しない

---

#### 根本原因2: ステージング環境の既存データのプラン情報が正しく設定されていない

**確認結果**:
- 新規登録APIの修正はデプロイされているが、既存データ（test41@example.com）のプラン情報が修正されていない可能性

**影響**:
- test41@example.comがFreeプランとして表示される

---

#### 根本原因3: スクリプトが環境変数 `DATABASE_URL` を優先的に使用していない

**確認結果**:
- `create_staging_monthly_dashboard_test_data.py` は `settings.database_url` を直接使用
- 環境変数 `DATABASE_URL` を優先的に使用していない

**影響**:
- ステージング環境のデータベースURLを指定しても、ローカル環境のデータベースに接続してしまう

---

### 2.2 データベース接続の確認

**ローカル環境（Docker）**:
```
DATABASE_URL: postgresql://yadopera_user:yadopera_password@postgres:5432/yadopera
```

**ステージング環境（Railway Hobby PostgreSQL）**:
```
DATABASE_URL: postgresql://postgres:password@railway-host:port/database
（Render.comの環境変数から取得）
```

**問題**: スクリプトは常にローカル環境のデータベースに接続している

---

## 3. 修正案

### 3.1 修正案1: スクリプトを環境変数対応に修正（根本解決）

**方針**: テストデータ作成スクリプトと既存データ修正スクリプトを、環境変数 `DATABASE_URL` を優先的に使用するように修正

**実装内容**:

1. **`create_staging_monthly_dashboard_test_data.py`を修正**
   ```python
   import os
   
   # 環境変数DATABASE_URLを優先的に使用
   db_url = os.getenv('DATABASE_URL')
   if not db_url:
       from app.core.config import settings
       db_url = settings.database_url
   
   engine = create_async_engine(db_url.replace('postgresql://', 'postgresql+asyncpg://'))
   ```

2. **`fix_existing_facilities_plan_settings.py`を修正**
   - 同様に環境変数 `DATABASE_URL` を優先的に使用

**メリット**:
- ✅ 環境変数で接続先を切り替えられる
- ✅ ローカル環境とステージング環境の両方で使用可能
- ✅ デプロイ不要で即座に実行可能

**デメリット**:
- なし

---

### 3.2 修正案2: ステージング環境のデータベースに直接接続してテストデータを作成

**方針**: ステージング環境のデータベースURLを使用して、テストデータ作成スクリプトを実行

**実装内容**:

1. **ステージング環境のデータベースURLを取得**
   - Render.comの環境変数から `DATABASE_URL` を取得
   - または、Railway Hobby PostgreSQLの接続情報を直接使用

2. **環境変数を設定してスクリプトを実行**
   ```bash
   # ステージング環境のDATABASE_URLを環境変数に設定
   export DATABASE_URL="postgresql://postgres:password@railway-host:port/database"
   
   # スクリプトを実行
   docker-compose exec backend python /app/create_staging_monthly_dashboard_test_data.py
   ```

**メリット**:
- ✅ ステージング環境のデータベースに直接データを挿入できる
- ✅ デプロイ不要で即座に実行可能

**デメリット**:
- ⚠️ ステージング環境のデータベースURLが必要

---

### 3.3 修正案3: ステージング環境の既存データのプラン情報を修正

**方針**: ステージング環境のデータベースで、既存データのプラン情報を修正

**実装内容**:

1. **既存データ修正スクリプトを実行**
   ```bash
   # ステージング環境のDATABASE_URLを環境変数に設定
   export DATABASE_URL="postgresql://postgres:password@railway-host:port/database"
   
   # スクリプトを実行
   docker-compose exec backend python /app/fix_existing_facilities_plan_settings.py
   ```

**メリット**:
- ✅ 既存データのプラン情報を修正できる
- ✅ デプロイ不要で即座に実行可能

**デメリット**:
- ⚠️ ステージング環境のデータベースURLが必要

---

## 4. 推奨される修正手順

### 4.1 優先順位

1. **最優先**: 修正案1（スクリプトを環境変数対応に修正）
   - 根本解決
   - 今後も使用可能

2. **次優先**: 修正案2（ステージング環境のデータベースにテストデータを作成）
   - 即座にテストデータを準備

3. **補完的**: 修正案3（既存データのプラン情報を修正）
   - 既存データの整合性を確保

---

### 4.2 実装手順

1. **修正案1を実装**
   - `create_staging_monthly_dashboard_test_data.py`を修正
   - `fix_existing_facilities_plan_settings.py`を修正
   - コミット・プッシュ

2. **ステージング環境のデータベースURLを取得**
   - Render.comの環境変数から取得
   - または、Railway Hobby PostgreSQLの接続情報を取得

3. **修正案2を実行**
   - 環境変数 `DATABASE_URL` を設定
   - テストデータ作成スクリプトを実行

4. **修正案3を実行（必要に応じて）**
   - 既存データ修正スクリプトを実行

5. **動作確認**
   - ステージング環境でログイン
   - ダッシュボードでデータが表示されることを確認

---

## 5. デプロイの必要性

### 5.1 デプロイが必要な変更

**修正案1（スクリプトの修正）**: 
- ⚠️ **デプロイ不要**（スクリプトは実行時に使用されるため）

### 5.2 デプロイが不要な変更

**修正案2（テストデータ作成）**: 
- ✅ **デプロイ不要**（データベースへの直接操作）

**修正案3（既存データ修正）**: 
- ✅ **デプロイ不要**（データベースへの直接操作）

---

## 6. 結論

### 6.1 根本原因

**根本原因**: 
1. テストデータ作成スクリプトがローカル環境のデータベースにのみ接続している
2. ステージング環境のデータベースにはテストデータが存在しない
3. ステージング環境の既存データのプラン情報が正しく設定されていない

### 6.2 修正案

**最優先**: 修正案1（スクリプトを環境変数対応に修正）+ 修正案2（ステージング環境のデータベースにテストデータを作成）+ 修正案3（既存データのプラン情報を修正）

**期待される結果**: 
- ステージング環境のデータベースにテストデータが作成される
- 既存データのプラン情報が正しく設定される
- ブラウザテストを即座に開始できる

---

**Document Version**: v1.0  
**Author**: Auto (AI Assistant)  
**Last Updated**: 2026年1月16日 12:48:00  
**Status**: 原因調査完了、修正案準備完了

