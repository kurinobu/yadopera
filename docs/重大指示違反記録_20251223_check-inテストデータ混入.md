# é‡å¤§æŒ‡ç¤ºé•åè¨˜éŒ²: check-iné–¢é€£ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æ··å…¥

**ç™ºç”Ÿæ—¥æ™‚**: 2025å¹´12æœˆ23æ—¥  
**ç™ºè¦‹è€…**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆæº–å‚™ä¸­ï¼‰  
**é‡å¤§åº¦**: ğŸ”´ **æœ€å„ªå…ˆãƒ»é‡å¤§**  
**å½±éŸ¿ç¯„å›²**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã€é–‹ç™ºè€…ä¿¡é ¼æ€§ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå“è³ª

---

## 1. é•åå†…å®¹

### 1.1 ç™ºè¦‹ã•ã‚ŒãŸé•åãƒ‡ãƒ¼ã‚¿

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã€Œcheck-inã€é–¢é€£ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒæ··å…¥ã—ã¦ã„ãŸ**

- **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: 29ä»¶ï¼ˆè‹±èªãƒ»æ—¥æœ¬èªï¼‰
  - "What time is check-in?" (è‹±èª)
  - "ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã®æ™‚é–“ã¯ä½•æ™‚ã§ã™ã‹ï¼Ÿ" (æ—¥æœ¬èª)
  - "When can I check in?" (è‹±èª)
- **ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: 1ä»¶ï¼ˆæœªè§£æ±ºï¼‰
  - conversation_id: 5
  - trigger_type: low_confidence
  - ai_confidence: 0.50
- **FAQææ¡ˆ**: 1ä»¶
  - "ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã®æ™‚é–“ã¯ä½•æ™‚ã§ã™ã‹ï¼Ÿ"

**åˆè¨ˆ**: 31ä»¶ã®ç¦æ­¢ãƒ‡ãƒ¼ã‚¿ãŒæ··å…¥

### 1.2 å½±éŸ¿

1. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®ä½ä¸‹**
   - å®¿æ³Šæ–½è¨­ç®¡ç†è€…ãŒã€Œé–‹ç™ºè€…ã¯å®¿æ³Šæ¥­ã«ã¤ã„ã¦ç„¡çŸ¥ã€ã¨åˆ¤æ–­
   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®å“è³ªãŒç–‘ã‚ã‚Œã‚‹
   - é–‹ç™ºè€…ã¸ã®ä¿¡é ¼ãŒå¤±ã‚ã‚Œã‚‹

2. **ãƒ“ã‚¸ãƒã‚¹ã¸ã®å½±éŸ¿**
   - æ–½è¨­ç®¡ç†è€…ãŒé–‹ç™ºè€…ã‚’ä¿¡é ¼ã§ããªã„ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨åˆ¤æ–­
   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç¶™ç¶šæ€§ãŒå±ã¶ã¾ã‚Œã‚‹

3. **æŠ€è¡“çš„å½±éŸ¿**
   - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã€Œcheck-inã€é–¢é€£ã®æœªè§£æ±ºè³ªå•ãŒè¡¨ç¤ºã•ã‚Œã‚‹
   - ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆã«ä¸é©åˆ‡ãªãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã‚‹

---

## 2. åŸå› åˆ†æ

### 2.1 ç›´æ¥åŸå› 

1. **æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®æ®‹å­˜**
   - éå»ã«ä½œæˆã•ã‚ŒãŸãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆ2025å¹´12æœˆ1æ—¥ã€œ12æœˆ20æ—¥ï¼‰ãŒå‰Šé™¤ã•ã‚Œãšã«æ®‹ã£ã¦ã„ãŸ
   - ç‰¹ã«ä»¥ä¸‹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã§ä½œæˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿:
     - `test-session-unresolved-1`
     - `test-session-category-basic-1`
     - `test-session-category-basic-2`
     - `test-session-category-basic-3`
     - ãã®ä»–ã€æ‰‹å‹•ã§ä½œæˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿

2. **å‰Šé™¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä¸å®Ÿè¡Œ**
   - `delete_checkin_data.py`ãŒå®šæœŸçš„ã«å®Ÿè¡Œã•ã‚Œã¦ã„ãªã‹ã£ãŸ
   - ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆå‰ã«æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ãŒè¡Œã‚ã‚Œã¦ã„ãªã‹ã£ãŸ

3. **æ¤œè¨¼æ©Ÿèƒ½ã®ä¸ååˆ†ãªé©ç”¨**
   - ç¾åœ¨ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã¯æ¤œè¨¼æ©Ÿèƒ½ãŒã‚ã‚‹ãŒã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ãŒä¸ååˆ†ã ã£ãŸ
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¬ãƒ™ãƒ«ã§ã®åˆ¶ç´„ãŒãªã„

### 2.2 æ ¹æœ¬åŸå› 

1. **å†ç™ºé˜²æ­¢ç­–ã®ä¸å‚™**
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¬ãƒ™ãƒ«ã§ã®åˆ¶ç´„ãŒãªã„
   - è‡ªå‹•å‰Šé™¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®šæœŸå®Ÿè¡Œã•ã‚Œã¦ã„ãªã„
   - ã‚³ãƒŸãƒƒãƒˆå‰ãƒ•ãƒƒã‚¯ãŒãªã„
   - CI/CDã§ã®æ¤œè¨¼ãŒãªã„
   - è¤‡æ•°ã®æ¤œè¨¼ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒãªã„

2. **ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†ã®ä¸å‚™**
   - ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆå‰ã®æ—¢å­˜ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ãŒå¿…é ˆåŒ–ã•ã‚Œã¦ã„ãªã„
   - å‰Šé™¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡ŒãŒæ‰‹å‹•ã«ä¾å­˜ã—ã¦ã„ã‚‹
   - å‰Šé™¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡ŒçµæœãŒè¨˜éŒ²ã•ã‚Œã¦ã„ãªã„

3. **ç›£è¦–ãƒ»æ¤œå‡ºæ©Ÿèƒ½ã®ä¸å‚™**
   - ç¦æ­¢ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•æ¤œå‡ºæ©Ÿèƒ½ãŒãªã„
   - å®šæœŸçš„ãªç›£æŸ»ãŒè¡Œã‚ã‚Œã¦ã„ãªã„
   - ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½ãŒãªã„

---

## 3. å¯¾å¿œå†…å®¹

### 3.1 å³åº§å¯¾å¿œï¼ˆå®Œäº†ï¼‰

1. **ç¦æ­¢ãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨å‰Šé™¤**
   - `delete_checkin_data.py`ã‚’å®Ÿè¡Œã—ã€31ä»¶ã®ç¦æ­¢ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
   - å‰Šé™¤å†…å®¹:
     - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: 29ä»¶
     - FAQææ¡ˆ: 1ä»¶
     - ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: 1ä»¶
     - åˆè¨ˆ: 31ä»¶

2. **å‰Šé™¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä¿®æ­£**
   - `delete_checkin_data.py`ã‚’ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆãƒ™ãƒ¼ã‚¹æ§‹é€ ã«å¯¾å¿œ
   - FAQå‰Šé™¤å‡¦ç†ã‚’`FAQTranslation`çµŒç”±ã«å¤‰æ›´

3. **å‰Šé™¤çµæœã®ç¢ºèª**
   - æ®‹å­˜ãƒ‡ãƒ¼ã‚¿: 0ä»¶ï¼ˆç¢ºèªæ¸ˆã¿ï¼‰
   - æ®‹å­˜ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: 0ä»¶ï¼ˆç¢ºèªæ¸ˆã¿ï¼‰

### 3.2 å†ç™ºé˜²æ­¢ç­–ã®å¼·åŒ–ï¼ˆå®Ÿæ–½äºˆå®šï¼‰

**ç¾åœ¨ã®å†ç™ºé˜²æ­¢ç­–ã‚’10å€ä»¥ä¸Šå …ç‰¢ã«ã™ã‚‹**

1. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¬ãƒ™ãƒ«ã§ã®åˆ¶ç´„è¿½åŠ **
   - ãƒˆãƒªã‚¬ãƒ¼é–¢æ•°ã§ç¦æ­¢ç”¨èªã‚’æ¤œå‡º
   - ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆæ™‚ã®è‡ªå‹•æ¤œè¨¼

2. **è¤‡æ•°ã®æ¤œè¨¼ãƒ¬ã‚¤ãƒ¤ãƒ¼**
   - ãƒ¬ã‚¤ãƒ¤ãƒ¼1: ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ™ãƒ«ï¼ˆ`validate_test_data_question()`ï¼‰
   - ãƒ¬ã‚¤ãƒ¤ãƒ¼2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¬ãƒ™ãƒ«ï¼ˆãƒˆãƒªã‚¬ãƒ¼é–¢æ•°ï¼‰
   - ãƒ¬ã‚¤ãƒ¤ãƒ¼3: ã‚³ãƒŸãƒƒãƒˆå‰ãƒ•ãƒƒã‚¯ï¼ˆpre-commit hookï¼‰
   - ãƒ¬ã‚¤ãƒ¤ãƒ¼4: CI/CDã§ã®æ¤œè¨¼
   - ãƒ¬ã‚¤ãƒ¤ãƒ¼5: å®šæœŸç›£æŸ»ï¼ˆcron jobï¼‰

3. **è‡ªå‹•å‰Šé™¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®šæœŸå®Ÿè¡Œ**
   - ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆå‰ã«è‡ªå‹•å®Ÿè¡Œ
   - å®šæœŸç›£æŸ»ï¼ˆæ¯æ—¥å®Ÿè¡Œï¼‰
   - å®Ÿè¡Œçµæœã®ãƒ­ã‚°è¨˜éŒ²

4. **ç›£è¦–ãƒ»æ¤œå‡ºæ©Ÿèƒ½ã®è¿½åŠ **
   - ç¦æ­¢ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•æ¤œå‡º
   - ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½
   - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã®è¡¨ç¤º

5. **ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†ã®å¼·åŒ–**
   - ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆå‰ã®æ—¢å­˜ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚’å¿…é ˆåŒ–
   - å‰Šé™¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œã‚’è‡ªå‹•åŒ–
   - å®Ÿè¡Œçµæœã®è¨˜éŒ²ã¨é€šçŸ¥

---

## 4. å†ç™ºé˜²æ­¢ç­–ã®è©³ç´°

### 4.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¬ãƒ™ãƒ«ã§ã®åˆ¶ç´„ï¼ˆæ–°è¦è¿½åŠ ï¼‰

**ãƒˆãƒªã‚¬ãƒ¼é–¢æ•°ã§ç¦æ­¢ç”¨èªã‚’æ¤œå‡º**

```sql
-- ç¦æ­¢ç”¨èªæ¤œå‡ºãƒˆãƒªã‚¬ãƒ¼é–¢æ•°
CREATE OR REPLACE FUNCTION check_forbidden_patterns()
RETURNS TRIGGER AS $$
DECLARE
    forbidden_patterns TEXT[] := ARRAY[
        'check-in', 'ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³', 'checkin',
        'Check-in', 'Check-In', 'CHECK-IN',
        'check in', 'Check In', 'CHECK IN'
    ];
    content_lower TEXT;
    pattern TEXT;
BEGIN
    -- messagesãƒ†ãƒ¼ãƒ–ãƒ«ã®å ´åˆ
    IF TG_TABLE_NAME = 'messages' THEN
        content_lower := LOWER(NEW.content);
        FOREACH pattern IN ARRAY forbidden_patterns LOOP
            IF content_lower LIKE '%' || LOWER(pattern) || '%' THEN
                -- ã€Œcheckoutã€ã€Œcheckingã€ãªã©ã¯é™¤å¤–
                IF content_lower NOT LIKE '%checkout%' 
                   AND content_lower NOT LIKE '%checking%' THEN
                    RAISE EXCEPTION 'ç¦æ­¢ç”¨èªãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ: % (ãƒ‘ã‚¿ãƒ¼ãƒ³: %)', NEW.content, pattern;
                END IF;
            END IF;
        END LOOP;
    END IF;
    
    -- faq_translationsãƒ†ãƒ¼ãƒ–ãƒ«ã®å ´åˆ
    IF TG_TABLE_NAME = 'faq_translations' THEN
        content_lower := LOWER(NEW.question || ' ' || NEW.answer);
        FOREACH pattern IN ARRAY forbidden_patterns LOOP
            IF content_lower LIKE '%' || LOWER(pattern) || '%' THEN
                IF content_lower NOT LIKE '%checkout%' 
                   AND content_lower NOT LIKE '%checking%' THEN
                    RAISE EXCEPTION 'ç¦æ­¢ç”¨èªãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ: % (ãƒ‘ã‚¿ãƒ¼ãƒ³: %)', NEW.question, pattern;
                END IF;
            END IF;
        END LOOP;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ãƒˆãƒªã‚¬ãƒ¼ã®ä½œæˆï¼ˆãƒ†ã‚¹ãƒˆæ–½è¨­ã®ã¿ï¼‰
CREATE TRIGGER check_forbidden_patterns_messages
    BEFORE INSERT OR UPDATE ON messages
    FOR EACH ROW
    WHEN (
        EXISTS (
            SELECT 1 FROM conversations c
            WHERE c.id = NEW.conversation_id
            AND c.facility_id IN (
                SELECT id FROM facilities WHERE slug = 'test-facility'
            )
        )
    )
    EXECUTE FUNCTION check_forbidden_patterns();

CREATE TRIGGER check_forbidden_patterns_faq_translations
    BEFORE INSERT OR UPDATE ON faq_translations
    FOR EACH ROW
    WHEN (
        EXISTS (
            SELECT 1 FROM faqs f
            WHERE f.id = NEW.faq_id
            AND f.facility_id IN (
                SELECT id FROM facilities WHERE slug = 'test-facility'
            )
        )
    )
    EXECUTE FUNCTION check_forbidden_patterns();
```

### 4.2 ã‚³ãƒŸãƒƒãƒˆå‰ãƒ•ãƒƒã‚¯ï¼ˆæ–°è¦è¿½åŠ ï¼‰

**`.git/hooks/pre-commit`ã«è¿½åŠ **

```bash
#!/bin/bash
# check-iné–¢é€£ã®ç¦æ­¢ç”¨èªã‚’æ¤œå‡º
FORBIDDEN_PATTERNS=(
    "check-in"
    "ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³"
    "checkin"
    "Check-in"
    "Check-In"
    "CHECK-IN"
    "check in"
    "Check In"
    "CHECK IN"
)

# ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

for file in $STAGED_FILES; do
    # Pythonãƒ•ã‚¡ã‚¤ãƒ«ã¨Markdownãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ãƒã‚§ãƒƒã‚¯
    if [[ "$file" == *.py ]] || [[ "$file" == *.md ]]; then
        for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
            if git diff --cached "$file" | grep -qi "$pattern"; then
                echo "âŒ ã‚¨ãƒ©ãƒ¼: ç¦æ­¢ç”¨èªã€Œ$patternã€ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ: $file"
                echo "   ã“ã®ç”¨èªã¯ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã“ã¨ã¯çµ¶å¯¾ã«ç¦æ­¢ã§ã™ã€‚"
                echo "   ç†ç”±: ã“ã®ã‚¢ãƒ—ãƒªã¯ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ¸ˆã¿ã®ã‚²ã‚¹ãƒˆãŒä½¿ç”¨ã™ã‚‹ãŸã‚ã€"
                echo "         ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ™‚é–“ã‚’èãè³ªå•ã¯ç¾å®Ÿçš„ã§ãªã„"
                exit 1
            fi
        done
    fi
done

exit 0
```

### 4.3 CI/CDã§ã®æ¤œè¨¼ï¼ˆæ–°è¦è¿½åŠ ï¼‰

**`.github/workflows/check-forbidden-patterns.yml`ã‚’ä½œæˆ**

```yaml
name: Check Forbidden Patterns

on:
  pull_request:
    paths:
      - 'backend/**/*.py'
      - 'backend/**/*.md'
  push:
    branches:
      - develop
      - main

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Check for forbidden patterns
        run: |
          FORBIDDEN_PATTERNS=(
            "check-in"
            "ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³"
            "checkin"
            "Check-in"
            "Check-In"
            "CHECK-IN"
            "check in"
            "Check In"
            "CHECK IN"
          )
          
          for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
            if grep -r -i "$pattern" backend/ --include="*.py" --include="*.md" | grep -v "FORBIDDEN_PATTERNS" | grep -v "validate_test_data" | grep -v "delete_checkin_data" | grep -v "check_checkin_data"; then
              echo "âŒ ã‚¨ãƒ©ãƒ¼: ç¦æ­¢ç”¨èªã€Œ$patternã€ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
              exit 1
            fi
          done
          
          echo "âœ… ç¦æ­¢ç”¨èªã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
```

### 4.4 å®šæœŸç›£æŸ»ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆæ–°è¦è¿½åŠ ï¼‰

**`backend/audit_checkin_data.py`ã‚’ä½œæˆ**

```python
"""
å®šæœŸç›£æŸ»ã‚¹ã‚¯ãƒªãƒ—ãƒˆ: check-iné–¢é€£ãƒ‡ãƒ¼ã‚¿ã®æ¤œå‡ºã¨ã‚¢ãƒ©ãƒ¼ãƒˆ
æ¯æ—¥å®Ÿè¡Œã•ã‚Œã€ç¦æ­¢ãƒ‡ãƒ¼ã‚¿ãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã¯ã‚¢ãƒ©ãƒ¼ãƒˆã‚’é€ä¿¡
"""
import asyncio
import sys
import os
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.orm import sessionmaker
from sqlalchemy import select, func
from app.core.config import settings
from app.models.facility import Facility
from app.models.conversation import Conversation
from app.models.message import Message, MessageRole
from app.models.faq_translation import FAQTranslation
from app.models.faq_suggestion import FAQSuggestion
from app.models.escalation import Escalation

FORBIDDEN_PATTERNS = [
    "check-in", "ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³", "checkin",
    "Check-in", "Check-In", "CHECK-IN",
    "check in", "Check In", "CHECK IN"
]

async def audit_checkin_data():
    """check-iné–¢é€£ãƒ‡ãƒ¼ã‚¿ã®å®šæœŸç›£æŸ»"""
    database_url = os.getenv("DATABASE_URL") or settings.database_url
    if database_url.startswith("postgresql://"):
        database_url = database_url.replace("postgresql://", "postgresql+asyncpg://", 1)
    
    engine = create_async_engine(database_url, echo=False)
    async_session = sessionmaker(engine, class_=AsyncSession, expire_on_commit=False)
    
    async with async_session() as session:
        # ãƒ†ã‚¹ãƒˆæ–½è¨­ã‚’å–å¾—
        result = await session.execute(
            select(Facility).where(Facility.slug == "test-facility")
        )
        test_facility = result.scalar_one_or_none()
        
        if not test_facility:
            print("âŒ ã‚¨ãƒ©ãƒ¼: ãƒ†ã‚¹ãƒˆæ–½è¨­ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
            sys.exit(1)
        
        violations = []
        
        # 1. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ¤œå‡º
        for pattern in FORBIDDEN_PATTERNS:
            messages_result = await session.execute(
                select(Message).join(Conversation).where(
                    Conversation.facility_id == test_facility.id,
                    Message.content.ilike(f"%{pattern}%")
                )
            )
            messages = messages_result.scalars().all()
            if messages:
                violations.append({
                    "type": "messages",
                    "count": len(messages),
                    "pattern": pattern
                })
        
        # 2. FAQææ¡ˆã®æ¤œå‡º
        for pattern in FORBIDDEN_PATTERNS:
            suggestions_result = await session.execute(
                select(FAQSuggestion).where(
                    FAQSuggestion.facility_id == test_facility.id,
                    FAQSuggestion.suggested_question.ilike(f"%{pattern}%")
                )
            )
            suggestions = suggestions_result.scalars().all()
            if suggestions:
                violations.append({
                    "type": "faq_suggestions",
                    "count": len(suggestions),
                    "pattern": pattern
                })
        
        # 3. FAQç¿»è¨³ã®æ¤œå‡º
        for pattern in FORBIDDEN_PATTERNS:
            translations_result = await session.execute(
                select(FAQTranslation).join(FAQ).where(
                    FAQ.facility_id == test_facility.id,
                    FAQTranslation.question.ilike(f"%{pattern}%")
                )
            )
            translations = translations_result.scalars().all()
            if translations:
                violations.append({
                    "type": "faq_translations",
                    "count": len(translations),
                    "pattern": pattern
                })
        
        # 4. ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æ¤œå‡º
        escalations_result = await session.execute(
            select(Escalation).join(Conversation).where(
                Escalation.facility_id == test_facility.id,
                Escalation.resolved_at.is_(None)
            )
        )
        escalations = escalations_result.scalars().all()
        
        checkin_escalations = []
        for escalation in escalations:
            if not escalation.conversation:
                continue
            first_user_message_result = await session.execute(
                select(Message).where(
                    Message.conversation_id == escalation.conversation.id,
                    Message.role == MessageRole.USER.value
                ).order_by(Message.created_at.asc()).limit(1)
            )
            first_user_message = first_user_message_result.scalar_one_or_none()
            if first_user_message:
                content_lower = first_user_message.content.lower()
                is_checkin_related = any(
                    pattern.lower() in content_lower 
                    for pattern in FORBIDDEN_PATTERNS
                )
                if is_checkin_related:
                    checkin_escalations.append(escalation)
        
        if checkin_escalations:
            violations.append({
                "type": "escalations",
                "count": len(checkin_escalations)
            })
        
        # çµæœã®å ±å‘Š
        if violations:
            print("âŒâŒâŒ é‡å¤§é•å: check-iné–¢é€£ãƒ‡ãƒ¼ã‚¿ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼âŒâŒâŒ")
            for violation in violations:
                print(f"  - {violation['type']}: {violation['count']}ä»¶")
                if 'pattern' in violation:
                    print(f"    ãƒ‘ã‚¿ãƒ¼ãƒ³: {violation['pattern']}")
            print("\nå³åº§ã«delete_checkin_data.pyã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼")
            sys.exit(1)
        else:
            print("âœ… ç›£æŸ»å®Œäº†: check-iné–¢é€£ãƒ‡ãƒ¼ã‚¿ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ")
    
    await engine.dispose()

if __name__ == "__main__":
    asyncio.run(audit_checkin_data())
```

### 4.5 ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆå‰ã®è‡ªå‹•å‰Šé™¤ï¼ˆå¼·åŒ–ï¼‰

**`create_test_data.py`ã¨`create_staging_test_data.py`ã‚’ä¿®æ­£**

```python
# ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆå‰ã«å¿…ãšæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
print("\nğŸ—‘ï¸ æ—¢å­˜ã®ã€Œcheck-inã€é–¢é€£ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨å‰Šé™¤ä¸­...")
from delete_checkin_data import delete_checkin_data
await delete_checkin_data()
print("  âœ… æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ãŒå®Œäº†ã—ã¾ã—ãŸ\n")
```

---

## 5. å®Ÿæ–½ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

1. **å³åº§å¯¾å¿œï¼ˆå®Œäº†ï¼‰**: 2025å¹´12æœˆ23æ—¥
   - ç¦æ­¢ãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨å‰Šé™¤
   - å‰Šé™¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä¿®æ­£

2. **å†ç™ºé˜²æ­¢ç­–ã®å®Ÿè£…ï¼ˆå®Ÿæ–½äºˆå®šï¼‰**: 2025å¹´12æœˆ23æ—¥
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¬ãƒ™ãƒ«ã§ã®åˆ¶ç´„è¿½åŠ 
   - ã‚³ãƒŸãƒƒãƒˆå‰ãƒ•ãƒƒã‚¯ã®è¿½åŠ 
   - CI/CDã§ã®æ¤œè¨¼ã®è¿½åŠ 
   - å®šæœŸç›£æŸ»ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆ
   - ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆå‰ã®è‡ªå‹•å‰Šé™¤ã®å¼·åŒ–

---

## 6. æ•™è¨“

1. **å†ç™ºé˜²æ­¢ç­–ã¯è¤‡æ•°ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§å®Ÿè£…ã™ã‚‹**
   - ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ™ãƒ«ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¬ãƒ™ãƒ«ã€CI/CDãƒ¬ãƒ™ãƒ«ã€å®šæœŸç›£æŸ»ãƒ¬ãƒ™ãƒ«

2. **è‡ªå‹•åŒ–ã‚’å¾¹åº•ã™ã‚‹**
   - æ‰‹å‹•å®Ÿè¡Œã«ä¾å­˜ã—ãªã„
   - è‡ªå‹•æ¤œå‡ºã€è‡ªå‹•å‰Šé™¤ã€è‡ªå‹•ã‚¢ãƒ©ãƒ¼ãƒˆ

3. **ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†ã‚’å¼·åŒ–ã™ã‚‹**
   - ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆå‰ã®æ—¢å­˜ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚’å¿…é ˆåŒ–
   - å®Ÿè¡Œçµæœã®è¨˜éŒ²ã¨é€šçŸ¥

4. **ç›£è¦–ãƒ»æ¤œå‡ºæ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹**
   - å®šæœŸçš„ãªç›£æŸ»
   - ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½
   - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã®è¡¨ç¤º

---

## 7. æ‰¿èª

- **ä½œæˆè€…**: AI Assistant
- **æ‰¿èªè€…**: ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªå¾…ã¡ï¼‰
- **æœ€çµ‚æ›´æ–°**: 2025å¹´12æœˆ23æ—¥

