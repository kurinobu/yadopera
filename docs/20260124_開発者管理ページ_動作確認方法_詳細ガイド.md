# 開発者管理ページ 動作確認方法 詳細ガイド

**作成日**: 2026年1月24日  
**対象**: ステージング環境テスト  
**状態**: ✅ **動作確認方法説明**

---

## 1. システムヘルスチェックの動作確認方法

### 1.1 確認手順

**ステップ1: システムヘルスページにアクセス**

1. 開発者としてログイン済みの状態で、以下のURLにアクセス：
   ```
   https://yadopera-frontend-staging.onrender.com/developer/health
   ```

**ステップ2: 表示内容の確認**

以下の3つのコンポーネントが表示されることを確認：

1. **データベース接続状態**
   - ステータス: "healthy" または "unhealthy"
   - 応答時間: 数値（ミリ秒単位）
   - エラーメッセージ: エラーがある場合のみ表示

2. **Redis接続状態**
   - ステータス: "healthy" または "unhealthy"
   - 応答時間: 数値（ミリ秒単位）
   - エラーメッセージ: エラーがある場合のみ表示

3. **OpenAI API接続状態**
   - ステータス: "healthy" または "unhealthy"
   - 応答時間: 数値（ミリ秒単位）
   - エラーメッセージ: エラーがある場合のみ表示

### 1.2 期待される結果

**正常な場合**:
- データベース: "healthy"（緑色表示）
- Redis: "healthy"（緑色表示）
- OpenAI API: "healthy"（緑色表示）
- 各サービスの応答時間が表示される（通常は100ms〜500ms程度）

**異常な場合**:
- いずれかのサービスが "unhealthy"（赤色表示）
- エラーメッセージが表示される
- 応答時間が表示されない、または非常に長い

### 1.3 トラブルシューティング

**データベースが "unhealthy" の場合**:
- Render.comの環境変数`DATABASE_URL`が正しく設定されているか確認
- Railway PostgreSQLサービスが正常稼働しているか確認

**Redisが "unhealthy" の場合**:
- Render.comの環境変数`REDIS_URL`が正しく設定されているか確認
- Railway Redisサービスが正常稼働しているか確認

**OpenAI APIが "unhealthy" の場合**:
- Render.comの環境変数`OPENAI_API_KEY`が正しく設定されているか確認
- APIキーが有効か確認

### 1.4 API直接テスト（オプション）

ブラウザの開発者ツールのコンソールで以下を実行：

```javascript
// ログインしてトークンを取得
const response = await fetch('https://yadopera-backend-staging.onrender.com/api/v1/developer/auth/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ password: 'YOUR_PASSWORD' })
});
const { access_token } = await response.json();

// システムヘルスチェックAPIを呼び出し
const healthResponse = await fetch('https://yadopera-backend-staging.onrender.com/api/v1/developer/health/system', {
  headers: { 'Authorization': `Bearer ${access_token}` }
});
const health = await healthResponse.json();
console.log(health);
```

---

## 2. 未認証で保護されたページにアクセスできないことの確認方法

### 2.1 確認手順

**ステップ1: ログアウト状態にする**

1. 開発者としてログインしている状態から、ログアウトボタンをクリック
2. または、ブラウザの開発者ツールで以下を実行：
   ```javascript
   localStorage.removeItem('developer_token');
   window.location.href = '/developer/login';
   ```

**ステップ2: 保護されたページに直接アクセス**

ログアウト状態で、以下のURLに直接アクセス（ブラウザのアドレスバーに入力）：

1. **ダッシュボードページ**:
   ```
   https://yadopera-frontend-staging.onrender.com/developer/dashboard
   ```

2. **エラーログページ**:
   ```
   https://yadopera-frontend-staging.onrender.com/developer/errors
   ```

3. **システムヘルスページ**:
   ```
   https://yadopera-frontend-staging.onrender.com/developer/health
   ```

**ステップ3: リダイレクトの確認**

各ページにアクセスした際に、以下の動作を確認：

1. **自動的にログインページにリダイレクトされる**
   - URLが `/developer/login` に変わる
   - ログインページが表示される

2. **リダイレクトクエリパラメータの確認**（オプション）
   - URLに `?redirect=/developer/dashboard` などのクエリパラメータが付与される
   - ログイン後、元のページに戻れる

### 2.2 期待される結果

**正常な場合**:
- 保護されたページに直接アクセスできない
- 自動的にログインページ（`/developer/login`）にリダイレクトされる
- ログインページが表示される
- エラーメッセージは表示されない（または適切なメッセージが表示される）

**異常な場合**:
- 保護されたページが表示される（認証チェックが機能していない）
- エラーページが表示される（リダイレクトが機能していない）

### 2.3 ブラウザの開発者ツールで確認

**ネットワークタブで確認**:
1. ブラウザの開発者ツールを開く（F12）
2. 「Network」タブを開く
3. 保護されたページにアクセス
4. 以下のリクエストを確認：
   - 最初のリクエスト: 保護されたページへのアクセス（例: `/developer/dashboard`）
   - ステータスコード: `302`（リダイレクト）または `401`（認証エラー）
   - リダイレクト先: `/developer/login`

**コンソールタブで確認**:
- エラーメッセージが表示されないことを確認
- 認証エラーが適切に処理されていることを確認

### 2.4 手動テスト手順

1. **新しいプライベートウィンドウ（シークレットモード）を開く**
   - Chrome: `Ctrl+Shift+N` (Windows) / `Cmd+Shift+N` (Mac)
   - Firefox: `Ctrl+Shift+P` (Windows) / `Cmd+Shift+P` (Mac)
   - Safari: `Cmd+Shift+N`

2. **保護されたページに直接アクセス**
   ```
   https://yadopera-frontend-staging.onrender.com/developer/dashboard
   ```

3. **ログインページにリダイレクトされることを確認**

4. **ログイン後、元のページに戻れることを確認**

---

## 3. トークン期限切れで自動ログアウトされることの確認方法

### 3.1 確認手順（方法1: ブラウザの開発者ツールを使用）

**ステップ1: ログインしてトークンを確認**

1. 開発者としてログイン
2. ブラウザの開発者ツールを開く（F12）
3. 「Application」タブ（Chrome）または「Storage」タブ（Firefox）を開く
4. 「Local Storage」→ `https://yadopera-frontend-staging.onrender.com` を選択
5. `developer_token` の値を確認

**ステップ2: トークンの有効期限を確認**

ブラウザのコンソールで以下を実行：

```javascript
// トークンを取得
const token = localStorage.getItem('developer_token');

// トークンをデコード（JWTのペイロード部分を取得）
const payload = JSON.parse(atob(token.split('.')[1]));

// 有効期限を確認
const expiryDate = new Date(payload.exp * 1000);
console.log('トークン有効期限:', expiryDate);
console.log('現在時刻:', new Date());
console.log('期限切れまで:', Math.floor((expiryDate - new Date()) / 1000 / 60), '分');
```

**ステップ3: トークンの有効期限を手動で変更（テスト用）**

ブラウザのコンソールで以下を実行：

```javascript
// トークンを取得
const token = localStorage.getItem('developer_token');

// トークンをデコード
const parts = token.split('.');
const header = JSON.parse(atob(parts[0]));
const payload = JSON.parse(atob(parts[1]));

// 有効期限を過去の日時に変更（テスト用）
payload.exp = Math.floor(Date.now() / 1000) - 3600; // 1時間前

// トークンを再エンコード（注意: 署名が無効になるため、実際のAPI呼び出しは失敗します）
const newPayload = btoa(JSON.stringify(payload));
const newToken = `${parts[0]}.${newPayload}.${parts[2]}`;

// ローカルストレージに保存
localStorage.setItem('developer_token', newToken);

// ページをリロード
window.location.reload();
```

**ステップ4: 自動ログアウトの確認**

1. ページをリロード
2. 自動的にログインページにリダイレクトされることを確認
3. `localStorage.getItem('developer_token')` が `null` であることを確認

### 3.2 確認手順（方法2: 実際の有効期限を待つ）

**ステップ1: ログイン**

1. 開発者としてログイン
2. トークンの有効期限を確認（上記の方法1のステップ2を参照）

**ステップ2: 有効期限まで待つ**

- デフォルトの有効期限: 24時間
- テスト用に短い有効期限を設定する場合は、Render.comの環境変数`DEVELOPER_SESSION_EXPIRE_HOURS`を変更（例: `1` = 1時間）

**ステップ3: 有効期限後にページをリロード**

1. 有効期限が過ぎた後、ページをリロード（F5）
2. 自動的にログインページにリダイレクトされることを確認

### 3.3 確認手順（方法3: API呼び出しで確認）

**ステップ1: 有効期限切れトークンでAPIを呼び出す**

ブラウザのコンソールで以下を実行：

```javascript
// 期限切れトークンを取得（方法1で作成したもの）
const expiredToken = localStorage.getItem('developer_token');

// APIを呼び出す
fetch('https://yadopera-backend-staging.onrender.com/api/v1/developer/stats/overview', {
  headers: {
    'Authorization': `Bearer ${expiredToken}`
  }
})
.then(response => {
  if (response.status === 401) {
    console.log('✅ トークン期限切れが正しく検出されました');
    // 自動的にログアウト処理が実行される
  } else {
    console.log('❌ トークン期限切れが検出されませんでした');
  }
});
```

### 3.4 期待される結果

**正常な場合**:
- トークン期限切れ時に自動的にログアウトされる
- ログインページ（`/developer/login`）にリダイレクトされる
- `localStorage`から`developer_token`が削除される
- エラーメッセージは表示されない（または適切なメッセージが表示される）

**異常な場合**:
- トークン期限切れでもログイン状態が維持される
- エラーメッセージが表示されるが、ログアウトされない

### 3.5 トラブルシューティング

**トークン期限切れが検出されない場合**:
1. ブラウザの開発者ツールでコンソールエラーを確認
2. `frontend/src/utils/developerAuth.ts`の`isDeveloperTokenExpired()`関数が正しく動作しているか確認
3. `frontend/src/stores/developer.ts`の`isAuthenticated` computedプロパティが正しく動作しているか確認

**自動ログアウトされない場合**:
1. `frontend/src/utils/developerAuth.ts`の`logoutDeveloper()`関数が正しく動作しているか確認
2. ルーターの認証ガードが正しく動作しているか確認

---

## 4. 動作確認チェックリスト

### 4.1 システムヘルスチェック

- [ ] システムヘルスページにアクセスできる
- [ ] データベース接続状態が表示される
- [ ] Redis接続状態が表示される
- [ ] OpenAI API接続状態が表示される
- [ ] 各サービスのステータスが "healthy" である
- [ ] 応答時間が表示される

### 4.2 未認証アクセス保護

- [ ] ログアウト状態でダッシュボードにアクセスできない
- [ ] ログアウト状態でエラーログページにアクセスできない
- [ ] ログアウト状態でシステムヘルスページにアクセスできない
- [ ] 自動的にログインページにリダイレクトされる
- [ ] リダイレクトクエリパラメータが付与される（オプション）

### 4.3 トークン期限切れ処理

- [ ] トークン期限切れ時に自動ログアウトされる
- [ ] ログインページにリダイレクトされる
- [ ] `localStorage`からトークンが削除される
- [ ] エラーメッセージが適切に表示される（または表示されない）

---

## 5. テスト実行のヒント

### 5.1 ブラウザの開発者ツールの活用

- **Console**: JavaScriptエラーやログを確認
- **Network**: APIリクエストのステータスコードを確認
- **Application/Storage**: LocalStorageの内容を確認・編集
- **Elements**: HTMLの構造を確認

### 5.2 テスト用の便利なコマンド

ブラウザのコンソールで実行できる便利なコマンド：

```javascript
// トークンの有効期限を確認
const token = localStorage.getItem('developer_token');
if (token) {
  const payload = JSON.parse(atob(token.split('.')[1]));
  console.log('有効期限:', new Date(payload.exp * 1000));
} else {
  console.log('トークンが存在しません');
}

// 強制的にログアウト
localStorage.removeItem('developer_token');
window.location.href = '/developer/login';

// 現在の認証状態を確認
const store = useDeveloperStore();
console.log('認証状態:', store.isAuthenticated);
```

---

**Document Version**: v1.0  
**Author**: Auto (AI Assistant)  
**Last Updated**: 2026年1月24日  
**Status**: ✅ **動作確認方法説明完了**

