# Phase 1・Phase 2: ビルドキャッシュクリア、再デプロイ、バンドル確認手順

**作成日時**: 2025年12月19日 23時18分41秒
**実施者**: AI Assistant
**目的**: Render.comでのビルドキャッシュクリア、再デプロイ、デプロイ後のJavaScriptバンドル確認の手順

---

## 1. Render.comでのビルドキャッシュクリアと再デプロイ

### 1.1 方法1: Manual Deployで再デプロイ（推奨）

**手順**:
1. Render.comダッシュボードにログイン: https://dashboard.render.com
2. `yadopera-frontend-staging`サービスを選択
3. 「Manual Deploy」ボタンをクリック
4. 最新のコミット（`03c592d`）を選択
5. 「Deploy latest commit」をクリック

**注意**: Render.comのStatic Siteサービスでは、Manual Deploy時に自動的にキャッシュがクリアされる場合がありますが、明示的なキャッシュクリアオプションは提供されていない場合があります。

### 1.2 方法2: ビルドコマンドにキャッシュクリアを追加（確実な方法）

**手順**:
1. Render.comダッシュボードで`yadopera-frontend-staging`サービスを開く
2. 「Settings」タブを開く
3. 「Build & Deploy」セクションで「Build Command」を確認
4. 一時的にビルドコマンドを変更:
   ```bash
   rm -rf node_modules/.vite && npm run build
   ```
   または
   ```bash
   npm run build -- --force
   ```

**注意**: この方法は一時的なもので、確認後は元のビルドコマンド（`npm run build`）に戻す必要があります。

### 1.3 方法3: 環境変数でキャッシュを無効化（代替案）

**手順**:
1. Render.comダッシュボードで`yadopera-frontend-staging`サービスを開く
2. 「Environment」タブを開く
3. 一時的な環境変数を追加:
   - Key: `NODE_ENV`
   - Value: `production`（既に設定されている場合は変更）
   - または、新しい環境変数を追加してビルドを強制的に再実行

**注意**: この方法は確実ではありません。Render.comのビルドキャッシュは自動的に管理されるため、環境変数の変更だけではキャッシュがクリアされない場合があります。

---

## 2. 推奨される手順（最優先）

**推奨**: **方法1（Manual Deploy）を実施**

**理由**:
1. シンプル: ダッシュボードから直接実行できる
2. 確実: Render.comが最新のコミットをビルドする
3. 安全: 既存の設定を変更する必要がない

**実施手順**:
1. Render.comダッシュボードで`yadopera-frontend-staging`サービスを開く
2. 「Manual Deploy」ボタンをクリック
3. 最新のコミット（`03c592d` - "デバッグログ強化: エラーオブジェクト構造の完全な出力を追加"）を選択
4. 「Deploy latest commit」をクリック
5. デプロイが完了するまで待つ（通常2-5分）

---

## 3. デプロイ後のJavaScriptバンドル確認方法

### 3.1 ステップ1: デプロイ完了の確認

**確認方法**:
1. Render.comダッシュボードで`yadopera-frontend-staging`サービスの「Events」タブを開く
2. 最新のデプロイイベントが「Live」状態になっていることを確認
3. デプロイログでビルドが成功していることを確認

### 3.2 ステップ2: JavaScriptバンドルのURLを特定

**方法**:
1. ブラウザで`https://yadopera-frontend-staging.onrender.com/`にアクセス
2. 開発者ツール（F12）を開く
3. 「Network」タブを開く
4. ページをリロード（F5）
5. 「JS」フィルターを選択
6. `Welcome-*.js`というファイル名のJavaScriptバンドルを探す
7. ファイル名をコピー（例: `Welcome-DXhaVQyc.js`）

**または、HTMLソースから確認**:
1. ブラウザで`https://yadopera-frontend-staging.onrender.com/`にアクセス
2. ページのソースを表示（右クリック→「ページのソースを表示」）
3. `Welcome-`で始まるJavaScriptファイルのパスを探す
4. ファイル名をコピー

### 3.3 ステップ3: デプロイされたJavaScriptバンドルの内容を確認

**方法A: curlコマンドで確認（推奨）**

```bash
# 1. 新しいデバッグログの文字列を検索
curl -s "https://yadopera-frontend-staging.onrender.com/assets/Welcome-*.js" | grep -o "完全なエラーオブジェクト構造" | head -3

# 2. 検出されたerrorCodeのログを検索
curl -s "https://yadopera-frontend-staging.onrender.com/assets/Welcome-*.js" | grep -o "検出されたerrorCode" | head -3

# 3. NETWORK_ERROR検出のログを検索
curl -s "https://yadopera-frontend-staging.onrender.com/assets/Welcome-*.js" | grep -o "NETWORK_ERROR検出" | head -3

# 4. エラーオブジェクト構造確認終了のログを検索
curl -s "https://yadopera-frontend-staging.onrender.com/assets/Welcome-*.js" | grep -o "エラーオブジェクト構造確認終了" | head -3
```

**注意**: `Welcome-*.js`の`*`部分は、実際のファイル名に置き換える必要があります。最新のファイル名は、ブラウザの開発者ツールで確認できます。

**方法B: ブラウザの開発者ツールで確認**

1. ブラウザで`https://yadopera-frontend-staging.onrender.com/`にアクセス
2. 開発者ツール（F12）を開く
3. 「Sources」タブを開く
4. 左側のファイルツリーで`Welcome-*.js`を探す
5. ファイルを開いて内容を確認
6. 以下の文字列を検索（Ctrl+F / Cmd+F）:
   - `完全なエラーオブジェクト構造`
   - `検出されたerrorCode`
   - `NETWORK_ERROR検出`
   - `エラーオブジェクト構造確認終了`

**方法C: ブラウザのコンソールで確認**

1. ブラウザで`https://yadopera-frontend-staging.onrender.com/`にアクセス
2. 開発者ツール（F12）を開く
3. 「Console」タブを開く
4. 言語選択ボタンをクリック（オフライン状態で）
5. 以下のログが出力されることを確認:
   - `=== [Welcome.vue] Facility fetch error - 完全なエラーオブジェクト構造 ===`
   - `[Welcome.vue] 検出されたerrorCode:`
   - `[Welcome.vue] NETWORK_ERROR検出: オフラインメッセージを表示`または`[Welcome.vue] エラーコードが検出されませんでした`

---

## 4. 確認結果の評価基準

### 4.1 新しいデバッグログが含まれている場合（成功）

**確認項目**:
- ✅ `完全なエラーオブジェクト構造`の文字列がバンドルに含まれている
- ✅ `検出されたerrorCode`の文字列がバンドルに含まれている
- ✅ `NETWORK_ERROR検出`の文字列がバンドルに含まれている
- ✅ ブラウザのコンソールで新しいデバッグログが出力される

**評価**: デプロイが成功し、最新のコードが含まれています。

### 4.2 新しいデバッグログが含まれていない場合（失敗）

**確認項目**:
- ❌ `完全なエラーオブジェクト構造`の文字列がバンドルに含まれていない
- ❌ `検出されたerrorCode`の文字列がバンドルに含まれていない
- ❌ `NETWORK_ERROR検出`の文字列がバンドルに含まれていない
- ❌ ブラウザのコンソールで古いデバッグログ（`Facility fetch error:`のみ）のみが出力される

**評価**: デプロイが失敗しているか、古いコードがデプロイされています。以下の対応を実施:
1. Render.comのビルドログを確認
2. ビルドエラーがないか確認
3. 必要に応じて、方法2（ビルドコマンドにキャッシュクリアを追加）を実施

---

## 5. 自動確認スクリプト（オプション）

以下のシェルスクリプトを使用して、デプロイ後のJavaScriptバンドルを自動的に確認できます:

```bash
#!/bin/bash

# デプロイ後のJavaScriptバンドル確認スクリプト

BASE_URL="https://yadopera-frontend-staging.onrender.com"
ASSETS_URL="${BASE_URL}/assets"

# Welcome.vueのバンドルファイル名を取得（最新のファイル名を取得）
WELCOME_FILE=$(curl -s "${BASE_URL}/" | grep -oP 'Welcome-[^"]+\.js' | head -1)

if [ -z "$WELCOME_FILE" ]; then
  echo "❌ Welcome.vueのバンドルファイルが見つかりません"
  exit 1
fi

echo "📦 確認対象ファイル: ${ASSETS_URL}/${WELCOME_FILE}"
echo ""

# 新しいデバッグログの文字列を検索
echo "🔍 新しいデバッグログの確認:"
echo ""

CHECK_STRINGS=(
  "完全なエラーオブジェクト構造"
  "検出されたerrorCode"
  "NETWORK_ERROR検出"
  "エラーオブジェクト構造確認終了"
)

ALL_FOUND=true

for STRING in "${CHECK_STRINGS[@]}"; do
  if curl -s "${ASSETS_URL}/${WELCOME_FILE}" | grep -q "$STRING"; then
    echo "✅ '$STRING' が見つかりました"
  else
    echo "❌ '$STRING' が見つかりませんでした"
    ALL_FOUND=false
  fi
done

echo ""

if [ "$ALL_FOUND" = true ]; then
  echo "✅ すべての新しいデバッグログが含まれています"
  exit 0
else
  echo "❌ 新しいデバッグログが含まれていません"
  exit 1
fi
```

**使用方法**:
1. 上記のスクリプトを`check_deploy.sh`として保存
2. 実行権限を付与: `chmod +x check_deploy.sh`
3. 実行: `./check_deploy.sh`

---

## 6. 次のステップ

1. **Manual Deployを実施**: Render.comダッシュボードから最新のコミット（`03c592d`）を再デプロイ
2. **デプロイ完了を待つ**: 通常2-5分
3. **JavaScriptバンドルを確認**: 上記の方法A、B、またはCを使用
4. **結果を評価**: 新しいデバッグログが含まれているか確認
5. **ブラウザテストを実施**: オフライン状態で言語選択ボタンをクリックし、新しいデバッグログが出力されることを確認

---

## 7. トラブルシューティング

### 7.1 デプロイが失敗する場合

**確認事項**:
1. Render.comのビルドログを確認
2. ビルドエラーがないか確認
3. 環境変数が正しく設定されているか確認

### 7.2 新しいデバッグログが含まれていない場合

**確認事項**:
1. デプロイされたコミットが`03c592d`であることを確認
2. ビルドログで最新のコードがビルドされているか確認
3. 必要に応じて、方法2（ビルドコマンドにキャッシュクリアを追加）を実施

---

## 8. まとめ

**推奨される手順**:
1. Render.comダッシュボードから「Manual Deploy」を実施
2. デプロイ完了後、curlコマンドでJavaScriptバンドルの内容を確認
3. 新しいデバッグログが含まれていることを確認
4. ブラウザテストを実施し、新しいデバッグログが出力されることを確認

**確認方法**:
- 方法A（curlコマンド）: 最も確実で迅速
- 方法B（ブラウザの開発者ツール）: 視覚的に確認可能
- 方法C（ブラウザのコンソール）: 実際の動作を確認
