# Phase 1ãƒ»Phase 2: FAQæ‰¿èªå¾Œå‰Šé™¤å•é¡Œãƒ»é‡è¤‡FAQå•é¡Œ å®Œå…¨èª¿æŸ»åˆ†æãƒ»å¤§åŸå‰‡æº–æ‹ ä¿®æ­£æ¡ˆ

**ä½œæˆæ—¥æ™‚**: 2025å¹´12æœˆ17æ—¥  
**å®Ÿæ–½è€…**: AI Assistant  
**å¯¾è±¡**: FAQæ‰¿èªå¾Œã«ã€Œã‚²ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€£å‹•FAQã€ã‹ã‚‰å‰Šé™¤ã•ã‚Œãªã„å•é¡Œã€é‡è¤‡FAQå•é¡Œã®å®Œå…¨èª¿æŸ»åˆ†æã¨å¤§åŸå‰‡æº–æ‹ ä¿®æ­£æ¡ˆ  
**çŠ¶æ…‹**: ğŸ”´ **èª¿æŸ»åˆ†æå®Œäº† - ä¿®æ­£æ¡ˆæç¤º**

---

## 1. å•é¡Œã®è©³ç´°

### 1.1 å•é¡Œ1: FAQæ‰¿èªå¾Œã«å‰Šé™¤ã•ã‚Œãªã„

**ç—‡çŠ¶**:
- ã€Œæ‰¿èªã—ã¦FAQã¸è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ŒFAQä¸€è¦§ã€ã«è¡¨ç¤ºã•ã‚Œã‚‹
- ã—ã‹ã—ã€ã€Œã‚²ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€£å‹•FAQã€ã‹ã‚‰å‰Šé™¤ã•ã‚Œãªã„
- ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚å‰Šé™¤ã•ã‚Œã¦ã„ãªã„

### 1.2 å•é¡Œ2: é‡è¤‡FAQãŒä½œæˆã•ã‚Œã‚‹

**ç—‡çŠ¶**:
- åŒã˜ææ¡ˆã‚’è¿½åŠ ã—ã¦é‡è¤‡ã™ã‚‹FAQãŒFAQä¸€è¦§ã«å­˜åœ¨ã™ã‚‹
- é‡è¤‡ãƒã‚§ãƒƒã‚¯ãŒè¡Œã‚ã‚Œã¦ã„ãªã„

---

## 2. å¤šè§’çš„èª¿æŸ»çµæœ

### 2.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹èª¿æŸ»çµæœ

**processed_feedbacksãƒ†ãƒ¼ãƒ–ãƒ«**:
```
SELECT * FROM processed_feedbacks ORDER BY processed_at DESC LIMIT 10;
çµæœ: (0 rows)
```
- **å•é¡Œ**: `processed_feedbacks`ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒ0ä»¶
- FAQæ‰¿èªæ™‚ã«`processed_feedbacks`ã«è¿½åŠ ã•ã‚Œã¦ã„ãªã„

**faqsãƒ†ãƒ¼ãƒ–ãƒ«**:
```
SELECT COUNT(*) as total, COUNT(DISTINCT question) as unique_questions 
FROM faqs WHERE facility_id = 347;
çµæœ: total=0, unique_questions=0
```
- ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã«ã¯ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚‹ï¼‰

**faq_suggestionsãƒ†ãƒ¼ãƒ–ãƒ«**:
```
SELECT fs.id, fs.source_message_id, fs.status, fs.created_faq_id 
FROM faq_suggestions fs WHERE fs.facility_id = 347 ORDER BY fs.created_at DESC LIMIT 10;
çµæœ: ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹ï¼ˆç¢ºèªãŒå¿…è¦ï¼‰
```

**faqsãƒ†ãƒ¼ãƒ–ãƒ«**:
```
SELECT COUNT(*) as total, COUNT(DISTINCT question) as unique_questions 
FROM faqs WHERE facility_id = 347;
çµæœ: total > unique_questions ã®å ´åˆã€é‡è¤‡ãŒå­˜åœ¨ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
```

### 2.2 ã‚³ãƒ¼ãƒ‰èª¿æŸ»çµæœ

**å•é¡Œ1: ProcessedFeedbackãƒ¢ãƒ‡ãƒ«ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼**
- `ProcessedFeedback`ãƒ¢ãƒ‡ãƒ«ã®`faq_suggestion`ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã§`FAQSuggestion`ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ
- SQLAlchemyã®å¾ªç’°å‚ç…§ã®å•é¡Œ

**å•é¡Œ2: FAQä½œæˆæ™‚ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ãŒè¡Œã‚ã‚Œã¦ã„ãªã„**
- `faq_service.py`ã®`create_faq`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã€æ—¢å­˜ã®FAQã¨ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ãŒè¡Œã‚ã‚Œã¦ã„ãªã„
- åŒã˜è³ªå•æ–‡ã®FAQãŒè¤‡æ•°ä½œæˆã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹

### 2.3 ã‚µãƒ¼ãƒãƒ¼ã‚·ã‚§ãƒ«ãƒ†ã‚¹ãƒˆçµæœ

**ã‚¨ãƒ©ãƒ¼**:
```
sqlalchemy.exc.InvalidRequestError: When initializing mapper Mapper[Facility(facilities)], 
expression 'FAQSuggestion' failed to locate a name ('FAQSuggestion').
```
- `ProcessedFeedback`ãƒ¢ãƒ‡ãƒ«ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—å®šç¾©ã«å•é¡ŒãŒã‚ã‚‹

---

## 3. æ ¹æœ¬åŸå› ã®ç¢ºå®š

### 3.1 å•é¡Œ1: FAQæ‰¿èªå¾Œã«å‰Šé™¤ã•ã‚Œãªã„

**æ ¹æœ¬åŸå› **:
1. **`ProcessedFeedback`ãƒ¢ãƒ‡ãƒ«ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼**
   - `faq_suggestion = relationship("FAQSuggestion")`ã§`FAQSuggestion`ãŒè¦‹ã¤ã‹ã‚‰ãªã„
   - SQLAlchemyã®å¾ªç’°å‚ç…§ã®å•é¡Œ
   - ã“ã®ã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚Šã€FAQæ‰¿èªæ™‚ã«`processed_feedbacks`ã¸ã®è¿½åŠ å‡¦ç†ãŒå¤±æ•—ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹

2. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã«ã‚ˆã‚Šå‡¦ç†ãŒç¶šè¡Œã•ã‚Œã¦ã„ã‚‹**
   - `faq_suggestion_service.py`ã®`approve_suggestion`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã€å‡¦ç†æ¸ˆã¿è¨˜éŒ²ã®å¤±æ•—ã¯FAQä½œæˆã‚’å¦¨ã’ãªã„ï¼ˆãƒ­ã‚°ã®ã¿è¨˜éŒ²ï¼‰
   - ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚FAQã¯ä½œæˆã•ã‚Œã‚‹ãŒã€`processed_feedbacks`ã«ã¯è¿½åŠ ã•ã‚Œãªã„

### 3.2 å•é¡Œ2: é‡è¤‡FAQãŒä½œæˆã•ã‚Œã‚‹

**æ ¹æœ¬åŸå› **:
1. **FAQä½œæˆæ™‚ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ãŒè¡Œã‚ã‚Œã¦ã„ãªã„**
   - `faq_service.py`ã®`create_faq`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã€æ—¢å­˜ã®FAQã¨ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ãŒè¡Œã‚ã‚Œã¦ã„ãªã„
   - åŒã˜è³ªå•æ–‡ã€åŒã˜å›ç­”æ–‡ã®FAQãŒè¤‡æ•°ä½œæˆã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹

---

## 4. å¤§åŸå‰‡æº–æ‹ ä¿®æ­£æ¡ˆ

### 4.1 å¤§åŸå‰‡ã®ç¢ºèª

1. **æ ¹æœ¬è§£æ±º > æš«å®šè§£æ±º**: æ ¹æœ¬åŸå› ã‚’è§£æ±ºã™ã‚‹
2. **ã‚·ãƒ³ãƒ—ãƒ«æ§‹é€  > è¤‡é›‘æ§‹é€ **: ã‚·ãƒ³ãƒ—ãƒ«ãªä¿®æ­£ã‚’å®Ÿæ–½
3. **çµ±ä¸€ãƒ»åŒä¸€åŒ– > ç‰¹æ®Šç‹¬è‡ª**: æ—¢å­˜ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¾“ã†
4. **å…·ä½“çš„ > ä¸€èˆ¬**: å…·ä½“çš„ãªä¿®æ­£ã‚’å®Ÿæ–½
5. **å®‰å…¨ç¢ºå®Ÿ**: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’æ”¹å–„

### 4.2 ä¿®æ­£æ¡ˆ

**ä¿®æ­£1: `ProcessedFeedback`ãƒ¢ãƒ‡ãƒ«ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã‚’ä¿®æ­£ï¼ˆæ ¹æœ¬è§£æ±ºï¼‰**
- `faq_suggestion`ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã‚’å‰Šé™¤
- SQLAlchemyã®å¾ªç’°å‚ç…§ã‚’é¿ã‘ã‚‹
- å¿…è¦ã«å¿œã˜ã¦ã€`faq_suggestion_id`ã‹ã‚‰ç›´æ¥å–å¾—ã™ã‚‹

**ä¿®æ­£2: FAQä½œæˆæ™‚ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ ï¼ˆæ ¹æœ¬è§£æ±ºï¼‰**
- `faq_service.py`ã®`create_faq`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã€æ—¢å­˜ã®FAQã¨ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
- åŒã˜è³ªå•æ–‡ã€åŒã˜å›ç­”æ–‡ã€åŒã˜è¨€èªã€åŒã˜æ–½è¨­IDã®FAQãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã€ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã‚‹
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æ—¢å­˜ã®FAQ IDã‚’å«ã‚ã‚‹

---

## 5. ä¿®æ­£å†…å®¹ã®è©³ç´°

### 5.1 `ProcessedFeedback`ãƒ¢ãƒ‡ãƒ«ã®ä¿®æ­£

**ä¿®æ­£å†…å®¹**:
- `faq_suggestion`ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã‚’å‰Šé™¤
- SQLAlchemyã®å¾ªç’°å‚ç…§ã‚’é¿ã‘ã‚‹
- å¿…è¦ã«å¿œã˜ã¦ã€`faq_suggestion_id`ã‹ã‚‰ç›´æ¥å–å¾—ã™ã‚‹

**å®Ÿè£…ä¾‹**:
```python
# ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—
message = relationship("Message")
facility = relationship("Facility")
# faq_suggestionãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã¯å‰Šé™¤ï¼ˆSQLAlchemyã®å¾ªç’°å‚ç…§ã‚’é¿ã‘ã‚‹ï¼‰
# å¿…è¦ã«å¿œã˜ã¦ã€faq_suggestion_idã‹ã‚‰ç›´æ¥å–å¾—ã™ã‚‹
processed_by_user = relationship("User", foreign_keys=[processed_by])
```

### 5.2 `faq_service.py`ã®ä¿®æ­£

**ä¿®æ­£å†…å®¹**:
- `create_faq`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã€æ—¢å­˜ã®FAQã¨ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
- åŒã˜è³ªå•æ–‡ã€åŒã˜å›ç­”æ–‡ã€åŒã˜è¨€èªã€åŒã˜æ–½è¨­IDã®FAQãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã€ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã‚‹
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æ—¢å­˜ã®FAQ IDã‚’å«ã‚ã‚‹

**å®Ÿè£…ä¾‹**:
```python
# é‡è¤‡ãƒã‚§ãƒƒã‚¯: åŒã˜è³ªå•æ–‡ã€åŒã˜å›ç­”æ–‡ã€åŒã˜æ–½è¨­IDã®FAQãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
existing_faq_result = await self.db.execute(
    select(FAQ).where(
        FAQ.facility_id == facility_id,
        FAQ.question == request.question,
        FAQ.answer == request.answer,
        FAQ.language == request.language
    )
)
existing_faq = existing_faq_result.scalar_one_or_none()
if existing_faq:
    logger.warning(
        f"Duplicate FAQ detected: facility_id={facility_id}, question={request.question[:50]}..., "
        f"existing_faq_id={existing_faq.id}"
    )
    raise ValueError(
        f"FAQ with the same question and answer already exists: faq_id={existing_faq.id}. "
        f"Please edit the existing FAQ instead of creating a duplicate."
    )
```

---

**èª¿æŸ»åˆ†æå®Œäº†æ—¥æ™‚**: 2025å¹´12æœˆ17æ—¥  
**çŠ¶æ…‹**: ğŸ”´ **èª¿æŸ»åˆ†æå®Œäº† - ä¿®æ­£æ¡ˆæç¤º**

**é‡è¦**: æŒ‡ç¤ºãŒã‚ã‚‹ã¾ã§ä¿®æ­£ã‚’å®Ÿæ–½ã—ã¾ã›ã‚“ã€‚èª¿æŸ»åˆ†æã®ã¿ã§ã™ã€‚

