================================================================================
YadOPERA ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªæ©Ÿèƒ½å®Ÿè£…è¨ˆç”»æ›¸ v2.0
================================================================================

ä½œæˆæ—¥: 2026å¹´01æœˆ26æ—¥
æœ€çµ‚æ›´æ–°æ—¥: 2026å¹´01æœˆ27æ—¥
ãƒãƒ¼ã‚¸ãƒ§ãƒ³: v2.0ï¼ˆğŸ”´æœ€å„ªå…ˆã€ğŸŸ é«˜å„ªå…ˆã€ğŸŸ¡ä¸­å„ªå…ˆã®ä¿®æ­£ã‚’å®Œå…¨åæ˜ ï¼‰
å¯¾è±¡: Phase 4 æ–°è¦ç™»éŒ²ãƒšãƒ¼ã‚¸ã®ãƒ¡ãƒ¼ãƒ«èªè¨¼æ©Ÿèƒ½å®Ÿè£…

================================================================================
å¤‰æ›´å±¥æ­´ï¼ˆv1.0 â†’ v2.0ï¼‰
================================================================================

ğŸ”´ æœ€å„ªå…ˆä¿®æ­£ï¼ˆå®Ÿè£…å‰ã«å¿…é ˆï¼‰
1. ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¿ã‚¹ã‚¯ã®å®Ÿè¡Œé †åºå•é¡Œã‚’ä¿®æ­£ï¼ˆ5.7ç« ï¼‰
2. APIãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’è¿½åŠ ï¼ˆ5.9ç« ã€æ–°è¦ï¼‰
3. Brevo API Keyæ¼æ´©ãƒªã‚¹ã‚¯å¯¾ç­–ã‚’è¿½åŠ ï¼ˆ3.1ç« ã€5.2ç« ï¼‰
4. æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¾Œæ–¹äº’æ›æ€§ã‚’ä¿®æ­£ï¼ˆ4.2ç« ï¼‰

ğŸŸ  é«˜å„ªå…ˆä¿®æ­£ï¼ˆå®Ÿè£…ã¨åŒæ™‚ã«å¯¾å¿œï¼‰
5. ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ï¼ˆ5.7ç« ï¼‰
6. ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ”¹å–„ï¼ˆ5.7ç« ã€6.5ç« ï¼‰
7. ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—æ™‚ã®ç®¡ç†è€…é€šçŸ¥ã‚’å®Ÿè£…ï¼ˆ5.10ç« ã€æ–°è¦ï¼‰
8. ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ»æœ¬ç•ªç’°å¢ƒã®FRONTEND_URLè¨­å®šã‚’æ˜ç¢ºåŒ–ï¼ˆ8.1ç« ã€9.1.2ç« ï¼‰

ğŸŸ¡ ä¸­å„ªå…ˆä¿®æ­£ï¼ˆPhase 2-3ã§å¯¾å¿œï¼‰
9. ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«åŒ–ï¼ˆ5.3ç« ï¼‰
10. pytestè‡ªå‹•ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ï¼ˆ7.6ç« ã€æ–°è¦ï¼‰
11. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å¼·åŒ–ï¼ˆ6.2ç« ï¼‰
12. ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã®ãƒªãƒˆãƒ©ã‚¤å‡¦ç†ã‚’å®Ÿè£…ï¼ˆ5.3ç« ï¼‰

================================================================================
ç›®æ¬¡
================================================================================

1. æ¦‚è¦
2. ç¾çŠ¶åˆ†æ
3. Brevoè¨­å®šã‚¬ã‚¤ãƒ‰
4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ
5. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…
6. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…
7. Dockerç’°å¢ƒã§ã®å‹•ä½œç¢ºèªæ‰‹é †
8. ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †
9. æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †
10. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
11. å®Ÿè£…å‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

================================================================================
1. æ¦‚è¦
================================================================================

## 1.1 ç›®çš„
æ–°è¦ç™»éŒ²æ™‚ã«ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç¢ºèªã‚’è¡Œã„ã€ä¸æ­£ç™»éŒ²ã‚’é˜²æ­¢ã™ã‚‹ã€‚

## 1.2 è¦ä»¶
- ç™»éŒ²æ™‚ã«ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ç¢ºèªç”¨URLã‚’é€ä¿¡
- ç¢ºèªç”¨URLã®æœ‰åŠ¹æœŸé™ã¯24æ™‚é–“
- ãƒ¡ãƒ¼ãƒ«ç¢ºèªå®Œäº†ã¾ã§ã¯ãƒ­ã‚°ã‚¤ãƒ³ä¸å¯
- ãƒ¡ãƒ¼ãƒ«å†é€ä¿¡æ©Ÿèƒ½ã‚’æä¾›ï¼ˆAPIãƒ¬ãƒ¼ãƒˆåˆ¶é™: 60ç§’ï¼‰
- Brevoç„¡æ–™ãƒ—ãƒ©ãƒ³ï¼ˆæœˆ300é€šï¼‰ã‚’ä½¿ç”¨
- ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—æ™‚ã¯ç®¡ç†è€…ã«é€šçŸ¥

## 1.3 å®Ÿè£…ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡                              â”‚
â”‚    â†“                                                             â”‚
â”‚ 2. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: æ–½è¨­ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆis_active=Falseï¼‰          â”‚
â”‚    â†“                                                             â”‚
â”‚ 3. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: ç¢ºèªãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆï¼ˆUUID4ï¼‰                      â”‚
â”‚    â†“                                                             â”‚
â”‚ 4. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: Brevoã§ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆãƒªãƒˆãƒ©ã‚¤3å›ï¼‰           â”‚
â”‚    â”œâ”€ æˆåŠŸ â†’ FAQè‡ªå‹•æŠ•å…¥ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰                    â”‚
â”‚    â””â”€ å¤±æ•— â†’ ç®¡ç†è€…é€šçŸ¥ + ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯å†é€ä¿¡ã‚’ä¿ƒã™             â”‚
â”‚    â†“                                                             â”‚
â”‚ 5. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: ã€Œç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€ç”»é¢è¡¨ç¤º        â”‚
â”‚    â†“                                                             â”‚
â”‚ 6. ãƒ¦ãƒ¼ã‚¶ãƒ¼: ãƒ¡ãƒ¼ãƒ«å†…ã®URLã‚’ã‚¯ãƒªãƒƒã‚¯                            â”‚
â”‚    â†“                                                             â”‚
â”‚ 7. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ãƒ»æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ï¼ˆã‚»ã‚­ãƒ¥ã‚¢ï¼‰    â”‚
â”‚    â†“                                                             â”‚
â”‚ 8. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: is_active=True, email_verified=True ã«æ›´æ–°    â”‚
â”‚    â†“                                                             â”‚
â”‚ 9. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: ã€Œç¢ºèªå®Œäº†ã€ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€ç”»é¢è¡¨ç¤º  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

================================================================================
2. ç¾çŠ¶åˆ†æ
================================================================================

## 2.1 ç¾åœ¨ã®ç™»éŒ²ãƒ•ãƒ­ãƒ¼

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (frontend/src/views/admin/Register.vue)**
- æ–½è¨­åã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€æ–™é‡‘ãƒ—ãƒ©ãƒ³ã‚’å…¥åŠ›
- `/api/v1/auth/register` ã«POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆ
- æˆåŠŸæ™‚ã¯å³åº§ã«ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã«ãªã‚‹

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (backend/app/api/v1/auth.py)**
- `register_facility()` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- æ–½è¨­ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã€å³åº§ã«JWTãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿”å´
- FAQè‡ªå‹•æŠ•å…¥ã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œ

**å•é¡Œç‚¹**
- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç¢ºèªãªã—
- ä¸æ­£ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã‚‚ç™»éŒ²å¯èƒ½
- ãªã‚Šã™ã¾ã—ç™»éŒ²ã®ãƒªã‚¹ã‚¯

## 2.2 å¿…è¦ãªå¤‰æ›´

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- usersãƒ†ãƒ¼ãƒ–ãƒ«ã«ä»¥ä¸‹ã‚’è¿½åŠ :
  - email_verified (Boolean)
  - verification_token (String)
  - verification_token_expires (DateTime)

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
- ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆBrevoé€£æºã€ãƒªãƒˆãƒ©ã‚¤å‡¦ç†ä»˜ãï¼‰
- ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆãƒ»æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆã‚»ã‚­ãƒ¥ã‚¢åŒ–ï¼‰
- æ–°è¦ç™»éŒ²APIä¿®æ­£ï¼ˆis_active=Falseï¼‰
- ãƒ¡ãƒ¼ãƒ«ç¢ºèªAPIè¿½åŠ ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼‰
- å†é€ä¿¡APIè¿½åŠ ï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™: 60ç§’ï¼‰
- ç®¡ç†è€…é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—æ™‚ï¼‰

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
- Register.vueä¿®æ­£ï¼ˆæˆåŠŸæ™‚ã®é·ç§»å…ˆå¤‰æ›´ï¼‰
- ãƒ¡ãƒ¼ãƒ«ç¢ºèªå¾…ã¡ç”»é¢ï¼ˆEmailVerificationPending.vueã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ï¼‰
- ãƒ¡ãƒ¼ãƒ«ç¢ºèªå®Œäº†ç”»é¢ï¼ˆEmailVerificationSuccess.vueï¼‰
- å†é€ä¿¡ãƒœã‚¿ãƒ³ï¼ˆ60ç§’ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã€ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼‰

================================================================================
3. Brevoè¨­å®šã‚¬ã‚¤ãƒ‰
================================================================================

## 3.1 Brevo API Keyå–å¾—æ‰‹é †

1. Brevoã«ãƒ­ã‚°ã‚¤ãƒ³
   URL: https://app.brevo.com/

2. å³ä¸Šã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ ã€ŒSMTP & APIã€ã‚’é¸æŠ

3. ã€ŒAPI Keysã€ã‚¿ãƒ–ã‚’é¸æŠ

4. ã€ŒCreate a new API keyã€ã‚’ã‚¯ãƒªãƒƒã‚¯

5. API Keyåã‚’å…¥åŠ›ï¼ˆä¾‹: "YadOPERA Production"ï¼‰

6. ç”Ÿæˆã•ã‚ŒãŸAPI Keyã‚’ã‚³ãƒ”ãƒ¼ï¼ˆä¸€åº¦ã—ã‹è¡¨ç¤ºã•ã‚Œãªã„ã®ã§æ³¨æ„ï¼‰

7. backend/.env ã«è¿½åŠ :
   ```
   BREVO_API_KEY=xkeysib-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
   ```

**ğŸ”´ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ³¨æ„äº‹é …ï¼ˆé‡è¦ï¼‰**

**é‡è¦**: `.env`ãƒ•ã‚¡ã‚¤ãƒ«ã¯çµ¶å¯¾ã«Gitã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„ã§ãã ã•ã„ã€‚

1. `.gitignore`ã«`.env`ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
   ```bash
   cat .gitignore | grep .env
   ```
   
   æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:
   ```
   .env
   .env.local
   .env.*.local
   backend/.env
   frontend/.env
   ```

2. æ—¢ã«`.env`ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ã—ã¾ã£ãŸå ´åˆã®å¯¾å‡¦
   ```bash
   # Gitã®å±¥æ­´ã‹ã‚‰å‰Šé™¤
   git rm --cached backend/.env
   git commit -m "Remove .env from Git"
   git push origin develop
   
   # Brevo API Keyã‚’å†ç™ºè¡Œï¼ˆå¤ã„Keyã¯å‰Šé™¤ï¼‰
   # Brevoãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ SMTP & API â†’ API Keys â†’ Delete old key
   # æ–°ã—ã„Keyã‚’ç™ºè¡Œã—ã€.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
   ```

3. `.env.example`ã®ç¢ºèª
   ```bash
   # backend/.env.exampleãŒå­˜åœ¨ã—ã€ä»¥ä¸‹ã®å†…å®¹ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
   cat backend/.env.example
   ```
   
   æœŸå¾…ã•ã‚Œã‚‹å†…å®¹:
   ```
   BREVO_API_KEY=your_brevo_api_key_here
   BREVO_SENDER_EMAIL=noreply@yadopera.com
   BREVO_SENDER_NAME=YadOPERA
   FRONTEND_URL=http://localhost:5173
   ADMIN_NOTIFICATION_EMAIL=kurinobu@example.com
   ```

## 3.2 é€ä¿¡å…ƒãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆnoreply@yadopera.comï¼‰è¨­å®šæ‰‹é †

### 3.2.1 Brevoã§ãƒ‰ãƒ¡ã‚¤ãƒ³èªè¨¼

1. Brevoã«ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€ã€ŒSenders, Domains & Dedicated IPsã€ã‚’é¸æŠ

2. ã€ŒDomainsã€ã‚¿ãƒ–ã‚’é¸æŠ

3. ã€ŒAdd a Domainã€ã‚’ã‚¯ãƒªãƒƒã‚¯

4. ãƒ‰ãƒ¡ã‚¤ãƒ³åã€Œyadopera.comã€ã‚’å…¥åŠ›

5. BrevoãŒæä¾›ã™ã‚‹DNSãƒ¬ã‚³ãƒ¼ãƒ‰æƒ…å ±ã‚’ç¢ºèªï¼ˆæ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ç”¨ï¼‰

### 3.2.2 DNSè¨­å®šï¼ˆCloudflareï¼‰

Cloudflareã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ä»¥ä¸‹ã®DNSãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ :

**SPFãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆTXTãƒ¬ã‚³ãƒ¼ãƒ‰ï¼‰**
```
Type: TXT
Name: @
Content: v=spf1 include:spf.brevo.com ~all
TTL: Auto
Proxy: DNS onlyï¼ˆã‚ªãƒ¬ãƒ³ã‚¸é›²ãƒãƒ¼ã‚¯OFFï¼‰
```

**DKIMãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆTXTãƒ¬ã‚³ãƒ¼ãƒ‰ã€BrevoãŒæä¾›ï¼‰**
```
Type: TXT
Name: mail._domainkey
Content: [BrevoãŒæä¾›ã™ã‚‹å€¤ã‚’ã‚³ãƒ”ãƒ¼]
TTL: Auto
Proxy: DNS onlyï¼ˆã‚ªãƒ¬ãƒ³ã‚¸é›²ãƒãƒ¼ã‚¯OFFï¼‰
```

**MXãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€å—ä¿¡ç”¨ï¼‰**
```
Type: MX
Name: @
Content: mx.brevo.com
Priority: 10
TTL: Auto
Proxy: DNS onlyï¼ˆã‚ªãƒ¬ãƒ³ã‚¸é›²ãƒãƒ¼ã‚¯OFFï¼‰
```

### 3.2.3 DNSè¨­å®šç¢ºèª

1. DNSè¨­å®šå¾Œã€10-30åˆ†å¾…ã¤ï¼ˆDNSä¼æ’­æ™‚é–“ï¼‰

2. ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ç¢ºèª:
   ```bash
   # SPFãƒ¬ã‚³ãƒ¼ãƒ‰ç¢ºèª
   dig TXT yadopera.com +short
   
   # DKIMãƒ¬ã‚³ãƒ¼ãƒ‰ç¢ºèª
   dig TXT mail._domainkey.yadopera.com +short
   ```

3. Brevoã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã€ŒVerifyã€ã‚’ã‚¯ãƒªãƒƒã‚¯

4. èªè¨¼æˆåŠŸã™ã‚‹ã¨ç·‘è‰²ã®ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### 3.2.4 é€ä¿¡å…ƒãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹è¿½åŠ 

1. Brevoã§ã€ŒSenders, Domains & Dedicated IPsã€â†’ã€ŒSendersã€ã‚¿ãƒ–

2. ã€ŒAdd a Senderã€ã‚’ã‚¯ãƒªãƒƒã‚¯

3. ä»¥ä¸‹ã‚’å…¥åŠ›:
   - Email: noreply@yadopera.com
   - Name: YadOPERA
   - Default: ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé€ä¿¡å…ƒã«ã™ã‚‹ï¼‰

4. ã€ŒCreateã€ã‚’ã‚¯ãƒªãƒƒã‚¯

5. ç¢ºèªãƒ¡ãƒ¼ãƒ«ãŒ noreply@yadopera.com ã«é€ä¿¡ã•ã‚Œã‚‹
   ï¼ˆã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒ¡ãƒ¼ãƒ«å—ä¿¡è¨­å®šãŒå¿…è¦ï¼‰

6. ç¢ºèªãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦èªè¨¼å®Œäº†

**æ³¨æ„**: noreply@yadopera.comã®ãƒ¡ãƒ¼ãƒ«å—ä¿¡è¨­å®š
- Cloudflareã®ã€ŒEmail Routingã€æ©Ÿèƒ½ã‚’ä½¿ç”¨
- noreply@yadopera.comã‚’åˆ¥ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä¾‹: kurinobu@example.comï¼‰ã«è»¢é€
- ã¾ãŸã¯ã€Brevoã®ã€ŒInboxã€æ©Ÿèƒ½ã‚’ä½¿ç”¨

## 3.3 Brevoç„¡æ–™ãƒ—ãƒ©ãƒ³ã®åˆ¶é™

- æœˆé–“é€ä¿¡ä¸Šé™: 300é€š
- 1æ—¥é€ä¿¡ä¸Šé™: åˆ¶é™ãªã—
- é€ä¿¡é€Ÿåº¦åˆ¶é™: ãªã—
- Brevoãƒ­ã‚´: ãƒ¡ãƒ¼ãƒ«ä¸‹éƒ¨ã«è¡¨ç¤ºã•ã‚Œã‚‹ï¼ˆæœ‰æ–™ãƒ—ãƒ©ãƒ³ã§å‰Šé™¤å¯èƒ½ï¼‰

**æƒ³å®šé€ä¿¡æ•°ï¼ˆMVPæ®µéšï¼‰**
- æ–°è¦ç™»éŒ²: 3æ–½è¨­Ã—1é€š = 3é€š
- å†é€ä¿¡: 3æ–½è¨­Ã—2é€šï¼ˆæƒ³å®šï¼‰ = 6é€š
- ç®¡ç†è€…é€šçŸ¥: 1é€šï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã®ã¿ï¼‰
- åˆè¨ˆ: 10é€š/æœˆï¼ˆååˆ†ä½™è£•ã‚ã‚Šï¼‰

================================================================================
4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ
================================================================================

## 4.1 usersãƒ†ãƒ¼ãƒ–ãƒ«ä¿®æ­£

### è¿½åŠ ã‚«ãƒ©ãƒ 

```sql
-- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªæ¸ˆã¿ãƒ•ãƒ©ã‚°
email_verified BOOLEAN DEFAULT FALSE NOT NULL

-- ãƒ¡ãƒ¼ãƒ«ç¢ºèªãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆUUID4å½¢å¼ï¼‰
verification_token VARCHAR(255) NULL

-- ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ï¼ˆ24æ™‚é–“å¾Œï¼‰
verification_token_expires TIMESTAMP WITH TIME ZONE NULL

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³æ¤œç´¢ç”¨ï¼‰
CREATE INDEX idx_users_verification_token 
ON users(verification_token) 
WHERE verification_token IS NOT NULL;
```

### ä¿®æ­£å¾Œã®usersãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“åƒ

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    facility_id INTEGER NOT NULL REFERENCES facilities(id) ON DELETE CASCADE,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(50) DEFAULT 'staff',
    full_name VARCHAR(255),
    is_active BOOLEAN DEFAULT TRUE,
    email_verified BOOLEAN DEFAULT FALSE NOT NULL,  -- â˜…è¿½åŠ 
    verification_token VARCHAR(255),  -- â˜…è¿½åŠ 
    verification_token_expires TIMESTAMP WITH TIME ZONE,  -- â˜…è¿½åŠ 
    last_login_at TIMESTAMP WITH TIME ZONE,
    password_reset_token VARCHAR(255),
    password_reset_expires TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE UNIQUE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_facility_id ON users(facility_id);
CREATE INDEX idx_users_password_reset_token ON users(password_reset_token) 
    WHERE password_reset_token IS NOT NULL;
CREATE INDEX idx_users_verification_token ON users(verification_token)  -- â˜…è¿½åŠ 
    WHERE verification_token IS NOT NULL;
```

## 4.2 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«å**: `backend/alembic/versions/013_add_email_verification.py`

```python
"""add email verification

Revision ID: 013
Revises: 012
Create Date: 2026-01-26 10:00:00.000000

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = '013'
down_revision = '012'
branch_labels = None
depends_on = None


def upgrade() -> None:
    # email_verified ã‚«ãƒ©ãƒ è¿½åŠ ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: Falseï¼‰
    op.add_column('users', sa.Column('email_verified', sa.Boolean(), 
                                      nullable=False, server_default='false'))
    
    # verification_token ã‚«ãƒ©ãƒ è¿½åŠ 
    op.add_column('users', sa.Column('verification_token', sa.String(255), 
                                      nullable=True))
    
    # verification_token_expires ã‚«ãƒ©ãƒ è¿½åŠ 
    op.add_column('users', sa.Column('verification_token_expires', 
                                      sa.DateTime(timezone=True), nullable=True))
    
    # verification_token ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆï¼ˆéƒ¨åˆ†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰
    op.execute("""
        CREATE INDEX idx_users_verification_token 
        ON users(verification_token) 
        WHERE verification_token IS NOT NULL
    """)
    
    # ğŸ”´ ä¿®æ­£: æ—¢å­˜ã®ã€Œæœ‰åŠ¹ãªã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚’ãƒ¡ãƒ¼ãƒ«ç¢ºèªæ¸ˆã¿ã¨ã—ã¦æ‰±ã†
    # is_active=False ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆå‰Šé™¤æ¸ˆã¿ã€åœæ­¢ä¸­ãªã©ï¼‰ã¯é™¤å¤–
    op.execute("""
        UPDATE users 
        SET email_verified = true 
        WHERE id IS NOT NULL 
          AND is_active = true
    """)


def downgrade() -> None:
    # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å‰Šé™¤
    op.drop_index('idx_users_verification_token', table_name='users')
    
    # ã‚«ãƒ©ãƒ å‰Šé™¤
    op.drop_column('users', 'verification_token_expires')
    op.drop_column('users', 'verification_token')
    op.drop_column('users', 'email_verified')
```

## 4.3 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ

```bash
# Dockerç’°å¢ƒã§å®Ÿè¡Œ
docker-compose exec backend alembic upgrade head

# ç¢ºèª
docker-compose exec backend alembic current
```

================================================================================
5. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…
================================================================================

## 5.1 Brevoãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

### requirements.txt ã«è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/requirements.txt`

```txt
# æ—¢å­˜ã®ä¾å­˜é–¢ä¿‚...

# Email
sib-api-v3-sdk==7.6.0  # Brevoå…¬å¼SDKã®æœ€æ–°ç‰ˆ

# ğŸŸ¡ ãƒªãƒˆãƒ©ã‚¤å‡¦ç†ï¼ˆä¸­å„ªå…ˆï¼‰
tenacity==8.2.3  # ãƒªãƒˆãƒ©ã‚¤ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
```

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Ÿè¡Œ

```bash
# Dockerç’°å¢ƒã§å®Ÿè¡Œ
docker-compose exec backend pip install sib-api-v3-sdk==7.6.0 tenacity==8.2.3

# ã¾ãŸã¯ã€ã‚³ãƒ³ãƒ†ãƒŠå†ãƒ“ãƒ«ãƒ‰
docker-compose build backend
docker-compose up -d backend
```

## 5.2 ç’°å¢ƒå¤‰æ•°è¨­å®š

### backend/.env ã«è¿½åŠ 

```env
# Email (Brevo)
BREVO_API_KEY=xkeysib-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
BREVO_SENDER_EMAIL=noreply@yadopera.com
BREVO_SENDER_NAME=YadOPERA

# Frontend URL (ãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ç”¨)
FRONTEND_URL=http://localhost:5173

# ğŸŸ  ç®¡ç†è€…é€šçŸ¥ç”¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆé«˜å„ªå…ˆï¼‰
ADMIN_NOTIFICATION_EMAIL=kurinobu@example.com
```

### backend/.env.example ã«è¿½åŠ 

```env
# Email (Brevo)
BREVO_API_KEY=your_brevo_api_key_here
BREVO_SENDER_EMAIL=noreply@yadopera.com
BREVO_SENDER_NAME=YadOPERA

# Frontend URL (ãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ç”¨)
FRONTEND_URL=http://localhost:5173

# Admin notification email
ADMIN_NOTIFICATION_EMAIL=your_email@example.com
```

**ğŸ”´ é‡è¦**: `.env`ãƒ•ã‚¡ã‚¤ãƒ«ã¯çµ¶å¯¾ã«Gitã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„ã§ãã ã•ã„ã€‚
`.gitignore`ã«`.env`ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’å¿…ãšç¢ºèªã—ã¦ãã ã•ã„ã€‚

## 5.3 ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚µãƒ¼ãƒ“ã‚¹ä½œæˆï¼ˆğŸŸ¡ ãƒªãƒˆãƒ©ã‚¤å‡¦ç†è¿½åŠ ï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/app/services/email_service.py`ï¼ˆæ–°è¦ä½œæˆï¼‰

```python
"""
ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆBrevoé€£æºï¼‰
"""

import sib_api_v3_sdk
from sib_api_v3_sdk.rest import ApiException
from app.core.config import settings
import logging
from typing import Optional
from tenacity import retry, stop_after_attempt, wait_exponential  # ğŸŸ¡ ãƒªãƒˆãƒ©ã‚¤

logger = logging.getLogger(__name__)


class EmailService:
    """
    Brevoã‚’ä½¿ç”¨ã—ãŸãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚µãƒ¼ãƒ“ã‚¹
    """
    
    def __init__(self):
        """
        Brevo APIè¨­å®š
        """
        configuration = sib_api_v3_sdk.Configuration()
        configuration.api_key['api-key'] = settings.brevo_api_key
        self.api_instance = sib_api_v3_sdk.TransactionalEmailsApi(
            sib_api_v3_sdk.ApiClient(configuration)
        )
    
    # ğŸŸ¡ ãƒªãƒˆãƒ©ã‚¤å‡¦ç†è¿½åŠ ï¼ˆä¸­å„ªå…ˆï¼‰
    # æœ€å¤§3å›ãƒªãƒˆãƒ©ã‚¤ã€å¾…æ©Ÿæ™‚é–“: 2ç§’ã€4ç§’ã€8ç§’ï¼ˆæŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‰
    @retry(
        stop=stop_after_attempt(3),
        wait=wait_exponential(multiplier=1, min=2, max=10),
        reraise=True
    )
    async def send_verification_email(
        self,
        to_email: str,
        to_name: str,
        verification_url: str
    ) -> bool:
        """
        ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ï¼ˆãƒªãƒˆãƒ©ã‚¤ã‚ã‚Šï¼‰
        
        Args:
            to_email: é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
            to_name: é€ä¿¡å…ˆåï¼ˆæ–½è¨­åï¼‰
            verification_url: ç¢ºèªç”¨URL
        
        Returns:
            é€ä¿¡æˆåŠŸæ™‚Trueã€å¤±æ•—æ™‚False
        """
        try:
            # ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ï¼ˆHTMLï¼‰
            html_content = f"""
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèª - YadOPERA</title>
</head>
<body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
    <div style="background-color: #f8f9fa; border-radius: 10px; padding: 30px; margin-bottom: 20px;">
        <h1 style="color: #2563eb; margin-top: 0;">YadOPERA</h1>
        <h2 style="color: #1f2937; margin-bottom: 20px;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèª</h2>
        
        <p style="font-size: 16px; margin-bottom: 20px;">
            {to_name} æ§˜
        </p>
        
        <p style="font-size: 16px; margin-bottom: 20px;">
            YadOPERAã«ã”ç™»éŒ²ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚<br>
            ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç¢ºèªã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚
        </p>
        
        <div style="text-align: center; margin: 30px 0;">
            <a href="{verification_url}" 
               style="display: inline-block; background-color: #2563eb; color: white; 
                      padding: 15px 40px; text-decoration: none; border-radius: 5px; 
                      font-size: 16px; font-weight: bold;">
                ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªã™ã‚‹
            </a>
        </div>
        
        <p style="font-size: 14px; color: #6b7280; margin-bottom: 10px;">
            ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ããªã„å ´åˆã¯ã€ä»¥ä¸‹ã®URLã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„ï¼š
        </p>
        <p style="font-size: 14px; color: #2563eb; word-break: break-all; margin-bottom: 20px;">
            {verification_url}
        </p>
        
        <p style="font-size: 14px; color: #ef4444; margin-bottom: 10px;">
            <strong>â€» ã“ã®ãƒªãƒ³ã‚¯ã¯24æ™‚é–“å¾Œã«ç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚</strong>
        </p>
        
        <p style="font-size: 14px; color: #6b7280; margin-bottom: 20px;">
            ã“ã®ãƒ¡ãƒ¼ãƒ«ã«å¿ƒå½“ãŸã‚ŠãŒãªã„å ´åˆã¯ã€ç„¡è¦–ã—ã¦ã„ãŸã ã„ã¦æ§‹ã„ã¾ã›ã‚“ã€‚
        </p>
    </div>
    
    <div style="text-align: center; font-size: 12px; color: #9ca3af; padding-top: 20px; border-top: 1px solid #e5e7eb;">
        <p>Â© 2026 YadOPERA. All rights reserved.</p>
        <p>ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯é€ä¿¡å°‚ç”¨ã§ã™ã€‚è¿”ä¿¡ã„ãŸã ã„ã¦ã‚‚ãŠç­”ãˆã§ãã¾ã›ã‚“ã€‚</p>
    </div>
</body>
</html>
            """
            
            # ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ï¼ˆãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼‰
            text_content = f"""
YadOPERA - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªï¼ˆå†é€ï¼‰

{to_name} æ§˜

ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’å†é€ä¿¡ã„ãŸã—ã¾ã—ãŸã€‚
ä»¥ä¸‹ã®URLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç¢ºèªã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚

{verification_url}

â€» ã“ã®ãƒªãƒ³ã‚¯ã¯24æ™‚é–“å¾Œã«ç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚

ã“ã®ãƒ¡ãƒ¼ãƒ«ã«å¿ƒå½“ãŸã‚ŠãŒãªã„å ´åˆã¯ã€ç„¡è¦–ã—ã¦ã„ãŸã ã„ã¦æ§‹ã„ã¾ã›ã‚“ã€‚

---
Â© 2026 YadOPERA. All rights reserved.
ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯é€ä¿¡å°‚ç”¨ã§ã™ã€‚è¿”ä¿¡ã„ãŸã ã„ã¦ã‚‚ãŠç­”ãˆã§ãã¾ã›ã‚“ã€‚
            """
            
            # ãƒ¡ãƒ¼ãƒ«é€ä¿¡è¨­å®š
            send_smtp_email = sib_api_v3_sdk.SendSmtpEmail(
                to=[{"email": to_email, "name": to_name}],
                sender={
                    "email": settings.brevo_sender_email,
                    "name": settings.brevo_sender_name
                },
                subject="ã€YadOPERAã€‘ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªã®ãŠé¡˜ã„ï¼ˆå†é€ï¼‰",
                html_content=html_content,
                text_content=text_content
            )
            
            # ãƒ¡ãƒ¼ãƒ«é€ä¿¡
            api_response = self.api_instance.send_transac_email(send_smtp_email)
            logger.info(
                f"Verification reminder email sent successfully: to={to_email}, "
                f"message_id={api_response.message_id}"
            )
            return True
            
        except ApiException as e:
            logger.error(
                f"Brevo API error (reminder): to={to_email}, status={e.status}, "
                f"reason={e.reason}, body={e.body}"
            )
            raise  # ğŸŸ¡ tenacityãŒãƒªãƒˆãƒ©ã‚¤ã™ã‚‹
        except Exception as e:
            logger.error(
                f"Unexpected error sending verification reminder email: to={to_email}, "
                f"error={str(e)}",
                exc_info=True
            )
            raise  # ğŸŸ¡ tenacityãŒãƒªãƒˆãƒ©ã‚¤ã™ã‚‹
```

## 5.4 è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä¿®æ­£

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/app/core/config.py`

```python
# æ—¢å­˜ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ...
from pydantic_settings import BaseSettings
from typing import Optional

class Settings(BaseSettings):
    # æ—¢å­˜ã®è¨­å®š...
    
    # Email (Brevo) è¨­å®šè¿½åŠ 
    brevo_api_key: str = ""
    brevo_sender_email: str = "noreply@yadopera.com"
    brevo_sender_name: str = "YadOPERA"
    
    # Frontend URLï¼ˆãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ç”¨ï¼‰
    frontend_url: str = "http://localhost:5173"
    
    # ğŸŸ  ç®¡ç†è€…é€šçŸ¥ç”¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆé«˜å„ªå…ˆï¼‰
    admin_notification_email: str = ""
    
    class Config:
        env_file = ".env"
        case_sensitive = False

settings = Settings()
```

## 5.5 ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«ä¿®æ­£

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/app/models/user.py`

```python
"""
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«
"""

from sqlalchemy import Column, Integer, String, Boolean, DateTime, ForeignKey
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from app.database import Base


class User(Base):
    """
    ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«
    """
    __tablename__ = "users"

    id = Column(Integer, primary_key=True, index=True)
    facility_id = Column(Integer, ForeignKey("facilities.id", ondelete="CASCADE"), 
                         nullable=False, index=True)
    email = Column(String(255), unique=True, nullable=False, index=True)
    password_hash = Column(String(255), nullable=False)
    role = Column(String(50), default="staff")
    full_name = Column(String(255))
    is_active = Column(Boolean, default=True)
    
    # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªé–¢é€£ï¼ˆâ˜…è¿½åŠ ï¼‰
    email_verified = Column(Boolean, default=False, nullable=False)
    verification_token = Column(String(255), index=True)
    verification_token_expires = Column(DateTime(timezone=True))
    
    last_login_at = Column(DateTime(timezone=True))
    password_reset_token = Column(String(255), index=True)
    password_reset_expires = Column(DateTime(timezone=True))
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), server_default=func.now(), 
                        onupdate=func.now())

    # ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—
    facility = relationship("Facility", back_populates="users")
```

## 5.6 èªè¨¼ã‚¹ã‚­ãƒ¼ãƒä¿®æ­£

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/app/schemas/auth.py`

```python
"""
èªè¨¼é–¢é€£ã‚¹ã‚­ãƒ¼ãƒ
"""

from pydantic import BaseModel, EmailStr, Field
from typing import Optional
from datetime import datetime


class LoginRequest(BaseModel):
    """
    ãƒ­ã‚°ã‚¤ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    """
    email: EmailStr = Field(..., description="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹")
    password: str = Field(..., min_length=8, description="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰")


class UserResponse(BaseModel):
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãƒ¬ã‚¹ãƒãƒ³ã‚¹
    """
    id: int
    email: str
    full_name: Optional[str] = None
    role: str
    facility_id: int
    is_active: bool
    email_verified: bool  # â˜…è¿½åŠ 

    class Config:
        from_attributes = True


class LoginResponse(BaseModel):
    """
    ãƒ­ã‚°ã‚¤ãƒ³ãƒ¬ã‚¹ãƒãƒ³ã‚¹
    """
    access_token: str = Field(..., description="JWTã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³")
    token_type: str = Field(default="bearer", description="ãƒˆãƒ¼ã‚¯ãƒ³ã‚¿ã‚¤ãƒ—")
    expires_in: int = Field(..., description="ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ï¼ˆç§’ï¼‰")
    user: UserResponse = Field(..., description="ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±")


class LogoutResponse(BaseModel):
    """
    ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒ¬ã‚¹ãƒãƒ³ã‚¹
    """
    message: str = Field(default="Logged out successfully", description="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸")


class PasswordChangeRequest(BaseModel):
    """
    ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    """
    current_password: str = Field(..., min_length=1, description="ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰")
    new_password: str = Field(..., min_length=8, description="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆæœ€å°8æ–‡å­—ï¼‰")
    confirm_password: str = Field(..., min_length=8, description="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰")


class PasswordChangeResponse(BaseModel):
    """
    ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒ¬ã‚¹ãƒãƒ³ã‚¹
    """
    message: str = Field(default="Password changed successfully", 
                         description="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸")


class FacilityRegisterRequest(BaseModel):
    """
    æ–½è¨­ç™»éŒ²ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    """
    email: EmailStr = Field(..., description="æ–½è¨­ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹")
    password: str = Field(..., min_length=8, description="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆæœ€å°8æ–‡å­—ï¼‰")
    facility_name: str = Field(..., min_length=1, max_length=255, description="æ–½è¨­å")
    subscription_plan: str = Field(default="small", 
                                    description="æ–™é‡‘ãƒ—ãƒ©ãƒ³ï¼ˆfree/mini/small/standard/premiumï¼‰")


class FacilityRegisterResponse(BaseModel):
    """
    æ–½è¨­ç™»éŒ²ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆãƒ¡ãƒ¼ãƒ«ç¢ºèªå¾…ã¡ï¼‰
    """
    message: str = Field(..., description="ç™»éŒ²å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸")
    email: str = Field(..., description="ç™»éŒ²ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹")
    facility_name: str = Field(..., description="æ–½è¨­å")


class VerifyEmailRequest(BaseModel):
    """
    ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    """
    token: str = Field(..., min_length=1, description="ç¢ºèªãƒˆãƒ¼ã‚¯ãƒ³")


class VerifyEmailResponse(BaseModel):
    """
    ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªãƒ¬ã‚¹ãƒãƒ³ã‚¹
    """
    message: str = Field(..., description="ç¢ºèªå®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸")
    email: str = Field(..., description="ç¢ºèªæ¸ˆã¿ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹")


class ResendVerificationRequest(BaseModel):
    """
    ç¢ºèªãƒ¡ãƒ¼ãƒ«å†é€ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    """
    email: EmailStr = Field(..., description="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹")


class ResendVerificationResponse(BaseModel):
    """
    ç¢ºèªãƒ¡ãƒ¼ãƒ«å†é€ä¿¡ãƒ¬ã‚¹ãƒãƒ³ã‚¹
    """
    message: str = Field(..., description="å†é€ä¿¡å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸")
    email: str = Field(..., description="é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹")
```

## 5.7 èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹ä¿®æ­£ï¼ˆğŸ”´ğŸŸ  ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ãƒ»ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ”¹å–„ï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/app/services/auth_service.py`

ä¸»è¦ãªå¤‰æ›´ç‚¹ï¼š
1. ğŸ”´ `register_facility()` ã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—æ™‚ã®å‡¦ç†ã‚’æ”¹å–„
2. ğŸŸ  `verify_email()` ã§ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–
3. ğŸŸ  `login()` ã§ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ”¹å–„ï¼ˆæ—¥æœ¬èªãƒ»è‹±èªä½µè¨˜ï¼‰
4. FAQè‡ªå‹•æŠ•å…¥ã‚’ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸå¾Œã«å®Ÿè¡Œ

```python
"""
èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹
èªè¨¼ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
"""

from __future__ import annotations

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from datetime import datetime, timedelta
from app.models.user import User
from app.models.facility import Facility
from app.core.security import verify_password, hash_password
from app.core.jwt import create_access_token
from app.core.config import settings
from app.schemas.auth import (
    LoginRequest, LoginResponse, UserResponse, 
    FacilityRegisterRequest, FacilityRegisterResponse,
    VerifyEmailRequest, VerifyEmailResponse,
    ResendVerificationRequest, ResendVerificationResponse
)
from app.schemas.faq import FAQRequest
from app.services.faq_service import FAQService
from app.services.email_service import EmailService
from app.services.notification_service import notify_admin_email_failure  # ğŸŸ  è¿½åŠ 
from app.data.faq_presets import FAQ_PRESETS
from app.core.plan_limits import filter_faq_presets_by_plan
from fastapi import HTTPException, status, BackgroundTasks, Request
from typing import Optional
import logging
import uuid

logger = logging.getLogger(__name__)


def convert_subscription_plan_to_plan_type(subscription_plan: str) -> str:
    """
    subscription_planã‚’plan_typeã«å¤‰æ›
    
    Args:
        subscription_plan: æ–™é‡‘ãƒ—ãƒ©ãƒ³ï¼ˆ'free', 'mini', 'small', 'standard', 'premium'ï¼‰
    
    Returns:
        plan_type: ãƒ—ãƒ©ãƒ³ç¨®åˆ¥ï¼ˆ'Free', 'Mini', 'Small', 'Standard', 'Premium'ï¼‰
    """
    plan_mapping = {
        'free': 'Free',
        'mini': 'Mini',
        'small': 'Small',
        'standard': 'Standard',
        'premium': 'Premium'
    }
    return plan_mapping.get(subscription_plan.lower(), 'Free')


def get_plan_defaults(plan_type: str) -> dict:
    """
    ãƒ—ãƒ©ãƒ³ç¨®åˆ¥ã«å¿œã˜ãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’å–å¾—
    
    Args:
        plan_type: ãƒ—ãƒ©ãƒ³ç¨®åˆ¥ï¼ˆ'Free', 'Mini', 'Small', 'Standard', 'Premium'ï¼‰
    
    Returns:
        ãƒ—ãƒ©ãƒ³åˆ¥ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆmonthly_question_limit, faq_limit, language_limitï¼‰
    """
    defaults = {
        'Free': {
            'monthly_question_limit': 30,
            'faq_limit': 20,
            'language_limit': 1
        },
        'Mini': {
            'monthly_question_limit': None,
            'faq_limit': 20,
            'language_limit': 2
        },
        'Small': {
            'monthly_question_limit': 200,
            'faq_limit': 20,
            'language_limit': 3
        },
        'Standard': {
            'monthly_question_limit': 500,
            'faq_limit': 20,
            'language_limit': 4
        },
        'Premium': {
            'monthly_question_limit': 1000,
            'faq_limit': None,
            'language_limit': None
        }
    }
    return defaults.get(plan_type, defaults['Free'])


class AuthService:
    """
    èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹
    """
    
    @staticmethod
    async def _generate_unique_slug(db: AsyncSession, base_name: str) -> str:
        """
        URLã‚»ãƒ¼ãƒ•ãªãƒ¦ãƒ‹ãƒ¼ã‚¯slugã‚’ç”Ÿæˆ
        
        Args:
            db: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³
            base_name: æ–½è¨­å
        
        Returns:
            str: ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªslug
        """
        import uuid
        import re
        
        # æ–½è¨­åã‚’è‹±æ•°å­—ã«å¤‰æ›ï¼ˆæ—¥æœ¬èªã¯å‰Šé™¤ï¼‰
        slug_base = re.sub(r'[^\w\s-]', '', base_name.lower())
        slug_base = re.sub(r'[-\s]+', '-', slug_base).strip('-')
        
        # è‹±æ•°å­—ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨
        if not slug_base or len(slug_base) < 1:
            slug_base = "facility"
        
        # æœ€å¤§20æ–‡å­—ã«åˆ¶é™
        slug_base = slug_base[:20]
        
        # UUIDã®å…ˆé ­8æ–‡å­—ã‚’ä»˜ä¸
        unique_id = str(uuid.uuid4())[:8]
        slug = f"{slug_base}-{unique_id}"
        
        # å¿µã®ãŸã‚é‡è¤‡ãƒã‚§ãƒƒã‚¯
        result = await db.execute(
            select(Facility).where(Facility.slug == slug)
        )
        if result.scalar_one_or_none() is not None:
            slug = f"{slug_base}-{str(uuid.uuid4())}"
        
        return slug
    
    @staticmethod
    async def authenticate_user(
        db: AsyncSession,
        login_data: LoginRequest
    ) -> Optional[User]:
        """
        ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼
        
        Args:
            db: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³
            login_data: ãƒ­ã‚°ã‚¤ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
            
        Returns:
            èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆèªè¨¼å¤±æ•—æ™‚ã¯Noneï¼‰
        """
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
        result = await db.execute(
            select(User).where(User.email == login_data.email)
        )
        user = result.scalar_one_or_none()
        
        if user is None:
            return None
        
        # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼
        if not verify_password(login_data.password, user.password_hash):
            return None
        
        # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ç¢ºèª
        if not user.is_active:
            return None
        
        # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªæ¸ˆã¿ã‹ç¢ºèª
        if not user.email_verified:
            return None
        
        return user
    
    @staticmethod
    async def login(
        db: AsyncSession,
        login_data: LoginRequest,
        request: Optional["Request"] = None
    ) -> LoginResponse:
        """
        ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        
        Args:
            db: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³
            login_data: ãƒ­ã‚°ã‚¤ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
            request: ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã€User-Agentå–å¾—ç”¨ï¼‰
            
        Returns:
            ãƒ­ã‚°ã‚¤ãƒ³ãƒ¬ã‚¹ãƒãƒ³ã‚¹
            
        Raises:
            HTTPException: èªè¨¼å¤±æ•—æ™‚
        """
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼
        user = await AuthService.authenticate_user(db, login_data)
        
        if user is None:
            # ğŸŸ  ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æœªç¢ºèªã®å ´åˆã®è©³ç´°ã‚¨ãƒ©ãƒ¼ï¼ˆæ—¥æœ¬èªãƒ»è‹±èªä½µè¨˜ï¼‰
            result = await db.execute(
                select(User).where(User.email == login_data.email)
            )
            existing_user = result.scalar_one_or_none()
            
            if existing_user and not existing_user.email_verified:
                raise HTTPException(
                    status_code=status.HTTP_403_FORBIDDEN,
                    detail=(
                        "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒç¢ºèªã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
                        "ç™»éŒ²æ™‚ã«é€ä¿¡ã•ã‚ŒãŸç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚"
                        "ãƒ¡ãƒ¼ãƒ«ãŒå±Šã„ã¦ã„ãªã„å ´åˆã¯ã€ç¢ºèªãƒ¡ãƒ¼ãƒ«å†é€ä¿¡ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚"
                        "\n\n"
                        "Email address not verified. "
                        "Please check your email and verify your account. "
                        "If you didn't receive the email, please use the resend function."
                    ),
                )
            
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="Incorrect email or password",
                headers={"WWW-Authenticate": "Bearer"},
            )
        
        # æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ™‚åˆ»æ›´æ–°
        user.last_login_at = datetime.utcnow()
        await db.commit()
        await db.refresh(user)
        
        # ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ãƒ­ã‚°è¨˜éŒ²
        if request:
            from app.models.admin_activity_log import AdminActivityLog
            activity_log = AdminActivityLog(
                user_id=user.id,
                facility_id=user.facility_id,
                action_type="login",
                ip_address=request.client.host if request.client else None,
                user_agent=request.headers.get("user-agent")
            )
            db.add(activity_log)
            await db.commit()
        
        # JWTãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
        access_token = create_access_token(
            data={"sub": str(user.id), "email": user.email}
        )
        
        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä½œæˆ
        return LoginResponse(
            access_token=access_token,
            token_type="bearer",
            expires_in=settings.access_token_expire_minutes * 60,
            user=UserResponse(
                id=user.id,
                email=user.email,
                full_name=user.full_name,
                role=user.role,
                facility_id=user.facility_id,
                is_active=user.is_active,
                email_verified=user.email_verified,
            )
        )
    
    @staticmethod
    async def logout(
        db: AsyncSession,
        user: User
    ) -> dict:
        """
        ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        
        Args:
            db: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³
            user: ãƒ¦ãƒ¼ã‚¶ãƒ¼
            
        Returns:
            ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒ¬ã‚¹ãƒãƒ³ã‚¹
        """
        return {"message": "Logged out successfully"}
    
    @staticmethod
    async def register_facility_sync(
        db: AsyncSession,
        request: FacilityRegisterRequest
    ) -> tuple[User, Facility]:
        """
        æ–½è¨­ç™»éŒ²å‡¦ç†ï¼ˆåŒæœŸéƒ¨åˆ†ï¼šæ–½è¨­ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã®ã¿ï¼‰
        
        Args:
            db: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³
            request: æ–½è¨­ç™»éŒ²ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        
        Returns:
            (User, Facility): ä½œæˆã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨æ–½è¨­
        
        Raises:
            HTTPException: ç™»éŒ²å¤±æ•—æ™‚
        """
        # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹é‡è¤‡ãƒã‚§ãƒƒã‚¯
        result = await db.execute(
            select(User).where(User.email == request.email)
        )
        existing_user = result.scalar_one_or_none()
        if existing_user:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="Email already registered"
            )
        
        # ãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’å¤‰æ›ãƒ»è¨­å®š
        plan_type = convert_subscription_plan_to_plan_type(request.subscription_plan)
        plan_defaults = get_plan_defaults(plan_type)
        
        # æ–½è¨­ä½œæˆ
        facility = Facility(
            name=request.facility_name,
            slug=await AuthService._generate_unique_slug(db, request.facility_name),
            email=request.email,
            subscription_plan=request.subscription_plan,
            plan_type=plan_type,
            monthly_question_limit=plan_defaults['monthly_question_limit'],
            faq_limit=plan_defaults['faq_limit'],
            language_limit=plan_defaults['language_limit']
        )
        db.add(facility)
        await db.flush()
        
        # ãƒ¡ãƒ¼ãƒ«ç¢ºèªãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
        verification_token = str(uuid.uuid4())
        verification_token_expires = datetime.utcnow() + timedelta(hours=24)
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆis_active=False, ãƒ¡ãƒ¼ãƒ«ç¢ºèªãƒˆãƒ¼ã‚¯ãƒ³è¨­å®šï¼‰
        user = User(
            facility_id=facility.id,
            email=request.email,
            password_hash=hash_password(request.password),
            role="owner",
            full_name=None,
            is_active=False,  # ãƒ¡ãƒ¼ãƒ«ç¢ºèªã¾ã§ç„¡åŠ¹
            email_verified=False,  # ãƒ¡ãƒ¼ãƒ«æœªç¢ºèª
            verification_token=verification_token,
            verification_token_expires=verification_token_expires
        )
        db.add(user)
        await db.flush()
        
        # ã‚³ãƒŸãƒƒãƒˆï¼ˆæ–½è¨­ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã‚’ç¢ºå®šï¼‰
        await db.commit()
        
        return user, facility
    
    @staticmethod
    async def register_facility(
        db: AsyncSession,
        request: FacilityRegisterRequest,
        background_tasks: Optional[BackgroundTasks] = None
    ) -> FacilityRegisterResponse:
        """
        æ–½è¨­ç™»éŒ²å‡¦ç†ï¼ˆãƒ¡ãƒ¼ãƒ«ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼‰
        
        Args:
            db: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³
            request: æ–½è¨­ç™»éŒ²ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            background_tasks: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¿ã‚¹ã‚¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        
        Returns:
            æ–½è¨­ç™»éŒ²ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆãƒ¡ãƒ¼ãƒ«ç¢ºèªå¾…ã¡ï¼‰
        
        Raises:
            HTTPException: ç™»éŒ²å¤±æ•—æ™‚
        """
        # æ–½è¨­ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆåŒæœŸå‡¦ç†ï¼‰
        user, facility = await AuthService.register_facility_sync(db, request)
        
        # ãƒ¡ãƒ¼ãƒ«ç¢ºèªURLç”Ÿæˆ
        verification_url = (
            f"{settings.frontend_url}/admin/verify-email"
            f"?token={user.verification_token}"
        )
        
        # ğŸ”´ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆãƒªãƒˆãƒ©ã‚¤å‡¦ç†ä»˜ãï¼‰
        email_service = EmailService()
        email_sent = False
        error_message = None
        
        try:
            email_sent = await email_service.send_verification_email(
                to_email=user.email,
                to_name=facility.name,
                verification_url=verification_url
            )
        except Exception as e:
            error_message = str(e)
            logger.error(
                f"Failed to send verification email after retries: "
                f"user_id={user.id}, email={user.email}, error={error_message}"
            )
        
        # ğŸŸ  ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—æ™‚ã®ç®¡ç†è€…é€šçŸ¥
        if not email_sent:
            try:
                await notify_admin_email_failure(
                    user_email=user.email,
                    facility_name=facility.name,
                    error_message=error_message or "Unknown error"
                )
            except Exception as notify_error:
                logger.error(
                    f"Failed to notify admin: {str(notify_error)}",
                    exc_info=True
                )
        
        # ğŸ”´ FAQè‡ªå‹•æŠ•å…¥ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡çŠ¶æ³ã«é–¢ä¿‚ãªãå®Ÿè¡Œï¼‰
        if background_tasks:
            background_tasks.add_task(
                AuthService.register_facility_async_faqs,
                facility.id,
                user.id,
                request.subscription_plan
            )
        else:
            logger.warning(
                "BackgroundTasks not available, running FAQ creation synchronously"
            )
            await AuthService.register_facility_async_faqs(
                facility.id,
                user.id,
                request.subscription_plan
            )
        
        return FacilityRegisterResponse(
            message=(
                "Registration successful. Please check your email to verify your account."
            ),
            email=user.email,
            facility_name=facility.name
        )
    
    @staticmethod
    async def verify_email(
        db: AsyncSession,
        request: VerifyEmailRequest
    ) -> VerifyEmailResponse:
        """
        ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªå‡¦ç†ï¼ˆğŸŸ  ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼‰
        
        Args:
            db: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³
            request: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        
        Returns:
            ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªãƒ¬ã‚¹ãƒãƒ³ã‚¹
        
        Raises:
            HTTPException: ç¢ºèªå¤±æ•—æ™‚
        """
        # ãƒˆãƒ¼ã‚¯ãƒ³ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
        result = await db.execute(
            select(User).where(User.verification_token == request.token)
        )
        user = result.scalar_one_or_none()
        
        # ğŸŸ  ãƒˆãƒ¼ã‚¯ãƒ³ãŒå­˜åœ¨ã—ãªã„ã€ã¾ãŸã¯æœ‰åŠ¹æœŸé™åˆ‡ã‚Œã®å ´åˆã¯åŒã˜ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        # ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ãƒˆãƒ¼ã‚¯ãƒ³ã®å­˜åœ¨ãƒ»éå­˜åœ¨ã‚’æ¨æ¸¬ã•ã›ãªã„ï¼‰
        if user is None or (
            user.verification_token_expires and 
            user.verification_token_expires < datetime.utcnow()
        ):
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="Invalid or expired verification token. Please request a new one."
            )
        
        # æ—¢ã«ç¢ºèªæ¸ˆã¿ã®å ´åˆ
        if user.email_verified:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="Email already verified. You can log in now."
            )
        
        # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªå®Œäº†
        user.email_verified = True
        user.is_active = True  # ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæœ‰åŠ¹åŒ–
        user.verification_token = None  # ãƒˆãƒ¼ã‚¯ãƒ³ã‚¯ãƒªã‚¢
        user.verification_token_expires = None  # æœ‰åŠ¹æœŸé™ã‚¯ãƒªã‚¢
        
        await db.commit()
        await db.refresh(user)
        
        logger.info(
            f"Email verified successfully: user_id={user.id}, email={user.email}"
        )
        
        return VerifyEmailResponse(
            message="Email verified successfully. You can now log in.",
            email=user.email
        )
    
    @staticmethod
    async def resend_verification_email(
        db: AsyncSession,
        request: ResendVerificationRequest
    ) -> ResendVerificationResponse:
        """
        ç¢ºèªãƒ¡ãƒ¼ãƒ«å†é€ä¿¡å‡¦ç†
        
        Args:
            db: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³
            request: ç¢ºèªãƒ¡ãƒ¼ãƒ«å†é€ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        
        Returns:
            ç¢ºèªãƒ¡ãƒ¼ãƒ«å†é€ä¿¡ãƒ¬ã‚¹ãƒãƒ³ã‚¹
        
        Raises:
            HTTPException: å†é€ä¿¡å¤±æ•—æ™‚
        """
        # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
        result = await db.execute(
            select(User).where(User.email == request.email)
        )
        user = result.scalar_one_or_none()
        
        if user is None:
            # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã§ã‚‚åŒã˜ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
            return ResendVerificationResponse(
                message="If the email address is registered, a verification email has been sent.",
                email=request.email
            )
        
        # æ—¢ã«ç¢ºèªæ¸ˆã¿ã®å ´åˆ
        if user.email_verified:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="Email already verified"
            )
        
        # æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
        user.verification_token = str(uuid.uuid4())
        user.verification_token_expires = datetime.utcnow() + timedelta(hours=24)
        
        await db.commit()
        await db.refresh(user)
        
        # æ–½è¨­æƒ…å ±å–å¾—
        facility_result = await db.execute(
            select(Facility).where(Facility.id == user.facility_id)
        )
        facility = facility_result.scalar_one_or_none()
        
        # ãƒ¡ãƒ¼ãƒ«ç¢ºèªURLç”Ÿæˆ
        verification_url = (
            f"{settings.frontend_url}/admin/verify-email"
            f"?token={user.verification_token}"
        )
        
        # ãƒ¡ãƒ¼ãƒ«é€ä¿¡
        email_service = EmailService()
        email_sent = False
        error_message = None
        
        try:
            email_sent = await email_service.send_verification_reminder_email(
                to_email=user.email,
                to_name=facility.name if facility else "User",
                verification_url=verification_url
            )
        except Exception as e:
            error_message = str(e)
            logger.error(
                f"Failed to resend verification email: user_id={user.id}, "
                f"email={user.email}, error={error_message}"
            )
        
        # ğŸŸ  ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—æ™‚ã®ç®¡ç†è€…é€šçŸ¥
        if not email_sent:
            try:
                await notify_admin_email_failure(
                    user_email=user.email,
                    facility_name=facility.name if facility else "Unknown",
                    error_message=error_message or "Unknown error"
                )
            except Exception as notify_error:
                logger.error(
                    f"Failed to notify admin: {str(notify_error)}",
                    exc_info=True
                )
            
            raise HTTPException(
                status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
                detail="Failed to send verification email. Please try again later."
            )
        
        logger.info(
            f"Verification email resent: user_id={user.id}, email={user.email}"
        )
        
        return ResendVerificationResponse(
            message="Verification email resent successfully. Please check your inbox.",
            email=user.email
        )
    
    @staticmethod
    async def register_facility_async_faqs(
        facility_id: int,
        user_id: int,
        subscription_plan: str
    ):
        """
        FAQè‡ªå‹•æŠ•å…¥å‡¦ç†ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡Œï¼‰
        
        Args:
            facility_id: æ–½è¨­ID
            user_id: ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
            subscription_plan: æ–™é‡‘ãƒ—ãƒ©ãƒ³
        """
        from app.database import AsyncSessionLocal
        from app.data.faq_presets import FAQ_PRESETS
        from app.schemas.faq import FAQRequest
        from app.core.cache import delete_cache_pattern
        
        # æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
        async with AsyncSessionLocal() as db:
            try:
                # æ–™é‡‘ãƒ—ãƒ©ãƒ³ã«åŸºã¥ã„ã¦FAQãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿
                filtered_presets = filter_faq_presets_by_plan(
                    FAQ_PRESETS,
                    subscription_plan
                )
                
                # ãƒ—ãƒªã‚»ãƒƒãƒˆFAQã‚’FAQRequestã«å¤‰æ›
                faq_requests = []
                for preset in filtered_presets:
                    faq_request = FAQRequest(
                        category=preset["category"],
                        intent_key=preset["intent_key"],
                        translations=[
                            {
                                "language": t["language"],
                                "question": t["question"],
                                "answer": t["answer"]
                            } for t in preset["translations"]
                        ],
                        priority=preset["priority"],
                        is_active=True
                    )
                    faq_requests.append(faq_request)
                
                # FAQä¸€æ‹¬ä½œæˆ
                await FAQService(db).bulk_create_faqs(facility_id, faq_requests, user_id)
                await db.commit()
                
                # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
                try:
                    deleted_count = await delete_cache_pattern(
                        f"faq:list:*facility_id={facility_id}*"
                    )
                    logger.info(
                        f"FAQ cache invalidated: {deleted_count} keys deleted "
                        f"(facility_id={facility_id})"
                    )
                except Exception as e:
                    logger.warning(
                        f"Failed to invalidate FAQ cache: facility_id={facility_id}, "
                        f"error={str(e)}",
                        exc_info=True
                    )
                
                logger.info(
                    f"Background FAQ creation completed: facility_id={facility_id}, "
                    f"plan={subscription_plan}, count={len(faq_requests)}"
                )
                
                # 5ç§’å¾…ã£ã¦ã‹ã‚‰å†åº¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
                import asyncio
                await asyncio.sleep(5)
                
                try:
                    deleted_count = await delete_cache_pattern(
                        f"faq:list:*facility_id={facility_id}*"
                    )
                    logger.info(
                        f"FAQ cache invalidated (delayed): {deleted_count} keys deleted "
                        f"(facility_id={facility_id})"
                    )
                except Exception as e:
                    logger.warning(
                        f"Failed to invalidate FAQ cache (delayed): facility_id={facility_id}, "
                        f"error={str(e)}",
                        exc_info=True
                    )
            except Exception as e:
                logger.error(
                    f"Background FAQ creation failed: facility_id={facility_id}, "
                    f"plan={subscription_plan}, error={str(e)}",
                    exc_info=True
                )
```

## 5.8 èªè¨¼APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¿®æ­£

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/app/api/v1/auth.py`

```python
"""
èªè¨¼APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
"""

from fastapi import APIRouter, Depends, HTTPException, status, BackgroundTasks, Request
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.exc import IntegrityError
from app.database import get_db
from app.api.deps import get_current_user
from app.core.rate_limit import check_resend_rate_limit  # ğŸ”´ è¿½åŠ 
from app.schemas.auth import (
    LoginRequest, LoginResponse, LogoutResponse, UserResponse,
    PasswordChangeRequest, PasswordChangeResponse,
    FacilityRegisterRequest, FacilityRegisterResponse,
    VerifyEmailRequest, VerifyEmailResponse,
    ResendVerificationRequest, ResendVerificationResponse
)
from app.services.auth_service import AuthService
from app.models.user import User
from app.core.security import hash_password, verify_password

router = APIRouter(prefix="/auth", tags=["auth"])


@router.post("/login", response_model=LoginResponse)
async def login(
    login_data: LoginRequest,
    request: Request,
    db: AsyncSession = Depends(get_db)
):
    """
    ãƒ­ã‚°ã‚¤ãƒ³
    
    - **email**: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
    - **password**: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
    
    æˆåŠŸæ™‚ã¯JWTã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿”å´
    
    â˜…æ³¨æ„: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªæ¸ˆã¿ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½
    """
    return await AuthService.login(db, login_data, request)


@router.post("/register", response_model=FacilityRegisterResponse)
async def register_facility(
    request: FacilityRegisterRequest,
    background_tasks: BackgroundTasks,
    db: AsyncSession = Depends(get_db)
):
    """
    æ–½è¨­ç™»éŒ²
    
    - **email**: æ–½è¨­ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
    - **password**: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆæœ€å°8æ–‡å­—ï¼‰
    - **facility_name**: æ–½è¨­å
    - **subscription_plan**: æ–™é‡‘ãƒ—ãƒ©ãƒ³ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: smallï¼‰
    
    â˜…å¤‰æ›´ç‚¹:
    - ç™»éŒ²å¾Œã€ãƒ¡ãƒ¼ãƒ«ç¢ºèªãŒå¿…è¦ã«ãªã‚Šã¾ã—ãŸ
    - ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã€ãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¾ã™
    - FAQè‡ªå‹•æŠ•å…¥ã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã¾ã™
    """
    try:
        return await AuthService.register_facility(db, request, background_tasks)
    except IntegrityError as e:
        error_str = str(e.orig) if hasattr(e, 'orig') else str(e)
        if "idx_facilities_slug" in error_str:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="æ–½è¨­ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚åŒã˜æ–½è¨­åãŒæ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"
            )
        elif "idx_facilities_email" in error_str or "email" in error_str.lower():
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚"
            )
        else:
            raise HTTPException(
                status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
                detail="æ–½è¨­ã®ç™»éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"
            )
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"
        )


@router.post("/verify-email", response_model=VerifyEmailResponse)
async def verify_email(
    request: VerifyEmailRequest,
    db: AsyncSession = Depends(get_db)
):
    """
    ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèª
    
    - **token**: ç¢ºèªãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆãƒ¡ãƒ¼ãƒ«ã«è¨˜è¼‰ã•ã‚ŒãŸURLå†…ã®ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰
    
    ç¢ºèªæˆåŠŸæ™‚ã¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒæœ‰åŠ¹åŒ–ã•ã‚Œã€ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½ã«ãªã‚Šã¾ã™
    """
    return await AuthService.verify_email(db, request)


@router.post("/resend-verification", response_model=ResendVerificationResponse)
async def resend_verification_email(
    request: ResendVerificationRequest,
    db: AsyncSession = Depends(get_db)
):
    """
    ç¢ºèªãƒ¡ãƒ¼ãƒ«å†é€ä¿¡
    
    - **email**: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
    
    ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’å†é€ä¿¡ã—ã¾ã™ï¼ˆæœ‰åŠ¹æœŸé™ã¯æ–°ãŸã«24æ™‚é–“ï¼‰
    
    â˜…ãƒ¬ãƒ¼ãƒˆåˆ¶é™: 60ç§’ã«1å›ã¾ã§
    """
    # ğŸ”´ ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
    check_resend_rate_limit(request.email, cooldown_seconds=60)
    
    return await AuthService.resend_verification_email(db, request)


@router.get("/me", response_model=UserResponse)
async def get_current_user_info(
    current_user: User = Depends(get_current_user)
):
    """
    ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
    
    JWTãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¿”å´
    """
    return UserResponse(
        id=current_user.id,
        email=current_user.email,
        full_name=current_user.full_name,
        role=current_user.role,
        facility_id=current_user.facility_id,
        is_active=current_user.is_active,
        email_verified=current_user.email_verified
    )


@router.post("/logout", response_model=LogoutResponse)
async def logout(
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """
    ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    
    JWTãƒˆãƒ¼ã‚¯ãƒ³ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§å‰Šé™¤
    """
    try:
        await AuthService.logout(db, current_user)
        return LogoutResponse(message="Logged out successfully")
    except HTTPException as e:
        if e.status_code == status.HTTP_403_FORBIDDEN:
            return LogoutResponse(message="Logged out successfully")
        raise


@router.put("/password", response_model=PasswordChangeResponse, status_code=status.HTTP_200_OK)
async def change_password(
    request: PasswordChangeRequest,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """
    ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
    
    JWTèªè¨¼å¿…é ˆã€‚ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã™ã€‚
    """
    try:
        if not verify_password(request.current_password, current_user.password_hash):
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="Current password is incorrect"
            )
        
        if request.new_password != request.confirm_password:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="New password and confirm password do not match"
            )
        
        if len(request.new_password) < 8:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="Password must be at least 8 characters long"
            )
        
        current_user.password_hash = hash_password(request.new_password)
        await db.commit()
        
        return PasswordChangeResponse(message="Password changed successfully")
    
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Error changing password: {str(e)}"
        )
```

## 5.9 ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆï¼ˆğŸ”´ æœ€å„ªå…ˆï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/app/core/rate_limit.py`ï¼ˆæ–°è¦ä½œæˆï¼‰

```python
"""
APIãƒ¬ãƒ¼ãƒˆåˆ¶é™
"""

from fastapi import HTTPException, status
from datetime import datetime, timedelta
from typing import Dict
import logging

logger = logging.getLogger(__name__)

# ãƒ¡ãƒ¢ãƒªãƒ™ãƒ¼ã‚¹ã®ç°¡æ˜“ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆæœ¬ç•ªã§ã¯Redisæ¨å¥¨ï¼‰
_resend_attempts: Dict[str, datetime] = {}


def check_resend_rate_limit(email: str, cooldown_seconds: int = 60):
    """
    ãƒ¡ãƒ¼ãƒ«å†é€ä¿¡ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
    
    Args:
        email: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
        cooldown_seconds: ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ç§’æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ60ç§’ï¼‰
    
    Raises:
        HTTPException: ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…éæ™‚
    """
    now = datetime.utcnow()
    last_attempt = _resend_attempts.get(email)
    
    if last_attempt and (now - last_attempt).total_seconds() < cooldown_seconds:
        remaining = cooldown_seconds - int((now - last_attempt).total_seconds())
        logger.warning(
            f"Rate limit exceeded: email={email}, remaining={remaining}s"
        )
        raise HTTPException(
            status_code=status.HTTP_429_TOO_MANY_REQUESTS,
            detail=f"Please wait {remaining} seconds before resending."
        )
    
    _resend_attempts[email] = now
    logger.info(f"Rate limit check passed: email={email}")


def cleanup_old_attempts(max_age_minutes: int = 60):
    """
    å¤ã„ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¨˜éŒ²ã‚’å‰Šé™¤ï¼ˆãƒ¡ãƒ¢ãƒªç¯€ç´„ï¼‰
    
    Args:
        max_age_minutes: å‰Šé™¤å¯¾è±¡ã®çµŒéæ™‚é–“ï¼ˆåˆ†ï¼‰
    """
    now = datetime.utcnow()
    cutoff = now - timedelta(minutes=max_age_minutes)
    
    old_keys = [
        email for email, timestamp in _resend_attempts.items()
        if timestamp < cutoff
    ]
    
    for email in old_keys:
        del _resend_attempts[email]
    
    if old_keys:
        logger.info(f"Cleaned up {len(old_keys)} old rate limit records")
```

## 5.10 ç®¡ç†è€…é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ä½œæˆï¼ˆğŸŸ  é«˜å„ªå…ˆï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/app/services/notification_service.py`ï¼ˆæ–°è¦ä½œæˆï¼‰

```python
"""
ç®¡ç†è€…é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹
"""

import sib_api_v3_sdk
from sib_api_v3_sdk.rest import ApiException
from app.core.config import settings
import logging

logger = logging.getLogger(__name__)


async def notify_admin_email_failure(
    user_email: str,
    facility_name: str,
    error_message: str
):
    """
    ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—ã‚’ç®¡ç†è€…ã«é€šçŸ¥
    
    Args:
        user_email: é€ä¿¡å¤±æ•—ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
        facility_name: æ–½è¨­å
        error_message: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    """
    try:
        # Brevo APIè¨­å®š
        configuration = sib_api_v3_sdk.Configuration()
        configuration.api_key['api-key'] = settings.brevo_api_key
        api_instance = sib_api_v3_sdk.TransactionalEmailsApi(
            sib_api_v3_sdk.ApiClient(configuration)
        )
        
        # ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡
        html_content = f"""
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—é€šçŸ¥ - YadOPERA</title>
</head>
<body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
    <div style="background-color: #fee; border-left: 4px solid #c00; padding: 20px; margin-bottom: 20px;">
        <h2 style="color: #c00; margin-top: 0;">ã€é‡è¦ã€‘ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—é€šçŸ¥</h2>
        
        <p><strong>æ–½è¨­å:</strong> {facility_name}</p>
        <p><strong>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:</strong> {user_email}</p>
        <p><strong>ã‚¨ãƒ©ãƒ¼å†…å®¹:</strong></p>
        <pre style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto;">{error_message}</pre>
        
        <p style="margin-top: 20px; color: #c00;">
            <strong>å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç›´æ¥é€£çµ¡ã—ã¦ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’æ‰‹å‹•ã§é€ä¿¡ã—ã¦ãã ã•ã„ã€‚</strong>
        </p>
    </div>
    
    <div style="font-size: 12px; color: #999; border-top: 1px solid #eee; padding-top: 10px;">
        <p>Â© 2026 YadOPERA. All rights reserved.</p>
    </div>
</body>
</html>
        """
        
        text_content = f"""
ã€é‡è¦ã€‘ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—é€šçŸ¥

æ–½è¨­å: {facility_name}
ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: {user_email}
ã‚¨ãƒ©ãƒ¼å†…å®¹:
{error_message}

å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç›´æ¥é€£çµ¡ã—ã¦ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’æ‰‹å‹•ã§é€ä¿¡ã—ã¦ãã ã•ã„ã€‚

---
Â© 2026 YadOPERA. All rights reserved.
        """
        
        # ãƒ¡ãƒ¼ãƒ«é€ä¿¡è¨­å®š
        send_smtp_email = sib_api_v3_sdk.SendSmtpEmail(
            to=[{"email": settings.admin_notification_email, "name": "YadOPERA Admin"}],
            sender={
                "email": settings.brevo_sender_email,
                "name": "YadOPERA System"
            },
            subject="ã€YadOPERAã€‘ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—é€šçŸ¥",
            html_content=html_content,
            text_content=text_content
        )
        
        # ãƒ¡ãƒ¼ãƒ«é€ä¿¡
        api_response = api_instance.send_transac_email(send_smtp_email)
        logger.info(
            f"Admin notification sent: user_email={user_email}, "
            f"message_id={api_response.message_id}"
        )
    
    except ApiException as e:
        logger.error(
            f"Failed to send admin notification: user_email={user_email}, "
            f"status={e.status}, reason={e.reason}, body={e.body}"
        )
    except Exception as e:
        logger.error(
            f"Unexpected error sending admin notification: user_email={user_email}, "
            f"error={str(e)}",
            exc_info=True
        )
```

================================================================================
6. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…
================================================================================

## 6.1 Register.vueä¿®æ­£

**ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/views/admin/Register.vue`

ä¸»è¦ãªå¤‰æ›´ç‚¹ï¼š
1. ç™»éŒ²æˆåŠŸæ™‚ã«ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†ç”»é¢ã¸é·ç§»
2. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã®æ”¹å–„

```vue
<template>
  <div class="min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center px-4 py-12">
    <div class="w-full max-w-md">
      <!-- ç™»éŒ²ã‚«ãƒ¼ãƒ‰ -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 p-8">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="text-center mb-8">
          <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
            YadOPERA
          </h1>
          <p class="text-gray-600 dark:text-gray-400">
            æ–°è¦æ–½è¨­ç™»éŒ² / Facility Registration
          </p>
        </div>

        <!-- ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
        <form @submit.prevent="handleRegister" class="space-y-6">
          <!-- æ–½è¨­å -->
          <div>
            <label for="facility_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              æ–½è¨­å / Facility Name
            </label>
            <input
              id="facility_name"
              v-model="form.facility_name"
              type="text"
              required
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
              placeholder="ä¾‹: æ±äº¬ã‚²ã‚¹ãƒˆãƒã‚¦ã‚¹"
            />
          </div>

          <!-- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ -->
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ / Email
            </label>
            <input
              id="email"
              v-model="form.email"
              type="email"
              required
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
              placeholder="admin@example.com"
            />
          </div>

          <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ -->
          <div>
            <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ / Password
            </label>
            <input
              id="password"
              v-model="form.password"
              type="password"
              required
              minlength="8"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
              placeholder="8æ–‡å­—ä»¥ä¸Š"
            />
          </div>

          <!-- æ–™é‡‘ãƒ—ãƒ©ãƒ³ -->
          <div>
            <label for="subscription_plan" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              æ–™é‡‘ãƒ—ãƒ©ãƒ³ / Subscription Plan
            </label>
            <select
              id="subscription_plan"
              v-model="form.subscription_plan"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
            >
              <option value="free">Free</option>
              <option value="mini">Mini</option>
              <option value="small">Small (æ¨å¥¨)</option>
              <option value="standard">Standard</option>
              <option value="premium">Premium</option>
            </select>
          </div>

          <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
          <div v-if="errorMessage" class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-md p-3">
            <p class="text-red-600 dark:text-red-400 text-sm">
              {{ errorMessage }}
            </p>
          </div>

          <!-- ç™»éŒ²ãƒœã‚¿ãƒ³ -->
          <button
            type="submit"
            :disabled="isLoading"
            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <span v-if="isLoading" class="flex items-center">
              <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              ç™»éŒ²ä¸­...
            </span>
            <span v-else>
              æ–½è¨­ã‚’ç™»éŒ² / Register Facility
            </span>
          </button>
        </form>

        <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ -->
        <div class="mt-6 text-center">
          <p class="text-sm text-gray-600 dark:text-gray-400">
            æ—¢ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ã™ã‹ï¼Ÿ
            <router-link to="/admin/login" class="font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400">
              ãƒ­ã‚°ã‚¤ãƒ³ / Login
            </router-link>
          </p>
        </div>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
        <div class="mt-6 text-center">
          <p class="text-xs text-gray-500 dark:text-gray-400">
            Â© 2026 YadOPERA. All rights reserved.
          </p>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive } from 'vue'
import { useRouter } from 'vue-router'
import axios from 'axios'

const router = useRouter()

const form = reactive({
  email: '',
  password: '',
  facility_name: '',
  subscription_plan: 'small'
})

const isLoading = ref(false)
const errorMessage = ref('')

const handleRegister = async () => {
  try {
    isLoading.value = true
    errorMessage.value = ''

    const response = await axios.post(`${import.meta.env.VITE_API_BASE_URL}/api/v1/auth/register`, {
      email: form.email,
      password: form.password,
      facility_name: form.facility_name,
      subscription_plan: form.subscription_plan
    })

    // â˜…æˆåŠŸæ™‚ã¯ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†ç”»é¢ã¸é·ç§»
    router.push({
      name: 'EmailVerificationPending',
      query: {
        email: form.email,
        facility_name: form.facility_name
      }
    })
  } catch (error: any) {
    if (error.response?.data?.detail) {
      errorMessage.value = error.response.data.detail
    } else {
      errorMessage.value = 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
    }
  } finally {
    isLoading.value = false
  }
}
</script>
```

## 6.2 ãƒ¡ãƒ¼ãƒ«ç¢ºèªå¾…ã¡ç”»é¢ä½œæˆï¼ˆğŸŸ¡ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/views/admin/EmailVerificationPending.vue`ï¼ˆæ–°è¦ä½œæˆï¼‰

```vue
<template>
  <div class="min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center px-4 py-12">
    <div class="w-full max-w-md">
      <!-- ç¢ºèªå¾…ã¡ã‚«ãƒ¼ãƒ‰ -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 p-8">
        <!-- ã‚¢ã‚¤ã‚³ãƒ³ -->
        <div class="flex justify-center mb-6">
          <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center">
            <svg class="w-8 h-8 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
          </div>
        </div>

        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="text-center mb-6">
          <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
            ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ
          </h1>
          <p class="text-gray-600 dark:text-gray-400 text-sm">
            Email Verification Sent
          </p>
        </div>

        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div class="space-y-4 mb-6">
          <p class="text-gray-700 dark:text-gray-300">
            {{ facilityName }} æ§˜
          </p>
          <p class="text-gray-700 dark:text-gray-300">
            ä»¥ä¸‹ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼š
          </p>
          <p class="text-blue-600 dark:text-blue-400 font-semibold text-center bg-blue-50 dark:bg-blue-900/20 py-2 px-4 rounded-md">
            {{ email }}
          </p>
          <p class="text-gray-700 dark:text-gray-300">
            ãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„ã€‚
          </p>
          <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-md p-3">
            <p class="text-yellow-800 dark:text-yellow-200 text-sm">
              <strong>æ³¨æ„:</strong> ç¢ºèªãƒªãƒ³ã‚¯ã¯24æ™‚é–“å¾Œã«ç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚
            </p>
          </div>
        </div>

        <!-- å†é€ä¿¡ãƒœã‚¿ãƒ³ -->
        <div class="space-y-4">
          <button
            @click="resendEmail"
            :disabled="isResending || cooldownRemaining > 0"
            class="w-full flex justify-center py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <span v-if="isResending" class="flex items-center">
              <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-700 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              é€ä¿¡ä¸­...
            </span>
            <span v-else-if="cooldownRemaining > 0">
              å†é€ä¿¡ã¾ã§ {{ cooldownRemaining }}ç§’
            </span>
            <span v-else>
              ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’å†é€ä¿¡
            </span>
          </button>

          <!-- æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
          <div v-if="resendSuccess" class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-md p-3">
            <p class="text-green-600 dark:text-green-400 text-sm">
              ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’å†é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
            </p>
          </div>

          <!-- ğŸŸ¡ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå¼·åŒ–ï¼‰ -->
          <div v-if="resendError" class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-md p-3">
            <p class="text-red-600 dark:text-red-400 text-sm">
              {{ resendError }}
            </p>
          </div>
        </div>

        <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ -->
        <div class="mt-6 text-center">
          <p class="text-sm text-gray-600 dark:text-gray-400">
            æ—¢ã«ç¢ºèªæ¸ˆã¿ã§ã™ã‹ï¼Ÿ
            <router-link to="/admin/login" class="font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400">
              ãƒ­ã‚°ã‚¤ãƒ³ / Login
            </router-link>
          </p>
        </div>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
        <div class="mt-6 text-center">
          <p class="text-xs text-gray-500 dark:text-gray-400">
            Â© 2026 YadOPERA. All rights reserved.
          </p>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, onUnmounted } from 'vue'
import { useRoute } from 'vue-router'
import axios from 'axios'

const route = useRoute()

const email = ref(route.query.email as string || '')
const facilityName = ref(route.query.facility_name as string || '')
const isResending = ref(false)
const resendSuccess = ref(false)
const resendError = ref('')
const cooldownRemaining = ref(0)
let cooldownTimer: number | null = null

const resendEmail = async () => {
  try {
    isResending.value = true
    resendSuccess.value = false
    resendError.value = ''

    await axios.post(`${import.meta.env.VITE_API_BASE_URL}/api/v1/auth/resend-verification`, {
      email: email.value
    })

    resendSuccess.value = true
    
    // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³é–‹å§‹ï¼ˆ60ç§’ï¼‰
    cooldownRemaining.value = 60
    cooldownTimer = window.setInterval(() => {
      cooldownRemaining.value--
      if (cooldownRemaining.value <= 0 && cooldownTimer) {
        clearInterval(cooldownTimer)
        cooldownTimer = null
      }
    }, 1000)
  } catch (error: any) {
    // ğŸŸ¡ HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰åˆ¥ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†ï¼ˆå¼·åŒ–ï¼‰
    if (error.response) {
      // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹
      const status = error.response.status
      const detail = error.response.data?.detail
      
      if (status === 429) {
        // ãƒ¬ãƒ¼ãƒˆåˆ¶é™
        resendError.value = 'ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚ï¼ˆ60ç§’ï¼‰'
      } else if (detail) {
        resendError.value = detail
      } else {
        resendError.value = 'å†é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'
      }
    } else if (error.request) {
      // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯é€ä¿¡ã•ã‚ŒãŸãŒãƒ¬ã‚¹ãƒãƒ³ã‚¹ãªã—ï¼‰
      resendError.value = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
    } else {
      // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
      resendError.value = 'äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'
    }
  } finally {
    isResending.value = false
  }
}

onMounted(() => {
  // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒãªã„å ´åˆã¯ç™»éŒ²ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  if (!email.value) {
    window.location.href = '/admin/register'
  }
})

onUnmounted(() => {
  if (cooldownTimer) {
    clearInterval(cooldownTimer)
  }
})
</script>
```

## 6.3 ãƒ¡ãƒ¼ãƒ«ç¢ºèªå®Œäº†ç”»é¢ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/views/admin/EmailVerificationSuccess.vue`ï¼ˆæ–°è¦ä½œæˆï¼‰

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ–‡å­—æ•°åˆ¶é™ã«ã‚ˆã‚Šã€è¨ˆç”»æ›¸v1.0ã¨åŒä¸€å†…å®¹ã®ãŸã‚çœç•¥ã—ã¾ã™ã€‚
å®Ÿè£…æ™‚ã¯ä»¥ä¸‹ã®URLã‹ã‚‰å‚ç…§ã—ã¦ãã ã•ã„ï¼š
`docs/Email address confirmation function implemented-plan.txt` ã® 6.3ç« 

## 6.4 ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®š

**ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/router/index.ts`

```typescript
import { createRouter, createWebHistory } from 'vue-router'
import type { RouteRecordRaw } from 'vue-router'

const routes: Array<RouteRecordRaw> = [
  // æ—¢å­˜ã®ãƒ«ãƒ¼ãƒˆ...
  
  // ç®¡ç†è€…èªè¨¼é–¢é€£
  {
    path: '/admin/register',
    name: 'Register',
    component: () => import('@/views/admin/Register.vue'),
    meta: { requiresGuest: true }
  },
  {
    path: '/admin/verify-email-pending',
    name: 'EmailVerificationPending',
    component: () => import('@/views/admin/EmailVerificationPending.vue'),
    meta: { requiresGuest: true }
  },
  {
    path: '/admin/verify-email',
    name: 'EmailVerificationSuccess',
    component: () => import('@/views/admin/EmailVerificationSuccess.vue'),
    meta: { requiresGuest: true }
  },
  {
    path: '/admin/login',
    name: 'Login',
    component: () => import('@/views/admin/Login.vue'),
    meta: { requiresGuest: true }
  },
  
  // ãã®ä»–ã®æ—¢å­˜ãƒ«ãƒ¼ãƒˆ...
]

const router = createRouter({
  history: createWebHistory(),
  routes
})

export default router
```

## 6.5 Login.vueä¿®æ­£ï¼ˆğŸŸ  ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ”¹å–„ï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/views/admin/Login.vue`

ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ãƒ¡ãƒ¼ãƒ«æœªç¢ºèªã‚¨ãƒ©ãƒ¼ã‚’é©åˆ‡ã«è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ä¿®æ­£ï¼š

```vue
<!-- æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã¯ç¶­æŒã€handleLoginé–¢æ•°ã®ã¿ä¿®æ­£ -->

<script setup lang="ts">
// æ—¢å­˜ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ...

const handleLogin = async () => {
  try {
    isLoading.value = true
    errorMessage.value = ''

    await login({
      email: form.email,
      password: form.password
    })
  } catch (error: any) {
    // ğŸŸ  ãƒ¡ãƒ¼ãƒ«æœªç¢ºèªã‚¨ãƒ©ãƒ¼ã®å ´åˆï¼ˆæ”¹å–„ï¼‰
    if (error.response?.status === 403 && 
        error.response?.data?.detail?.includes('Email address not verified')) {
      errorMessage.value = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒç¢ºèªã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç™»éŒ²æ™‚ã«é€ä¿¡ã•ã‚ŒãŸç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚ãƒ¡ãƒ¼ãƒ«ãŒå±Šã„ã¦ã„ãªã„å ´åˆã¯ã€ç¢ºèªãƒ¡ãƒ¼ãƒ«å†é€ä¿¡ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚'
    } else if (error.response?.data?.detail) {
      errorMessage.value = error.response.data.detail
    } else {
      errorMessage.value = 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
    }
  } finally {
    isLoading.value = false
  }
}
</script>
```

================================================================================
7. Dockerç’°å¢ƒã§ã®å‹•ä½œç¢ºèªæ‰‹é †
================================================================================

## 7.1 ç’°å¢ƒå¤‰æ•°è¨­å®š

```bash
# backend/.env ã‚’ç·¨é›†
nano backend/.env

# ä»¥ä¸‹ã‚’è¿½åŠ 
BREVO_API_KEY=xkeysib-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
BREVO_SENDER_EMAIL=noreply@yadopera.com
BREVO_SENDER_NAME=YadOPERA
FRONTEND_URL=http://localhost:5173
ADMIN_NOTIFICATION_EMAIL=kurinobu@example.com  # ğŸŸ  è¿½åŠ 
```

## 7.2 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ

```bash
# Dockerç’°å¢ƒèµ·å‹•
docker-compose up -d

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
docker-compose exec backend alembic upgrade head

# ç¢ºèª
docker-compose exec backend alembic current

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›: "013 (head)"
```

## 7.3 ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆBrevoãƒ©ã‚¤ãƒ–ãƒ©ãƒª + tenacityï¼‰
docker-compose exec backend pip install sib-api-v3-sdk==7.6.0 tenacity==8.2.3

# ã¾ãŸã¯ã€ã‚³ãƒ³ãƒ†ãƒŠå†ãƒ“ãƒ«ãƒ‰
docker-compose down
docker-compose build backend
docker-compose up -d
```

## 7.4 å‹•ä½œç¢ºèªãƒ†ã‚¹ãƒˆ

### ã‚¹ãƒ†ãƒƒãƒ—1: æ–°è¦ç™»éŒ²

1. ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://localhost:5173/admin/register` ã«ã‚¢ã‚¯ã‚»ã‚¹

2. ä»¥ä¸‹ã®æƒ…å ±ã‚’å…¥åŠ›ï¼š
   - æ–½è¨­å: ãƒ†ã‚¹ãƒˆæ–½è¨­
   - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: test@example.comï¼ˆè‡ªåˆ†ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¨å¥¨ï¼‰
   - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: testpass123
   - æ–™é‡‘ãƒ—ãƒ©ãƒ³: Small

3. ã€Œæ–½è¨­ã‚’ç™»éŒ²ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

4. ã€Œç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¢ºèªï¼š
   ```bash
   docker-compose exec postgres psql -U yadopera_user -d yadopera -c "SELECT id, email, is_active, email_verified, verification_token FROM users WHERE email='test@example.com';"
   ```
   
   æœŸå¾…ã•ã‚Œã‚‹çµæœï¼š
   - is_active: false
   - email_verified: false
   - verification_token: UUIDå½¢å¼ã®æ–‡å­—åˆ—

### ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ¡ãƒ¼ãƒ«ç¢ºèª

1. ç™»éŒ²ã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å—ä¿¡ãƒˆãƒ¬ã‚¤ã‚’ç¢ºèª

2. ã€Œã€YadOPERAã€‘ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªã®ãŠé¡˜ã„ã€ã¨ã„ã†ãƒ¡ãƒ¼ãƒ«ã‚’é–‹ã

3. ã€Œãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

4. ã€Œãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªå®Œäº†ï¼ã€ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¢ºèªï¼š
   ```bash
   docker-compose exec postgres psql -U yadopera_user -d yadopera -c "SELECT id, email, is_active, email_verified, verification_token FROM users WHERE email='test@example.com';"
   ```
   
   æœŸå¾…ã•ã‚Œã‚‹çµæœï¼š
   - is_active: true
   - email_verified: true
   - verification_token: NULL

### ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ­ã‚°ã‚¤ãƒ³

1. ã€Œãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

2. ä»¥ä¸‹ã®æƒ…å ±ã‚’å…¥åŠ›ï¼š
   - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: test@example.com
   - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: testpass123

3. ã€Œãƒ­ã‚°ã‚¤ãƒ³ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

4. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

### ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ¡ãƒ¼ãƒ«å†é€ä¿¡ãƒ†ã‚¹ãƒˆï¼ˆğŸ”´ ãƒ¬ãƒ¼ãƒˆåˆ¶é™ç¢ºèªï¼‰

1. åˆ¥ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§æ–°è¦ç™»éŒ²

2. ã€Œç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€ç”»é¢ã§ã€Œç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’å†é€ä¿¡ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

3. å†é€ä¿¡æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

4. 60ç§’é–“ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒãƒ¼ãŒå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª

5. ğŸ”´ 60ç§’ä»¥å†…ã«å†åº¦ã‚¯ãƒªãƒƒã‚¯ã—ã€ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
   - æœŸå¾…ã•ã‚Œã‚‹ã‚¨ãƒ©ãƒ¼: ã€Œã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚ï¼ˆ60ç§’ï¼‰ã€

6. ãƒ¡ãƒ¼ãƒ«å—ä¿¡ç¢ºèª

### ã‚¹ãƒ†ãƒƒãƒ—5: ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ

**ç„¡åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆğŸŸ  ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ç¢ºèªï¼‰**
1. ãƒ–ãƒ©ã‚¦ã‚¶ã§ä»¥ä¸‹ã®URLã«ã‚¢ã‚¯ã‚»ã‚¹ï¼š
   `http://localhost:5173/admin/verify-email?token=invalid-token-12345`

2. ã€Œç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸã€ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

3. ğŸŸ  ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã€ŒInvalid or expired verification tokenã€ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
   ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ã®å­˜åœ¨ãƒ»éå­˜åœ¨ã‚’æ¨æ¸¬ã•ã›ãªã„ï¼‰

**ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™åˆ‡ã‚Œ**
1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§æ‰‹å‹•ã§ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ã‚’éå»ã«è¨­å®šï¼š
   ```bash
   docker-compose exec postgres psql -U yadopera_user -d yadopera -c "UPDATE users SET verification_token_expires = NOW() - INTERVAL '1 day' WHERE email='test2@example.com';"
   ```

2. ç¢ºèªURLã«ã‚¢ã‚¯ã‚»ã‚¹

3. ğŸŸ  ã€ŒInvalid or expired verification tokenã€ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

**ãƒ¡ãƒ¼ãƒ«æœªç¢ºèªã§ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œï¼ˆğŸŸ  ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ”¹å–„ç¢ºèªï¼‰**
1. ãƒ¡ãƒ¼ãƒ«ç¢ºèªå‰ã®çŠ¶æ…‹ã§ `/admin/login` ã«ã‚¢ã‚¯ã‚»ã‚¹

2. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›

3. ğŸŸ  ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªï¼š
   ã€Œãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒç¢ºèªã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç™»éŒ²æ™‚ã«é€ä¿¡ã•ã‚ŒãŸç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚ãƒ¡ãƒ¼ãƒ«ãŒå±Šã„ã¦ã„ãªã„å ´åˆã¯ã€ç¢ºèªãƒ¡ãƒ¼ãƒ«å†é€ä¿¡ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚ã€

## 7.5 ãƒ­ã‚°ç¢ºèª

```bash
# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ­ã‚°ç¢ºèª
docker-compose logs -f backend

# ç¢ºèªãƒã‚¤ãƒ³ãƒˆ:
# - "Verification email sent successfully" ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
# - "Email verified successfully" ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
# - Brevo API ã‚¨ãƒ©ãƒ¼ãŒãªã„ã“ã¨
# - ğŸ”´ ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ­ã‚°: "Rate limit exceeded" ã¾ãŸã¯ "Rate limit check passed"
# - ğŸŸ¡ ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚°: "Retrying..." ï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—æ™‚ï¼‰
```

## 7.6 pytestè‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆğŸŸ¡ ä¸­å„ªå…ˆï¼‰

```bash
# ğŸŸ¡ ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå¾Œã«å®Ÿè¡Œ
docker-compose exec backend pytest tests/test_email_service.py -v
docker-compose exec backend pytest tests/test_auth_e2e.py -v

# ã‚«ãƒãƒ¬ãƒƒã‚¸ç¢ºèª
docker-compose exec backend pytest --cov=app tests/
```

================================================================================
8. ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †
================================================================================

## 8.1 ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆRender.comï¼‰

1. Render.comãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒ­ã‚°ã‚¤ãƒ³

2. ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠ

3. ã€ŒEnvironmentã€ã‚¿ãƒ–ã‚’é¸æŠ

4. ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ ï¼š

```
BREVO_API_KEY=xkeysib-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
BREVO_SENDER_EMAIL=noreply@yadopera.com
BREVO_SENDER_NAME=YadOPERA
FRONTEND_URL=https://yadopera-frontend-staging.onrender.com  # ğŸŸ  ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒURL
ADMIN_NOTIFICATION_EMAIL=kurinobu@example.com  # ğŸŸ  è¿½åŠ 
```

5. ã€ŒSave Changesã€ã‚’ã‚¯ãƒªãƒƒã‚¯

## 8.2 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ

```bash
# Render.com Shellã¾ãŸã¯SSHã§å®Ÿè¡Œ
alembic upgrade head

# ç¢ºèª
alembic current
```

## 8.3 ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# developãƒ–ãƒ©ãƒ³ãƒã«ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
git add .
git commit -m "feat: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªæ©Ÿèƒ½å®Ÿè£…ï¼ˆv2.0ã€ğŸ”´ğŸŸ ğŸŸ¡ä¿®æ­£å®Œå…¨åæ˜ ï¼‰"
git push origin develop

# Render.comãŒè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹
# ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ³ã‚’ç¢ºèª
```

## 8.4 ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ã®å‹•ä½œç¢ºèª

1. `https://yadopera-frontend-staging.onrender.com/admin/register` ã«ã‚¢ã‚¯ã‚»ã‚¹

2. Dockerç’°å¢ƒã¨åŒæ§˜ã®å‹•ä½œç¢ºèªãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½

3. ãƒ¡ãƒ¼ãƒ«é€ä¿¡ç¢ºèªï¼ˆå®Ÿéš›ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ç”¨ï¼‰

4. Brevoãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§é€ä¿¡å±¥æ­´ã‚’ç¢ºèª
   - URL: https://app.brevo.com/
   - ã€ŒTransactionalã€â†’ã€ŒEmailã€â†’ã€ŒStatisticsã€

5. ğŸŸ  ç®¡ç†è€…é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ãŒå±Šãã“ã¨ã‚’ç¢ºèªï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—æ™‚ï¼‰

## 8.5 ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒï¼‰

**ãƒ¡ãƒ¼ãƒ«ãŒå±Šã‹ãªã„å ´åˆ**

1. Brevoãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§é€ä¿¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª

2. Render.comãƒ­ã‚°ç¢ºèªï¼š
   ```
   Render.com Dashboard â†’ Service â†’ Logs
   ```

3. é€ä¿¡å…ƒãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆnoreply@yadopera.comï¼‰ãŒèªè¨¼æ¸ˆã¿ã‹ç¢ºèª

4. DNSè¨­å®šï¼ˆSPF, DKIMï¼‰ãŒæ­£ã—ã„ã‹ç¢ºèªï¼š
   ```bash
   dig TXT yadopera.com +short
   dig TXT mail._domainkey.yadopera.com +short
   ```

5. ğŸŸ¡ ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚°ã‚’ç¢ºèªï¼ˆ"Retrying..."ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰

================================================================================
9. æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †
================================================================================

## 9.1 æœ¬ç•ªç’°å¢ƒæº–å‚™

### 9.1.1 Brevoæœ¬ç•ªç’°å¢ƒè¨­å®š

1. Brevoã§æœ¬ç•ªç”¨API Keyä½œæˆï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç”¨ã¨ã¯åˆ¥ï¼‰

2. é€ä¿¡å…ƒãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªï¼ˆæ—¢ã«ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã§è¨­å®šæ¸ˆã¿ï¼‰

### 9.1.2 ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰

**Render.comï¼ˆæœ¬ç•ªãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼‰**

```
BREVO_API_KEY=xkeysib-[æœ¬ç•ªç”¨API Key]
BREVO_SENDER_EMAIL=noreply@yadopera.com
BREVO_SENDER_NAME=YadOPERA
FRONTEND_URL=https://yadopera.com  # ğŸŸ  æœ¬ç•ªç’°å¢ƒURL
ADMIN_NOTIFICATION_EMAIL=kurinobu@example.com  # ğŸŸ  æœ¬ç•ªç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«
ENVIRONMENT=production
DEBUG=False
```

## 9.2 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ

```bash
# æœ¬ç•ªç’°å¢ƒã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
# Render.com Shellã¾ãŸã¯SSHã§å®Ÿè¡Œ
alembic upgrade head
```

## 9.3 ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# mainãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸
git checkout main
git merge develop
git push origin main

# Render.comãŒè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹
```

## 9.4 æœ¬ç•ªç’°å¢ƒã§ã®å‹•ä½œç¢ºèª

1. `https://yadopera.com/admin/register` ã«ã‚¢ã‚¯ã‚»ã‚¹

2. å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã§ç™»éŒ²ãƒ†ã‚¹ãƒˆ

3. ãƒ¡ãƒ¼ãƒ«å—ä¿¡ç¢ºèª

4. ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèª

5. Brevoãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§é€ä¿¡å±¥æ­´ç¢ºèª

6. ğŸŸ  ç®¡ç†è€…é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã®å—ä¿¡ãƒ†ã‚¹ãƒˆ

## 9.5 ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

### 9.5.1 ãƒ¡ãƒ¼ãƒ«é€ä¿¡çŠ¶æ³

- Brevoãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ ã€ŒTransactionalã€â†’ã€ŒStatisticsã€
- é€ä¿¡æˆåŠŸç‡ã‚’ç¢ºèªï¼ˆç›®æ¨™: 95%ä»¥ä¸Šï¼‰
- ğŸŸ¡ ãƒªãƒˆãƒ©ã‚¤ç‡ã‚’ç¢ºèªï¼ˆ10%ä»¥ä¸‹ãŒç›®æ¨™ï¼‰

### 9.5.2 ç™»éŒ²æˆåŠŸç‡

- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã§ç¢ºèªï¼š
  ```sql
  SELECT 
    COUNT(*) AS total_users,
    SUM(CASE WHEN email_verified = true THEN 1 ELSE 0 END) AS verified_users,
    ROUND(SUM(CASE WHEN email_verified = true THEN 1 ELSE 0 END)::DECIMAL / COUNT(*) * 100, 2) AS verification_rate
  FROM users
  WHERE created_at >= NOW() - INTERVAL '7 days';
  ```

### 9.5.3 ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ç›£è¦–

- Render.com Logs
- Brevoé€ä¿¡ã‚¨ãƒ©ãƒ¼
- ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™åˆ‡ã‚Œ
- ğŸ”´ ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…éï¼ˆ429ã‚¨ãƒ©ãƒ¼ï¼‰
- ğŸŸ  ç®¡ç†è€…é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ­ã‚°

================================================================================
10. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
================================================================================

ï¼ˆv1.0ã¨åŒä¸€å†…å®¹ã®ãŸã‚çœç•¥ã€‚å®Ÿè£…æ™‚ã¯å…ƒã®è¨ˆç”»æ›¸ã‚’å‚ç…§ï¼‰

================================================================================
11. å®Ÿè£…å‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
================================================================================

## ğŸ”´ æœ€å„ªå…ˆï¼ˆå®Ÿè£…å‰ã«å¿…é ˆä¿®æ­£ï¼‰
- [ ] ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¿ã‚¹ã‚¯ã®å®Ÿè¡Œé †åºã‚’ä¿®æ­£ï¼ˆ5.7ç« ï¼‰
- [ ] å†é€ä¿¡APIã«ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’è¿½åŠ ï¼ˆ5.8ç« ã€5.9ç« ï¼‰
- [ ] .gitignoreã«.envãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆ3.1ç« ï¼‰
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼å‡¦ç†ã‚’ä¿®æ­£ï¼ˆ4.2ç« ï¼‰

## ğŸŸ  é«˜å„ªå…ˆï¼ˆå®Ÿè£…ã¨åŒæ™‚ã«å¯¾å¿œï¼‰
- [ ] ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ï¼ˆ5.7ç« ï¼‰
- [ ] ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ”¹å–„ï¼ˆ5.7ç« ã€6.5ç« ï¼‰
- [ ] ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—æ™‚ã®ç®¡ç†è€…é€šçŸ¥ã‚’å®Ÿè£…ï¼ˆ5.10ç« ï¼‰
- [ ] ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ»æœ¬ç•ªç’°å¢ƒã®FRONTEND_URLè¨­å®šã‚’æ˜ç¢ºåŒ–ï¼ˆ8.1ç« ã€9.1.2ç« ï¼‰

## ğŸŸ¡ ä¸­å„ªå…ˆï¼ˆPhase 2-3ã§å¯¾å¿œï¼‰
- [ ] ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«åŒ–ï¼ˆ5.3ç« ã‚³ãƒ¡ãƒ³ãƒˆå‚ç…§ï¼‰
- [ ] pytestè‡ªå‹•ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ï¼ˆ7.6ç« ï¼‰
- [ ] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å¼·åŒ–ï¼ˆ6.2ç« ï¼‰
- [ ] ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã®ãƒªãƒˆãƒ©ã‚¤å‡¦ç†ã‚’å®Ÿè£…ï¼ˆ5.3ç« ï¼‰

## ğŸ“‹ ç¢ºèªäº‹é …
- [ ] Dockerç’°å¢ƒã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
- [ ] ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
- [ ] æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®æœ€çµ‚ç¢ºèª
- [ ] è¦ç´„å®šç¾©æ›¸ï¼ˆyadopera-v03-summary.mdï¼‰æ›´æ–°

================================================================================
ä»¥ä¸Šã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªæ©Ÿèƒ½å®Ÿè£…è¨ˆç”»æ›¸ v2.0
================================================================================

**æ›´æ–°å±¥æ­´**: 
- v1.0: åˆç‰ˆä½œæˆï¼ˆ2026-01-26ï¼‰
- v2.0: ğŸ”´æœ€å„ªå…ˆã€ğŸŸ é«˜å„ªå…ˆã€ğŸŸ¡ä¸­å„ªå…ˆã®ä¿®æ­£ã‚’å®Œå…¨åæ˜ ï¼ˆ2026-01-27ï¼‰

**Document Version**: v2.0
**Author**: Airï¼ˆèª¿æŸ»åˆ†æï¼šClaudeï¼‰
**Last Updated**: 2026å¹´01æœˆ27æ—¥
**Status**: å®Ÿè£…æº–å‚™å®Œäº†
        <p style="font-size: 14px; color: #ef4444; margin-bottom: 10px;">
            <strong>â€» ã“ã®ãƒªãƒ³ã‚¯ã¯24æ™‚é–“å¾Œã«ç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚</strong>
        </p>
        
        <p style="font-size: 14px; color: #6b7280; margin-bottom: 20px;">
            ã“ã®ãƒ¡ãƒ¼ãƒ«ã«å¿ƒå½“ãŸã‚ŠãŒãªã„å ´åˆã¯ã€ç„¡è¦–ã—ã¦ã„ãŸã ã„ã¦æ§‹ã„ã¾ã›ã‚“ã€‚
        </p>
    </div>
    
    <div style="text-align: center; font-size: 12px; color: #9ca3af; padding-top: 20px; border-top: 1px solid #e5e7eb;">
        <p>Â© 2026 YadOPERA. All rights reserved.</p>
        <p>ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯é€ä¿¡å°‚ç”¨ã§ã™ã€‚è¿”ä¿¡ã„ãŸã ã„ã¦ã‚‚ãŠç­”ãˆã§ãã¾ã›ã‚“ã€‚</p>
    </div>
</body>
</html>
            """
            
            # ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ï¼ˆãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼‰
            text_content = f"""
YadOPERA - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèª

{to_name} æ§˜

YadOPERAã«ã”ç™»éŒ²ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚
ä»¥ä¸‹ã®URLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç¢ºèªã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚

{verification_url}

â€» ã“ã®ãƒªãƒ³ã‚¯ã¯24æ™‚é–“å¾Œã«ç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚

ã“ã®ãƒ¡ãƒ¼ãƒ«ã«å¿ƒå½“ãŸã‚ŠãŒãªã„å ´åˆã¯ã€ç„¡è¦–ã—ã¦ã„ãŸã ã„ã¦æ§‹ã„ã¾ã›ã‚“ã€‚

---
Â© 2026 YadOPERA. All rights reserved.
ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯é€ä¿¡å°‚ç”¨ã§ã™ã€‚è¿”ä¿¡ã„ãŸã ã„ã¦ã‚‚ãŠç­”ãˆã§ãã¾ã›ã‚“ã€‚
            """
            
            # ãƒ¡ãƒ¼ãƒ«é€ä¿¡è¨­å®š
            send_smtp_email = sib_api_v3_sdk.SendSmtpEmail(
                to=[{"email": to_email, "name": to_name}],
                sender={
                    "email": settings.brevo_sender_email,
                    "name": settings.brevo_sender_name
                },
                subject="ã€YadOPERAã€‘ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªã®ãŠé¡˜ã„",
                html_content=html_content,
                text_content=text_content
            )
            
            # ãƒ¡ãƒ¼ãƒ«é€ä¿¡
            api_response = self.api_instance.send_transac_email(send_smtp_email)
            logger.info(
                f"Verification email sent successfully: to={to_email}, "
                f"message_id={api_response.message_id}"
            )
            return True
            
        except ApiException as e:
            logger.error(
                f"Brevo API error: to={to_email}, status={e.status}, "
                f"reason={e.reason}, body={e.body}"
            )
            raise  # ğŸŸ¡ tenacityãŒãƒªãƒˆãƒ©ã‚¤ã™ã‚‹
        except Exception as e:
            logger.error(
                f"Unexpected error sending verification email: to={to_email}, "
                f"error={str(e)}",
                exc_info=True
            )
            raise  # ğŸŸ¡ tenacityãŒãƒªãƒˆãƒ©ã‚¤ã™ã‚‹
    
    # ğŸŸ¡ ãƒªãƒˆãƒ©ã‚¤å‡¦ç†è¿½åŠ ï¼ˆä¸­å„ªå…ˆï¼‰
    @retry(
        stop=stop_after_attempt(3),
        wait=wait_exponential(multiplier=1, min=2, max=10),
        reraise=True
    )
    async def send_verification_reminder_email(
        self,
        to_email: str,
        to_name: str,
        verification_url: str
    ) -> bool:
        """
        ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ï¼ˆå†é€ä¿¡ç”¨ã€ãƒªãƒˆãƒ©ã‚¤ã‚ã‚Šï¼‰
        
        Args:
            to_email: é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
            to_name: é€ä¿¡å…ˆåï¼ˆæ–½è¨­åï¼‰
            verification_url: ç¢ºèªç”¨URL
        
        Returns:
            é€ä¿¡æˆåŠŸæ™‚Trueã€å¤±æ•—æ™‚False
        """
        try:
            # ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ï¼ˆHTMLï¼‰
            html_content = f"""
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªï¼ˆå†é€ï¼‰ - YadOPERA</title>
</head>
<body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
    <div style="background-color: #f8f9fa; border-radius: 10px; padding: 30px; margin-bottom: 20px;">
        <h1 style="color: #2563eb; margin-top: 0;">YadOPERA</h1>
        <h2 style="color: #1f2937; margin-bottom: 20px;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªï¼ˆå†é€ï¼‰</h2>
        
        <p style="font-size: 16px; margin-bottom: 20px;">
            {to_name} æ§˜
        </p>
        
        <p style="font-size: 16px; margin-bottom: 20px;">
            ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’å†é€ä¿¡ã„ãŸã—ã¾ã—ãŸã€‚<br>
            ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç¢ºèªã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚
        </p>
        
        <div style="text-align: center; margin: 30px 0;">
            <a href="{verification_url}" 
               style="display: inline-block; background-color: #2563eb; color: white; 
                      padding: 15px 40px; text-decoration: none; border-radius: 5px; 
                      font-size: 16px; font-weight: bold;">
                ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªã™ã‚‹
            </a>
        </div>
        
        <p style="font-size: 14px; color: #6b7280; margin-bottom: 10px;">
            ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ããªã„å ´åˆã¯ã€ä»¥ä¸‹ã®URLã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„ï¼š
        </p>
        <p style="font-size: 14px; color: #2563eb; word-break: break-all; margin-bottom: 20px;">
            {verification_url}
        </p>
        
        