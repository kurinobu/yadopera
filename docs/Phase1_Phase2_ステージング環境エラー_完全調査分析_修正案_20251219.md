# Phase 1・Phase 2: ステージング環境エラー完全調査分析と修正案

**作成日時**: 2025年12月19日 16時35分00秒
**実施者**: AI Assistant
**目的**: ステージング環境での「施設情報の取得に失敗しました」エラーの完全な調査分析と修正案の提示

---

## 1. 問題の概要

**現象**: ステージング環境（`https://yadopera-frontend-staging.onrender.com/`）で、言語選択ボタンをクリックした際に「施設情報の取得に失敗しました」という汎用エラーメッセージが表示される。期待される「現在オフラインです。インターネット接続を確認してください。」が表示されない。

**ユーザー様の報告**:
- コンソールエラー: `GET https://yadopera-backend-staging.onrender.com/api/v1/facility/test-facility net::ERR_INTERNET_DISCONNECTED`
- コンソールログ: `Facility fetch error: {code: 'NETWORK_ERROR', ...}`
- 表示メッセージ: 「施設情報の取得に失敗しました」（期待: 「現在オフラインです。インターネット接続を確認してください。」）

---

## 2. 多角的な調査分析結果

### 2.1 シェルテスト: デプロイされたJavaScriptバンドルの確認

**実施内容**: ステージング環境にデプロイされたJavaScriptバンドル（`assets/index-B1a5Sok-.js`）の内容を確認

**結果**:
1. ✅ **API URLの確認**: `https://yadopera-backend-staging.onrender.com`が正しく埋め込まれている
2. ✅ **`localhost:8000`の不在**: `localhost:8000`は含まれていない
3. ✅ **`NETWORK_ERROR`コードの存在**: `NETWORK_ERROR`文字列がバンドル内に存在する
4. ⚠️ **エラーメッセージ文字列の確認**: 「現在オフラインです」と「施設情報の取得に失敗しました」はminifyにより検出不可（正常）

**結論**: ビルドプロセスは正常に動作しており、環境変数は正しく埋め込まれている。

### 2.2 シェルテスト: バックエンドAPIの応答確認

**実施内容**: ステージング環境のバックエンドAPIに直接リクエストを送信し、CORSヘッダーと応答を確認

**結果**:
```bash
$ curl -s -I -H "Origin: https://yadopera-frontend-staging.onrender.com" \
  "https://yadopera-backend-staging.onrender.com/api/v1/facility/test-facility"

HTTP/2 405 
access-control-allow-origin: https://yadopera-frontend-staging.onrender.com
access-control-allow-credentials: true
```

**結論**: バックエンドAPIは正常に応答しており、CORSヘッダーも正しく設定されている。405エラーはHEADリクエストに対する正常な応答（GETリクエストが必要）。

### 2.3 コード分析: エラーハンドリングロジックの確認

**実施内容**: `frontend/src/api/axios.ts`、`frontend/src/views/guest/Welcome.vue`、`frontend/src/views/guest/Chat.vue`のエラーハンドリングロジックを確認

**確認結果**:

#### 2.3.1 `axios.ts`のレスポンスインターセプター（68-86行目）

```typescript
// ネットワークエラーやタイムアウト
if (error.request) {
  // タイムアウトエラーの判定
  if (error.code === 'ECONNABORTED' || error.message?.includes('timeout')) {
    return Promise.reject({
      code: 'TIMEOUT_ERROR',
      message: 'リクエストがタイムアウトしました。接続を確認して再度お試しください。'
    })
  }
  
  // ネットワークエラー
  return Promise.reject({
    code: 'NETWORK_ERROR',
    message: 'ネットワークエラーが発生しました。接続を確認してください。',
    details: {
      url: error.config?.url,
      method: error.config?.method
    }
  })
}
```

**分析**: `error.request`が存在する場合、`NETWORK_ERROR`コードを持つエラーオブジェクトを返す。`net::ERR_INTERNET_DISCONNECTED`は`error.request`が存在するエラーであるため、この条件に該当するはず。

#### 2.3.2 `Welcome.vue`のエラーハンドリング（89-107行目）

```typescript
catch (err: any) {
  // デバッグログ: エラーオブジェクトの構造を確認
  console.error('Facility fetch error:', err)
  console.error('Error code:', err?.code)
  console.error('Error type:', typeof err?.code)
  console.error('Error object keys:', Object.keys(err || {}))
  
  // オフライン時のエラーメッセージ
  // NETWORK_ERRORの場合は、navigator.onLineの値に関わらずオフライン時のメッセージを表示
  const errorCode = err?.code || err?.error?.code
  if (errorCode === 'NETWORK_ERROR' || String(errorCode) === 'NETWORK_ERROR') {
    error.value = '現在オフラインです。インターネット接続を確認してください。'
  } else if (errorCode === 'TIMEOUT_ERROR' || String(errorCode) === 'TIMEOUT_ERROR') {
    error.value = 'リクエストがタイムアウトしました。接続を確認して再度お試しください。'
  } else if (errorCode === 'SERVER_ERROR' || String(errorCode) === 'SERVER_ERROR') {
    error.value = 'サーバーエラーが発生しました。しばらくしてから再度お試しください。'
  } else {
    error.value = '施設情報の取得に失敗しました'
  }
}
```

**分析**: `err?.code`または`err?.error?.code`から`NETWORK_ERROR`を検出し、適切なメッセージを表示するロジックが実装されている。

---

## 3. 根本原因の特定

### 3.1 矛盾点の分析

**観察された事実**:
1. ✅ ユーザー様のコンソールログ: `Facility fetch error: {code: 'NETWORK_ERROR', ...}` → `NETWORK_ERROR`コードが設定されている
2. ❌ 表示メッセージ: 「施設情報の取得に失敗しました」 → `NETWORK_ERROR`条件が満たされていない
3. ✅ デプロイされたJSバンドル: `NETWORK_ERROR`文字列が存在する
4. ✅ バックエンドAPI: 正常に応答している

**推論**: `err.code === 'NETWORK_ERROR'`の条件が満たされているにもかかわらず、`Welcome.vue`の条件分岐で検出されていない可能性がある。

### 3.2 可能性のある根本原因

#### 原因候補1: エラーオブジェクトの構造の不一致

**仮説**: Axiosインターセプターが返すエラーオブジェクトの構造と、`Welcome.vue`で期待する構造が一致していない可能性。

**検証方法**: デプロイされた環境でのブラウザ開発者ツールのコンソールログを確認し、実際の`err`オブジェクトの構造を確認する必要がある。

**可能性**:
- `err.code`が`undefined`で、`err.error.code`に`NETWORK_ERROR`が設定されている
- エラーオブジェクトがラップされている（例: `{error: {code: 'NETWORK_ERROR'}}`）
- 型の問題（`err.code`が`string`ではなく`Symbol`やその他の型）

#### 原因候補2: ビルド時の最適化による問題

**仮説**: Viteのビルド最適化により、エラーハンドリングロジックが予期しない形に変換されている可能性。

**検証方法**: デプロイされたJSバンドル内のエラーハンドリング部分を直接確認する（難易度が高い）。

#### 原因候補3: エラーオブジェクトのプロトタイプチェーンの問題

**仮説**: `err.code`が直接プロパティではなく、プロトタイプチェーン経由でアクセスする必要がある可能性。

---

## 4. 修正案

### 修正案1: エラーオブジェクトの構造チェックの強化（推奨）

**目的**: `err.code`の検出ロジックをより堅牢にし、様々なエラーオブジェクト構造に対応する。

**変更内容**:
1. `err.code`の直接チェックに加えて、`err.error?.code`、`err.response?.data?.error?.code`など、より深い階層もチェック
2. `String()`変換による型安全性の向上
3. デバッグログの強化（実際のエラーオブジェクト構造を完全に出力）

**実装箇所**:
- `frontend/src/views/guest/Welcome.vue`（89-107行目）
- `frontend/src/views/guest/Chat.vue`（201-219行目、424-444行目）

**リスク**: 低（既存のロジックを拡張するのみ）

**大原則への準拠**: ✅ `根本解決 > 暫定解決`、✅ `安全は確保しながら拙速`

### 修正案2: Axiosインターセプターのエラーオブジェクト構造の統一

**目的**: Axiosインターセプターが返すエラーオブジェクトの構造を明確にし、一貫性を保つ。

**変更内容**:
- `axios.ts`のレスポンスインターセプターで、ネットワークエラーの場合に返すエラーオブジェクトの構造を明示的に定義
- `AppError`インターフェースに準拠した構造を保証

**リスク**: 中（他のエラーハンドリングに影響する可能性）

**大原則への準拠**: ✅ `統一・同一化 > 特殊独自`

### 修正案3: デバッグログの強化とステージング環境での詳細調査

**目的**: ステージング環境での実際のエラーオブジェクト構造を完全に把握する。

**変更内容**:
- `Welcome.vue`と`Chat.vue`のデバッグログを強化し、`JSON.stringify(err, null, 2)`で完全なエラーオブジェクトを出力
- エラーオブジェクトの全てのプロパティを列挙

**リスク**: 低（デバッグログの追加のみ）

**大原則への準拠**: ✅ `具体的 > 一般`

---

## 5. 推奨される修正手順

### ステップ1: 修正案1の実装（最優先）

1. `Welcome.vue`と`Chat.vue`のエラーハンドリングロジックを修正
2. エラーオブジェクトの構造チェックを強化
3. デバッグログを強化

### ステップ2: ローカル環境でのテスト

1. ビルドを実行
2. プレビューサーバーでオフライン動作をテスト
3. ブラウザ開発者ツールでエラーオブジェクトの構造を確認

### ステップ3: ステージング環境へのデプロイと検証

1. コミット・プッシュ
2. デプロイ完了を待つ
3. ステージング環境でオフライン動作をテスト
4. ブラウザ開発者ツールでエラーオブジェクトの構造を確認

---

## 6. 次のアクション

ユーザー様のご指示をお待ちしております。修正案1の実装を推奨いたしますが、ご判断をお聞かせください。
