================================================================================
FAQ初期設定機能の実装提案（既存機能活用版）
================================================================================
作成日: 2025年12月27日
対象: やどぺらシステム フェーズ2ステップ8代替実装
目的: 既存FAQ管理機能を最大限活用したプリセットFAQ初期設定機能の実装
================================================================================

## 1. 既存実装の完全把握

### 1-1. データモデル構造

**FAQ (faq.py)**
```
テーブル: faqs
- id (PK)
- facility_id (FK → facilities.id)
- category (basic/facilities/location/trouble)
- intent_key (インテント識別キー)
- priority (1-5)
- is_active (boolean)
- created_by (FK → users.id)
- created_at
- updated_at
```

**FAQTranslation (faq_translation.py)**
```
テーブル: faq_translations
- id (PK)
- faq_id (FK → faqs.id)
- language (en/ja/zh-TW/fr)
- question (text)
- answer (text)
- embedding (vector[1536]) ← OpenAI埋め込みベクトル
- created_at
- updated_at
```

**設計の特徴**:
- インテントベース構造（intent_key）
- 施設ごとのFAQ管理（facility_id）
- 多言語対応（FAQTranslationで分離）
- ベクトル検索対応（embedding列）
- カテゴリ4種類（basic/facilities/location/trouble）

================================================================================

### 1-2. 既存のFAQ管理機能 (FaqManagement.vue)

**実装済み機能**:
1. ✅ FAQ一覧表示（カテゴリ別）
2. ✅ FAQ追加フォーム（Modalベース）
3. ✅ FAQ編集機能（個別編集）
4. ✅ FAQ削除機能（論理削除: is_active=false）
5. ✅ 多言語対応（translations配列で複数言語を一括管理）
6. ✅ 優先度設定（priority: 1-5）
7. ✅ 有効/無効切り替え（is_active）
8. ✅ カテゴリ分類表示
9. ✅ 未解決質問からのFAQ生成（AI提案機能）
10. ✅ ゲストフィードバック連動（低評価回答の改善）

**UI構成**:
- FaqList: FAQ一覧表示コンポーネント
- FaqForm: FAQ追加/編集フォーム（Modal内）
- FaqSuggestionCard: AI提案表示カード
- UnresolvedQuestionsList: 未解決質問リスト
- FeedbackLinkedFaqs: 低評価回答リスト

================================================================================

### 1-3. 既存のAPI実装

**FAQRequest (作成用スキーマ)**:
```python
{
  "category": "basic",  # basic/facilities/location/trouble
  "intent_key": "basic_checkout_time",  # 自動生成可能
  "translations": [
    {
      "language": "en",
      "question": "What time is check-out?",
      "answer": "Check-out is by 11:00 AM."
    },
    {
      "language": "ja",
      "question": "チェックアウトは何時ですか？",
      "answer": "チェックアウトは11時までです。"
    }
  ],
  "priority": 5,  # 1-5
  "is_active": true
}
```

**APIエンドポイント（推測）**:
- POST /api/faqs - FAQ作成
- GET /api/faqs - FAQ一覧取得
- PUT /api/faqs/{id} - FAQ更新
- DELETE /api/faqs/{id} - FAQ削除

================================================================================

## 2. 重複分析：提案内容 vs 既存実装

### 2-1. 完全に重複している機能

| 提案内容 | 既存実装 | 状態 |
|---------|---------|------|
| テキスト編集（日英） | FaqForm + translations配列 | ✅ 実装済み |
| 有効/無効トグル | is_active切り替え | ✅ 実装済み |
| 削除機能 | handleDelete関数（論理削除） | ✅ 実装済み |
| カテゴリ分類 | category列 + FaqList表示 | ✅ 実装済み |
| 多言語対応 | FAQTranslationモデル | ✅ 実装済み |
| 施設ごとのFAQ管理 | facility_id列 | ✅ 実装済み |
| 優先度設定 | priority列（1-5） | ✅ 実装済み |

### 2-2. 提案内容で不要だった部分

| 提案内容 | 理由 |
|---------|------|
| property_faqsテーブル | 既存のfaqsテーブルで実現済み |
| faq_templatesテーブル | MVPでは不要（直接FAQを一括作成で対応） |
| オートセーブ機能 | 既存FaqFormは即座に保存するため不要 |
| 独自の編集UI実装 | 既存のFaqManagement.vueを活用 |

### 2-3. 既存実装にない部分（新規実装が必要）

| 機能 | 現状 | 必要な理由 |
|------|------|-----------|
| 初回セットアップ時のFAQプリセット自動投入 | ❌ なし | 新規施設登録時に30問を自動作成 |
| 一括FAQ作成API | ❌ なし | 30問を1回のAPI呼び出しで作成 |
| プリセットFAQデータの管理 | ❌ なし | FAQ_Preset_Format_List.mdをDB/コードに格納 |

================================================================================

## 3. 最適な実装戦略

### 3-1. 基本方針

**既存機能を100%活用し、最小限の追加実装でプリセットFAQ機能を実現する**

1. ✅ 既存のFAQ管理画面（FaqManagement.vue）を使用
2. ✅ 既存のデータモデル（FAQ + FAQTranslation）を使用
3. ✅ 既存のAPI（POST /api/faqs）を使用
4. ➕ 新規: 一括FAQ作成機能のみ追加

### 3-2. 実装が必要な機能

#### A. バックエンド実装

**1. プリセットFAQデータの定義**
```python
# app/data/faq_presets.py

FAQ_PRESETS = [
    {
        "category": "basic",
        "intent_key": "basic_quiet_hours",
        "priority": 5,
        "translations": [
            {
                "language": "ja",
                "question": "夜間の静音ルールはありますか？",
                "answer": "22時以降は他のゲストへの配慮をお願いします。通話や会話は共用スペースで行ってください。"
            },
            {
                "language": "en",
                "question": "Is there a quiet rule at night?",
                "answer": "Please keep noise to a minimum after 10:00 PM. Phone calls and conversations should be done in common areas."
            }
        ]
    },
    # ... 残り29問（FAQ_Preset_Format_List.mdから変換）
]
```

**2. 一括FAQ作成API**
```python
# app/api/endpoints/faqs.py

@router.post("/faqs/bulk", response_model=BulkFAQCreateResponse)
async def create_bulk_faqs(
    faqs: List[FAQRequest],
    current_user: User = Depends(get_current_active_user),
    db: Session = Depends(get_db)
):
    """
    複数FAQを一括作成（プリセット投入用）
    """
    created_faqs = []
    for faq_data in faqs:
        faq = FAQ(
            facility_id=current_user.facility_id,
            category=faq_data.category,
            intent_key=faq_data.intent_key,
            priority=faq_data.priority,
            is_active=True,
            created_by=current_user.id
        )
        db.add(faq)
        db.flush()  # IDを取得
        
        # 翻訳を作成
        for trans in faq_data.translations:
            translation = FAQTranslation(
                faq_id=faq.id,
                language=trans.language,
                question=trans.question,
                answer=trans.answer,
                embedding=generate_embedding(trans.question)  # ベクトル生成
            )
            db.add(translation)
        
        created_faqs.append(faq)
    
    db.commit()
    return {"created_count": len(created_faqs), "faqs": created_faqs}
```

**3. 施設登録時のトリガー処理**
```python
# app/api/endpoints/auth.py (施設登録エンドポイント)

@router.post("/register", response_model=FacilityResponse)
async def register_facility(
    facility_data: FacilityRegister,
    db: Session = Depends(get_db)
):
    # 施設作成
    facility = Facility(...)
    db.add(facility)
    db.commit()
    
    # ✨ 新規: プリセットFAQを自動投入
    from app.data.faq_presets import FAQ_PRESETS
    for preset in FAQ_PRESETS:
        faq = FAQ(
            facility_id=facility.id,
            category=preset["category"],
            intent_key=preset["intent_key"],
            priority=preset["priority"],
            is_active=True,
            created_by=None  # システム生成
        )
        db.add(faq)
        db.flush()
        
        for trans in preset["translations"]:
            translation = FAQTranslation(
                faq_id=faq.id,
                language=trans["language"],
                question=trans["question"],
                answer=trans["answer"],
                embedding=generate_embedding(trans["question"])
            )
            db.add(translation)
    
    db.commit()
    return facility
```

================================================================================

#### B. フロントエンド実装

**既存のFaqManagement.vueをそのまま使用**

新規施設が初回ログイン時:
1. ダッシュボードにアクセス
2. 「FAQ管理」メニューをクリック
3. **既にプリセット30問が表示されている状態**
4. 各FAQを個別に編集・削除可能
5. 既存のFaqFormで編集（Modal表示）

**追加実装不要の理由**:
- FaqManagement.vueは既にカテゴリ別表示に対応
- FaqFormは既に多言語編集に対応
- 削除機能も実装済み
- UI/UXの新規開発が一切不要

**オプション: 初回ガイダンス表示**
```vue
<!-- FaqManagement.vue に追加 -->
<div v-if="faqs.length === 30 && !hasEditedAnyFaq" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
  <h3 class="text-blue-900 font-semibold mb-2">
    📋 プリセットFAQが設定されています
  </h3>
  <p class="text-blue-800 text-sm">
    30個のFAQテンプレートが初期設定されています。
    あなたの宿泊施設に合わせて自由に編集・削除してください。
  </p>
  <button @click="dismissGuide" class="mt-2 text-blue-600 text-sm underline">
    了解しました
  </button>
</div>
```

================================================================================

## 4. 実装ステップ計画（既存機能活用版）

### フェーズ1: プリセットデータ準備（1時間）

**作業内容**:
1. FAQ_Preset_Format_List.mdをPython辞書形式に変換
2. app/data/faq_presets.pyファイル作成
3. 30問すべてのデータを格納
4. intent_keyの自動生成ルール定義

**成果物**:
- app/data/faq_presets.py (約300行)

**検証方法**:
```python
# テストスクリプトで検証
from app.data.faq_presets import FAQ_PRESETS

assert len(FAQ_PRESETS) == 30
assert all("translations" in faq for faq in FAQ_PRESETS)
assert all(len(faq["translations"]) == 2 for faq in FAQ_PRESETS)  # ja + en
```

================================================================================

### フェーズ2: バックエンドAPI実装（2時間）

**作業内容**:
1. 一括FAQ作成API実装（/api/faqs/bulk）
2. 施設登録時のプリセット自動投入処理
3. ベクトル生成処理の統合
4. エラーハンドリング

**成果物**:
- app/api/endpoints/faqs.py (bulk作成エンドポイント追加)
- app/api/endpoints/auth.py (register処理にFAQ投入追加)
- app/schemas/faq.py (BulkFAQCreateResponseスキーマ追加)

**検証方法**:
```python
# 単体テスト
def test_bulk_faq_creation():
    response = client.post("/api/faqs/bulk", json=FAQ_PRESETS[:3])
    assert response.status_code == 200
    assert response.json()["created_count"] == 3
```

================================================================================

### フェーズ3: 統合テスト（1時間）

**作業内容**:
1. 新規施設登録フロー全体のテスト
2. FAQ自動投入の検証
3. 既存FaqManagement画面での表示確認
4. 編集・削除機能の動作確認

**テストシナリオ**:
```
1. 新規施設登録
   ↓
2. ログイン
   ↓
3. FAQ管理画面にアクセス
   ↓
4. プリセット30問が表示されることを確認
   ↓
5. 1問を編集して保存
   ↓
6. 1問を削除
   ↓
7. 変更が反映されることを確認
```

**成果物**:
- E2Eテストコード
- 動作確認チェックリスト

================================================================================

### フェーズ4: PoC施設への適用（30分）

**作業内容**:
1. 既存の3施設に手動でプリセットFAQを投入
2. 各施設の管理者に編集方法を案内
3. フィードバック収集

**投入方法**:
```bash
# 管理スクリプト実行
python scripts/apply_faq_presets.py --facility-id 1
python scripts/apply_faq_presets.py --facility-id 2
python scripts/apply_faq_presets.py --facility-id 3
```

**成果物**:
- 投入スクリプト (scripts/apply_faq_presets.py)
- 操作ガイド (簡易版)

================================================================================

## 5. 総所要時間の見積もり

```
フェーズ1: プリセットデータ準備     1.0時間
フェーズ2: バックエンドAPI実装      2.0時間
フェーズ3: 統合テスト               1.0時間
フェーズ4: PoC施設への適用          0.5時間
───────────────────────────────────
合計                                4.5時間
```

**当初見積もり（9時間）との比較**:
- **削減時間: 4.5時間（50%削減）**
- 削減理由: 既存UI/UXを100%再利用、データモデル変更なし

================================================================================

## 6. 既存機能活用のメリット

### 6-1. 開発効率

| 項目 | 新規実装 | 既存活用 | 削減時間 |
|------|---------|---------|---------|
| データモデル設計 | 1.5h | 0h | 1.5h |
| フロントエンド実装 | 3.5h | 0h | 3.5h |
| API実装 | 2.0h | 2.0h | 0h |
| テスト | 1.5h | 1.0h | 0.5h |
| **合計** | **8.5h** | **3.0h** | **5.5h** |

### 6-2. 保守性

**既存機能活用の利点**:
- ✅ 既存のバグ修正が自動的に反映される
- ✅ 既存の機能拡張（例: 新言語追加）が自動的に使える
- ✅ コードベースの一貫性が保たれる
- ✅ 学習コストが低い（開発者が既存UIを理解済み）

### 6-3. ユーザー体験

**宿泊施設管理者の視点**:
- ✅ FAQ管理画面の使い方を一度学べば、プリセットも通常FAQも同じ操作
- ✅ プリセットを「編集」するのではなく「削除して新規追加」も可能
- ✅ 後から追加FAQとプリセットFAQを区別する必要がない

================================================================================

## 7. 実装上の技術的考慮事項

### 7-1. プリセットFAQの識別

**課題**: プリセットFAQと手動追加FAQを区別する必要があるか？

**結論**: **区別不要**
- 理由: 宿泊施設管理者にとって「プリセット」は初期値に過ぎない
- 全てのFAQは編集・削除可能であるべき
- システム側でプリセットを特別扱いする必要はない

**オプション実装**（将来対応）:
```python
# FAQモデルに追加（オプション）
is_preset = Column(Boolean, default=False)  # プリセット由来かどうか
```

### 7-2. プリセットFAQの更新

**課題**: FAQ_Preset_Format_List.mdが更新されたとき、既存施設のFAQを更新するか？

**MVP方針**: **更新しない**
- 理由: 各施設が既にカスタマイズしている可能性が高い
- 上書きすると施設独自の編集が失われる

**将来対応の案**:
1. 新しいプリセットバージョンを通知
2. 管理者が手動で「プリセットを再適用」を選択
3. 差分を表示して選択的に適用

### 7-3. ベクトル生成の処理

**既存実装の確認が必要**:
- FAQTranslationモデルにembedding列が存在
- 質問文からベクトルを生成する関数が既に実装されている可能性が高い

**実装方針**:
```python
# 既存の関数を使用（推測）
from app.services.embeddings import generate_embedding

# FAQ作成時に自動生成
embedding = generate_embedding(question_text)
```

### 7-4. 多言語対応の拡張性

**現在**: 日本語（ja）+ 英語（en）
**将来**: 中国語（zh-TW）、フランス語（fr）

**プリセットデータの構造**:
```python
FAQ_PRESETS = [
    {
        "translations": [
            {"language": "ja", "question": "...", "answer": "..."},
            {"language": "en", "question": "...", "answer": "..."},
            # 将来追加
            # {"language": "zh-TW", "question": "...", "answer": "..."},
        ]
    }
]
```

**拡張時の対応**:
1. FAQ_PRESETS配列に新言語を追加
2. 既存施設には影響なし（各施設は必要な言語のみ保持）
3. 新規施設は全言語のプリセットを受け取る

================================================================================

## 8. リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| プリセット投入失敗 | 高 | トランザクション管理、ロールバック処理 |
| ベクトル生成エラー | 中 | エラー時は embedding=NULL で保存、後で再生成 |
| 既存施設への影響 | 低 | 新規施設のみ自動投入、既存施設は手動適用 |
| プリセット内容の不適切さ | 中 | PoC期間中にフィードバック収集して修正 |

================================================================================

## 9. 次のステップ

### 実装前の確認事項

1. **ベクトル生成関数の確認**
   - どのファイルに実装されているか
   - 関数名とシグネチャ
   - OpenAI APIキーの管理方法

2. **既存FAQの件数確認**
   - PoC 3施設に既存FAQが何件あるか
   - プリセット投入時に重複チェックが必要か

3. **施設登録フローの確認**
   - 現在の登録処理のコード位置
   - トリガー処理を追加する最適な場所

### 実装開始の承認確認

以下が承認されれば実装を開始します:

✅ 既存FAQ管理画面（FaqManagement.vue）をそのまま使用
✅ 新規実装は「プリセットデータ定義」「一括投入API」のみ
✅ フロントエンドの新規開発は不要
✅ 所要時間は4.5時間（当初見積もりの半分）

承認いただければ、フェーズ1のプリセットデータ準備からコード実装を開始します。

================================================================================
END OF DOCUMENT
================================================================================