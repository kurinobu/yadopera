# ⚠️ 危険！重要！ Phase 1・Phase 2: PWAインストール後の起動時404エラー セキュリティ対策付き修正実施完了

**⚠️ 危険！重要！**: この文書にはAI Assistantの誤った認識が反映されている可能性があります。必ず`docs/Phase1_Phase2_PWAインストール後の起動時404エラー_期待動作_誤認識警告_20251222.md`を参照してください。

**作成日時**: 2025年12月22日 15時20分30秒
**実施者**: AI Assistant  
**目的**: セキュリティ対策を追加した修正の実施  
**状態**: ✅ **修正実施完了（ただし、誤った認識が含まれている可能性あり）**

---

## 1. バックアップ作成

**実施日時**: 2025年12月22日 14時35分49秒

**バックアップファイル**:
- ✅ `frontend/src/components/common/PWAInstallPrompt.vue.bak_20251222_143549`
- ✅ `frontend/src/router/index.ts.bak_20251222_143549`

---

## 2. 修正実施内容

### 2.1 修正①: `frontend/src/components/common/PWAInstallPrompt.vue`

**修正内容**:
- PWAインストール成功時に、その時点のURL（施設URL）をlocalStorageに保存
- ゲスト側のルート（`/f/:facilityId`）にアクセスしている場合のみ保存

**変更点**:
```typescript
import { useRoute } from 'vue-router'  // ← 追加

const route = useRoute()  // ← 追加

const handleInstall = async () => {
  isInstalling.value = true
  try {
    const success = await install()
    if (success) {
      isDismissed.value = true
      
      // PWAインストール成功時に、その時点のURL（施設URL）をlocalStorageに保存
      try {
        // ゲスト側のルート（/f/:facilityId）にアクセスしている場合のみ保存
        if (route.path.startsWith('/f/')) {
          const facilityUrl = route.fullPath
          localStorage.setItem('last_facility_url', facilityUrl)
        }
      } catch (error) {
        console.warn('Failed to save facility URL to localStorage:', error)
      }
    }
  } catch (error) {
    console.error('Installation failed:', error)
  } finally {
    isInstalling.value = false
  }
}
```

---

### 2.2 修正②: `frontend/src/router/index.ts` - `router.beforeEach`

**修正内容**:
- ゲスト側のルート（`/f/:facilityId`など）にアクセスした際、localStorageに施設URLを保存
- 常に最新の施設URLを保持する（PWAインストール時にも確実に保存される）

**変更点**:
```typescript
// 認証ガード
router.beforeEach(async (to: RouteLocationNormalized, _from: RouteLocationNormalized, next: NavigationGuardNext) => {
  const authStore = useAuthStore()
  
  // ゲスト側のルート（/f/:facilityId）にアクセスした際、localStorageに施設URLを保存
  // 常に最新の施設URLを保持する（PWAインストール時にも確実に保存される）
  if (to.path.startsWith('/f/')) {
    try {
      const facilityUrl = to.fullPath
      localStorage.setItem('last_facility_url', facilityUrl)
    } catch (error) {
      // localStorageが利用できない場合（プライベートモードなど）、エラーを無視
      console.warn('Failed to save facility URL to localStorage:', error)
    }
  }
  
  // 既存の認証ガード処理
  // ...
})
```

---

### 2.3 修正③: `frontend/src/router/index.ts` - `/`のルート

**修正内容**:
- `/`のルートに`beforeEnter`ガードを追加
- **セキュリティ対策**: ホワイトリスト方式 + 施設IDの検証
- localStorageから最後にアクセスした施設URLを取得してリダイレクト

**変更点**:
```typescript
import { isValidFacilityId } from '@/utils/validators'  // ← 追加

const routes: RouteRecordRaw[] = [
  {
    path: '/',
    name: 'Root',
    beforeEnter: (to, from, next) => {
      try {
        // 最後にアクセスした施設URLをlocalStorageから取得
        const lastFacilityUrl = localStorage.getItem('last_facility_url')
        
        if (lastFacilityUrl) {
          // ホワイトリスト方式: ゲスト側のルート（/f/:facilityId）のみ許可
          const allowedPattern = /^\/f\/([^\/]+)(\/.*)?$/
          const match = lastFacilityUrl.match(allowedPattern)
          
          if (match) {
            const facilityId = match[1]
            
            // 施設IDの検証
            if (isValidFacilityId(facilityId)) {
              // ゲスト側のルートのみリダイレクト
              next(lastFacilityUrl)
            } else {
              // 不正な施設IDの場合は404エラーページを表示
              console.error('PWA起動時: 不正な施設IDが検出されました。', facilityId)
              next('/:pathMatch(.*)*')
            }
          } else {
            // 許可されていないURLの場合は404エラーページを表示
            console.error('PWA起動時: 許可されていないURLが検出されました。', lastFacilityUrl)
            next('/:pathMatch(.*)*')
          }
        } else {
          // 施設URLがない場合は想定外のエラー（この状況は発生してはいけない）
          // ただし、万が一の場合に備えて404エラーページを表示
          console.error('PWA起動時: 施設URLが保存されていません。これは想定外の状況です。')
          next('/:pathMatch(.*)*')
        }
      } catch (error) {
        // localStorageが利用できない場合、404エラーページを表示
        console.warn('Failed to access localStorage:', error)
        next('/:pathMatch(.*)*')
      }
    },
    meta: {
      layout: undefined
    }
  },
  // ...
]
```

---

## 3. セキュリティ対策

### 3.1 ホワイトリスト方式

**実装内容**:
- ゲスト側のルート（`/f/:facilityId`）のみ許可
- 正規表現パターン: `/^\/f\/([^\/]+)(\/.*)?$/`

**効果**:
- ✅ 外部サイトへのリダイレクトを防止
- ✅ 管理者ページ（`/admin/*`）へのリダイレクトを防止
- ✅ JavaScriptスキーム（`javascript:...`）のリダイレクトを防止

### 3.2 施設IDの検証

**実装内容**:
- `isValidFacilityId()`による施設IDの検証
- 不正な施設IDの場合は404エラーページを表示

**効果**:
- ✅ 不正な施設IDを防止
- ✅ マルチテナント分離の維持

---

## 4. 期待される動作

### 4.1 PWAインストール時の動作

1. ゲストがゲスト側のルート（`/f/:facilityId`など）にアクセス
2. PWAインストールプロンプトが表示される
3. ゲストが「インストール」ボタンをクリック
4. **PWAインストール成功時に、その時点のURL（施設URL）をlocalStorageに保存**
5. ホーム画面にアイコンが追加される

### 4.2 PWAインストール後の起動時（ゲスト）

1. ゲストがPWAアイコンをタップ
2. `start_url: "/"`にアクセス
3. `index.html`が返される
4. Vue Routerが初期化される
5. **Vue Routerが`/`のルートにマッチする**
6. **`beforeEnter`ガードが実行される**
7. **localStorageから最後にアクセスした施設URLを取得**
8. **ホワイトリスト方式と施設IDの検証により、安全にリダイレクト**
9. **保存された施設URLにリダイレクト**
10. **施設独自の画面が表示される**
11. **ゲストが期待する動作が実現される**

### 4.3 セキュリティ対策の動作

**不正なURLが検出された場合**:
- 外部サイト（`https://evil.com`）へのリダイレクト → ❌ 404エラーページを表示
- 管理者ページ（`/admin/login`）へのリダイレクト → ❌ 404エラーページを表示
- JavaScriptスキーム（`javascript:...`）のリダイレクト → ❌ 404エラーページを表示
- 不正な施設ID → ❌ 404エラーページを表示

---

## 5. リンター確認

**実施結果**: ✅ **リンターエラーなし**

**確認ファイル**:
- `frontend/src/components/common/PWAInstallPrompt.vue`
- `frontend/src/router/index.ts`

---

## 6. まとめ

### 6.1 修正実施内容

1. ✅ **`PWAInstallPrompt.vue`**: PWAインストール成功時に施設URLを保存
2. ✅ **`router.beforeEach`**: ゲスト側のルートアクセス時に施設URLを保存
3. ✅ **`/`のルート**: セキュリティ対策付きの`beforeEnter`ガードを追加

### 6.2 セキュリティ対策

- ✅ **ホワイトリスト方式**: ゲスト側のルート（`/f/:facilityId`）のみ許可
- ✅ **施設IDの検証**: `isValidFacilityId()`による検証
- ✅ **オープンリダイレクト脆弱性の対策**: 外部サイトへのリダイレクトを防止
- ✅ **認証・認可の回避リスクの対策**: 管理者ページへのリダイレクトを防止

### 6.3 期待される動作

- ✅ ゲストがPWAアイコンをタップした場合、最後にアクセスした施設URLにリダイレクトされる
- ✅ 不正なURLが検出された場合、404エラーページを表示
- ✅ セキュリティリスクが解消されている

---

**Document Version**: v1.0  
**Author**: AI Assistant  
**Last Updated**: 2025年12月22日  
**Status**: ✅ **修正実施完了**

**重要**: セキュリティ対策を追加した修正が完了しました。次はビルドとテストを実施してください。

