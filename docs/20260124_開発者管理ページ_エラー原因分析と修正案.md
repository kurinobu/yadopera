# 開発者管理ページ エラー原因分析と修正案

**作成日**: 2026年1月24日  
**エラー**: `isDeveloperTokenExpired is not defined`  
**状態**: ⚠️ **原因特定完了、修正案提示**

---

## 1. エラー原因分析

### 1.1 エラー内容

**エラーメッセージ**:
```
isDeveloperTokenExpired is not defined
```

**発生箇所**: `frontend/src/api/developer.ts` の25行目と26行目

### 1.2 根本原因

**問題点**:
1. `frontend/src/api/developer.ts`で`isDeveloperTokenExpired()`と`logoutDeveloper()`を使用しているが、**インポート文が欠落している**
2. ビルドエラーでも確認：
   - `src/api/developer.ts(25,7): error TS2304: Cannot find name 'isDeveloperTokenExpired'.`
   - `src/api/developer.ts(26,5): error TS2304: Cannot find name 'logoutDeveloper'.`
3. 未使用の型インポート：`ErrorLog`がインポートされているが使用されていない

**該当コード**:
```typescript
// frontend/src/api/developer.ts (17-28行目)
const getDeveloperApiClient = () => {
  const token = localStorage.getItem('developer_token')
  if (!token) {
    throw new Error('Developer token not found')
  }
  
  // トークンの有効期限をチェック
  if (isDeveloperTokenExpired()) {  // ❌ インポートされていない
    logoutDeveloper()               // ❌ インポートされていない
    throw new Error('Developer token expired')
  }
  // ...
}
```

**インポート文の欠落**:
```typescript
// frontend/src/api/developer.ts (1-13行目)
import apiClient from './axios'
import type {
  SystemOverview,
  FacilitySummary,
  ErrorLog,  // ⚠️ 未使用
  ErrorLogDetail,
  ErrorLogListResponse,
  SystemHealthResponse
} from '@/types/developer'
// ❌ isDeveloperTokenExpired と logoutDeveloper のインポートが欠落
```

### 1.3 影響範囲

- **直接影響**: 開発者ログイン後のAPI呼び出し時にエラーが発生
- **間接影響**: ダッシュボード、エラーログページ、システムヘルスページなど、すべての開発者ページでAPI呼び出しが失敗

---

## 2. 大原則に準拠した修正案

### 2.1 大原則の確認

**Grand Principles** (yadopera-v03-summary.mdより):
1. **シンプルさを優先**: 最小限の機能から実装
2. **拡張性**: 将来の機能追加を考慮した設計
3. **保守性**: コードの可読性とメンテナンス性を重視
4. **一貫性**: 既存のコードパターンに従う

### 2.2 修正方針

1. **インポート文の追加**: `@/utils/developerAuth`から必要な関数をインポート
2. **未使用インポートの削除**: `ErrorLog`型のインポートを削除（使用されていないため）
3. **既存パターンに準拠**: `frontend/src/stores/developer.ts`と同じインポートパターンを使用

### 2.3 修正内容

**ファイル**: `frontend/src/api/developer.ts`

**修正箇所1: インポート文の追加（1-13行目）**

```typescript
/**
 * 開発者管理ページAPI
 */

import apiClient from './axios'
import { isDeveloperTokenExpired, logoutDeveloper } from '@/utils/developerAuth'  // ✅ 追加
import type {
  SystemOverview,
  FacilitySummary,
  // ErrorLog,  // ✅ 削除（未使用）
  ErrorLogDetail,
  ErrorLogListResponse,
  SystemHealthResponse
} from '@/types/developer'
```

**修正箇所2: 関数の使用（25-28行目）**

```typescript
  // トークンの有効期限をチェック
  if (isDeveloperTokenExpired()) {  // ✅ インポート済み
    logoutDeveloper()               // ✅ インポート済み
    throw new Error('Developer token expired')
  }
```

### 2.4 修正後のコード全体

```typescript
/**
 * 開発者管理ページAPI
 */

import apiClient from './axios'
import { isDeveloperTokenExpired, logoutDeveloper } from '@/utils/developerAuth'
import type {
  SystemOverview,
  FacilitySummary,
  ErrorLogDetail,
  ErrorLogListResponse,
  SystemHealthResponse
} from '@/types/developer'

const DEVELOPER_API_BASE = '/developer'

// 開発者用のAPIクライアント（認証トークンを手動で設定）
const getDeveloperApiClient = () => {
  const token = localStorage.getItem('developer_token')
  if (!token) {
    throw new Error('Developer token not found')
  }
  
  // トークンの有効期限をチェック
  if (isDeveloperTokenExpired()) {
    logoutDeveloper()
    throw new Error('Developer token expired')
  }
  
  // 既存のapiClientを使用し、Authorizationヘッダーを追加
  const config = {
    headers: {
      Authorization: `Bearer ${token}`
    }
  }
  
  return {
    get: (url: string, options?: any) => apiClient.get(`${DEVELOPER_API_BASE}${url}`, { ...config, ...options }),
    post: (url: string, data?: any, options?: any) => apiClient.post(`${DEVELOPER_API_BASE}${url}`, data, { ...config, ...options }),
    put: (url: string, data?: any, options?: any) => apiClient.put(`${DEVELOPER_API_BASE}${url}`, data, { ...config, ...options }),
    delete: (url: string, options?: any) => apiClient.delete(`${DEVELOPER_API_BASE}${url}`, { ...config, ...options })
  }
}

// ... 以下既存のコード ...
```

---

## 3. 修正の妥当性確認

### 3.1 既存パターンとの整合性

**既存の実装パターン** (`frontend/src/stores/developer.ts`):
```typescript
import { isDeveloperTokenExpired, logoutDeveloper } from '@/utils/developerAuth'
```

**修正案**: 同じインポートパターンを使用 ✅

### 3.2 大原則への準拠

1. **シンプルさ**: インポート文を1行追加するだけの最小限の修正 ✅
2. **拡張性**: 既存のユーティリティ関数を再利用 ✅
3. **保守性**: 既存のコードパターンに従い、一貫性を保持 ✅
4. **一貫性**: `stores/developer.ts`と同じインポート方法を使用 ✅

### 3.3 影響範囲

- **修正ファイル**: 1ファイルのみ (`frontend/src/api/developer.ts`)
- **修正行数**: 2行（インポート追加、未使用インポート削除）
- **破壊的変更**: なし
- **既存機能への影響**: なし（修正により正常動作）

---

## 4. テスト計画

### 4.1 修正後の確認項目

1. **ビルドエラー解消**:
   ```bash
   docker-compose exec frontend npm run build
   ```
   - TypeScriptエラーが解消されることを確認

2. **開発者ログイン**:
   - ログインページでパスワード入力
   - ログイン成功後、ダッシュボードに遷移することを確認

3. **API呼び出し**:
   - ダッシュボードのデータ取得が正常に動作することを確認
   - エラーログページのデータ取得が正常に動作することを確認
   - システムヘルスチェックが正常に動作することを確認

4. **トークン期限チェック**:
   - トークン期限切れ時に自動ログアウトされることを確認

### 4.2 期待される動作

- ✅ ログイン成功後、エラーなくダッシュボードが表示される
- ✅ すべてのAPI呼び出しが正常に動作する
- ✅ トークン期限チェックが正常に動作する

---

## 5. 修正手順

### 5.1 修正実行前の確認

1. 現在のコードを確認
2. バックアップの取得（必要に応じて）
3. 修正内容の再確認

### 5.2 修正実行

1. `frontend/src/api/developer.ts`を開く
2. インポート文に以下を追加:
   ```typescript
   import { isDeveloperTokenExpired, logoutDeveloper } from '@/utils/developerAuth'
   ```
3. 未使用の`ErrorLog`型インポートを削除

### 5.3 修正後の確認

1. ビルドエラーが解消されることを確認
2. 開発者ログインが正常に動作することを確認
3. 各ページが正常に表示されることを確認

---

## 6. まとめ

### 6.1 エラー原因

- **根本原因**: `frontend/src/api/developer.ts`で`isDeveloperTokenExpired`と`logoutDeveloper`のインポートが欠落
- **影響**: 開発者ログイン後のすべてのAPI呼び出しでエラーが発生

### 6.2 修正案

- **修正内容**: インポート文の追加（1行）と未使用インポートの削除
- **修正方針**: 既存のコードパターンに準拠し、大原則に従った最小限の修正

### 6.3 修正の妥当性

- ✅ 大原則に準拠（シンプルさ、拡張性、保守性、一貫性）
- ✅ 既存パターンとの整合性
- ✅ 破壊的変更なし
- ✅ 最小限の修正で問題解決

---

**Document Version**: v1.0  
**Author**: Auto (AI Assistant)  
**Last Updated**: 2026年1月24日  
**Status**: ⚠️ **修正案提示完了、修正待ち**

