# ゲスト側言語選択画面日本語未表示問題 - 根本調査分析・修正案

**作成日時**: 2026年01月17日  
**問題**: Freeプランで日本語のみ対応なのに、言語選択画面で「英語」しか表示されない  
**重大度**: 🔴 **重大（ビジネス破綻レベルの問題）**  
**状態**: 📋 **根本調査分析完了・修正案提示**

---

## 1. 問題の概要

### 1.1 問題の詳細

**現状**:
- Freeプラン: 日本語のみ対応（`available_languages: ["ja"]`）なのに、言語選択画面で「英語」しか表示されない
- Miniプラン: 日本語＋英語対応（`available_languages: ["ja", "en"]`）なのに、言語選択画面で「英語」しか表示されない
- Smallプラン: 日本語＋英語＋中国語対応（`available_languages: ["ja", "en", "zh-TW"]`）なのに、言語選択画面で「英語」しか表示されない

**影響**:
- 🔴 **日本人ゲストが使用できない**（Freeプランで日本語のみ対応なのに日本語が表示されない）
- 🔴 **ビジネス破綻レベルの問題**（日本人が主要顧客である可能性が高い）
- 🔴 **ユーザー体験の急降下**（プランに応じた言語が表示されない）

### 1.2 問題の発生箇所

**ファイル**: `frontend/src/utils/constants.ts`
```typescript
export const SUPPORTED_LANGUAGES = [
  { code: 'en', name: 'English', flag: '🇬🇧' },
  // MVPでは英語のみ、Phase 2で追加
] as const
```

**問題点**:
- `SUPPORTED_LANGUAGES`が英語のみで定義されている
- プランに応じた言語フィルタリングは実装されているが、`SUPPORTED_LANGUAGES`に日本語が含まれていないため、日本語が表示されない

---

## 2. 根本原因の完全分析

### 2.1 根本原因

**`SUPPORTED_LANGUAGES`が英語のみで定義されている**

**詳細**:
1. **`SUPPORTED_LANGUAGES`の定義不足**
   - `frontend/src/utils/constants.ts`で`SUPPORTED_LANGUAGES`が英語のみで定義されている
   - 日本語、中国語、フランス語などが含まれていない

2. **フィルタリングロジックの問題**
   - `LanguageSelect.vue`で`SUPPORTED_LANGUAGES`から`available_languages`に含まれる言語をフィルタリングしている
   - しかし、`SUPPORTED_LANGUAGES`に日本語が含まれていないため、フィルタリングしても日本語が表示されない

3. **プラン制限との不整合**
   - Backendの`plan_limits.py`では各プランで日本語が含まれている（Free: `["ja"]`, Mini: `["ja", "en"]`など）
   - しかし、Frontendの`SUPPORTED_LANGUAGES`に日本語が含まれていないため、プランに応じた言語が表示されない

### 2.2 影響範囲

**直接影響**:
- `frontend/src/utils/constants.ts`: `SUPPORTED_LANGUAGES`の定義
- `frontend/src/views/guest/LanguageSelect.vue`: 言語フィルタリングロジック
- `frontend/src/components/guest/LanguageCard.vue`: 言語カード表示（影響なし）

**間接影響**:
- すべてのプランで日本語が表示されない
- 日本人ゲストが使用できない
- ビジネス破綻レベルの問題

### 2.3 データフロー分析

**現在のデータフロー**:
1. Backend: `plan_limits.py`でプランに応じた言語を定義（Free: `["ja"]`, Mini: `["ja", "en"]`など）
2. Backend: `facility_service.py`で`available_languages`を取得
3. Frontend: `LanguageSelect.vue`で`available_languages`を受け取る
4. Frontend: `SUPPORTED_LANGUAGES`から`available_languages`に含まれる言語をフィルタリング
5. **問題**: `SUPPORTED_LANGUAGES`に日本語が含まれていないため、フィルタリングしても日本語が表示されない

**期待されるデータフロー**:
1. Backend: `plan_limits.py`でプランに応じた言語を定義（Free: `["ja"]`, Mini: `["ja", "en"]`など）
2. Backend: `facility_service.py`で`available_languages`を取得
3. Frontend: `LanguageSelect.vue`で`available_languages`を受け取る
4. Frontend: `SUPPORTED_LANGUAGES`から`available_languages`に含まれる言語をフィルタリング
5. **修正後**: `SUPPORTED_LANGUAGES`に日本語が含まれているため、フィルタリングで日本語が表示される

---

## 3. 大原則に準拠した修正案

### 3.1 大原則の確認

1. **根本解決 > 暫定解決**: `SUPPORTED_LANGUAGES`に日本語を追加する根本解決を採用
2. **シンプル構造 > 複雑構造**: `SUPPORTED_LANGUAGES`に言語を追加するシンプルなアプローチ
3. **統一・同一化 > 特殊独自**: Backendの`plan_limits.py`と整合性を保つ
4. **具体的 > 一般**: 具体的な言語コードと名前を定義
5. **拙速 < 安全確実**: テストを省略せず、十分な検証を行う
6. **Docker環境必須**: すべての修正・テストはDocker環境で実行する

### 3.2 修正案

#### 修正案1: `SUPPORTED_LANGUAGES`に日本語を追加（推奨）

**方針**: `SUPPORTED_LANGUAGES`にプランで使用されるすべての言語を追加する

**修正内容**:
1. `frontend/src/utils/constants.ts`の`SUPPORTED_LANGUAGES`に日本語、中国語、フランス語を追加
2. 各言語のコード、名前、フラグを定義

**修正後のコード**:
```typescript
export const SUPPORTED_LANGUAGES = [
  { code: 'ja', name: '日本語', flag: '🇯🇵' },
  { code: 'en', name: 'English', flag: '🇬🇧' },
  { code: 'zh-TW', name: '繁體中文', flag: '🇹🇼' },
  { code: 'fr', name: 'Français', flag: '🇫🇷' },
  { code: 'es', name: 'Español', flag: '🇪🇸' },
  { code: 'de', name: 'Deutsch', flag: '🇩🇪' },
  { code: 'ko', name: '한국어', flag: '🇰🇷' },
  { code: 'th', name: 'ไทย', flag: '🇹🇭' },
  { code: 'vi', name: 'Tiếng Việt', flag: '🇻🇳' },
] as const
```

**メリット**:
- ✅ 根本解決（`SUPPORTED_LANGUAGES`に日本語を追加）
- ✅ シンプル構造（既存のフィルタリングロジックをそのまま使用）
- ✅ Backendの`plan_limits.py`と整合性を保つ
- ✅ 将来的な拡張にも対応可能

**デメリット**:
- なし（すべてのプランで使用される言語を定義するだけ）

#### 修正案2: 動的言語リスト生成（非推奨）

**方針**: `available_languages`から動的に言語リストを生成する

**修正内容**:
1. `LanguageSelect.vue`で`available_languages`から動的に言語リストを生成
2. 言語コードから名前とフラグをマッピング

**デメリット**:
- ❌ 複雑構造（動的生成ロジックが必要）
- ❌ 特殊独自（既存のパターンと異なる）
- ❌ 言語名とフラグのマッピングが必要

**結論**: 修正案1を採用

---

## 4. 実装ステップ計画

### ステップ1: `SUPPORTED_LANGUAGES`の拡張（15分）

1. **`frontend/src/utils/constants.ts`の修正**
   - `SUPPORTED_LANGUAGES`に日本語、中国語、フランス語などを追加
   - 各言語のコード、名前、フラグを定義

**修正内容**:
```typescript
export const SUPPORTED_LANGUAGES = [
  { code: 'ja', name: '日本語', flag: '🇯🇵' },
  { code: 'en', name: 'English', flag: '🇬🇧' },
  { code: 'zh-TW', name: '繁體中文', flag: '🇹🇼' },
  { code: 'fr', name: 'Français', flag: '🇫🇷' },
  { code: 'es', name: 'Español', flag: '🇪🇸' },
  { code: 'de', name: 'Deutsch', flag: '🇩🇪' },
  { code: 'ko', name: '한국어', flag: '🇰🇷' },
  { code: 'th', name: 'ไทย', flag: '🇹🇭' },
  { code: 'vi', name: 'Tiếng Việt', flag: '🇻🇳' },
] as const
```

### ステップ2: 型定義の確認（5分）

1. **型定義の確認**
   - `LanguageSelect.vue`の型定義が正しく動作することを確認
   - `LanguageCard.vue`の型定義が正しく動作することを確認

### ステップ3: ブラウザテスト（30分）

1. **各プランでの言語表示確認**
   - Freeプラン: 日本語のみが表示されることを確認
   - Miniプラン: 日本語＋英語が表示されることを確認
   - Smallプラン: 日本語＋英語＋中国語が表示されることを確認
   - Standardプラン: 日本語＋英語＋中国語＋フランス語が表示されることを確認
   - Premiumプラン: 全言語が表示されることを確認

**総所要時間**: 約50分（1時間以内）

---

## 5. 成功基準

### 5.1 機能要件

- ✅ Freeプラン: 日本語のみが表示される
- ✅ Miniプラン: 日本語＋英語が表示される
- ✅ Smallプラン: 日本語＋英語＋中国語が表示される
- ✅ Standardプラン: 日本語＋英語＋中国語＋フランス語が表示される
- ✅ Premiumプラン: 全言語が表示される
- ✅ エラー時はデフォルトで英語が表示される（既存の動作を維持）

### 5.2 非機能要件

- ✅ 既存の機能（Welcome、Chat）に影響しない
- ✅ パフォーマンスが既存と同等である
- ✅ ブラウザテストがすべて成功する

---

## 6. リスク分析

### 6.1 リスク

**リスク1: 言語名の表示問題**
- **可能性**: 🟡 中
- **影響**: 🟡 中
- **対策**: 各言語の正しい名前を確認し、適切に表示する

**リスク2: フラグの表示問題**
- **可能性**: 🟡 中
- **影響**: 🟢 低
- **対策**: フラグが表示されない場合は、言語コードを表示する

**リスク3: 既存機能への影響**
- **可能性**: 🟢 低
- **影響**: 🟡 中
- **対策**: 既存のフィルタリングロジックをそのまま使用するため、影響は最小限

### 6.2 リスク軽減策

1. **段階的な実装**: まず日本語と英語を追加し、その後他の言語を追加
2. **十分なテスト**: 各プランでの言語表示を確認
3. **既存機能の確認**: Welcome、Chat画面が正常に動作することを確認

---

## 7. 参照文書

- `docs/20260117_ゲスト側言語選択画面プラン対応言語フィルタリング_調査分析_修正ステップ計画.md`: 元の実装計画
- `backend/app/core/plan_limits.py`: プラン制限定義
- `frontend/src/utils/constants.ts`: 言語定数定義
- `frontend/src/views/guest/LanguageSelect.vue`: 言語選択画面

---

## 8. まとめ

### 8.1 問題の本質

**`SUPPORTED_LANGUAGES`が英語のみで定義されているため、プランに応じた言語が表示されない**

### 8.2 修正方針

**`SUPPORTED_LANGUAGES`にプランで使用されるすべての言語を追加する**

### 8.3 期待される結果

- ✅ Freeプラン: 日本語のみが表示される
- ✅ Miniプラン: 日本語＋英語が表示される
- ✅ Smallプラン: 日本語＋英語＋中国語が表示される
- ✅ Standardプラン: 日本語＋英語＋中国語＋フランス語が表示される
- ✅ Premiumプラン: 全言語が表示される

---

**Document Version**: v1.0  
**Author**: Auto (AI Assistant)  
**Last Updated**: 2026年01月17日  
**Status**: 📋 **根本調査分析完了・修正案提示**

