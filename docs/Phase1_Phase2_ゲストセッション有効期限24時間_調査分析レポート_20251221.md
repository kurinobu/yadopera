# ゲストセッション有効期限24時間 調査分析レポート

**作成日時**: 2025年12月21日  
**調査目的**: ゲストセッションの有効期限が24時間であるかどうかを文書とコードベースの両方から確認

---

## 調査結果サマリー

✅ **結論: ゲストセッションの有効期限は24時間であることが確認されました**

---

## 1. 文書からのエビデンス

### 1.1 要約定義書（yadopera-v03-summary.md）

**エビデンス1**: セッション統合トークンの有効期限
```169:169:docs/Summary/yadopera-v03-summary.md
- 有効期限: 無動作24時間で自動終了
```

**エビデンス2**: データベース設計
```483:483:docs/Summary/yadopera-v03-summary.md
expires_at TIMESTAMP  -- 24時間後
```

### 1.2 アーキテクチャ設計書（v0.1, v0.2, v0.3）

**エビデンス3**: Cookie設定（v0.1）
```1067:1067:docs/Architecture/やどぺら_v0.1_アーキテクチャ設計書.md
│ - Max-Age: 86400 (24h)     │
```

**エビデンス4**: セッション有効性チェック（v0.1）
```1120:1125:docs/Architecture/やどぺら_v0.1_アーキテクチャ設計書.md
    - 存在確認
    - 24時間以内のアクティビティ
    """
    conversation = db.query(Conversation).filter(
        Conversation.session_id == session_id,
        Conversation.is_active == True,
        Conversation.last_activity_at > datetime.utcnow() - timedelta(hours=24)
```

**エビデンス5**: Cookie設定（v0.2, v0.3）
```4292:4292:docs/Architecture/やどぺら_v0.3_アーキテクチャ設計書.md
│ - Max-Age: 86400 (24時間) v0.2
```

**エビデンス6**: セッション有効性チェックフロー（v0.3）
```1531:1534:docs/Architecture/やどぺら_v0.3_アーキテクチャ設計書.md
    │   │   ├─ 24時間以内のアクティビティ
    │   │   │   └─ セッション有効 → チャット画面へ
    │   │   └─ 24時間経過
    │   │       └─ セッション無効 → ウェルカム画面へ
```

---

## 2. コードベースからのエビデンス

### 2.1 フロントエンド実装

**エビデンス7**: セッションCookie有効期限設定（constants.ts）
```16:16:frontend/src/utils/constants.ts
export const SESSION_EXPIRES_DAYS = 1 // 24時間
```

**エビデンス8**: セッション管理Composable（useSession.ts）
```23:23:frontend/src/composables/useSession.ts
const SESSION_ID_EXPIRES_DAYS = 1 // 24時間
```

**エビデンス9**: Cookie設定の実装（useSession.ts）
```37:37:frontend/src/composables/useSession.ts
        expires: new Date(Date.now() + SESSION_ID_EXPIRES_DAYS * 24 * 60 * 60 * 1000),
```

計算式: `1日 × 24時間 × 60分 × 60秒 × 1000ミリ秒 = 86,400,000ミリ秒 = 24時間`

### 2.2 バックエンド実装

**エビデンス10**: 会話引き継ぎコード（SessionToken）の有効期限設定
```87:87:backend/app/services/session_token_service.py
                expires_at = datetime.now(timezone.utc) + timedelta(hours=24)
```

**エビデンス11**: データベースモデルのコメント
```25:25:backend/app/models/session_token.py
    expires_at = Column(DateTime(timezone=True), nullable=False, index=True)  # 24時間後
```

**エビデンス12**: 会話モデルのlast_activity_atコメント
```26:26:backend/app/models/conversation.py
    last_activity_at = Column(DateTime(timezone=True), server_default=func.now(), index=True)  # 24時間判定用
```

**エビデンス13**: 会話引き継ぎコードの有効期限チェック
```212:212:backend/app/services/session_token_service.py
        if token_obj.expires_at < datetime.now(timezone.utc):
```

**エビデンス14**: チャットサービスでの最終活動時刻更新
```172:172:backend/app/services/chat_service.py
        conversation.last_activity_at = datetime.utcnow()
```

---

## 3. 実装の詳細分析

### 3.1 セッション有効期限の仕組み

1. **Cookie有効期限**: フロントエンドで24時間（86,400秒 = 86400）に設定
2. **会話引き継ぎコード有効期限**: バックエンドで24時間（`timedelta(hours=24)`）に設定
3. **セッション有効性判定**: `last_activity_at`が24時間以内かどうかで判定（設計書に記載）

### 3.2 実装の一貫性

- ✅ フロントエンド: `SESSION_EXPIRES_DAYS = 1`（24時間）
- ✅ バックエンド: `timedelta(hours=24)`（24時間）
- ✅ Cookie Max-Age: `86400`秒（24時間）
- ✅ データベース: `expires_at`カラムに24時間後のタイムスタンプを保存

---

## 4. 結論

### 4.1 確認結果

**ゲストセッションの有効期限は24時間であることが確認されました。**

### 4.2 エビデンスの信頼性

- **文書エビデンス**: 6件（要約定義書、アーキテクチャ設計書v0.1/v0.2/v0.3）
- **コードエビデンス**: 8件（フロントエンド3件、バックエンド5件）
- **合計**: 14件のエビデンスが24時間有効期限を支持

### 4.3 実装の一貫性

すべての実装（フロントエンド、バックエンド、データベース、Cookie設定）で24時間が一貫して使用されています。

---

## 5. 補足情報

### 5.1 セッション有効期限の種類

1. **ゲストセッションCookie**: 24時間（`SESSION_EXPIRES_DAYS = 1`）
2. **会話引き継ぎコード**: 24時間（`timedelta(hours=24)`）
3. **セッション有効性判定**: `last_activity_at`が24時間以内（設計書に記載）

### 5.2 注意事項

- セッション有効性判定の実装（`last_activity_at > datetime.utcnow() - timedelta(hours=24)`）は設計書に記載されていますが、現在のコードベースでは明示的な実装が見つかりませんでした。
- ただし、`last_activity_at`はチャットメッセージ送信時に更新されており、設計意図は実装されていると考えられます。

---

**調査完了日時**: 2025年12月21日


