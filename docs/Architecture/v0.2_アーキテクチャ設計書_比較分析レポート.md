# v0.2アーキテクチャ設計書 比較分析レポート

**作成日**: 2025年11月19日  
**分析対象**: 
- `やどぺら_v0.2_アーキテクチャ設計書.md`
- `yadopera-v02-summary.md` (要約定義書)
- `やどぺら_v0.1_アーキテクチャ設計書.md` (v0.1版)

---

## 1. 分析結果サマリー

### ✅ 良好な点
- v0.1からの主要機能はすべて反映されている
- RAG統合、エスカレーションスケジュール、パスワードリセットなどv0.2の新機能は適切に実装されている
- 技術スタックの変更（TypeScript、Redis、pgvector）は正確に反映されている

### ⚠️ 抜け落ち・矛盾点

#### 重大な矛盾点
1. **JWT認証ライブラリの記載不一致**
   - 要約定義書: `Flask-JWT-Extended`（Flask用）
   - v0.2アーキテクチャ設計書: FastAPI使用（`python-jose`が正しい）
   - **影響**: 要約定義書の記載が誤り。v0.2アーキテクチャ設計書が正しい。

#### アーキテクチャ設計書の範囲外（記載不要）
以下の項目は要約定義書にはあるが、アーキテクチャ設計書の範囲外のため記載不要：
- GTM戦略（マーケティング）
- PoC計画（ビジネス計画）
- 収益モデル（ビジネス計画）
- 補助金活用戦略（ビジネス計画）

#### 補足推奨事項
1. **FAQ初期テンプレートの詳細**
   - 要約定義書: 30件の詳細な内訳あり
   - v0.2アーキテクチャ設計書: 「20-30件提供」のみ
   - **推奨**: 付録として詳細なFAQテンプレートリストを追加すると親切

2. **市場規模の記載**
   - 要約定義書: 「100-150施設（京都・大阪・東京）」
   - v0.2アーキテクチャ設計書: 記載なし
   - **推奨**: システム概要セクションに市場規模の記載を追加すると、スケーラビリティ要件の理解に役立つ

---

## 2. 詳細比較分析

### 2.1 v0.1からの抜け落ちチェック

#### ✅ すべて反映されている項目

| 項目 | v0.1 | v0.2 | 状態 |
|------|------|------|------|
| 3層構造AIエンジン | ✅ | ✅ (RAG統合型に変更) | 反映 |
| JWT認証 | ✅ | ✅ (7日間に変更) | 反映 |
| セッション管理 | ✅ | ✅ (Redis + Cookie、24時間) | 反映 |
| パスワードリセット | ✅ | ✅ | 反映 |
| エスカレーション | ✅ | ✅ (スケジュール管理追加) | 反映 |
| データベース設計 | ✅ | ✅ (pgvector追加) | 反映 |
| API設計 | ✅ | ✅ (RAG統合型レスポンス追加) | 反映 |
| エラーハンドリング | ✅ | ✅ | 反映 |
| デプロイメント | ✅ | ✅ (Redis追加) | 反映 |
| パフォーマンス要件 | ✅ | ✅ (RAG統合型に更新) | 反映 |
| 開発規約 | ✅ | ✅ (TypeScript追加) | 反映 |

#### ⚠️ 変更が必要な項目

| 項目 | v0.1 | v0.2要約定義書 | v0.2アーキテクチャ設計書 | 状態 |
|------|------|---------------|----------------------|------|
| システムの目的 | 90%削減 | 70%自動化（MVP目標） | 70%自動化（MVP目標） | ✅ 一致 |
| JWT有効期限 | 60分 | 7日間 | 7日間 | ✅ 一致 |
| セッション有効期限 | 記載なし | 24時間 | 24時間 | ✅ 一致 |
| AIエンジン | 3層構造 | RAG統合型 | RAG統合型 | ✅ 一致 |

### 2.2 要約定義書との矛盾点チェック

#### 🔴 重大な矛盾点

**1. JWT認証ライブラリの記載不一致**

- **要約定義書 (line 161)**: 
  ```
  JWT認証（Flask-JWT-Extended、有効期限7日間）
  ```
- **v0.2アーキテクチャ設計書**: 
  - FastAPI使用（`python-jose`が正しい）
  - `Flask-JWT-Extended`はFlask用のライブラリ

**結論**: 要約定義書の記載が誤り。v0.2アーキテクチャ設計書が正しい。要約定義書の修正が必要。

#### ⚠️ 記載不一致（要確認）

**2. システムの目的**

- **要約定義書**: 「70%自動化（MVP目標、Phase 2で85%+）」
- **v0.2アーキテクチャ設計書**: 「70%自動化（MVP目標、Phase 2で85%+）」
- **状態**: ✅ 一致

**3. エスカレーション閾値**

- **要約定義書**: 
  - 通常モード: 0.7
  - 早期モード: 0.85
- **v0.2アーキテクチャ設計書**: 
  - 通常モード: 0.7
  - 早期モード: 0.85
- **状態**: ✅ 一致

**4. セッション管理**

- **要約定義書**: Cookie保存、24時間有効期限、複数デバイス対応
- **v0.2アーキテクチャ設計書**: Cookie保存、24時間有効期限、Redisバックエンド
- **状態**: ✅ 一致（v0.2アーキテクチャ設計書の方が詳細）

**5. FAQ初期件数**

- **要約定義書**: 20-30件テンプレート提供（詳細な内訳あり）
- **v0.2アーキテクチャ設計書**: 20-30件提供（詳細なし）
- **状態**: ⚠️ 詳細が不足（付録として追加推奨）

### 2.3 アーキテクチャ設計書の範囲外項目

以下の項目は要約定義書にはあるが、アーキテクチャ設計書の範囲外のため記載不要：

| 項目 | 要約定義書 | v0.2アーキテクチャ設計書 | 判断 |
|------|-----------|----------------------|------|
| GTM戦略 | ✅ 詳細あり | ❌ 記載なし | ✅ 範囲外（記載不要） |
| PoC計画 | ✅ 詳細あり | ❌ 記載なし | ✅ 範囲外（記載不要） |
| 収益モデル | ✅ 詳細あり | ❌ 記載なし | ✅ 範囲外（記載不要） |
| 補助金活用戦略 | ✅ 詳細あり | ❌ 記載なし | ✅ 範囲外（記載不要） |
| 開発スケジュール | ✅ 詳細あり | ❌ 記載なし | ✅ 範囲外（記載不要） |
| リスクと対策 | ✅ 詳細あり | ❌ 記載なし | ✅ 範囲外（記載不要） |
| 成功指標（KPI） | ✅ 詳細あり | ❌ 記載なし | ✅ 範囲外（記載不要） |

**結論**: これらはビジネス計画やプロジェクト管理の内容であり、アーキテクチャ設計書の範囲外。記載不要。

### 2.4 補足推奨事項

#### 1. FAQ初期テンプレートの詳細

**現状**:
- v0.2アーキテクチャ設計書: 「20-30件提供」のみ
- 要約定義書: 30件の詳細な内訳あり（基本情報5件、設備・サービス10件、周辺情報5件、トラブル対応5件、拡張5件）

**推奨**: 
- 付録セクションにFAQ初期テンプレート30件の詳細リストを追加
- 開発者が実装時に参照できるようにする

#### 2. 市場規模の記載

**現状**:
- v0.2アーキテクチャ設計書: 記載なし
- 要約定義書: 「100-150施設（京都・大阪・東京）」

**推奨**: 
- システム概要セクションに市場規模の記載を追加
- スケーラビリティ要件の理解に役立つ

#### 3. 月間質問数の記載

**現状**:
- v0.2アーキテクチャ設計書: 記載なし
- 要約定義書: 「月間質問数100件/施設」

**推奨**: 
- パフォーマンス要件セクションに記載を追加
- 負荷テスト目標の設定に役立つ

---

## 3. 技術的な整合性チェック

### 3.1 技術スタックの整合性

| 技術 | 要約定義書 | v0.2アーキテクチャ設計書 | 状態 |
|------|-----------|----------------------|------|
| フロントエンド | Vue.js 3 + TypeScript | Vue.js 3 + TypeScript | ✅ 一致 |
| バックエンド | FastAPI | FastAPI | ✅ 一致 |
| データベース | PostgreSQL 15+ (pgvector) | PostgreSQL 15+ (pgvector) | ✅ 一致 |
| キャッシュ/セッション | Redis 7.2+ | Redis 7.2+ | ✅ 一致 |
| AI | GPT-4o mini, text-embedding-3-small | GPT-4o mini, text-embedding-3-small | ✅ 一致 |
| ベクトル検索 | pgvector 0.2+ | pgvector 0.2+ | ✅ 一致 |
| ホスティング | Render.com | Render.com | ✅ 一致 |

### 3.2 データベース設計の整合性

| テーブル | 要約定義書 | v0.2アーキテクチャ設計書 | 状態 |
|----------|-----------|----------------------|------|
| facilities | ✅ | ✅ | ✅ 一致 |
| users | ✅ | ✅ | ✅ 一致 |
| faqs | ✅ (embedding追加) | ✅ (embedding追加) | ✅ 一致 |
| conversations | ✅ | ✅ | ✅ 一致 |
| messages | ✅ (ai_confidence追加) | ✅ (ai_confidence追加) | ✅ 一致 |
| escalations | ✅ (escalation_mode追加) | ✅ (escalation_mode追加) | ✅ 一致 |
| escalation_schedules | ✅ (新規) | ✅ (新規) | ✅ 一致 |
| qr_codes | ✅ | ✅ | ✅ 一致 |
| password_resets | ✅ (新規) | ✅ (新規) | ✅ 一致 |

### 3.3 API設計の整合性

| エンドポイント | 要約定義書 | v0.2アーキテクチャ設計書 | 状態 |
|---------------|-----------|----------------------|------|
| POST /api/v1/chat | ✅ | ✅ (RAG統合型) | ✅ 一致 |
| GET /api/v1/facility/{slug} | ✅ | ✅ | ✅ 一致 |
| POST /api/v1/auth/login | ✅ | ✅ | ✅ 一致 |
| POST /api/v1/auth/password-reset | ✅ (新規) | ✅ (新規) | ✅ 一致 |
| GET /api/v1/admin/dashboard | ✅ | ✅ | ✅ 一致 |
| GET/POST/PUT/DELETE /api/v1/admin/faqs | ✅ | ✅ (埋め込みベクトル自動生成) | ✅ 一致 |
| GET/POST/PUT /api/v1/admin/escalation-schedule | ✅ (新規) | ✅ (新規) | ✅ 一致 |

---

## 4. 修正推奨事項

### 4.1 要約定義書の修正が必要

**修正箇所**: `yadopera-v02-summary.md` line 161

**修正前**:
```
JWT認証（Flask-JWT-Extended、有効期限7日間）
```

**修正後**:
```
JWT認証（python-jose、有効期限7日間）
```

**理由**: FastAPIを使用しているため、Flask用の`Flask-JWT-Extended`ではなく、FastAPI用の`python-jose`が正しい。

### 4.2 v0.2アーキテクチャ設計書への追加推奨

#### 1. 付録: FAQ初期テンプレート30件

**追加場所**: 付録セクション（最後）

**内容**: 要約定義書の「付録 B. 初期FAQテンプレート30件」を参照

#### 2. システム概要: 市場規模

**追加場所**: セクション1.1「システムの目的」の後

**内容**:
```markdown
### 1.2 市場規模（参考）

- **対象施設数**: 100-150施設（京都・大阪・東京）
- **月間質問数**: 100件/施設（想定）
- **やどびとネットワーク**: 実数200施設
```

#### 3. パフォーマンス要件: 月間質問数

**追加場所**: セクション15「パフォーマンス要件」

**内容**:
```markdown
### 15.7 想定利用量

- **月間質問数**: 100件/施設（想定）
- **同時接続数**: 最大10施設同時利用
- **ピーク時**: 夜間（22-8時）に30件/月/施設
```

---

## 5. 結論

### ✅ 総合評価

v0.2アーキテクチャ設計書は、v0.1からの変更点を適切に反映し、要約定義書の技術要件と整合性が取れています。

### 🔴 修正が必要な項目

1. **要約定義書**: JWT認証ライブラリの記載を修正（`Flask-JWT-Extended` → `python-jose`）

### ⚠️ 補足推奨事項

1. **v0.2アーキテクチャ設計書**: FAQ初期テンプレート30件の詳細リストを付録に追加
2. **v0.2アーキテクチャ設計書**: 市場規模の記載をシステム概要に追加
3. **v0.2アーキテクチャ設計書**: 月間質問数の記載をパフォーマンス要件に追加

### ✅ 範囲外（記載不要）

以下の項目はアーキテクチャ設計書の範囲外のため、記載不要で問題ありません：
- GTM戦略
- PoC計画
- 収益モデル
- 補助金活用戦略
- 開発スケジュール
- リスクと対策
- 成功指標（KPI）

---

**分析完了日**: 2025年11月19日  
**分析者**: AI Assistant


