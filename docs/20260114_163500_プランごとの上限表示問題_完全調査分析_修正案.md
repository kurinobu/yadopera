# プランごとの上限表示問題 - 完全調査分析・修正案

**作成日時**: 2026年1月14日 16:35:00  
**目的**: 「全てのプランで「あと30件で上限です」と表示される」問題の完全調査分析と修正案提示  
**状態**: 調査分析完了、修正案提示

---

## 1. 問題の説明

### 1.1 問題の内容

- **報告**: 全てのプランで「あと30件で上限です」と表示される
- **期待**: プランごとの上限を表示する
  - Freeプラン: 「あと30件で上限です」
  - Smallプラン: 「あと200件で上限です」
  - Standardプラン: 「あと500件で上限です」
  - Premiumプラン: 「あと1000件で上限です」

---

## 2. 完全調査分析

### 2.1 Backend APIレスポンス確認結果

**確認結果**:
```
=== Freeプラン ===
  Plan Limit: 30
  Remaining Questions: 30
  Current Month Questions: 0
  Usage Percentage: 0.0

=== Miniプラン ===
  Plan Limit: None
  Remaining Questions: None
  Current Month Questions: 0
  Usage Percentage: None

=== Smallプラン ===
  Plan Limit: 200
  Remaining Questions: 200
  Current Month Questions: 0
  Usage Percentage: 0.0

=== Standardプラン ===
  Plan Limit: 200  ← 問題: 本来は500であるべき
  Remaining Questions: 200  ← 問題: 本来は500であるべき
  Current Month Questions: 0
  Usage Percentage: 0.0

=== Premiumプラン ===
  Plan Limit: 200  ← 問題: 本来は1000であるべき
  Remaining Questions: 200  ← 問題: 本来は1000であるべき
  Current Month Questions: 0
  Usage Percentage: 0.0
```

### 2.2 根本原因の分析

**問題1: StandardプランとPremiumプランで`plan_limit`が200になっている**

**原因**:
- 修正案1では、`plan_limit`が`None`の場合のみデフォルト値を適用している
- StandardプランとPremiumプランでは、データベースの`monthly_question_limit`が`200`（NULLではない）のまま
- そのため、デフォルト値が適用されず、間違った値（200）がそのまま使用されている

**確認コード**:
```python
# 修正案1のコード
if plan_limit is None:  # ← この条件では、plan_limit = 200の場合は適用されない
    plan_limits = {
        'Free': 30,
        'Mini': None,
        'Small': 200,
        'Standard': 500,
        'Premium': 1000
    }
    plan_limit = plan_limits.get(plan_type, 30)
```

**問題2: フロントエンドの`statusMessage` computed**

**現在のコード**:
```typescript
const statusMessage = computed(() => {
  const usage = props.data.usage_percentage || 0
  if (usage >= 100) {
    return `⚠️ 従量課金が発生しています（${props.data.overage_questions}件超過）`
  }
  if (usage >= 91) {
    return `⚠️ まもなく上限です（残り${props.data.remaining_questions}件）`
  }
  if (usage >= 71) {
    return `残り${props.data.remaining_questions}件です`
  }
  return `あと${props.data.remaining_questions}件で上限です`  // ← remaining_questionsの値を使っている
})
```

**評価**:
- `statusMessage` computedは`remaining_questions`の値を使っているため、Backendから正しい値が返されていれば正しく表示される
- 問題はBackendで正しい値が返されていないこと

---

## 3. 修正案の評価

### 3.1 修正案2の評価

**修正案2の内容**:
- `statusMessage` computedで`null`チェックを追加
- Miniプランの場合はメッセージを表示しない

**評価**:
- ❌ **修正案2では解決しない**: 修正案2は`null`チェックを追加するだけで、プランごとの上限を正しく表示する処理は含まれていない
- 修正案2を実施しても、StandardプランとPremiumプランで「あと200件で上限です」と表示される問題は解決しない

### 3.2 修正案1の評価

**修正案1の内容**:
- `plan_limit`が`None`の場合のみデフォルト値を適用

**評価**:
- ⚠️ **不完全**: `plan_limit`が`None`の場合のみデフォルト値を適用しているが、StandardプランとPremiumプランでは`plan_limit = 200`（NULLではない）なので、デフォルト値が適用されていない

---

## 4. 根本原因の完全調査分析

### 4.1 問題の本質

**問題の本質**:
- Backendサービス層で、プラン種別に応じた正しいデフォルト値が設定されていない場合（データベースの値が間違っている場合）でも、正しいデフォルト値を適用する必要がある
- 現在の実装では、`plan_limit`が`None`の場合のみデフォルト値を適用しているが、`plan_limit`が間違った値（例: Standardプランで200）の場合には適用されない

### 4.2 データベースの状態

**確認結果**:
- Freeプラン: `monthly_question_limit = NULL` → 修正案1で30に適用 ✅
- Miniプラン: `monthly_question_limit = NULL` → 修正案1でNoneに適用 ✅
- Smallプラン: `monthly_question_limit = 200` → 正しい ✅
- Standardプラン: `monthly_question_limit = 200` → 間違い（本来は500であるべき） ❌
- Premiumプラン: `monthly_question_limit = 200` → 間違い（本来は1000であるべき） ❌

---

## 5. 大原則準拠評価

### 5.1 根本解決 > 暫定解決

**評価**: ✅ **準拠**
- データベースの値が間違っている場合でも、正しいデフォルト値を適用する（根本解決）
- 暫定的な回避策ではなく、設計レベルでの解決を提案

### 5.2 シンプル構造 > 複雑構造

**評価**: ✅ **準拠**
- 修正案は既存のコードパターンに従う
- 過度に複雑な実装を避けている

### 5.3 統一・同一化 > 特殊独自

**評価**: ✅ **準拠**
- 既存のコードパターンに従う
- 特殊な実装を避け、統一されたパターンを採用

### 5.4 具体的 > 一般

**評価**: ✅ **準拠**
- 具体的な修正コードを提示
- 実行可能な具体的な内容を記載

### 5.5 拙速 < 安全確実

**評価**: ✅ **準拠**
- テストを省略せず、十分な検証を行う
- 安全を確保しながら修正を実施

---

## 6. 修正案

### 6.1 修正案1-1: Backendサービス層でプラン種別に応じた正しいデフォルト値を強制適用（根本解決）

**理由**: データベースの値が間違っている場合でも、正しいデフォルト値を適用する（根本解決）

**修正ファイル**: `backend/app/services/dashboard_service.py`

**修正箇所**: `get_monthly_usage`メソッド（436-438行目）

**修正コード**:
```python
# プラン情報を取得
plan_type = facility.plan_type or 'Free'
plan_limit = facility.monthly_question_limit

# プラン種別に応じた正しいデフォルト値を定義
plan_limits = {
    'Free': 30,
    'Mini': None,  # 無制限
    'Small': 200,
    'Standard': 500,
    'Premium': 1000
}

# プラン種別に応じた正しいデフォルト値を強制適用
# plan_limitがNoneの場合、またはプラン種別に応じた正しい値と一致しない場合に適用
expected_limit = plan_limits.get(plan_type, 30)
if plan_limit is None or plan_limit != expected_limit:
    plan_limit = expected_limit
```

**修正後の期待結果**:
- Freeプラン: `plan_limit = 30` ✅
- Miniプラン: `plan_limit = None`（無制限） ✅
- Smallプラン: `plan_limit = 200` ✅
- Standardプラン: `plan_limit = 500` ✅（修正前: 200 → 修正後: 500）
- Premiumプラン: `plan_limit = 1000` ✅（修正前: 200 → 修正後: 1000）

---

## 7. 修正実施順序

### ステップ1: Backendサービス層でプラン種別に応じた正しいデフォルト値を強制適用（最優先・根本解決）

**理由**: データベースの値が間違っている場合でも、正しいデフォルト値を適用する（根本解決）

**修正ファイル**: `backend/app/services/dashboard_service.py`

---

## 8. 修正後の期待結果

### 8.1 各プランでの表示

- ✅ Freeプラン: 「あと30件で上限です」
- ✅ Miniプラン: ステータスメッセージなし（従量課金プランバッジのみ）
- ✅ Smallプラン: 「あと200件で上限です」
- ✅ Standardプラン: 「あと500件で上限です」（修正前: 「あと200件で上限です」）
- ✅ Premiumプラン: 「あと1000件で上限です」（修正前: 「あと200件で上限です」）

---

## 9. テスト項目

### 9.1 修正後のテスト項目

1. **Freeプランでの表示確認**
   - 「あと30件で上限です」と表示される

2. **Miniプランでの表示確認**
   - ステータスメッセージが表示されない
   - 「従量課金プラン」バッジが表示される

3. **Smallプランでの表示確認**
   - 「あと200件で上限です」と表示される

4. **Standardプランでの表示確認**
   - 「あと500件で上限です」と表示される（修正前: 「あと200件で上限です」）

5. **Premiumプランでの表示確認**
   - 「あと1000件で上限です」と表示される（修正前: 「あと200件で上限です」）

---

**Document Version**: v1.0  
**Author**: Auto (AI Assistant)  
**Last Updated**: 2026年1月14日 16:35:00  
**Status**: 調査分析完了、修正案提示完了

