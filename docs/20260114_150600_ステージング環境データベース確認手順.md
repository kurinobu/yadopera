# ステージング環境データベース確認手順

**作成日**: 2025年1月14日 15:06:00  
**更新日**: 2025年1月14日 15:30:00  
**目的**: ステージング環境のデータベース状態を確認し、operator_faqsテーブルの存在とデータの有無を確認  
**状態**: ✅ 確認完了、初期データ投入完了（2025-01-14 15:29）

---

## 方法1: Railway CLIを使用（推奨）

### ステップ1: Railway CLIでログイン

```bash
railway login
```

### ステップ2: プロジェクトを選択

```bash
railway link
```

または、プロジェクトIDを指定:

```bash
railway link <project-id>
```

### ステップ3: データベース接続情報を取得

```bash
railway variables
```

`DATABASE_URL`の値を確認します。

### ステップ4: 環境変数を設定して確認スクリプトを実行

```bash
# DATABASE_URLを環境変数に設定（Railway CLIから取得した値を使用）
export DATABASE_URL="postgresql://postgres:password@host:port/database"

# 確認スクリプトを実行
cd /Users/kurinobu/projects/yadopera
python backend/scripts/check_staging_db.py
```

---

## 方法2: Railwayダッシュボードから直接接続

### ステップ1: Railwayダッシュボードにアクセス

1. https://railway.app にアクセス
2. プロジェクトを選択
3. PostgreSQLサービスを選択

### ステップ2: 接続情報を取得

1. 「Variables」タブで`DATABASE_URL`または`DATABASE_PUBLIC_URL`を確認
2. 接続情報をコピー

### ステップ3: 環境変数を設定して確認スクリプトを実行

```bash
# DATABASE_URLを環境変数に設定
export DATABASE_URL="postgresql://postgres:password@host:port/database"

# 確認スクリプトを実行
cd /Users/kurinobu/projects/yadopera
python backend/scripts/check_staging_db.py
```

---

## 方法3: Render.comの環境変数から取得

### ステップ1: Render.comダッシュボードにアクセス

1. https://dashboard.render.com にアクセス
2. `yadopera-backend-staging`サービスを選択
3. 「Environment」タブを開く

### ステップ2: DATABASE_URLを確認

`DATABASE_URL`環境変数の値を確認します。

### ステップ3: 環境変数を設定して確認スクリプトを実行

```bash
# DATABASE_URLを環境変数に設定（Render.comから取得した値を使用）
export DATABASE_URL="postgresql://postgres:password@host:port/database"

# 確認スクリプトを実行
cd /Users/kurinobu/projects/yadopera
python backend/scripts/check_staging_db.py
```

---

## 確認スクリプトの出力内容

スクリプトは以下の情報を表示します:

1. **テーブル存在確認**
   - `operator_faqs`テーブルの存在
   - `operator_faq_translations`テーブルの存在

2. **データ存在確認**
   - `operator_faqs`のデータ数
   - `operator_faq_translations`のデータ数
   - カテゴリ別FAQ数
   - 言語別翻訳数

3. **Alembicマイグレーション状態確認**
   - 現在のマイグレーションリビジョン
   - マイグレーション011（operator_help_tables追加）の適用状況

4. **サマリー**
   - データベース状態の総合評価
   - 必要なアクションの提示

---

## 期待される結果

### 正常な状態

```
✅ operator_faqsテーブル: 存在
✅ operator_faq_translationsテーブル: 存在
📊 operator_faqs: 31件
📊 operator_faq_translations: 62件
✅ マイグレーション011（operator_help_tables追加）: 適用済み
✅ データベース状態: 正常（テーブル存在、データ投入済み）
```

### テーブルが存在しない場合

```
❌ operator_faqsテーブル: 存在しない
❌ operator_faq_translationsテーブル: 存在しない
❌ データベース状態: テーブルが存在しません
   マイグレーションを実行してください:
   alembic upgrade head
```

### テーブルは存在するがデータがない場合

```
✅ operator_faqsテーブル: 存在
✅ operator_faq_translationsテーブル: 存在
📊 operator_faqs: 0件
📊 operator_faq_translations: 0件
⚠️  データベース状態: テーブルは存在するが、データが投入されていません
   初期データ投入スクリプトを実行してください:
   python backend/scripts/insert_operator_faqs.py
```

---

## 次のステップ

確認結果に応じて、以下のアクションを実行してください:

### テーブルが存在しない場合

1. マイグレーションを実行:
   ```bash
   # Render.comのデプロイ時に自動実行されるはずですが、手動で実行する場合
   railway run alembic upgrade head
   ```

2. または、Render.comのデプロイログを確認し、マイグレーションが実行されているか確認

### テーブルは存在するがデータがない場合

1. 初期データ投入スクリプトを実行:
   ```bash
   export DATABASE_URL="postgresql://postgres:password@host:port/database"
   python backend/scripts/insert_operator_faqs.py
   ```

---

**Document Version**: v1.1  
**Author**: Auto (AI Assistant)  
**Last Updated**: 2025年1月14日 15:30:00

---

## 10. 確認結果サマリー

### 10.1 確認日時
2025年1月14日 15:07

### 10.2 確認結果
- テーブル存在: ✅ 確認済み（operator_faqs、operator_faq_translations）
- データ存在: ❌ データなし（0件）

### 10.3 解決日時
2025年1月14日 15:29

### 10.4 解決内容
- 初期データ投入スクリプトを実行
- 31件のFAQデータを投入完了
- APIエンドポイントで正常動作を確認

### 10.5 デプロイ情報
- ブランチ: `develop`
- コミット: `7df3e86` - "Add Phase 2 Step 1: 統合ヘルプシステム実装完了"
- デプロイ環境: Render.com ステージング環境（自動デプロイ）

