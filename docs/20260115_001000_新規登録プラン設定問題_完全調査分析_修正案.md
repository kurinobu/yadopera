# 新規登録プラン設定問題 - 完全調査分析・修正案

**作成日時**: 2026年1月15日 00:10:00  
**目的**: 新規登録時に全プランがFreeプランとして表示される問題の完全調査分析と修正案  
**状態**: 原因特定完了、修正案準備完了

---

## 1. 問題の説明

### 1.1 報告された問題

- **現象**: ステージング環境で31~71まで各プランで新規登録したが、ダッシュボード表示が全てFreeプランの表示になっている
- **期待**: 新規登録時に選択したプラン（free/mini/small/standard/premium）に応じた正しい表示
- **実際**: すべてFreeプランとして表示される

---

## 2. 原因の完全調査分析

### 2.1 データベース確認結果

**ローカル環境（Docker）の確認結果**:
- ID 36-40の施設は正しく`plan_type`と`monthly_question_limit`が設定されている
- これはマイグレーション実行後に作成された施設で、マイグレーションの`UPDATE`文が適用されたため

**問題の本質**:
- マイグレーション（`012_add_facility_plan_columns.py`）は**既存データ**に対してのみ`UPDATE`文を実行
- **新規登録時**には、マイグレーションは実行されない
- 新規登録API（`register_facility_sync`）で`plan_type`と`monthly_question_limit`を設定していない

---

### 2.2 コード分析

#### 2.2.1 新規登録APIの実装

**ファイル**: `backend/app/services/auth_service.py`

**現在の実装**（207-213行目）:
```python
# 施設作成
facility = Facility(
    name=request.facility_name,
    slug=await AuthService._generate_unique_slug(db, request.facility_name),
    email=request.email,
    subscription_plan=request.subscription_plan
)
```

**問題点**:
1. `subscription_plan`のみを設定している
2. `plan_type`は設定していない（モデルのデフォルト値'Free'が使用される）
3. `monthly_question_limit`は設定していない（モデルのデフォルト値`NULL`が使用される）
4. `faq_limit`と`language_limit`も設定していない

#### 2.2.2 モデルのデフォルト値

**ファイル**: `backend/app/models/facility.py`

```python
plan_type = Column(String(20), default='Free', nullable=False)  # デフォルト: 'Free'
monthly_question_limit = Column(Integer, nullable=True)  # デフォルト: NULL
faq_limit = Column(Integer, default=20, nullable=True)  # デフォルト: 20
language_limit = Column(Integer, default=1, nullable=True)  # デフォルト: 1
```

**問題点**:
- `plan_type`のデフォルト値が'Free'のため、`subscription_plan`を設定しても`plan_type`は'Free'のまま
- `monthly_question_limit`のデフォルト値が`NULL`のため、プランに応じた上限が設定されない

#### 2.2.3 マイグレーションの動作

**ファイル**: `backend/alembic/versions/012_add_facility_plan_columns.py`

**マイグレーションの内容**:
- 既存の`subscription_plan`から`plan_type`を変換（34-45行目）
- 既存の`monthly_question_limit`をプラン別に設定（85-119行目）

**問題点**:
- マイグレーションは**既存データ**に対してのみ実行される
- **新規登録時**には、マイグレーションは実行されない
- 新規登録APIで`plan_type`と`monthly_question_limit`を設定する必要がある

---

### 2.3 根本原因

**根本原因**: 新規登録API（`register_facility_sync`）で`subscription_plan`から`plan_type`への変換と、プラン別の`monthly_question_limit`設定が実装されていない

**影響範囲**:
- ステージング環境で新規登録したすべての施設
- 本番環境で新規登録するすべての施設（修正前）

---

## 3. 修正案

### 3.1 修正案1: 新規登録APIでプラン情報を正しく設定（根本解決）

**方針**: `register_facility_sync`メソッドで、`subscription_plan`から`plan_type`を変換し、プラン別の`monthly_question_limit`、`faq_limit`、`language_limit`を設定する

**実装内容**:

1. **`subscription_plan`から`plan_type`への変換関数を作成**
   ```python
   def convert_subscription_plan_to_plan_type(subscription_plan: str) -> str:
       """subscription_planをplan_typeに変換"""
       plan_mapping = {
           'free': 'Free',
           'mini': 'Mini',
           'small': 'Small',
           'standard': 'Standard',
           'premium': 'Premium'
       }
       return plan_mapping.get(subscription_plan.lower(), 'Free')
   ```

2. **プラン別のデフォルト値を定義**
   ```python
   def get_plan_defaults(plan_type: str) -> dict:
       """プラン種別に応じたデフォルト値を取得"""
       defaults = {
           'Free': {
               'monthly_question_limit': 30,
               'faq_limit': 20,
               'language_limit': 1
           },
           'Mini': {
               'monthly_question_limit': None,  # 無制限
               'faq_limit': 20,
               'language_limit': 1
           },
           'Small': {
               'monthly_question_limit': 200,
               'faq_limit': 20,
               'language_limit': 1
           },
           'Standard': {
               'monthly_question_limit': 500,
               'faq_limit': 20,
               'language_limit': 1
           },
           'Premium': {
               'monthly_question_limit': 1000,
               'faq_limit': None,  # 無制限
               'language_limit': None  # 無制限
           }
       }
       return defaults.get(plan_type, defaults['Free'])
   ```

3. **`register_facility_sync`メソッドを修正**
   ```python
   # プラン情報を変換・設定
   plan_type = convert_subscription_plan_to_plan_type(request.subscription_plan)
   plan_defaults = get_plan_defaults(plan_type)
   
   # 施設作成
   facility = Facility(
       name=request.facility_name,
       slug=await AuthService._generate_unique_slug(db, request.facility_name),
       email=request.email,
       subscription_plan=request.subscription_plan,
       plan_type=plan_type,
       monthly_question_limit=plan_defaults['monthly_question_limit'],
       faq_limit=plan_defaults['faq_limit'],
       language_limit=plan_defaults['language_limit']
   )
   ```

**修正ファイル**:
- `backend/app/services/auth_service.py`

**メリット**:
- ✅ 新規登録時に正しいプラン情報が設定される
- ✅ マイグレーションに依存しない
- ✅ 既存の`subscription_plan`との互換性を維持

**デメリット**:
- なし

---

### 3.2 修正案2: 既存データの修正（補完的）

**方針**: ステージング環境の既存データ（ID 31-71）に対して、`subscription_plan`から`plan_type`と`monthly_question_limit`を設定するSQLスクリプトを実行

**実装内容**:

```sql
-- subscription_planからplan_typeを設定
UPDATE facilities 
SET plan_type = CASE 
    WHEN LOWER(subscription_plan) = 'free' THEN 'Free'
    WHEN LOWER(subscription_plan) = 'mini' THEN 'Mini'
    WHEN LOWER(subscription_plan) = 'small' THEN 'Small'
    WHEN LOWER(subscription_plan) = 'standard' THEN 'Standard'
    WHEN LOWER(subscription_plan) = 'premium' THEN 'Premium'
    ELSE 'Free'
END
WHERE id >= 31 AND id <= 71;

-- プラン別のmonthly_question_limitを設定
UPDATE facilities 
SET monthly_question_limit = 30 
WHERE plan_type = 'Free' AND monthly_question_limit IS NULL;

UPDATE facilities 
SET monthly_question_limit = NULL 
WHERE plan_type = 'Mini';

UPDATE facilities 
SET monthly_question_limit = 200 
WHERE plan_type = 'Small' AND monthly_question_limit IS NULL;

UPDATE facilities 
SET monthly_question_limit = 500 
WHERE plan_type = 'Standard' AND monthly_question_limit IS NULL;

UPDATE facilities 
SET monthly_question_limit = 1000 
WHERE plan_type = 'Premium' AND monthly_question_limit IS NULL;

-- Premiumプランのfaq_limitとlanguage_limitをNULLに設定
UPDATE facilities 
SET faq_limit = NULL, language_limit = NULL 
WHERE plan_type = 'Premium';
```

**実行方法**:
- ステージング環境のデータベースに直接接続して実行
- または、Pythonスクリプトを作成して実行

**メリット**:
- ✅ 既存データを即座に修正できる

**デメリット**:
- ⚠️ 根本解決ではない（新規登録の問題は解決しない）

---

## 4. 推奨される修正手順

### 4.1 優先順位

1. **最優先**: 修正案1（新規登録APIの修正）
   - 根本原因を解決
   - 今後新規登録されるすべての施設に適用される

2. **補完的**: 修正案2（既存データの修正）
   - ステージング環境の既存データを修正
   - テストを継続できるようにする

---

### 4.2 実装手順

1. **修正案1を実装**
   - `backend/app/services/auth_service.py`を修正
   - ローカル環境でテスト
   - コミット・プッシュ

2. **ステージング環境にデプロイ**
   - Render.comで自動デプロイ
   - デプロイ完了を確認

3. **修正案2を実行（必要に応じて）**
   - ステージング環境のデータベースに接続
   - SQLスクリプトを実行
   - 既存データの修正を確認

4. **動作確認**
   - 新規登録で各プランを選択
   - ダッシュボードで正しいプラン表示を確認

---

## 5. 影響範囲

### 5.1 影響を受ける機能

- ✅ 新規登録API（`/api/v1/auth/register`）
- ✅ ダッシュボード表示（月次統計カード）

### 5.2 影響を受けない機能

- ✅ 既存の施設データ（マイグレーションで修正済み）
- ✅ その他のAPIエンドポイント

---

## 6. テスト計画

### 6.1 単体テスト

- `convert_subscription_plan_to_plan_type`関数のテスト
- `get_plan_defaults`関数のテスト

### 6.2 統合テスト

- 各プラン（free/mini/small/standard/premium）で新規登録
- ダッシュボードで正しいプラン表示を確認

### 6.3 ブラウザテスト

- 各プランで新規登録
- ダッシュボードで正しいプラン表示を確認
- 月次統計カードの表示を確認

---

## 7. 結論

**根本原因**: 新規登録APIで`subscription_plan`から`plan_type`への変換と、プラン別の`monthly_question_limit`設定が実装されていない

**修正案**: 修正案1（新規登録APIの修正）を最優先で実装し、修正案2（既存データの修正）を補完的に実行

**期待される結果**: 新規登録時に選択したプランに応じた正しいプラン情報が設定され、ダッシュボードで正しく表示される

---

**Document Version**: v1.0  
**Author**: Auto (AI Assistant)  
**Last Updated**: 2026年1月15日 00:10:00  
**Status**: 原因特定完了、修正案準備完了

