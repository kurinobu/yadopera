# Phase 1・Phase 2: 施設情報取得エラー「施設情報の取得に失敗しました」完全調査分析

**作成日時**: 2025年12月18日  
**実施者**: AI Assistant  
**目的**: 「施設情報の取得に失敗しました」と表示される条件を完全に調査分析し、オフライン時の適切なエラーハンドリング方法を特定  
**状態**: 📋 **完全調査分析完了**

**重要**: 指示があるまで修正を実施しません。調査分析のみです。

---

## 1. 調査目的

### 1.1 問題の背景

**ユーザー体験の問題**:
- オフライン時に「施設情報の取得に失敗しました」と表示されると、ゲストは「宿泊施設の問題」または「システムの問題」と誤認する可能性がある
- 実際には「オフラインです」ということを伝えるべき

**必要な対応**:
- オフラインが原因の場合、ゲストに以下を伝える必要がある：
  1. 現在オフラインである
  2. オンラインに切り替える方法
  3. 正しい回答が得られない場合がある

### 1.2 調査項目

1. 「施設情報の取得に失敗しました」と表示される条件
2. エラーの種類と分類（オフライン、ネットワークエラー、サーバーエラーなど）
3. 現在のエラーハンドリングの実装状況
4. オフライン検出の実装状況
5. エラーメッセージの表示ロジック

---

## 2. 「施設情報の取得に失敗しました」が表示される条件

### 2.1 表示箇所

**`frontend/src/views/guest/Chat.vue`**（199-202行目）:
```typescript
try {
  const response = await facilityApi.getFacility(slug, location.value)
  facilityStore.setFacility(response.facility)
  facilityStore.setTopQuestions(response.top_questions)
} catch (err) {
  console.error('[Chat.vue] onMounted: 施設情報取得エラー', err)
  error.value = '施設情報の取得に失敗しました'  // ← ここで表示
  return
}
```

**`frontend/src/views/guest/Welcome.vue`**（83-88行目）:
```typescript
const response = await facilityApi.getFacility(slug, location.value)
facilityStore.setFacility(response.facility)
facilityStore.setTopQuestions(response.top_questions)
} catch (err) {
  error.value = '施設情報の取得に失敗しました'  // ← ここで表示
  console.error('Facility fetch error:', err)
}
```

### 2.2 エラーが発生する条件

**`facilityApi.getFacility`がエラーをthrowする条件**:
- `apiClient.get<FacilityPublicResponse>(`/facility/${slug}`, { params })`がエラーを返す場合
- 以下のいずれかのエラーが発生した場合：
  1. **ネットワークエラー**（オフライン、接続エラーなど）
  2. **タイムアウトエラー**（30秒以内にレスポンスがない）
  3. **HTTPレスポンスエラー**（400, 401, 403, 404, 500, 502, 503, 504など）
  4. **その他のエラー**（予期しないエラー）

---

## 3. エラーの種類と分類

### 3.1 エラーハンドリングの流れ

```
facilityApi.getFacility()
  ↓
apiClient.get() (axios)
  ↓
レスポンスインターセプター (axios.ts)
  ↓
エラーの種類に応じて処理
  ↓
Chat.vue / Welcome.vue の catch ブロック
  ↓
「施設情報の取得に失敗しました」と表示
```

### 3.2 エラーの種類と処理（`frontend/src/api/axios.ts`）

#### 3.2.1 HTTPレスポンスエラー（`error.response`が存在する場合）

**処理**: `handleApiError(error)`で処理

**エラーの種類**:
- **400 Bad Request**: `BAD_REQUEST`コード、「リクエストが不正です。入力内容を確認してください。」
- **401 Unauthorized**: `UNAUTHORIZED`コード、「認証が必要です。ログインしてください。」（ログアウト処理も実行）
- **403 Forbidden**: `FORBIDDEN`コード、「この操作を実行する権限がありません。」（ログアウト処理も実行）
- **404 Not Found**: `NOT_FOUND`コード、「リソースが見つかりません。」
- **429 Too Many Requests**: `RATE_LIMIT`コード、「リクエストが多すぎます。しばらく時間をおいてから再度お試しください。」
- **500 Internal Server Error**: `SERVER_ERROR`コード、「サーバーでエラーが発生しました。しばらく時間をおいてから再度お試しください。」
- **502 Bad Gateway**: `SERVICE_UNAVAILABLE`コード、「サービスが一時的に利用できません。しばらく時間をおいてから再度お試しください。」
- **503 Service Unavailable**: `SERVICE_UNAVAILABLE`コード、「サービスが一時的に利用できません。しばらく時間をおいてから再度お試しください。」
- **504 Gateway Timeout**: `TIMEOUT_ERROR`コード、「リクエストがタイムアウトしました。再度お試しください。」

#### 3.2.2 ネットワークエラー（`error.request`が存在する場合）

**処理**: ネットワークエラーとして処理

**エラーの種類**:
1. **タイムアウトエラー**:
   - 条件: `error.code === 'ECONNABORTED'` または `error.message?.includes('timeout')`
   - コード: `TIMEOUT_ERROR`
   - メッセージ: 「リクエストがタイムアウトしました。接続を確認して再度お試しください。」

2. **その他のネットワークエラー**:
   - 条件: `error.request`が存在し、タイムアウトエラーではない
   - コード: `NETWORK_ERROR`
   - メッセージ: 「ネットワークエラーが発生しました。接続を確認してください。」
   - **注意**: オフライン時もこのエラーが発生する可能性が高い

#### 3.2.3 その他のエラー

**処理**: `handleApiError(error)`で処理

**エラーの種類**:
- **その他のエラー**: `UNKNOWN_ERROR`コード、「エラーが発生しました。しばらく時間をおいてから再度お試しください。」

### 3.3 エラーコードの構造

**`AppError`インターフェース**（`frontend/src/utils/errorHandler.ts`）:
```typescript
export interface AppError {
  code: string
  message: string
  details?: Record<string, any>
}
```

**エラーコードの例**:
- `NETWORK_ERROR`: ネットワークエラー（オフライン含む）
- `TIMEOUT_ERROR`: タイムアウトエラー
- `SERVER_ERROR`: サーバーエラー
- `NOT_FOUND`: リソースが見つからない
- `UNKNOWN_ERROR`: その他のエラー

---

## 4. 現在のエラーハンドリングの問題点

### 4.1 問題点1: エラーの種類を区別していない

**現在の実装**（`Chat.vue`の199-202行目）:
```typescript
catch (err) {
  console.error('[Chat.vue] onMounted: 施設情報取得エラー', err)
  error.value = '施設情報の取得に失敗しました'  // ← すべて同じメッセージ
  return
}
```

**問題**:
- エラーの種類（オフライン、ネットワークエラー、サーバーエラーなど）を区別していない
- すべて「施設情報の取得に失敗しました」と表示される
- オフライン時も同じメッセージが表示される

### 4.2 問題点2: オフライン検出が実装されていない

**確認結果**: ❌ **オフライン検出が実装されていない**

**確認内容**:
- `navigator.onLine`の使用: ❌ 使用されていない
- `useOffline.ts`コンポーザブル: ❌ 存在しない
- `online`/`offline`イベントのリッスン: ❌ 実装されていない
- オフライン時の専用メッセージ: ❌ 実装されていない

### 4.3 問題点3: エラーコードを活用していない

**現在の実装**:
- `axios.ts`で`NETWORK_ERROR`コードを返しているが、`Chat.vue`では`err.message`を使用している
- エラーコード（`err.code`）を確認していない

**改善の余地**:
- エラーコード（`err.code`）を確認して、エラーの種類に応じたメッセージを表示する
- オフライン検出（`navigator.onLine`）と組み合わせて、より正確なエラーメッセージを表示する

---

## 5. オフライン時のエラー発生メカニズム

### 5.1 オフライン時のエラー発生フロー

```
1. ユーザーがオフライン状態
   ↓
2. facilityApi.getFacility() を呼び出す
   ↓
3. apiClient.get() (axios) がリクエストを送信
   ↓
4. ネットワーク接続がないため、リクエストが失敗
   ↓
5. axios が error.request を持つエラーを返す
   ↓
6. axios.ts のレスポンスインターセプターで処理
   ↓
7. NETWORK_ERROR コードを返す
   ↓
8. Chat.vue の catch ブロックでキャッチ
   ↓
9. 「施設情報の取得に失敗しました」と表示（問題）
```

### 5.2 オフライン検出の必要性

**`navigator.onLine`の使用**:
- `navigator.onLine`は、ブラウザがネットワーク接続を持っているかどうかを示す
- `true`: オンライン、`false`: オフライン
- **注意**: `navigator.onLine`は完全に正確ではない場合がある（WiFi接続があるがインターネット接続がない場合など）

**`online`/`offline`イベント**:
- `window.addEventListener('online', handler)`: オンラインになったときに発火
- `window.addEventListener('offline', handler)`: オフラインになったときに発火
- リアルタイムでネットワーク状態の変化を検出できる

### 5.3 オフライン検出とネットワークエラーの組み合わせ

**推奨アプローチ**:
1. **`navigator.onLine`でオフライン状態を検出**
2. **`NETWORK_ERROR`コードを確認**
3. **両方が一致する場合、オフライン専用メッセージを表示**

**理由**:
- `navigator.onLine`だけでは不十分な場合がある（WiFi接続があるがインターネット接続がない場合など）
- `NETWORK_ERROR`コードだけでは、オフラインとその他のネットワークエラーを区別できない
- 両方を組み合わせることで、より正確なオフライン検出が可能

---

## 6. エラーの種類別の表示メッセージ（推奨）

### 6.1 オフライン時

**条件**:
- `navigator.onLine === false` または `NETWORK_ERROR`コード

**表示メッセージ**:
```
現在オフラインです / Currently Offline

インターネット接続を確認してください / Please check your internet connection

オフライン時は、AI回答が生成できません / AI responses cannot be generated while offline
```

### 6.2 ネットワークエラー（オンラインだが接続エラー）

**条件**:
- `navigator.onLine === true` かつ `NETWORK_ERROR`コード

**表示メッセージ**:
```
ネットワークエラーが発生しました / Network Error

接続を確認して再度お試しください / Please check your connection and try again
```

### 6.3 タイムアウトエラー

**条件**:
- `TIMEOUT_ERROR`コード

**表示メッセージ**:
```
リクエストがタイムアウトしました / Request Timeout

接続を確認して再度お試しください / Please check your connection and try again
```

### 6.4 サーバーエラー

**条件**:
- `SERVER_ERROR`、`SERVICE_UNAVAILABLE`コード

**表示メッセージ**:
```
サーバーでエラーが発生しました / Server Error

しばらく時間をおいてから再度お試しください / Please try again later
```

### 6.5 その他のエラー

**条件**:
- 上記以外のエラー

**表示メッセージ**:
```
施設情報の取得に失敗しました / Failed to fetch facility information

しばらく時間をおいてから再度お試しください / Please try again later
```

---

## 7. 実装が必要な機能

### 7.1 オフライン検出の実装

**必要な実装**:
1. **`frontend/src/composables/useOffline.ts`の作成**:
   - `navigator.onLine`でオフライン状態を検出
   - `online`/`offline`イベントをリッスン
   - リアクティブな`isOffline`を返す

2. **`Chat.vue`での使用**:
   - `useOffline`をインポート
   - `isOffline`を監視
   - オフライン時に専用メッセージを表示

### 7.2 エラーハンドリングの改善

**必要な実装**:
1. **エラーコードの確認**:
   - `err.code`を確認して、エラーの種類を判定
   - `NETWORK_ERROR`、`TIMEOUT_ERROR`、`SERVER_ERROR`などを区別

2. **オフライン検出との組み合わせ**:
   - `navigator.onLine`と`NETWORK_ERROR`コードを組み合わせて、オフラインを判定
   - オフライン時は専用メッセージを表示

3. **多言語対応**:
   - エラーメッセージを多言語対応（日本語・英語）

### 7.3 エラーメッセージの改善

**必要な実装**:
1. **オフライン時の専用メッセージ**:
   - 「現在オフラインです」
   - 「インターネット接続を確認してください」
   - 「オフライン時は、AI回答が生成できません」

2. **エラーの種類に応じたメッセージ**:
   - オフライン、ネットワークエラー、タイムアウト、サーバーエラーなど、エラーの種類に応じたメッセージを表示

---

## 8. 調査結果のまとめ

### 8.1 「施設情報の取得に失敗しました」が表示される条件

**条件**:
- `facilityApi.getFacility(slug, location.value)`がエラーをthrowした場合
- 以下のいずれかのエラーが発生した場合：
  1. **ネットワークエラー**（オフライン、接続エラーなど）→ `NETWORK_ERROR`コード
  2. **タイムアウトエラー**（30秒以内にレスポンスがない）→ `TIMEOUT_ERROR`コード
  3. **HTTPレスポンスエラー**（400, 401, 403, 404, 500, 502, 503, 504など）→ 各エラーコード
  4. **その他のエラー**（予期しないエラー）→ `UNKNOWN_ERROR`コード

**表示箇所**:
- `frontend/src/views/guest/Chat.vue`（199-202行目）
- `frontend/src/views/guest/Welcome.vue`（83-88行目）

### 8.2 現在の問題点

1. **エラーの種類を区別していない**: すべて「施設情報の取得に失敗しました」と表示される
2. **オフライン検出が実装されていない**: `navigator.onLine`を使用していない
3. **エラーコードを活用していない**: `err.code`を確認していない

### 8.3 必要な実装

1. **オフライン検出の実装**:
   - `useOffline.ts`コンポーザブルの作成
   - `navigator.onLine`と`online`/`offline`イベントの使用

2. **エラーハンドリングの改善**:
   - エラーコード（`err.code`）の確認
   - オフライン検出との組み合わせ
   - エラーの種類に応じたメッセージの表示

3. **エラーメッセージの改善**:
   - オフライン時の専用メッセージ
   - エラーの種類に応じたメッセージ
   - 多言語対応

---

## 9. 推奨実装方針

### 9.1 実装の優先順位

1. **最優先**: オフライン検出の実装
   - `useOffline.ts`の作成
   - `Chat.vue`での使用

2. **高優先度**: エラーハンドリングの改善
   - エラーコードの確認
   - オフライン検出との組み合わせ

3. **中優先度**: エラーメッセージの改善
   - オフライン時の専用メッセージ
   - エラーの種類に応じたメッセージ
   - 多言語対応

### 9.2 実装の注意事項

1. **大原則の遵守**:
   - 根本解決 > 暫定解決
   - シンプル構造 > 複雑構造
   - 具体的 > 一般
   - 拙速 < 安全確実

2. **Docker環境でのテスト**:
   - すべての修正・テストはDocker環境で実行する
   - ローカル環境で直接実行しない

3. **指示があるまで修正しない**:
   - 調査分析と計画立案のみ
   - 修正は指示があるまで実施しない

---

**完全調査分析完了日時**: 2025年12月18日  
**状態**: 📋 **完全調査分析完了**

**重要**: 指示があるまで修正を実施しません。調査分析のみです。
