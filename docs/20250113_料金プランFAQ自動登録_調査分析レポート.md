# 料金プランとFAQ自動登録機能 調査分析レポート

**作成日時**: 2025年1月13日  
**目的**: Freeプランの新規登録時のFAQ自動登録が仕様通り（日本語限定・20件のみ）になっているか調査分析

---

## 1. 要約定義書・アーキテクチャ設計書・引き継ぎ書の確認

### 1.1 大原則の確認

要約定義書（v0.3.9）より、以下の大原則を確認：

1. **根本解決 > 暫定解決**
   - 一時的な回避策ではなく、根本原因を解決する
   - パッチワーク的な修正を避け、設計レベルでの解決を優先

2. **シンプル構造 > 複雑構造**
   - 過度に複雑な実装を避け、理解しやすく保守しやすい構造を選択
   - 不要な抽象化や過剰な設計を避ける

3. **統一・同一化 > 特殊独自**
   - 既存のパターンや規約に従い、統一された実装を優先
   - 特殊な実装や独自の方法を避け、標準的なアプローチを採用

4. **具体的 > 一般**
   - 抽象的な説明ではなく、具体的な実装方法や手順を明確にする
   - 曖昧な表現を避け、実行可能な具体的な内容を記載

5. **拙速 < 安全確実**
   - 速度よりも安全性と確実性を優先
   - テストを省略せず、十分な検証を行ってから本番環境に反映

6. **Docker環境必須 > ローカル直接実行**
   - **Dockerを使わない修正もテストも意味がない**
   - すべての修正・テストはDocker環境（docker-compose）で実行する
   - ローカル環境で直接実行した修正やテストは無効であり、再実施が必要

**重大指示違反**: なし（大原則は遵守されている）

**注意**: 今回発見された問題は、大原則に違反しているわけではなく、料金プラン制限の実装が不足していることが原因です。

### 1.2 料金プランの定義（要約定義書 v0.3.9より）

| プラン | 同時利用言語数 | 想定 | 価格 | FAQ登録数 | 規模目安 |
|--------|---------------|------|------|-----------|----------|
| **Free** | **1言語** | **国内・日本語のみ※選択不可**（30質問限定）超過後はFAQ対応のみ | 無料 | **20件** | 〜25床 |
| Mini | 2言語 | 日本語＋英語 | ¥1,980/月 + ¥30/質問（最初から従量課金） | 30件 | 〜25床 |
| Small | 3言語 | 日・英・中（繁体字中国語） | ¥3,980/月、200件/月まで（超過分は+ ¥30/質問） | 50件 | 〜25床 |
| Standard | 4言語 | 日・英・中（繁体字中国語）・仏 | ¥5,980/月、500件/月まで（超過分は+ ¥30/質問） | 100件 | 26-50床 |
| Premium | 無制限 | - | ¥7,980/月、1,000件/月まで（超過分は+ ¥30/質問） | 無制限 | 51床以上 |

**重要な仕様**:
- Freeプランは**日本語のみ**（選択不可）
- FreeプランのFAQ登録数は**20件**（インテント単位）
- 新規登録時に**30件のFAQが自動登録**される設定になっているはず

### 1.3 FAQ登録数カウント方法（要約定義書 v0.3.9より）

- FAQ登録数は「意味（インテント）」単位で1件としてカウント
- 多言語対応してもFAQ登録数が増えない設計（「今何時ですか？」と「what time is it now?」は1件としてカウント）
- データベーススキーマ: `faqs`テーブルと`faq_translations`テーブルに分離済み

---

## 2. 現在の実装状況

### 2.1 新規登録時のFAQ自動登録処理

**ファイル**: `backend/app/services/auth_service.py`

```227:253:backend/app/services/auth_service.py
        # FAQ自動投入
        try:
            # プリセットFAQをFAQRequestに変換
            faq_requests = []
            for preset in FAQ_PRESETS:
                faq_request = FAQRequest(
                    category=preset["category"],
                    intent_key=preset["intent_key"],
                    translations=[
                        {
                            "language": t["language"],
                            "question": t["question"],
                            "answer": t["answer"]
                        } for t in preset["translations"]
                    ],
                    priority=preset["priority"],
                    is_active=True
                )
                faq_requests.append(faq_request)
            
            await FAQService(db).bulk_create_faqs(facility.id, faq_requests, user.id)
        except Exception as e:
            # FAQ投入失敗時はロールバック
            raise HTTPException(
                status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
                detail=f"Failed to create FAQs: {str(e)}"
            )
```

**問題点**:
1. **料金プランを考慮していない**: `request.subscription_plan`を参照せず、全プランで同じ処理を実行
2. **FAQ件数制限がない**: `FAQ_PRESETS`の全件（30件）を登録している
3. **言語フィルタがない**: Freeプランでも日本語と英語の両方が登録される

### 2.2 FAQプリセットデータ

**ファイル**: `backend/app/data/faq_presets.py`

- **総件数**: 30件のFAQが定義されている
- **各FAQの翻訳**: 日本語（ja）と英語（en）の2言語が含まれている
- **カテゴリ内訳**:
  - basic: 8件
  - facilities: 10件（8件 + 2件追加）
  - location: 6件
  - trouble: 6件

### 2.3 料金プラン制限の実装状況

**調査結果**: 
- 料金プランに基づくFAQ登録数制限の実装は**存在しない**
- Freeプランで日本語のみに制限する処理も**存在しない**
- `faq_service.py`の`bulk_create_faqs`メソッドにも制限チェックがない

---

## 3. 問題点の詳細分析

### 3.1 FreeプランのFAQ登録数超過問題

**現状**:
- FreeプランはFAQ登録数が**20件**のはず
- しかし、新規登録時に**30件**のFAQが登録されている
- **10件超過**している

**影響**:
- 料金プランの制限を超えたFAQが登録される
- 仕様違反により、Freeプラン利用者が制限を超えたサービスを受けている

### 3.2 Freeプランの言語制限違反問題

**現状**:
- Freeプランは**日本語のみ**（選択不可）のはず
- しかし、新規登録時に**日本語と英語の両方**が登録されている
- 英語の翻訳が不要にもかかわらず登録されている

**影響**:
- Freeプラン利用者が英語対応のFAQを利用できてしまう
- 仕様違反により、Freeプラン利用者が制限を超えたサービスを受けている

### 3.3 料金プラン別の制限実装不足

**現状**:
- 料金プランに基づく制限チェックが実装されていない
- `auth_service.py`の`register_facility`メソッドで、プランに関係なく全件登録している

**必要な実装**:
1. Freeプラン: 日本語のみ、20件まで
2. Miniプラン: 日本語＋英語、30件まで
3. Smallプラン: 日本語＋英語＋中国語、50件まで
4. Standardプラン: 日本語＋英語＋中国語＋フランス語、100件まで
5. Premiumプラン: 無制限

---

## 4. 修正が必要な箇所

### 4.1 `backend/app/services/auth_service.py`

**修正内容**:
- `register_facility`メソッドで、料金プランに基づいてFAQ登録数を制限
- Freeプランの場合は日本語のみの翻訳をフィルタ
- プラン別のFAQ登録数上限を適用

### 4.2 料金プラン制限の定義

**新規作成が必要**:
- 料金プラン別のFAQ登録数上限を定義する定数または設定ファイル
- 料金プラン別の対応言語リストを定義する定数または設定ファイル

---

## 5. 結論

### 5.1 調査結果サマリー

| 項目 | 仕様 | 現状 | 問題 |
|------|------|------|------|
| FreeプランのFAQ登録数 | 20件 | 30件 | **10件超過** |
| Freeプランの言語 | 日本語のみ | 日本語＋英語 | **英語が不要** |
| 料金プラン制限の実装 | 必要 | なし | **実装不足** |

### 5.2 重大な問題

1. **FreeプランのFAQ登録数超過**: 仕様では20件のはずが、30件登録されている（10件超過）
2. **Freeプランの言語制限違反**: 仕様では日本語のみのはずが、英語も登録されている
3. **料金プラン制限の実装不足**: 料金プランに基づく制限チェックが実装されていない

### 5.3 修正の優先度

**優先度: 高**
- 料金プランの制限が正しく機能していない
- Freeプラン利用者が制限を超えたサービスを受けている
- 仕様違反により、料金体系が正しく機能していない

---

## 6. 推奨される修正方針

### 6.1 修正ステップ

1. **料金プラン制限の定義ファイル作成**
   - プラン別のFAQ登録数上限を定義
   - プラン別の対応言語リストを定義

2. **`auth_service.py`の修正**
   - `register_facility`メソッドで料金プランを確認
   - FAQ登録数をプラン別上限に制限
   - Freeプランの場合は日本語のみの翻訳をフィルタ

3. **テスト**
   - Freeプランで新規登録し、20件の日本語のみのFAQが登録されることを確認
   - 他のプランでも正しい件数・言語で登録されることを確認

### 6.2 実装例（参考）

```python
# 料金プラン制限の定義
PLAN_FAQ_LIMITS = {
    "free": {"max_faqs": 20, "languages": ["ja"]},
    "mini": {"max_faqs": 30, "languages": ["ja", "en"]},
    "small": {"max_faqs": 50, "languages": ["ja", "en", "zh-TW"]},
    "standard": {"max_faqs": 100, "languages": ["ja", "en", "zh-TW", "fr"]},
    "premium": {"max_faqs": None, "languages": None}  # 無制限
}

# register_facilityメソッド内で
plan_limits = PLAN_FAQ_LIMITS.get(request.subscription_plan, PLAN_FAQ_LIMITS["small"])
allowed_languages = plan_limits["languages"]
max_faqs = plan_limits["max_faqs"]

# FAQプリセットをフィルタ
filtered_presets = FAQ_PRESETS[:max_faqs] if max_faqs else FAQ_PRESETS
faq_requests = []
for preset in filtered_presets:
    # 言語フィルタ
    filtered_translations = [
        t for t in preset["translations"] 
        if t["language"] in allowed_languages
    ] if allowed_languages else preset["translations"]
    
    if filtered_translations:  # フィルタ後も翻訳が残っている場合のみ
        faq_request = FAQRequest(...)
        faq_requests.append(faq_request)
```

---

**状態**: 🔴 **重大な問題発見 - 修正が必要**

