# Phase 1・Phase 2: CORSエラー 原因分析・説明・評価

**作成日時**: 2025年12月19日 10時05分15秒  
**実施者**: AI Assistant  
**目的**: CORSエラーの原因分析と説明・評価  
**状態**: 📋 **分析完了・説明・評価完了**

**重要**: 指示があるまで修正を実施しません。分析と説明のみです。

---

## 1. 問題の詳細

### 1.1 ユーザーが報告した問題

**問題**: CORSエラーが発生している

**発生状況**:
- ネットワークを「スロットリングなし」に設定（オンライン状態）
- ページをリロード
- 上記を何回か実行しても、同じエラーが発生

**ブラウザに表示**:
- 「施設情報の取得に失敗しました」

**コンソールエラー**:
```
Access to XMLHttpRequest at 'http://localhost:8000/api/v1/facility/test-facility' from origin 'http://localhost:4173' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.
```

**エラーコード**:
```
{code: 'NETWORK_ERROR', message: 'ネットワークエラーが発生しました。接続を確認してください。', details: {…}}
```

**ネットワークタブ**:
- `test-facility` が `CORS エラー` と表示されている
- ステータス: `CORS エラー`
- サイズ: `0.0 KB`
- 時間: `31 ms`

### 1.2 重要な発見

**問題点**:
- プレビューサーバー（`localhost:4173`）からバックエンドAPI（`localhost:8000`）へのリクエストがCORSポリシーによってブロックされている
- バックエンドのCORS設定に `http://localhost:4173` が含まれていない可能性がある

---

## 2. 原因分析

### 2.1 直接原因

**原因**: **CORS設定の不備**

**詳細**:
- プレビューサーバーは `localhost:4173` で動作している
- バックエンドAPIは `localhost:8000` で動作している
- バックエンドのCORS設定に `http://localhost:4173` が含まれていない
- そのため、ブラウザがCORSポリシーによってリクエストをブロックしている

### 2.2 根本原因

**根本原因**: **プレビューサーバー用のCORS設定が追加されていない**

**確認が必要な項目**:
- `docker-compose.yml`の`CORS_ORIGINS`環境変数に `http://localhost:4173` が含まれているか
- バックエンドのCORS設定が正しく反映されているか

### 2.3 確認した内容

**`docker-compose.yml`の確認**:
```yaml
environment:
  - CORS_ORIGINS=http://localhost:5173,http://localhost:3000
```

**問題点**:
- `CORS_ORIGINS`に `http://localhost:4173` が含まれていない
- 開発サーバー（`localhost:5173`）とステージング環境（`localhost:3000`）のみが許可されている
- プレビューサーバー（`localhost:4173`）が許可されていない

---

## 3. 説明・評価

### 3.1 問題の説明

**問題**: CORSエラーが発生している

**状況**:
- プレビューサーバー（`localhost:4173`）からバックエンドAPI（`localhost:8000`）へのリクエストがCORSポリシーによってブロックされている
- バックエンドのCORS設定に `http://localhost:4173` が含まれていない

**CORS（Cross-Origin Resource Sharing）とは**:
- ブラウザのセキュリティ機能の一つ
- 異なるオリジン（プロトコル、ドメイン、ポート）間でのリソース共有を制御する
- サーバー側で明示的に許可する必要がある

**今回のケース**:
- **オリジン**: `http://localhost:4173`（プレビューサーバー）
- **リクエスト先**: `http://localhost:8000`（バックエンドAPI）
- **問題**: バックエンドのCORS設定に `http://localhost:4173` が含まれていない

### 3.2 評価

**評価**: ⚠️ **設定不備による問題**

**理由**:
1. **CORS設定の不備**: ❌ **問題が確認された**
   - `docker-compose.yml`の`CORS_ORIGINS`に `http://localhost:4173` が含まれていない
   - プレビューサーバーからバックエンドAPIへのリクエストがブロックされている

2. **エラーハンドリング**: ✅ **正常に動作**
   - CORSエラーが正しく検出されている
   - `NETWORK_ERROR`コードが設定されている
   - エラーメッセージが表示されている

3. **Service Worker**: ✅ **正常に動作**
   - Service Workerは正常に登録されている
   - 静的リソースのキャッシュは正常に動作している

**結論**: 
- 問題の根本原因は、CORS設定の不備である
- `docker-compose.yml`の`CORS_ORIGINS`に `http://localhost:4173` を追加する必要がある

---

## 4. 解決方法

### 4.1 修正内容

**修正箇所**: `docker-compose.yml`

**修正前**:
```yaml
environment:
  - CORS_ORIGINS=http://localhost:5173,http://localhost:3000
```

**修正後**:
```yaml
environment:
  - CORS_ORIGINS=http://localhost:5173,http://localhost:3000,http://localhost:4173
```

**理由**:
- プレビューサーバー（`localhost:4173`）からバックエンドAPIへのリクエストを許可するため
- 開発サーバー（`localhost:5173`）とステージング環境（`localhost:3000`）に加えて、プレビューサーバーも許可する

### 4.2 修正後の確認手順

**手順1: Dockerコンテナの再起動**
```bash
docker-compose up -d backend
```

**手順2: プレビューサーバーで確認**
1. ブラウザで`http://localhost:4173/f/test-facility?location=entrance`にアクセス
2. 言語を選択してチャット画面に移動
3. 施設情報が正常に取得されることを確認

**期待される結果**:
- CORSエラーが発生しない
- 施設情報が正常に取得される
- 「施設情報の取得に失敗しました」が表示されない

---

## 5. 以前の問題との関連

### 5.1 以前の問題

**問題**: オンライン復帰後、施設情報の取得に失敗している

**原因の可能性**:
1. オフライン時に施設情報がキャッシュされていない
2. エラーハンドリングの不備
3. Service Workerのキャッシュ戦略の動作確認不足

### 5.2 今回の問題との関連

**関連性**:
- 今回の問題は、CORS設定の不備によるものである
- 以前の問題（オンライン復帰後の施設情報取得失敗）も、CORSエラーが原因の可能性がある
- CORSエラーが解決されれば、施設情報の取得が正常に動作する可能性が高い

**重要性**:
- CORS設定の修正は、プレビューサーバーでの動作確認に必要である
- 本番環境（ステージング環境）でも、CORS設定が正しく設定されていることを確認する必要がある

---

## 6. まとめ

### 6.1 問題の原因

**直接原因**: **CORS設定の不備**
- `docker-compose.yml`の`CORS_ORIGINS`に `http://localhost:4173` が含まれていない
- プレビューサーバーからバックエンドAPIへのリクエストがブロックされている

**根本原因**: **プレビューサーバー用のCORS設定が追加されていない**
- 開発サーバー（`localhost:5173`）とステージング環境（`localhost:3000`）のみが許可されている
- プレビューサーバー（`localhost:4173`）が許可されていない

### 6.2 評価

**評価**: ⚠️ **設定不備による問題**

**理由**:
- CORS設定の不備が確認された
- エラーハンドリングは正常に動作している
- Service Workerは正常に動作している

### 6.3 解決方法

**修正内容**:
- `docker-compose.yml`の`CORS_ORIGINS`に `http://localhost:4173` を追加する
- Dockerコンテナ（バックエンド）を再起動する

**期待される効果**:
- CORSエラーが解決される
- 施設情報が正常に取得される
- プレビューサーバーでの動作確認が可能になる

### 6.4 次のステップ

**推奨される対応**:
1. **CORS設定の修正**
   - `docker-compose.yml`の`CORS_ORIGINS`に `http://localhost:4173` を追加
   - Dockerコンテナ（バックエンド）を再起動

2. **動作確認**
   - プレビューサーバーで施設情報の取得を確認
   - CORSエラーが発生しないことを確認

3. **本番環境の確認**
   - ステージング環境でもCORS設定が正しく設定されていることを確認

---

**分析完了日時**: 2025年12月19日 10時05分15秒  
**状態**: 📋 **分析完了・説明・評価完了**

**重要**: 指示があるまで修正を実施しません。分析と説明のみです。

