# ゲスト側の言語選択画面でプランに応じた言語フィルタリング実装 - 調査分析・修正ステップ計画

**作成日時**: 2026年01月17日  
**目的**: ゲスト側の言語選択画面でプランに応じた言語フィルタリングを実装するための調査分析と修正ステップ計画  
**状態**: 📋 **調査分析完了・修正ステップ計画立案完了（修正は指示があるまで実施しない）**

---

## 1. 現状把握

### 1.1 問題点

**残存課題**: ゲスト側の言語選択画面でプランに応じた言語フィルタリング未実装

**問題の詳細**:
- ゲスト側の言語選択画面（`LanguageSelect.vue`）で、施設のプランに応じた言語フィルタリングが未実装
- 現在は`SUPPORTED_LANGUAGES`（英語のみ）を表示しているが、実際の施設のプランに応じた言語を表示すべき
- プランによって利用可能な言語数が異なる（Free: 1言語、Mini: 2言語、Small: 3言語、Standard: 4言語、Premium: 無制限）

**影響範囲**:
- `frontend/src/views/guest/LanguageSelect.vue`
- ゲストが選択できる言語がプラン制限と一致しない可能性
- プラン制限の整合性を保つため重要

**優先度**: 中（プラン制限の整合性を保つため重要）

---

## 2. コードベース調査結果

### 2.1 現状の実装状況

#### 2.1.1 フロントエンド

**`frontend/src/views/guest/LanguageSelect.vue`**:
- `SUPPORTED_LANGUAGES`（英語のみ）を表示
- 施設情報を取得する処理はコメントアウトされている（TODO: Week 4で実装）
- `onMounted`で施設情報取得処理があるが、実装されていない

**`frontend/src/utils/constants.ts`**:
- `SUPPORTED_LANGUAGES`は英語のみ定義されている
- MVPでは英語のみ、Phase 2で追加予定とコメントされている

**`frontend/src/components/guest/LanguageCard.vue`**:
- `SUPPORTED_LANGUAGES`の型を使用しているが、表示ロジックには影響なし

#### 2.1.2 バックエンド

**`backend/app/core/plan_limits.py`**:
- 各プランの対応言語リストが定義されている:
  - Free: `["ja"]`（日本語のみ）
  - Mini: `["ja", "en"]`（日本語＋英語）
  - Small: `["ja", "en", "zh-TW"]`（日本語＋英語＋中国語）
  - Standard: `["ja", "en", "zh-TW", "fr"]`（日本語＋英語＋中国語＋フランス語）
  - Premium: `None`（無制限、全言語対応）
- `get_plan_limits(plan: str)`関数でプラン制限を取得可能

**`backend/app/api/v1/facility.py`**:
- `/facility/{slug}`エンドポイントで施設情報を取得
- 現在は`plan_type`を返していない
- `FacilityPublicResponse`スキーマに`plan_type`が含まれていない

**`backend/app/services/facility_service.py`**:
- `get_facility_public_info`メソッドで施設情報を取得
- `Facility`モデルには`plan_type`フィールドが存在するが、レスポンスに含まれていない

**`backend/app/models/facility.py`**:
- `plan_type`フィールドが存在（`Column(String(20), default='Free', nullable=False)`）
- 値: `'Free'`, `'Mini'`, `'Small'`, `'Standard'`, `'Premium'`

**`backend/app/schemas/facility.py`**:
- `FacilityPublicResponse`スキーマに`plan_type`が含まれていない
- `FacilityResponse`（管理側用）には`subscription_plan`が含まれているが、`plan_type`ではない

### 2.2 関連機能への影響調査

#### 2.2.1 `SUPPORTED_LANGUAGES`の使用箇所

**使用箇所**:
1. `frontend/src/views/guest/LanguageSelect.vue`（3箇所）
   - インポート
   - `supportedLanguages`の初期値
   - `selectedLanguage`の型定義
   - `handleLanguageSelect`の引数の型

2. `frontend/src/components/guest/LanguageCard.vue`（2箇所）
   - インポート
   - `Language`型の定義

**影響範囲**: 限定的（`LanguageSelect.vue`と`LanguageCard.vue`のみ）

#### 2.2.2 ゲスト側の画面遷移フロー

```
/f/:facilityId (LanguageSelect)
  ↓ 言語選択
/f/:facilityId/welcome (Welcome)
  ↓ メッセージ送信
/f/:facilityId/chat (Chat)
```

**影響**: `LanguageSelect.vue`の修正は、`Welcome.vue`や`Chat.vue`には影響しない（言語選択後に使用されるため）

#### 2.2.3 施設情報取得APIの使用箇所

**使用箇所**:
1. `frontend/src/views/guest/Welcome.vue`
   - `facilityApi.getFacility(slug, location)`で施設情報を取得
   - 取得した情報を`facilityStore`に保存

2. `frontend/src/views/guest/Chat.vue`
   - 施設情報が取得されていない場合、`facilityApi.getFacility(slug, location)`で取得

**影響**: 既存の使用箇所には影響しない（`plan_type`を追加しても既存の処理には影響なし）

---

## 3. 修正方針

### 3.1 アプローチ

**方針**: 既存の施設情報取得APIを拡張し、プランに応じた利用可能言語を取得する

**理由**:
1. 既存のAPIを拡張することで、新規エンドポイントを追加する必要がない
2. 施設情報と一緒に利用可能言語を取得できるため、API呼び出し回数を削減できる
3. 既存のコードへの影響を最小限に抑えられる

### 3.2 実装ステップ

#### ステップ1: Backend - 施設情報取得APIの拡張

**目的**: 施設情報取得APIに`plan_type`と`available_languages`を追加

**修正内容**:
1. `FacilityPublicResponse`スキーマに`plan_type`と`available_languages`を追加
2. `FacilityService.get_facility_public_info`メソッドで`plan_type`と`available_languages`を取得
3. `get_facility`エンドポイントで`plan_type`と`available_languages`を返す

**修正ファイル**:
- `backend/app/schemas/facility.py`
- `backend/app/services/facility_service.py`
- `backend/app/api/v1/facility.py`

#### ステップ2: Frontend - 型定義の更新

**目的**: 施設情報の型定義に`plan_type`と`available_languages`を追加

**修正内容**:
1. `FacilityPublicResponse`型に`plan_type`と`available_languages`を追加

**修正ファイル**:
- `frontend/src/types/facility.ts`

#### ステップ3: Frontend - 言語選択画面の修正

**目的**: プランに応じた言語を表示するように修正

**修正内容**:
1. `LanguageSelect.vue`で施設情報を取得
2. 取得した`available_languages`を使用して言語リストをフィルタリング
3. `SUPPORTED_LANGUAGES`から、プランで利用可能な言語のみを表示

**修正ファイル**:
- `frontend/src/views/guest/LanguageSelect.vue`

#### ステップ4: テスト実装

**目的**: プラン別の言語表示をテスト

**テスト内容**:
1. 各プラン（Free、Mini、Small、Standard、Premium）での言語表示テスト
2. 施設情報取得APIのレスポンス確認
3. 言語選択時の動作確認

**テストファイル**:
- `backend/tests/test_facility_available_languages.py`（新規作成）
- `frontend/src/__tests__/LanguageSelect.spec.ts`（新規作成、必要に応じて）

#### ステップ5: ブラウザテスト

**目的**: 実際のブラウザで動作確認

**テスト内容**:
1. 各プランでの言語表示確認
2. 言語選択時の動作確認
3. エラーハンドリング確認

---

## 4. 詳細実装計画

### 4.1 ステップ1: Backend - 施設情報取得APIの拡張

#### 4.1.1 `FacilityPublicResponse`スキーマの拡張

**ファイル**: `backend/app/schemas/facility.py`

**修正内容**:
```python
class FacilityPublicResponse(BaseModel):
    """
    施設情報公開レスポンス（ゲスト側用）
    """
    id: int
    name: str
    slug: str
    email: str
    phone: Optional[str] = None
    check_in_time: Optional[str] = None  # "15:00"形式
    check_out_time: Optional[str] = None  # "11:00"形式
    wifi_ssid: Optional[str] = None
    top_questions: List[TopQuestion] = Field(default_factory=list, description="よくある質問TOP3")
    plan_type: Optional[str] = Field(None, description="料金プラン（Free, Mini, Small, Standard, Premium）")
    available_languages: List[str] = Field(default_factory=list, description="利用可能言語リスト")

    class Config:
        from_attributes = True
```

#### 4.1.2 `FacilityService.get_facility_public_info`メソッドの拡張

**ファイル**: `backend/app/services/facility_service.py`

**修正内容**:
```python
from app.core.plan_limits import get_plan_limits

# get_facility_public_infoメソッド内で、plan_typeとavailable_languagesを取得
plan_type = facility.plan_type or "Free"  # デフォルトはFree
plan_limits = get_plan_limits(plan_type.lower())
available_languages = plan_limits.get("languages", ["ja"])

# Premiumプランの場合、全言語対応
if plan_type == "Premium" or available_languages is None:
    # 全言語対応の場合、SUPPORTED_LANGUAGESの全言語を返す
    # ただし、現時点では英語のみなので、将来的な拡張を考慮
    available_languages = ["ja", "en", "zh-TW", "fr", "es", "de", "ko", "th", "vi"]

return FacilityPublicResponse(
    id=facility.id,
    name=facility.name,
    slug=facility.slug,
    email=facility.email,
    phone=facility.phone,
    check_in_time=check_in_time_str,
    check_out_time=check_out_time_str,
    wifi_ssid=facility.wifi_ssid,
    top_questions=top_questions,
    plan_type=plan_type,
    available_languages=available_languages,
)
```

**注意事項**:
- `plan_type`は大文字（`"Free"`, `"Mini"`など）で保存されているが、`get_plan_limits`は小文字（`"free"`, `"mini"`など）を期待しているため、`lower()`で変換する
- Premiumプランの場合、`available_languages`は`None`になるため、全言語対応として処理する

#### 4.1.3 `get_facility`エンドポイントの修正

**ファイル**: `backend/app/api/v1/facility.py`

**修正内容**:
```python
return {
    "facility": {
        "id": facility_info.id,
        "name": facility_info.name,
        "slug": facility_info.slug,
        "email": facility_info.email,
        "phone": facility_info.phone,
        "check_in_time": facility_info.check_in_time,
        "check_out_time": facility_info.check_out_time,
        "wifi_ssid": facility_info.wifi_ssid,
        "plan_type": facility_info.plan_type,
        "available_languages": facility_info.available_languages,
    },
    "top_questions": facility_info.top_questions,
}
```

### 4.2 ステップ2: Frontend - 型定義の更新

**ファイル**: `frontend/src/types/facility.ts`

**修正内容**:
```typescript
export interface Facility {
  id: number
  name: string
  slug: string
  email: string
  phone?: string
  check_in_time?: string
  check_out_time?: string
  wifi_ssid?: string
  plan_type?: string  // 追加
  available_languages?: string[]  // 追加
}

export interface FacilityPublicResponse {
  facility: Facility
  top_questions: TopQuestion[]
}
```

### 4.3 ステップ3: Frontend - 言語選択画面の修正

**ファイル**: `frontend/src/views/guest/LanguageSelect.vue`

**修正内容**:
```typescript
import { facilityApi } from '@/api/facility'
import { useFacilityStore } from '@/stores/facility'

const facilityStore = useFacilityStore()

// 施設情報を取得（slugまたはIDから）
onMounted(async () => {
  try {
    isLoading.value = true
    error.value = null
    
    // 施設情報を取得
    const slug = facilityId.value
    const response = await facilityApi.getFacility(slug)
    
    // 施設情報をstoreに保存
    facilityStore.setFacility(response.facility)
    
    // プランに応じた利用可能言語を取得
    const availableLanguages = response.facility.available_languages || ['en']
    
    // SUPPORTED_LANGUAGESから、利用可能な言語のみをフィルタリング
    const filteredLanguages = SUPPORTED_LANGUAGES.filter(lang => 
      availableLanguages.includes(lang.code)
    )
    
    // 利用可能な言語がない場合、デフォルトで英語を表示
    if (filteredLanguages.length === 0) {
      supportedLanguages.value = SUPPORTED_LANGUAGES
    } else {
      supportedLanguages.value = filteredLanguages
    }
  } catch (err) {
    error.value = '施設情報の取得に失敗しました'
    console.error('Facility fetch error:', err)
    // エラー時はデフォルトで英語を表示
    supportedLanguages.value = SUPPORTED_LANGUAGES
  } finally {
    isLoading.value = false
  }
})
```

**注意事項**:
- エラー時はデフォルトで英語を表示する（既存の動作を維持）
- 利用可能な言語がない場合も、デフォルトで英語を表示する

### 4.4 ステップ4: テスト実装

#### 4.4.1 Backendテスト

**ファイル**: `backend/tests/test_facility_available_languages.py`（新規作成）

**テスト内容**:
1. Freeプラン: 日本語のみが返されることを確認
2. Miniプラン: 日本語＋英語が返されることを確認
3. Smallプラン: 日本語＋英語＋中国語が返されることを確認
4. Standardプラン: 日本語＋英語＋中国語＋フランス語が返されることを確認
5. Premiumプラン: 全言語が返されることを確認
6. プランが設定されていない場合: デフォルト（Free）として処理されることを確認

#### 4.4.2 Frontendテスト（必要に応じて）

**ファイル**: `frontend/src/__tests__/LanguageSelect.spec.ts`（新規作成、必要に応じて）

**テスト内容**:
1. 各プランでの言語表示確認
2. エラー時のフォールバック動作確認

### 4.5 ステップ5: ブラウザテスト

**テスト内容**:
1. **Freeプラン**: 日本語のみが表示されることを確認
2. **Miniプラン**: 日本語＋英語が表示されることを確認
3. **Smallプラン**: 日本語＋英語＋中国語が表示されることを確認
4. **Standardプラン**: 日本語＋英語＋中国語＋フランス語が表示されることを確認
5. **Premiumプラン**: 全言語が表示されることを確認（現時点では英語のみ）
6. **エラー時**: デフォルトで英語が表示されることを確認

---

## 5. 競合・干渉の事前調査

### 5.1 既存機能への影響

#### 5.1.1 `Welcome.vue`への影響

**影響**: なし

**理由**:
- `Welcome.vue`は施設情報を取得しているが、`plan_type`や`available_languages`を使用していない
- 既存の処理には影響しない

#### 5.1.2 `Chat.vue`への影響

**影響**: なし

**理由**:
- `Chat.vue`は施設情報を取得しているが、`plan_type`や`available_languages`を使用していない
- 既存の処理には影響しない

#### 5.1.3 `LanguageCard.vue`への影響

**影響**: なし

**理由**:
- `LanguageCard.vue`は言語情報を受け取って表示するだけのコンポーネント
- 表示する言語リストが変更されても、コンポーネント自体には影響しない

### 5.2 他の機能への影響

#### 5.2.1 管理画面への影響

**影響**: なし

**理由**:
- 管理画面は`FacilitySettingsResponse`を使用しており、`FacilityPublicResponse`とは別のスキーマ
- ゲスト側のAPI変更は管理画面には影響しない

#### 5.2.2 API互換性への影響

**影響**: 最小限（後方互換性を維持）

**理由**:
- `plan_type`と`available_languages`はオプショナルフィールドとして追加
- 既存のクライアントはこれらのフィールドを無視できる
- 既存の動作を維持するため、エラー時はデフォルトで英語を表示

### 5.3 データベースへの影響

**影響**: なし

**理由**:
- データベーススキーマの変更は不要
- `plan_type`フィールドは既に存在している

---

## 6. 実装時の注意事項

### 6.1 大原則の遵守

1. **根本解決 > 暫定解決**: プランに応じた言語フィルタリングを根本的に実装する
2. **シンプル構造 > 複雑構造**: 既存のAPIを拡張するシンプルなアプローチを採用
3. **統一・同一化 > 特殊独自**: 既存のパターン（`plan_limits.py`の使用）に従う
4. **具体的 > 一般**: 具体的な実装方法を明確にする
5. **拙速 < 安全確実**: テストを省略せず、十分な検証を行う
6. **Docker環境必須**: すべての修正・テストはDocker環境で実行する

### 6.2 エラーハンドリング

1. **施設情報取得失敗時**: デフォルトで英語を表示（既存の動作を維持）
2. **利用可能言語が空の場合**: デフォルトで英語を表示
3. **プランが設定されていない場合**: デフォルト（Free）として処理

### 6.3 パフォーマンス

1. **API呼び出し回数**: 施設情報取得時に一緒に利用可能言語を取得するため、追加のAPI呼び出しは不要
2. **キャッシュ**: 施設情報は`facilityStore`に保存されるため、複数回の取得を避ける

---

## 7. 実装ステップ計画（詳細）

### ステップ1: Backend - 施設情報取得APIの拡張（1時間）

1. **`FacilityPublicResponse`スキーマの拡張**（15分）
   - `plan_type`と`available_languages`フィールドを追加

2. **`FacilityService.get_facility_public_info`メソッドの拡張**（30分）
   - `plan_type`を取得
   - `get_plan_limits`を使用して利用可能言語を取得
   - Premiumプランの場合の処理を追加

3. **`get_facility`エンドポイントの修正**（15分）
   - レスポンスに`plan_type`と`available_languages`を追加

### ステップ2: Frontend - 型定義の更新（15分）

1. **`Facility`型に`plan_type`と`available_languages`を追加**（15分）

### ステップ3: Frontend - 言語選択画面の修正（1-2時間）

1. **`LanguageSelect.vue`の修正**（1-2時間）
   - 施設情報取得処理の実装
   - プランに応じた言語フィルタリングの実装
   - エラーハンドリングの実装

### ステップ4: テスト実装（1時間）

1. **Backendテスト**（45分）
   - 各プランでの言語取得テスト
   - エラーハンドリングテスト

2. **Frontendテスト**（15分、必要に応じて）
   - 言語表示テスト

### ステップ5: ブラウザテスト（30分）

1. **各プランでの言語表示確認**（20分）
2. **エラーハンドリング確認**（10分）

**総所要時間**: 約3-4時間（0.5日）

---

## 8. 成功基準

### 8.1 機能要件

- ✅ 各プラン（Free、Mini、Small、Standard、Premium）で、プランに応じた言語が表示される
- ✅ エラー時はデフォルトで英語が表示される
- ✅ 既存の機能（Welcome、Chat）に影響しない

### 8.2 非機能要件

- ✅ APIレスポンス時間が既存と同等である
- ✅ エラーハンドリングが適切に実装されている
- ✅ ブラウザテストがすべて成功する

---

## 9. 参照文書

- `docs/Phase2_実装ステップ計画_20250114.md`: Phase 2実装ステップ計画書（課題3の記載あり）
- `backend/app/core/plan_limits.py`: 料金プラン制限定義
- `docs/20260117_FAQ登録時言語数制限バリデーション_調査分析_修正ステップ計画.md`: 関連する言語制限バリデーションの実装計画
- `docs/Phase1_Phase2_引き継ぎ書_20251214.md`: 引き継ぎ書（残存課題の記載あり）

---

## 10. まとめ

### 10.1 調査結果

- **現状**: ゲスト側の言語選択画面で、プランに応じた言語フィルタリングが未実装
- **影響範囲**: `LanguageSelect.vue`のみ（他の機能への影響なし）
- **修正方針**: 既存の施設情報取得APIを拡張し、プランに応じた利用可能言語を取得する

### 10.2 修正ステップ

1. Backend: 施設情報取得APIの拡張（`plan_type`と`available_languages`を追加）
2. Frontend: 型定義の更新
3. Frontend: 言語選択画面の修正（プランに応じた言語フィルタリング）
4. テスト実装
5. ブラウザテスト

### 10.3 所要時間

**総所要時間**: 約3-4時間（0.5日）

### 10.4 注意事項

- エラー時はデフォルトで英語を表示（既存の動作を維持）
- 既存の機能への影響を最小限に抑える
- テストを省略せず、十分な検証を行う

---

**Document Version**: v1.0  
**Author**: Auto (AI Assistant)  
**Last Updated**: 2026年01月17日  
**Status**: 📋 **調査分析完了・修正ステップ計画立案完了（修正は指示があるまで実施しない）**

