# 新規登録FAQ表示問題 - シンプル修正案

## 1. 要件の整理

### 1.1 ユーザーの要望

1. **段階的な表示はやめる**: 20件→30件のような段階的コミットは不要
2. **カテゴリ毎に均等な数を抽出して合計で20件をデフォルトにする**
3. **Freeプランだけ日本語限定**
4. **その他は日本語プラスで20件**（日本語と英語を含む20件）

### 1.2 現在のFAQプリセット構成

- **basic**: 8件
- **facilities**: 10件
- **location**: 6件
- **trouble**: 6件
- **合計**: 30件

### 1.3 新しい要件

- **初期自動登録件数**: 全プランで**20件**に統一
- **カテゴリ別抽出**: 各カテゴリから**5件ずつ**抽出（優先度順）
- **Freeプラン**: 日本語のみ
- **その他プラン**: 日本語+英語（プランに応じた言語）

## 2. 修正方針

### 2.1 シンプルな実装

1. **初期自動登録件数を全プランで20件に統一**
2. **カテゴリ毎に均等に5件ずつ抽出**（優先度順）
3. **バックグラウンド処理は20件だけ作成して一度だけコミット**
4. **フロントエンドは通常通り表示**（ポーリング不要、アナウンス不要）

### 2.2 メリット

- ✅ **シンプル**: 複雑なポーリングや段階的コミットが不要
- ✅ **分かりやすい**: 全プランで20件、カテゴリ毎に5件ずつ
- ✅ **ユーザー体験**: 不審に思われることがない
- ✅ **実装が簡単**: 既存のコードを最小限の修正で対応可能

## 3. 実装詳細

### 3.1 修正1: `plan_limits.py`の修正

**変更内容**:
1. `INITIAL_FAQ_COUNTS`を全プランで20件に統一
2. `filter_faq_presets_by_plan`を修正して、カテゴリ毎に均等に抽出

**修正後のコード**:
```python
# 初期自動登録件数の定義
# 全プランで20件に統一（カテゴリ毎に5件ずつ）
INITIAL_FAQ_COUNTS: Dict[str, int] = {
    "free": 20,      # Freeプラン: 20件（日本語のみ）
    "mini": 20,      # Miniプラン: 20件（日本語+英語）
    "small": 20,     # Smallプラン: 20件（日本語+英語+中国語）
    "standard": 20,  # Standardプラン: 20件（日本語+英語+中国語+フランス語）
    "premium": 20    # Premiumプラン: 20件（全言語）
}

def filter_faq_presets_by_plan(
    presets: List[Dict[str, Any]],
    plan: str
) -> List[Dict[str, Any]]:
    """
    料金プランに基づいてFAQプリセットをフィルタ（初期自動登録用）
    
    カテゴリ毎に均等に5件ずつ抽出して合計20件にする。
    
    Args:
        presets: FAQプリセットリスト
        plan: 料金プラン
    
    Returns:
        フィルタされたFAQプリセットリスト（20件、カテゴリ毎に5件ずつ）
    """
    # プランの制限を取得（言語フィルタ用）
    limits = get_plan_limits(plan)
    allowed_languages = limits["languages"]
    
    # カテゴリ毎に分類
    categories = ["basic", "facilities", "location", "trouble"]
    filtered_presets = []
    
    for category in categories:
        # カテゴリ毎にFAQを抽出
        category_presets = [p for p in presets if p["category"] == category]
        
        # 優先度順にソート（優先度が高い順）
        category_presets.sort(key=lambda x: x.get("priority", 1), reverse=True)
        
        # 各カテゴリから5件ずつ抽出
        selected_presets = category_presets[:5]
        
        # 言語フィルタ
        if allowed_languages:
            selected_presets = [
                {
                    **preset,
                    "translations": [
                        t for t in preset["translations"]
                        if t["language"] in allowed_languages
                    ]
                }
                for preset in selected_presets
            ]
            # フィルタ後も翻訳が残っているFAQのみを追加
            selected_presets = [
                preset for preset in selected_presets
                if preset["translations"]
            ]
        
        filtered_presets.extend(selected_presets)
    
    return filtered_presets
```

### 3.2 修正2: `auth_service.py`の修正

**変更内容**: 特に変更不要（既存の実装で対応可能）

**現在の実装**:
```python
# FAQ一括作成
await FAQService(db).bulk_create_faqs(facility_id, faq_requests, user_id)
await db.commit()
```

この実装のままで、`filter_faq_presets_by_plan`が20件を返すため、20件だけ作成されて一度だけコミットされる。

### 3.3 修正3: キャッシュ無効化の見直し

**変更内容**: 現在の実装（5秒待ってから再度無効化）は維持

**理由**: 20件だけなので、バックグラウンド処理の実行時間が短縮される（約17秒 → 約10秒程度）

## 4. 実装手順

1. **修正1: `plan_limits.py`の修正**
   - `INITIAL_FAQ_COUNTS`を全プランで20件に統一
   - `filter_faq_presets_by_plan`を修正して、カテゴリ毎に均等に5件ずつ抽出

2. **テスト**
   - Freeプランで新規登録 → 20件（日本語のみ）表示されることを確認
   - Standardプランで新規登録 → 20件（日本語+英語）表示されることを確認
   - カテゴリ毎に5件ずつ表示されることを確認

## 5. 期待される効果

1. **シンプルな実装**: 複雑なポーリングや段階的コミットが不要
2. **分かりやすい**: 全プランで20件、カテゴリ毎に5件ずつ
3. **ユーザー体験**: 不審に思われることがない
4. **実行時間の短縮**: 20件だけなので、バックグラウンド処理の実行時間が短縮される（約17秒）

## 6. 注意事項

1. **カテゴリ毎の抽出**: 優先度順にソートしてから5件ずつ抽出するため、優先度が高いFAQが選ばれる
2. **言語フィルタ**: Freeプランは日本語のみ、その他はプランに応じた言語が含まれる
3. **既存のFAQ**: 既に登録されている施設には影響しない（新規登録時のみ適用）

## 7. カテゴリ別抽出の詳細

### 7.1 抽出ロジック

1. **カテゴリ毎に分類**: basic, facilities, location, trouble
2. **優先度順にソート**: 優先度が高い順（5 → 4 → 3 → 2 → 1）
3. **各カテゴリから5件ずつ抽出**: 優先度が高い順に5件
4. **言語フィルタ**: プランに応じた言語のみを残す

### 7.2 抽出例

**Freeプラン（日本語のみ）**:
- basic: 5件（日本語のみ）
- facilities: 5件（日本語のみ）
- location: 5件（日本語のみ）
- trouble: 5件（日本語のみ）
- **合計**: 20件

**Standardプラン（日本語+英語）**:
- basic: 5件（日本語+英語）
- facilities: 5件（日本語+英語）
- location: 5件（日本語+英語）
- trouble: 5件（日本語+英語）
- **合計**: 20件

## 8. 既存の実装との互換性

### 8.1 既存の施設への影響

- **影響なし**: 既に登録されている施設には影響しない
- **新規登録時のみ適用**: 新規登録時にのみ20件が自動登録される

### 8.2 既存のコードとの互換性

- **`get_initial_faq_count`**: 全プランで20を返すように変更
- **`filter_faq_presets_by_plan`**: カテゴリ毎に均等に抽出するように変更
- **その他のコード**: 変更不要

## 9. まとめ

この修正案は、**シンプルで分かりやすい実装**を提供します。

- ✅ 全プランで20件に統一
- ✅ カテゴリ毎に5件ずつ抽出
- ✅ Freeプランは日本語のみ
- ✅ その他はプランに応じた言語
- ✅ 複雑なポーリングや段階的コミットが不要
- ✅ ユーザーに不審に思われることがない

