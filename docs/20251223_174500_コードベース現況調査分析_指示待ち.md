# コードベース現況調査分析（指示待ち）

**作成日時**: 2025年12月23日 17時45分00秒  
**実施者**: AI Assistant  
**目的**: コードベースの現況を完全に調査分析し、指示があるまで修正を実施しない  
**状態**: 📋 **調査分析完了・指示待ち**

---

## 1. プロジェクト構造の確認

### 1.1 ディレクトリ構造

**バックエンド** (`backend/app/`):
- `api/v1/`: APIエンドポイント（18ファイル）
- `ai/`: AI対話エンジン関連（embeddings, engine, confidence, safety_check等）
- `core/`: コア機能（config, security, jwt, cache等）
- `models/`: データベースモデル（conversation, facility, faq, faq_translation等）
- `services/`: ビジネスロジック（chat_service, qr_code_service等）
- `utils/`: ユーティリティ（session.py等）

**フロントエンド** (`frontend/src/`):
- `api/`: APIクライアント（auth, chat, dashboard, facility等）
- `components/`: Vueコンポーネント（admin, guest, common）
- `composables/`: Composition API（useAuth, useChat, usePWA, useOffline等）
- `layouts/`: レイアウト（AdminLayout, GuestLayout）
- `router/`: ルーティング（admin, guest, index）
- `stores/`: Piniaストア（auth, chat, facility, theme）
- `utils/`: ユーティリティ（manifestGenerator, validators等）
- `views/`: ページコンポーネント（admin, guest, PWABoot, Error404, Error500）

### 1.2 Docker環境

**docker-compose.yml構成**:
- `postgres`: PostgreSQL 15（pgvector拡張）
- `redis`: Redis 7.2-alpine
- `backend`: FastAPI（ポート8000）
- `frontend`: Vite開発サーバー（ポート5173）

---

## 2. PWA関連の現況

### 2.1 動的manifest生成機能

**ファイル**: `frontend/src/utils/manifestGenerator.ts`

**実装内容**:
- `generateManifest(facilityId)`: 動的manifestを生成（`start_url`に`/f/${facilityId}`を設定）
- `updateManifestLink(facilityId)`: manifest linkタグを動的に更新（Blob URLを使用）

**使用箇所**:
1. `frontend/src/main.ts`: アプリ起動時に`updateManifestLink(null)`を呼び出し
2. `frontend/src/layouts/GuestLayout.vue`: ゲストレイアウトで`updateManifestLink(facilityId)`を呼び出し
3. `frontend/src/components/common/PWAInstallPrompt.vue`: PWAインストールプロンプトで`updateManifestLink(facilityId)`を呼び出し

**問題点**:
- Blob URLを使用した動的manifestは、PWAインストール時にブラウザが参照できない可能性がある
- `[PWA]`ログが出力されていない（コードが実行されていない可能性）

### 2.2 PWABoot.vue

**ファイル**: `frontend/src/views/PWABoot.vue`

**実装内容**:
- PWA起動時のルート（`/`）で表示されるコンポーネント
- 管理者が認証済みの場合は`/admin/dashboard`にリダイレクト
- `localStorage`から`last_facility_url`を取得してリダイレクト
- ホワイトリスト方式でゲスト側のルート（`/f/:facilityId`）のみ許可
- `localStorage`に`last_facility_url`が存在しない場合、404エラーページを表示

**問題点**:
- `localStorage`への依存がある（プライベートモードなどで利用できない場合がある）
- 動的manifestが機能していない場合、`localStorage`に依存する必要がある

### 2.3 ルーティング設定

**ファイル**: `frontend/src/router/index.ts`

**実装内容**:
- `/`ルートで`PWABoot.vue`を表示
- ゲスト側のルート（`/f/:facilityId`）にアクセスした際、`localStorage`に施設URLを保存
- 認証ガードの実装

**問題点**:
- `localStorage`への保存は実装されているが、PWA起動時に`localStorage`が空の場合がある

---

## 3. 残存課題の現況

### 3.1 PWAインストール後の起動時404エラー

**根本原因（確定）**: 動的manifestが機能していない、またはPWAインストール時に使用されていない

**現況**:
- 動的manifest生成機能は実装されている（`manifestGenerator.ts`）
- `updateManifestLink()`は複数箇所で呼び出されている
- しかし、PWA起動時に`/`にアクセスしている（動的manifestの`start_url`が使用されていない）
- `[PWA]`ログが出力されていない（コードが実行されていない可能性）

**推奨される対応方針**（引き継ぎ書から）:
1. 動的manifestの動作を完全に検証
2. サーバーサイドでの動的manifest生成の検討
3. 複数アプローチの組み合わせ

### 3.2 オフライン時対応

**現況**:
- `frontend/src/composables/useOffline.ts`が存在する
- オフライン検出機能は実装されている可能性がある
- 詳細な実装内容は未確認

---

## 4. 完了済み機能の確認

### 4.1 セッション有効期限延長問題の防止策1

**ファイル**: `backend/app/utils/session.py`

**実装内容**:
- `is_session_valid()`関数を実装
- `started_at`ベースの固定有効期限（24時間）
- Redisキャッシュを使用

**確認結果**: ✅ **実装済み**

### 4.2 FAQ登録数カウント方法修正

**実装内容**:
- データベーススキーマ変更（`faqs`テーブルと`faq_translations`テーブルに分離）
- インテントベースのカウント方式

**確認結果**: ✅ **実装済み**（コミットハッシュ: `b928c2b`、`develop`ブランチ）

---

## 5. 調査分析結果のまとめ

### 5.1 コードベースの現況

**全体的な状況**:
- ✅ 主要機能は実装済み
- ✅ Docker環境は正常に動作
- ⚠️ PWA関連の実装は存在するが、動的manifestが機能していない

### 5.2 残存課題の現況

1. **🔴 最優先: PWAインストール後の起動時404エラー**
   - 動的manifest生成機能は実装されているが、機能していない
   - `PWABoot.vue`のフォールバックも機能していない可能性
   - サーバーサイドでの動的manifest生成の検討が必要

2. **⚠️ 高優先度: オフライン時対応**
   - `useOffline.ts`が存在するが、詳細な実装内容は未確認
   - オフライン時の専用メッセージ表示の実装状況は未確認

### 5.3 次のステップ（指示待ち）

**調査分析のみ実施済み**:
- ✅ コードベースの構造確認
- ✅ PWA関連の実装状況確認
- ✅ 残存課題の現況確認

**修正は実施していない**:
- ⏳ 指示があるまで修正を実施しない
- ⏳ 調査分析と計画立案のみ実施

---

## 6. 参照文書

- `docs/Phase1_Phase2_引き継ぎ書_20251214.md`: 最新の引き継ぎ書
- `docs/20251222_220854_PWA404エラー_残存課題_完全総括_失敗履歴修正履歴_コードベース現況_継承文書.md`: PWA404エラーの完全総括文書
- `docs/20251223_174023_セッション開始チェックリスト完了報告_現況把握.md`: セッション開始チェックリスト完了報告

---

**Document Version**: v1.0  
**Author**: AI Assistant  
**Last Updated**: 2025年12月23日 17時45分00秒  
**Status**: 📋 **調査分析完了・指示待ち**

**重要**: この文書は、コードベースの現況を調査分析した結果を記録したものです。指示があるまで修正を実施していません。次のステップは、ユーザーの指示を待ちます。

