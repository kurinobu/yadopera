# Phase 1・Phase 2: PWAインストール後の起動時404エラー 調査依頼書 記載項目検討

**作成日時**: 2025年12月22日  
**実施者**: AI Assistant  
**目的**: ChatGPT/Claudeへの調査依頼書に記載する項目を検討  
**状態**: 📋 **記載項目検討完了**

---

## 記載すべき項目（検討結果）

### 1. プロジェクト概要

**記載内容**:
- プロジェクト名: YadOPERA
- プロジェクトの目的: 小規模宿泊施設向けAI多言語自動案内システム
- 現在のフェーズ: Phase 2（PoC準備）
- システムの構造: ゲスト側と管理者側の分離

**重要**: ゲスト側と管理者側の役割の違いを明確に記載

---

### 2. 問題の詳細

#### 2.1 問題の概要

**記載内容**:
- PWAインストール後の起動時に404エラーが発生
- 発生率: 100%（全端末で発生）
- 発生端末: iPad（Safari iOS）、Pixel（Chrome Android）
- 発生タイミング: PWAをインストール後、ホーム画面のアイコンをタップしてアプリを起動した際

#### 2.2 症状の詳細

**記載内容**:
- ネットワークログ: `Error404-Cw82tsUu.js`と`Error404-tn0RQdqM.css`が読み込まれている
- これは、Vue Routerが`NotFound`ルート（404エラーページ）にリダイレクトしていることを示している
- localStorageの状態: `theme: "light"`のみ保存されており、`last_facility_url`が存在しない

#### 2.3 期待される動作（正しい期待動作）

**記載内容**:
- ✅ **ゲストがPWAアイコンをタップ → 最後にアクセスした施設URL（例: `/f/:facilityId`）にリダイレクト → 施設独自の画面が表示される**
- ❌ **404エラーページを表示することは期待されていない**
- ❌ **「施設URLがない場合」という状況は発生してはいけない（PWAインストールはゲスト側のルートでのみ可能なため）**

**重要**: 誤った認識（「404エラーページを表示する」）を排除し、正しい期待動作のみを記載

---

### 3. 技術スタック

**記載内容**:
- フロントエンド: Vue.js 3.4.21, TypeScript, Vite 5.0.12, Vue Router 4.3.0
- PWAプラグイン: vite-plugin-pwa 0.19.8
- Service Worker: Workbox（vite-plugin-pwa経由）
- デプロイ環境: Render.com Static Site
- 開発環境: Docker / Docker Compose（必須）

---

### 4. 現在の実装状況

#### 4.1 PWA設定（`frontend/vite.config.ts`）

**記載内容**:
- `manifest.start_url: '/'`
- `manifest.scope: '/'`
- `manifest.display: 'standalone'`
- `workbox.navigateFallback: '/index.html'`
- `workbox.navigationPreload: false`

#### 4.2 Vue Router設定（`frontend/src/router/index.ts`）

**記載内容**:
- `/`のルートに`beforeEnter`ガードを実装
- `localStorage.getItem('last_facility_url')`から最後にアクセスした施設URLを取得
- ホワイトリスト方式: ゲスト側のルート（`/f/:facilityId`）のみ許可
- 施設IDの検証: `isValidFacilityId()`を使用
- `localStorage`に`last_facility_url`がない場合、`next({ name: 'NotFound' })`を実行（これが404エラーの原因）

#### 4.3 localStorage保存処理

**記載内容**:
- `router.beforeEach`: ゲスト側のルート（`/f/:facilityId`）にアクセスした際、`localStorage.setItem('last_facility_url', facilityUrl)`を実行
- `PWAInstallPrompt.vue`: PWAインストール前とインストール成功時に施設URLを保存
- `usePWA.ts`: `appinstalled`イベントでも施設URLを保存

#### 4.4 サーバー側設定（`render.yaml`）

**記載内容**:
- Render.com Static Siteのリライト設定
- SPAルーティング用の設定

---

### 5. これまで実施した修正とその結果

#### 5.1 修正履歴

**記載内容**:
1. **修正1**: `manifest.json`に`start_url`、`scope`、`display`を明示的に設定
   - 結果: ❌ 404エラー継続

2. **修正2**: `navigationPreload: false`と`runtimeCaching`ルールを追加
   - 結果: ❌ 404エラー継続

3. **修正3**: `navigateFallback`のみに依存する設定に変更
   - 結果: ❌ 404エラー継続

4. **修正4（ChatGPTの提案）**: `start_url: '/index.html'`に変更、`render.yaml`にリライトルールを追加
   - 結果: ❌ `index.html`は読み込まれるが、Vue Routerが404ルートにリダイレクト

5. **修正5**: `/`のルートを`/admin/login`にリダイレクト
   - 結果: ❌ **重大問題**: ゲストが管理者ログインページにアクセスできてしまう

6. **修正6（セキュリティ対策）**: `/`のルートに`beforeEnter`ガードを追加、ホワイトリスト方式でゲスト側のルートのみ許可
   - 結果: ❌ 404エラー継続（`localStorage`に`last_facility_url`が保存されていない）

7. **修正7**: `next('/:pathMatch(.*)*')`を`next({ name: 'NotFound' })`に変更
   - 結果: ❌ 404エラー継続

8. **修正8（修正案1,2,3）**: PWAインストール前とインストール成功時に施設URLを保存、`appinstalled`イベントでも保存、デバッグログを追加
   - 結果: ❌ 404エラー継続（`localStorage`に`last_facility_url`が保存されていない）

#### 5.2 現在の問題

**記載内容**:
- `localStorage`に`last_facility_url`が保存されていない
- PWAインストール時に施設URLが保存されない原因が不明
- Safari iOSの特殊性（`beforeinstallprompt`イベントが発火しない）が影響している可能性

---

### 6. 調査してほしい点

#### 6.1 根本原因の特定

**記載内容**:
- なぜ`localStorage`に`last_facility_url`が保存されないのか
- PWAインストール時に施設URLが保存されない原因
- Safari iOSとChrome Androidの両方で発生する原因

#### 6.2 技術的な調査

**記載内容**:
- PWAインストール時のタイミングと`localStorage`への保存タイミングの関係
- `beforeinstallprompt`イベントが発火しない環境での対応方法
- `appinstalled`イベントのタイミングと`window.location`の状態
- Service Workerと`localStorage`の関係

#### 6.3 実装方法の調査

**記載内容**:
- PWAインストール時に確実に施設URLを保存する方法
- 複数の保存タイミング（インストール前、インストール成功時、`appinstalled`イベント）の優先順位
- フォールバック処理の必要性

---

### 7. 修正案を依頼する点

#### 7.1 修正案の要件

**記載内容**:
- ゲストがPWAアイコンをタップした際、最後にアクセスした施設URLにリダイレクトされる
- 404エラーページを表示することは期待されていない
- 「施設URLがない場合」という状況は発生してはいけない
- セキュリティ対策（ホワイトリスト方式、施設IDの検証）を維持

#### 7.2 修正案の評価基準

**記載内容**:
- 大原則への準拠（根本解決 > 暫定解決、シンプル構造 > 複雑構造など）
- 既存の機能への影響がないこと
- セキュリティ対策を維持すること
- マルチテナント対応を維持すること

---

### 8. 環境情報

**記載内容**:
- デプロイ環境: Render.com Static Site（ステージング環境）
- テスト環境: Docker / Docker Compose
- テスト端末: iPad（Safari iOS）、Pixel（Chrome Android）
- ブラウザバージョン: 最新版

---

### 9. エラーログとスクリーンショット

**記載内容**:
- ネットワークログ: `Error404-Cw82tsUu.js`と`Error404-tn0RQdqM.css`が読み込まれている
- localStorageの状態: `theme: "light"`のみ保存されており、`last_facility_url`が存在しない
- コンソールログ: `[PWA]`で始まるログが表示されていない（または表示されていない）

---

### 10. 重要な注意事項

**記載内容**:
- ⚠️ **誤った認識の排除**: 「404エラーページを表示する」という誤った認識を排除
- ⚠️ **期待動作の明確化**: ゲストがPWAアイコンをタップした際、最後にアクセスした施設URLにリダイレクトされることが期待される
- ⚠️ **システムの理解**: ゲスト側と管理者側の役割の違いを理解する
- ⚠️ **PWAの用途**: PWAはゲスト側の機能として実装されている

---

## 記載項目の優先順位

### 最優先項目

1. **期待される動作（正しい期待動作）**: 誤った認識を排除し、正しい期待動作のみを記載
2. **現在の問題**: `localStorage`に`last_facility_url`が保存されていない
3. **これまで実施した修正とその結果**: 修正履歴と結果を正確に記載
4. **現在の実装状況**: コードの実装状況を正確に記載

### 重要項目

5. **技術スタック**: 使用している技術を正確に記載
6. **調査してほしい点**: 根本原因の特定と技術的な調査
7. **修正案を依頼する点**: 修正案の要件と評価基準

### 補足項目

8. **環境情報**: デプロイ環境とテスト環境
9. **エラーログとスクリーンショット**: エラーの詳細
10. **重要な注意事項**: 誤った認識の排除と期待動作の明確化

---

## 記載時の注意事項

### 1. 誤った認識の排除

**注意事項**:
- 「404エラーページを表示する」という誤った認識を記載しない
- 「保存された施設URLがない場合」という状況を想定した記述を避ける
- 正しい期待動作のみを記載

### 2. 正確な情報の記載

**注意事項**:
- コードの実装状況を正確に記載
- 修正履歴と結果を正確に記載
- エラーログとスクリーンショットの情報を正確に記載

### 3. 明確な依頼内容

**注意事項**:
- 調査してほしい点を明確に記載
- 修正案の要件と評価基準を明確に記載
- 期待される結果を明確に記載

---

**Document Version**: v1.0  
**Author**: AI Assistant  
**Last Updated**: 2025年12月22日  
**Status**: 📋 **記載項目検討完了**

**重要**: この文書は、ChatGPT/Claudeへの調査依頼書に記載する項目を検討した結果です。これらの項目に基づいて、正確な調査依頼書を作成してください。

