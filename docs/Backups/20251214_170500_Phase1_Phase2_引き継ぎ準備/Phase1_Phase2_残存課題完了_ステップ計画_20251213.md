# Phase 1・Phase 2 残存課題完了 ステップ計画

**作成日**: 2025年12月13日  
**実施者**: AI Assistant  
**目的**: Phase 1とPhase 2の残存課題を全て完了させる包括的なステップ計画を立案（大原則準拠）  
**状態**: 📋 **ステップ計画立案完了**

**重要**: 指示があるまで修正しないでください。

---

## 1. 残存課題の整理

### 1.1 Phase 1残存課題

1. **ステージング環境でのテスト予定項目（マスト、2項目）**
   - 有効なトークンでのセッション統合の動作確認
   - PWAインストールプロンプトのボタンの動作確認

2. **FAQ自動学習UIの動作確認**
   - 状態: コード修正完了、動作確認未完了
   - 必要な作業: テストデータ作成、動作確認

### 1.2 Phase 2残存課題

1. **ステージング環境のダッシュボード表示問題（CRITICAL）**
   - 状態: 未解決
   - 問題: ダッシュボードが正常に表示されない（真っ白画面）

2. **ステージング環境のデプロイ完了確認**
   - 状態: 再デプロイ実施中（2025-12-13）
   - 内容: bcrypt 4.1.2へのダウングレード反映

3. **Docker環境での再テスト実施**
   - 状態: 準備完了
   - 内容: 管理画面・ゲスト画面の詳細テスト

---

## 2. 大原則の確認

### 2.1 開発・実装の大原則

1. **根本解決 > 暫定解決**
2. **シンプル構造 > 複雑構造**
3. **統一・同一化 > 特殊独自**
4. **具体的 > 一般**
5. **拙速 < 安全確実**
6. **Docker環境必須 > ローカル直接実行**

### 2.2 禁止事項・留意事項

- **指示違反の禁止**: 質問・意見の場合は、必ず同意を確認してから実施
- **Docker環境必須の原則**: すべての修正・テストはDocker環境で実行する

---

## 3. ステップ計画（実行順序）

### ステップ0: 環境準備とテストデータ作成 🔴 最優先

**目的**: テストを実施するための環境とテストデータを準備する（大原則: 拙速 < 安全確実）

**所要時間**: 1-2時間

**前提条件**:
- Docker環境が利用可能
- データベースが正常に動作している

**大原則の適用**:
- **拙速 < 安全確実**: 十分な検証を行い、テストデータが正しく作成されることを確認する
- **具体的 > 一般**: 具体的な手順を明確にする

**実施内容**:

1. **Docker環境の確認**
   - `docker-compose ps`で全コンテナが正常稼働していることを確認
   - `docker-compose logs backend --tail 50`でバックエンドのログを確認
   - `docker-compose logs frontend --tail 50`でフロントエンドのログを確認

2. **テストデータ作成スクリプトの確認・拡張**
   - `backend/create_test_data.py`を確認
   - 未解決質問リストのテストデータが作成されることを確認
   - 必要に応じて、ゲスト画面テスト用のデータも追加

3. **テストデータ作成スクリプトの実行（Docker環境）**
   ```bash
   docker-compose exec backend python create_test_data.py
   ```
   - テストユーザー・テスト施設が作成されることを確認
   - 未解決質問のテストデータが作成されることを確認
   - ゲスト画面テスト用の会話・メッセージデータが作成されることを確認

4. **テストデータの確認**
   - データベースに正しく作成されたことを確認
   - 管理画面で未解決質問リストに表示されることを確認

**確認項目**:
- [ ] Docker環境が正常に稼働している
- [ ] テストデータ作成スクリプトが正常に実行される
- [ ] テストユーザー・テスト施設が作成される
- [ ] 未解決質問のテストデータが作成される
- [ ] ゲスト画面テスト用のデータが作成される
- [ ] 管理画面で未解決質問リストに表示される

**完了条件**:
- ✅ Docker環境が正常に稼働している
- ✅ テストデータ作成スクリプトが正常に実行される
- ✅ テストユーザー・テスト施設が作成される
- ✅ 未解決質問のテストデータが作成される
- ✅ ゲスト画面テスト用のデータが作成される

**成果物**:
- テストデータ作成スクリプト（拡張版）
- テストデータ作成完了レポート

---

### ステップ1: ステージング環境のデプロイ完了確認 ⚠️ 最優先

**目的**: ステージング環境の再デプロイが完了し、正常に動作していることを確認する（大原則: 拙速 < 安全確実）

**所要時間**: 0.5-1時間

**前提条件**:
- ステージング環境への再デプロイが実施されている（2025-12-13）

**大原則の適用**:
- **拙速 < 安全確実**: 十分な検証を行い、デプロイが正常に完了していることを確認する
- **具体的 > 一般**: 具体的な確認手順を明確にする

**実施内容**:

1. **Render.comダッシュボードでデプロイ状況を確認**
   - デプロイが完了していることを確認
   - デプロイログにエラーがないことを確認

2. **bcryptバージョンの確認（Render.comのShellから実行）**
   ```bash
   pip show bcrypt
   ```
   - bcrypt 4.1.2がインストールされていることを確認

3. **ログインAPIの動作確認**
   - `https://yadopera-backend-staging.onrender.com/api/v1/auth/login`にPOSTリクエストを送信
   - 200 OKレスポンスが返されることを確認
   - JWTトークンが返されることを確認

4. **CORSエラーの確認**
   - ブラウザで`https://yadopera-frontend-staging.onrender.com/admin/login`にアクセス
   - ブラウザの開発者ツール（Consoleタブ）でCORSエラーが発生していないか確認
   - NetworkタブでAPIリクエストが正常に送信されているか確認

**確認項目**:
- [ ] デプロイが完了している
- [ ] bcrypt 4.1.2がインストールされている
- [ ] ログインAPIが正常に動作する
- [ ] CORSエラーが発生していない

**完了条件**:
- ✅ デプロイが完了している
- ✅ bcrypt 4.1.2がインストールされている
- ✅ ログインAPIが正常に動作する
- ✅ CORSエラーが発生していない

**成果物**:
- ステージング環境デプロイ完了確認レポート

---

### ステップ2: ステージング環境のダッシュボード表示問題の調査・修正 🔴 CRITICAL

**目的**: ステージング環境のダッシュボード表示問題の根本原因を特定し、修正する（大原則: 根本解決 > 暫定解決）

**所要時間**: 2-4時間

**前提条件**:
- ステップ1完了
- Docker環境が利用可能

**大原則の適用**:
- **根本解決 > 暫定解決**: 真っ白画面問題の根本原因を特定し、根本的に解決する
- **シンプル構造 > 複雑構造**: 既存のコード構造を最小限の変更で修正する
- **統一・同一化 > 特殊独自**: 既存のパターンに従い、統一された実装を維持する
- **具体的 > 一般**: 具体的な調査・修正手順を明確にする
- **拙速 < 安全確実**: 十分な検証を行い、安全に修正する
- **Docker環境必須**: すべての調査・修正はDocker環境で実行する

**実施内容**:

1. **問題の詳細調査（Docker環境で実施）**
   - ブラウザの開発者ツール（Consoleタブ）でエラーメッセージの詳細を確認
   - NetworkタブでJavaScriptファイルが正しく読み込まれているか確認
   - SourcesタブでJavaScriptファイルの内容を確認
   - エラーメッセージのスタックトレースを確認

2. **ローカル環境でのビルド確認（Docker環境で実行）**
   ```bash
   docker-compose exec frontend npm run build
   ```
   - ビルドが正常に完了することを確認
   - `dist/index.html`の内容を確認
   - JavaScriptファイルのパスが正しいか確認
   - `base`設定が反映されているか確認

3. **根本原因の特定**
   - JavaScriptファイルのパスが正しく解決されていない可能性
   - Vue Routerの初期化に失敗している可能性
   - 静的ファイル（JS/CSS）の読み込みに失敗している可能性
   - エラーメッセージの原因が特定できていない可能性

4. **根本解決の実装**
   - 根本原因に基づいて修正を実施
   - `frontend/vite.config.ts`の`base`設定を確認・修正
   - `frontend/src/router/index.ts`の`createWebHistory`設定を確認・修正
   - `frontend/src/main.ts`の初期化処理を確認・修正

5. **動作確認（Docker環境）**
   - ローカル環境でビルドを実行
   - ビルド後の`dist/index.html`を確認
   - ブラウザで`http://localhost:5173/admin/dashboard`にアクセス
   - ダッシュボードが正常に表示されることを確認

6. **ステージング環境への反映**
   - 修正をコミット・プッシュ
   - ステージング環境へのデプロイを確認
   - ステージング環境でダッシュボードが正常に表示されることを確認

**確認項目**:
- [ ] エラーメッセージの詳細を確認した
- [ ] ビルド後の`dist/index.html`を確認した
- [ ] 根本原因を特定した
- [ ] 修正を実施した
- [ ] ローカル環境で動作確認した
- [ ] ステージング環境で動作確認した

**完了条件**:
- ✅ 根本原因を特定した
- ✅ 修正を実施した
- ✅ ローカル環境でダッシュボードが正常に表示される
- ✅ ステージング環境でダッシュボードが正常に表示される

**成果物**:
- ダッシュボード表示問題の調査分析レポート
- 修正完了レポート

---

### ステップ3: FAQ自動学習UIの動作確認 ⚠️ 高優先度

**目的**: FAQ自動学習UIが正常に動作することを確認する（大原則: 拙速 < 安全確実）

**所要時間**: 1-2時間

**前提条件**:
- ステップ0完了（テストデータ作成完了）
- Docker環境が利用可能

**大原則の適用**:
- **拙速 < 安全確実**: 十分な検証を行い、FAQ自動学習UIが正常に動作することを確認する
- **具体的 > 一般**: 具体的な確認手順を明確にする
- **Docker環境必須**: すべてのテストはDocker環境で実行する

**実施内容**:

1. **管理画面で未解決質問リストを確認**
   - 管理画面にログイン（`test@example.com` / `testpassword123`）
   - FAQ管理画面にアクセス
   - 「未解決質問リスト」セクションが表示されることを確認
   - 未解決質問が表示されることを確認

2. **FAQ提案の生成を確認**
   - 未解決質問リストから任意の質問を選択
   - 「FAQ追加」ボタンをクリック
   - FAQ追加提案カードが表示されることを確認
   - 質問文・回答文・カテゴリが自動入力されることを確認

3. **FAQ提案の承認を確認**
   - FAQ追加提案カードで「承認」ボタンをクリック
   - ローディング表示が表示されることを確認
   - 成功メッセージが表示されることを確認
   - FAQ一覧に新規FAQが追加されることを確認

4. **エラーハンドリングの確認**
   - ブラウザの開発者ツール（Consoleタブ）でエラーがないことを確認
   - NetworkタブでAPIリクエストが正常に送信されていることを確認

**確認項目**:
- [ ] 未解決質問リストが表示される
- [ ] FAQ提案の生成が正常に動作する
- [ ] FAQ提案の承認が正常に動作する
- [ ] FAQが正常に作成される
- [ ] エラーが発生していない

**完了条件**:
- ✅ 未解決質問リストが表示される
- ✅ FAQ提案の生成が正常に動作する
- ✅ FAQ提案の承認が正常に動作する
- ✅ FAQが正常に作成される
- ✅ エラーが発生していない

**成果物**:
- FAQ自動学習UI動作確認完了レポート

---

### ステップ4: Docker環境での管理画面詳細テスト ⚠️ 高優先度

**目的**: 管理画面のすべての機能が正常に動作することを確認する（大原則: 拙速 < 安全確実）

**所要時間**: 2-3時間

**前提条件**:
- ステップ0完了（テストデータ作成完了）
- Docker環境が利用可能

**大原則の適用**:
- **拙速 < 安全確実**: 十分な検証を行い、すべての機能が正常に動作することを確認する
- **具体的 > 一般**: 具体的なテスト項目を明確にする
- **Docker環境必須**: すべてのテストはDocker環境で実行する

**実施内容**:

1. **ログイン機能のテスト**
   - ログイン画面にアクセス（`http://localhost:5173/admin/login`）
   - ログイン処理が正常に動作するか確認（`test@example.com` / `testpassword123`）
   - JWT認証が正常に動作するか確認
   - ログイン成功後にダッシュボードにリダイレクトされるか確認

2. **ダッシュボードのテスト**
   - ダッシュボードが正常に表示されることを確認
   - 統計情報（総質問数、自動応答率、平均信頼度など）が正しく表示されることを確認
   - カテゴリ別内訳が正しく表示されることを確認
   - グラフが正常に表示されることを確認

3. **FAQ管理画面のテスト**
   - FAQ一覧が表示されることを確認
   - FAQ追加が正常に動作することを確認
   - FAQ編集が正常に動作することを確認
   - FAQ削除が正常に動作することを確認
   - 埋め込みベクトル自動生成が正常に動作することを確認

4. **施設設定画面のテスト**
   - 施設設定画面が正常に表示されることを確認
   - 基本情報の編集が正常に動作することを確認
   - スタッフ不在時間帯設定が正常に動作することを確認
   - パスワード変更が正常に動作することを確認

5. **FAQ自動学習UIのテスト**
   - 未解決質問リストが表示されることを確認
   - FAQ提案の生成が正常に動作することを確認
   - FAQ提案の承認が正常に動作することを確認

6. **スタッフ不在時間帯対応キューUIのテスト**
   - キュー一覧が表示されることを確認
   - キューの統計情報が正常に表示されることを確認
   - 「対応済み」ボタンが正常に動作することを確認

7. **QRコード生成UIのテスト**
   - QRコード生成フォームが表示されることを確認
   - QRコード生成が正常に動作することを確認
   - QRコードダウンロードが正常に動作することを確認
   - セッション統合トークン埋め込みオプションが正常に動作することを確認

8. **ゲストフィードバック統計のテスト**
   - フィードバック集計が正常に表示されることを確認
   - 低評価回答一覧が正常に表示されることを確認

**確認項目**:
- [ ] ログイン機能が正常に動作する
- [ ] ダッシュボードが正常に表示される
- [ ] FAQ管理画面が正常に動作する
- [ ] 施設設定画面が正常に動作する
- [ ] FAQ自動学習UIが正常に動作する
- [ ] スタッフ不在時間帯対応キューUIが正常に動作する
- [ ] QRコード生成UIが正常に動作する
- [ ] ゲストフィードバック統計が正常に表示される

**完了条件**:
- ✅ すべての管理画面機能が正常に動作する
- ✅ エラーが発生していない
- ✅ テスト結果を記録した

**成果物**:
- 管理画面詳細テスト完了レポート

---

### ステップ5: Docker環境でのゲスト画面詳細テスト ⚠️ 高優先度

**目的**: ゲスト画面のすべての機能が正常に動作することを確認する（大原則: 拙速 < 安全確実）

**所要時間**: 2-3時間

**前提条件**:
- ステップ0完了（テストデータ作成完了）
- Docker環境が利用可能

**大原則の適用**:
- **拙速 < 安全確実**: 十分な検証を行い、すべての機能が正常に動作することを確認する
- **具体的 > 一般**: 具体的なテスト項目を明確にする
- **Docker環境必須**: すべてのテストはDocker環境で実行する

**実施内容**:

1. **言語選択画面のテスト**
   - ゲスト画面にアクセス（`http://localhost:5173/f/test-facility?location=entrance`）
   - 言語選択画面が正常に表示されることを確認
   - 各言語ボタンが正常に動作することを確認

2. **ウェルカム画面のテスト**
   - ウェルカム画面が正常に表示されることを確認
   - よくある質問TOP3が表示されることを確認
   - フリー入力欄が表示されることを確認
   - 緊急連絡先が表示されることを確認

3. **チャット画面のテスト**
   - チャット画面が正常に表示されることを確認
   - チャット形式で表示されることを確認
   - PWA対応が正常に動作することを確認
   - ダークモードが正常に動作することを確認
   - 固定フッターが正常に表示されることを確認

4. **AI対話のテスト**
   - テスト質問を送信（例: "What time is check-in?"）
   - AI回答が返ってくることを確認
   - レスポンス時間が3秒以内であることを確認
   - RAG統合型AI応答が正常に動作することを確認

5. **ゲストフィードバックUIのテスト**
   - ゲストフィードバックUI（👍👎）が正常に動作することを確認
   - フィードバックが正常に送信されることを確認

6. **セッション統合トークンのテスト**
   - 4桁英数字トークンが表示されることを確認
   - トークン入力モーダルが正常に表示されることを確認
   - トークン入力機能が正常に動作することを確認（ローカル環境での基本機能確認）

7. **ダークモード切替のテスト**
   - ダークモード切替ボタンが正常に動作することを確認
   - ダークモードとライトモードが正常に切り替わることを確認

8. **PWAインストールプロンプトのテスト**
   - PWAインストールプロンプトが正常に表示されることを確認
   - プロンプトの「インストール」ボタンが正常に動作することを確認（ローカル環境での基本機能確認）
   - プロンプトの「後で」ボタンが正常に動作することを確認
   - プロンプトの「閉じる」ボタンが正常に動作することを確認

**確認項目**:
- [ ] 言語選択画面が正常に動作する
- [ ] ウェルカム画面が正常に動作する
- [ ] チャット画面が正常に動作する
- [ ] AI対話が正常に動作する
- [ ] ゲストフィードバックUIが正常に動作する
- [ ] セッション統合トークンが正常に動作する
- [ ] ダークモード切替が正常に動作する
- [ ] PWAインストールプロンプトが正常に動作する

**完了条件**:
- ✅ すべてのゲスト画面機能が正常に動作する
- ✅ エラーが発生していない
- ✅ テスト結果を記録した

**成果物**:
- ゲスト画面詳細テスト完了レポート

---

### ステップ6: ステージング環境でのテスト予定項目の確認（マスト） ⚠️ マスト

**目的**: ステージング環境での残存項目のテストを実施する（大原則: 拙速 < 安全確実）

**所要時間**: 1-2時間

**前提条件**:
- ステップ1完了（ステージング環境のデプロイ完了確認）
- ステップ2完了（ダッシュボード表示問題の修正完了）

**大原則の適用**:
- **拙速 < 安全確実**: 十分な検証を行い、すべての機能が正常に動作することを確認する
- **具体的 > 一般**: 具体的な確認項目を明確にする

**実施内容**:

1. **有効なトークンでのセッション統合の動作確認**
   - 2つのデバイス/ブラウザで異なるセッションを開始
   - 1つ目のデバイスでトークンを生成・表示
   - 2つ目のデバイスでトークンを入力してセッション統合
   - セッション統合後の会話履歴読み込みを確認

2. **PWAインストールプロンプトのボタンの動作確認**
   - プロンプトの「インストール」ボタンをクリックしてPWAインストールが正常に動作するか確認
   - プロンプトの「後で」ボタンをクリックしてプロンプトが非表示になるか確認
   - プロンプトの「閉じる」ボタンをクリックしてプロンプトが非表示になるか確認

**確認項目**:
- [ ] 有効なトークンでのセッション統合が正常に動作する
- [ ] PWAインストールプロンプトのボタンが正常に動作する
- [ ] ブラウザの開発者ツールでエラーがない
- [ ] ネットワークリクエストが正常に送信されている

**完了条件**:
- ✅ 有効なトークンでのセッション統合が正常に動作する
- ✅ PWAインストールプロンプトのボタンが正常に動作する
- ✅ エラーが発生していない
- ✅ テスト結果を記録した

**成果物**:
- ステージング環境テスト完了レポート

---

## 4. 実行順序と工数見積もり

### 4.1 実行順序

**推奨実行順序**:

1. **ステップ0: 環境準備とテストデータ作成**（最優先、1-2時間）
2. **ステップ1: ステージング環境のデプロイ完了確認**（最優先、0.5-1時間）
3. **ステップ2: ステージング環境のダッシュボード表示問題の調査・修正**（CRITICAL、2-4時間）
4. **ステップ3: FAQ自動学習UIの動作確認**（高優先度、1-2時間）
5. **ステップ4: Docker環境での管理画面詳細テスト**（高優先度、2-3時間）
6. **ステップ5: Docker環境でのゲスト画面詳細テスト**（高優先度、2-3時間）
7. **ステップ6: ステージング環境でのテスト予定項目の確認**（マスト、1-2時間）

### 4.2 工数見積もり

| ステップ | 工数 | 優先度 | 状態 |
|---------|------|--------|------|
| ステップ0: 環境準備とテストデータ作成 | 1-2時間 | 🔴 最優先 | ⏳ 未実施 |
| ステップ1: ステージング環境のデプロイ完了確認 | 0.5-1時間 | 🔴 最優先 | ⏳ 進行中 |
| ステップ2: ダッシュボード表示問題の調査・修正 | 2-4時間 | 🔴 CRITICAL | ⏳ 未実施 |
| ステップ3: FAQ自動学習UIの動作確認 | 1-2時間 | ⚠️ 高優先度 | ⏳ 未実施 |
| ステップ4: 管理画面詳細テスト | 2-3時間 | ⚠️ 高優先度 | ⏳ 未実施 |
| ステップ5: ゲスト画面詳細テスト | 2-3時間 | ⚠️ 高優先度 | ⏳ 未実施 |
| ステップ6: ステージング環境でのテスト予定項目 | 1-2時間 | ⚠️ マスト | ⏳ 未実施 |
| **合計** | **約10-17時間** | - | - |

---

## 5. テスト結果の記録方法

### 5.1 記録項目

各テスト項目について、以下の情報を記録してください：

- **実施日時**: テストを実施した日時
- **テスト結果**: ✅完了 / ❌未完了 / ⚠️問題あり
- **問題点**: 問題が発生した場合、詳細を記録
- **スクリーンショット**: 必要に応じてスクリーンショットを撮影

### 5.2 問題が発生した場合の対応

1. **問題の詳細を記録**
   - 問題の症状
   - 発生条件
   - エラーメッセージ（コンソール、ネットワークタブ）
   - スクリーンショット

2. **調査分析を実施**
   - ブラウザの開発者ツールでエラーを確認
   - ネットワークタブでAPIリクエスト/レスポンスを確認
   - バックエンドのログを確認（`docker-compose logs backend`）

3. **修正を実施**（指示がある場合）
   - 問題の根本原因を特定
   - 修正を実施（大原則に準拠）
   - 再テストを実施

---

## 6. まとめ

### 6.1 ステップ計画の概要

**残存課題**: 合計6項目
- Phase 1: 3項目
- Phase 2: 3項目

**ステップ数**: 7ステップ
- ステップ0: 環境準備とテストデータ作成
- ステップ1: ステージング環境のデプロイ完了確認
- ステップ2: ダッシュボード表示問題の調査・修正（CRITICAL）
- ステップ3: FAQ自動学習UIの動作確認
- ステップ4: 管理画面詳細テスト
- ステップ5: ゲスト画面詳細テスト
- ステップ6: ステージング環境でのテスト予定項目の確認（マスト）

**合計工数**: 約10-17時間

### 6.2 重要な注意事項

1. **Docker環境必須の原則**: すべての修正・テストはDocker環境で実行する
2. **指示違反の禁止**: 質問・意見の場合は、必ず同意を確認してから実施
3. **大原則の遵守**: 根本解決 > 暫定解決、シンプル構造 > 複雑構造、統一・同一化 > 特殊独自、具体的 > 一般、拙速 < 安全確実
4. **指示があるまで修正しない**: このステップ計画は調査分析と計画立案のみ。修正は指示があるまで実施しない

---

**Document Version**: v1.0  
**Author**: AI Assistant  
**Last Updated**: 2025-12-13  
**Status**: 📋 **ステップ計画立案完了**

**重要**: 指示があるまで修正しないでください。
