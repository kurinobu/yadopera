# FAQ言語数制限バリデーション ブラウザテスト手順

## テスト環境

- **バックエンド**: http://localhost:8000
- **フロントエンド**: http://localhost:5173
- **データベース**: PostgreSQL (localhost:5433)
- **Redis**: localhost:6379

## テスト前の準備

### 1. Docker環境の確認

```bash
cd /Users/kurinobu/projects/yadopera
docker-compose ps
```

すべてのサービスが起動していることを確認：
- ✅ yadopera-backend (Up)
- ✅ yadopera-frontend (Up)
- ✅ yadopera-postgres (Up, healthy)
- ✅ yadopera-redis (Up, healthy)

### 2. サービスへのアクセス確認

- バックエンド: http://localhost:8000/health → `{"status":"ok"}`
- フロントエンド: http://localhost:5173 → HTMLページが表示される

### 3. テスト用施設データの準備

各プランタイプの施設を作成し、既に言語数制限に達している状態を準備する必要があります。

#### プラン別の言語数制限

| プラン | 言語数制限 | 対応言語 |
|--------|-----------|---------|
| Free | 1 | ja |
| Mini | 2 | ja, en |
| Small | 3 | ja, en, zh-TW |
| Standard | 4 | ja, en, zh-TW, fr |
| Premium | 無制限 | 全言語 |

## テストケース

### テストケース1: Freeプラン（1言語制限）

**前提条件**:
- Freeプランの施設を作成
- 既に1言語（ja）を使用しているFAQが存在する

**テスト手順**:
1. 管理画面にログイン: http://localhost:5173/admin/login
2. FAQ管理画面に移動: http://localhost:5173/admin/faqs
3. 「新規FAQ作成」をクリック
4. カテゴリを選択（例: basic）
5. 翻訳を追加:
   - 言語: `ja`（既存言語）→ ✅ 成功するはず
   - 言語: `en`（新しい言語）→ ❌ エラーが表示されるはず
6. エラーメッセージを確認:
   - 「プランの言語数制限に達しています（1言語）。既存の言語（ja）を使用するか、プランをアップグレードしてください。」

**期待結果**:
- ✅ 既存言語（ja）を使用する場合は成功
- ❌ 新しい言語（en）を追加しようとするとエラーメッセージが表示される

---

### テストケース2: Miniプラン（2言語制限）

**前提条件**:
- Miniプランの施設を作成
- 既に2言語（ja, en）を使用しているFAQが存在する

**テスト手順**:
1. 管理画面にログイン
2. FAQ管理画面に移動
3. 「新規FAQ作成」をクリック
4. カテゴリを選択
5. 翻訳を追加:
   - 言語: `ja` または `en`（既存言語）→ ✅ 成功するはず
   - 言語: `zh-TW`（新しい言語）→ ❌ エラーが表示されるはず
6. エラーメッセージを確認:
   - 「プランの言語数制限に達しています（2言語）。既存の言語（ja, en）を使用するか、プランをアップグレードしてください。」

**期待結果**:
- ✅ 既存言語（ja, en）を使用する場合は成功
- ❌ 新しい言語（zh-TW）を追加しようとするとエラーメッセージが表示される

---

### テストケース3: Smallプラン（3言語制限）

**前提条件**:
- Smallプランの施設を作成
- 既に3言語（ja, en, zh-TW）を使用しているFAQが存在する

**テスト手順**:
1. 管理画面にログイン
2. FAQ管理画面に移動
3. 「新規FAQ作成」をクリック
4. カテゴリを選択
5. 翻訳を追加:
   - 言語: `ja`, `en`, `zh-TW`（既存言語）→ ✅ 成功するはず
   - 言語: `fr`（新しい言語）→ ❌ エラーが表示されるはず
6. エラーメッセージを確認:
   - 「プランの言語数制限に達しています（3言語）。既存の言語（ja, en, zh-TW）を使用するか、プランをアップグレードしてください。」

**期待結果**:
- ✅ 既存言語を使用する場合は成功
- ❌ 新しい言語（fr）を追加しようとするとエラーメッセージが表示される

---

### テストケース4: Standardプラン（4言語制限）

**前提条件**:
- Standardプランの施設を作成
- 既に4言語（ja, en, zh-TW, fr）を使用しているFAQが存在する

**テスト手順**:
1. 管理画面にログイン
2. FAQ管理画面に移動
3. 「新規FAQ作成」をクリック
4. カテゴリを選択
5. 翻訳を追加:
   - 言語: `ja`, `en`, `zh-TW`, `fr`（既存言語）→ ✅ 成功するはず
   - 言語: `es`（新しい言語）→ ❌ エラーが表示されるはず
6. エラーメッセージを確認:
   - 「プランの言語数制限に達しています（4言語）。既存の言語（ja, en, zh-TW, fr）を使用するか、プランをアップグレードしてください。」

**期待結果**:
- ✅ 既存言語を使用する場合は成功
- ❌ 新しい言語（es）を追加しようとするとエラーメッセージが表示される

---

### テストケース5: Premiumプラン（無制限）

**前提条件**:
- Premiumプランの施設を作成

**テスト手順**:
1. 管理画面にログイン
2. FAQ管理画面に移動
3. 「新規FAQ作成」をクリック
4. カテゴリを選択
5. 複数の翻訳を追加:
   - 言語: `ja`, `en`, `zh-TW`, `fr`, `es`, `de` など → ✅ すべて成功するはず
6. FAQを保存

**期待結果**:
- ✅ 任意の数の言語を追加できる（制限なし）

---

### テストケース6: 既存FAQの更新（既存言語のみ）

**前提条件**:
- Freeプラン（1言語制限）の施設
- 既に1言語（ja）を使用しているFAQが存在する

**テスト手順**:
1. 管理画面にログイン
2. FAQ管理画面に移動
3. 既存のFAQを編集
4. 翻訳を更新:
   - 言語: `ja`（既存言語）の質問・回答を更新 → ✅ 成功するはず
5. FAQを保存

**期待結果**:
- ✅ 既存言語の更新は成功する（言語数は増えないため）

---

### テストケース7: 既存FAQの更新（新しい言語を追加）

**前提条件**:
- Freeプラン（1言語制限）の施設
- 既に1言語（ja）を使用しているFAQが存在する

**テスト手順**:
1. 管理画面にログイン
2. FAQ管理画面に移動
3. 既存のFAQを編集
4. 翻訳を追加:
   - 言語: `ja`（既存）
   - 言語: `en`（新規追加）→ ❌ エラーが表示されるはず
5. エラーメッセージを確認

**期待結果**:
- ❌ 新しい言語を追加しようとするとエラーメッセージが表示される

---

## テストデータ作成用SQL（参考）

### Freeプラン施設の作成

```sql
-- 施設作成
INSERT INTO facilities (name, slug, email, plan_type, language_limit, is_active, created_at, updated_at)
VALUES ('Test Hotel Free', 'test-hotel-free', 'test-free@example.com', 'Free', 1, true, NOW(), NOW())
RETURNING id;

-- ユーザー作成（facility_idを上記のIDに置き換える）
INSERT INTO users (facility_id, email, password_hash, full_name, role, is_active, created_at, updated_at)
VALUES (
  (SELECT id FROM facilities WHERE slug = 'test-hotel-free'),
  'admin@test-free.com',
  '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5GyY5Y5Y5Y5Y5', -- password: testpassword123
  'Admin User',
  'admin',
  true,
  NOW(),
  NOW()
);

-- 既存FAQ作成（ja言語）
INSERT INTO faqs (facility_id, category, intent_key, priority, is_active, created_by, created_at, updated_at)
VALUES (
  (SELECT id FROM facilities WHERE slug = 'test-hotel-free'),
  'basic',
  'basic_test_ja',
  5,
  true,
  (SELECT id FROM users WHERE email = 'admin@test-free.com'),
  NOW(),
  NOW()
)
RETURNING id;

-- 翻訳作成（ja）
INSERT INTO faq_translations (faq_id, language, question, answer, created_at, updated_at)
VALUES (
  (SELECT id FROM faqs WHERE intent_key = 'basic_test_ja' AND facility_id = (SELECT id FROM facilities WHERE slug = 'test-hotel-free')),
  'ja',
  'テスト質問',
  'テスト回答',
  NOW(),
  NOW()
);
```

### Miniプラン施設の作成

```sql
-- 施設作成
INSERT INTO facilities (name, slug, email, plan_type, language_limit, is_active, created_at, updated_at)
VALUES ('Test Hotel Mini', 'test-hotel-mini', 'test-mini@example.com', 'Mini', 2, true, NOW(), NOW());

-- ユーザー作成
INSERT INTO users (facility_id, email, password_hash, full_name, role, is_active, created_at, updated_at)
VALUES (
  (SELECT id FROM facilities WHERE slug = 'test-hotel-mini'),
  'admin@test-mini.com',
  '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5GyY5Y5Y5Y5Y5',
  'Admin User',
  'admin',
  true,
  NOW(),
  NOW()
);

-- 既存FAQ作成（ja, en言語）
INSERT INTO faqs (facility_id, category, intent_key, priority, is_active, created_by, created_at, updated_at)
VALUES (
  (SELECT id FROM facilities WHERE slug = 'test-hotel-mini'),
  'basic',
  'basic_test_mini',
  5,
  true,
  (SELECT id FROM users WHERE email = 'admin@test-mini.com'),
  NOW(),
  NOW()
);

-- 翻訳作成（ja, en）
INSERT INTO faq_translations (faq_id, language, question, answer, created_at, updated_at)
VALUES
  ((SELECT id FROM faqs WHERE intent_key = 'basic_test_mini' AND facility_id = (SELECT id FROM facilities WHERE slug = 'test-hotel-mini')), 'ja', 'テスト質問', 'テスト回答', NOW(), NOW()),
  ((SELECT id FROM faqs WHERE intent_key = 'basic_test_mini' AND facility_id = (SELECT id FROM facilities WHERE slug = 'test-hotel-mini')), 'en', 'Test question', 'Test answer', NOW(), NOW());
```

## テスト実行時の注意事項

1. **ブラウザのコンソールを開く**: F12キーで開発者ツールを開き、エラーがないか確認
2. **ネットワークタブを確認**: APIリクエストのステータスコードとレスポンスを確認
3. **エラーメッセージの確認**: エラーメッセージが日本語で正しく表示されているか確認
4. **既存言語の確認**: エラーメッセージに既存の言語リストが正しく表示されているか確認

## トラブルシューティング

### バックエンドが起動しない場合

```bash
docker-compose logs backend
docker-compose restart backend
```

### フロントエンドが起動しない場合

```bash
docker-compose logs frontend
docker-compose restart frontend
```

### データベース接続エラーの場合

```bash
docker-compose restart postgres
docker-compose ps postgres  # healthy になっているか確認
```

### 最新のコードが反映されない場合

```bash
docker-compose build --no-cache backend frontend
docker-compose up -d backend frontend
```

## テスト完了後の確認事項

- [ ] すべてのテストケースが実行された
- [ ] エラーメッセージが正しく表示された
- [ ] 既存言語を使用する場合は成功した
- [ ] 新しい言語を追加しようとするとエラーが表示された
- [ ] Premiumプランでは無制限で言語を追加できた
- [ ] ブラウザコンソールにエラーがない

