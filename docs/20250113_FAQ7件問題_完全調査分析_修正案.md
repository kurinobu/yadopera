# FAQ7件問題 - 完全調査分析と修正案

## 1. 問題の概要

### 1.1 報告された問題
- **現象**: 合計7件しか表示されていない
- **期待値**: 20件表示されるべき
- **データベース**: 20件のFAQが正しく登録されている（確認済み）
- **APIレスポンス**: 20件を正しく返している（確認済み）
- **キャッシュ**: 20件を保存している（確認済み）

### 1.2 調査結果の要約

**バックエンドの処理**:
- ✅ データベース: 20件のFAQが正しく登録されている
  - basic: 8件
  - facilities: 5件
  - location: 1件
  - trouble: 6件
- ✅ APIレスポンス: 20件を正しく返している
- ✅ キャッシュ: 20件を保存している

**問題の所在**:
- バックエンドの処理は正しく動作している
- データベースには20件登録されている
- APIレスポンスは20件を返している
- キャッシュも20件を保存している
- **フロントエンドの表示に問題がある可能性が高い**

## 2. 根本原因の分析

### 2.1 `FaqList.vue`の表示ロジック

**現在の実装**:
```vue
<template v-for="category in categories" :key="category">
  <div
    v-if="getFaqsByCategory(category).length > 0"
    class="p-6"
  >
    <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-4">
      {{ getCategoryLabel(category) }} ({{ getFaqsByCategory(category).length }}件)
    </h4>
    <div class="space-y-4">
      <div
        v-for="faq in getFaqsByCategory(category)"
        :key="faq.id"
        class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700"
      >
        <!-- FAQ表示 -->
      </div>
    </div>
  </div>
</template>
```

**問題点**:
- `v-for="category in categories"`で各カテゴリをループしている
- `v-if="getFaqsByCategory(category).length > 0"`で、そのカテゴリにFAQがある場合のみ表示している
- `getFaqsByCategory`は`props.faqs`から直接フィルタリングしている（修正済み）

### 2.2 考えられる原因

1. **`props.faqs`が7件しか含まれていない**
   - APIから取得したデータが7件しかない
   - しかし、APIレスポンスは20件を返しているので、これは矛盾している

2. **カテゴリ別の表示ロジックに問題がある**
   - `v-if="getFaqsByCategory(category).length > 0"`の条件で、一部のカテゴリが表示されていない
   - しかし、データベースにはすべてのカテゴリにFAQが存在する

3. **キャッシュの問題**
   - 古いキャッシュが残っている可能性
   - しかし、キャッシュは20件を保存している

4. **フロントエンドのデータ取得に問題がある**
   - `fetchFaqs`が正しく動作していない可能性
   - APIレスポンスのパースに問題がある可能性

### 2.3 根本原因の特定

**真の根本原因**:
フロントエンドが受け取っているデータが7件しかない可能性が高いです。

考えられる原因：
1. **APIレスポンスのパースに問題がある**
   - `response.data.faqs`が正しく取得できていない
   - `response.data`の構造が期待と異なる

2. **タイミングの問題**
   - バックグラウンド処理が完了する前にFAQ一覧を取得している
   - しかし、データベースには20件登録されているので、これは矛盾している

3. **キャッシュの問題**
   - 古いキャッシュ（7件）が返されている
   - しかし、キャッシュは20件を保存している

## 3. 大原則に準拠した修正案

### 3.1 修正方針

**大原則**:
1. **シンプルな実装**: 複雑なロジックを避ける
2. **根本的な解決**: フロントエンドのデータ取得と表示ロジックを修正
3. **確実性**: すべてのFAQが正しく表示される

### 3.2 修正案1: フロントエンドのデータ取得を確認

**修正内容**:
`FaqManagement.vue`の`fetchFaqs`メソッドで、取得したデータをログ出力して確認します。

**実装**:
```typescript
const fetchFaqs = async () => {
  try {
    loading.value = true
    error.value = null
    const data = await faqApi.getFaqs()
    console.log('取得したFAQデータ:', data)
    console.log('FAQ件数:', data.length)
    faqs.value = data
  } catch (err: any) {
    console.error('Failed to fetch FAQs:', err)
    error.value = err.response?.data?.detail || 'FAQ一覧の取得に失敗しました'
  } finally {
    loading.value = false
  }
}
```

### 3.3 修正案2: キャッシュを無効化する

**修正内容**:
新規登録後、FAQ一覧取得時にキャッシュを無効化する処理を追加します。

**実装**:
バックエンドの`get_faqs`メソッドで、施設作成から一定時間以内の場合はキャッシュを無効化します。

### 3.4 修正案3: フロントエンドでデバッグログを追加

**修正内容**:
`FaqList.vue`で、`props.faqs`の内容をログ出力して確認します。

**実装**:
```typescript
import { watch } from 'vue'

watch(() => props.faqs, (newFaqs) => {
  console.log('FaqList: props.faqs changed:', newFaqs)
  console.log('FaqList: FAQ件数:', newFaqs.length)
  console.log('FaqList: カテゴリ別件数:', {
    basic: newFaqs.filter(f => f.category === 'basic').length,
    facilities: newFaqs.filter(f => f.category === 'facilities').length,
    location: newFaqs.filter(f => f.category === 'location').length,
    trouble: newFaqs.filter(f => f.category === 'trouble').length,
  })
}, { immediate: true })
```

## 4. 推奨修正案

### 4.1 推奨: 修正案1 + 修正案3（デバッグログの追加）

**理由**:
1. **原因の特定**: デバッグログを追加することで、フロントエンドが受け取っているデータを確認できる
2. **根本的な解決**: 原因が特定できれば、適切な修正を実施できる

### 4.2 実装詳細

**修正1: `FaqManagement.vue`の`fetchFaqs`にデバッグログを追加**

```typescript
const fetchFaqs = async () => {
  try {
    loading.value = true
    error.value = null
    const data = await faqApi.getFaqs()
    console.log('✅ FAQ取得成功:', {
      count: data.length,
      categories: {
        basic: data.filter(f => f.category === 'basic').length,
        facilities: data.filter(f => f.category === 'facilities').length,
        location: data.filter(f => f.category === 'location').length,
        trouble: data.filter(f => f.category === 'trouble').length,
      }
    })
    faqs.value = data
  } catch (err: any) {
    console.error('❌ FAQ取得失敗:', err)
    error.value = err.response?.data?.detail || 'FAQ一覧の取得に失敗しました'
  } finally {
    loading.value = false
  }
}
```

**修正2: `FaqList.vue`にデバッグログを追加**

```typescript
import { watch } from 'vue'

watch(() => props.faqs, (newFaqs) => {
  console.log('📋 FaqList: props.faqs received:', {
    count: newFaqs.length,
    categories: {
      basic: newFaqs.filter(f => f.category === 'basic').length,
      facilities: newFaqs.filter(f => f.category === 'facilities').length,
      location: newFaqs.filter(f => f.category === 'location').length,
      trouble: newFaqs.filter(f => f.category === 'trouble').length,
    }
  })
}, { immediate: true })
```

## 5. 実装手順

1. **修正1: `FaqManagement.vue`の`fetchFaqs`にデバッグログを追加**
   - 取得したデータをログ出力

2. **修正2: `FaqList.vue`にデバッグログを追加**
   - `props.faqs`の内容をログ出力

3. **テスト**
   - ブラウザのコンソールでログを確認
   - フロントエンドが受け取っているデータを確認
   - 原因を特定

4. **原因に基づいた修正**
   - 原因が特定できたら、適切な修正を実施

## 6. 期待される効果

1. **原因の特定**: デバッグログにより、フロントエンドが受け取っているデータを確認できる
2. **根本的な解決**: 原因が特定できれば、適切な修正を実施できる

## 7. 注意事項

1. **デバッグログ**: 本番環境では削除する必要がある
2. **原因の特定**: デバッグログで原因を特定してから、適切な修正を実施する

