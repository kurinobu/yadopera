# 404エラー・ステージング環境エラー完全調査分析報告書

**作成日時**: 2025年1月13日  
**調査対象**: 
1. ローカル環境での404エラー（`http://localhost:5173/api/v1/auth/register`）
2. ステージング環境でのCORS + Database Integrity Error

---

## 1. 404エラーの完全調査分析

### 1.1 エラー概要

**エラー内容**:
- URL: `http://localhost:5173/api/v1/auth/register`
- エラー: 404 Not Found

### 1.2 根本原因の確定

**確定事実**:
1. `http://localhost:5173` はフロントエンド（Vue.js）のURL
2. `/api/v1/auth/register` はバックエンド（FastAPI）のAPIエンドポイント
3. フロントエンドのURLに直接APIパスを指定すると、Vue Routerがそのパスを処理しようとする
4. Vue Routerには `/api/v1/auth/register` というルートが定義されていない
5. そのため、404エラー（NotFound）が発生する

**コードベース確認結果**:

```18:24:frontend/src/router/admin.ts
  {
    path: '/register',
    name: 'Register',
    component: () => import('@/views/admin/Register.vue'),
    meta: {
      layout: 'admin',
      requiresAuth: false
    }
  },
```

**正しいアクセス方法**:
- ✅ フロントエンドの登録ページ: `http://localhost:5173/register`
- ✅ バックエンドAPI（直接アクセス）: `http://localhost:8000/api/v1/auth/register`

**APIクライアント設定確認**:

```10:14:frontend/src/api/axios.ts
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:8000'

// Axiosインスタンス作成
const apiClient: AxiosInstance = axios.create({
  baseURL: `${API_BASE_URL}/api/v1`,
```

**結論**: 
- フロントエンドからAPIを呼び出す場合は、`/register`ページにアクセスし、そのページ内で`authApi.register()`を呼び出す
- 直接APIエンドポイントにアクセスする場合は、バックエンドのURL（`http://localhost:8000`）を使用する必要がある

### 1.3 修正内容の確認

**前のセッションでの修正内容**:
- `backend/app/api/v1/auth.py`: `/register`エンドポイントの実装と例外ハンドリング追加
- `backend/app/services/auth_service.py`: `_generate_unique_slug`メソッドの実装
- `frontend/src/router/admin.ts`: `/register`ルートの定義

**修正は正しく実装されている**: ✅

**404エラーの原因**:
- ユーザーが誤ったURLにアクセスしている（フロントエンドURL + APIパス）
- これは実装の問題ではなく、**使用方法の問題**

---

## 2. ステージング環境エラーの完全調査分析

### 2.1 エラー概要

**エラー1: CORS Policy Violation**
```
Access to XMLHttpRequest at 'https://yadopera-backend-staging.onrender.com/api/v1/auth/register' 
from origin 'https://yadopera-frontend-staging.onrender.com' has been blocked by CORS policy: 
No 'Access-Control-Allow-Origin' header is present on the requested resource.
```

**エラー2: Database Integrity Error**
```
sqlalchemy.exc.IntegrityError: duplicate key value violates unique constraint "idx_facilities_slug"
DETAIL: Key (slug)=(クリブロゲストハウス) already exists.
```

**HTTPステータス**: 500 Internal Server Error

### 2.2 根本原因の完全分析

#### 2.2.1 エラー発生順序（確定）

```
1. フロントエンド → POST /api/v1/auth/register リクエスト送信
   ↓
2. バックエンド → リクエスト受信、処理開始
   ↓
3. バックエンド → データベースへのINSERT実行
   ↓
4. PostgreSQL → UniqueViolationError発生
   原因: slug='クリブロゲストハウス' が既に存在
   ↓
5. SQLAlchemy → IntegrityError例外発生
   ↓
6. FastAPI → 例外ハンドリング（auth.pyのtry-exceptで捕捉）
   ↓
7. HTTPException発生 → 500エラー、CORSヘッダー未付与の可能性
   ↓
8. フロントエンド → CORSエラー表示（実際はDBエラーが原因）
```

#### 2.2.2 CORSエラーの真の原因

**確定**: CORSエラーは二次的な現象であり、本質的な原因ではない

**理由**:
1. バックエンドで500エラーが発生した場合、FastAPIの例外ハンドラーがCORSヘッダーを付与する前に処理が中断される可能性がある
2. CORSミドルウェアは正常応答時には機能するが、未ハンドリング例外時には機能しない場合がある
3. ブラウザは「CORSエラー」として表示するが、実際はバックエンドの500エラーが原因

**CORS設定の確認**:

```18:24:backend/app/main.py
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins_list,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

```24:30:backend/app/core/config.py
    # CORS (comma-separated string to List[str])
    cors_origins: str = "http://localhost:5173,http://localhost:3000"
    
    @property
    def cors_origins_list(self) -> List[str]:
        """CORS originsをリストに変換"""
        return [origin.strip() for origin in self.cors_origins.split(",")]
```

**問題点**:
- デフォルト設定にステージング環境のURLが含まれていない
- Render.comの環境変数で`CORS_ORIGINS`が正しく設定されているか確認が必要

#### 2.2.3 Database Integrity Error の原因

**確定事実**:
```sql
INSERT INTO facilities (name, slug, ...) 
VALUES ('クリブロゲストハウス', 'クリブロゲストハウス', ...)
```

**制約違反**:
```20:20:backend/app/models/facility.py
    slug = Column(String(100), unique=True, nullable=False, index=True)  # URL用識別子
```

**エラーログから判明した事実**:
- slugが「クリブロゲストハウス」という日本語のまま使用されている
- これは**古いコード**がステージング環境で実行されていることを示している

**現在のコードベース確認**:

```28:65:backend/app/services/auth_service.py
    @staticmethod
    async def _generate_unique_slug(db: AsyncSession, base_name: str) -> str:
        """
        URLセーフなユニークslugを生成
        
        Args:
            db: データベースセッション
            base_name: 施設名
        
        Returns:
            str: ユニークなslug
        """
        import uuid
        import re
        
        # 施設名を英数字に変換（日本語は削除）
        slug_base = re.sub(r'[^\w\s-]', '', base_name.lower())
        slug_base = re.sub(r'[-\s]+', '-', slug_base).strip('-')
        
        # 英数字が存在しない場合はデフォルト値を使用
        if not slug_base or len(slug_base) < 1:
            slug_base = "facility"
        
        # 最大20文字に制限
        slug_base = slug_base[:20]
        
        # UUIDの先頭8文字を付与
        unique_id = str(uuid.uuid4())[:8]
        slug = f"{slug_base}-{unique_id}"
        
        # 念のため重複チェック（UUID使用時はほぼ不要だが安全のため）
        result = await db.execute(
            select(Facility).where(Facility.slug == slug)
        )
        if result.scalar_one_or_none() is not None:
            # 万が一重複した場合はUUID全体を使用
            slug = f"{slug_base}-{str(uuid.uuid4())}"
        
        return slug
```

```206:213:backend/app/services/auth_service.py
        # 施設作成
        facility = Facility(
            name=request.facility_name,
            slug=await AuthService._generate_unique_slug(db, request.facility_name),
            email=request.email,
            subscription_plan=request.subscription_plan
        )
        db.add(facility)
        await db.flush()  # facility_idを取得
```

**確定**: ローカルコードベースには正しいslug生成ロジックが実装されている

**問題**: ステージング環境では古いコードが実行されている可能性が高い

---

## 3. 修正案（大原則準拠）

### 3.1 404エラーへの対応

**修正不要**: 実装は正しく、使用方法の問題

**対応策**:
- ユーザーに正しいURL（`http://localhost:5173/register`）を案内
- または、フロントエンドで`/api/v1/*`パスへのアクセスを検出し、適切なエラーメッセージを表示

### 3.2 ステージング環境エラーへの対応

#### 3.2.1 根本解決: ステージング環境への最新コードデプロイ

**方針**: 
1. ローカルの最新コード（slug生成ロジック含む）をステージング環境にデプロイ
2. CORS設定の環境変数を確認・修正

**実装ステップ**:

1. **CORS設定の確認・修正**

**backend/app/core/config.py の修正**:

```python
# CORS (comma-separated string to List[str])
cors_origins: str = Field(
    default="http://localhost:5173,http://localhost:3000,https://yadopera-frontend-staging.onrender.com,https://yadopera.com",
    description="CORS許可オリジン（カンマ区切り）"
)
```

2. **Render.com環境変数の確認**

**確認項目**:
- `CORS_ORIGINS`環境変数に`https://yadopera-frontend-staging.onrender.com`が含まれているか
- 環境変数の形式: `http://localhost:5173,http://localhost:3000,https://yadopera-frontend-staging.onrender.com,https://yadopera.com`

3. **例外ハンドリングの改善（既に実装済み）**

```49:77:backend/app/api/v1/auth.py
    try:
        return await AuthService.register_facility(db, request)
    except IntegrityError as e:
        # データベース制約違反のハンドリング
        error_str = str(e.orig) if hasattr(e, 'orig') else str(e)
        if "idx_facilities_slug" in error_str:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="施設の登録に失敗しました。同じ施設名が既に登録されている可能性があります。"
            )
        elif "idx_facilities_email" in error_str or "email" in error_str.lower():
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="このメールアドレスは既に登録されています。"
            )
        else:
            raise HTTPException(
                status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
                detail="施設の登録中にエラーが発生しました。"
            )
    except HTTPException:
        # HTTPExceptionはそのまま再発生
        raise
    except Exception as e:
        # その他の例外
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"予期しないエラーが発生しました: {str(e)}"
        )
```

**問題点**: 
- 例外ハンドリングは実装されているが、CORSヘッダーが付与されない可能性がある
- FastAPIの例外ハンドラーでCORSヘッダーが確実に付与されるようにする必要がある

#### 3.2.2 CORSヘッダー確実付与の改善

**backend/app/main.py の修正案**:

```python
@app.exception_handler(HTTPException)
async def http_exception_handler(request: Request, exc: HTTPException):
    """
    HTTPExceptionエラーハンドラー
    アーキテクチャ設計書の標準エラーフォーマットに準拠
    CORSヘッダーを確実に付与
    """
    # エラーコードのマッピング
    error_code_map = {
        status.HTTP_401_UNAUTHORIZED: "UNAUTHORIZED",
        status.HTTP_403_FORBIDDEN: "FORBIDDEN",
        status.HTTP_404_NOT_FOUND: "NOT_FOUND",
        status.HTTP_400_BAD_REQUEST: "BAD_REQUEST",
        status.HTTP_429_TOO_MANY_REQUESTS: "RATE_LIMIT_EXCEEDED",
        status.HTTP_503_SERVICE_UNAVAILABLE: "SERVICE_UNAVAILABLE",
    }
    
    error_code = error_code_map.get(exc.status_code, "INTERNAL_ERROR")
    
    # CORSヘッダーを確実に付与
    origin = request.headers.get("origin")
    headers = {}
    if origin and origin in settings.cors_origins_list:
        headers["Access-Control-Allow-Origin"] = origin
        headers["Access-Control-Allow-Credentials"] = "true"
    
    return JSONResponse(
        status_code=exc.status_code,
        content={
            "error": {
                "code": error_code,
                "message": exc.detail,
                "details": {}
            }
        },
        headers=headers
    )
```

#### 3.2.3 データベース制約違反時のエラーメッセージ改善

**backend/app/api/v1/auth.py の改善案**:

```python
except IntegrityError as e:
    # データベース制約違反のハンドリング
    error_str = str(e.orig) if hasattr(e, 'orig') else str(e)
    if "idx_facilities_slug" in error_str:
        # slug重複エラー（既に実装済みのslug生成ロジックで発生しないはずだが、念のため）
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="施設の登録に失敗しました。システムエラーが発生しました。しばらく時間をおいて再度お試しください。"
        )
    elif "idx_facilities_email" in error_str or "email" in error_str.lower():
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="このメールアドレスは既に登録されています。"
        )
    else:
        # その他の制約違反
        logger.error(f"Database integrity error: {error_str}")
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail="施設の登録中にエラーが発生しました。"
        )
```

---

## 4. 修正手順（指示待ち）

### 4.1 実装ステップ

1. **CORS設定の確認・修正**
   - `backend/app/core/config.py`: デフォルト値にステージング環境URLを追加
   - Render.com環境変数: `CORS_ORIGINS`の確認・修正

2. **例外ハンドラーの改善**
   - `backend/app/main.py`: HTTPExceptionハンドラーでCORSヘッダーを確実に付与

3. **ステージング環境へのデプロイ**
   - 最新コードを`develop`ブランチにプッシュ
   - Render.comで自動デプロイを確認

4. **テスト項目**
   - [ ] 新規施設登録（日本語名）→ 成功
   - [ ] 重複施設名での登録 → 成功（異なるslug）
   - [ ] メールアドレス重複 → 400エラー、適切なエラーメッセージ
   - [ ] CORSエラーが発生しないことを確認
   - [ ] 生成されたslugがURLセーフであることを確認

### 4.2 404エラーへの対応

**修正不要**: 実装は正しく、使用方法の問題

**ドキュメント化推奨**:
- README.mdに正しいアクセス方法を記載
- または、フロントエンドで`/api/v1/*`パスへのアクセスを検出し、適切なエラーメッセージを表示

---

## 5. 結論

### 5.1 404エラーの原因（確定）

1. **原因**: ユーザーが誤ったURL（フロントエンドURL + APIパス）にアクセス
2. **実装**: 正しく実装されている
3. **対応**: 使用方法の案内またはエラーメッセージの改善

### 5.2 ステージング環境エラーの原因（確定）

1. **主原因**: ステージング環境で古いコード（slug生成ロジック未実装）が実行されている
2. **副次的原因**: CORS設定が不十分、または例外ハンドラーでCORSヘッダーが付与されない

### 5.3 推奨修正方針

- **根本解決**: 最新コードをステージング環境にデプロイ
- **安全対策**: CORS設定の確認・修正、例外ハンドラーの改善

### 5.4 参照文書

- 要約定義書v0.3.9（大原則準拠）
- アーキテクチャ設計書v0.3.7
- 引き継ぎ書（2025-12-29）

---

**指示があるまで修正を保留します。修正実施の指示をお待ちしております。**

