# Phase 1 ステップ計画（2025-12-01）

**作成日**: 2025年12月1日  
**対象**: Phase 1（MVP開発）完了のためのステップ計画  
**目的**: 経緯・現在地点・今後の予定・大原則を把握し、具体的なステップ計画を提示  
**状態**: 指示があるまで修正しない

---

## 1. 経緯と現在地点

### 1.1 プロジェクト経緯

**やどぺら**は、小規模宿泊施設向け外国人ゲスト対応自動化SaaSです。

**開発フェーズ**:
- **Phase 0（準備期間）**: 90.9%完了
  - 開発環境構築完了 ✅
  - ランディングページ作成・デプロイ完了 ✅
  - やどびと多言語優先度アンケート実施完了 ✅
  - ステップ10-2〜10-6未実施（Vercelデプロイ、Google Analytics設定）⚠️
- **Phase 1（MVP開発）**: 約97%完了
  - Week 1-3: 100%完了 ✅
  - Week 4: 約97%完了 ⚠️
    - API実装完了 ✅
    - テストコード作成完了 ✅
    - ステージング環境構築・デプロイ完了 ✅（2025-11-29）
    - テスト実行: 20テストがパス（68.9%）、9テストが失敗（残存課題）⚠️

### 1.2 現在地点（2025-12-01時点）

**完了した項目**:
- ✅ Week 1: バックエンド基盤構築完了
- ✅ Week 2: AI対話エンジン実装完了
- ✅ Week 3: フロントエンド実装完了
- ✅ Week 4 API実装完了（6つのAPI）
  - ゲストフィードバックAPI
  - ダッシュボードAPI
  - FAQ管理API
  - FAQ自動学習API
  - 夜間対応キューAPI
  - QRコード生成API
- ✅ Week 4テストコード作成完了（12ファイル）
- ✅ Week 4最適化・エラーハンドリング完了
- ✅ Railway PostgreSQL作成完了
- ✅ Railway pgvector拡張有効化完了（2025-11-29）
- ✅ Railway Redis作成完了
- ✅ Render.com Web Service作成完了
- ✅ Render.com 環境変数設定完了
- ✅ Render.com デプロイ成功（2025-11-29）
- ✅ ステージング環境動作確認完了（2025-11-29）
- ✅ Event loopエラー修正完了（2025-12-01）
- ✅ 認証エラー修正完了（2025-12-01）

**残存課題**:
- ⚠️ 残存テストの修正（9テスト、一部完了）
  - `test_auth.py`関連（2テスト） - レスポンス形式の問題
  - `test_integration.py::TestResponseTime`（1テスト） - パフォーマンステスト（3.51秒 > 3秒）
  - `test_session_token.py`関連（6テスト） - データベースモデルの問題
- ⏳ ドキュメント更新（実装中）

**Phase 1全体完了率**: **約97%**（2025-12-01更新）

**最新の進捗**（2025-12-01）:
- ✅ Event loopエラー修正完了（AsyncClientへの移行）
- ✅ 認証エラー修正完了（JWTの`sub`フィールドを文字列に変換）
- ✅ 20テストがパス（68.9%）
- ⚠️ 9テストが失敗（残存課題）

---

## 2. 大原則の確認

### 2.1 プロジェクトの大原則

1. **段階的拡大戦略**
   - Phase 1: 京都・大阪・東京（100-150施設）
   - Phase 2: +福岡・沖縄（+80-120施設）
   - Phase 3: +北海道・金沢・広島（+100-150施設）
   - 長期: 全国展開（500-700施設）

2. **品質重視**
   - PoC施設数: 3施設に絞り込み（5-7施設から削減）
   - 一人開発の現実的対応
   - 深いフィードバック収集が可能

3. **コスト効率**
   - RAG統合によるコスト削減（48%削減、¥0.033/質問）
   - 月100件/施設: ¥3.3/月

4. **安全第一**
   - 安全カテゴリ強制エスカレーション（医療・避難情報は閾値無視で即エスカレーション）
   - 夜間対応設計（翌朝対応予約、自動返信、8:00一括通知）

5. **自動化推進**
   - FAQ自動学習機能（MVP前倒し実装）
   - ゲストフィードバック連動（低評価回答の自動ハイライト）
   - セッション統合トークン（4桁コードでデバイス間会話履歴を統合）

6. **ブランチ戦略とデプロイ戦略**
   - オプション2採用（サブドメインでのテストURL作成）
   - ステージング環境: Railway Hobby（PostgreSQL + Redis、契約済み）
   - 本番環境: Render.com（PostgreSQL Managed + Redis Cloud）
   - ブランチ構成: `main`（本番）、`develop`（ステージング）、`feature/*`（開発）

---

## 3. 今後の予定

### 3.1 Phase 1完了（残存課題対応）

**残存課題**:
1. **残存テストの修正**（9テスト、1-2時間）
   - `test_auth.py`関連（2テスト） - レスポンス形式の問題
   - `test_integration.py::TestResponseTime`（1テスト） - パフォーマンステスト（3.51秒 > 3秒）
   - `test_session_token.py`関連（6テスト） - データベースモデルの問題
2. **ドキュメント更新**（1時間）
   - Phase 1完了の記録
   - 次のフェーズへの引き継ぎ準備

**完了条件**:
- ✅ すべてのテストがパスする（エラーなし、失敗なし）
- ✅ テストカバレッジが60%以上
- ✅ pgvector検索テストが正常に動作する
- ✅ 統合テストが正常に動作する
- ✅ テスト結果が記録されている

### 3.2 Phase 2: PoC準備（2週間）

**内容**:
- やどびとユーザーへのメールDM作成・送信
- オンライン説明会準備（Zoom、週1回×4週間）
- PoC施設選定（3施設、品質重視）
- 初期FAQ作成支援
- 利用マニュアル作成
- 専用Slackチャンネル作成

### 3.3 Phase 3: PoC実施（3ヶ月）

**内容**:
- 3施設同時スタート
- 週次ヒアリング（30分×3施設）
- FAQ最適化（自動学習機能活用）
- ゲストフィードバックデータ分析
- バグ修正・機能改善
- 成功事例の記録
- 有料転換率測定

### 3.4 Phase 4: 本格展開準備（1ヶ月）

**内容**:
- PoC結果を反映した機能改善
- 本番環境構築・デプロイ（Render.com）
  - 本番環境設定（環境変数、データベース接続）
  - Render.com PostgreSQL（Managed）作成
  - Redis Cloud設定
  - カスタムドメイン設定（yadopera.com）
  - SSL証明書設定
  - 本番環境デプロイ確認
- 決済機能実装（Stripe連携）
- 多言語対応（アンケート結果に基づく優先言語）
- Slack/LINE通知連携
- 地域拡大準備（福岡・沖縄）

---

## 4. 設定状況・環境

### 4.1 開発環境

**ローカル環境**:
- Docker & Docker Compose
- PostgreSQL 15（pgvector拡張）
- Redis 7.2
- Backend: FastAPI（http://localhost:8000）
- Frontend: Vue.js 3（http://localhost:5173）

### 4.2 ステージング環境

**データベース**:
- **サービス**: Railway Hobby PostgreSQL（pgvector-pg18）
- **バージョン**: PostgreSQL 18.1
- **拡張**: pgvector 0.8.1（有効化済み）
- **接続URL**: Railwayダッシュボードから取得

**Redis**:
- **サービス**: Railway Hobby Redis
- **接続URL**: Railwayダッシュボードから取得

**バックエンド**:
- **サービス**: Render.com Web Service（`yadopera-backend-staging`）
- **URL**: `https://yadopera-backend-staging.onrender.com`
- **ブランチ**: `develop`
- **ステータス**: ✅ デプロイ成功（2025-11-29）

### 4.3 本番環境（Phase 4で構築予定）

**データベース**:
- **サービス**: Render.com PostgreSQL（Managed）
- **Redis**: Redis Cloud（External）

**バックエンド**:
- **サービス**: Render.com Web Service
- **ブランチ**: `main`
- **URL**: `https://yadopera.com`（予定）

### 4.4 ブランチ戦略

**ブランチ構成**:
- `main`: 本番環境用ブランチ
- `develop`: ステージング環境用ブランチ（現在のブランチ）
- `feature/*`: 機能開発用ブランチ

**デプロイフロー**:
1. `feature/*` → `develop`（マージ）
2. `develop` → Render.com ステージング環境（自動デプロイ）
3. テスト完了後、`develop` → `main`（マージ）
4. `main` → Render.com 本番環境（自動デプロイ）

---

## 5. ステップ計画

### 5.1 最優先ステップ（Phase 1完了に必須）

#### ステップ1: 残存テストの調査と修正（1-2時間）

**目的**: 9テストの失敗原因を特定し、修正を実施して100%パスを達成

**内容**:
1. 失敗した9テストの詳細なエラーログを確認
2. テストコードの修正が必要か判断
3. 必要に応じて修正を実施

**具体的な作業**:
- `test_auth.py`のレスポンス形式の期待値を修正
- `test_session_token.py`のデータベースモデルの問題を調査・修正
- `test_integration.py::TestResponseTime`のパフォーマンステストの閾値を調整

**確認項目**:
- [ ] 失敗した9テストのエラーログを確認
- [ ] テストコードの修正が必要か判断
- [ ] 修正を実施
- [ ] すべてのテストがパスすることを確認

**参考**:
- `docs/Phase1/Phase1_ステージング環境テスト結果_20251201.md`
- `docs/Phase1/Phase1_次のステップ_推奨案_20251201.md`

---

#### ステップ2: 完全なテスト実行（30分）

**目的**: Phase 1完了条件の「ステージング環境でのテスト実行・パス確認」を達成

**内容**:
1. すべてのテストファイルを実行
2. すべてのテストがパスすることを確認
3. テスト結果を記録

**実行コマンド**:
```bash
cd /Users/kurinobu/projects/yadopera/backend
export TEST_DATABASE_URL="postgresql+asyncpg://postgres:uhk62qgfrro7wu2s4et6dgd84563qg1k@tramway.proxy.rlwy.net:50673/railway"
export REDIS_URL="redis://default:QIpOCNjyhqyHYoaGBUWWaALyuWmVGYjd@shuttle.proxy.rlwy.net:28858"
export USE_POSTGRES_TEST="true"
export USE_OPENAI_MOCK="true"
export SECRET_KEY="test-secret-key-for-staging-tests-minimum-32-characters-long"
export CORS_ORIGINS="http://localhost:5173"

pytest tests/ -v
```

**確認項目**:
- [ ] すべてのテストがパスすることを確認
- [ ] テストカバレッジが60%以上であることを確認
- [ ] pgvector検索テストが正常に動作することを確認
- [ ] 統合テストが正常に動作することを確認
- [ ] テスト結果を記録

**完了条件**:
1. ✅ すべてのテストがパスする（エラーなし、失敗なし）
2. ✅ テストカバレッジが60%以上
3. ✅ pgvector検索テストが正常に動作する
4. ✅ 統合テストが正常に動作する
5. ✅ テスト結果が記録されている

**参考**:
- `docs/Phase1/Phase1_ステージング環境テスト計画.md`
- `docs/Phase1/Phase1_ステージング環境テスト結果_20251201.md`

---

### 5.2 高優先度ステップ（Phase 1完了に推奨）

#### ステップ3: ドキュメント更新（1時間）

**目的**: Phase 1完了の記録と次のフェーズへの引き継ぎ準備

**内容**:
1. `docs/Phase1/Phase1_Week4_実装状況.md`を更新
   - ステージング環境構築・デプロイ完了を反映
   - 動作確認完了を反映
   - テスト実行・パス確認完了を反映
2. `docs/Phase1/Phase1_引き継ぎ書.md`を作成（または更新）
   - Phase 1完了を反映
   - ステージング環境の情報を記載
     - Railway PostgreSQL接続情報（機密情報は環境変数参照を記載）
     - Railway Redis接続情報（機密情報は環境変数参照を記載）
     - Render.com Web Service URL
   - 次のフェーズ（Phase 2）への準備事項を記載

**確認項目**:
- [ ] Phase 1 Week 4実装状況ドキュメント更新完了
- [ ] Phase 1引き継ぎ書作成（または更新）完了
- [ ] ステージング環境の情報を記載完了

**参考**:
- `docs/Phase1/Phase1_残存課題_完了条件_進捗状況_20251129.md`
- `docs/Phase1/Phase1_完了準備_実行ステップ.md`

---

### 5.3 推奨ステップ（Phase 1完了に推奨）

#### ステップ4: イベントループエラーの完全解決（30分-1時間）

**目的**: イベントループエラーの警告を完全に解消

**内容**:
1. `db_session`フィクスチャのクリーンアップ処理を改善
2. イベントループのライフサイクル管理を改善
3. クリーンアップ時の警告を解消

**確認項目**:
- [ ] イベントループエラーの警告を完全に解消
- [ ] テスト実行時の警告を最小化

**参考**:
- `docs/Phase1/Phase1_Event_loopエラー修正_実装完了レポート_20251201.md`
- `docs/Phase1/Phase1_Week4_非同期接続クリーンアップ改善_実装完了レポート.md`

---

## 6. 完了条件

### 6.1 Phase 1完了の必須条件

Phase 1が完了するためには、以下がすべて完了している必要があります：

1. **Week 1-3の完了** ✅
   - Week 1: バックエンド基盤構築完了
   - Week 2: AI対話エンジン実装完了
   - Week 3: フロントエンド実装完了

2. **Week 4のAPI実装完了** ✅
   - ゲストフィードバックAPI
   - ダッシュボードAPI
   - FAQ管理API
   - FAQ自動学習API
   - 夜間対応キューAPI
   - QRコード生成API

3. **Week 4のテストコード作成完了** ✅
   - Week 2のテストコード作成
   - 統合テスト・E2Eテスト実装

4. **Week 4の最適化・エラーハンドリング完了** ✅
   - レスポンス速度最適化
   - エラーハンドリング強化

5. **ステージング環境構築・デプロイ完了** ⚠️ **一部完了**
   - Railway PostgreSQL作成完了 ✅
   - Railway pgvector拡張有効化完了 ✅
   - Railway Redis作成完了 ✅
   - Render.com Web Service作成完了 ✅
   - Render.com 環境変数設定完了 ✅
   - Render.com デプロイ成功 ✅
   - ステージング環境動作確認完了 ✅
   - **テスト実行・パス確認完了** ❌ **未完了**
     - **完了条件**:
       - ✅ すべてのテストがパスする（エラーなし、失敗なし）
       - ✅ テストカバレッジが60%以上
       - ✅ pgvector検索テストが正常に動作する
       - ✅ 統合テストが正常に動作する
       - ✅ テスト結果が記録されている

6. **ドキュメント更新完了** ⏳
   - **完了条件**:
     - ✅ Phase 1 Week 4実装状況ドキュメント更新完了
     - ✅ Phase 1引き継ぎ書作成（または更新）完了
     - ✅ ステージング環境の情報を記載完了

**これらすべてが完了し、テストを実行してパスして初めてPhase 1は100%完了です。**

---

## 7. 実行順序の推奨

### 7.1 最優先（Phase 1完了に必須）

1. **ステップ1**: 残存テストの調査と修正（1-2時間）
2. **ステップ2**: 完全なテスト実行（30分）

### 7.2 高優先度（Phase 1完了に推奨）

3. **ステップ3**: ドキュメント更新（1時間）

### 7.3 推奨（Phase 1完了に推奨）

4. **ステップ4**: イベントループエラーの完全解決（30分-1時間）

---

## 8. 各ステップの工数見積もり

| ステップ | 工数 | 累計工数 | 優先度 |
|---------|------|---------|--------|
| ステップ1: 残存テストの調査と修正 | 1-2時間 | 1-2時間 | 最高 |
| ステップ2: 完全なテスト実行 | 30分 | 1.5-2.5時間 | 最高 |
| ステップ3: ドキュメント更新 | 1時間 | 2.5-3.5時間 | 高 |
| ステップ4: イベントループエラーの完全解決 | 30分-1時間 | 3-4.5時間 | 推奨 |

**合計**: 約3-4.5時間（Phase 1完了に必須のステップ1-2は約1.5-2.5時間）

---

## 9. 参考資料

### 9.1 主要ドキュメント

- **要約定義書**: `docs/Summary/yadopera-v03-summary.md`
- **アーキテクチャ設計書**: `docs/Architecture/やどぺら_v0.3_アーキテクチャ設計書.md`
- **Phase 0引き継ぎ書**: `docs/Phase0_引き継ぎ書.md`
- **Phase 1 Week 4ステップ計画**: `docs/Phase1/Phase1_Week4_ステップ計画.md`
- **Phase 1ステージング環境テスト計画**: `docs/Phase1/Phase1_ステージング環境テスト計画.md`
- **Phase 1ステージング環境テスト結果**: `docs/Phase1/Phase1_ステージング環境テスト結果_20251201.md`
- **Phase 1残存課題・完了条件・進捗状況**: `docs/Phase1/Phase1_残存課題_完了条件_進捗状況_20251129.md`
- **Phase 1次のステップ推奨案**: `docs/Phase1/Phase1_次のステップ_推奨案_20251201.md`

### 9.2 実装参考セクション

- アーキテクチャ設計書 8.2 RESTful API エンドポイント一覧
- アーキテクチャ設計書 8.3 APIリクエスト・レスポンス詳細
- アーキテクチャ設計書 14. デプロイメント
- アーキテクチャ設計書 15. パフォーマンス要件

---

## 10. まとめ

### 10.1 現在の状態

**Phase 1全体完了率**: **約97%**（2025-12-01更新）

**完了した項目**:
- ✅ Week 1-3完了（100%）
- ✅ Week 4 API実装完了（100%）
- ✅ Week 4テストコード作成完了（100%）
- ✅ Week 4最適化・エラーハンドリング完了（100%）
- ✅ ステージング環境構築・デプロイ完了（90.9%）
- ⚠️ テスト実行・パス確認（一部完了、20/29テストがパス）

**残存課題**:
- ⚠️ 残存テストの修正（9テスト、1-2時間）
- ⏳ ドキュメント更新（1時間）

### 10.2 次のステップ

**最優先（Phase 1完了に必須）**:
1. 残存テストの調査と修正（1-2時間）
2. 完全なテスト実行（30分）

**高優先度（Phase 1完了に推奨）**:
3. ドキュメント更新（1時間）

**推奨（Phase 1完了に推奨）**:
4. イベントループエラーの完全解決（30分-1時間）

### 10.3 完了条件

**Phase 1が100%完了するためには**:
1. Week 1-3完了 ✅
2. Week 4 API実装完了 ✅
3. Week 4テストコード作成完了 ✅
4. Week 4最適化・エラーハンドリング完了 ✅
5. **ステージング環境構築・デプロイ完了** ⚠️ **一部完了**
   - **テスト実行・パス確認完了** ❌ **未完了**
6. ドキュメント更新完了 ⏳

**これらすべてが完了し、テストを実行してパスして初めてPhase 1は100%完了です。**

---

**Document Version**: v1.0  
**Author**: Auto (AI Assistant)  
**Last Updated**: 2025-12-01  
**Status**: ✅ ステップ計画確定（指示があるまで修正しない）


