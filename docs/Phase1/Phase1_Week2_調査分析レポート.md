# Phase 1 Week 2 調査分析レポート

**作成日**: 2025年11月27日  
**対象**: Phase 1 Week 2（AI対話エンジン）実装前調査分析  
**判断基準**: 要約定義書 v0.3.3 および アーキテクチャ設計書 v0.3

---

## 1. 調査サマリー

### 調査目的

Phase 1 Week 2で実装するAI対話エンジン（RAG統合型）について、以下を調査・分析する：

1. 実装範囲の明確化
2. 技術的依存関係の確認
3. 実装上の課題・リスクの特定
4. 実装順序の最適化

### 調査結果サマリー

| カテゴリ | 状況 | 詳細 |
|---------|------|------|
| 実装範囲 | ✅ **明確** | 要約定義書・アーキテクチャ設計書で詳細化済み |
| 技術的依存関係 | ✅ **確認済み** | Week 1で基盤構築完了、Week 2で追加実装 |
| 実装上の課題 | ⚠️ **軽微** | タイムゾーン処理、pgvectorインデックス最適化 |
| 実装順序 | ✅ **最適化済み** | 基盤→RAG→エスカレーション→統合の順序 |

---

## 2. 実装範囲の明確化

### 2.1 Week 2で実装する機能

#### コア機能

1. **OpenAI API 統合**
   - GPT-4o mini（回答生成）
   - text-embedding-3-small（埋め込み生成）
   - エラーハンドリング（タイムアウト、レート制限、API障害）

2. **RAG実装**
   - 埋め込みベクトル生成（1536次元）
   - pgvector検索（コサイン類似度、Top 3 FAQ取得）
   - コンテキスト構築（約600トークン）
   - IVFFlatインデックス使用

3. **信頼度スコア計算（v0.3改善版）**
   - ベーススコア: 0.7
   - FAQ類似度ボーナス（0.8以上: +0.3、0.7以上: +0.15）
   - 回答長ペナルティ（20文字未満: -0.2）
   - 不確実性ワード検出（maybe等: -0.15）
   - **質問具体性スコア（固有名詞・数値: +0.1）★新規**
   - **過去同一質問解決率（80%以上: +0.15）★新規**
   - **施設カスタムFAQヒット（+0.2）★新規**

4. **安全カテゴリ強制エスカレーション**
   - 医療関連キーワード検出（即エスカレーション）
   - 安全・避難関連キーワード検出（即エスカレーション）
   - 多言語対応（英語・日本語）

5. **夜間対応キュー**
   - 夜間時間帯判定（22:00-8:00、施設タイムゾーン基準）
   - 自動返信メッセージ送信（英語・日本語）
   - 翌朝8:00一括通知（MVP期間中は手動実行または外部cron）

6. **フォールバック文言**
   - OpenAI API障害時のフォールバックメッセージ
   - 多言語対応（英語・日本語）
   - 宿側ログ記録

### 2.2 Week 2で追加するデータベーステーブル

1. **faqs**
   - FAQテーブル（埋め込みベクトル含む）
   - `embedding vector(1536)`型
   - IVFFlatインデックス

2. **escalations**
   - エスカレーションテーブル
   - エスカレーション記録

3. **escalation_schedules**
   - エスカレーションスケジュールテーブル
   - 時間帯・曜日・言語別の自動切り替え

4. **overnight_queue**
   - 夜間対応キューテーブル
   - 翌朝8:00一括通知

5. **question_patterns**
   - 質問パターン解決率テーブル
   - `pattern_embedding vector(1536)`型
   - 信頼度スコア計算で使用

6. **guest_feedback**
   - ゲストフィードバックテーブル
   - Week 3で使用、Week 2で準備

### 2.3 Week 2で実装するAPIエンドポイント

1. **POST `/api/v1/chat`**
   - チャットメッセージ送信
   - RAG統合型AI対話エンジン呼び出し
   - エスカレーション処理
   - 夜間対応キュー処理

2. **GET `/api/v1/chat/history/{session_id}`**
   - 会話履歴取得
   - セッションID検証

---

## 3. 技術的依存関係の確認

### 3.1 Week 1で構築済みの基盤

- ✅ FastAPI プロジェクト構造
- ✅ PostgreSQL 接続（pgvector拡張対応）
- ✅ Redis環境構築
- ✅ JWT認証システム
- ✅ 基本テーブル（users, facilities, conversations, messages, session_tokens）
- ✅ エラーハンドリング基盤

### 3.2 Week 2で追加する依存関係

#### Pythonライブラリ

- `openai`: OpenAI APIクライアント
- `pgvector`: pgvector拡張（既にインストール済み）
- `pytz`: タイムゾーン処理（夜間対応キュー用）

#### データベース拡張

- `pgvector`: ベクトル検索（既に有効化済み）
- IVFFlatインデックス: ベクトル検索の高速化

#### 外部API

- OpenAI API: GPT-4o mini、text-embedding-3-small

### 3.3 依存関係の確認結果

| 依存関係 | 状況 | 備考 |
|---------|------|------|
| OpenAI API | ✅ **準備済み** | APIキー設定済み（Phase 0完了） |
| pgvector拡張 | ✅ **有効化済み** | Phase 0で有効化確認済み |
| Pythonライブラリ | ⚠️ **追加必要** | `openai`、`pytz`を追加 |
| データベーステーブル | ⚠️ **追加必要** | Week 2でマイグレーション作成 |

---

## 4. 実装上の課題・リスクの特定

### 4.1 技術的課題

#### 課題1: タイムゾーン処理の複雑性

**問題**:
- 夜間対応キューは施設のタイムゾーン基準で時刻判定が必要
- UTC保存・ローカル表示の変換が必要

**対策**:
- `pytz`ライブラリを使用
- 施設テーブルに`timezone`カラム追加（デフォルト: 'Asia/Tokyo'）
- UTC保存・ローカル表示の統一ルールを定義

**実装方針**:
- `OvernightQueueService`でタイムゾーン変換を実装
- 施設タイムゾーン基準で翌朝8:00計算
- UTCに変換して保存

#### 課題2: pgvectorインデックス最適化

**問題**:
- IVFFlatインデックスの作成にはサンプルデータが必要
- インデックス作成タイミングの決定が必要

**対策**:
- MVP期間中はインデックスなしで開始（後で最適化）
- Phase 2でIVFFlatインデックス作成（サンプルデータ蓄積後）

**実装方針**:
- Week 2ではインデックスなしで実装
- コサイン類似度計算は正しく実装
- Phase 2でインデックス最適化

#### 課題3: 過去解決率取得のコスト

**問題**:
- 信頼度スコア計算で過去解決率取得のため、pgvector検索が必要
- 追加の埋め込み生成・検索でコスト増加の可能性

**対策**:
- 質問パターンテーブルにキャッシュ
- 類似度閾値を0.85に設定（高精度マッチング）
- Top 1のみ取得（コスト削減）

**実装方針**:
- `question_patterns`テーブルで解決率をキャッシュ
- 類似度0.85以上のみを同一パターンと判定
- コスト増加は最小限に抑制

### 4.2 ビジネスロジック上の課題

#### 課題1: 安全カテゴリ判定の精度

**問題**:
- キーワードベースの判定は誤検出の可能性がある
- 例: "hospital"という単語が含まれていても、実際は病院への道順を聞いているだけ

**対策**:
- MVP期間中はキーワードベースで実装（安全重視）
- Phase 2でGPT-4o miniによる意図判定を追加検討

**実装方針**:
- Week 2ではキーワードベースで実装
- 誤検出は許容（安全重視）
- Phase 2で改善検討

#### 課題2: 夜間対応キューの自動実行

**問題**:
- MVP期間中はCeleryバッチ処理が未実装
- 手動実行または外部cronが必要

**対策**:
- MVP期間中は管理画面から手動実行ボタン
- または外部cronから定期API呼び出し
- Phase 2でCeleryバッチ処理実装

**実装方針**:
- Week 2では手動実行APIを実装
- 管理画面UIはWeek 3で実装
- Phase 2で自動実行に移行

### 4.3 パフォーマンス上の課題

#### 課題1: レスポンス時間

**問題**:
- RAG統合型処理は複数のステップが必要
- 目標: 3秒以内

**対策**:
- 非同期処理を徹底
- 埋め込み生成・検索を並列化（可能な範囲）
- キャッシュ活用（Redis）

**実装方針**:
- 非同期処理を徹底
- レスポンス時間計測を実装
- 目標3秒以内を目指す

#### 課題2: OpenAI APIレート制限

**問題**:
- OpenAI APIにはレート制限がある
- 大量リクエスト時にエラー発生の可能性

**対策**:
- レート制限エラーのハンドリング
- リトライロジック実装
- フォールバック文言実装

**実装方針**:
- レート制限エラーを検出
- 適切なエラーメッセージ返却
- フォールバック文言で対応

---

## 5. 実装順序の最適化

### 5.1 推奨実装順序

1. **基盤構築フェーズ**（ステップ1-3）
   - データベースモデル追加
   - Alembicマイグレーション作成
   - Pydanticスキーマ追加

2. **外部API接続フェーズ**（ステップ4-6）
   - OpenAI API クライアント実装
   - 埋め込みベクトル生成実装
   - pgvector検索実装

3. **判定ロジックフェーズ**（ステップ7-9）
   - 安全カテゴリ判定実装
   - 信頼度スコア計算実装
   - コンテキスト構築実装

4. **コア機能フェーズ**（ステップ10-12）
   - RAG統合型AI対話エンジン実装
   - エスカレーション判定・管理実装
   - 夜間対応キュー実装

5. **統合フェーズ**（ステップ13-17）
   - フォールバック文言実装
   - チャットサービス実装
   - チャットAPI実装
   - エラーハンドリング拡張
   - API統合・動作確認

6. **テストフェーズ**（ステップ18、オプション）
   - テストコード作成

### 5.2 実装順序の根拠

1. **基盤→機能の順序**: データベース・スキーマを先に構築し、その後に機能を実装
2. **外部API→内部ロジックの順序**: OpenAI API接続を先に確立し、その後に内部ロジックを実装
3. **判定ロジック→コア機能の順序**: 判定ロジックを先に実装し、その後にコア機能で統合
4. **コア機能→統合の順序**: コア機能を先に実装し、その後にサービス・APIで統合

---

## 6. 実装上の注意事項

### 6.1 非同期処理

- SQLAlchemy 2.0+ のasync構文を使用
- `async def`、`await`を適切に使用
- データベース接続は非同期で管理

### 6.2 pgvector対応

- `vector(1536)`型を正しく使用
- インデックス作成時に`ivfflat`を使用（Phase 2で実装）
- コサイン類似度計算を正しく実装

### 6.3 OpenAI API

- エラーハンドリング（タイムアウト、レート制限、API障害）
- フォールバック文言実装
- コスト最適化（RAG統合による48%削減）

### 6.4 安全カテゴリ判定

- 医療・安全関連キーワードは即エスカレーション（閾値無視）
- 多言語対応（英語・日本語）
- 大文字小文字を区別しない検出

### 6.5 信頼度スコア計算

- v0.3改善版の新規要素を実装
- 過去解決率取得（pgvector検索使用）
- 施設カスタムFAQヒット判定
- 0.0-1.0の範囲にクリップ

### 6.6 夜間対応キュー

- 施設のタイムゾーン基準で時刻判定
- UTC保存・ローカル表示
- MVP期間中は手動実行ボタンまたは外部cron対応

### 6.7 エラーハンドリング

- 統一されたエラーレスポンス形式
- 適切なHTTPステータスコード
- OpenAI API障害時のフォールバック

---

## 7. 実装完了基準

### 7.1 機能完了基準

- [ ] データベースモデルが正しく追加されている
- [ ] マイグレーションが正常に実行される
- [ ] OpenAI API接続が正常に動作する
- [ ] 埋め込みベクトル生成が正常に動作する
- [ ] pgvector検索が正常に動作する
- [ ] 安全カテゴリ判定が正常に動作する
- [ ] 信頼度スコア計算が正常に動作する
- [ ] RAG統合型AI対話エンジンが正常に動作する
- [ ] エスカレーション判定・管理が正常に動作する
- [ ] 夜間対応キューが正常に動作する
- [ ] フォールバック文言が正しく実装されている
- [ ] チャットAPIが正常に動作する
- [ ] Swagger UIでAPI仕様が確認できる
- [ ] エラーハンドリングが適切に実装されている

### 7.2 パフォーマンス基準

- [ ] レスポンス時間: 3秒以内（目標）
- [ ] OpenAI APIエラー率: 1%以下
- [ ] pgvector検索精度: 類似度0.7以上でTop 3取得

### 7.3 品質基準

- [ ] エラーハンドリングが適切に実装されている
- [ ] ログ記録が適切に実装されている
- [ ] コード品質が適切である（リントエラーなし）

---

## 8. 次のステップ（Week 3）

Week 2完了後、Week 3（フロントエンド）に進む：

- Vue.js プロジェクト初期化
- ゲスト側UI（PWA、ダークモード）
- ゲストフィードバックUI（👍👎）
- セッション統合トークン表示・入力UI
- 管理画面（ダッシュボード）
- FAQ自動学習UI（ワンクリック追加）
- 夜間対応キューUI

---

## 9. 参考資料

### 主要ドキュメント
- **要約定義書**: `docs/Summary/yadopera-v03-summary.md`
- **アーキテクチャ設計書**: `docs/Architecture/やどぺら_v0.3_アーキテクチャ設計書.md`
- **Phase 0引き継ぎ書**: `docs/Phase0_引き継ぎ書.md`
- **Phase 1 Week 1ステップ計画**: `docs/Phase1/Phase1_Week1_ステップ計画.md`
- **Phase 1 Week 1整合性判断レポート**: `docs/Phase1/Phase1_Week1_整合性判断レポート.md`

### 実装参考セクション
- アーキテクチャ設計書 11. AI対話エンジン設計（RAG統合型）
- アーキテクチャ設計書 12. エスカレーション管理
- アーキテクチャ設計書 7.2 テーブル定義詳細
- アーキテクチャ設計書 8.2 RESTful API エンドポイント一覧
- アーキテクチャ設計書 8.3 APIリクエスト・レスポンス詳細

---

**レポート作成者**: AI Assistant  
**最終更新日**: 2025年11月27日

