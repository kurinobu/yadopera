# Phase 1 Week 2 引き継ぎ事項

**作成日**: 2025年11月27日  
**対象**: Phase 1 Week 2（AI対話エンジン）実装完了後の引き継ぎ事項  
**目的**: 後続フェーズでの実装忘れ防止

---

## 1. ステップ18未実行について（⚠️ 重要: テスト未実施）

### ステータス

- **ステップ18**: テストコード作成（オプション、時間があれば）
- **実装状況**: ⏳ **未実施**
- **理由**: オプションステップのため、必須機能実装を優先
- **リスク**: ⚠️ **高リスク** - テスト未実施により、後で動かない場合の原因特定に大量の時間を費やす可能性

### テスト未実施の影響

**Phase 1 Week 2で実装した機能のテストが一切実施されていません**:
- ❌ RAG統合型AI対話エンジンのテスト未実施
- ❌ 埋め込みベクトル生成のテスト未実施
- ❌ pgvector検索のテスト未実施
- ❌ 信頼度スコア計算のテスト未実施
- ❌ チャットメッセージ送信のテスト未実施
- ❌ エスカレーション判定のテスト未実施
- ❌ 夜間対応キュー処理のテスト未実施

### テスト実施計画（必須）

**⚠️ MVP的にもテストを後回しにするのはリスクが高いため、以下の計画で実施する必要があります。**

#### Phase 1 Week 4で実施（推奨）

**理由**:
- Week 4は「統合・テスト・ステージング環境構築」の週
- エンドツーエンドテストと並行して実施可能
- ステージング環境構築前にバグを発見・修正できる

**実施内容**:
1. **単体テスト（必須）**
   - [ ] `backend/tests/test_ai_engine.py` - RAG統合型AI対話エンジンテスト
   - [ ] `backend/tests/test_embeddings.py` - 埋め込みベクトル生成テスト
   - [ ] `backend/tests/test_vector_search.py` - pgvector検索テスト
   - [ ] `backend/tests/test_confidence.py` - 信頼度スコア計算テスト
   - [ ] `backend/tests/test_safety_check.py` - 安全カテゴリ判定テスト

2. **統合テスト（必須）**
   - [ ] `backend/tests/test_chat.py` - チャットメッセージ送信テスト
   - [ ] `backend/tests/test_chat_service.py` - チャットサービス統合テスト
   - [ ] `backend/tests/test_escalation.py` - エスカレーション判定テスト
   - [ ] `backend/tests/test_overnight_queue.py` - 夜間対応キュー処理テスト

3. **APIテスト（必須）**
   - [ ] `backend/tests/test_chat_api.py` - チャットAPIエンドポイントテスト
   - [ ] `backend/tests/test_chat_history_api.py` - 会話履歴取得APIテスト

**工数見積もり**: 8-12時間（ステップ18の4時間では不十分なため拡大）

#### 代替案: Phase 1 Week 3中に並行実施

**理由**:
- Week 3はフロントエンド実装の週
- バックエンドのテストを並行して実施可能
- Week 4での統合テスト前にバグを発見できる

**実施内容**: 上記と同じ

**工数見積もり**: 8-12時間（Week 3の工数に追加）

### 後続フェーズでの対応（非推奨）

- ❌ Phase 2以降での実施は非推奨（リスクが高すぎる）
- ❌ 動かない場合の原因特定に大量の時間を費やす可能性
- ❌ MVP的にもテストを後回しにするのは愚の骨頂

---

## 2. 各ステップの注意事項（後続フェーズでの実装忘れ防止）

### ステップ1: データベースモデル追加

**注意事項**:
- pgvector型（`vector(1536)`）を正しく使用すること
- リレーションシップが正しく設定されていること
- インデックス定義が適切であること

**後続フェーズでの実装忘れ防止**:
- ✅ マイグレーション実行時にpgvector拡張が有効化されていること
- ✅ ベクトルカラムにIVFFlatインデックスが作成されること（Phase 2で最適化）

---

### ステップ2: Alembicマイグレーション作成

**注意事項**:
- pgvector拡張が有効化されていること
- `GENERATED ALWAYS AS`カラム（`resolution_rate`）が正しく定義されていること
- 外部キー制約が正しく設定されていること

**後続フェーズでの実装忘れ防止**:
- ✅ マイグレーション実行前にpgvector拡張を有効化
- ✅ `resolution_rate`カラムの計算式が正しいこと

---

### ステップ4: OpenAI API クライアント実装

**注意事項**:
- エラーハンドリング（タイムアウト、レート制限、API障害）を実装すること
- フォールバックメッセージを返却すること
- 非同期処理（`asyncio.to_thread`）を使用すること

**後続フェーズでの実装忘れ防止**:
- ✅ タイムアウト設定（5秒）が適切であること
- ⚠️ **Phase 2で検討**: レート制限エラー時の再試行ロジック（現在は再試行なし）
- ⚠️ **Phase 2で実装**: APIコスト監視

---

### ステップ6: pgvector検索実装

**注意事項**:
- コサイン類似度を使用すること
- 類似度閾値0.7以上でフィルタリングすること
- エラー時は空リストを返却すること

**後続フェーズでの実装忘れ防止**:
- ⚠️ **Phase 2で実装**: IVFFlatインデックスの最適化
- ⚠️ **Phase 2で実装**: 検索パフォーマンス監視

---

### ステップ7: RAGエンジン実装

**注意事項**:
- 依存モジュールは後続ステップで実装する前提で進めること
- エラーハンドリングを適切に実装すること

**後続フェーズでの実装忘れ防止**:
- ⚠️ **重要: Phase 2で実装必須**: `engine.py`内のTODOコメントを解消すること
  - `calculate_confidence`の統合
  - `check_escalation_needed`の統合
  - `build_rag_prompt`の使用（現在は`_build_context`を使用）
  - メッセージ保存処理の実装（現在は`ChatService`で実装）
- ✅ 現在は`ChatService`で統合処理を実装済みだが、`engine.py`のリファクタリングが必要

---

### ステップ8: 信頼度スコア計算実装

**注意事項**:
- v0.3改善版の新規要素を実装すること
- 過去解決率取得（pgvector検索使用）
- 施設カスタムFAQヒット判定
- 0.0-1.0の範囲にクリップすること

**後続フェーズでの実装忘れ防止**:
- ⚠️ **Phase 2で修正**: `search_similar_faqs`でsimilarity属性を返すように修正（現在は暫定値使用）
- ✅ 過去解決率取得エラー時の処理（現在は警告ログのみ）

---

### ステップ9: コンテキスト構築実装

**注意事項**:
- 約600トークン以内に収めること
- 関連FAQ Top 3: 約300トークン
- 施設基本情報: 約150トークン
- システムプロンプト: 約100トークン
- ゲスト質問: 約50トークン

**後続フェーズでの実装忘れ防止**:
- ⚠️ **Phase 2で実装**: トークン数監視
- ⚠️ **Phase 2で検討**: プロンプト最適化

---

### ステップ11: エスカレーション判定・管理実装

**注意事項**:
- 施設のタイムゾーン基準で時刻判定すること
- 安全カテゴリは即エスカレーション（閾値無視）
- エスカレーションスケジュール連動

**後続フェーズでの実装忘れ防止**:
- ⚠️ **Phase 2で実装必須**: 通知送信機能（現在はログのみ）
  - Email通知
  - Slack通知
  - LINE通知
- ⚠️ **Phase 2で実装**: エスカレーション統計

---

### ステップ12: 夜間対応キュー実装

**注意事項**:
- 施設タイムゾーン基準の翌朝8:00計算
- 夜間時間帯判定（22:00-8:00）
- 自動返信メッセージ送信
- **MVP期間中は手動実行ボタンまたは外部cron対応**

**後続フェーズでの実装忘れ防止**:
- ⚠️ **重要: Phase 2で実装必須**: Celeryバッチ処理に移行すること
  - 毎日8:00（施設タイムゾーン基準）に自動実行
  - 施設タイムゾーン別に処理
- ⚠️ **Phase 2で実装必須**: 通知送信機能（現在はログのみ）
- ✅ タイムゾーン処理の統一確認

---

### ステップ14: チャットサービス実装

**注意事項**:
- セッション管理
- RAG統合型AI対話エンジン呼び出し
- エスカレーション処理
- 夜間対応キュー処理
- メッセージ保存

**後続フェーズでの実装忘れ防止**:
- ⚠️ **Phase 2で実装**: 質問パターン記録・更新
  - 質問受付時のパターン記録
  - 解決率計算
  - 類似パターンマッチング

---

## 3. Phase 2で実装すべき項目（優先度順）

### 高優先度（必須）

1. **`engine.py`のTODOコメント解消**
   - [ ] `calculate_confidence`の統合
   - [ ] `check_escalation_needed`の統合
   - [ ] `build_rag_prompt`の使用（`_build_context`を置き換え）
   - [ ] メッセージ保存処理の実装（`ChatService`から`engine.py`へ移動検討）
   - [ ] `ChatService`のリファクタリング検討

2. **通知送信機能実装**
   - [ ] エスカレーション通知（Email/Slack/LINE）
   - [ ] 夜間対応キュー通知（翌朝8:00）
   - [ ] 通知チャネル設定UI

3. **Celeryバッチ処理実装**
   - [ ] 夜間対応キュー一括通知（毎日8:00、施設タイムゾーン別）
   - [ ] データ保持ポリシー（3ヶ月自動削除）
   - [ ] 統計データ抽出

### 中優先度

4. **パフォーマンス最適化**
   - [ ] IVFFlatインデックス最適化
   - [ ] ベクトルキャッシュ（検討）
   - [ ] 検索パフォーマンス監視

5. **質問パターン記録・更新**
   - [ ] 質問受付時のパターン記録
   - [ ] 解決率計算
   - [ ] 類似パターンマッチング

6. **APIコスト監視**
   - [ ] OpenAI API使用量監視
   - [ ] コストアラート
   - [ ] 使用量統計

### ⚠️ 最優先度（必須・緊急）

7. **テストコード作成（ステップ18） - Phase 1 Week 4で実施必須**
   - [ ] RAG統合型AI対話エンジンテスト
   - [ ] 埋め込みベクトル生成テスト
   - [ ] pgvector検索テスト
   - [ ] 信頼度スコア計算テスト
   - [ ] 安全カテゴリ判定テスト
   - [ ] チャットメッセージ送信テスト
   - [ ] チャットサービス統合テスト
   - [ ] エスカレーション判定テスト
   - [ ] 夜間対応キュー処理テスト
   - [ ] チャットAPIエンドポイントテスト
   - [ ] 会話履歴取得APIテスト
   - **工数**: 8-12時間（ステップ18の4時間では不十分なため拡大）
   - **実施時期**: Phase 1 Week 4（推奨）または Week 3中に並行実施
   - **理由**: テスト未実施により、後で動かない場合の原因特定に大量の時間を費やすリスクが高い

8. **エラーログ監視**
   - [ ] エラーログ集約
   - [ ] エラー統計ダッシュボード
   - [ ] アラート設定

---

## 4. 技術的負債・改善点

### 即座に対応が必要な項目

1. **`engine.py`のリファクタリング**
   - 現在: `ChatService`で統合処理を実装
   - 問題: `engine.py`にTODOコメントが残っている
   - 対応: Phase 2で`engine.py`を完全実装し、`ChatService`を簡素化

2. **`search_similar_faqs`のsimilarity属性**
   - 現在: 暫定値（0.7）を使用
   - 問題: 信頼度スコア計算の精度が低下
   - 対応: Phase 2で`search_similar_faqs`を修正し、similarity属性を返すようにする

### 後続フェーズで対応可能な項目

3. **プロンプト最適化**
   - 現在: `_build_context`を使用（`build_rag_prompt`は未使用）
   - 対応: Phase 2で`build_rag_prompt`を使用するように変更

4. **ベクトルキャッシュ**
   - 現在: 毎回OpenAI APIを呼び出し
   - 対応: Phase 2でRedisキャッシュを検討

---

## 5. 依存関係・前提条件

### Phase 2で必要な環境

- Celery（バッチ処理用）
- メール送信サービス（SendGrid、AWS SES等）
- Slack/LINE API（通知用）
- モニタリングツール（エラーログ、APIコスト監視）

### Phase 2で必要な設定

- Celeryワーカー設定
- 通知チャネル設定（Email/Slack/LINE）
- バッチ処理スケジュール設定
- モニタリングアラート設定

---

## 6. 参考資料

### 実装済みドキュメント

- **実装整合性レポート**: `docs/Phase1/Phase1_Week2_実装整合性レポート.md`
- **ステップ計画**: `docs/Phase1/Phase1_Week2_ステップ計画.md`
- **調査分析レポート**: `docs/Phase1/Phase1_Week2_調査分析レポート.md`

### 設計ドキュメント

- **要約定義書**: `docs/Summary/yadopera-v03-summary.md`
- **アーキテクチャ設計書**: `docs/Architecture/やどぺら_v0.3_アーキテクチャ設計書.md`

---

**Document Version**: v1.0  
**Author**: Auto  
**Last Updated**: 2025-11-27  
**Status**: Phase 1 Week 2 引き継ぎ事項記録完了

