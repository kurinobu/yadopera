# Phase 1: 生成済みQRコード一覧 永続化機能 完全調査分析・修正案

**作成日時**: 2025年12月6日 10:00  
**最終更新日時**: 2025年12月6日 10:00  
**実施者**: Auto (AI Assistant)  
**対象**: 生成済みQRコード一覧の永続化機能（データベース保存）  
**状態**: ✅ **調査分析完了、修正案提示完了**  
**ファイル名**: `Phase1_生成済みQRコード一覧_永続化機能_完全調査分析_修正案_20251206_1000.md`

---

## 1. 問題の認識

### 1.1 ユーザーの要求

**要求**:
> 「生成済みQRコード一覧は今の表示を保持するようにする。」

**意味**:
- ページをリロードしても、生成済みQRコード一覧が消えないようにする
- データベースに保存し、永続化する
- 2年後の更新や全館張り替えの際に、漏れなく確認できるようにする

### 1.2 現在の実装の問題点

**現在の実装**:
- `generatedQRCodes`がフロントエンドの`ref`（メモリ）にのみ保存されている
- データベースに保存されていない
- ページをリロードすると、一覧が消える

**問題点**:
1. **永続化されていない**
   - ページをリロードすると、生成済みQRコード一覧が消える
   - セッションを跨いで参照できない

2. **設置場所の管理ができない**
   - どこに何箇所QRコードが設置されているか確認できない
   - 2年後の更新や全館張り替えの際に、漏れなく確認できない

3. **設置履歴が残らない**
   - いつ、どこに、どのQRコードを設置したか記録できない
   - 設置場所の変更履歴を確認できない

---

## 2. 現在の実装状況の調査

### 2.1 フロントエンドの実装

**実装場所**: `frontend/src/views/admin/QRCodeGenerator.vue`

**コード（153行目）**:
```typescript
const generatedQRCodes = ref<QRCodeResponse[]>([])
```

**問題点**:
- `generatedQRCodes`がフロントエンドの`ref`（メモリ）にのみ保存されている
- データベースに保存されていない
- ページをリロードすると、メモリがクリアされ、一覧が消える

**`handleGenerate`関数（189-215行目）**:
```typescript
const handleGenerate = async (data: {
  location: QRCodeLocation
  custom_location_name?: string
  format: 'pdf' | 'png' | 'svg'
}) => {
  // ...
  const qrCode = await qrcodeApi.generateQRCode({
    location: data.location,
    custom_location_name: data.custom_location_name,
    format: data.format
  })
  
  generatedQRCodes.value.unshift(qrCode)
  // ...
}
```

**問題点**:
- QRコードを生成した後、`generatedQRCodes`に追加しているだけ
- データベースに保存していない

### 2.2 バックエンドの実装

**実装場所**: `backend/app/api/v1/admin/qr_code.py`

**コード（17-75行目）**:
```python
@router.post("", response_model=QRCodeResponse)
async def generate_qr_code(
    request: QRCodeRequest,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    # ...
    qr_code_data = await qr_code_service.generate_qr_code(
        facility_id=facility_id,
        location=request.location,
        custom_location_name=request.custom_location_name,
        include_session_token=request.include_session_token,
        format=request.format,
        primary_session_id=request.primary_session_id
    )
    
    # レスポンス生成（IDは生成時刻ベース）
    qr_code_id = int(datetime.utcnow().timestamp())
    
    return QRCodeResponse(
        id=qr_code_id,
        facility_id=facility_id,
        location=request.location,
        custom_location_name=request.custom_location_name,
        include_session_token=request.include_session_token,
        qr_code_url=qr_code_data["qr_code_url"],
        qr_code_data=qr_code_data["qr_code_data"],
        format=qr_code_data["format"],
        created_at=datetime.utcnow()
    )
```

**問題点**:
- QRコード生成APIは、QRコードを生成して返すだけ
- データベースに保存する機能は実装されていない
- 生成済みQRコード一覧を取得するAPIも実装されていない

### 2.3 データベースモデルの確認

**調査結果**:
- QRコードを保存するテーブルが存在しない
- `backend/app/models/`ディレクトリにQRコードモデルがない

**必要なテーブル**:
- QRコードの情報を保存するテーブルが必要
- 設置場所、カスタム設置場所名、QRコードURL、生成日時などを保存

---

## 3. ユーザー目線での検討

### 3.1 使用シナリオ

**シナリオ1: 複数の設置場所のQRコードを生成**
1. 施設管理者が「入口」「客室」「キッチン」「階段踊り場」など、複数の設置場所のQRコードを生成
2. 各QRコードを施設の適切な場所に設置
3. **2年後、QRコードを更新したい場合**
   - どこに何箇所QRコードが設置されているか確認する必要がある
   - 現在の実装では、ページをリロードすると一覧が消えるため、確認できない

**シナリオ2: 全館張り替え**
1. 施設全体のQRコードを張り替えたい場合
   - どこに何箇所QRコードが設置されているか確認する必要がある
   - 漏れなく確認する必要がある
   - 現在の実装では、ページをリロードすると一覧が消えるため、確認できない

**シナリオ3: 設置場所の変更**
1. 設置場所を変更したい場合
   - 以前の設置場所を確認する必要がある
   - 現在の実装では、ページをリロードすると一覧が消えるため、確認できない

### 3.2 ユーザーの要望

**要望1: 永続化**
- ページをリロードしても、生成済みQRコード一覧が消えないようにする
- データベースに保存し、永続化する

**要望2: 設置場所の管理**
- どこに何箇所QRコードが設置されているか確認できる
- 設置場所ごとのQRコードを表示できる

**要望3: 更新・張り替え時の確認**
- 2年後の更新や全館張り替えの際に、漏れなく確認できる
- 設置場所ごとのQRコードを確認できる

---

## 4. 修正案

### 4.1 修正案1: データベースに保存する（推奨）

#### 4.1.1 データベースモデルの作成

**テーブル設計**:
```sql
CREATE TABLE qr_codes (
    id SERIAL PRIMARY KEY,
    facility_id INTEGER NOT NULL REFERENCES facilities(id) ON DELETE CASCADE,
    location VARCHAR(50) NOT NULL,
    custom_location_name VARCHAR(50),
    qr_code_url TEXT NOT NULL,
    qr_code_data TEXT NOT NULL,
    format VARCHAR(10) NOT NULL,  -- 'pdf', 'png', 'svg'
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_qr_codes_facility_id ON qr_codes(facility_id);
CREATE INDEX idx_qr_codes_location ON qr_codes(location);
CREATE INDEX idx_qr_codes_created_at ON qr_codes(created_at);
```

**モデルファイル**: `backend/app/models/qr_code.py`
```python
"""
QRコードモデル
"""
from sqlalchemy import Column, Integer, String, DateTime, ForeignKey, Text
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from app.database import Base


class QRCode(Base):
    """
    QRコードモデル
    生成済みQRコード一覧の永続化用
    """
    __tablename__ = "qr_codes"

    id = Column(Integer, primary_key=True, index=True)
    facility_id = Column(Integer, ForeignKey("facilities.id", ondelete="CASCADE"), nullable=False, index=True)
    location = Column(String(50), nullable=False, index=True)  # 'entrance', 'room', 'kitchen', 'lounge', 'custom'
    custom_location_name = Column(String(50), nullable=True)
    qr_code_url = Column(Text, nullable=False)  # Base64エンコードされたQRコード画像URL
    qr_code_data = Column(Text, nullable=False)  # QRコードに埋め込まれたURL
    format = Column(String(10), nullable=False)  # 'pdf', 'png', 'svg'
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now())

    # リレーションシップ
    facility = relationship("Facility", back_populates="qr_codes")
```

#### 4.1.2 スキーマの追加

**スキーマファイル**: `backend/app/schemas/qr_code.py`に追加

```python
class QRCodeListResponse(BaseModel):
    """生成済みQRコード一覧レスポンス"""
    qr_codes: List[QRCodeResponse] = Field(..., description="生成済みQRコード一覧")
    total: int = Field(..., description="総数")

    class Config:
        from_attributes = True
```

#### 4.1.3 APIエンドポイントの追加

**追加するAPI**:

1. **QRコード生成時にデータベースに保存**
   - `POST /api/v1/admin/qr-code`を修正
   - QRコード生成後、データベースに保存する

2. **生成済みQRコード一覧を取得**
   - `GET /api/v1/admin/qr-codes`を追加
   - 施設IDでフィルタリング
   - 設置場所でソート

3. **QRコードを削除**
   - `DELETE /api/v1/admin/qr-code/{id}`を追加
   - 一覧から削除する機能

**実装例**:
```python
# backend/app/api/v1/admin/qr_code.py

@router.post("", response_model=QRCodeResponse)
async def generate_qr_code(
    request: QRCodeRequest,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    # ... 既存のQRコード生成処理 ...
    
    # データベースに保存
    qr_code_model = QRCode(
        facility_id=facility_id,
        location=request.location,
        custom_location_name=request.custom_location_name,
        qr_code_url=qr_code_data["qr_code_url"],
        qr_code_data=qr_code_data["qr_code_data"],
        format=request.format
    )
    db.add(qr_code_model)
    await db.commit()
    await db.refresh(qr_code_model)
    
    return QRCodeResponse(
        id=qr_code_model.id,
        facility_id=facility_id,
        location=request.location,
        custom_location_name=request.custom_location_name,
        include_session_token=False,  # 削除されたためFalse
        qr_code_url=qr_code_data["qr_code_url"],
        qr_code_data=qr_code_data["qr_code_data"],
        format=qr_code_data["format"],
        created_at=qr_code_model.created_at
    )

@router.get("", response_model=QRCodeListResponse)
async def list_qr_codes(
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """
    生成済みQRコード一覧を取得
    """
    facility_id = current_user.facility_id
    if not facility_id:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="User is not associated with any facility"
        )
    
    result = await db.execute(
        select(QRCode)
        .where(QRCode.facility_id == facility_id)
        .order_by(QRCode.created_at.desc())
    )
    qr_codes = result.scalars().all()
    
    return QRCodeListResponse(
        qr_codes=[QRCodeResponse(
            id=qr.id,
            facility_id=qr.facility_id,
            location=qr.location,
            custom_location_name=qr.custom_location_name,
            include_session_token=False,
            qr_code_url=qr.qr_code_url,
            qr_code_data=qr.qr_code_data,
            format=qr.format,
            created_at=qr.created_at
        ) for qr in qr_codes],
        total=len(qr_codes)
    )

@router.delete("/{qr_code_id}")
async def delete_qr_code(
    qr_code_id: int,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """
    QRコードを削除
    """
    facility_id = current_user.facility_id
    if not facility_id:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="User is not associated with any facility"
        )
    
    result = await db.execute(
        select(QRCode)
        .where(QRCode.id == qr_code_id)
        .where(QRCode.facility_id == facility_id)
    )
    qr_code = result.scalar_one_or_none()
    
    if not qr_code:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="QR code not found"
        )
    
    await db.delete(qr_code)
    await db.commit()
    
    return {"message": "QR code deleted successfully"}
```

#### 4.1.4 フロントエンドの修正

**修正箇所1: ページ読み込み時に一覧を取得**

**`frontend/src/views/admin/QRCodeGenerator.vue`**:
```typescript
// コンポーネントマウント時に生成済みQRコード一覧を取得
onMounted(async () => {
  await fetchFacilityInfo()
  await fetchGeneratedQRCodes()
})

// 生成済みQRコード一覧を取得
const fetchGeneratedQRCodes = async () => {
  try {
    const response = await qrcodeApi.listQRCodes()
    generatedQRCodes.value = response.qr_codes
  } catch (err: any) {
    console.error('Failed to fetch QR codes:', err)
    // エラーは表示しない（初回アクセス時は空の一覧で問題ない）
  }
}
```

**修正箇所2: QRコード生成時にデータベースに保存**

**既存の`handleGenerate`関数は修正不要**:
- バックエンドで自動的にデータベースに保存される
- レスポンスに`id`が含まれるため、フロントエンドで追加する必要はない

**修正箇所3: 「一覧から削除」ボタンの実装**

**`handleRemoveFromList`関数を修正**:
```typescript
const handleRemoveFromList = async (id: number) => {
  try {
    await qrcodeApi.deleteQRCode(id)
    // 一覧から削除
    const index = generatedQRCodes.value.findIndex(qr => qr.id === id)
    if (index !== -1) {
      generatedQRCodes.value.splice(index, 1)
    }
  } catch (err: any) {
    console.error('Failed to delete QR code:', err)
    alert(err.response?.data?.detail || 'QRコードの削除に失敗しました')
  }
}
```

#### 4.1.5 APIクライアントの追加

**`frontend/src/api/qrcode.ts`に追加**:
```typescript
// 生成済みQRコード一覧を取得
async listQRCodes(): Promise<QRCodeListResponse> {
  const response = await apiClient.get<QRCodeListResponse>('/admin/qr-codes')
  return response.data
}

// QRコードを削除
async deleteQRCode(id: number): Promise<void> {
  await apiClient.delete(`/admin/qr-code/${id}`)
}
```

#### 4.1.6 型定義の追加

**`frontend/src/types/qrcode.ts`に追加**:
```typescript
export interface QRCodeListResponse {
  qr_codes: QRCodeResponse[]
  total: number
}
```

### 4.2 修正案2: ローカルストレージに保存する（代替案）

**概要**:
- QRコード生成時に、ローカルストレージに保存する
- ページ読み込み時に、ローカルストレージから取得する

**メリット**:
- 実装が簡単
- データベース設計の変更が不要

**デメリット**:
- ブラウザをクリアすると消える
- 複数の施設管理者が同じQRコードを参照できない
- 設置場所の管理が不十分

**評価**: ❌ **非推奨**（ユーザーの要望を満たさない）

---

## 5. 実装手順

### 5.1 データベースマイグレーション

1. **マイグレーションファイルの作成**
   ```bash
   alembic revision --autogenerate -m "Add qr_codes table"
   ```

2. **マイグレーションの実行**
   ```bash
   alembic upgrade head
   ```

### 5.2 バックエンドの実装

1. **モデルの作成**
   - `backend/app/models/qr_code.py`を作成

2. **スキーマの追加**
   - `backend/app/schemas/qr_code.py`に`QRCodeListResponse`を追加

3. **APIエンドポイントの追加・修正**
   - `POST /api/v1/admin/qr-code`を修正（データベースに保存）
   - `GET /api/v1/admin/qr-codes`を追加（一覧取得）
   - `DELETE /api/v1/admin/qr-code/{id}`を追加（削除）

4. **Facilityモデルにリレーションシップを追加**
   - `backend/app/models/facility.py`に`qr_codes`リレーションシップを追加

### 5.3 フロントエンドの実装

1. **APIクライアントの追加**
   - `frontend/src/api/qrcode.ts`に`listQRCodes`と`deleteQRCode`を追加

2. **型定義の追加**
   - `frontend/src/types/qrcode.ts`に`QRCodeListResponse`を追加

3. **コンポーネントの修正**
   - `frontend/src/views/admin/QRCodeGenerator.vue`を修正
   - ページ読み込み時に一覧を取得
   - 「一覧から削除」ボタンの実装

### 5.4 テスト

1. **QRコード生成時の保存確認**
   - QRコードを生成すると、データベースに保存されることを確認

2. **ページリロード時の一覧表示確認**
   - ページをリロードしても、生成済みQRコード一覧が表示されることを確認

3. **削除機能の確認**
   - 「一覧から削除」ボタンをクリックすると、データベースから削除されることを確認

---

## 6. まとめ

### 6.1 問題の認識

**ユーザーの要求**:
- 「生成済みQRコード一覧は今の表示を保持するようにする。」

**意味**:
- ページをリロードしても、生成済みQRコード一覧が消えないようにする
- データベースに保存し、永続化する
- 2年後の更新や全館張り替えの際に、漏れなく確認できるようにする

### 6.2 現在の実装の問題点

1. **永続化されていない**
   - ページをリロードすると、生成済みQRコード一覧が消える

2. **設置場所の管理ができない**
   - どこに何箇所QRコードが設置されているか確認できない

3. **設置履歴が残らない**
   - いつ、どこに、どのQRコードを設置したか記録できない

### 6.3 修正案

**修正案1: データベースに保存する（推奨）**

**必要な実装**:
1. データベースモデルの作成（`QRCode`テーブル）
2. APIエンドポイントの追加・修正
   - QRコード生成時にデータベースに保存
   - 生成済みQRコード一覧を取得
   - QRコードを削除
3. フロントエンドの修正
   - ページ読み込み時に一覧を取得
   - 「一覧から削除」ボタンの実装

**メリット**:
- 永続化される
- セッションを跨いで参照できる
- 設置場所の管理ができる
- 2年後の更新や全館張り替えの際に、漏れなく確認できる

---

**Document Version**: v1.0  
**Author**: Auto (AI Assistant)  
**Last Updated**: 2025-12-06 10:00  
**Status**: ✅ **調査分析完了、修正案提示完了**


