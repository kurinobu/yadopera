# Phase 1: QRコード生成エラー・生成済み一覧保持問題 完全調査分析・修正案

**作成日時**: 2025年12月6日 09:37  
**最終更新日時**: 2025年12月6日 09:37  
**実施者**: Auto (AI Assistant)  
**対象**: QRコード生成エラーと生成済み一覧保持問題の完全調査分析と修正案  
**状態**: ✅ **調査分析完了、修正案提示完了**  
**ファイル名**: `Phase1_QRコード生成エラー_生成済み一覧保持問題_完全調査分析_修正案_20251206_0937.md`

---

## 1. 問題1: プレビュー生成エラー

### 1.1 エラーの詳細

**エラーメッセージ**:
```
POST http://localhost:8000/api/v1/admin/qr-code 400 (Bad Request)
{code: 'BAD_REQUEST', message: 'primary_session_id is required when include_session_token is True', details: {…}}
```

**発生タイミング**:
- 「セッション統合トークンを埋め込む（v0.3新規）」にチェックを入れた瞬間
- プライマリセッションID入力欄が表示されるが、まだ入力されていない状態

### 1.2 原因の完全調査分析

#### 1.2.1 コードの流れ

**`QRCodeForm.vue`の`watch`関数（304-309行目）**:
```typescript
// セッション統合トークンオプション変更時にプレビューを再生成
watch(() => formData.value.include_session_token, () => {
  if (canGeneratePreview.value) {
    generatePreview()
  }
})
```

**問題点**:
- `include_session_token`が`True`になった時点で、`watch`が発火
- `canGeneratePreview.value`が`True`の場合、`generatePreview()`が呼ばれる
- しかし、この時点では`primary_session_id`がまだ空文字列（`''`）
- `generatePreview()`内で`primary_session_id`を送信するが、空文字列のためバックエンドでエラーが発生

**`generatePreview()`関数（260-267行目）**:
```typescript
const qrCode = await qrcodeApi.generateQRCode({
  location: formData.value.location as QRCodeLocation,
  custom_location_name: formData.value.location === 'custom' ? formData.value.custom_location_name.trim() : undefined,
  include_session_token: formData.value.include_session_token,
  primary_session_id: formData.value.include_session_token ? formData.value.primary_session_id.trim() : undefined,
  format: 'png'
})
```

**問題点**:
- `formData.value.primary_session_id.trim()`が空文字列（`''`）を返す
- 空文字列は`undefined`ではないため、バックエンドに送信される
- バックエンドでは、`include_session_token`が`True`で`primary_session_id`が空文字列の場合、エラーが発生

**バックエンドのバリデーション（`backend/app/api/v1/admin/qr_code.py` 44-49行目）**:
```python
# セッション統合トークン埋め込みの場合、primary_session_idが必要
if request.include_session_token and not request.primary_session_id:
    raise HTTPException(
        status_code=status.HTTP_400_BAD_REQUEST,
        detail="primary_session_id is required when include_session_token is True"
    )
```

**問題点**:
- `not request.primary_session_id`は、`None`、空文字列（`''`）、`False`の場合に`True`になる
- 空文字列が送信されると、エラーが発生

### 1.3 修正案

#### 修正案1: `canGeneratePreview`に`primary_session_id`のチェックを追加（推奨）

**概要**:
- `canGeneratePreview`に`primary_session_id`のチェックを追加
- `include_session_token`が`True`の場合、`primary_session_id`が入力されている場合のみプレビューを生成可能にする

**修正内容**:
```typescript
const canGeneratePreview = computed(() => {
  if (!formData.value.location) return false
  if (formData.value.location === 'custom' && !formData.value.custom_location_name.trim()) {
    return false
  }
  // セッション統合トークン埋め込みの場合、primary_session_idが必須
  if (formData.value.include_session_token && !formData.value.primary_session_id.trim()) {
    return false
  }
  return true
})
```

**メリット**:
- シンプルで明確
- `include_session_token`が`True`の場合、`primary_session_id`が入力されるまでプレビューが生成されない
- エラーが発生しない

**デメリット**:
- なし

#### 修正案2: `watch`内で`primary_session_id`をチェック

**概要**:
- `watch`内で`primary_session_id`が入力されている場合のみプレビューを生成

**修正内容**:
```typescript
// セッション統合トークンオプション変更時にプレビューを再生成
watch(() => formData.value.include_session_token, () => {
  if (canGeneratePreview.value) {
    // セッション統合トークン埋め込みの場合、primary_session_idが入力されている場合のみプレビューを生成
    if (formData.value.include_session_token && !formData.value.primary_session_id.trim()) {
      return
    }
    generatePreview()
  }
})
```

**メリット**:
- `canGeneratePreview`を変更する必要がない

**デメリット**:
- ロジックが分散する
- 保守性が低い

**評価**: ❌ **非推奨**（ロジックが分散する）

---

## 2. 問題2: 生成済みQRコード一覧がリロードで消える

### 2.1 問題の詳細

**症状**:
- 「生成済みQRコード一覧に追加」ボタンをクリックすると、生成済みQRコード一覧に表示される
- ページをリロードすると、一覧が全て消えてしまう

### 2.2 原因の完全調査分析

#### 2.2.1 現在の実装

**`QRCodeGenerator.vue`の実装（153行目）**:
```typescript
const generatedQRCodes = ref<QRCodeResponse[]>([])
```

**問題点**:
- `generatedQRCodes`がフロントエンドの`ref`（メモリ）にのみ保存されている
- データベースに保存されていない
- ページをリロードすると、メモリがクリアされ、一覧が消える

**`handleGenerate`関数（186-216行目）**:
```typescript
const handleGenerate = async (data: {
  location: QRCodeLocation
  custom_location_name?: string
  include_session_token: boolean
  format: 'pdf' | 'png' | 'svg'
  primary_session_id?: string
}) => {
  // ...
  const qrCode = await qrcodeApi.generateQRCode({
    location: data.location,
    custom_location_name: data.custom_location_name,
    include_session_token: data.include_session_token,
    format: data.format,
    primary_session_id: data.primary_session_id
  })
  
  generatedQRCodes.value.unshift(qrCode)
  // ...
}
```

**問題点**:
- QRコードを生成した後、`generatedQRCodes`に追加しているだけ
- データベースに保存していない

#### 2.2.2 バックエンドの実装確認

**`backend/app/api/v1/admin/qr_code.py`**:
- QRコード生成APIは、QRコードを生成して返すだけ
- データベースに保存する機能は実装されていない

**調査結果**:
- QRコード生成APIは、生成のみで保存はしていない
- 生成済みQRコード一覧を保持するには、データベースに保存する必要がある
- 現在の実装では、生成済みQRコード一覧を保持する機能は実装されていない

### 2.3 回答

#### 2.3.1 現在の動作は正常か？

**回答**: **現在の動作は実装仕様通りです**。

**理由**:
1. 現在の実装では、生成済みQRコード一覧はセッション（メモリ）内のみに保存されている
2. データベースに保存する機能は実装されていない
3. ページをリロードすると、メモリがクリアされ、一覧が消えるのは正常な動作

#### 2.3.2 保持されるべきか？

**回答**: **ユーザーの要望を考慮すると、保持されるべきです**。

**理由**:
1. ユーザーが生成したQRコードを後で参照したい場合がある
2. リロードで消えると、ユーザビリティが低下する
3. データベースに保存することで、永続化できる

#### 2.3.3 修正が必要か？

**回答**: **修正が必要です**。

**修正内容**:
1. QRコード生成時に、データベースに保存する機能を追加
2. 生成済みQRコード一覧を取得するAPIを追加
3. ページ読み込み時に、生成済みQRコード一覧を取得する機能を追加

**ただし、これは大きな機能追加になるため、Phase 1の完了条件に含まれているか確認が必要です。**

---

## 3. テストデータ: プライマリセッションID

### 3.1 テスト用プライマリセッションIDの取得方法

#### 方法1: 既存の会話から取得（推奨）

**手順**:
1. ゲスト画面でメッセージを送信して会話を作成
2. ブラウザの開発者ツールで、Cookieの`yadopera_session_id`を確認
3. そのセッションIDをプライマリセッションIDとして使用

**例**:
```
プライマリセッションID: 550e8400-e29b-41d4-a716-446655440000
```

#### 方法2: データベースから取得

**SQLクエリ**:
```sql
SELECT session_id FROM conversations WHERE facility_id = 1 ORDER BY started_at DESC LIMIT 1;
```

**実行方法**:
```bash
docker-compose exec postgres psql -U yadopera_user -d yadopera -c "SELECT session_id FROM conversations WHERE facility_id = 1 ORDER BY started_at DESC LIMIT 1;"
```

**注意**: `created_at`ではなく`started_at`を使用してください。

#### 方法3: テストデータ作成スクリプトで作成

**`create_test_data.py`を実行**:
```bash
cd backend
python create_test_data.py
```

**作成されるセッションID**:
- `create_test_data.py`を実行すると、テスト用の会話が作成される
- その会話の`session_id`をプライマリセッションIDとして使用

### 3.2 テスト用プライマリセッションID（即座に使用可能）

**注意**: 以下のセッションIDは、`create_test_data.py`を実行した場合に作成される可能性がありますが、実際のデータベースに存在するか確認が必要です。

**推奨テスト手順**:
1. ゲスト画面（`http://localhost:5173/f/tokyo-guesthouse`）にアクセス
2. 任意のメッセージを送信（例: "What time is check-in?"）
3. ブラウザの開発者ツール（F12）を開く
4. Applicationタブ → Cookies → `http://localhost:5173` → `yadopera_session_id`を確認
5. そのセッションIDをコピーして、管理画面のQRコード生成フォームの「プライマリセッションID」に入力

**例**:
```
プライマリセッションID: 37dee6e7-1df1-4226-aa5a-06fbf3ba5b64
```

**または、データベースから直接取得**:
```bash
docker-compose exec postgres psql -U yadopera_user -d yadopera -c "SELECT session_id FROM conversations WHERE facility_id = 1 ORDER BY created_at DESC LIMIT 1;"
```

---

## 4. 修正案の実装

### 4.1 問題1の修正（最優先）

**修正ファイル**: `frontend/src/components/admin/QRCodeForm.vue`

**修正内容**:
```typescript
const canGeneratePreview = computed(() => {
  if (!formData.value.location) return false
  if (formData.value.location === 'custom' && !formData.value.custom_location_name.trim()) {
    return false
  }
  // セッション統合トークン埋め込みの場合、primary_session_idが必須
  if (formData.value.include_session_token && !formData.value.primary_session_id.trim()) {
    return false
  }
  return true
})
```

### 4.2 問題2の修正（要検討）

**修正内容**:
1. QRコード生成時に、データベースに保存する機能を追加
2. 生成済みQRコード一覧を取得するAPIを追加
3. ページ読み込み時に、生成済みQRコード一覧を取得する機能を追加

**ただし、これは大きな機能追加になるため、Phase 1の完了条件に含まれているか確認が必要です。**

---

## 5. まとめ

### 5.1 問題1: プレビュー生成エラー

**原因**:
- `include_session_token`が`True`になった時点で、`watch`が発火し、`generatePreview()`が呼ばれる
- しかし、この時点では`primary_session_id`がまだ空文字列のため、バックエンドでエラーが発生

**修正案**:
- `canGeneratePreview`に`primary_session_id`のチェックを追加
- `include_session_token`が`True`の場合、`primary_session_id`が入力されている場合のみプレビューを生成可能にする

**優先度**: **最優先**（即座に修正が必要）

### 5.2 問題2: 生成済みQRコード一覧がリロードで消える

**原因**:
- `generatedQRCodes`がフロントエンドの`ref`（メモリ）にのみ保存されている
- データベースに保存されていない

**回答**:
- **現在の動作は実装仕様通りです**
- **ユーザーの要望を考慮すると、保持されるべきです**
- **修正が必要ですが、大きな機能追加になるため、Phase 1の完了条件に含まれているか確認が必要です**

**優先度**: **要検討**（Phase 1の完了条件を確認）

### 5.3 テストデータ: プライマリセッションID

**取得方法**:
1. ゲスト画面でメッセージを送信して会話を作成
2. ブラウザの開発者ツールで、Cookieの`yadopera_session_id`を確認
3. そのセッションIDをプライマリセッションIDとして使用

**または、データベースから直接取得**:
```bash
docker-compose exec postgres psql -U yadopera_user -d yadopera -c "SELECT session_id FROM conversations WHERE facility_id = 1 ORDER BY created_at DESC LIMIT 1;"
```

---

**Document Version**: v1.0  
**Author**: Auto (AI Assistant)  
**Last Updated**: 2025-12-06 09:37  
**Status**: ✅ **調査分析完了、修正案提示完了**

