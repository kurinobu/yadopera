# Phase 1 Week 1 ステップ計画

**作成日**: 2025年11月27日  
**フェーズ**: Phase 1 Week 1（バックエンド基盤）  
**期間**: 1週間  
**目的**: MVP開発のためのバックエンド基盤構築

---

## Week 1 目標

バックエンド基盤を構築し、以下の機能を実装する：

1. FastAPI プロジェクト構造の完成
2. PostgreSQL 接続（pgvector拡張対応）
3. JWT認証システム
4. 基本テーブル実装（Alembicマイグレーション）
5. セッション統合トークンAPI実装

---

## 前提条件

### Phase 0完了確認

- [x] Docker環境構築完了
- [x] PostgreSQL + pgvector拡張有効化済み
- [x] Redis環境構築済み
- [x] FastAPI基本構造作成済み（`main.py`, `config.py`）
- [x] 開発環境動作確認済み

### 必要な環境変数

`backend/.env`に以下が設定されていること：
- `DATABASE_URL`: PostgreSQL接続URL
- `REDIS_URL`: Redis接続URL
- `SECRET_KEY`: JWT署名用シークレットキー
- `OPENAI_API_KEY`: OpenAI APIキー（Week 2で使用）

---

## ステップ詳細

### ステップ1: データベース接続設定（2時間）

**目的**: PostgreSQL（pgvector拡張）への非同期接続を確立

**実装内容**:
1. `backend/app/database.py`作成
   - SQLAlchemy async engine設定
   - SessionLocal作成
   - `get_db`依存性注入関数
   - 接続プール設定

2. `backend/app/redis_client.py`作成
   - Redis接続設定
   - Redisクライアント取得関数

3. `backend/app/main.py`更新
   - データベース接続確認エンドポイント追加
   - 起動時・終了時の接続管理

**確認項目**:
- [ ] `http://localhost:8000/health`でデータベース接続確認
- [ ] Redis接続確認
- [ ] pgvector拡張有効化確認

**参考**: アーキテクチャ設計書 6.1 ディレクトリ構造、7.1 ER図

---

### ステップ2: 基本モデル定義（4時間）

**目的**: SQLAlchemyモデルを定義し、データベーススキーマを構築

**実装内容**:
1. `backend/app/models/__init__.py`作成
2. 基本モデル実装（Week 1で必要なもの）:
   - `backend/app/models/user.py` - ユーザーモデル
   - `backend/app/models/facility.py` - 施設モデル
   - `backend/app/models/conversation.py` - 会話セッションモデル
   - `backend/app/models/message.py` - メッセージモデル
   - `backend/app/models/session_token.py` - セッション統合トークンモデル（v0.3新規）

**モデル定義のポイント**:
- SQLAlchemy 2.0+ のasync対応構文を使用
- pgvector対応（`vector(1536)`型）
- リレーションシップ定義
- インデックス定義

**確認項目**:
- [ ] 各モデルが正しく定義されている
- [ ] リレーションシップが正しく設定されている
- [ ] pgvector型が正しく使用されている

**参考**: アーキテクチャ設計書 7.2 テーブル定義詳細

---

### ステップ3: Alembicマイグレーション作成（3時間）

**目的**: データベーススキーマをマイグレーションで管理

**実装内容**:
1. 初期マイグレーションファイル作成:
   - `backend/alembic/versions/002_initial_tables.py`
     - users, facilities, conversations, messages, session_tokensテーブル作成
     - インデックス作成
     - pgvector拡張確認（既に有効化済み）

2. マイグレーション実行:
   ```bash
   cd backend
   alembic upgrade head
   ```

3. マイグレーション確認:
   ```bash
   alembic current
   alembic history
   ```

**確認項目**:
- [ ] マイグレーションが正常に実行される
- [ ] テーブルが正しく作成される
- [ ] インデックスが正しく作成される
- [ ] pgvector拡張が有効化されている

**参考**: アーキテクチャ設計書 7.4 マイグレーション管理

---

### ステップ4: Pydanticスキーマ定義（2時間）

**目的**: APIリクエスト・レスポンスのバリデーション用スキーマを定義

**実装内容**:
1. `backend/app/schemas/__init__.py`作成
2. 基本スキーマ実装:
   - `backend/app/schemas/auth.py` - 認証関連スキーマ
   - `backend/app/schemas/facility.py` - 施設関連スキーマ
   - `backend/app/schemas/chat.py` - チャット関連スキーマ
   - `backend/app/schemas/session.py` - セッション統合トークン関連スキーマ（v0.3新規）

**スキーマ定義のポイント**:
- Pydantic v2構文を使用
- リクエスト・レスポンスモデル分離
- バリデーションルール定義

**確認項目**:
- [ ] 各スキーマが正しく定義されている
- [ ] バリデーションが正しく動作する

**参考**: アーキテクチャ設計書 8.3 APIリクエスト・レスポンス詳細

---

### ステップ5: JWT認証システム実装（4時間）

**目的**: 管理画面用のJWT認証システムを実装

**実装内容**:
1. `backend/app/core/security.py`作成
   - パスワードハッシュ化（bcrypt）
   - パスワード検証関数

2. `backend/app/core/jwt.py`作成
   - JWTトークン生成関数
   - JWTトークン検証関数
   - トークンデコード関数

3. `backend/app/api/deps.py`作成
   - `get_current_user`依存性注入関数
   - JWT認証ミドルウェア

4. `backend/app/api/v1/auth.py`作成
   - `POST /api/v1/auth/login` - ログインエンドポイント
   - `POST /api/v1/auth/logout` - ログアウトエンドポイント（JWT無効化）

5. `backend/app/services/auth_service.py`作成
   - 認証ビジネスロジック
   - ユーザー検証

6. `backend/app/main.py`更新
   - 認証ルーター登録

**確認項目**:
- [ ] ログインAPIが正常に動作する
   - 正しい認証情報でログイン成功
   - 間違った認証情報でログイン失敗
- [ ] JWTトークンが正しく生成される
- [ ] JWTトークンが正しく検証される
- [ ] ログアウトAPIが正常に動作する

**参考**: アーキテクチャ設計書 3.2 APIエンドポイント詳細構造（認証系）、8.2 RESTful API エンドポイント一覧

---

### ステップ6: セッション統合トークンAPI実装（4時間）

**目的**: デバイス間セッション統合機能を実装（v0.3新規）

**実装内容**:
1. `backend/app/services/session_token_service.py`作成
   - トークン生成ロジック（4桁英数字）
   - トークン検証ロジック
   - セッション統合ロジック

2. `backend/app/api/v1/session.py`作成
   - `POST /api/v1/session/link` - セッション統合エンドポイント
   - `GET /api/v1/session/token/{token}` - トークン検証エンドポイント

3. `backend/app/schemas/session.py`更新
   - セッション統合リクエスト・レスポンススキーマ

4. `backend/app/main.py`更新
   - セッションルーター登録

**実装詳細**:
- トークン生成: 4桁英数字（例: `AB12`）
- 有効期限: 24時間
- セッション統合: 複数のセッションIDを1つのトークンに紐付け

**確認項目**:
- [ ] トークン生成APIが正常に動作する
- [ ] トークン検証APIが正常に動作する
- [ ] セッション統合APIが正常に動作する
- [ ] トークン有効期限が正しく管理される

**参考**: 
- 要約定義書 3.1 ゲスト側機能（セッション管理）
- アーキテクチャ設計書 5.4 セッション管理フロー（セッション統合フロー）
- アーキテクチャ設計書 7.2 テーブル定義詳細（session_tokens）

---

### ステップ7: 施設情報取得API実装（2時間）

**目的**: ゲスト側で使用する施設情報取得APIを実装

**実装内容**:
1. `backend/app/services/facility_service.py`作成
   - 施設情報取得ロジック
   - slugによる検索

2. `backend/app/api/v1/facility.py`作成
   - `GET /api/v1/facility/{slug}` - 施設情報取得エンドポイント（公開）

3. `backend/app/main.py`更新
   - 施設ルーター登録

**確認項目**:
- [ ] 施設情報取得APIが正常に動作する
- [ ] slugによる検索が正しく動作する
- [ ] 存在しない施設の場合、適切なエラーレスポンスが返る

**参考**: アーキテクチャ設計書 8.3 APIリクエスト・レスポンス詳細（GET /api/v1/facility/{slug}）

---

### ステップ8: エラーハンドリング・例外処理（2時間）

**目的**: 統一されたエラーレスポンスと例外処理を実装

**実装内容**:
1. `backend/app/core/exceptions.py`作成
   - カスタム例外クラス定義
   - HTTPException拡張

2. `backend/app/main.py`更新
   - グローバル例外ハンドラー登録
   - エラーレスポンス形式統一

**確認項目**:
- [ ] エラーが適切な形式で返される
- [ ] 404エラーが正しく処理される
- [ ] 500エラーが正しく処理される
- [ ] バリデーションエラーが正しく処理される

**参考**: アーキテクチャ設計書 3.4 エラーレスポンス構造

---

### ステップ9: API統合・動作確認（2時間）

**目的**: 実装したAPIを統合し、動作確認を行う

**実装内容**:
1. `backend/app/api/v1/router.py`作成
   - 全APIルーターを統合

2. `backend/app/main.py`更新
   - APIルーター登録
   - Swagger UI確認

3. 動作確認:
   - 各エンドポイントの動作確認
   - Swagger UIでのAPI仕様確認
   - エラーハンドリング確認

**確認項目**:
- [ ] 全APIエンドポイントが正常に動作する
- [ ] Swagger UIが正しく表示される
- [ ] API仕様が正しく表示される
- [ ] エラーハンドリングが正しく動作する

**参考**: アーキテクチャ設計書 3.1 APIルーター構造

---

### ステップ10: テストコード作成（オプション、時間があれば）

**目的**: 基本的なテストコードを作成し、品質を担保

**実装内容**:
1. `backend/tests/`ディレクトリ作成
2. 基本テスト実装:
   - `backend/tests/test_auth.py` - 認証テスト
   - `backend/tests/test_session_token.py` - セッション統合トークンテスト

**確認項目**:
- [ ] テストが正常に実行される
- [ ] テストカバレッジが適切である

---

## 実装順序の推奨

1. **ステップ1**: データベース接続設定（基盤）
2. **ステップ2**: 基本モデル定義（データ構造）
3. **ステップ3**: Alembicマイグレーション（データベーススキーマ）
4. **ステップ4**: Pydanticスキーマ定義（API仕様）
5. **ステップ5**: JWT認証システム（認証基盤）
6. **ステップ6**: セッション統合トークンAPI（v0.3新規機能）
7. **ステップ7**: 施設情報取得API（基本API）
8. **ステップ8**: エラーハンドリング（品質向上）
9. **ステップ9**: API統合・動作確認（統合テスト）
10. **ステップ10**: テストコード作成（オプション）

---

## 各ステップの工数見積もり

| ステップ | 工数 | 累計工数 |
|---------|------|---------|
| ステップ1: データベース接続設定 | 2時間 | 2時間 |
| ステップ2: 基本モデル定義 | 4時間 | 6時間 |
| ステップ3: Alembicマイグレーション | 3時間 | 9時間 |
| ステップ4: Pydanticスキーマ定義 | 2時間 | 11時間 |
| ステップ5: JWT認証システム | 4時間 | 15時間 |
| ステップ6: セッション統合トークンAPI | 4時間 | 19時間 |
| ステップ7: 施設情報取得API | 2時間 | 21時間 |
| ステップ8: エラーハンドリング | 2時間 | 23時間 |
| ステップ9: API統合・動作確認 | 2時間 | 25時間 |
| ステップ10: テストコード作成（オプション） | 3時間 | 28時間 |

**合計**: 約25-28時間（1週間で実装可能）

---

## 実装時の注意事項

### 1. 非同期処理
- SQLAlchemy 2.0+ のasync構文を使用
- `async def`、`await`を適切に使用
- データベース接続は非同期で管理

### 2. pgvector対応
- `vector(1536)`型を正しく使用
- インデックス作成時に`ivfflat`を使用
- Week 2で使用するため、準備のみ

### 3. JWT認証
- `python-jose`ライブラリを使用
- トークン有効期限を適切に設定（7日間）
- セキュリティを考慮した実装

### 4. セッション統合トークン
- 4桁英数字の生成ロジック
- 有効期限管理（24時間）
- セッションIDの統合ロジック

### 5. エラーハンドリング
- 統一されたエラーレスポンス形式
- 適切なHTTPステータスコード
- エラーメッセージの国際化対応（将来）

---

## 完了基準

Week 1完了の基準：

- [ ] データベース接続が正常に動作する
- [ ] 基本テーブルが正しく作成されている
- [ ] JWT認証システムが正常に動作する
- [ ] セッション統合トークンAPIが正常に動作する
- [ ] 施設情報取得APIが正常に動作する
- [ ] Swagger UIでAPI仕様が確認できる
- [ ] エラーハンドリングが適切に実装されている

---

## 次のステップ（Week 2）

Week 1完了後、Week 2（AI対話エンジン）に進む：

- OpenAI API 統合
- RAG実装
- 信頼度スコア改善版実装
- 安全カテゴリ強制エスカレーション実装
- 夜間対応キュー実装
- フォールバック文言実装

---

## 参考資料

### 主要ドキュメント
- **要約定義書**: `docs/Summary/yadopera-v03-summary.md`
- **アーキテクチャ設計書**: `docs/Architecture/やどぺら_v0.3_アーキテクチャ設計書.md`
- **Phase 0引き継ぎ書**: `docs/Phase0_引き継ぎ書.md`

### 実装参考セクション
- アーキテクチャ設計書 6.1 ディレクトリ構造
- アーキテクチャ設計書 7.2 テーブル定義詳細
- アーキテクチャ設計書 7.4 マイグレーション管理
- アーキテクチャ設計書 8.2 RESTful API エンドポイント一覧
- アーキテクチャ設計書 8.3 APIリクエスト・レスポンス詳細

---

**Document Version**: v1.0  
**Author**: Air  
**Last Updated**: 2025-11-27  
**Status**: Phase 1 Week 1 ステップ計画完了


