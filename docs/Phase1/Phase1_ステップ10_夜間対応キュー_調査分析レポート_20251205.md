# Phase 1: ステップ10 夜間対応キュー 調査分析レポート

**作成日**: 2025年12月5日  
**実施者**: Auto (AI Assistant)  
**対象**: 夜間対応キュー専用ページの3点の調査分析  
**状態**: ✅ **調査分析完了**

---

## 1. 調査項目

### 1.1 調査対象

1. **数値のロジック**: 未対応2、対応済み2、合計2の整合性
2. **各キューにボタン設置**: 個別対応ができない問題
3. **「手動実行」ボタンの整合性**: 「処理対象の質問はありません。」と表示されるが、未対応が2件ある問題

---

## 2. 調査結果

### 2.1 数値のロジックについて

#### 2.1.1 現在の表示

- **未対応**: 2
- **対応済み**: 2
- **合計**: 2

#### 2.1.2 バックエンドのロジック

**ファイル**: `backend/app/api/v1/admin/overnight_queue.py`

```python
# 統計情報を計算
all_queues = await queue_service.get_overnight_queue(
    facility_id=facility_id,
    db=db,
    include_resolved=True
)
pending_count = sum(1 for q in all_queues if q.resolved_at is None)
resolved_count = sum(1 for q in all_queues if q.resolved_at is not None)

# レスポンスに変換
queue_responses = [
    OvernightQueueResponse(...)
    for queue in queues  # ← include_resolved=Falseで取得したキュー
]

return OvernightQueueListResponse(
    queues=queue_responses,
    total=len(queue_responses),  # ← 問題: 未解決のみの数
    pending_count=pending_count,
    resolved_count=resolved_count
)
```

#### 2.1.3 問題点

**問題**: `total`の計算ロジックが間違っている

- `total=len(queue_responses)`は、`include_resolved=False`で取得したキュー数なので、**未解決のみ**がカウントされている
- しかし、`pending_count`と`resolved_count`は`include_resolved=True`で取得した**全キュー**から計算されている
- つまり、`total`は`pending_count`と一致するはずだが、実際には`resolved_count`が2ということは、対応済みが2件あるということ
- **矛盾**: `total`が2、`pending_count`が2、`resolved_count`が2 → `total`は4であるべき

#### 2.1.4 正しいロジック

**修正案**:
```python
return OvernightQueueListResponse(
    queues=queue_responses,
    total=len(all_queues),  # ← 全キュー数（未解決+解決済み）
    pending_count=pending_count,
    resolved_count=resolved_count
)
```

**期待される結果**:
- **未対応**: 2
- **対応済み**: 2
- **合計**: 4（2 + 2）

---

### 2.2 各キューにボタン設置について

#### 2.2.1 現在の状態

**ファイル**: `frontend/src/components/admin/OvernightQueueList.vue`

- ヘッダーに「対応する」ボタンがある
- 各キューアイテムには「対応済み」ボタンがない（コメントで削除されている）
- 個別対応ができない

#### 2.2.2 問題点

**問題**: 統一パターンに修正した際に、各キューアイテムの「対応済み」ボタンを削除してしまった

- ダッシュボードの「夜間対応キュー」セクションでは、概要表示のみで「対応する」ボタンで専用ページに遷移する（正しい）
- しかし、専用ページ（`OvernightQueue.vue`）では、各キューアイテムに「対応済み」ボタンが必要

#### 2.2.3 修正案

**ファイル**: `frontend/src/components/admin/OvernightQueueList.vue`

**修正内容**:
1. 各キューアイテムに「対応済み」ボタンを追加
2. `handleResolve`イベントをemitする
3. 親コンポーネント（`OvernightQueue.vue`）で`handleResolve`を実装（既に実装済み）

**修正コード**:
```vue
<div class="ml-4 flex-shrink-0">
  <button
    v-if="!item.resolved_at"
    @click="handleResolve(item)"
    class="px-3 py-1.5 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 rounded-lg transition-colors"
  >
    対応済み
  </button>
</div>
```

```typescript
const emit = defineEmits<{
  viewAll: []
  resolve: [item: OvernightQueue]  // ← 追加
}>()

const handleResolve = (item: OvernightQueue) => {
  emit('resolve', item)
}
```

**注意**: ダッシュボードの`OvernightQueueList`コンポーネントでは、`resolve`イベントをemitしない（概要表示のみ）

---

### 2.3 「手動実行」ボタンの整合性について

#### 2.3.1 現在の状態

- 「処理対象の質問はありません。」と表示される
- しかし、未対応が2件ある

#### 2.3.2 バックエンドのロジック

**ファイル**: `backend/app/services/overnight_queue_service.py`

```python
async def process_scheduled_notifications(
    self,
    db: AsyncSession,
    facility_id: Optional[int] = None
) -> List[OvernightQueue]:
    now = datetime.utcnow()
    
    # 8:00-8:30の範囲で未通知のキューを取得
    query = select(OvernightQueue).where(
        OvernightQueue.scheduled_notify_at >= now.replace(hour=8, minute=0, second=0, microsecond=0),
        OvernightQueue.scheduled_notify_at < now.replace(hour=8, minute=30, second=0, microsecond=0),
        OvernightQueue.notified_at.is_(None)
    )
```

#### 2.3.3 問題点

**問題**: 時刻条件が厳しすぎる

- `process_scheduled_notifications`は、`scheduled_notify_at`が**8:00-8:30の範囲**で、かつ`notified_at`が`None`のキューを処理する
- 現在のUTC時刻は**4時**なので、8:00-8:30の範囲外である
- つまり、現在時刻が8:00-8:30の範囲外の場合、処理対象がない

**現在の時刻**: UTC 4:01（日本時間 13:01）

**テストデータの`scheduled_notify_at`**: 2025-12-05 23:00:00（UTC） = 2025-12-06 08:00:00（JST）

- テストデータは翌朝8:00（JST）に設定されている
- しかし、現在時刻が4:01（UTC）なので、8:00-8:30の範囲外である
- つまり、処理対象がない

#### 2.3.4 整合性の確認

**整合性**: **正しい**

- 「処理対象の質問はありません。」というメッセージは正しい
- 未対応が2件あるが、それらは翌朝8:00（JST）に通知予定なので、現在時刻（4:01 UTC = 13:01 JST）では処理対象外
- ただし、ユーザーにとっては分かりにくい

#### 2.3.5 改善案

**改善案1**: メッセージを改善
```typescript
if (result.processed_count > 0) {
  alert(`${result.processed_count}件の質問をスタッフへ通知しました。`)
} else {
  // より詳細なメッセージ
  const now = new Date()
  const hour = now.getHours()
  if (hour < 8 || hour >= 8.5) {
    alert('処理対象の質問はありません。\n（通知予定時刻: 翌朝8:00）')
  } else {
    alert('処理対象の質問はありません。')
  }
}
```

**改善案2**: ロジックを改善（MVP期間中は時刻条件を緩和）
```python
# MVP期間中: 時刻条件を緩和（未通知のキューをすべて処理）
if facility_id:
    query = query.where(OvernightQueue.facility_id == facility_id)
    # MVP期間中: 時刻条件を緩和
    query = query.where(OvernightQueue.notified_at.is_(None))
else:
    # 本番環境: 時刻条件を厳密に
    query = query.where(
        OvernightQueue.scheduled_notify_at >= now.replace(hour=8, minute=0, second=0, microsecond=0),
        OvernightQueue.scheduled_notify_at < now.replace(hour=8, minute=30, second=0, microsecond=0),
        OvernightQueue.notified_at.is_(None)
    )
```

---

## 3. コンソール警告について

### 3.1 警告内容

```
[Vue warn]: Property "handleQueueViewAll" was accessed during render but is not defined on instance.
```

### 3.2 原因

**ファイル**: `frontend/src/views/admin/Dashboard.vue`

- `handleQueueViewAll`は定義されているが、Vueのレンダリング時にアクセスできない
- おそらく、`<OvernightQueueList @view-all="handleQueueViewAll" />`の部分で、`handleQueueViewAll`が正しくバインドされていない

### 3.3 確認

**ファイル**: `frontend/src/views/admin/Dashboard.vue`

```typescript
const handleQueueViewAll = () => {
  // 夜間対応キュー専用ページへの遷移はOvernightQueueListコンポーネント内で処理
  // この関数は必要に応じて追加の処理を行う（現時点では不要）
}
```

**問題**: 関数は定義されているが、Vueのレンダリング時にアクセスできない可能性がある

**修正案**: 関数を削除するか、正しくバインドする

```vue
<OvernightQueueList
  :queue="overnightQueue"
  @view-all="() => {}"  // ← 空の関数を直接指定
/>
```

または

```typescript
const handleQueueViewAll = () => {
  // 何もしない（空実装）
}
```

---

## 4. まとめ

### 4.1 問題点

1. **数値のロジック**: `total`の計算が間違っている（未解決のみをカウントしている）
2. **各キューにボタン設置**: 専用ページで各キューアイテムに「対応済み」ボタンがない
3. **「手動実行」ボタンの整合性**: ロジックは正しいが、メッセージが分かりにくい

### 4.2 修正案

1. **数値のロジック**: `total=len(all_queues)`に修正
2. **各キューにボタン設置**: `OvernightQueueList.vue`に「対応済み」ボタンを追加（専用ページ用）
3. **「手動実行」ボタンの整合性**: メッセージを改善するか、MVP期間中は時刻条件を緩和

### 4.3 コンソール警告

- `handleQueueViewAll`のバインドを確認するか、空の関数を直接指定する

---

**Document Version**: v1.0  
**Author**: Auto (AI Assistant)  
**Last Updated**: 2025-12-05  
**Status**: ✅ **調査分析完了**


