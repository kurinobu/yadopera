# Phase 1: QRコード設置場所別設計意図 説明書

**作成日**: 2025年12月4日  
**実施者**: Auto (AI Assistant)  
**対象**: QRコードの設置場所別の設計意図と用途の説明

---

## 1. QRコード設置場所別の設計意図

### 1.1 主な目的

QRコードを設置場所別に区別している主な理由は、以下の通りです：

#### 1.1.1 **ゲストの行動分析と統計**

**目的**: ゲストがどの場所でQRコードを読み取ったかを記録し、後で分析できるようにする

**実装**:
- QRコードのURLに`location`パラメータが含まれる: `https://yadopera.com/f/{facility_slug}?location={location}`
- ゲストがQRコードを読み取ると、この`location`情報が会話（Conversation）テーブルに保存される
- 会話テーブルの`location`カラムに保存される: `'entrance'`, `'room'`, `'kitchen'`, `'lounge'`, `'custom'`

**コード確認**:
```python:22:22:backend/app/models/conversation.py
location = Column(String(50))  # 'entrance', 'room', 'kitchen', 'lounge'
```

```python:192:252:backend/app/services/chat_service.py
async def _get_or_create_conversation(
    self,
    facility_id: int,
    session_id: Optional[str],
    language: str,
    location: Optional[str] = None,
    user_agent: Optional[str] = None,
    ip_address: Optional[str] = None
) -> Conversation:
    """
    会話の取得または新規作成
    
    Args:
        facility_id: 施設ID
        session_id: セッションID（Noneの場合は新規生成）
        language: 言語コード
        location: QRコード設置場所（オプション）
        user_agent: ユーザーエージェント（オプション）
        ip_address: IPアドレス（オプション）
    
    Returns:
        Conversation: 会話オブジェクト
    """
    # ... 省略 ...
    if conversation:
        # 既存の会話を更新
        conversation.last_activity_at = datetime.utcnow()
        if location:
            conversation.location = location
    else:
        # 新規会話を作成
        conversation = Conversation(
            facility_id=facility_id,
            session_id=session_id,
            guest_language=language,
            location=location,
            user_agent=user_agent,
            ip_address=ip_address,
            started_at=datetime.utcnow(),
            last_activity_at=datetime.utcnow()
        )
```

**活用例**:
- 「入口でQRコードを読み取ったゲストが多い」
- 「客室でQRコードを読み取ったゲストの質問内容は何が多いか」
- 「キッチンでQRコードを読み取ったゲストは、どのような質問をするか」

#### 1.1.2 **場所別のFAQ最適化**

**目的**: 設置場所に応じて、適切なFAQを優先的に表示する

**設計意図**:
- 入口でQRコードを読み取ったゲストには、チェックイン関連のFAQを優先表示
- 客室でQRコードを読み取ったゲストには、設備・サービス関連のFAQを優先表示
- キッチンでQRコードを読み取ったゲストには、キッチン使用方法関連のFAQを優先表示

**現在の実装状況**:
- 現在の実装では、location情報は会話に保存されるが、FAQの優先表示には使用されていない
- Phase 2以降で実装予定の可能性がある

#### 1.1.3 **場所別のコンテキスト情報の提供**

**目的**: 設置場所に応じて、AI応答にコンテキスト情報を追加する

**設計意図**:
- 入口でQRコードを読み取ったゲストには、「入口にいます」というコンテキスト情報を追加
- 客室でQRコードを読み取ったゲストには、「客室にいます」というコンテキスト情報を追加
- これにより、AI応答がより適切になる可能性がある

**現在の実装状況**:
- 現在の実装では、location情報は会話に保存されるが、AI応答のコンテキストには使用されていない
- Phase 2以降で実装予定の可能性がある

#### 1.1.4 **複数QRコードの管理**

**目的**: 施設内の複数の場所にQRコードを設置し、それぞれを区別して管理する

**設計意図**:
- 施設内の複数の場所（入口、客室、キッチン、ラウンジなど）にQRコードを設置できる
- それぞれのQRコードを区別して管理し、必要に応じて個別に更新・再発行できる
- カスタム設置場所名を使用することで、施設ごとに柔軟に対応できる

**実装**:
- QRコード生成時に、設置場所を指定できる
- 生成されたQRコードは、設置場所情報を含むURLを持つ
- 管理画面で、生成済みQRコード一覧を表示し、場所別に管理できる

---

## 2. 現在の実装状況

### 2.1 実装済み機能

1. **QRコード生成時の設置場所指定**
   - 設置場所（entrance, room, kitchen, lounge, custom）を選択できる
   - カスタム設置場所名を入力できる

2. **会話へのlocation情報の保存**
   - ゲストがQRコードを読み取ると、location情報が会話に保存される
   - 既存の会話がある場合も、location情報が更新される

3. **URLパラメータとしてのlocation**
   - QRコードのURLに`location`パラメータが含まれる
   - ゲストがQRコードを読み取ると、このパラメータが使用される

### 2.2 未実装機能（Phase 2以降で実装予定の可能性）

1. **場所別のFAQ優先表示**
   - 現在の実装では、location情報は会話に保存されるが、FAQの優先表示には使用されていない

2. **場所別のAI応答コンテキスト**
   - 現在の実装では、location情報は会話に保存されるが、AI応答のコンテキストには使用されていない

3. **場所別の統計分析**
   - 現在の実装では、location情報は会話に保存されるが、ダッシュボードでの統計分析には使用されていない（Phase 2以降で実装予定の可能性がある）

---

## 3. 設計意図のまとめ

### 3.1 主な目的

1. **ゲストの行動分析と統計**（実装済み）
   - ゲストがどの場所でQRコードを読み取ったかを記録
   - 後で分析できるようにする

2. **複数QRコードの管理**（実装済み）
   - 施設内の複数の場所にQRコードを設置できる
   - それぞれを区別して管理できる

3. **場所別のFAQ最適化**（未実装、Phase 2以降で実装予定の可能性）
   - 設置場所に応じて、適切なFAQを優先的に表示

4. **場所別のコンテキスト情報の提供**（未実装、Phase 2以降で実装予定の可能性）
   - 設置場所に応じて、AI応答にコンテキスト情報を追加

### 3.2 将来的な活用可能性

1. **ダッシュボードでの統計表示**
   - 場所別のQRコード読み取り数
   - 場所別の質問数
   - 場所別のエスカレーション数

2. **場所別のFAQ自動学習**
   - 場所別の未解決質問を分析
   - 場所別のFAQを自動生成

3. **場所別のAI応答最適化**
   - 場所別のコンテキスト情報を追加
   - 場所別のFAQを優先的に使用

---

## 4. 回答

### 4.1 質問への回答

**質問**: QRコードを新しく発行したり、場所ごとにQRコードを区別しているのは、ゲストがどこの場所でQRコードを読み込んだかを後で分析できるからですか？

**回答**: **はい、その通りです。** 主な目的は、ゲストがどの場所でQRコードを読み取ったかを記録し、後で分析できるようにすることです。

### 4.2 その他の理由

1. **複数QRコードの管理**
   - 施設内の複数の場所にQRコードを設置し、それぞれを区別して管理できる

2. **将来的な機能拡張**
   - 場所別のFAQ最適化（Phase 2以降で実装予定の可能性）
   - 場所別のAI応答コンテキスト（Phase 2以降で実装予定の可能性）
   - 場所別の統計分析（Phase 2以降で実装予定の可能性）

3. **柔軟な運用**
   - カスタム設置場所名を使用することで、施設ごとに柔軟に対応できる

---

## 5. まとめ

QRコードの設置場所別の設計意図は、主に以下の通りです：

1. **ゲストの行動分析と統計**（実装済み）
   - ゲストがどの場所でQRコードを読み取ったかを記録
   - 後で分析できるようにする

2. **複数QRコードの管理**（実装済み）
   - 施設内の複数の場所にQRコードを設置できる
   - それぞれを区別して管理できる

3. **将来的な機能拡張**（未実装、Phase 2以降で実装予定の可能性）
   - 場所別のFAQ最適化
   - 場所別のAI応答コンテキスト
   - 場所別の統計分析

現在の実装では、location情報は会話に保存されるが、分析や統計には使用されていません。Phase 2以降で、これらの機能が実装される可能性があります。

---

**Document Version**: v1.0  
**Author**: Auto (AI Assistant)  
**Last Updated**: 2025-12-04  
**Status**: ✅ **説明完了**


