# Phase 1: ステップ10 夜間対応キュー 設定と説明文 調査分析レポート

**作成日**: 2025年12月5日  
**実施者**: Auto (AI Assistant)  
**対象**: 夜間時間帯設定と説明文の調査分析  
**状態**: ✅ **調査分析完了**

---

## 1. 調査項目

### 1.1 調査対象

1. **「夜間（22:00-8:00）」設定の場所と修正方法**
2. **「手動実行」ボタンの意味と「MVP期間中」文言の問題**

---

## 2. 調査結果

### 2.1 「夜間（22:00-8:00）」設定について

#### 2.1.1 現在の設定場所

**ファイル**: `backend/app/services/overnight_queue_service.py`

```python
class OvernightQueueService:
    """
    夜間対応キュー管理サービス（v0.3新規）
    """
    
    NIGHT_START = time(22, 0)  # 22:00
    NIGHT_END = time(8, 0)     # 8:00
```

**問題点**:
- 夜間時間帯（22:00-8:00）が**ハードコード**されている
- 施設モデル（`Facility`）に夜間時間帯の設定フィールドがない
- 施設管理者が修正する方法がない

#### 2.1.2 使用箇所

**1. 夜間対応キューへの追加判定**
- **ファイル**: `backend/app/services/chat_service.py`
- **ロジック**: エスカレーション発生時に、現在時刻が22:00-8:00の範囲内かどうかを判定

**2. 翌朝8:00の通知時刻計算**
- **ファイル**: `backend/app/services/overnight_queue_service.py`
- **ロジック**: 夜間時間帯にエスカレーションが発生した場合、翌朝8:00に通知予定時刻を設定

#### 2.1.3 施設モデルの確認

**ファイル**: `backend/app/models/facility.py`

**現在のフィールド**:
- `timezone`: タイムゾーン設定（例: "Asia/Tokyo"）
- `check_in_time`: チェックイン時間（例: 15:00）
- `check_out_time`: チェックアウト時間（例: 11:00）
- **夜間時間帯の設定フィールドは存在しない**

#### 2.1.4 施設設定画面の確認

**調査結果**:
- 施設設定画面（`Settings.vue`、`FacilitySettings.vue`など）が存在しない
- 施設情報を編集する画面が存在しない
- 施設管理者が設定を変更する方法がない

#### 2.1.5 問題点のまとめ

**問題**:
1. 夜間時間帯（22:00-8:00）がハードコードされている
2. 施設モデルに夜間時間帯の設定フィールドがない
3. 施設設定画面が存在しない
4. 施設管理者が修正する方法がない

**影響**:
- 施設ごとに異なる夜間時間帯を設定できない
- 施設管理者が自施設の営業時間に合わせて設定を変更できない

---

### 2.2 「手動実行」ボタンと「MVP期間中」について

#### 2.2.1 「手動実行」ボタンの意味

**現在の説明文**:
```
夜間（22:00-8:00）にエスカレーションされた質問は、自動的に翌朝8:00にスタッフへ通知されます。
MVP期間中は「手動実行」ボタンで通知処理を実行できます。
```

**実際の動作**:
1. **本来の動作**: 翌朝8:00に自動的に通知処理が実行される（cronジョブなど）
2. **現在の動作**: 自動実行の仕組みがないため、「手動実行」ボタンで手動で通知処理を実行する

**「手動実行」ボタンの機能**:
- **ファイル**: `backend/app/services/overnight_queue_service.py`
- **メソッド**: `process_scheduled_notifications`
- **処理内容**:
  1. `scheduled_notify_at`が8:00-8:30の範囲で、かつ`notified_at`が`None`のキューを取得
  2. 各キューに対して、スタッフへ通知送信（Phase 2で実装予定）
  3. `notified_at`を現在時刻に設定

**問題点**:
- 説明文が不十分で、ユーザーが理解しにくい
- 「MVP期間中」という開発者用の用語が使用されている

#### 2.2.2 「MVP期間中」という文言の問題

**問題点**:
1. **開発者用の用語**: 「MVP期間中」は開発者しか分からない用語
2. **ユーザーにとって意味不明**: 施設管理者には「MVP期間中」の意味が分からない
3. **不適切な表現**: ユーザー向けの説明文に開発者用の用語を使用すべきではない

**使用箇所**:
1. **フロントエンド**: `frontend/src/views/admin/OvernightQueue.vue`
   ```
   MVP期間中は「手動実行」ボタンで通知処理を実行できます。
   ```

2. **バックエンドAPI**: `backend/app/api/v1/admin/overnight_queue.py`
   ```python
   """
   手動実行処理（MVP期間中）
   
   翌朝8:00の一括通知処理を手動で実行します。
   MVP期間中はこのエンドポイントを使用して通知処理を実行します。
   """
   ```

3. **バックエンドサービス**: `backend/app/services/overnight_queue_service.py`
   ```python
   """
   翌朝8:00の一括通知処理（v0.3新規）
   MVP期間中: 手動実行ボタンまたは外部cron対応
   """
   ```

#### 2.2.3 改善案

**説明文の改善案**:

**現在**:
```
夜間（22:00-8:00）にエスカレーションされた質問は、自動的に翌朝8:00にスタッフへ通知されます。
MVP期間中は「手動実行」ボタンで通知処理を実行できます。
```

**改善案1（自動実行の説明を追加）**:
```
夜間（22:00-8:00）にエスカレーションされた質問は、翌朝8:00にスタッフへ通知されます。
現在は自動通知の仕組みが整備中です。「手動実行」ボタンをクリックすると、通知予定時刻が来ている質問をスタッフへ通知します。
```

**改善案2（より簡潔に）**:
```
夜間（22:00-8:00）にエスカレーションされた質問は、翌朝8:00にスタッフへ通知されます。
「手動実行」ボタンをクリックすると、通知予定時刻が来ている質問をスタッフへ通知します。
```

**改善案3（機能説明を明確に）**:
```
夜間（22:00-8:00）にエスカレーションされた質問は、翌朝8:00にスタッフへ通知されます。
「手動実行」ボタンで、通知予定時刻が来ている質問を手動でスタッフへ通知できます。
```

---

## 3. まとめ

### 3.1 「夜間（22:00-8:00）」設定について

**現状**:
- 夜間時間帯がハードコードされている
- 施設管理者が修正する方法がない

**改善案**:
1. **施設モデルに夜間時間帯の設定フィールドを追加**
   - `overnight_start_time`: 夜間開始時刻（例: 22:00）
   - `overnight_end_time`: 夜間終了時刻（例: 8:00）

2. **施設設定画面を作成**
   - 施設情報を編集する画面を作成
   - 夜間時間帯を設定できるUIを追加

3. **サービスロジックを修正**
   - ハードコードされた時間帯を、施設設定から取得するように変更

### 3.2 「手動実行」ボタンと「MVP期間中」について

**現状**:
- 説明文が不十分
- 「MVP期間中」という開発者用の用語が使用されている

**改善案**:
1. **説明文を改善**
   - 「MVP期間中」という文言を削除
   - 「手動実行」ボタンの機能を明確に説明

2. **バックエンドのコメントも修正**
   - 開発者向けのコメントは残すが、ユーザー向けの説明文からは削除

---

**Document Version**: v1.0  
**Author**: Auto (AI Assistant)  
**Last Updated**: 2025-12-05  
**Status**: ✅ **調査分析完了**


