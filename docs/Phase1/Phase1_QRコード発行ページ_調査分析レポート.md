# Phase 1: QRコード発行ページ 調査分析レポート

**作成日**: 2025年12月4日  
**実施者**: Auto (AI Assistant)  
**対象**: QRコード発行ページの使い方の問題点分析  
**目的**: QRコード発行ページの現在の実装を調査分析し、使い方が分かりにくい原因を特定し、改善案を提示

---

## 1. 現在の実装状況

### 1.1 ページ構成

QRコード発行ページは以下の2つのコンポーネントで構成されています：

1. **`QRCodeGenerator.vue`**（メインページ）
   - QRコード発行フォーム（QRCodeFormコンポーネント）
   - 生成済みQRコード一覧

2. **`QRCodeForm.vue`**（フォームコンポーネント）
   - 設置場所選択
   - セッション統合トークン埋め込みオプション
   - QRコードプレビュー（モック）
   - ダウンロードボタン（モック）
   - QRコード生成ボタン

### 1.2 現在のワークフロー

```
1. ユーザーが設置場所を選択
   ↓
2. QRコードプレビューが表示される（モック、外部API使用）
   - プレビューURL: `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=...`
   ↓
3. プレビュー下に「PDF/PNG/SVG ダウンロード」ボタンが表示される
   - これらのボタンは、モックプレビューをダウンロードしようとする
   - 実際のQRコードではない
   ↓
4. 「QRコード生成」ボタンをクリック
   - 実際のAPI（`/api/v1/admin/qr-code`）を呼び出す
   - バックエンドでQRコードを生成（PDF/PNG/SVG形式）
   - 生成されたQRコードを`generatedQRCodes`配列に追加
   ↓
5. 「生成済みQRコード一覧」に表示される
   - ここから実際のQRコードをダウンロードできる
```

---

## 2. 問題点の分析

### 2.1 問題1: プレビューとダウンロードボタンの意味が不明確

**現象**:
- 「QRコードプレビュー」が表示され、その下に「PDF/PNG/SVG ダウンロード」ボタンが並んでいる
- ユーザーは、これらのボタンで実際のQRコードをダウンロードできると誤解する可能性がある

**根本原因**:
- プレビューは**モック**（外部API `api.qrserver.com`を使用）
- プレビュー下のダウンロードボタンは、このモックプレビューをダウンロードしようとする
- 実際のQRコードは、バックエンドAPIで生成されるが、プレビューとは別物

**コード確認**:
```typescript:207:221:frontend/src/components/admin/QRCodeForm.vue
const generatePreview = () => {
  // モック: QRコードURL生成
  const baseUrl = 'https://yadopera.com'
  const facilitySlug = props.facilitySlug || 'facility-1'
  const location = formData.value.location
  const tokenParam = formData.value.include_session_token ? '&token=AB12' : ''
  
  const url = `${baseUrl}/f/${facilitySlug}?location=${location}${tokenParam}`
  qrCodeData.value = url
  
  // モック: QRコード画像生成（実際の実装ではAPIから取得）
  // ここではQRコード生成ライブラリを使用するか、APIから取得
  // モックとして、QRコードAPIを使用（例: https://api.qrserver.com/v1/create-qr-code/）
  previewUrl.value = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`
}
```

**問題点**:
- プレビューはモック（外部API）で、実際のQRコード生成APIとは別
- プレビュー下のダウンロードボタンは、モックをダウンロードしようとする
- 実際のQRコードは「QRコード生成」ボタンを押さないと生成されない

### 2.2 問題2: 「QRコード生成」ボタンの意味が不明確

**現象**:
- プレビューが既に表示されているのに、「QRコード生成」ボタンがある
- ユーザーは「なぜ生成が必要なのか？」と疑問に思う

**根本原因**:
- プレビューは**モック**（外部API）で、実際のQRコードではない
- 「QRコード生成」ボタンは、実際のバックエンドAPIを呼び出してQRコードを生成する
- 生成されたQRコードは「生成済みQRコード一覧」に表示される

**コード確認**:
```typescript:185:215:frontend/src/views/admin/QRCodeGenerator.vue
const handleGenerate = async (data: {
  location: QRCodeLocation
  custom_location_name?: string
  include_session_token: boolean
  format: 'pdf' | 'png' | 'svg'
  primary_session_id?: string
}) => {
  if (loading.value || !facilityId.value) return
  
  try {
    loading.value = true
    error.value = null
    
    const qrCode = await qrcodeApi.generateQRCode({
      location: data.location,
      custom_location_name: data.custom_location_name,
      include_session_token: data.include_session_token,
      format: data.format,
      primary_session_id: data.primary_session_id
    })
    
    generatedQRCodes.value.unshift(qrCode)
    alert('QRコードを生成しました。')
  } catch (err: any) {
    console.error('Generate QR code error:', err)
    error.value = err.response?.data?.detail || 'QRコードの生成に失敗しました'
    alert(error.value)
  } finally {
    loading.value = false
  }
}
```

**問題点**:
- プレビューと実際の生成が別物であることが分かりにくい
- 「QRコード生成」ボタンの意味が不明確
- 生成されたQRコードが「生成済みQRコード一覧」に表示されるが、その存在が分かりにくい

### 2.3 問題3: 2つのダウンロード機能が混在している

**現象**:
- プレビュー下に「PDF/PNG/SVG ダウンロード」ボタンがある（モック）
- 「生成済みQRコード一覧」にも「PDF/PNG/SVG」ボタンがある（実際のQRコード）

**根本原因**:
- プレビュー下のダウンロードボタンは、モックプレビューをダウンロードしようとする
- 「生成済みQRコード一覧」のダウンロードボタンは、実際のQRコードをダウンロードする
- 2つのダウンロード機能が混在しており、どちらが実際のQRコードか分かりにくい

---

## 3. 設計意図の推測

### 3.1 元の設計意図（推測）

1. **プレビュー機能**:
   - ユーザーが設置場所を選択すると、プレビューが表示される
   - プレビューは、実際のQRコードがどのように見えるかを確認するためのもの
   - モック（外部API）を使用して、実際のAPIを呼び出す前にプレビューを表示

2. **QRコード生成機能**:
   - 「QRコード生成」ボタンをクリックすると、実際のバックエンドAPIを呼び出す
   - 生成されたQRコードは「生成済みQRコード一覧」に表示される
   - ここから実際のQRコードをダウンロードできる

3. **ダウンロード機能**:
   - プレビュー下のダウンロードボタンは、モックプレビューをダウンロードしようとする（実装不十分）
   - 「生成済みQRコード一覧」のダウンロードボタンは、実際のQRコードをダウンロードする

### 3.2 実装の不整合

- **プレビュー**: モック（外部API）を使用
- **ダウンロードボタン（プレビュー下）**: モックをダウンロードしようとする（実装不十分）
- **QRコード生成**: 実際のバックエンドAPIを呼び出す
- **ダウンロードボタン（生成済みQRコード一覧）**: 実際のQRコードをダウンロードする

**問題**: プレビューと実際の生成が別物であることが分かりにくい

---

## 4. 改善案

### 4.1 改善案1: プレビューを実際のAPIに置き換える（推奨）

**方針**:
- プレビューも実際のバックエンドAPIを使用する
- プレビュー下のダウンロードボタンで、実際のQRコードをダウンロードできるようにする
- 「QRコード生成」ボタンは、生成済みQRコード一覧に追加するためのボタンとして明確化

**実装内容**:
1. `generatePreview`関数を修正して、実際のAPIを呼び出す
2. プレビュー下のダウンロードボタンで、実際のQRコードをダウンロードできるようにする
3. 「QRコード生成」ボタンのラベルを「生成済みQRコード一覧に追加」などに変更

**メリット**:
- プレビューと実際のQRコードが一致する
- プレビュー下のダウンロードボタンで、実際のQRコードをダウンロードできる
- ユーザー体験が向上する

**デメリット**:
- API呼び出しが増える（設置場所を選択するたびにAPIを呼び出す）
- パフォーマンスへの影響がある可能性

### 4.2 改善案2: プレビューを削除し、生成後に表示する

**方針**:
- プレビューを削除する
- 「QRコード生成」ボタンをクリックすると、QRコードが生成され、すぐに表示される
- 生成されたQRコードからダウンロードできる

**実装内容**:
1. プレビュー機能を削除
2. 「QRコード生成」ボタンをクリックすると、QRコードが生成され、すぐに表示される
3. 生成されたQRコードからダウンロードできる

**メリット**:
- シンプルで分かりやすい
- プレビューと実際のQRコードの不一致がなくなる
- API呼び出しが減る

**デメリット**:
- 生成前にQRコードの見た目を確認できない
- ユーザー体験がやや低下する可能性

### 4.3 改善案3: プレビューと生成を明確に区別する

**方針**:
- プレビューは「プレビュー（モック）」と明示する
- プレビュー下のダウンロードボタンを削除する
- 「QRコード生成」ボタンのラベルを「実際のQRコードを生成する」などに変更
- 生成されたQRコードを「生成済みQRコード一覧」に表示する

**実装内容**:
1. プレビューに「プレビュー（モック）」と明示
2. プレビュー下のダウンロードボタンを削除
3. 「QRコード生成」ボタンのラベルを変更
4. 生成されたQRコードを「生成済みQRコード一覧」に表示

**メリット**:
- 実装が簡単
- プレビューと実際のQRコードの違いが明確になる

**デメリット**:
- プレビュー下のダウンロードボタンが使えない
- ユーザー体験がやや低下する可能性

---

## 5. 推奨改善案

### 5.1 推奨: 改善案1（プレビューを実際のAPIに置き換える）

**理由**:
- プレビューと実際のQRコードが一致する
- プレビュー下のダウンロードボタンで、実際のQRコードをダウンロードできる
- ユーザー体験が最も向上する

**実装手順**:
1. `generatePreview`関数を修正して、実際のAPIを呼び出す
2. プレビュー下のダウンロードボタンで、実際のQRコードをダウンロードできるようにする
3. 「QRコード生成」ボタンのラベルを「生成済みQRコード一覧に追加」などに変更
4. 生成済みQRコード一覧に追加する機能を実装

**注意点**:
- API呼び出しが増えるため、パフォーマンスへの影響を考慮する
- デバウンス処理を追加して、設置場所を選択するたびにAPIを呼び出さないようにする

---

## 6. まとめ

### 6.1 現在の問題点

1. **プレビューとダウンロードボタンの意味が不明確**
   - プレビューはモック（外部API）で、実際のQRコードではない
   - プレビュー下のダウンロードボタンは、モックをダウンロードしようとする

2. **「QRコード生成」ボタンの意味が不明確**
   - プレビューが既に表示されているのに、なぜ生成が必要なのか分からない

3. **2つのダウンロード機能が混在している**
   - プレビュー下のダウンロードボタン（モック）
   - 生成済みQRコード一覧のダウンロードボタン（実際のQRコード）

### 6.2 改善の方向性

- **プレビューを実際のAPIに置き換える**（推奨）
- プレビューと実際のQRコードを一致させる
- プレビュー下のダウンロードボタンで、実際のQRコードをダウンロードできるようにする
- 「QRコード生成」ボタンの意味を明確化する

---

**Document Version**: v1.0  
**Author**: Auto (AI Assistant)  
**Last Updated**: 2025-12-04  
**Status**: ✅ **調査分析完了**


