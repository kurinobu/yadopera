# Phase 1: QRコード重複表示 完全調査分析・修正案

**作成日時**: 2025年12月6日 12:00  
**最終更新日時**: 2025年12月6日 12:00  
**実施者**: Auto (AI Assistant)  
**対象**: QRコード重複表示問題（リロード時の重複、カスタム設置場所名入力時の段階的表示）  
**状態**: ✅ **調査分析完了、修正案提示完了**  
**ファイル名**: `Phase1_QRコード重複表示_完全調査分析_修正案_20251206_1200.md`

---

## 1. 問題の認識

### 1.1 ユーザーが報告した問題

**問題1: リロードすると同じQRコードが複数表示される**
- ページをリロードすると、同じQRコードが複数回表示される

**問題2: カスタム設置場所名入力時の段階的表示**
- カスタムで「ろうか」と入れて作ってリロードすると、「ろ」「ろう」「ろうか」「ろうか」などと一覧に表示される
- これは正しい表示ではない

### 1.2 期待される動作

- 同じQRコードは1つだけ表示される
- カスタム設置場所名を入力中に生成されたプレビュー用QRコードは、一覧に表示されない
- 「生成済みQRコード一覧に追加」ボタンを押した時だけ、データベースに保存される

---

## 2. 原因の調査

### 2.1 問題1: リロード時の重複表示

#### 2.1.1 現在の実装フロー

**QRコード生成時の処理**:

1. **プレビュー生成時** (`QRCodeForm.vue`の`generatePreview`関数):
   ```typescript
   const qrCode = await qrcodeApi.generateQRCode({
     location: formData.value.location as QRCodeLocation,
     custom_location_name: formData.value.location === 'custom' ? formData.value.custom_location_name.trim() : undefined,
     format: 'png'
   })
   ```
   - **問題**: このAPI呼び出しが、バックエンドでデータベースに保存される（`backend/app/api/v1/admin/qr_code.py`の65-76行目）

2. **「生成済みQRコード一覧に追加」ボタン押下時** (`QRCodeGenerator.vue`の`handleGenerate`関数):
   ```typescript
   const qrCode = await qrcodeApi.generateQRCode({
     location: data.location,
     custom_location_name: data.custom_location_name,
     format: data.format
   })
   generatedQRCodes.value.unshift(qrCode)
   ```
   - **問題**: 再度APIを呼び出し、データベースに保存される
   - **問題**: さらに、フロントエンドの`generatedQRCodes`にも追加される

3. **ページリロード時** (`QRCodeGenerator.vue`の`fetchGeneratedQRCodes`関数):
   ```typescript
   const response = await qrcodeApi.listQRCodes()
   generatedQRCodes.value = response.qr_codes
   ```
   - **問題**: データベースから全QRコードを取得して、`generatedQRCodes`に設定する
   - **結果**: プレビュー生成時と「生成済みQRコード一覧に追加」ボタン押下時の両方で保存されたQRコードが表示される

#### 2.1.2 原因の分析

**根本原因**:
- **プレビュー生成時にデータベースに保存されている**
- 「生成済みQRコード一覧に追加」ボタン押下時にもデータベースに保存されている
- その結果、同じQRコードが2回保存される

**データフロー**:
```
1. プレビュー生成
   → API呼び出し
   → データベースに保存（1回目）
   → プレビュー表示

2. 「生成済みQRコード一覧に追加」ボタン押下
   → API呼び出し
   → データベースに保存（2回目）
   → フロントエンドの一覧に追加

3. ページリロード
   → データベースから全QRコードを取得
   → 同じQRコードが2つ表示される
```

### 2.2 問題2: カスタム設置場所名入力時の段階的表示

#### 2.2.1 現在の実装フロー

**カスタム設置場所名入力時の処理** (`QRCodeForm.vue`の`watch`関数):

```typescript
// カスタム設置場所名変更時にプレビューを生成
watch(() => formData.value.custom_location_name, () => {
  if (formData.value.location === 'custom' && formData.value.custom_location_name.trim()) {
    generatePreview()
  }
})
```

**問題**:
- 「ろうか」と入力する過程で、「ろ」「ろう」「ろうか」と3回`generatePreview()`が呼ばれる
- それぞれがデータベースに保存される
- リロード時に、すべてが表示される

#### 2.2.2 原因の分析

**根本原因**:
- **プレビュー生成時にデータベースに保存されている**
- カスタム設置場所名を入力するたびに、プレビューが生成され、データベースに保存される
- デバウンス処理（500ms）があっても、入力が完了するまでに複数回保存される

**データフロー**:
```
1. 「ろ」と入力
   → watchが発火
   → generatePreview()呼び出し（デバウンス500ms）
   → API呼び出し
   → データベースに保存（「ろ」）

2. 「う」を追加して「ろう」になる
   → watchが発火
   → generatePreview()呼び出し（デバウンス500ms）
   → API呼び出し
   → データベースに保存（「ろう」）

3. 「か」を追加して「ろうか」になる
   → watchが発火
   → generatePreview()呼び出し（デバウンス500ms）
   → API呼び出し
   → データベースに保存（「ろうか」）

4. 「生成済みQRコード一覧に追加」ボタン押下
   → API呼び出し
   → データベースに保存（「ろうか」、2回目）

5. ページリロード
   → データベースから全QRコードを取得
   → 「ろ」「ろう」「ろうか」「ろうか」が表示される
```

---

## 3. 修正案

### 3.1 修正案1: プレビュー生成時にデータベースに保存しない（推奨）

#### 3.1.1 概要

**方針**:
- プレビュー生成用のAPIエンドポイントを作成（データベースに保存しない）
- 「生成済みQRコード一覧に追加」ボタン押下時のみ、データベースに保存する

#### 3.1.2 実装内容

**1. バックエンド: プレビュー生成用APIエンドポイントの追加**

**`backend/app/api/v1/admin/qr_code.py`に追加**:
```python
@router.post("/preview", response_model=QRCodeResponse)
async def generate_qr_code_preview(
    request: QRCodeRequest,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """
    QRコードプレビュー生成（データベースに保存しない）
    
    - **location**: 設置場所（entrance/room/kitchen/lounge/custom）
    - **custom_location_name**: カスタム設置場所名（location=customの場合）
    - **format**: 出力形式（pdf/png/svg、デフォルト: png）
    
    JWT認証必須。プレビュー表示用のQRコードを生成します。
    データベースに保存されません。
    """
    try:
        facility_id = current_user.facility_id
        if not facility_id:
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail="User is not associated with any facility"
            )
        
        # QRコードサービスでQRコード生成
        qr_code_service = QRCodeService(db)
        qr_code_data = await qr_code_service.generate_qr_code(
            facility_id=facility_id,
            location=request.location,
            custom_location_name=request.custom_location_name,
            include_session_token=False,  # プレビューでは常にFalse
            format=request.format,
            primary_session_id=None
        )
        
        # データベースに保存しない（プレビュー用）
        # IDは生成時刻ベース（一時的なID）
        qr_code_id = int(datetime.utcnow().timestamp())
        
        return QRCodeResponse(
            id=qr_code_id,
            facility_id=facility_id,
            location=request.location,
            custom_location_name=request.custom_location_name,
            include_session_token=False,
            qr_code_url=qr_code_data["qr_code_url"],
            qr_code_data=qr_code_data["qr_code_data"],
            format=qr_code_data["format"],
            created_at=datetime.utcnow()
        )
    except ValueError as e:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail=str(e)
        )
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Error generating QR code preview: {str(e)}"
        )
```

**2. フロントエンド: APIクライアントの追加**

**`frontend/src/api/qrcode.ts`に追加**:
```typescript
export const qrcodeApi = {
  // ... 既存のメソッド ...

  /**
   * QRコードプレビュー生成（データベースに保存しない）
   */
  async generateQRCodePreview(data: Omit<QRCodeRequest, 'include_session_token' | 'primary_session_id'>): Promise<QRCodeResponse> {
    const response = await apiClient.post<QRCodeResponse>('/admin/qr-code/preview', {
      location: data.location,
      custom_location_name: data.custom_location_name,
      format: data.format
    })
    return response.data
  }
}
```

**3. フロントエンド: QRCodeFormコンポーネントの修正**

**`frontend/src/components/admin/QRCodeForm.vue`の`generatePreview`関数を修正**:
```typescript
// プレビュー生成（実際のAPIを使用）
const generatePreview = async () => {
  if (!canGeneratePreview.value || !props.facilityId) {
    previewUrl.value = null
    qrCodeData.value = ''
    previewQRCode.value = null
    return
  }

  // デバウンス処理（500ms待機）
  if (previewDebounceTimer) {
    clearTimeout(previewDebounceTimer)
  }

  previewDebounceTimer = setTimeout(async () => {
    try {
      previewLoading.value = true
      previewError.value = null

      // プレビュー用APIを呼び出し（データベースに保存しない）
      const qrCode = await qrcodeApi.generateQRCodePreview({
        location: formData.value.location as QRCodeLocation,
        custom_location_name: formData.value.location === 'custom' ? formData.value.custom_location_name.trim() : undefined,
        format: 'png' // プレビューはPNG形式
      })

      previewQRCode.value = qrCode
      previewUrl.value = qrCode.qr_code_url
      qrCodeData.value = qrCode.qr_code_data
    } catch (err: any) {
      console.error('Preview generation error:', err)
      previewError.value = err.response?.data?.detail || 'プレビューの生成に失敗しました'
      previewUrl.value = null
      qrCodeData.value = ''
      previewQRCode.value = null
    } finally {
      previewLoading.value = false
    }
  }, 500)
}
```

**4. フロントエンド: QRCodeGeneratorコンポーネントの修正**

**`frontend/src/views/admin/QRCodeGenerator.vue`の`handleGenerate`関数を修正**:
```typescript
const handleGenerate = async (data: {
  location: QRCodeLocation
  custom_location_name?: string
  format: 'pdf' | 'png' | 'svg'
}) => {
  if (loading.value || !facilityId.value) return
  
  try {
    loading.value = true
    error.value = null
    
    // データベースに保存するAPIを呼び出し
    const qrCode = await qrcodeApi.generateQRCode({
      location: data.location,
      custom_location_name: data.custom_location_name,
      format: data.format
    })
    
    // データベースから最新の一覧を取得（重複を防ぐため）
    await fetchGeneratedQRCodes()
  } catch (err: any) {
    console.error('Generate QR code error:', err)
    error.value = err.response?.data?.detail || 'QRコードの生成に失敗しました'
    alert(error.value)
  } finally {
    loading.value = false
  }
}
```

**変更点**:
- `generatedQRCodes.value.unshift(qrCode)`を削除
- `fetchGeneratedQRCodes()`を呼び出して、データベースから最新の一覧を取得

#### 3.1.3 メリット

- **プレビュー生成時にデータベースに保存されない**
- **カスタム設置場所名入力時の段階的保存が発生しない**
- **「生成済みQRコード一覧に追加」ボタン押下時のみ、データベースに保存される**
- **リロード時の重複表示が発生しない**

### 3.2 修正案2: 重複チェック機能の追加（代替案）

#### 3.2.1 概要

**方針**:
- データベースに保存する前に、同じQRコードが既に存在するかチェック
- 存在する場合は、新規保存せずに既存のQRコードを返す

#### 3.2.2 実装内容

**バックエンド: 重複チェック機能の追加**

**`backend/app/api/v1/admin/qr_code.py`の`generate_qr_code`関数を修正**:
```python
@router.post("", response_model=QRCodeResponse)
async def generate_qr_code(
    request: QRCodeRequest,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    # ... 既存の処理 ...
    
    # 重複チェック（同じ設置場所、同じカスタム設置場所名、同じ形式のQRコードが既に存在するか）
    result = await db.execute(
        select(QRCode)
        .where(QRCode.facility_id == facility_id)
        .where(QRCode.location == request.location)
        .where(QRCode.format == request.format)
        .where(
            (QRCode.custom_location_name == request.custom_location_name) if request.custom_location_name
            else (QRCode.custom_location_name.is_(None))
        )
        .order_by(QRCode.created_at.desc())
    )
    existing_qr_code = result.scalar_one_or_none()
    
    if existing_qr_code:
        # 既存のQRコードを返す（新規保存しない）
        return QRCodeResponse(
            id=existing_qr_code.id,
            facility_id=facility_id,
            location=existing_qr_code.location,
            custom_location_name=existing_qr_code.custom_location_name,
            include_session_token=request.include_session_token,
            qr_code_url=existing_qr_code.qr_code_url,
            qr_code_data=existing_qr_code.qr_code_data,
            format=existing_qr_code.format,
            created_at=existing_qr_code.created_at
        )
    
    # 新規保存
    # ... 既存の保存処理 ...
```

#### 3.2.3 デメリット

- **プレビュー生成時にもデータベースに保存される（問題が残る）**
- **カスタム設置場所名入力時の段階的保存が発生する（問題が残る）**
- **重複チェックのロジックが複雑になる**

**評価**: ❌ **非推奨**（根本的な解決にならない）

---

## 4. 実装手順

### 4.1 修正案1の実装手順

1. **バックエンド: プレビュー生成用APIエンドポイントの追加**
   - `backend/app/api/v1/admin/qr_code.py`に`generate_qr_code_preview`関数を追加

2. **フロントエンド: APIクライアントの追加**
   - `frontend/src/api/qrcode.ts`に`generateQRCodePreview`メソッドを追加

3. **フロントエンド: QRCodeFormコンポーネントの修正**
   - `generatePreview`関数で`generateQRCodePreview`を使用

4. **フロントエンド: QRCodeGeneratorコンポーネントの修正**
   - `handleGenerate`関数で`fetchGeneratedQRCodes()`を呼び出すように修正

5. **テスト**
   - プレビュー生成時にデータベースに保存されないことを確認
   - 「生成済みQRコード一覧に追加」ボタン押下時のみ、データベースに保存されることを確認
   - リロード時の重複表示が発生しないことを確認
   - カスタム設置場所名入力時の段階的表示が発生しないことを確認

---

## 5. まとめ

### 5.1 問題の原因

**根本原因**:
1. **プレビュー生成時にデータベースに保存されている**
2. **「生成済みQRコード一覧に追加」ボタン押下時にもデータベースに保存されている**
3. **カスタム設置場所名入力時に、入力のたびにプレビューが生成され、データベースに保存されている**

### 5.2 修正案

**修正案1: プレビュー生成時にデータベースに保存しない（推奨）**

**実装内容**:
1. プレビュー生成用のAPIエンドポイントを作成（データベースに保存しない）
2. 「生成済みQRコード一覧に追加」ボタン押下時のみ、データベースに保存する
3. `handleGenerate`関数で、データベースから最新の一覧を取得する

**メリット**:
- プレビュー生成時にデータベースに保存されない
- カスタム設置場所名入力時の段階的保存が発生しない
- リロード時の重複表示が発生しない

---

**Document Version**: v1.0  
**Author**: Auto (AI Assistant)  
**Last Updated**: 2025-12-06 12:00  
**Status**: ✅ **調査分析完了、修正案提示完了**


