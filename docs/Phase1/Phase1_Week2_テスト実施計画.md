# Phase 1 Week 2 テスト実施計画

**作成日**: 2025年11月27日  
**対象**: Phase 1 Week 2（AI対話エンジン）で実装した機能のテスト  
**実施時期**: Phase 1 Week 4（推奨）または Week 3中に並行実施  
**工数**: 8-12時間

---

## 1. 現状

### テスト未実施の状況

**Phase 1 Week 2で実装した機能のテストが一切実施されていません**。

**未実施のテスト**:
- ❌ RAG統合型AI対話エンジンのテスト
- ❌ 埋め込みベクトル生成のテスト
- ❌ pgvector検索のテスト
- ❌ 信頼度スコア計算のテスト
- ❌ チャットメッセージ送信のテスト
- ❌ エスカレーション判定のテスト
- ❌ 夜間対応キュー処理のテスト

### リスク

⚠️ **高リスク**: テスト未実施により、以下のリスクが発生します：

1. **バグ発見の遅延**: 後で動かない場合の原因特定に大量の時間を費やす可能性
2. **品質保証の欠如**: 実装した機能が正しく動作するか確認できていない
3. **リファクタリングのリスク**: テストがないため、リファクタリング時に既存機能を壊すリスク
4. **MVP的にも問題**: テストを後回しにするのは愚の骨頂

---

## 2. テスト実施計画

### 実施時期

**推奨**: Phase 1 Week 4（統合・テスト・ステージング環境構築の週）

**理由**:
- Week 4は「統合・テスト・ステージング環境構築」の週
- エンドツーエンドテストと並行して実施可能
- ステージング環境構築前にバグを発見・修正できる

**代替案**: Phase 1 Week 3中に並行実施

**理由**:
- Week 3はフロントエンド実装の週
- バックエンドのテストを並行して実施可能
- Week 4での統合テスト前にバグを発見できる

### 工数見積もり

**合計**: 8-12時間（ステップ18の4時間では不十分なため拡大）

| テストファイル | 工数 | 優先度 |
|--------------|------|--------|
| `test_ai_engine.py` | 2時間 | 高 |
| `test_embeddings.py` | 1時間 | 高 |
| `test_vector_search.py` | 1.5時間 | 高 |
| `test_confidence.py` | 1.5時間 | 高 |
| `test_safety_check.py` | 0.5時間 | 中 |
| `test_chat.py` | 1時間 | 高 |
| `test_chat_service.py` | 1.5時間 | 高 |
| `test_escalation.py` | 1時間 | 高 |
| `test_overnight_queue.py` | 1時間 | 高 |
| `test_chat_api.py` | 1時間 | 高 |

---

## 3. テスト実装内容

### 3.1 単体テスト

#### `backend/tests/test_ai_engine.py`

**テスト項目**:
- [ ] RAG統合型AI対話エンジンの基本動作
- [ ] 埋め込みベクトル生成の統合
- [ ] pgvector検索の統合
- [ ] コンテキスト構築
- [ ] GPT-4o mini回答生成
- [ ] エラーハンドリング（埋め込み生成失敗、検索失敗等）

#### `backend/tests/test_embeddings.py`

**テスト項目**:
- [ ] `generate_embedding()`の正常動作
- [ ] `generate_faq_embedding()`の正常動作
- [ ] エラーハンドリング（OpenAI API障害時）
- [ ] 空文字列の処理
- [ ] 1536次元ベクトルの生成確認

#### `backend/tests/test_vector_search.py`

**テスト項目**:
- [ ] `search_similar_faqs()`の正常動作
- [ ] `search_similar_patterns()`の正常動作
- [ ] コサイン類似度計算の正確性
- [ ] 類似度閾値フィルタリング
- [ ] Top K取得の正確性
- [ ] エラーハンドリング（データベースエラー時）

#### `backend/tests/test_confidence.py`

**テスト項目**:
- [ ] `calculate_confidence()`の正常動作
- [ ] FAQ類似度ボーナス計算
- [ ] 回答長ペナルティ計算
- [ ] 不確実性ワード検出
- [ ] 質問具体性スコア計算（v0.3新規）
- [ ] 過去同一質問解決率計算（v0.3新規）
- [ ] 施設カスタムFAQヒット判定（v0.3新規）
- [ ] 0.0-1.0の範囲クリップ

#### `backend/tests/test_safety_check.py`

**テスト項目**:
- [ ] `check_safety_category()`の正常動作
- [ ] 医療関連キーワード検出
- [ ] 安全・避難関連キーワード検出
- [ ] 大文字小文字を区別しない検出
- [ ] 多言語対応（英語・日本語）

### 3.2 統合テスト

#### `backend/tests/test_chat.py`

**テスト項目**:
- [ ] チャットメッセージ送信の正常動作
- [ ] 会話履歴取得の正常動作
- [ ] セッション管理（新規作成・既存利用）
- [ ] メッセージ保存

#### `backend/tests/test_chat_service.py`

**テスト項目**:
- [ ] `process_chat_message()`の正常動作
- [ ] セッション管理の統合
- [ ] RAG統合型AI対話エンジン呼び出し
- [ ] エスカレーション処理の統合
- [ ] 夜間対応キュー処理の統合
- [ ] メッセージ保存の統合

#### `backend/tests/test_escalation.py`

**テスト項目**:
- [ ] `check_escalation_needed()`の正常動作
- [ ] 信頼度 < 閾値判定
- [ ] 緊急キーワード検出
- [ ] 3往復以上未解決チェック
- [ ] 安全カテゴリ即エスカレーション
- [ ] エスカレーションスケジュール連動
- [ ] タイムゾーン基準の時刻判定

#### `backend/tests/test_overnight_queue.py`

**テスト項目**:
- [ ] `add_to_overnight_queue()`の正常動作
- [ ] `send_overnight_auto_reply()`の正常動作
- [ ] `process_scheduled_notifications()`の正常動作
- [ ] 施設タイムゾーン基準の翌朝8:00計算
- [ ] 夜間時間帯判定（22:00-8:00）
- [ ] 自動返信メッセージ送信（英語・日本語）

### 3.3 APIテスト

#### `backend/tests/test_chat_api.py`

**テスト項目**:
- [ ] `POST /api/v1/chat`の正常動作
- [ ] `GET /api/v1/chat/history/{session_id}`の正常動作
- [ ] リクエストバリデーション
- [ ] エラーハンドリング
- [ ] レスポンス形式の確認

---

## 4. テスト環境要件

### 必要な環境

- PostgreSQL（pgvector拡張有効）
- Redis（オプション、キャッシュ用）
- OpenAI APIキー（テスト用、モックも検討）
- pytest
- pytest-asyncio
- pytest-mock（モック用）

### テストデータ

- テスト用施設データ
- テスト用FAQデータ（埋め込みベクトル含む）
- テスト用会話データ
- テスト用エスカレーションスケジュールデータ

---

## 5. テスト実行方法

### テスト実行コマンド

```bash
# 全テスト実行
pytest tests/ -v

# 特定のテストファイル実行
pytest tests/test_ai_engine.py -v

# カバレッジ確認
pytest tests/ --cov=app --cov-report=html

# 特定のテスト関数実行
pytest tests/test_ai_engine.py::test_rag_engine_process_message -v
```

### テストカバレッジ目標

- **最低カバレッジ**: 60%以上
- **推奨カバレッジ**: 80%以上
- **重要機能**: 100%カバレッジ（RAGエンジン、エスカレーション判定等）

---

## 6. テスト実施チェックリスト

### Phase 1 Week 4開始時

- [ ] テスト実施計画の確認
- [ ] テスト環境の準備
- [ ] テストデータの準備
- [ ] テストファイルの作成開始

### テスト実装中

- [ ] 各テストファイルの実装
- [ ] テストの実行確認
- [ ] テストカバレッジの確認
- [ ] バグ発見時の修正

### テスト完了時

- [ ] 全テストが通過することを確認
- [ ] テストカバレッジが目標を達成していることを確認
- [ ] エッジケースもテストされていることを確認
- [ ] テストドキュメントの更新

---

## 7. 参考資料

### 実装済みドキュメント

- **引き継ぎ事項**: `docs/Phase1/Phase1_Week2_引き継ぎ事項.md`
- **実装整合性レポート**: `docs/Phase1/Phase1_Week2_実装整合性レポート.md`
- **ステップ計画**: `docs/Phase1/Phase1_Week2_ステップ計画.md`

### 設計ドキュメント

- **要約定義書**: `docs/Summary/yadopera-v03-summary.md`
- **アーキテクチャ設計書**: `docs/Architecture/やどぺら_v0.3_アーキテクチャ設計書.md`

---

**Document Version**: v1.0  
**Author**: Auto  
**Last Updated**: 2025-11-27  
**Status**: Phase 1 Week 2 テスト実施計画作成完了


