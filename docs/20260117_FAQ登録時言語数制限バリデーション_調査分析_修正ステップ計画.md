# FAQ登録時の言語数制限バリデーション未実装 - 調査分析・修正ステップ計画

**作成日時**: 2026年01月17日  
**目的**: FAQ登録時の言語数制限バリデーション未実装問題の完全調査分析と修正ステップ計画の立案  
**状態**: 📋 **調査分析完了・修正ステップ計画立案完了（修正は指示があるまで実施しない）**

---

## 1. 現状把握

### 1.1 問題の概要

**残存課題**: 「2. FAQ登録時の言語数制限バリデーション未実装」（Phase 2実装ステップ計画書より）

**問題点**:
- プランによって言語数に制限があるが、FAQ登録時にバリデーションが未実装
- `plan_limits.py`で定義されている言語制限が実際のAPIでチェックされていない
- プラン制限の整合性を保つため重要

**影響範囲**:
- `backend/app/api/v1/admin/faqs.py`の`create_faq`エンドポイント
- `backend/app/services/faq_service.py`の`create_faq`メソッド
- `backend/app/services/faq_service.py`の`update_faq`メソッド（翻訳追加時）

**優先度**: 中（プラン制限の整合性を保つため重要）

---

## 2. 調査分析結果

### 2.1 プラン制限の定義状況

#### 2.1.1 `plan_limits.py`の定義

**ファイル**: `backend/app/core/plan_limits.py`

```python
PLAN_FAQ_LIMITS: Dict[str, Dict[str, Any]] = {
    "free": {
        "max_faqs": 20,
        "languages": ["ja"]  # 対応言語リスト（日本語のみ）
    },
    "mini": {
        "max_faqs": 30,
        "languages": ["ja", "en"]  # 日本語＋英語
    },
    "small": {
        "max_faqs": 50,
        "languages": ["ja", "en", "zh-TW"]  # 日本語＋英語＋中国語（繁体字）
    },
    "standard": {
        "max_faqs": 100,
        "languages": ["ja", "en", "zh-TW", "fr"]  # 日本語＋英語＋中国語＋フランス語
    },
    "premium": {
        "max_faqs": None,  # 無制限
        "languages": None  # 無制限（全言語対応）
    }
}
```

**重要な発見**:
- `languages`は「対応可能な言語のリスト」を定義している
- **`language_limit`という数値制限は定義されていない**

#### 2.1.2 `Facility`モデルの定義

**ファイル**: `backend/app/models/facility.py`

```python
class Facility(Base):
    # ...
    plan_type = Column(String(20), default='Free', nullable=False)  # 'Free', 'Mini', 'Small', 'Standard', 'Premium'
    language_limit = Column(Integer, default=1, nullable=True)  # Premiumの場合はNULL（無制限）
    # ...
```

**重要な発見**:
- `Facility`モデルには`language_limit`カラムが存在する
- Premiumプランの場合は`NULL`（無制限）
- プラン別のデフォルト値は以下の通り:
  - Free: 1言語
  - Mini: 1言語（実際は2言語が許可されているが、デフォルトは1）
  - Small: 1言語（実際は3言語が許可されているが、デフォルトは1）
  - Standard: 1言語（実際は4言語が許可されているが、デフォルトは1）
  - Premium: NULL（無制限）

**問題点**:
- `plan_limits.py`の`languages`リストの長さと`Facility.language_limit`の値が一致していない
- `plan_limits.py`の`languages`リストの長さを`language_limit`として使用すべき

### 2.2 現在のFAQ登録・更新処理

#### 2.2.1 `create_faq`メソッド

**ファイル**: `backend/app/services/faq_service.py`（201-370行目）

**現在の実装**:
- カテゴリバリデーション: ✅ 実装済み
- intent_key重複チェック: ✅ 実装済み
- **言語数制限バリデーション: ❌ 未実装**

#### 2.2.2 `update_faq`メソッド

**ファイル**: `backend/app/services/faq_service.py`（421-590行目）

**現在の実装**:
- カテゴリバリデーション: ✅ 実装済み
- intent_key重複チェック: ✅ 実装済み
- **翻訳追加時の言語数制限バリデーション: ❌ 未実装**

### 2.3 既存のFAQから使用言語を取得する処理

**調査結果**:
- ❌ **既存のFAQから使用言語を取得する関数は存在しない**
- 新規作成が必要

**必要な処理**:
1. 施設の既存FAQから、使用されている言語の一意なリストを取得
2. 新規登録・更新時に追加される言語を含めて、言語数制限をチェック

---

## 3. 設計方針

### 3.1 言語数制限の判定ロジック

**方針**:
1. 施設の`language_limit`を取得（Premiumの場合は`NULL`で無制限）
2. 既存のFAQから使用されている言語の一意なリストを取得
3. 新規登録・更新時に追加される言語を含めて、言語数をカウント
4. `language_limit`と比較してバリデーション

**重要な考慮事項**:
- Premiumプラン（`language_limit = NULL`）の場合は制限なし
- 既存の言語を追加する場合は制限に達していても許可（言語数は増えない）
- 新しい言語を追加する場合のみ制限をチェック

### 3.2 実装箇所

1. **`faq_service.py`にヘルパー関数を追加**:
   - `_get_facility_languages(facility_id: int) -> Set[str]`: 施設の既存FAQから使用されている言語の一意なリストを取得

2. **`create_faq`メソッドにバリデーション追加**:
   - 施設情報を取得（`Facility`モデル）
   - 既存の言語リストを取得
   - 新規登録される言語を追加
   - 言語数制限をチェック

3. **`update_faq`メソッドにバリデーション追加**:
   - 施設情報を取得（`Facility`モデル）
   - 既存の言語リストを取得
   - 更新時に追加される新しい言語を確認
   - 言語数制限をチェック

### 3.3 エラーメッセージ

**エラーメッセージ定義**:
- `backend/app/core/error_messages.py`に追加
- 多言語対応（日本語・英語）

**エラーメッセージ例**:
- 日本語: "プランの言語数制限に達しています（{language_limit}言語）。既存の言語を使用するか、プランをアップグレードしてください。"
- 英語: "Language limit reached ({language_limit} languages). Please use existing languages or upgrade your plan."

---

## 4. 修正ステップ計画

### ステップ1: ヘルパー関数の実装（30分）

**ファイル**: `backend/app/services/faq_service.py`

**実装内容**:
```python
async def _get_facility_languages(self, facility_id: int) -> Set[str]:
    """
    施設の既存FAQから使用されている言語の一意なリストを取得
    
    Args:
        facility_id: 施設ID
    
    Returns:
        使用されている言語のセット（例: {"ja", "en"}）
    """
    # FAQTranslationテーブルから、該当施設のFAQに紐づく翻訳の言語を取得
    query = select(FAQTranslation.language).join(FAQ).where(
        FAQ.facility_id == facility_id,
        FAQ.is_active == True
    ).distinct()
    
    result = await self.db.execute(query)
    languages = {row[0] for row in result.all()}
    
    return languages
```

**確認事項**:
- SQLクエリが正しく動作するか
- パフォーマンスに問題がないか（インデックス確認）

### ステップ2: `create_faq`メソッドにバリデーション追加（1時間）

**ファイル**: `backend/app/services/faq_service.py`

**実装位置**: `create_faq`メソッドの冒頭（カテゴリバリデーションの後）

**実装内容**:
```python
# 施設情報を取得
from app.models.facility import Facility
facility = await self.db.get(Facility, facility_id)
if not facility:
    raise ValueError(f"Facility not found: facility_id={facility_id}")

# 言語数制限バリデーション（Premiumプランの場合はスキップ）
if facility.language_limit is not None:
    # 既存の言語リストを取得
    existing_languages = await self._get_facility_languages(facility_id)
    
    # 新規登録される言語を取得
    new_languages = {trans.language for trans in request.translations}
    
    # 既存の言語と新規言語を結合
    all_languages = existing_languages | new_languages
    
    # 言語数制限をチェック
    if len(all_languages) > facility.language_limit:
        # 新規言語のみを抽出（既存言語は許可）
        truly_new_languages = new_languages - existing_languages
        if truly_new_languages:
            raise ValueError(
                f"プランの言語数制限に達しています（{facility.language_limit}言語）。"
                f"既存の言語（{', '.join(sorted(existing_languages))}）を使用するか、"
                f"プランをアップグレードしてください。"
            )
```

**確認事項**:
- Premiumプラン（`language_limit = NULL`）の場合はスキップされるか
- 既存の言語を追加する場合は許可されるか
- 新しい言語を追加する場合のみ制限をチェックするか

### ステップ3: `update_faq`メソッドにバリデーション追加（1時間）

**ファイル**: `backend/app/services/faq_service.py`

**実装位置**: `update_faq`メソッドの翻訳更新処理部分（487行目付近）

**実装内容**:
```python
# translationsの更新または作成
if request.translations is not None:
    # 施設情報を取得
    facility = await self.db.get(Facility, facility_id)
    if not facility:
        raise ValueError(f"Facility not found: facility_id={facility_id}")
    
    # 言語数制限バリデーション（Premiumプランの場合はスキップ）
    if facility.language_limit is not None:
        # 既存の言語リストを取得（更新対象のFAQを除く）
        existing_languages = await self._get_facility_languages(facility_id)
        # 更新対象のFAQの既存言語を除外
        existing_languages = existing_languages - {trans.language for trans in existing_translations.values()}
        
        # 更新時に追加される新しい言語を取得
        new_languages = {trans.language for trans in request.translations}
        
        # 既存の言語と新規言語を結合
        all_languages = existing_languages | new_languages
        
        # 言語数制限をチェック
        if len(all_languages) > facility.language_limit:
            # 新規言語のみを抽出（既存言語は許可）
            truly_new_languages = new_languages - existing_languages
            if truly_new_languages:
                raise ValueError(
                    f"プランの言語数制限に達しています（{facility.language_limit}言語）。"
                    f"既存の言語（{', '.join(sorted(existing_languages))}）を使用するか、"
                    f"プランをアップグレードしてください。"
                )
    
    # 既存の翻訳更新処理（既存コード）
    for trans_request in request.translations:
        # ...
```

**確認事項**:
- 更新対象のFAQの既存言語を除外する処理が正しいか
- 既存の言語を更新する場合は許可されるか
- 新しい言語を追加する場合のみ制限をチェックするか

### ステップ4: エラーメッセージの追加（30分）

**ファイル**: `backend/app/core/error_messages.py`

**実装内容**:
```python
ERROR_MESSAGES: Dict[str, Dict[str, str]] = {
    # ... 既存のエラーメッセージ ...
    "LANGUAGE_LIMIT_EXCEEDED": {
        "en": "Language limit reached ({language_limit} languages). Please use existing languages or upgrade your plan.",
        "ja": "プランの言語数制限に達しています（{language_limit}言語）。既存の言語を使用するか、プランをアップグレードしてください。"
    }
}
```

**確認事項**:
- エラーメッセージが多言語対応されているか
- プレースホルダー（`{language_limit}`）が正しく置換されるか

### ステップ5: フロントエンドエラーハンドリング（30分）

**ファイル**: `frontend/src/utils/errorHandler.ts`

**実装内容**:
- 既存のエラーハンドリングで、バックエンドからのエラーメッセージをそのまま表示
- 特別な処理は不要（バックエンドのエラーメッセージがそのまま表示される）

**確認事項**:
- エラーメッセージが正しく表示されるか
- ユーザーにとって分かりやすいメッセージか

### ステップ6: テスト実装（1時間）

**テストファイル**: `backend/tests/test_faq_service_language_limit.py`（新規作成）

**テストケース**:
1. **言語制限に達していない場合の新規登録**: ✅ 成功
2. **言語制限に達している場合の新規登録（既存言語を使用）**: ✅ 成功
3. **言語制限に達している場合の新規登録（新しい言語を追加）**: ❌ エラー
4. **Premiumプラン（無制限）の場合の新規登録**: ✅ 成功
5. **言語制限に達していない場合の更新（新しい言語を追加）**: ✅ 成功
6. **言語制限に達している場合の更新（既存言語を更新）**: ✅ 成功
7. **言語制限に達している場合の更新（新しい言語を追加）**: ❌ エラー
8. **Premiumプラン（無制限）の場合の更新（新しい言語を追加）**: ✅ 成功

**確認事項**:
- すべてのテストケースがパスするか
- エッジケース（Premiumプラン、既存言語のみなど）が正しく処理されるか

### ステップ7: ブラウザテスト（30分）

**テスト項目**:
1. Freeプラン（1言語）で、既に1言語使用している場合に新しい言語を追加しようとする → エラーメッセージ表示
2. Miniプラン（2言語）で、既に2言語使用している場合に新しい言語を追加しようとする → エラーメッセージ表示
3. Smallプラン（3言語）で、既に3言語使用している場合に新しい言語を追加しようとする → エラーメッセージ表示
4. Standardプラン（4言語）で、既に4言語使用している場合に新しい言語を追加しようとする → エラーメッセージ表示
5. Premiumプラン（無制限）で、新しい言語を追加しようとする → 成功
6. 既存の言語を追加する場合（制限に達していても） → 成功

**確認事項**:
- エラーメッセージが正しく表示されるか
- ユーザーにとって分かりやすいメッセージか
- 既存の言語を追加する場合は許可されるか

---

## 5. 他の機能やUIとの競合・干渉調査

### 5.1 既存機能への影響

#### 5.1.1 FAQ一括作成（`bulk_create_faqs`）

**調査結果**:
- `bulk_create_faqs`メソッドは`create_faq`を呼び出している
- `create_faq`にバリデーションを追加すれば、一括作成時も自動的にチェックされる
- **影響**: ✅ 問題なし（既存のエラーハンドリングで処理される）

#### 5.1.2 FAQ初期自動登録

**調査結果**:
- 施設登録時の初期FAQ自動登録は`filter_faq_presets_by_plan`を使用
- プランに応じた言語フィルタリングが既に実装されている
- **影響**: ✅ 問題なし（初期登録時は言語制限内で登録される）

#### 5.1.3 FAQ編集（既存言語の更新）

**調査結果**:
- 既存の言語を更新する場合は言語数が増えない
- バリデーションでは既存言語を許可するため、問題なし
- **影響**: ✅ 問題なし

### 5.2 UIへの影響

#### 5.2.1 `FaqForm.vue`

**調査結果**:
- `addTranslation`関数で翻訳を追加できる
- フロントエンドでの事前バリデーションは不要（バックエンドでチェック）
- エラーメッセージは既存のエラーハンドリングで表示される
- **影響**: ✅ 問題なし（既存のエラーハンドリングで処理される）

#### 5.2.2 `FaqManagement.vue`

**調査結果**:
- FAQ作成・更新時のエラーハンドリングは既存の処理を使用
- **影響**: ✅ 問題なし（既存のエラーハンドリングで処理される）

### 5.3 データベースへの影響

**調査結果**:
- データベーススキーマの変更は不要
- 既存の`Facility.language_limit`カラムを使用
- **影響**: ✅ 問題なし

### 5.4 パフォーマンスへの影響

**調査結果**:
- `_get_facility_languages`関数は`FAQTranslation`テーブルから言語を取得
- `FAQTranslation.faq_id`にインデックスが存在する（`faqs.id`の外部キー）
- `FAQ.facility_id`にインデックスが存在する
- **影響**: ⚠️ 軽微（クエリは高速だが、頻繁に呼び出される場合はキャッシュを検討）

**推奨対策**:
- 現時点ではキャッシュは不要（FAQ登録・更新は頻繁ではない）
- 将来的にパフォーマンス問題が発生した場合は、Redisキャッシュを検討

---

## 6. 実装時の注意事項

### 6.1 大原則の遵守

1. **根本解決 > 暫定解決**: 言語数制限を正しくチェックする根本的な解決を実装
2. **シンプル構造 > 複雑構造**: 既存のパターンに従い、シンプルな実装を心がける
3. **統一・同一化 > 特殊独自**: 既存のバリデーションパターンに従う
4. **具体的 > 一般**: エラーメッセージは具体的で分かりやすく
5. **拙速 < 安全確実**: テストを省略せず、十分な検証を行う
6. **Docker環境必須**: すべての修正・テストはDocker環境で実行する

### 6.2 実装前の確認事項

- [ ] データベースバックアップを取得
- [ ] Docker環境で動作確認
- [ ] 既存のテストがパスすることを確認

### 6.3 実装後の確認事項

- [ ] 単体テストがパスする
- [ ] 統合テストがパスする
- [ ] Docker環境で動作確認
- [ ] ブラウザテスト完了
- [ ] エラーメッセージが正しく表示される
- [ ] 既存の言語を追加する場合は許可される
- [ ] 新しい言語を追加する場合のみ制限をチェックする

---

## 7. 所要時間見積もり

| ステップ | 所要時間 | 累計時間 |
|---------|---------|---------|
| ステップ1: ヘルパー関数の実装 | 30分 | 30分 |
| ステップ2: `create_faq`メソッドにバリデーション追加 | 1時間 | 1時間30分 |
| ステップ3: `update_faq`メソッドにバリデーション追加 | 1時間 | 2時間30分 |
| ステップ4: エラーメッセージの追加 | 30分 | 3時間 |
| ステップ5: フロントエンドエラーハンドリング | 30分 | 3時間30分 |
| ステップ6: テスト実装 | 1時間 | 4時間30分 |
| ステップ7: ブラウザテスト | 30分 | 5時間 |

**合計所要時間**: 約5時間（0.5日）

---

## 8. 参照文書

- `docs/Phase2_実装ステップ計画_20250114.md`: Phase 2実装ステップ計画書（残存課題「2. FAQ登録時の言語数制限バリデーション未実装」）
- `backend/app/core/plan_limits.py`: 料金プラン制限定義
- `backend/app/models/facility.py`: 施設モデル（`language_limit`カラム）
- `backend/app/services/faq_service.py`: FAQサービス（`create_faq`、`update_faq`メソッド）
- `backend/app/core/error_messages.py`: エラーメッセージ定義
- `frontend/src/utils/errorHandler.ts`: フロントエンドエラーハンドリング

---

## 9. まとめ

### 9.1 調査結果

1. **プラン制限の定義**: `Facility.language_limit`カラムで管理されているが、バリデーションが未実装
2. **既存の処理**: FAQ登録・更新時に言語数制限のチェックが行われていない
3. **必要な実装**: 既存FAQから使用言語を取得する関数と、バリデーションロジックの追加

### 9.2 修正方針

1. **ヘルパー関数の実装**: 施設の既存FAQから使用されている言語の一意なリストを取得
2. **バリデーション追加**: `create_faq`と`update_faq`メソッドに言語数制限チェックを追加
3. **エラーメッセージ**: 多言語対応のエラーメッセージを追加
4. **テスト実装**: プラン別の言語制限テストを実装

### 9.3 競合・干渉調査結果

- ✅ **既存機能への影響**: 問題なし（既存のエラーハンドリングで処理される）
- ✅ **UIへの影響**: 問題なし（既存のエラーハンドリングで処理される）
- ✅ **データベースへの影響**: 問題なし（スキーマ変更不要）
- ⚠️ **パフォーマンスへの影響**: 軽微（現時点では問題なし、将来的にキャッシュを検討）

### 9.4 次のステップ

**指示があるまで修正を実施しない**。修正を実施する場合は、以下の順序で進める:

1. データベースバックアップを取得
2. ステップ1から順番に実装
3. 各ステップでテストを実施
4. ブラウザテストを実施
5. コミット・プッシュ

---

**Document Version**: v1.0  
**Author**: Auto (AI Assistant)  
**Last Updated**: 2026年01月17日  
**Status**: 📋 **調査分析完了・修正ステップ計画立案完了（修正は指示があるまで実施しない）**

