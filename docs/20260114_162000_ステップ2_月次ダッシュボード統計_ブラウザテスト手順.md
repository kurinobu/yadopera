# ステップ2: 月次ダッシュボード統計 - ブラウザテスト手順

**作成日時**: 2026年1月14日 16:20:00  
**目的**: 月次ダッシュボード統計機能のブラウザテスト手順を記載  
**対象**: ステップ2実装完了後の統合テスト

---

## 1. テスト環境の準備

### 1.1 ローカル環境の起動

```bash
cd /Users/kurinobu/projects/yadopera
docker-compose up -d
```

### 1.2 フロントエンドの起動

```bash
cd frontend
npm run dev
```

### 1.3 ブラウザでアクセス

- URL: `http://localhost:5173`
- 管理画面にログイン

---

## 2. テスト項目

### 2.1 月次統計セクションの表示確認

**テスト手順**:
1. ダッシュボード画面にアクセス
2. ページ上部に「今月の利用状況」セクションが表示されることを確認
3. 以下の4つのカードが表示されることを確認:
   - カード1: 今月の質問数 / プラン上限
   - カード2: 今月のAI自動応答数
   - カード3: 今月のエスカレーション数
   - カード8: 未解決のエスカレーション

**期待結果**:
- ✅ 月次統計セクションが最上部に表示される
- ✅ 4つのカードが正しく表示される
- ✅ 既存の週次サマリーセクションは維持されている

---

### 2.2 プラン別表示ロジック確認

#### テスト2-1: Freeプラン（30件以内）

**前提条件**:
- テスト施設のプランがFree
- 今月の質問数が30件以内

**テスト手順**:
1. Freeプランの施設でログイン
2. ダッシュボード画面を確認

**期待結果**:
- ✅ プログレスバーが表示される（緑色）
- ✅ 「あと○○件で上限です」メッセージが表示される
- ✅ ステータスが「normal」である

#### テスト2-2: Freeプラン（30件超過）

**前提条件**:
- テスト施設のプランがFree
- 今月の質問数が30件超過

**テスト手順**:
1. Freeプランの施設でログイン（質問数が30件超過の状態）
2. ダッシュボード画面を確認

**期待結果**:
- ✅ 「FAQのみ対応中」バッジが表示される（赤色）
- ✅ プログレスバーは表示されない
- ✅ ステータスが「faq_only」である

#### テスト2-3: Miniプラン

**前提条件**:
- テスト施設のプランがMini

**テスト手順**:
1. Miniプランの施設でログイン
2. ダッシュボード画面を確認

**期待結果**:
- ✅ 「従量課金プラン」バッジが表示される（青色）
- ✅ プログレスバーは表示されない
- ✅ 質問数が表示される

#### テスト2-4: Smallプラン（上限内）

**前提条件**:
- テスト施設のプランがSmall
- 今月の質問数が上限（200件）以内

**テスト手順**:
1. Smallプランの施設でログイン
2. ダッシュボード画面を確認

**期待結果**:
- ✅ プログレスバーが表示される
- ✅ 使用率に応じた色分けが正しい（0-70%: 緑、71-90%: 黄、91-99%: オレンジ）
- ✅ 「あと○○件で上限です」または「残り○○件です」メッセージが表示される

#### テスト2-5: Smallプラン（警告範囲）

**前提条件**:
- テスト施設のプランがSmall
- 今月の質問数が上限の91-99%（182-198件）

**テスト手順**:
1. Smallプランの施設でログイン（警告範囲の状態）
2. ダッシュボード画面を確認

**期待結果**:
- ✅ プログレスバーがオレンジ色で表示される
- ✅ 「⚠️ まもなく上限です（残り○○件）」メッセージが表示される
- ✅ ステータスが「warning」である

#### テスト2-6: Smallプラン（超過）

**前提条件**:
- テスト施設のプランがSmall
- 今月の質問数が上限（200件）を超過

**テスト手順**:
1. Smallプランの施設でログイン（超過の状態）
2. ダッシュボード画面を確認

**期待結果**:
- ✅ プログレスバーが赤色で表示される
- ✅ 「⚠️ 従量課金が発生しています（○○件超過）」メッセージが表示される
- ✅ ステータスが「overage」である

#### テスト2-7: Standard/Premiumプラン

**前提条件**:
- テスト施設のプランがStandardまたはPremium

**テスト手順**:
1. Standard/Premiumプランの施設でログイン
2. ダッシュボード画面を確認

**期待結果**:
- ✅ プログレスバーが表示される
- ✅ 使用率に応じた色分けが正しい
- ✅ 残数表示が正しい

---

### 2.3 AI自動応答統計カード確認

**テスト手順**:
1. ダッシュボード画面を確認
2. カード2（AI自動応答数）を確認

**期待結果**:
- ✅ AI自動応答数が表示される
- ✅ 自動化率（パーセンテージ）が表示される
- ✅ 自動化率のプログレスバーが表示される
- ✅ 総質問数が表示される

---

### 2.4 エスカレーション統計カード確認

**テスト手順**:
1. ダッシュボード画面を確認
2. カード3（エスカレーション数）を確認

**期待結果**:
- ✅ エスカレーション総数が表示される
- ✅ 未解決数が表示される（1件以上の場合、赤バッジで強調）
- ✅ 解決済み数が表示される
- ✅ 未解決0件の場合、緑バッジで表示される

---

### 2.5 未解決エスカレーションリスト確認

**テスト手順**:
1. ダッシュボード画面を確認
2. カード8（未解決のエスカレーション）を確認

**期待結果**:
- ✅ 未解決エスカレーションがリスト表示される（最新10件）
- ✅ 各エスカレーションにメッセージが表示される
- ✅ 作成日時が表示される
- ✅ エスカレーションをクリックすると会話詳細ページに遷移する
- ✅ 未解決エスカレーションが0件の場合、「未解決の質問はありません」と表示される

---

### 2.6 月次集計の正確性確認

**テスト手順**:
1. データベースで今月の質問数を確認
2. ダッシュボード画面で表示される質問数と一致することを確認

**確認SQL**:
```sql
SELECT COUNT(*) as current_month_questions
FROM messages m
JOIN conversations c ON m.conversation_id = c.id
WHERE c.facility_id = :facility_id
  AND m.role = 'user'
  AND m.created_at >= DATE_TRUNC('month', CURRENT_TIMESTAMP AT TIME ZONE 'Asia/Tokyo')
  AND m.created_at < DATE_TRUNC('month', CURRENT_TIMESTAMP AT TIME ZONE 'Asia/Tokyo') + INTERVAL '1 month';
```

**期待結果**:
- ✅ ダッシュボードに表示される質問数がデータベースの集計結果と一致する
- ✅ タイムゾーン処理が正しい（JST基準）

---

### 2.7 エラーハンドリング確認

#### テスト2-7-1: プラン情報が取得できない場合

**テスト手順**:
1. 施設情報が存在しない施設IDでAPIを呼び出す（開発者ツールで確認）

**期待結果**:
- ✅ 適切なエラーメッセージが表示される
- ✅ アプリケーションがクラッシュしない

#### テスト2-7-2: データが存在しない場合

**テスト手順**:
1. 質問数が0件の施設でログイン
2. ダッシュボード画面を確認

**期待結果**:
- ✅ 0件が正しく表示される
- ✅ エラーが発生しない

#### テスト2-7-3: APIエラー時の表示

**テスト手順**:
1. バックエンドAPIを停止
2. ダッシュボード画面をリロード

**期待結果**:
- ✅ エラーメッセージが表示される
- ✅ 「再試行」ボタンが表示される
- ✅ アプリケーションがクラッシュしない

---

### 2.8 レスポンシブ対応確認

**テスト手順**:
1. ブラウザの開発者ツールでデバイスモードに切り替え
2. モバイル（375px）、タブレット（768px）、デスクトップ（1024px）で表示を確認

**期待結果**:
- ✅ モバイル: カードが1列で表示される
- ✅ タブレット: カードが2列で表示される
- ✅ デスクトップ: カードが3列で表示される
- ✅ すべてのデバイスでレイアウトが崩れない

---

### 2.9 ダークモード対応確認

**テスト手順**:
1. ブラウザの設定でダークモードに切り替え
2. ダッシュボード画面を確認

**期待結果**:
- ✅ すべてのカードがダークモードで正しく表示される
- ✅ テキストが読みやすく表示される
- ✅ プログレスバーの色が正しく表示される

---

## 3. テスト結果の記録

### 3.1 テスト結果テンプレート

```
テスト日時: YYYY-MM-DD HH:MM:SS
テスト環境: ローカル / ステージング
テスト実施者: [名前]

[テスト項目名]
- 結果: ✅ 成功 / ❌ 失敗
- 備考: [問題があれば記載]
```

### 3.2 問題発見時の対応

1. スクリーンショットを取得
2. ブラウザのコンソールログを確認
3. ネットワークタブでAPIレスポンスを確認
4. 問題を記録して修正依頼

---

## 4. テスト完了条件

以下のすべてが完了していること:

- ✅ 月次統計セクションが正しく表示される
- ✅ 各プランでの表示ロジックが正しく動作する
- ✅ 月次集計が正確である（JST基準）
- ✅ エラーハンドリングが適切である
- ✅ レスポンシブ対応が完了している
- ✅ ダークモード対応が完了している

---

**Document Version**: v1.0  
**Author**: Auto (AI Assistant)  
**Last Updated**: 2026年1月14日 16:20:00

