# ステージング環境構築手順

**作成日**: 2025-11-28  
**フェーズ**: Phase 1 Week 4  
**目的**: ステージング環境を構築し、デプロイする（Render.com Pro + Railway Hobby）

---

## 前提条件

- Render.com Proアカウント（既存契約）
- Railway Hobbyアカウント（既存契約）
- GitHubリポジトリへのアクセス権限
- OpenAI APIキー

---

## 1. developブランチ作成

```bash
# developブランチを作成
git checkout -b develop

# リモートにプッシュ
git push -u origin develop
```

---

## 2. Render.com Pro設定

### 2.1 Web Service作成（ステージング）

1. Render.comダッシュボードにログイン
2. 「New +」→「Web Service」を選択
3. 以下の設定を行う：
   - **Name**: `yadopera-backend-staging`
   - **Region**: `Tokyo`（または最寄りのリージョン）
   - **Branch**: `develop`
   - **Root Directory**: `backend`
   - **Environment**: `Python 3`
   - **Build Command**: `pip install -r requirements.txt && alembic upgrade head`
   - **Start Command**: `uvicorn app.main:app --host 0.0.0.0 --port $PORT`

### 2.2 環境変数設定

Render.comの「Environment」タブで以下の環境変数を設定：

```bash
# データベース接続（Railway Hobby PostgreSQL）
DATABASE_URL=postgresql://user:password@host:port/database

# Redis接続（Railway Hobby Redis）
REDIS_URL=redis://user:password@host:port/0

# OpenAI API
OPENAI_API_KEY=sk-...

# JWT署名用シークレットキー
SECRET_KEY=your-secret-key-here

# CORS設定
CORS_ORIGINS=https://yadopera-frontend-staging.vercel.app

# 環境設定
ENVIRONMENT=staging
DEBUG=False

# ログレベル
LOG_LEVEL=INFO
```

### 2.3 自動デプロイ設定

- **Auto-Deploy**: `Yes`
- **Branch**: `develop`
- **Pull Request Previews**: `Enabled`（オプション）

---

## 3. Railway Hobby設定

### 3.1 PostgreSQLサービス追加

1. Railwayダッシュボードにログイン
2. 「New Project」→「Add Service」→「Database」→「PostgreSQL」を選択
3. サービス名: `yadopera-postgres-staging`
4. 接続情報を取得：
   - **Connection URL**: `postgresql://user:password@host:port/database`
   - このURLを`DATABASE_URL`としてRender.comに設定

### 3.2 Redisサービス追加

1. Railwayダッシュボードで「Add Service」→「Database」→「Redis」を選択
2. サービス名: `yadopera-redis-staging`
3. 接続情報を取得：
   - **Connection URL**: `redis://user:password@host:port/0`
   - このURLを`REDIS_URL`としてRender.comに設定

### 3.3 pgvector拡張有効化

PostgreSQLサービスで以下のSQLを実行：

```sql
CREATE EXTENSION IF NOT EXISTS vector;
```

---

## 4. フロントエンドデプロイ（Vercel）

### 4.1 Vercelプロジェクト作成

1. Vercelダッシュボードにログイン
2. 「Add New」→「Project」を選択
3. GitHubリポジトリを選択
4. 以下の設定を行う：
   - **Framework Preset**: `Vite`
   - **Root Directory**: `frontend`
   - **Build Command**: `npm run build`
   - **Output Directory**: `dist`
   - **Install Command**: `npm install`

### 4.2 環境変数設定

Vercelの「Settings」→「Environment Variables」で以下を設定：

```bash
# APIベースURL（Render.comバックエンド）
VITE_API_BASE_URL=https://yadopera-backend-staging.onrender.com

# 環境設定
VITE_ENVIRONMENT=staging
```

### 4.3 ブランチ設定

- **Production Branch**: `main`
- **Preview Branches**: `develop`（ステージング環境として使用）

---

## 5. データベースマイグレーション

### 5.1 マイグレーション実行

Render.comのバックエンドサービスで以下のコマンドを実行：

```bash
# マイグレーション実行
alembic upgrade head
```

または、Render.comの「Shell」から実行：

```bash
cd backend
alembic upgrade head
```

---

## 6. デプロイ確認

### 6.1 バックエンド確認

1. Render.comのバックエンドサービスURLにアクセス
2. ヘルスチェックエンドポイントを確認：
   ```
   GET https://yadopera-backend-staging.onrender.com/api/v1/health
   ```
3. ログを確認してエラーがないか確認

### 6.2 フロントエンド確認

1. VercelのフロントエンドURLにアクセス
2. ログイン機能を確認
3. チャット機能を確認
4. 管理画面機能を確認

### 6.3 動作確認チェックリスト

- [ ] バックエンドAPIが正常に応答する
- [ ] フロントエンドが正常に表示される
- [ ] 認証機能が正常に動作する
- [ ] チャット機能が正常に動作する
- [ ] 管理画面が正常に表示される
- [ ] データベース接続が正常である
- [ ] Redis接続が正常である
- [ ] OpenAI APIが正常に動作する

---

## 7. トラブルシューティング

### 7.1 データベース接続エラー

- Railway HobbyのPostgreSQL接続URLを確認
- `DATABASE_URL`環境変数が正しく設定されているか確認
- pgvector拡張が有効化されているか確認

### 7.2 Redis接続エラー

- Railway HobbyのRedis接続URLを確認
- `REDIS_URL`環境変数が正しく設定されているか確認

### 7.3 デプロイエラー

- Render.comのログを確認
- ビルドコマンドが正しく設定されているか確認
- 依存関係が正しくインストールされているか確認

### 7.4 CORSエラー

- `CORS_ORIGINS`環境変数が正しく設定されているか確認
- フロントエンドURLが`CORS_ORIGINS`に含まれているか確認

---

## 8. 環境変数一覧

### バックエンド（Render.com）

| 変数名 | 説明 | 例 |
|--------|------|-----|
| `DATABASE_URL` | PostgreSQL接続URL | `postgresql://user:pass@host:port/db` |
| `REDIS_URL` | Redis接続URL | `redis://user:pass@host:port/0` |
| `OPENAI_API_KEY` | OpenAI APIキー | `sk-...` |
| `SECRET_KEY` | JWT署名用シークレットキー | `your-secret-key` |
| `CORS_ORIGINS` | CORS許可オリジン | `https://yadopera-frontend-staging.vercel.app` |
| `ENVIRONMENT` | 環境設定 | `staging` |
| `DEBUG` | デバッグモード | `False` |
| `LOG_LEVEL` | ログレベル | `INFO` |

### フロントエンド（Vercel）

| 変数名 | 説明 | 例 |
|--------|------|-----|
| `VITE_API_BASE_URL` | APIベースURL | `https://yadopera-backend-staging.onrender.com` |
| `VITE_ENVIRONMENT` | 環境設定 | `staging` |

---

## 9. 参考資料

- [Render.com Documentation](https://render.com/docs)
- [Railway Documentation](https://docs.railway.app)
- [Vercel Documentation](https://vercel.com/docs)
- アーキテクチャ設計書 14. デプロイメント
- 要約定義書 7. 開発スケジュール（Phase 1 Week 4）

---

## 10. 次のステップ

ステージング環境構築完了後：

1. ステップ10: レスポンス速度最適化
2. ステップ11: エラーハンドリング強化
3. ステップ12: ドキュメント更新

