# CSV一括登録機能 ステージング前 調査・分析 確認結果報告

**作成日**: 2026年2月11日  
**目的**: ステージングへコミット・プッシュする前に問題の有無を調査し、残存課題を確認する。**指示があるまで修正は行わない。**

**参照ドキュメント**  
- CSV一括登録実装計画書 v2: `CSV_bulk_registration_function_implementation_plan2.txt`  
- Phase3 実装ステップ計画: `docs/Phase3/CSV一括アップロード_期待動作_ユーザーフロー_実装ステップ計画_20260210.md`  
- テスト結果説明・評価: `files/テスト結果_説明と評価_20260211.md`

---

## 1. 調査結果サマリー

| 観点 | 結果 | 備考 |
|------|------|------|
| Phase 0（DB・auth） | ✅ 実装済み | マイグレーション014、get_plan_defaults 整合 |
| Phase 1（バックエンドAPI） | ✅ 実装済み | パーサー・言語数制限・1トランザクション・bulk-upload |
| Phase 2（フロント） | ✅ 実装済み | plan_type 取得・モーダル・ボタン表示制御・API 呼び出し |
| 400 時エラーメッセージ表示 | ❌ 不具合 | モーダルで API の具体メッセージが表示されない（後述） |
| Phase 3（テスト・ドキュメント・デプロイ） | ⚠ 未実施 | 自動テスト未整備、ステージング未デプロイ |
| セキュリティ・バリデーション | ✅ 妥当 | 認証・10MB 制限・必須カラム・行バリデーション |

**結論**  
- 機能としては Phase 0〜2 まで実装済みで、ブラウザテストでも正常系・異常系の挙動は確認済み。  
- **1件の不具合**（400 時のモーダルで具体メッセージが出ない）と、**Phase 3 の未実施**（テスト整備・ステージングデプロイ）が残存している。  
- ステージングへプッシュすること自体は可能。不具合修正と Phase 3 は別タスクとして実施可能。

---

## 2. 計画書との照合

### 2.1 Phase 0（準備）

| 項目 | 計画 | 実装状況 |
|------|------|----------|
| マイグレーション 014 | faq_limit / language_limit を plan_type に合わせて更新 | ✅ `014_fix_faq_limit_by_plan.py` で Free=20, Mini=30, Small=50, Standard=100, Premium=NULL を設定 |
| auth_service get_plan_defaults | plan_limits と一致（Standard=100 等） | ✅ faq_limit / language_limit が plan_limits と一致 |
| 既存 bulk_create_faqs の動作確認 | Docker で確認 | 手動・ブラウザテストで一括登録は確認済み（単体 pytest は未実施） |

### 2.2 Phase 1（バックエンドAPI）

| 項目 | 計画 | 実装状況 |
|------|------|----------|
| 文字コード検出 | BOM → chardet → UTF-8/CP932 フォールバック | ✅ `encoding_detector.py` |
| CSV 解析 | 必須カラム・行バリデーション・FAQRequest 変換 | ✅ `csv_parser.py`（parse_faq_csv, CSVParseError, extract_languages_from_rows） |
| 言語数制限チェック | 既存＋CSV 新規言語 ≤ language_limit | ✅ `check_language_limit_for_csv` |
| bulk_create_faqs_from_csv | 1 トランザクション・1 件でも失敗でロールバック | ✅ commit=False / raise_on_embedding_failure=True で create_faq をループし、最後に commit、例外時 rollback |
| FAQ 登録数チェック | 既存件数＋CSV 行数 ≤ faq_limit（Standard=100, Premium 無制限） | ✅ `_get_faq_count` と facility.faq_limit でチェック |
| POST /admin/faqs/bulk-upload | プラン制限・10MB・file/mode・BulkUploadResult | ✅ 実装済み。CSVParseError / ValueError → 400、その他 → 500 |
| エラーメッセージ | 必須カラム不足・行番号付きカテゴリ等を日本語で返す | ✅ バックエンドは正しく detail（HTTPException）で返却。**ただしグローバルハンドラで `error.message` に変換して返している**（後述） |

### 2.3 Phase 2（フロントエンド）

| 項目 | 計画 | 実装状況 |
|------|------|----------|
| 施設 plan_type 取得 | FAQ 管理画面で CSV ボタン表示可否に使用 | ✅ getFacilitySettings で plan_type 取得、loadFacilityPlan() で設定 |
| CSV 一括登録モーダル | ファイル選択・D&D・送信・結果サマリー・エラー表示 | ✅ FaqBulkUploadModal.vue（accept=".csv"、プログレス、成功時サマリー） |
| ボタン表示制御 | Standard/Premium のみ「CSV一括登録」表示 | ✅ `planType === 'Standard' \|\| planType === 'Premium'` で表示 |
| API 呼び出し | multipart/form-data で bulk-upload、ローディング・エラー処理 | ✅ faq.ts の bulkUploadCsv、onUploadProgress |

### 2.4 Phase 3（テスト・ドキュメント・デプロイ）

| 項目 | 計画 | 実装状況 |
|------|------|----------|
| Docker 上でテスト | pytest（CSV 解析・encoding・API・プラン制限・言語数制限） | ❌ **未実施**。`backend/tests` に bulk-upload / csv_parser / encoding_detector のテストなし |
| CSV フォーマットガイド・サンプル | 参照可能であることを明記 | ⚠ ドキュメント・files 内サンプルはあり。管理画面からのリンクは未確認 |
| ステージングデプロイ | develop マージ後 Railway で確認 | ❌ 未実施（本調査時点） |

---

## 3. 発見した問題点（修正は行っていない）

### 3.1 【不具合】400 エラー時にモーダルで具体メッセージが表示されない → **修正済み（2026/02/11）**

**事象**  
- バックエンドは 400 時に `HTTPException(detail="必須カラムが不足しています: ...")` を投げている。  
- `main.py` の `http_exception_handler` はレスポンスを **`{"error": {"code": "BAD_REQUEST", "message": exc.detail, "details": {}}}`** の形で返している（`detail` ではなく `error.message`）。  
- フロントの `handleApiError` は `response.data.error` を参照しており、**正しく `{ code, message }` を取得している**。  
- しかし **FaqBulkUploadModal.vue の catch 内**で、`err.response?.data?.detail` を参照している。  
- axios のレスポンスインターセプターで `handleApiError(error)` を実行し、その戻り値（`AppError`：`{ code, message }`）を `Promise.reject(appError)` で渡しているため、**モーダルに渡る `err` はすでに `{ code, message }` であり `response` プロパティは存在しない**。  
- その結果、`err.response?.data?.detail` は常に undefined となり、フォールバックの「アップロードに失敗しました。しばらく待ってから再度お試しください。」のみ表示される。

**実施した修正（2026/02/11）**  
- バックアップ: `backups/20260211_csv_bulk_400_error_message_fix/FaqBulkUploadModal.vue`  
- モーダル側の catch で、axios インターセプター経由の AppError（`err.message`）を優先し、なければ `response.data.detail`、それもなければ汎用メッセージを表示するよう変更済み。

### 3.2 その他の確認事項（軽微・任意）

- **ファイル形式の厳密な制限**  
  バックエンドは「CSV であること」を Content-Type や拡張子では検証していない。10MB 以下であれば任意のバイナリも受け付ける。パーサーで失敗すれば 400 になるため、運用上は許容できるレベル。必要なら `file.content_type` やファイル名の `.csv` チェックを追加可能。

- **タイムアウト**  
  axios の timeout は 10 秒。100 件・埋め込み生成を含むと 60 秒程度かかる想定（計画書）のため、bulk-upload のみタイムアウトを延ばす設定を検討してもよい（現状でも 3.26 秒程度で成功しているスクショあり）。

---

## 4. 残存課題一覧

| 種別 | 内容 | 優先度 |
|------|------|--------|
| 不具合 | 400 時モーダルで API の具体メッセージが表示されない（3.1） | 高 |
| Phase 3 | Docker 上での pytest（csv_parser, encoding_detector） | ✅ 実施済み（test_encoding_detector.py, test_csv_parser.py 追加、16 件パス） |
| Phase 3 | ステージング環境へのデプロイ・動作確認未実施 | 中 |
| Phase 3 | 管理画面からの CSV フォーマットガイド／テンプレートリンク（任意） | 低 |
| 将来 | 上書きモード（upsert）は Phase 2 以降で未実装（計画どおり） | - |
| 将来 | 詳細ログのダウンロード機能は Phase 2 以降で未実装（計画どおり） | - |

---

## 5. ステージング前の推奨確認事項（手動で実施可能）

- [ ] `docker-compose up -d` のうえ、FAQ 管理画面で「CSV一括登録」を Standard/Premium で表示・Free/Mini/Small で非表示を再確認  
- [ ] test_valid_minimal.csv / test_valid_with_intent_key.csv で 201 成功・FAQ 一覧の件数増加を確認  
- [ ] test_invalid_missing_columns.csv / test_invalid_bad_category.csv で 400 となり、開発者管理ページのエラーログに期待どおりのメッセージが記録されることを確認  
- [ ] マイグレーション 014 が未適用の環境では `alembic upgrade head` を実行してから確認  
- [ ] ステージングへプッシュ後、Railway 等でマイグレーション・API・画面の動作を確認  

---

## 6. 総括

- **ステージングにコミット・プッシュしてよいか**  
  **可**。Phase 0〜2 の実装は計画と整合しており、既存ブラウザテスト結果とも矛盾しない。  
- **問題点（追記）**  
  - 400 時モーダル不具合は 2026/02/11 に修正済み（バックアップ: backups/20260211_csv_bulk_400_error_message_fix/）。  
  - Phase 3 の CSV 関連 pytest は実施済み（test_encoding_detector.py, test_csv_parser.py で 16 件パス）。ステージングデプロイ・ドキュメント周りは未実施。

**Document Version**: 1.1  
**Last Updated**: 2026年2月11日  
**Status**: 推奨修正実施済み。Docker 上で CSV 関連テスト実行済み（16 passed）。
