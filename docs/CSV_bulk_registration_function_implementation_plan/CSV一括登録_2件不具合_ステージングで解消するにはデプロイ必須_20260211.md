# CSV一括登録 2件不具合 — ステージングで解消するにはデプロイ必須

**作成日**: 2026年2月11日  
**前提**: ユーザーがステージング環境（yadopera-frontend-staging.onrender.com）で CSV 一括登録を利用し、従来どおり「タイムアウト」「英語の重複メッセージ」が表示される事象を報告。Docker で再ビルド・再起動して検証したが同じエラーが発生した、とのこと。

---

## 1. 結論：修正なしでは解決しない（ユーザー指摘は正しい）

- **エラーの意味がわからない・どう対処したらよいかわからない・困惑する・離脱する** — その通りであり、ビジネスの根幹を揺るがす重要な問題である。
- **「修正なしで解決する」は誤り**である。少なくとも **ユーザーが利用している環境（ステージング）に修正を反映する**必要がある。

---

## 2. なぜステージングで同じエラーが出るか（事実）

スクリーンショットの URL は以下である。

- フロント: `https://yadopera-frontend-staging.onrender.com/admin/faqs`
- バックエンド（ネットワークタブ）: `https://yadopera-backend-staging.onrender.com/api/v1/admin/faqs/bulk-upload`

すなわち、**表示はすべてステージング環境（Render にデプロイされたフロント・バックエンド）**である。

- **修正はリポジトリのコードには入っている**（`faq.ts` の `timeout: 60000`、`faq_service.py` の重複時日本語メッセージ、`errorHandler.ts` の 400 時 detail 表示）。
- しかし **ステージング環境には、その修正を含んだビルドがまだデプロイされていない**（またはデプロイ後に古いビルドが動いている）。
- そのため、ステージングで CSV 一括登録を行うと、**従来どおり**  
  - 1回目: 「リクエストがタイムアウトしました。接続を確認して再度お試しください。」  
  - 2回目: 「FAQ with the same intent_key already exists: faq_id=..., intent_key=...」  
  が表示される。

**Docker で再ビルド・再起動して検証**したのは **ローカル** のコンテナであり、**ステージング（Render）のサービスは別**である。ステージングの表示を変えるには、**ステージング用のフロント・バックエンドを、修正済みコードで再デプロイする**必要がある。

---

## 3. 必要な対応：ステージングへ修正済みコードをデプロイする

### 3.1 やるべきこと

1. **修正が入っているブランチを確認する**  
   - 通常は `develop` に、`frontend/src/api/faq.ts`（timeout: 60000）、`backend/app/services/faq_service.py`（重複時日本語）、`frontend/src/utils/errorHandler.ts`（400 detail 表示）の修正が含まれていることを確認する。

2. **ステージングのデプロイ元を確認する**  
   - Render のステージング用 Web サービス・Static Site が、どのブランチ（例: `develop`）からデプロイされているかを確認する。  
   - 参照: `docs/Deployment/` 内のステージング・Render 関連文書（例: `Render_Static_Site_ステージング環境デプロイ手順.md`、`ステージング環境構築手順.md`）。

3. **修正済みコードをステージングに反映する**  
   - ステージング用のフロントエンド（Static Site）とバックエンド（Web Service）の **両方** を、修正を含むブランチで **再デプロイ** する。  
   - Render の場合は、該当ブランチにプッシュするか、ダッシュボードから「Manual Deploy」で最新コミットをデプロイする。

4. **デプロイ後の確認**  
   - ステージングの FAQ 管理画面で、  
     - 1回目: 60秒以内に完了する CSV でタイムアウトせず成功表示になること。  
     - 2回目: 同じ CSV で日本語の「同じ内容のFAQは既に登録されています。…既存の同じFAQをFAQ一覧から削除してから、再度アップロードしてください。」が表示されること。  
   を確認する。

### 3.2 注意

- 引き継ぎ書では「ステージングは PoC 実行中・顧客使用中のため本件の対象外」「デプロイやステージング向けの変更は行わない」としていた。  
  これは **調査・原因特定の段階でステージングへの安易なデプロイを避ける** 趣旨であった。  
- **ユーザーが実際に利用しているのがステージングである以上、そこでエラーが解消されなければビジネス上の問題は解決しない。**  
  したがって、**ステージングで CSV 一括登録を利用する場合は、上記のとおり修正済みコードのステージングへのデプロイが必須**である。

---

## 4. コード側の整理（再確認）

| 項目 | ファイル | リポジトリ上の状態 |
|------|----------|---------------------|
| タイムアウト 60 秒 | `frontend/src/api/faq.ts` | `timeout: 60000` 指定済み |
| 重複時メッセージ（作成・更新） | `backend/app/services/faq_service.py` | 日本語メッセージに変更済み |
| 400 時にバックエンドの detail を表示 | `frontend/src/utils/errorHandler.ts` | `response.data.detail` を message に使用済み |

追加のコード変更は不要。**デプロイ** によりステージングに反映する。

---

## 5. 総括

- **修正なしでは解決しない。** ユーザーの指摘は正しい。
- ステージングで同じエラーが出る理由は、**修正済みコードがステージングにデプロイされていない** ためである。
- **必要な対応**: 修正が入ったブランチで、ステージング用フロント・バックエンドを **再デプロイ** し、デプロイ後に挙動を確認する。
- デプロイ手順は `docs/Deployment/` 内のステージング・Render 関連文書を参照する。

---

**Document Version**: 1.0  
**Last Updated**: 2026年2月11日
