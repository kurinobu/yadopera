# CSV一括登録 2件不具合対応 引き継ぎ書

**作成日**: 2026年2月11日  
**目的**: 本問題の背景・原因・経過を事実に基づいて記録し、次の担当が調査分析および大原則に準拠した修正案の提示を即座に再開できるようにする。

---

## 1. 問題の背景（事実）

- **機能**: 管理画面の FAQ 管理における **CSV 一括登録**（`POST /api/v1/admin/faqs/bulk-upload`）。
- **報告された事象**:
  - **事象1**: 1回目アップロード時に「アップロードに失敗しました」「リクエストがタイムアウトしました。接続を確認して再度お試しください。」と表示される。バックエンドでは処理が完了し 201 を返している場合もあるが、クライアントではタイムアウト扱いになる。
  - **事象2**: 同じ CSV を再度アップロードすると「FAQ with the same intent_key already exists: faq_id=..., intent_key=...」等の英語・技術用語のメッセージが表示され、ユーザーが原因と対処方法を理解しづらい。
- **テスト環境**: ユーザーは一貫して **ローカル環境でのブラウザテスト** であるとしている。**ステージングは現在 PoC 実行中で顧客が使用中のため、本件の対象外。**

---

## 2. 原因（調査で確定した事実）

### 2.1 事象1（タイムアウト表示）

- **直接原因**: 一括アップロードの HTTP リクエストに **タイムアウトが指定されていない** 場合、`frontend/src/api/axios.ts` のインスタンスデフォルト **10 秒** が適用される。サーバー処理が 10 秒を超えるとクライアントがリクエストを打ち切り、`ECONNABORTED` となり、インターセプターが「リクエストがタイムアウトしました。接続を確認して再度お試しください。」を返す。
- **コード上の対処**: `frontend/src/api/faq.ts` の `bulkUploadCsv` で `apiClient.post` の第3引数に **`timeout: 60000`** を指定すると、当該リクエストのみ 60 秒が適用され、10 秒で打ち切られなくなる。

### 2.2 事象2（重複時の英語メッセージ）

- **直接原因**: CSV 一括は `bulk_upload_faqs` → `faq_service.bulk_create_faqs_from_csv` → 行ごとに **`create_faq`** のみを呼ぶ。重複時は `create_faq` 内で `raise ValueError(...)` し、`admin/faqs.py` で `HTTPException(400, detail=str(e))` として返している。文言が英語・技術用語のままだとユーザーに伝わりにくい。また、フロントの `handleApiError` が 400 時に固定文言を返しており、バックエンドの `response.data.detail` がモーダルに表示されない実装だった。
- **コード上の対処**: (1) `backend/app/services/faq_service.py` の `create_faq` および `update_faq` の重複時 `ValueError` を、原因・対処が分かる**日本語**に変更する。(2) `frontend/src/utils/errorHandler.ts` で、status 400 かつ `response.data.detail` が文字列の場合は、その内容を `message` として返すようにする。

---

## 3. 経過（実施したこと・事実のみ）

| 順 | 内容 |
|----|------|
| 1 | タイムアウトの原因調査・修正案を文書化。`docs/CSV_bulk_registration_function_implementation_plan/CSV一括登録_成功時タイムアウト表示_原因調査と修正案_20260211.md` |
| 2 | 重複時エラー表示の調査・修正案を文書化。`docs/CSV_bulk_registration_function_implementation_plan/CSV一括登録_重複時エラー表示_調査と修正提案_20260211.md` |
| 3 | バックアップ作成後、`frontend/src/api/faq.ts` に `timeout: 60000` を追加。バックアップ: `backups/20260211_csv_bulk_timeout_fix/`（faq.ts, README.md） |
| 4 | バックアップ作成後、`backend/app/services/faq_service.py` の `create_faq` 内の重複時 `ValueError` を日本語に変更。バックアップ: `backups/20260211_csv_bulk_duplicate_error_message_fix/`（faq_service.py, README.md） |
| 5 | 原因確定・大原則準拠修正案を一括で文書化。`docs/CSV_bulk_registration_function_implementation_plan/CSV一括登録_2件不具合_原因確定調査報告と大原則準拠修正案_20260211.md` |
| 6 | バックアップ作成後、次の2点を実施。バックアップ: `backups/20260211_csv_bulk_duplicate_and_400_detail_fix/`（faq_service.py, errorHandler.ts, README.md） (1) `faq_service.py` の `update_faq` 内の重複時 `ValueError` を日本語に変更。(2) `frontend/src/utils/errorHandler.ts` で 400 時に `response.data.detail`（文字列）があればそれを `message` に使用するよう変更。 |
| 7 | ローカルでコードが確実に動くよう、`docker-compose down --remove-orphans` のうえ `docker-compose up -d --build` を実行。フロント 200・バックエンド 200 を確認。 |
| 8 | ユーザーがローカルでブラウザテストを実行。結果: 1回目でタイムアウト表示、2回目で英語の重複メッセージが表示された（期待しない結果）。 |
| 9 | テスト環境をステージングと誤認する記述を複数回行った。ユーザーから「ローカル環境でのテストである」「ステージングは PoC 実行中で顧客使用中」との訂正を二度受けた。 |
| 10 | ローカルテストに限定した結果説明・評価を文書化。`docs/CSV_bulk_registration_function_implementation_plan/CSV一括登録_ローカルブラウザテスト_結果説明と評価_20260211.md` |

---

## 4. 現時点のコード状態（事実）

- **frontend/src/api/faq.ts**  
  - `bulkUploadCsv` の `apiClient.post` 第3引数に **`timeout: 60000`** が含まれている（99行目付近）。
- **backend/app/services/faq_service.py**  
  - `create_faq` の重複時 `ValueError` は**日本語**（437〜440行付近:「同じ内容のFAQは既に登録されています。…既存の同じFAQをFAQ一覧から削除してから、再度アップロードしてください。」）。  
  - `update_faq` の重複時 `ValueError` も**日本語**（678〜682行付近:「同じ内容のFAQは既に登録されています。同じ質問・カテゴリのFAQは1件のみ登録できます。…」）。
- **frontend/src/utils/errorHandler.ts**  
  - status 400 のとき、`response.data.detail` が非空文字列ならそれを `message` に使用し、そうでなければ従来の固定文言を使用している（27〜36行付近）。

---

## 5. バックアップの場所（事実）

| ディレクトリ | 内容 |
|--------------|------|
| `backups/20260211_csv_bulk_timeout_fix/` | faq.ts（timeout 追加前） |
| `backups/20260211_csv_bulk_duplicate_error_message_fix/` | faq_service.py（create_faq 日本語変更前） |
| `backups/20260211_csv_bulk_duplicate_and_400_detail_fix/` | faq_service.py, errorHandler.ts（update_faq 日本語化・400 detail 表示の変更前） |

各ディレクトリに README.md あり。復元時は該当ファイルを上書きコピーする。

---

## 6. 参照すべきドキュメント（事実）

| ファイル | 内容 |
|----------|------|
| `docs/CSV_bulk_registration_function_implementation_plan/CSV一括登録_2件不具合_原因確定調査報告と大原則準拠修正案_20260211.md` | 原因の確定根拠と大原則に準拠した修正案（コード変更内容含む）。 |
| `docs/CSV_bulk_registration_function_implementation_plan/CSV一括登録_ローカルブラウザテスト_結果説明と評価_20260211.md` | ローカル環境でのテスト結果の説明と評価（テスト環境はローカルのみ。ステージングは対象外）。 |
| `docs/CSV_bulk_registration_function_implementation_plan/CSV一括登録_成功時タイムアウト表示_原因調査と修正案_20260211.md` | タイムアウト事象の原因と修正案。 |
| `docs/CSV_bulk_registration_function_implementation_plan/CSV一括登録_重複時エラー表示_調査と修正提案_20260211.md` | 重複時メッセージの調査と修正提案。 |
| `docs/Summary/yadopera-v03-summary.md` | 大原則（§0）の定義。 |
| `docs/CSV_bulk_registration_function_implementation_plan/CSV一括登録_2件不具合_ステージングで解消するにはデプロイ必須_20260211.md` | ステージングで利用する場合にデプロイが必須である理由と手順。 |

---

## 7. 次の担当が行うこと（引き継ぎ用）

1. **背景・原因・経過の把握**: 本引き継ぎ書の 1〜3 節および 6 節のドキュメントで、問題の背景・確定した原因・これまでの経過を把握する。
2. **現状の確認**: 4 節のとおり、該当ファイルに上記修正が入っていることをリポジトリ上で確認する。
3. **調査分析**: ローカルで「1回目タイムアウト・2回目英語メッセージ」が再現した理由を、実行時に使用されたフロント・バックエンドのコードが修正後だったかどうかの観点で必要に応じて調査する。
4. **大原則に準拠した修正案の提示**: 要約定義書の大原則に準拠したうえで、追加のコード変更が必要か、運用（再起動・再ビルド・再テスト手順）で足りるかを整理し、修正案として提示する。
5. **注意**: ステージングは PoC 実行中・顧客使用中のため、本件の調査時点ではデプロイ対象外としていた。**ただし、ユーザーが実際に利用するのがステージングである場合は、修正を反映するためにステージングへのデプロイが必須である。**「修正なしで解決する」は誤り。詳細は `CSV一括登録_2件不具合_ステージングで解消するにはデプロイ必須_20260211.md` を参照。

---

**Document Version**: 1.1  
**Last Updated**: 2026年2月11日
