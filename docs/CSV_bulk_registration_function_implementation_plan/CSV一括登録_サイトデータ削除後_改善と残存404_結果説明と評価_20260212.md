# CSV一括登録 サイトデータ削除後 — 改善点と残存404 結果説明と評価 2026-02-12

**前提**: アプリケーションでサイトデータを削除し強制リロードしたうえでブラウザテストを実施。改善した点と改善しなかった点、スクリーンショット・ログに基づく説明と評価。

---

## 1. 改善した点（期待どおり）

| 項目 | 内容 |
|------|------|
| **FAQ 管理・CSV一括登録モーダル** | 「CSV一括登録」ボタンでモーダルを開くと、**ダウンロードリンクが表示され、ダウンロードが可能になった**。→ 問題B 解消。 |
| **マニュアル内のリンク表示** | マニュアル内の該当箇所が**青（ブルー）のリンク**で表示されるようになった。→ 問題A の表示面は解消。 |
| **付録へのページ内リンク** | マニュアル内の付録（例: 12.2 翻訳手引書）への**ページ内リンクが正常に動作**した。 |

**解釈**: キャッシュを消して強制リロードしたことで、**修正済みの JS（ManualContent のプレースホルダ置換、FaqManagement の v-if によるモーダル再マウント）が読み込まれ**、問題A（リンクの見た目）と問題B（モーダル内テンプレート）は解消している。

---

## 2. 改善されなかった点（残存する不具合）

**事象**: マニュアル内の「CSVテンプレートをダウンロード」リンクを**タップ（クリック）すると 404 エラーが発生**する。戻ると、リンクは青いまま正常に表示されている。

### 2.1 スクリーンショット・ログから分かること

| 確認項目 | 内容 |
|----------|------|
| **表示** | URL `https://yadopera-frontend-staging.onrender.com/faq-csv-template/FAQ_CSV_template_4lang.csv` を開いた結果、画面上に **「404」「ページが見つかりません」** が表示されている。 |
| **コンソール** | `[Router Guard] ... toName: 'NotFound'` と出ている。→ アプリの**クライアント側ルーター**が、このパスを「存在しないルート」と解釈し、404 画面を表示している。 |
| **Network** | `FAQ_CSV_template_4lang.csv` へのリクエストの **Status は 200**、**Type は document**、**Size は (ServiceWorker...)** と表示されている。 |
| **バックエンドログ** | 共有されたログには `/api/v1/...` へのリクエストのみで、いずれも 200 OK。**CSV のパス（/faq-csv-template/...）へのリクエストはバックエンドには来ていない**（静的ファイルはフロントのホストで扱うため想定どおり）。 |

### 2.2 評価：なぜ 404 になるか

- **Status 200 で「404 ページ」が表示される** ＝ サーバー（または Service Worker）が **HTML（index.html または 404 用 HTML）を 200 で返し**、その HTML を読み込んだ Vue アプリがルート未一致で **NotFound 画面を出している** 状態（ソフト 404）。
- **Size (ServiceWorker...)** から、このリクエストは **Service Worker を経由している**。
- **原因**: PWA の Workbox で **`navigateFallback: '/index.html'`** が有効になっており、**ナビゲーション要求**でキャッシュにないパスには **index.html を返す** 設定になっている。  
  `navigateFallbackDenylist` は現在 **`/^\/api\//`** のみで、**`/faq-csv-template/` は対象外**。  
  そのため、リンクをタップして `/faq-csv-template/FAQ_CSV_template_4lang.csv` に**遷移**すると、Service Worker がこのパスを「フォールバック対象」とみなし、**index.html を返す**。ブラウザは 200 + index.html を受け取り、Vue Router が起動して該当ルートが無いため **NotFound** を表示する。
- **補足**: 静的ファイルとして CSV が dist に含まれていても、**SW が先にリクエストを処理して index.html を返してしまう**ため、サーバーが CSV を返す機会がない。

---

## 3. 総合評価

| 観点 | 評価 |
|------|------|
| **問題A（マニュアルのリンク化）** | **表示は解消**（青リンクで表示）。**クリック時の挙動は未解消**（CSV ではなく 404 ページが開く）。 |
| **問題B（モーダル内テンプレート）** | **解消**（サイトデータ削除・強制リロード後、モーダルにダウンロードリンクが表示されダウンロード可能）。 |
| **問題C（CSV 配信）** | **要確認**。サーバー側で CSV が dist に含まれていても、**同一オリジンでのリンク遷移**では Service Worker の navigateFallback により index.html が返り、404 になる。別タブで CSV URL を直接開く、または SW を経由しないリクエストでは 200 で CSV が返る可能性はある。 |
| **バックエンド** | ログ上は API はすべて 200 OK。CSV 404 は**フロントのホスティングと Service Worker の挙動**に起因する。 |

---

## 4. 残存 404 の対応方針（推奨）

**原因**: Service Worker が `/faq-csv-template/...` へのナビゲーション要求を拾い、navigateFallback で index.html を返している。

**対応**: Workbox の **`navigateFallbackDenylist`** に **`/faq-csv-template/`** を追加し、このパスでは **フォールバック（index.html）を行わない** ようにする。  
すると、この URL へのリクエストは Service Worker で処理されずネットワークに渡り、Render が静的ファイルとして **CSV を返す**（dist に含まれていれば 200 + CSV になる）。

- **変更例**: `vite.config.ts` の  
  `navigateFallbackDenylist: [/^\/api\//]`  
  を  
  `navigateFallbackDenylist: [/^\/api\//, /^\/faq-csv-template\//]`  
  に変更する。

以上を反映したうえで再ビルド・再デプロイし、マニュアルの CSV リンクをタップして 404 にならないことを確認する。
