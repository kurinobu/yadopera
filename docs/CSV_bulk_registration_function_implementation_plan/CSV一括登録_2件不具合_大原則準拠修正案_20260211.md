# CSV一括登録 2件不具合 大原則準拠修正案

**作成日**: 2026年2月11日  
**前提**: 要約定義書・アーキテクチャ設計書・引き継ぎ書・原因確定調査報告を精読し、コードベースで事実を確認したうえで作成。  
**大原則**: `docs/Summary/yadopera-v03-summary.md` §0 に準拠する。

---

## 1. 要約定義書・アーキテクチャから把握した目的・全体像・大原則

### 1.1 目的・全体像

- **やどぺら**: 小規模宿泊施設向け外国人ゲスト対応自動化SaaS。QRコードでAIが24時間多言語自動応答。
- **本機能**: 管理画面のFAQ管理における **CSV一括登録**（`POST /api/v1/admin/faqs/bulk-upload`）。埋め込み生成を含むため処理時間が長くなり得る。
- **経緯**: CSV一括登録実装後に、(1) 1回目アップロードで「タイムアウト」表示、(2) 2回目で英語・技術用語の重複メッセージ、が報告された。

### 1.2 大原則（要約定義書 §0・最優先で遵守）

| 原則 | 内容 |
|------|------|
| 根本解決 > 暫定解決 | 一時的な回避策ではなく根本原因を解決する。 |
| シンプル構造 > 複雑構造 | 過度に複雑な実装を避け、保守しやすい構造を選択。 |
| 統一・同一化 > 特殊独自 | 既存パターン・規約に従い、統一された実装を優先。 |
| 具体的 > 一般 | 曖昧な表現を避け、実行可能な具体的な内容を記載。 |
| 拙速 < 安全確実 | テストを省略せず、十分な検証を行ってから反映。 |
| **Docker環境必須** | **Dockerを使わない修正もテストも意味がない。** すべての修正・テストは Docker 環境（docker-compose）で実行する。ローカル直接実行は無効。 |

---

## 2. 原因の事実確認（コードベースで検証済み）

### 2.1 事象1: 1回目アップロードで「タイムアウト」表示

**確定した原因（引き継ぎ書・原因確定調査報告と一致）**

- **直接原因**: 一括アップロードに **タイムアウトが効いていない** 状態で実行されていた場合、`frontend/src/api/axios.ts` のインスタンスデフォルト **10秒** が適用され、サーバー処理が10秒を超えるとクライアントが打ち切り `ECONNABORTED` → インターセプターが「リクエストがタイムアウトしました。接続を確認して再度お試しください。」を返す。
- **コード上の対処**: `frontend/src/api/faq.ts` の `bulkUploadCsv` で `apiClient.post` の第3引数に **`timeout: 60000`** を指定すれば、当該リクエストのみ60秒が適用される。

**リポジトリ上の事実（2026-02-11 確認）**

- `frontend/src/api/faq.ts` 96〜104行目: **既に `timeout: 60000` が指定されている。**
- したがって、**実行時にこのコード（またはそのビルド）が使われていれば** 10秒で打ち切られることはない。
- ローカルテストで「タイムアウト」が出た理由は、**実行中のフロントが修正後のコード／ビルドになっていなかった**ため（開発サーバー再起動なし・Docker 再ビルドなし等）と確定されている。

### 2.2 事象2: 2回目アップロードで英語・技術用語の重複メッセージ

**確定した原因（引き継ぎ書・原因確定調査報告と一致）**

- **直接原因**: CSV一括は `bulk_upload_faqs` → `faq_service.bulk_create_faqs_from_csv` → 行ごとに **`create_faq`** のみを呼ぶ。重複時は `create_faq` 内で `raise ValueError(...)` し、`admin/faqs.py` で `HTTPException(400, detail=str(e))` として返している。文言が英語・技術用語のままだとユーザーに伝わりにくい。また、フロントで 400 時にバックエンドの `detail` が表示されない実装だと、原因・対処が伝わらない。
- **コード上の対処**: (1) `faq_service.py` の `create_faq` および `update_faq` の重複時 `ValueError` を**日本語**に変更する。(2) フロントの `errorHandler.ts` で、status 400 かつ `response.data.detail` が文字列の場合はその内容を `message` として返す。

**リポジトリ上の事実（2026-02-11 確認）**

- **backend/app/services/faq_service.py**
  - `create_faq` 内（437〜440行）: 重複時 `ValueError` は **日本語**（「同じ内容のFAQは既に登録されています。CSV一括登録では…既存の同じFAQをFAQ一覧から削除してから、再度アップロードしてください。」）。
  - `update_faq` 内（679〜682行）: 重複時 `ValueError` も **日本語**（「同じ内容のFAQは既に登録されています。同じ質問・カテゴリのFAQは1件のみ…既存の同じFAQをFAQ一覧から削除するか、質問・カテゴリを変更してください。」）。
- **frontend/src/utils/errorHandler.ts**（27〜36行）: status 400 のとき、`response.data.detail` が非空文字列ならそれを `message` に使用し、そうでなければ従来の固定文言を使用している。
- **frontend/src/components/admin/FaqBulkUploadModal.vue**（161〜171行）: catch で `appErrorMsg ?? rawDetail` を表示。インターセプターが `handleApiError` の戻り値（`message` に detail が入る）で reject するため、**400 時はバックエンドの detail がモーダルに表示される**実装になっている。

したがって、**コード上は重複メッセージの日本語化と 400 detail 表示の両方が既に入っている。** ローカルで英語が出た理由は、**実行中のバックエンドが修正後の `faq_service.py` を読み込んでいなかった**ため（プロセス再起動なし・Docker 再ビルドなし等）と確定されている。

---

## 3. 大原則に準拠した修正案

### 3.1 方針

- **コード変更**: 上記のとおり、**現時点のリポジトリには必要な修正が既に含まれている。** 追加のコード変更は不要とする。
- **根本原因**: 修正が「実行環境に反映されていなかった」こと。大原則の **「Docker環境必須」** と **「拙速 < 安全確実」** に従い、**Docker 環境で再ビルド・再起動を明示して検証**することで解消する。
- **統一・同一化**: 重複エラーは作成時・更新時とも日本語で統一済み。400 はバックエンドの detail を表示するパターンで他 API と方針を揃えている。

### 3.2 実施内容（運用・検証手順）

以下の手順を **Docker 環境** で実施する。ローカル直接実行（`npm run dev` のみ・Python 直接起動のみ）での確認は大原則上無効とする。

1. **クリーンな状態でビルド・起動**
   - `docker-compose down --remove-orphans`
   - `docker-compose build --no-cache`（少なくとも frontend, backend）
   - `docker-compose up -d`
   - 必要に応じて DB マイグレーション・初期データの確認

2. **事象1の検証（タイムアウト）**
   - ブラウザで管理画面にログインし、FAQ 管理から CSV 一括登録を開く。
   - 60秒以内に完了する CSV（例: 数件〜十数件）で 1 回目アップロードを実行する。
   - **期待**: 60秒以内に処理が終わる場合は「アップロードが完了しました」等の成功表示になること。10秒前後で「タイムアウト」表示にならないこと。

3. **事象2の検証（重複時メッセージ）**
   - 同じ CSV を **2 回目** アップロードする。
   - **期待**: モーダルに **日本語** で「同じ内容のFAQは既に登録されています。…既存の同じFAQをFAQ一覧から削除してから、再度アップロードしてください。」（または同趣旨）が表示されること。英語の「FAQ with the same intent_key already exists」等が表示されないこと。

4. **検証結果の記録**
   - 上記 2・3 の結果を記録し、問題がなければ「Docker 環境で 2 件不具合の解消を確認した」と引き継ぎ書または同フォルダ内の文書に追記する。

### 3.3 それでも事象が再現する場合の確認ポイント

- **事象1が再現する場合**: ブラウザの DevTools → ソース（またはネットワークの Initiator）で、実際に読み込まれている `faq.ts` またはバンドル内の `bulkUploadCsv` に `timeout: 60000`（または 60000）が含まれているかを確認する。含まれていなければ、フロントイメージのビルドキャッシュ削除（`docker-compose build --no-cache frontend`）とコンテナの再作成を行う。
- **事象2が再現する場合**: バックエンドコンテナ内の `faq_service.py` で、`create_faq` の重複時 `ValueError` が日本語になっているかを確認する。英語のままなら、バックエンドイメージの再ビルド（`docker-compose build --no-cache backend`）とコンテナの再起動を行う。

### 3.4 ステージング・本番について

- 引き継ぎ書のとおり、**ステージングは PoC 実行中・顧客使用中のため本件の対象外**とする。デプロイやステージング向けの変更は行わない。
- Docker 環境で検証が完了したうえで、今後のデプロイ判断は別途行う。

---

## 4. 総括

| 項目 | 内容 |
|------|------|
| 原因（事象1） | 実行フロントに一括アップロード用の **timeout: 60000 が含まれていなかった**（コードは既に指定済み。実行環境が古いビルドのまま）。 |
| 原因（事象2） | 実行バックエンドが **create_faq / update_faq の日本語変更後の faq_service.py を読み込んでいなかった**（コードは既に日本語＋errorHandler で 400 detail 表示済み。実行環境が古いプロセスのまま）。 |
| コード変更 | **追加不要**。現行リポジトリで必要修正は揃っている。 |
| 修正の要点 | **Docker 環境で再ビルド・再起動を明示して検証**し、「修正後のコードが確実に使われている」状態でタイムアウト解消・日本語表示を確認する。 |
| 大原則との対応 | Docker環境必須・拙速より安全確実・統一同一化・根本解決（実行環境の反映）に準拠。 |

---

**Document Version**: 1.0  
**Last Updated**: 2026年2月11日  
**Status**: 大原則準拠修正案提示完了。コード変更は不要。Docker 環境での検証手順の実施を推奨。
