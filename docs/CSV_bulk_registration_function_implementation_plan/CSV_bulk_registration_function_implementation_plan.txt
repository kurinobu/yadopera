================================================================================
FAQ CSV一括登録機能 実装計画書
================================================================================

作成日: 2026年1月27日
プロジェクト: やどぺら (YadOPERA) v0.3
対象機能: FAQのCSVファイルによる一括登録機能

================================================================================
目次
================================================================================

1. 概要・目的
2. 調査結果サマリー
3. 機能仕様
4. 技術仕様
5. 実装計画（フェーズ別）
6. データ構造・CSV仕様
7. バリデーションルール
8. エラーハンドリング
9. テスト計画
10. リスク・注意事項
11. 将来の拡張

================================================================================
1. 概要・目的
================================================================================

【目的】
宿泊施設管理者または開発者がCSVファイルをアップロードすることにより、
FAQを自動で一括登録（上書き/追加）できる機能を実装する。

【ビジネス要件】
- 宿泊施設管理者が自身で実行する場合: 無料
- 開発者へFAQ登録依頼する場合: 有料（料金体系は別途）
- StandardプランおよびPremiumプランのみの機能
- プラン料金とは別料金が発生（Stripe実装後に継承）

【料金体系】
■ Standard（最大100件）
  〜30件：¥12,000
  〜60件：¥22,000
  〜100件：¥32,000

■ Premium（件数無制限）
  〜50件：¥25,000
  〜100件：¥45,000
  〜200件：¥68,000
  200件超：個別見積（¥90,000〜）

【料金に含まれる内容】
- 日本語FAQの質問文・回答文の自然さ／文法確認
- 軽微な表現修正（意味変更なし）
- AI翻訳＋人による品質確認
- 管理画面への登録作業
- 表示・動作チェック（初回）

【料金に含まれない内容】
- FAQの新規企画・構成設計
- 内容の事実確認（運営保証なし）
- 大幅な書き直し・再編集
- 法的表現監修・翻訳証明

================================================================================
2. 調査結果サマリー
================================================================================

【データベース構造】
■ faqsテーブル（インテントベース）
  - id: FAQ ID
  - facility_id: 施設ID
  - category: カテゴリ（basic/facilities/location/trouble）
  - intent_key: インテント識別キー（例: basic_checkout_time）
  - priority: 優先度（1-5）
  - is_active: 有効/無効
  - created_by: 作成者ID
  - created_at, updated_at

■ faq_translationsテーブル（言語ごとの翻訳）
  - id: 翻訳ID
  - faq_id: FAQ ID（外部キー）
  - language: 言語コード（en/ja/zh-TW/fr/ko）
  - question: 質問文
  - answer: 回答文
  - embedding: 埋め込みベクトル（vector(1536)）
  - created_at, updated_at

【プラン管理】
■ facilitiesテーブル
  - plan_type: プラン種別（Free/Mini/Small/Standard/Premium）
  - faq_limit: FAQ登録数上限（Premiumの場合はNULL=無制限）
  - language_limit: 同時利用言語数上限（Premiumの場合はNULL=無制限）
  - monthly_question_limit: 月間質問数上限

【プラン別制限（plan_limits.py）】
  Free: FAQ 20件、言語 1（日本語のみ）
  Mini: FAQ 30件、言語 2
  Small: FAQ 50件、言語 3
  Standard: FAQ 100件、言語 4
  Premium: FAQ 無制限、言語 無制限

【既存実装の確認】
✓ bulk_create_faqs()メソッド: 既に存在（faq_service.py L422）
✓ CSV処理の参考実装: insert_operator_faqs.py
✓ 認証方式: JWT Bearer Token（get_current_user()）
✓ エラーハンドリング: HTTPException + try-catch パターン
✓ 言語数制限・FAQ登録数制限のバリデーションロジック: 実装済み

✗ ファイルアップロード機能: 未実装（新規実装が必要）

【実データ統計（2026年1月27日時点）】
- 施設数: 41施設
- FAQ総数: 914件（インテント単位）
- プラン分布: Free (11), Mini (5), Small (10), Standard (12), Premium (3)

【重要な発見】
⚠ FAQ登録数制限の不整合
  - 実データ: 全プランfaq_limit=20
  - plan_limits.py: Standard=100, Premium=無制限
  → マイグレーション012で初期値20が設定されているため
  → CSV一括登録実装時に、plan_limits.pyの値を優先する

⚠ Premiumプランのfaq_limit
  - 実データ: 20（数値）
  - 仕様: None（無制限）
  → マイグレーション012の不備により、Premiumでもfaq_limit=20が設定されている
  → 修正が必要（別タスクとして対応）

================================================================================
3. 機能仕様
================================================================================

【3.1 機能概要】
CSVファイルをアップロードし、FAQを一括登録（追加/上書き）する機能。

【3.2 対象ユーザー】
- 宿泊施設管理者（自身で登録: 無料）
- 開発者（依頼を受けて登録: 有料）

【3.3 対象プラン】
- Standard
- Premium
※ Free/Mini/Smallプランでは利用不可（制限メッセージを表示）

【3.4 登録モード】
■ 追加モード（デフォルト）
  - CSVの各行を新規FAQとして追加
  - intent_keyが重複する場合はスキップ（エラーログに記録）

■ 上書きモード（オプション）
  - CSVにintent_keyカラムがある場合、既存FAQを更新
  - intent_keyが存在しない場合は新規追加

【3.5 登録件数制限】
- Standardプラン: 最大100件まで
  → CSVのデータが100件以上ある場合、全件登録しない
  → エラーメッセージ「Standardプランでは100件までしか登録できません。
     CSVを100件以内に修正するか、Premiumプランにアップグレードしてください。」

- Premiumプラン: 無制限

【3.6 アップロード結果の記録・表示】
以下の情報を日本語で記録・表示する：
- 成功件数
- 失敗件数
- 失敗原因（件数別サマリー + 詳細ログ）
- 処理時間
- アップロード日時
- アップロード者

【3.7 UI/UX要件】
- FAQ管理画面に「CSV一括登録」ボタンを追加
- モーダルでCSVファイル選択UIを表示
- ドラッグ&ドロップ対応
- プログレスバー表示（処理中）
- 結果サマリー表示（処理完了後）
- 詳細ログのダウンロード機能

================================================================================
4. 技術仕様
================================================================================

【4.1 システム構成】
■ バックエンド
  - フレームワーク: FastAPI
  - 言語: Python 3.11+
  - データベース: PostgreSQL 15 + pgvector
  - ORM: SQLAlchemy（非同期）
  - CSV解析: pandas
  - 埋め込みベクトル生成: OpenAI Embeddings API

■ フロントエンド
  - フレームワーク: Vue 3 + TypeScript
  - ビルドツール: Vite
  - UIライブラリ: Tailwind CSS
  - ファイルアップロード: ネイティブ<input type="file">

【4.2 API仕様】

■ エンドポイント
POST /admin/faqs/bulk-upload

■ リクエスト
Content-Type: multipart/form-data

フィールド:
- file: CSVファイル（必須、最大サイズ10MB）
- mode: 登録モード（optional、デフォルト="add"）
  - "add": 追加モード
  - "upsert": 上書きモード（intent_keyで判定）

■ レスポンス（成功時）
Status: 201 Created
Content-Type: application/json

{
  "success_count": 25,
  "failure_count": 2,
  "total_count": 27,
  "skipped_count": 0,
  "processing_time_seconds": 12.5,
  "uploaded_at": "2026-01-27T12:34:56Z",
  "uploaded_by": 123,
  "errors": [
    {
      "row": 5,
      "intent_key": "basic_wifi_password",
      "reason": "FAQ with the same intent_key already exists",
      "details": "faq_id=456, intent_key=basic_wifi_password"
    },
    {
      "row": 18,
      "intent_key": "facilities_kitchen_hours",
      "reason": "プランの言語数制限に達しています（2言語）",
      "details": "既存の言語（en, ja）を使用するか、プランをアップグレードしてください。"
    }
  ],
  "warnings": [
    {
      "row": 3,
      "intent_key": "basic_checkout_time",
      "message": "埋め込みベクトルの生成に失敗しました（後で再生成可能）"
    }
  ]
}

■ レスポンス（エラー時）
Status: 400 Bad Request / 403 Forbidden / 500 Internal Server Error
Content-Type: application/json

{
  "detail": "エラーメッセージ（日本語）"
}

【4.3 CSV仕様】

■ 文字コード
UTF-8（BOM付き推奨、Excel互換性のため）

■ 区切り文字
カンマ（,）

■ 必須カラム
- category: カテゴリ（basic/facilities/location/trouble）
- language_ja_question: 日本語の質問文
- language_ja_answer: 日本語の回答文

■ オプションカラム
- intent_key: インテント識別キー（指定しない場合は自動生成）
- priority: 優先度（1-5、デフォルト=3）
- is_active: 有効/無効（true/false、デフォルト=true）
- language_en_question: 英語の質問文
- language_en_answer: 英語の回答文
- language_zh-TW_question: 繁体中国語の質問文
- language_zh-TW_answer: 繁体中国語の回答文
- language_fr_question: フランス語の質問文
- language_fr_answer: フランス語の回答文
- language_ko_question: 韓国語の質問文
- language_ko_answer: 韓国語の回答文

■ CSVサンプル（最小構成）
```csv
category,language_ja_question,language_ja_answer
basic,チェックアウトは何時ですか？,チェックアウトは11時までです。
basic,WiFiパスワードは何ですか？,WiFiパスワードはguest2024です。
facilities,キッチンは使えますか？,キッチンは24時間利用可能です。
```

■ CSVサンプル（多言語対応）
```csv
category,intent_key,priority,language_ja_question,language_ja_answer,language_en_question,language_en_answer
basic,basic_checkout_time,5,チェックアウトは何時ですか？,チェックアウトは11時までです。,What time is check-out?,Check-out is by 11:00 AM.
basic,basic_wifi_password,5,WiFiパスワードは何ですか？,WiFiパスワードはguest2024です。,What is the WiFi password?,The WiFi password is guest2024.
```

【4.4 処理フロー】

1. CSVファイル受信
   ↓
2. ファイルサイズチェック（10MB以内）
   ↓
3. プラン制限チェック（Standard/Premiumのみ）
   ↓
4. CSV解析（pandas）
   - 文字コード検出（chardet）
   - 必須カラムの存在確認
   ↓
5. 行数チェック
   - Standardプラン: 100件以内
   - Premiumプラン: 無制限
   ↓
6. 各行の処理（トランザクション内）
   a. バリデーション
      - categoryの妥当性チェック
      - 質問文・回答文の文字数チェック
      - 言語数制限チェック
   b. intent_keyの生成または取得
   c. 重複チェック（追加モードの場合）
   d. FAQTranslationレコード作成
   e. 埋め込みベクトル生成（非同期）
   f. データベース保存
   ↓
7. 結果集計
   - 成功件数
   - 失敗件数
   - エラー詳細
   ↓
8. キャッシュ無効化
   ↓
9. レスポンス返却

【4.5 エラーハンドリング】

■ ファイルレベル
- ファイルサイズ超過（10MB以上）
  → 400 Bad Request: "ファイルサイズは10MB以内にしてください"
- CSVフォーマット不正
  → 400 Bad Request: "CSVファイルの形式が不正です"
- 必須カラム欠落
  → 400 Bad Request: "必須カラムが不足しています: category, language_ja_question, language_ja_answer"

■ プラン制限
- Free/Mini/Smallプランでのアクセス
  → 403 Forbidden: "CSV一括登録はStandardプランまたはPremiumプランでのみ利用可能です"
- Standardプランで100件超
  → 400 Bad Request: "Standardプランでは100件までしか登録できません"

■ 行レベル（個別エラー、処理は継続）
- intent_key重複（追加モード）
  → スキップ、エラーログに記録
- 言語数制限超過
  → スキップ、エラーログに記録
- 質問文・回答文の文字数超過
  → スキップ、エラーログに記録
- 埋め込みベクトル生成失敗
  → FAQは登録、警告ログに記録

【4.6 セキュリティ】
- JWT認証必須（get_current_user()）
- ファイルサイズ制限（10MB）
- CSVインジェクション対策（pandasで安全に解析）
- SQLインジェクション対策（ORMを使用、プリペアドステートメント）
- XSS対策（フロントエンドでサニタイズ）

================================================================================
5. 実装計画（フェーズ別）
================================================================================

【Phase 1: バックエンドAPI実装】（優先度: 高）

■ タスク1.1: CSVアップロードエンドポイント作成
ファイル: backend/app/api/v1/admin/faqs.py
内容:
  - POST /admin/faqs/bulk-upload エンドポイント追加
  - multipart/form-data 対応
  - ファイルサイズチェック（10MB）
  - プラン制限チェック（Standard/Premium）

■ タスク1.2: CSV解析ロジック実装
ファイル: backend/app/services/csv_parser.py（新規）
内容:
  - pandas でCSV読み込み
  - 文字コード検出（chardet）
  - 必須カラム検証
  - 行数制限チェック
  - データ型変換

■ タスク1.3: FAQ一括登録サービス実装
ファイル: backend/app/services/faq_service.py
内容:
  - bulk_create_faqs_from_csv() メソッド追加
  - 既存の bulk_create_faqs() を活用
  - トランザクション管理
  - エラーハンドリング
  - 結果集計

■ タスク1.4: レスポンススキーマ定義
ファイル: backend/app/schemas/faq.py
内容:
  - BulkUploadResponse
  - BulkUploadError
  - BulkUploadWarning

■ タスク1.5: バリデーション強化
ファイル: backend/app/services/faq_service.py
内容:
  - 行単位のバリデーション
  - 言語数制限チェック（既存ロジック活用）
  - FAQ登録数制限チェック（新規実装）

■ タスク1.6: テスト実装
ファイル: backend/tests/test_faq_bulk_upload.py（新規）
内容:
  - ユニットテスト
  - 統合テスト
  - エラーケーステスト

推定工数: 16時間（2営業日）

---

【Phase 2: フロントエンドUI実装】（優先度: 高）

■ タスク2.1: CSV一括登録モーダル作成
ファイル: frontend/src/components/admin/FaqBulkUploadModal.vue（新規）
内容:
  - ファイル選択UI
  - ドラッグ&ドロップ対応
  - プログレスバー
  - 結果サマリー表示

■ タスク2.2: FAQ管理画面に統合
ファイル: frontend/src/views/admin/FaqManagement.vue
内容:
  - 「CSV一括登録」ボタン追加
  - モーダル表示制御
  - プラン制限チェック（Free/Mini/Smallは非表示）

■ タスク2.3: API連携実装
ファイル: frontend/src/api/faq.ts
内容:
  - bulkUploadCsv() メソッド追加
  - multipart/form-data 対応
  - エラーハンドリング

■ タスク2.4: 型定義追加
ファイル: frontend/src/types/faq.ts
内容:
  - BulkUploadResponse
  - BulkUploadError
  - BulkUploadWarning

■ タスク2.5: CSVテンプレートダウンロード機能
ファイル: frontend/src/components/admin/FaqBulkUploadModal.vue
内容:
  - テンプレートCSVのダウンロードボタン
  - サンプルデータ埋め込み

推定工数: 12時間（1.5営業日）

---

【Phase 3: エラーハンドリング・ログ機能】（優先度: 中）

■ タスク3.1: 詳細エラーログ生成
ファイル: backend/app/services/faq_service.py
内容:
  - 行単位のエラー情報記録
  - エラーサマリー生成

■ タスク3.2: エラーログダウンロード機能
ファイル: frontend/src/components/admin/FaqBulkUploadModal.vue
内容:
  - エラーログをCSV形式でダウンロード
  - 失敗行のハイライト表示

■ タスク3.3: アクティビティログ記録
ファイル: backend/app/api/v1/admin/faqs.py
内容:
  - AdminActivityLog への記録
  - アップロード履歴の保存

推定工数: 6時間（0.75営業日）

---

【Phase 4: ドキュメント・テスト】（優先度: 中）

■ タスク4.1: ユーザーマニュアル作成
ファイル: docs/faq_csv_bulk_upload_manual.md（新規）
内容:
  - CSV仕様書
  - 操作手順
  - トラブルシューティング

■ タスク4.2: API仕様書更新
ファイル: README.md または docs/api_specification.md
内容:
  - エンドポイント仕様
  - リクエスト/レスポンス例

■ タスク4.3: E2Eテスト実装
ファイル: backend/tests/test_e2e_faq_bulk_upload.py（新規）
内容:
  - 実際のCSVファイルでの動作確認
  - ブラウザテスト（Playwright等）

推定工数: 8時間（1営業日）

---

【Phase 5: 本番デプロイ準備】（優先度: 低）

■ タスク5.1: マイグレーション実行（必要に応じて）
内容:
  - faq_limit の修正（Premium=NULL）
  - 既存データの整合性確認

■ タスク5.2: ステージング環境テスト
内容:
  - 実データでの動作確認
  - パフォーマンステスト（大量データ）

■ タスク5.3: 本番環境デプロイ
内容:
  - Docker イメージビルド
  - デプロイ手順確認

推定工数: 6時間（0.75営業日）

---

【総推定工数】
合計: 48時間（6営業日、1人月の約30%）

【推奨実装順序】
1. Phase 1（バックエンドAPI）
2. Phase 2（フロントエンドUI）
3. Phase 3（エラーハンドリング）
4. Phase 4（ドキュメント・テスト）
5. Phase 5（本番デプロイ）

================================================================================
6. データ構造・CSV仕様
================================================================================

【6.1 CSVカラム定義】

■ 必須カラム
┌────────────────────────┬──────────┬────────┬───────────────────────┐
│ カラム名               │ データ型 │ 必須   │ 説明                  │
├────────────────────────┼──────────┼────────┼───────────────────────┤
│ category               │ string   │ ✓      │ basic/facilities/     │
│                        │          │        │ location/trouble      │
├────────────────────────┼──────────┼────────┼───────────────────────┤
│ language_ja_question   │ string   │ ✓      │ 日本語の質問文        │
│                        │          │        │ （1-500文字）         │
├────────────────────────┼──────────┼────────┼───────────────────────┤
│ language_ja_answer     │ string   │ ✓      │ 日本語の回答文        │
│                        │          │        │ （1-2000文字）        │
└────────────────────────┴──────────┴────────┴───────────────────────┘

■ オプションカラム
┌────────────────────────┬──────────┬────────┬───────────────────────┐
│ カラム名               │ データ型 │ 必須   │ 説明                  │
├────────────────────────┼──────────┼────────┼───────────────────────┤
│ intent_key             │ string   │        │ インテント識別キー    │
│                        │          │        │ （自動生成可）        │
├────────────────────────┼──────────┼────────┼───────────────────────┤
│ priority               │ integer  │        │ 優先度（1-5）         │
│                        │          │        │ デフォルト: 3         │
├────────────────────────┼──────────┼────────┼───────────────────────┤
│ is_active              │ boolean  │        │ 有効/無効             │
│                        │          │        │ デフォルト: true      │
├────────────────────────┼──────────┼────────┼───────────────────────┤
│ language_en_question   │ string   │        │ 英語の質問文          │
├────────────────────────┼──────────┼────────┼───────────────────────┤
│ language_en_answer     │ string   │        │ 英語の回答文          │
├────────────────────────┼──────────┼────────┼───────────────────────┤
│ language_zh-TW_question│ string   │        │ 繁体中国語の質問文    │
├────────────────────────┼──────────┼────────┼───────────────────────┤
│ language_zh-TW_answer  │ string   │        │ 繁体中国語の回答文    │
├────────────────────────┼──────────┼────────┼───────────────────────┤
│ language_fr_question   │ string   │        │ フランス語の質問文    │
├────────────────────────┼──────────┼────────┼───────────────────────┤
│ language_fr_answer     │ string   │        │ フランス語の回答文    │
├────────────────────────┼──────────┼────────┼───────────────────────┤
│ language_ko_question   │ string   │        │ 韓国語の質問文        │
├────────────────────────┼──────────┼────────┼───────────────────────┤
│ language_ko_answer     │ string   │        │ 韓国語の回答文        │
└────────────────────────┴──────────┴────────┴───────────────────────┘

【6.2 CSVテンプレート】

■ 最小構成（日本語のみ）
```csv
category,language_ja_question,language_ja_answer
basic,チェックアウトは何時ですか？,チェックアウトは11時までです。
basic,WiFiパスワードは何ですか？,WiFiパスワードはguest2024です。
facilities,キッチンは使えますか？,キッチンは24時間利用可能です。共有スペースなので譲り合ってご利用ください。
location,最寄り駅はどこですか？,最寄り駅は地下鉄三宮駅で、徒歩5分です。
trouble,鍵を紛失した場合は？,すぐにフロントにご連絡ください。予備の鍵をお渡しします。
```

■ 完全版（多言語対応）
```csv
category,intent_key,priority,is_active,language_ja_question,language_ja_answer,language_en_question,language_en_answer
basic,basic_checkout_time,5,true,チェックアウトは何時ですか？,チェックアウトは11時までです。,What time is check-out?,Check-out is by 11:00 AM.
basic,basic_wifi_password,5,true,WiFiパスワードは何ですか？,WiFiパスワードはguest2024です。SSIDはTokyoGuesthouse_WiFiです。,What is the WiFi password?,The WiFi password is guest2024. The SSID is TokyoGuesthouse_WiFi.
facilities,facilities_kitchen_hours,4,true,キッチンは何時まで使えますか？,キッチンは24時間利用可能です。共有スペースなので譲り合ってご利用ください。,What are the kitchen hours?,The kitchen is available 24/7. Please share the space with other guests.
```

【6.3 intent_key生成ルール】

CSVにintent_keyが指定されていない場合、以下のルールで自動生成：

1. category + "_" + 正規化された質問文
2. 正規化ルール:
   - 小文字に変換
   - 記号除去（ハイフン、アンダースコアは保持）
   - 複数の空白を1つのアンダースコアに変換
   - 前後の空白除去
   - 100文字以内に切り詰め

例:
  質問文: "チェックアウトは何時ですか？"
  → 正規化: "checkout_time"
  → intent_key: "basic_checkout_time"

================================================================================
7. バリデーションルール
================================================================================

【7.1 ファイルレベル】
■ ファイルサイズ
  - 最大10MB
  - 超過時: 400 Bad Request

■ ファイル形式
  - 拡張子: .csv
  - Content-Type: text/csv または application/vnd.ms-excel
  - 不正時: 400 Bad Request

■ 文字コード
  - UTF-8（BOM付きも可）
  - Shift_JIS（自動変換）
  - その他のエンコーディングはエラー

■ 必須カラム
  - category
  - language_ja_question
  - language_ja_answer
  - 欠落時: 400 Bad Request

【7.2 プランレベル】
■ プラン制限
  - Free/Mini/Small: 403 Forbidden
  - Standard: 100件まで
  - Premium: 無制限

■ FAQ登録数上限
  - Standard: 既存FAQ数 + CSV行数 ≤ 100
  - 超過時: 400 Bad Request

【7.3 行レベル】
■ category
  - 許可値: basic, facilities, location, trouble
  - 不正時: スキップ、エラーログに記録

■ intent_key（指定された場合）
  - 最大100文字
  - 英数字、ハイフン、アンダースコアのみ
  - 重複チェック（追加モードのみ）
  - 不正時: スキップ、エラーログに記録

■ priority
  - 範囲: 1-5
  - デフォルト: 3
  - 不正時: デフォルト値を使用

■ is_active
  - 許可値: true, false, 1, 0, yes, no
  - デフォルト: true
  - 不正時: デフォルト値を使用

■ language_*_question
  - 最小1文字、最大500文字
  - 超過時: スキップ、エラーログに記録

■ language_*_answer
  - 最小1文字、最大2000文字
  - 超過時: スキップ、エラーログに記録

■ 言語数制限
  - 既存の言語 + CSVで指定された言語 ≤ プランの言語数上限
  - 超過時: スキップ、エラーログに記録

【7.4 重複チェック】
■ 追加モード
  - 同一facility_id + intent_key が存在する場合: スキップ
  - エラーログに記録

■ 上書きモード
  - 同一facility_id + intent_key が存在する場合: 更新
  - 存在しない場合: 新規追加

================================================================================
8. エラーハンドリング
================================================================================

【8.1 エラー分類】

■ レベル1: ファイルレベルエラー（処理中断）
┌────────────────────────────┬──────────┬───────────────────────┐
│ エラー                     │ HTTPコード│ メッセージ            │
├────────────────────────────┼──────────┼───────────────────────┤
│ ファイルサイズ超過         │ 400      │ ファイルサイズは10MB  │
│                            │          │ 以内にしてください    │
├────────────────────────────┼──────────┼───────────────────────┤
│ CSVフォーマット不正        │ 400      │ CSVファイルの形式が   │
│                            │          │ 不正です              │
├────────────────────────────┼──────────┼───────────────────────┤
│ 必須カラム欠落             │ 400      │ 必須カラムが不足して  │
│                            │          │ います: category,     │
│                            │          │ language_ja_question, │
│                            │          │ language_ja_answer    │
├────────────────────────────┼──────────┼───────────────────────┤
│ プラン制限                 │ 403      │ CSV一括登録はStandard │
│                            │          │ プランまたはPremium   │
│                            │          │ プランでのみ利用可能  │
│                            │          │ です                  │
├────────────────────────────┼──────────┼───────────────────────┤
│ FAQ登録数上限超過          │ 400      │ Standardプランでは    │
│ （Standard）               │          │ 100件までしか登録でき │
│                            │          │ ません。CSVを100件以内│
│                            │          │ に修正するか、Premium │
│                            │          │ プランにアップグレード│
│                            │          │ してください          │
└────────────────────────────┴──────────┴───────────────────────┘

■ レベル2: 行レベルエラー（処理継続、スキップ）
┌────────────────────────────┬───────────────────────────┐
│ エラー                     │ メッセージ                │
├────────────────────────────┼───────────────────────────┤
│ category不正               │ カテゴリが不正です:       │
│                            │ {category}                │
├────────────────────────────┼───────────────────────────┤
│ intent_key重複             │ FAQ with the same         │
│                            │ intent_key already exists │
├────────────────────────────┼───────────────────────────┤
│ 質問文文字数超過           │ 質問文は500文字以内で     │
│                            │ 入力してください          │
├────────────────────────────┼───────────────────────────┤
│ 回答文文字数超過           │ 回答文は2000文字以内で    │
│                            │ 入力してください          │
├────────────────────────────┼───────────────────────────┤
│ 言語数制限超過             │ プランの言語数制限に達して│
│                            │ います（{limit}言語）     │
└────────────────────────────┴───────────────────────────┘

■ レベル3: 警告（処理継続、データ登録）
┌────────────────────────────┬───────────────────────────┐
│ 警告                       │ メッセージ                │
├────────────────────────────┼───────────────────────────┤
│ 埋め込みベクトル生成失敗   │ 埋め込みベクトルの生成に  │
│                            │ 失敗しました（後で再生成  │
│                            │ 可能）                    │
├────────────────────────────┼───────────────────────────┤
│ priority不正値             │ 優先度は1-5の範囲で指定   │
│                            │ してください。デフォルト値│
│                            │ （3）を使用します         │
└────────────────────────────┴───────────────────────────┘

【8.2 エラーログ構造】

```json
{
  "row": 5,
  "intent_key": "basic_wifi_password",
  "reason": "FAQ with the same intent_key already exists",
  "details": "faq_id=456, intent_key=basic_wifi_password",
  "severity": "error",
  "timestamp": "2026-01-27T12:34:56Z"
}
```

【8.3 リトライ戦略】

■ 埋め込みベクトル生成失敗
  - 最大3回リトライ（指数バックオフ: 1秒、2秒、4秒）
  - 失敗時: 警告ログに記録、FAQは登録（embedding=NULL）

■ データベース接続エラー
  - 最大3回リトライ（指数バックオフ）
  - 失敗時: 500 Internal Server Error

【8.4 トランザクション管理】

■ 基本方針
  - 全体をトランザクション内で処理
  - 行レベルエラーが発生してもロールバックしない
  - ファイルレベルエラーが発生したらロールバック

■ コミットタイミング
  - 全行の処理完了後にコミット
  - 部分コミットは行わない（一貫性保証）

================================================================================
9. テスト計画
================================================================================

【9.1 ユニットテスト】

■ CSV解析テスト
  - 正常系: 必須カラムのみ
  - 正常系: オプションカラム含む
  - 異常系: 必須カラム欠落
  - 異常系: 文字コード不正
  - 異常系: カンマ区切り不正

■ バリデーションテスト
  - category バリデーション
  - intent_key バリデーション
  - priority バリデーション
  - is_active バリデーション
  - 質問文・回答文の文字数チェック

■ intent_key生成テスト
  - 正規化ロジック
  - 重複チェック
  - 100文字制限

■ プラン制限テスト
  - Free/Mini/Small: 403 Forbidden
  - Standard: 100件制限
  - Premium: 無制限

■ 言語数制限テスト
  - 既存言語 + 新規言語 ≤ 上限
  - 超過時のスキップ

【9.2 統合テスト】

■ APIエンドポイントテスト
  - 認証: JWT Bearer Token
  - リクエスト: multipart/form-data
  - レスポンス: JSON構造チェック
  - エラーレスポンス: HTTPステータスコード

■ データベーステスト
  - FAQ作成
  - FAQTranslation作成
  - 埋め込みベクトル生成
  - トランザクション整合性

■ キャッシュ無効化テスト
  - FAQ一覧キャッシュの無効化確認

【9.3 E2Eテスト】

■ シナリオ1: 正常系（追加モード）
  1. ログイン（Standardプラン）
  2. FAQ管理画面へ移動
  3. 「CSV一括登録」ボタンクリック
  4. CSVファイル選択（10件）
  5. アップロード実行
  6. 結果サマリー確認（成功10件）
  7. FAQ一覧で登録確認

■ シナリオ2: 正常系（上書きモード）
  1. ログイン（Standardプラン）
  2. FAQ管理画面へ移動
  3. 「CSV一括登録」ボタンクリック
  4. CSVファイル選択（intent_key指定、5件）
  5. 上書きモード選択
  6. アップロード実行
  7. 結果サマリー確認（成功5件）
  8. FAQ一覧で更新確認

■ シナリオ3: 異常系（プラン制限）
  1. ログイン（Freeプラン）
  2. FAQ管理画面へ移動
  3. 「CSV一括登録」ボタンが非表示であることを確認

■ シナリオ4: 異常系（件数超過）
  1. ログイン（Standardプラン）
  2. FAQ管理画面へ移動
  3. 「CSV一括登録」ボタンクリック
  4. CSVファイル選択（150件）
  5. アップロード実行
  6. エラーメッセージ確認（400 Bad Request）

■ シナリオ5: 部分成功
  1. ログイン（Standardプラン）
  2. FAQ管理画面へ移動
  3. 「CSV一括登録」ボタンクリック
  4. CSVファイル選択（20件、うち5件に重複intent_key）
  5. アップロード実行
  6. 結果サマリー確認（成功15件、失敗5件）
  7. エラーログダウンロード
  8. エラー内容確認

【9.4 パフォーマンステスト】

■ 大量データ処理
  - 100件のFAQ登録（Standardプラン上限）
  - 処理時間: 30秒以内目標
  - メモリ使用量: 512MB以内

■ 並行アップロード
  - 複数ユーザーが同時にアップロード
  - データベース整合性確認
  - デッドロック発生確認

【9.5 セキュリティテスト】

■ 認証テスト
  - JWT無しでアクセス → 401 Unauthorized
  - 無効なJWT → 401 Unauthorized
  - 期限切れJWT → 401 Unauthorized

■ ファイルアップロード攻撃
  - 10MB超のファイル → 400 Bad Request
  - 悪意のあるファイル名 → サニタイズ確認
  - CSVインジェクション → 無害化確認

【9.6 テストデータ】

■ CSVサンプルファイル
  - sample_valid_minimal.csv（最小構成、3件）
  - sample_valid_full.csv（完全版、10件）
  - sample_valid_large.csv（大量データ、100件）
  - sample_invalid_missing_columns.csv（必須カラム欠落）
  - sample_invalid_duplicate_intent_key.csv（重複intent_key）
  - sample_invalid_exceeds_limit.csv（150件、Standard超過）

================================================================================
10. リスク・注意事項
================================================================================

【10.1 技術的リスク】

■ リスク1: 大量データ処理時のタイムアウト
発生条件:
  - 100件以上のFAQ登録（Premium）
  - 埋め込みベクトル生成に時間がかかる
対策:
  - 非同期処理の導入（Celery等）
  - プログレスバーでユーザーに待機を促す
  - タイムアウト時間を60秒に延長

■ リスク2: 埋め込みベクトル生成の失敗
発生条件:
  - OpenAI API の制限・障害
  - ネットワーク不安定
対策:
  - リトライ戦略（最大3回、指数バックオフ）
  - 失敗時もFAQは登録（embedding=NULL）
  - 後で再生成できることをユーザーに通知

■ リスク3: CSV文字コードの問題
発生条件:
  - Excel for Mac で保存したCSV（Shift_JIS）
  - Windowsで保存したCSV（BOM付きUTF-8）
対策:
  - chardet で自動検出
  - Shift_JIS → UTF-8 自動変換
  - BOM付きUTF-8 対応

■ リスク4: メモリ不足
発生条件:
  - 大量データ（1000件以上）
  - pandas でCSV全体をメモリに読み込み
対策:
  - チャンク処理（100件ずつ）
  - ストリーミング処理の検討

【10.2 運用リスク】

■ リスク5: FAQ登録数上限の誤解
発生条件:
  - Standardプランで100件以上登録しようとする
  - 既存FAQ数を考慮せずにアップロード
対策:
  - アップロード前に現在のFAQ数を表示
  - 「登録可能残数: XX件」を明示
  - 上限に近い場合は警告メッセージ

■ リスク6: 誤った上書き
発生条件:
  - 上書きモードで誤ったintent_keyを指定
  - 既存FAQが意図せず更新される
対策:
  - 上書きモード選択時に確認ダイアログ
  - 「XX件のFAQが更新されます」と明示
  - Undo機能は提供しない（バックアップ推奨）

■ リスク7: 重複FAQ登録の混乱
発生条件:
  - 追加モードで重複intent_keyをアップロード
  - 一部がスキップされる
対策:
  - 失敗理由を明確に表示
  - 「既に存在するFAQはスキップされました」
  - エラーログで重複行を特定可能に

【10.3 ビジネスリスク】

■ リスク8: 有料サービスの価格設定
発生条件:
  - 開発者依頼時の価格が高すぎる/安すぎる
対策:
  - 市場調査（競合サービスの価格）
  - ベータテストでのフィードバック収集
  - 柔軟な価格改定

■ リスク9: サポート工数の増加
発生条件:
  - CSV形式のトラブルが頻発
  - ユーザーからの問い合わせ増加
対策:
  - 詳細なマニュアル作成
  - FAQテンプレートの提供
  - エラーメッセージの改善

【10.4 注意事項】

■ 注意1: プラン制限の整合性
現状:
  - 実データ: 全プランfaq_limit=20
  - 仕様: Standard=100, Premium=無制限
対応:
  - plan_limits.py の値を優先
  - マイグレーションで修正（別タスク）

■ 注意2: Premiumプランのfaq_limit
現状:
  - 実データ: faq_limit=20（数値）
  - 仕様: faq_limit=NULL（無制限）
対応:
  - マイグレーションで修正（別タスク）
  - CSV一括登録では仕様通りに動作

■ 注意3: 既存のbulk_create_faqs()との統合
現状:
  - bulk_create_faqs() は既に存在
  - FAQRequestのリストを受け取る
対応:
  - CSV解析後、FAQRequestのリストに変換
  - 既存メソッドを活用（重複実装を避ける）

■ 注意4: Docker環境での動作確認
現状:
  - Docker環境が必須（大原則）
対応:
  - すべての修正・テストはDocker環境で実行
  - ローカル環境での直接実行は無効

================================================================================
11. 将来の拡張
================================================================================

【11.1 機能拡張案】

■ Phase 2（6ヶ月後）
  - Excel形式（.xlsx）のアップロード対応
  - CSVテンプレートの自動生成（既存FAQをエクスポート）
  - FAQのバックアップ・リストア機能

■ Phase 3（12ヶ月後）
  - スケジュール登録（特定日時に自動アップロード）
  - Webhook通知（登録完了時にSlack/Emailで通知）
  - バッチ処理（夜間に大量データを処理）

■ Phase 4（18ヶ月後）
  - AI支援（CSVの内容をAIがチェック、改善提案）
  - 多言語翻訳API連携（日本語のみで登録、他言語を自動翻訳）
  - バージョン管理（FAQの変更履歴を追跡）

【11.2 技術的改善案】

■ パフォーマンス最適化
  - 非同期処理（Celery + Redis）
  - ストリーミング処理（大量データ）
  - 並列処理（複数FAQを同時登録）

■ UI/UX改善
  - ドラッグ&ドロップの視覚フィードバック強化
  - リアルタイムプレビュー（アップロード前にCSV内容を表示）
  - プログレスバーの詳細化（「XX件中YY件処理中」）

■ セキュリティ強化
  - ファイルウイルススキャン
  - レート制限（1ユーザーあたり1時間に5回まで）
  - 監査ログの強化

【11.3 ビジネス拡張案】

■ 有料サービスの充実
  - FAQ作成代行サービス
  - 定期メンテナンスプラン
  - SLA保証オプション

■ API提供
  - REST API で外部システムからFAQを登録
  - Webhook で登録完了を通知
  - GraphQL対応

================================================================================
補足資料
================================================================================

【A. 参考URL】
- 要約定義書: yadopera-v03-summary.md
- アーキテクチャ設計書: （要確認）
- plan_limits.py: backend/app/core/plan_limits.py
- faq_service.py: backend/app/services/faq_service.py
- insert_operator_faqs.py: backend/scripts/insert_operator_faqs.py

【B. 関連issue・PR】
- （今後追加）

【C. 開発環境】
- Docker: 必須
- Python: 3.11+
- Node.js: 18+
- PostgreSQL: 15 + pgvector
- Redis: 7.2

【D. デプロイ環境】
- ステージング: Railway Hobby
- 本番: Render.com

【E. 連絡先】
- 開発者: Air
- ブログ: https://air-edison.com
- Twitter: @kbqjp

================================================================================
変更履歴
================================================================================

| バージョン | 日付       | 変更内容                          |
|-----------|-----------|----------------------------------|
| v1.0      | 2026-01-27 | 初版作成                          |

================================================================================
承認
================================================================================

作成者: Claude (AI Assistant)
レビュー者: （要指定）
承認者: （要指定）

承認日: （要指定）

================================================================================
以上
================================================================================
