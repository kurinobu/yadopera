# CSV一括登録 ブラウザテスト結果 説明と評価

**実施日**: 2026年2月11日  
**参照**: README_test_csv.md、開発者管理ページのエラーログ詳細

---

## 1. テスト結果サマリー

| 確認項目 | 結果 | 備考 |
|----------|------|------|
| Standard / Premium で「CSV一括登録」ボタン表示 | ✅ 確認完了 | スクショでボタンが表示されていることを確認 |
| Free / Mini / Small で「CSV一括登録」ボタン表示 | ✅ 確認完了 | 仕様どおり非表示であることを確認したと解釈（※） |
| test_valid_minimal.csv アップロード | ✅ 成功 | FAQ一覧が 23 件等に増加し、登録が反映 |
| test_valid_with_intent_key.csv アップロード | ✅ 成功 | 同様に FAQ 件数が 28 件等に増加 |
| test_valid_bilingual.csv アップロード | ❌ 400 エラー | モーダルに「アップロードに失敗しました」、コンソールに 400 Bad Request |
| test_invalid_missing_columns.csv アップロード | ❌ 400 エラー（想定どおり） | バリデーションエラーとして正しく拒否 |
| test_invalid_bad_category.csv アップロード | ❌ 400 エラー（想定どおり） | バリデーションエラーとして正しく拒否 |

※ Free/Mini/Small の「表示されることを確認完了」は、「ボタンが表示されないことを確認した」と解釈しています。もしボタンが表示されている場合は仕様と逆の挙動です。

---

## 2. エラーログ詳細に基づく説明

### 2.1 test_invalid_missing_columns.csv（必須カラム欠落）

- **エラーコード**: BAD_REQUEST (400)  
- **リクエストパス**: `POST /api/v1/admin/faqs/bulk-upload`  
- **エラーメッセージ**: 「必須カラムが不足しています: language_ja_answer」

**説明**:  
このCSVは `category` と `language_ja_question` のみで、`language_ja_answer` がありません。バックエンドの必須カラムチェック（REQUIRED_COLUMNS）が正しく働き、不足しているカラム名を日本語で返しています。**異常系テストとして期待どおりの動作です。**

---

### 2.2 test_invalid_bad_category.csv（不正なカテゴリ）

- **エラーコード**: BAD_REQUEST (400)  
- **リクエストパス**: `POST /api/v1/admin/faqs/bulk-upload`  
- **エラーメッセージ**: 「行3: カテゴリは basic / facilities / location / trouble のいずれかを指定してください（値: invalid_category）」

**説明**:  
2行目に `invalid_category` が含まれており、3行目（ヘッダーを除いた2行目）でエラーになっています。カテゴリの行単位バリデーションが正しく動作し、不正な値と行番号を明示しています。**異常系テストとして期待どおりの動作です。**

※ CSV上では「invalid_category」は2行目（データ1行目）にあります。行番号は「ヘッダーを1行目としたときのデータ行の番号」で表示しているため、メッセージの「行3」は実装の行番号付け方に依存します。

---

### 2.3 test_valid_bilingual.csv（日英2言語）

- **現象**: アップロード時に 400 Bad Request。モーダルには汎用の「アップロードに失敗しました。しばらく待ってから再度お試しください。」が表示。
- **共有いただいたエラーログ**: 上記2件（必須カラム不足・不正カテゴリ）のため、bilingual 専用のログ内容は不明。

**考えられる要因**（修正は行わず、調査候補として記載）:

1. **BOM（Byte Order Mark）**:  
   テスト用CSVを UTF-8 BOM 付きで保存している場合、1列目のヘッダーが `"\ufeffcategory"` のように読まれ、`category` と一致せず「必須カラムが不足しています: category」となる可能性。  
   ※ test_valid_minimal / test_valid_with_intent_key は同じ BOM でも成功しているため、環境差（ブラウザ送信時の改行やエンコーディングの違い）の影響もあり得る。

2. **列名の前後空白**:  
   ヘッダーに空白が含まれると必須カラムと一致しない可能性。現状のパーサーは `df.columns.str.strip()` のみで、BOM は明示的に除去していない。

3. **その他のバリデーション**:  
   文字数制限（質問 500 文字・回答 2000 文字）や、言語列の有無による制約に引っかかっている可能性。

**評価**:  
正常系として期待しているファイルのため、**要因の切り分けのためには、開発者管理ページで「test_valid_bilingual.csv をアップロードしたとき」のエラーログ（エラーメッセージ全文）を確認する必要があります。** 現時点では「400 が返っている」ことのみ確定しています。

---

## 3. フロントのエラー表示について

- コンソール: `POST .../bulk-upload 400 (Bad Request)` が複数回記録されている。
- モーダル: 「アップロードに失敗しました。しばらく待ってから再度お試しください。」の汎用メッセージのみ。

**評価**:  
400 のときは API の `detail` に「必須カラムが不足しています: …」「行3: カテゴリは…」などの具体的なメッセージが入っています。フロントでは `response.data.detail` を表示する実装になっていれば、その文言がそのままユーザーに表示される想定です。スクショでは汎用メッセージのみなので、**axios のエラーレスポンスから `detail` を正しく取り出してモーダルに表示できているか**を確認すると、UX 改善になります（今回のテスト結果の説明・評価の範囲では「要確認」として記録）。

---

## 4. 総合評価

| 観点 | 評価 |
|------|------|
| **正常系（minimal / with_intent_key）** | アップロード成功し、FAQ 件数が増えていることから、CSV パース〜登録〜一覧更新まで一連の流れは動作している。 |
| **異常系（missing_columns / bad_category）** | 開発者管理ページのエラーログどおり、必須カラム不足・不正カテゴリを適切に検知し、400 と具体的なメッセージで返している。仕様どおり。 |
| **正常系（bilingual）** | 400 が返っており、想定した「成功」にはなっていない。原因特定には、bilingual 専用のエラーログ（エラーメッセージ全文）の確認が必要。 |
| **プラン別ボタン表示** | Standard/Premium で表示・Free/Mini/Small で非表示の確認が取れている（※上記の解釈による）。 |
| **エラーログの有用性** | 開発者管理ページのエラーログにより、必須カラム名・行番号付きカテゴリエラーが追いやすく、調査に有効。 |

**結論**:  
- 正常系 2 ファイルは意図どおり成功。  
- 異常系 2 ファイルは意図どおり 400 で弾かれており、メッセージも適切。  
- test_valid_bilingual.csv のみ、現状の情報では原因を特定できていないため、**bilingual アップロード時のエラーログ詳細（1件分のメッセージ全文）** が分かれば、次の修正・対応案を具体的に提示できます。  
- 指示があるまで修正は行わず、本ドキュメントは「説明と評価」に留めています。

---

## 5. 追記：test_valid_bilingual が今回成功した場合の原因判明のしかた（2026/02/11）

### 5.1 サーバー側の記録で比較できること

- **400 のとき**  
  `bulk_upload_faqs` は `HTTPException(status_code=400, detail=...)` を投げており、`main.py` の `http_exception_handler` で **すべて** の HTTP エラーが `error_logs` に記録されます。  
  - 保存される内容: `error_message = str(exc.detail)`（API が返した `detail` そのもの）  
  - リクエストパス: `/api/v1/admin/faqs/bulk-upload`  
  - 発生時刻も保存されているため、**前回失敗した時刻付近** のレコードを探せます。

- **201 のとき**  
  成功時は HTTPException を投げないため、**エラーログは 1 件も作成されません**。  
  ネットワークタブの `bulk-upload` が 201 Created、その後の `faqs` 取得が 200 であれば、サーバー側の「成功」と対応します。

したがって、「前回のエラー」と「今回の成功」を**サーバーログで直接比較**するというよりは、  
**前回の 400 が 1 件だけ developer のエラーログに残っている**ので、その **エラーメッセージ** を見れば原因が判明します。

### 5.2 前回の test_valid_bilingual 失敗時の原因を特定する手順

共有いただいたエラーログは次の 3 件でした。

- **ID 51 / 52**: 「必須カラムが不足しています: language_ja_answer」  
  → `test_invalid_missing_columns.csv` 用と考えられる。
- **ID 53**: 「行3: カテゴリは basic / facilities / location / trouble のいずれか… (値: invalid_category)」  
  → `test_invalid_bad_category.csv` 用と考えられる。

このため、**test_valid_bilingual.csv をアップロードしたときの 400** は、上記とは**別の 1 件**として記録されている可能性が高いです。

1. **開発者管理ページのエラーログ一覧** を開く。
2. **リクエストパス** が `/api/v1/admin/faqs/bulk-upload` のものに絞る（または日時で 2026/02/11 10:46 前後などに絞る）。
3. **ID 51, 52, 53 以外** で、同じく `bulk-upload` の 400 のレコードを探す。
4. そのレコードの **「エラーメッセージ」** を確認する。  
   → そこに書かれている内容が、**前回 test_valid_bilingual が失敗した理由**（必須カラム名・行番号付きバリデーション・文字数制限など）です。

DB を直接参照できる場合は、次のようなクエリでも確認できます。

```sql
SELECT id, error_message, created_at
FROM error_logs
WHERE request_path = '/api/v1/admin/faqs/bulk-upload'
  AND created_at >= '2026-02-11 10:40:00'
  AND created_at <= '2026-02-11 11:00:00'
ORDER BY created_at;
```

`error_message` が「必須カラムが不足しています: language_ja_answer」でも「行3: カテゴリは…」でもない行が、test_valid_bilingual 用の失敗と考えられます。

### 5.3 「前回は失敗・今回は成功」になりうる要因（推定）

コード上、**同じ test_valid_bilingual.csv の中身**であれば、毎回同じ結果になる想定です。  
「前回 400・今回 201」の差は、**送信したファイルの違い**か**環境の一時的な差**による可能性が高いです。

- **ファイルの違い（最も有力）**
  - **BOM の有無**  
    先頭に BOM があると、検出によっては 1 列目のヘッダーが `\ufeffcategory` のように読まれ、「category」が無いと判定される場合があります。  
    今回、リポジトリの `test_valid_bilingual.csv`（BOM なしの UTF-8）をそのままアップロードして成功しているなら、前回は **BOM 付きや別エンコーディングで保存した別ファイル** を送っていた可能性があります。
  - **ヘッダーや列名の微妙な差**  
    余分なスペース・ typo ・別エンコーディングによる文字化けで、「language_ja_answer」などが必須カラムと一致せず「必須カラムが不足しています: …」になることがあります。
- **送信順・キャッシュ**  
  ブラウザやプロキシのキャッシュで、前回だけ古いファイルが送られた可能性は低いですが、可能性としてはあります。

**結論**:  
- 原因の**確定**には、上記 5.2 の手順で「test_valid_bilingual 用の 1 件」の **エラーメッセージ** を確認するのが確実です。  
- 今回、同じファイルで 201 になっているなら、**今回使ったファイル（リポジトリの test_valid_bilingual.csv）を今後も標準にして再現テストすれば、同様の失敗は起きにくい**と考えられます。
