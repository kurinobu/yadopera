# FAQ言語数制限バリデーション実装完了 引き継ぎ書

**作成日**: 2026年1月17日  
**実装者**: AI Assistant  
**対象課題**: Phase2実装ステップ計画書の残存課題「2. FAQ登録時の言語数制限バリデーション未実装」  
**状態**: ✅ 完了

---

## 1. 実装概要

### 1.1 実装内容

FAQ作成・更新時に、プランの言語数制限をチェックするバリデーションを実装しました。

**実装箇所**:
- バックエンド: `backend/app/services/faq_service.py`
  - `create_faq`メソッドにバリデーション追加
  - `update_faq`メソッドにバリデーション追加
  - `_get_facility_languages`ヘルパー関数を追加
- フロントエンド: `frontend/src/views/admin/FaqManagement.vue`
  - エラーハンドリング改善（言語数制限エラーの識別）
- エラーメッセージ: `backend/app/core/error_messages.py`
  - `LANGUAGE_LIMIT_EXCEEDED`エラーメッセージ追加
- バグ修正: `backend/app/services/auth_service.py`
  - `get_plan_defaults`関数の`language_limit`バグを修正（Mini: 2, Small: 3, Standard: 4）

### 1.2 実装の特徴

- **Premiumプラン（無制限）**: `language_limit = NULL`の場合はバリデーションをスキップ
- **既存言語の使用**: 制限に達していても、既存の言語を使用する場合は許可
- **新しい言語の追加**: 制限に達している場合、新しい言語を追加しようとするとエラー
- **エラーメッセージ**: 日本語で、既存言語リストと制限数を明示

---

## 2. 実装詳細

### 2.1 バリデーションロジック

#### 2.1.1 `create_faq`メソッド

```python
# 施設情報を取得
facility = await self.db.get(Facility, facility_id)

# 言語数制限バリデーション（Premiumプランの場合はスキップ）
if facility.language_limit is not None:
    # 既存の言語リストを取得
    existing_languages = await self._get_facility_languages(facility_id)
    
    # 新規登録される言語を取得
    new_languages = {trans.language for trans in request.translations}
    
    # 既存の言語と新規言語を結合
    all_languages = existing_languages | new_languages
    
    # 言語数制限をチェック
    if len(all_languages) > facility.language_limit:
        # 新規言語のみを抽出（既存言語は許可）
        truly_new_languages = new_languages - existing_languages
        if truly_new_languages:
            raise ValueError(
                f"プランの言語数制限に達しています（{facility.language_limit}言語）。"
                f"既存の言語（{', '.join(sorted(existing_languages))}）を使用するか、"
                f"プランをアップグレードしてください。"
            )
```

#### 2.1.2 `update_faq`メソッド

```python
# 既存の言語リストを取得（更新対象のFAQを除く）
existing_languages = await self._get_facility_languages(facility_id)
# 更新対象のFAQの既存言語を除外
existing_languages = existing_languages - {trans.language for trans in existing_translations.values()}

# 更新時に追加される新しい言語を取得
new_languages = {trans.language for trans in request.translations}

# 既存の言語と新規言語を結合
all_languages = existing_languages | new_languages

# 言語数制限をチェック
if len(all_languages) > facility.language_limit:
    # 新規言語のみを抽出（既存言語は許可）
    truly_new_languages = new_languages - existing_languages
    if truly_new_languages:
        raise ValueError(...)
```

### 2.2 プラン別の言語数制限

| プラン | 言語数制限 | 対応言語 |
|--------|-----------|---------|
| Free | 1 | ja |
| Mini | 2 | ja, en |
| Small | 3 | ja, en, zh-TW |
| Standard | 4 | ja, en, zh-TW, fr |
| Premium | 無制限 | 全言語 |

**注意**: `Facility.language_limit`カラムに保存される値は、上記の言語数制限と一致します。

---

## 3. テスト結果

### 3.1 ユニットテスト

**テストファイル**: `backend/tests/test_faq_service_language_limit.py`

**テストケース**:
1. ✅ 言語制限に達していない場合の新規登録 - 成功
2. ✅ 言語制限に達している場合の新規登録（既存言語を使用） - 成功
3. ✅ 言語制限に達している場合の新規登録（新しい言語を追加） - エラー
4. ✅ Premiumプラン（無制限）の場合の新規登録 - 成功
5. ✅ 言語制限に達していない場合の更新（新しい言語を追加） - 成功
6. ✅ 言語制限に達している場合の更新（既存言語を更新） - 成功
7. ✅ 言語制限に達している場合の更新（新しい言語を追加） - エラー
8. ✅ Premiumプラン（無制限）の場合の更新（新しい言語を追加） - 成功

**結果**: すべてのテストケースが成功

### 3.2 ステージング環境テスト

**テストスクリプト**: `backend/test_faq_language_limit_api.py`

**テスト結果**:
- ✅ Smallプラン（3言語制限）: 新しい言語追加時にエラー表示
- ✅ Standardプラン（4言語制限）: 新しい言語追加時にエラー表示
- ✅ Premiumプラン（無制限）: 新しい言語追加時に成功
- ✅ 既存FAQ更新（既存言語のみ）: 成功
- ✅ 既存FAQ更新（新しい言語追加）: エラー表示

**結果**: 5/5 テストが成功

### 3.3 ブラウザテスト

**テスト手順書**: `docs/20260117_FAQ言語数制限バリデーション_ブラウザテスト手順.md`

**テスト結果**:
- ✅ Freeプラン（1言語制限）: 新しい言語追加時にエラー表示
- ✅ Miniプラン（2言語制限）: 新しい言語追加時にエラー表示

---

## 4. 修正したバグ

### 4.1 `get_plan_defaults`関数の`language_limit`バグ

**問題**: Mini、Small、Standardプランの`language_limit`がすべて1に設定されていた

**修正内容**:
- Miniプラン: `language_limit: 1` → `2`
- Smallプラン: `language_limit: 1` → `3`
- Standardプラン: `language_limit: 1` → `4`

**影響範囲**:
- 新規施設登録時に正しい`language_limit`が設定される
- 既存施設の`language_limit`は手動で修正が必要（ステージング環境では修正済み）

---

## 5. デプロイ状況

### 5.1 コミット情報

**コミットハッシュ**: `2a43c26`  
**ブランチ**: `develop`  
**コミットメッセージ**: `feat: FAQ登録時の言語数制限バリデーション実装`

**変更ファイル**:
- `backend/app/core/error_messages.py`
- `backend/app/services/auth_service.py`
- `backend/app/services/faq_service.py`
- `frontend/src/views/admin/FaqManagement.vue`
- `backend/tests/test_faq_service_language_limit.py`（新規）

### 5.2 ステージング環境

- ✅ デプロイ完了
- ✅ データベース更新完了（20件の施設の`language_limit`を修正）
- ✅ APIテスト完了（5/5 テスト成功）

---

## 6. 使用方法

### 6.1 バリデーション動作

1. **FAQ作成時**:
   - プランの言語数制限をチェック
   - 既存言語を使用する場合は許可
   - 新しい言語を追加する場合のみ制限をチェック

2. **FAQ更新時**:
   - 更新対象のFAQの既存言語を一時的に除外
   - 残りの既存言語と新規言語を結合してチェック
   - 既存言語を更新する場合は許可
   - 新しい言語を追加する場合のみ制限をチェック

3. **Premiumプラン**:
   - `language_limit = NULL`の場合はバリデーションをスキップ
   - 任意の数の言語を追加可能

### 6.2 エラーメッセージ

エラーメッセージの形式：
```
プランの言語数制限に達しています（{language_limit}言語）。
既存の言語（{existing_languages}）を使用するか、プランをアップグレードしてください。
```

例：
- Smallプラン（3言語制限）: 「プランの言語数制限に達しています（3言語）。既存の言語（en, ja, zh-TW）を使用するか、プランをアップグレードしてください。」

---

## 7. 今後の注意事項

### 7.1 既存施設の`language_limit`修正

**問題**: 既存の施設で`language_limit`が正しく設定されていない場合がある

**対応方法**:
1. データベースで直接更新:
   ```sql
   UPDATE facilities 
   SET language_limit = CASE plan_type 
       WHEN 'Mini' THEN 2 
       WHEN 'Small' THEN 3 
       WHEN 'Standard' THEN 4 
       WHEN 'Premium' THEN NULL 
       ELSE 1 
   END 
   WHERE plan_type IN ('Mini', 'Small', 'Standard', 'Premium');
   ```

2. スクリプトで更新:
   ```bash
   export DATABASE_URL="postgresql://..."
   python3 fix_staging_language_limits.py
   ```

### 7.2 新規施設登録

新規施設登録時は、`get_plan_defaults`関数が正しい`language_limit`を設定するため、問題ありません。

### 7.3 プラン変更時の対応

プラン変更時は、`language_limit`も同時に更新する必要があります。現在の実装では、プラン変更時に`language_limit`を自動更新する処理は含まれていません。

**推奨対応**:
- プラン変更APIまたはサービスに、`language_limit`の更新処理を追加することを推奨

---

## 8. 関連ファイル

### 8.1 実装ファイル

- `backend/app/services/faq_service.py`: バリデーション実装
- `backend/app/core/error_messages.py`: エラーメッセージ定義
- `backend/app/services/auth_service.py`: `get_plan_defaults`関数修正
- `frontend/src/views/admin/FaqManagement.vue`: エラーハンドリング

### 8.2 テストファイル

- `backend/tests/test_faq_service_language_limit.py`: ユニットテスト
- `backend/test_faq_language_limit_api.py`: APIテスト（ステージング環境用）

### 8.3 ユーティリティファイル

- `backend/fix_staging_language_limits.py`: ステージング環境の`language_limit`修正スクリプト
- `backend/run_staging_tests.sh`: ステージング環境テスト実行スクリプト

### 8.4 ドキュメント

- `docs/20260117_FAQ登録時言語数制限バリデーション_調査分析_修正ステップ計画.md`: 調査分析・修正ステップ計画
- `docs/20260117_FAQ言語数制限バリデーション_ブラウザテスト手順.md`: ブラウザテスト手順
- `docs/20260117_FAQ言語数制限バリデーション実装完了_引き継ぎ書.md`: 本引き継ぎ書

---

## 9. 完了確認チェックリスト

- [x] バックエンド実装完了（`create_faq`, `update_faq`にバリデーション追加）
- [x] フロントエンド実装完了（エラーハンドリング改善）
- [x] エラーメッセージ追加完了
- [x] バグ修正完了（`get_plan_defaults`関数）
- [x] ユニットテスト実装完了（8テストケース）
- [x] ステージング環境テスト完了（5テストケース）
- [x] ブラウザテスト完了（Free、Miniプラン）
- [x] デプロイ完了（developブランチ）
- [x] ステージング環境データベース更新完了
- [x] 引き継ぎ書作成完了

---

## 10. まとめ

FAQ登録時の言語数制限バリデーションの実装が完了しました。

**実装内容**:
- FAQ作成・更新時にプランの言語数制限をチェック
- Premiumプラン（無制限）の場合はスキップ
- 既存言語を使用する場合は許可、新しい言語を追加する場合のみ制限をチェック
- エラーメッセージを日本語で表示

**テスト結果**:
- ユニットテスト: 8/8 成功
- ステージング環境APIテスト: 5/5 成功
- ブラウザテスト: Free、Miniプランで確認済み

**デプロイ状況**:
- developブランチにコミット・プッシュ完了
- ステージング環境にデプロイ完了
- ステージング環境のデータベース更新完了

**状態**: ✅ 完了

