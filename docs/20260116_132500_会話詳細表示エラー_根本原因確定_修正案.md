# 会話詳細表示エラー - 根本原因確定・修正案

**作成日時**: 2026年1月16日 13:25:00  
**目的**: 会話詳細ページで404エラーが発生する根本原因の確定と修正案  
**状態**: 根本原因確定完了、修正案準備完了

---

## 1. 問題の再確認

### 1.1 報告された問題

- **リクエストURL**: `https://yadopera-backend-staging.onrender.com/api/v1/chat/history/conv_181`
- **ステータスコード**: 404 Not Found
- **サーバーログ**: `Session expired: session_id=conv_181`
- **修正案1の実装**: 管理画面からのアクセス時はセッション有効期限チェックをスキップ（コミット: `ec2d948`）

### 1.2 修正案1実装後の状況

- 修正案1を実装したが、エラーが継続
- `session_id=conv_181`で会話を検索しているが、見つからない

---

## 2. 根本原因の完全分析

### 2.1 リクエストURLの分析

**リクエストURL**: `/api/v1/chat/history/conv_181`

**問題点**:
- `session_id`が`conv_181`となっている
- これは`UnresolvedListCard.vue`から遷移する際に使用される形式（`conv_${escalation.conversation_id}`）
- しかし、実際の`session_id`は`Conversation.session_id`であり、`conv_181`という形式ではない

---

### 2.2 コードフローの確認

#### フロントエンド側

1. **未解決エスカレーションリスト (`UnresolvedListCard.vue`)**:
   ```typescript
   const handleClick = (escalation: UnresolvedEscalation) => {
     router.push({
       name: 'ConversationDetail',
       params: { session_id: `conv_${escalation.conversation_id}` }  // ← 問題: conv_181
     })
   }
   ```

2. **リアルタイムチャット履歴 (`ChatHistoryList.vue`)**:
   ```typescript
   const handleClick = (conversation: ChatHistory) => {
     emit('click', conversation)  // conversation.session_idを使用
   }
   ```

**問題点**: `UnresolvedListCard.vue`で`session_id`を`conv_${escalation.conversation_id}`として生成しているが、実際の`session_id`は`Conversation.session_id`である

---

#### バックエンド側

1. **未解決エスカレーション取得 (`dashboard_service.py`)**:
   ```python
   async def get_unresolved_escalations(self, facility_id: int, limit: int = 10) -> List[UnresolvedEscalation]:
       # 未解決エスカレーションを取得
       escalations_result = await self.db.execute(
           select(Escalation)
           .join(Conversation, Escalation.conversation_id == Conversation.id)
           # ...
       )
       
       unresolved_list: List[UnresolvedEscalation] = []
       for escalation in escalations:
           unresolved_list.append(UnresolvedEscalation(
               id=escalation.id,
               conversation_id=escalation.conversation_id,  # ← conversation_idのみ
               created_at=escalation.created_at,
               message=message
           ))
   ```

2. **UnresolvedEscalationスキーマ (`dashboard.py`)**:
   ```python
   class UnresolvedEscalation(BaseModel):
       id: int
       conversation_id: int  # ← session_idが含まれていない
       created_at: datetime
       message: str
   ```

**問題点**: `UnresolvedEscalation`スキーマに`session_id`が含まれていない

---

### 2.3 根本原因の確定

#### 根本原因1: `UnresolvedEscalation`スキーマに`session_id`が含まれていない

**問題**:
- `get_unresolved_escalations`メソッドで`conversation_id`のみを返している
- `session_id`を取得していない
- フロントエンドで`conv_${escalation.conversation_id}`として生成しているが、これは間違っている

**影響**:
- `conv_181`という`session_id`で会話を検索しても見つからない
- 実際の`session_id`は`test-session-{facility.id}-{i}-{uuid}`のような形式

---

#### 根本原因2: フロントエンドで`session_id`を間違って生成している

**問題**:
- `UnresolvedListCard.vue`で`session_id`を`conv_${escalation.conversation_id}`として生成
- しかし、実際の`session_id`は`Conversation.session_id`であり、`conv_181`という形式ではない

**影響**:
- 404エラーが発生する
- 会話詳細ページに遷移できない

---

## 3. 修正案

### 3.1 修正案1: `UnresolvedEscalation`スキーマに`session_id`を追加（推奨）

**方針**: バックエンドで`session_id`を取得して返すように修正

**実装内容**:

1. **`dashboard.py`を修正**:
   ```python
   class UnresolvedEscalation(BaseModel):
       """未解決エスカレーション"""
       id: int = Field(..., description="エスカレーションID")
       conversation_id: int = Field(..., description="会話ID")
       session_id: str = Field(..., description="セッションID")  # ← 追加
       created_at: datetime = Field(..., description="作成日時")
       message: str = Field(..., description="ゲストメッセージ")
   ```

2. **`dashboard_service.py`を修正**:
   ```python
   async def get_unresolved_escalations(self, facility_id: int, limit: int = 10) -> List[UnresolvedEscalation]:
       # 未解決エスカレーションを取得
       escalations_result = await self.db.execute(
           select(Escalation)
           .join(Conversation, Escalation.conversation_id == Conversation.id)
           .where(
               Conversation.facility_id == facility_id,
               Escalation.resolved_at.is_(None)
           )
           .order_by(Escalation.created_at.desc())
           .limit(limit)
           .options(selectinload(Escalation.conversation).selectinload(Conversation.messages))
       )
       escalations = escalations_result.scalars().all()
       
       unresolved_list: List[UnresolvedEscalation] = []
       for escalation in escalations:
           # ゲストメッセージを取得（最初のユーザーメッセージ）
           message = ""
           if escalation.conversation and escalation.conversation.messages:
               user_messages = [m for m in escalation.conversation.messages if m.role == MessageRole.USER.value]
               if user_messages:
                   message = user_messages[0].content[:200]  # 200文字まで
           
           unresolved_list.append(UnresolvedEscalation(
               id=escalation.id,
               conversation_id=escalation.conversation_id,
               session_id=escalation.conversation.session_id,  # ← 追加
               created_at=escalation.created_at,
               message=message
           ))
       
       return unresolved_list
   ```

3. **`UnresolvedListCard.vue`を修正**:
   ```typescript
   const handleClick = (escalation: UnresolvedEscalation) => {
     router.push({
       name: 'ConversationDetail',
       params: { session_id: escalation.session_id }  // ← 修正: conv_${escalation.conversation_id}から変更
     })
   }
   ```

**メリット**:
- ✅ 正しい`session_id`を使用できる
- ✅ 根本解決
- ✅ 設計原則に準拠

**デメリット**:
- なし

---

### 3.2 修正案2: フロントエンドで`conversation_id`から`session_id`を取得（非推奨）

**方針**: フロントエンドで`conversation_id`から`session_id`を取得するAPIを呼び出す

**デメリット**:
- ⚠️ 追加のAPI呼び出しが必要
- ⚠️ パフォーマンス低下
- ⚠️ 設計原則に反する（バックエンドで必要なデータを返すべき）

---

## 4. 推奨される修正手順

### 4.1 優先順位

1. **最優先**: 修正案1（`UnresolvedEscalation`スキーマに`session_id`を追加）
   - 根本解決
   - 設計原則に準拠

2. **非推奨**: 修正案2（フロントエンドで`conversation_id`から`session_id`を取得）
   - 追加のAPI呼び出しが必要
   - パフォーマンス低下

---

### 4.2 実装手順

1. **修正案1を実装**
   - `backend/app/schemas/dashboard.py`を修正（`session_id`を追加）
   - `backend/app/services/dashboard_service.py`を修正（`session_id`を取得して返す）
   - `frontend/src/types/dashboard.ts`を修正（`session_id`を追加）
   - `frontend/src/components/admin/dashboard/UnresolvedListCard.vue`を修正（`session_id`を使用）
   - コミット・プッシュ

2. **動作確認**
   - 未解決エスカレーションリストから会話詳細ページに遷移
   - 会話履歴が正しく表示されることを確認

---

## 5. 結論

### 5.1 根本原因

**根本原因**: 
1. `UnresolvedEscalation`スキーマに`session_id`が含まれていない
2. フロントエンドで`session_id`を`conv_${escalation.conversation_id}`として間違って生成している

### 5.2 修正案

**最優先**: 修正案1（`UnresolvedEscalation`スキーマに`session_id`を追加）

**期待される結果**: 
- 未解決エスカレーションリストから会話詳細ページに遷移できる
- 正しい`session_id`を使用して会話履歴が表示される

---

**Document Version**: v1.0  
**Author**: Auto (AI Assistant)  
**Last Updated**: 2026年1月16日 13:25:00  
**Status**: 根本原因確定完了、修正案準備完了

