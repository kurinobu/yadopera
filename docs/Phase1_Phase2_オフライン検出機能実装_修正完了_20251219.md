# Phase 1・Phase 2: オフライン検出機能実装 修正完了

**作成日時**: 2025年12月19日 11時02分31秒  
**実施者**: AI Assistant  
**目的**: 修正案1（オフライン検出機能の実装）の修正完了報告  
**状態**: ✅ **修正完了**

---

## 1. 修正内容

### 1.1 修正ファイル

1. **`frontend/src/composables/useOffline.ts`**
   - ✅ 既に存在し、正しく実装されている（修正不要）

2. **`frontend/src/views/guest/Welcome.vue`**
   - ✅ バックアップ作成: `Welcome.vue.bak_20251219_110231`
   - ✅ オフライン検出機能の統合（既に実装済み）
   - ✅ エラーハンドリングの改善（既に実装済み）
   - ✅ `handleMessageSubmit`関数にオフライン時のメッセージ送信ブロックを追加
   - ✅ `handleMessageSubmit`関数のエラーハンドリングを改善

3. **`frontend/src/views/guest/Chat.vue`**
   - ✅ バックアップ作成: `Chat.vue.bak_20251219_110231`
   - ✅ オフライン検出機能の統合（既に実装済み）
   - ✅ エラーハンドリングの改善（既に実装済み）
   - ✅ `handleMessageSubmit`関数にオフライン時のメッセージ送信ブロックを追加
   - ✅ `handleMessageSubmit`関数のエラーハンドリングを改善

---

## 2. 修正詳細

### 2.1 `useOffline.ts`コンポーザブル

**状態**: ✅ **既に存在し、正しく実装されている**

**実装内容**:
```typescript
import { ref, onMounted, onUnmounted } from 'vue'

export function useOffline() {
  const isOffline = ref(!navigator.onLine)

  const updateOnlineStatus = () => {
    isOffline.value = !navigator.onLine
  }

  onMounted(() => {
    window.addEventListener('online', updateOnlineStatus)
    window.addEventListener('offline', updateOnlineStatus)
  })

  onUnmounted(() => {
    window.removeEventListener('online', updateOnlineStatus)
    window.removeEventListener('offline', updateOnlineStatus)
  })

  return {
    isOffline
  }
}
```

**機能**:
- `navigator.onLine`を使用してオフライン状態を検出
- `online`/`offline`イベントをリッスンしてリアルタイムで状態を更新
- コンポーネントで簡単に使用できる

### 2.2 `Welcome.vue`の修正

#### 2.2.1 オフライン検出機能の統合

**状態**: ✅ **既に実装済み**

**実装内容**:
```typescript
import { useOffline } from '@/composables/useOffline'

const { isOffline } = useOffline()
```

#### 2.2.2 エラーハンドリングの改善

**状態**: ✅ **既に実装済み**

**実装内容**:
```typescript
catch (err: any) {
  // オフライン時のエラーメッセージ
  if (isOffline.value || err.code === 'NETWORK_ERROR') {
    error.value = '現在オフラインです。インターネット接続を確認してください。'
  } else if (err.code === 'TIMEOUT_ERROR') {
    error.value = 'リクエストがタイムアウトしました。接続を確認して再度お試しください。'
  } else if (err.code === 'SERVER_ERROR') {
    error.value = 'サーバーエラーが発生しました。しばらくしてから再度お試しください。'
  } else {
    error.value = '施設情報の取得に失敗しました'
  }
  console.error('Facility fetch error:', err)
}
```

#### 2.2.3 `handleMessageSubmit`関数の改善

**修正内容**:
1. オフライン時のメッセージ送信をブロック
2. エラーハンドリングの改善

**修正後のコード**:
```typescript
// メッセージ送信
const handleMessageSubmit = async (message: string) => {
  if (!facility.value) {
    error.value = '施設情報が取得できませんでした'
    return
  }

  // オフライン時のメッセージ送信をブロック
  if (isOffline.value) {
    error.value = '現在オフラインです。メッセージを送信できません。インターネット接続を確認してください。'
    return
  }

  try {
    isSubmitting.value = true
    error.value = null

    // セッションIDを取得または生成
    getOrCreateSessionId()

    // チャット画面に遷移してメッセージを送信
    router.push({
      name: 'Chat',
      params: { facilityId: facilityId.value },
      query: {
        lang: language.value,
        location: location.value,
        message: message
      }
    })
  } catch (err: any) {
    // オフライン時のエラーメッセージ
    if (isOffline.value || err.code === 'NETWORK_ERROR') {
      error.value = '現在オフラインです。インターネット接続を確認してください。'
    } else if (err.code === 'TIMEOUT_ERROR') {
      error.value = 'リクエストがタイムアウトしました。接続を確認して再度お試しください。'
    } else if (err.code === 'SERVER_ERROR') {
      error.value = 'サーバーエラーが発生しました。しばらくしてから再度お試しください。'
    } else {
      error.value = 'メッセージの送信に失敗しました'
    }
    console.error('Message submit error:', err)
  } finally {
    isSubmitting.value = false
  }
}
```

### 2.3 `Chat.vue`の修正

#### 2.3.1 オフライン検出機能の統合

**状態**: ✅ **既に実装済み**

**実装内容**:
```typescript
import { useOffline } from '@/composables/useOffline'

const { isOffline } = useOffline()
```

#### 2.3.2 エラーハンドリングの改善

**状態**: ✅ **既に実装済み**

**実装内容**:
```typescript
catch (err: any) {
  // オフライン時のエラーメッセージ
  if (isOffline.value || err.code === 'NETWORK_ERROR') {
    error.value = '現在オフラインです。インターネット接続を確認してください。'
  } else if (err.code === 'TIMEOUT_ERROR') {
    error.value = 'リクエストがタイムアウトしました。接続を確認して再度お試しください。'
  } else if (err.code === 'SERVER_ERROR') {
    error.value = 'サーバーエラーが発生しました。しばらくしてから再度お試しください。'
  } else {
    error.value = '施設情報の取得に失敗しました'
  }
  console.error('[Chat.vue] onMounted: 施設情報取得エラー', err)
  return
}
```

#### 2.3.3 `handleMessageSubmit`関数の改善

**修正内容**:
1. オフライン時のメッセージ送信をブロック
2. エラーハンドリングの改善

**修正後のコード**:
```typescript
// メッセージ送信
const handleMessageSubmit = async (message: string) => {
  console.log('[Chat.vue] handleMessageSubmit: 開始', {
    message,
    facilityId: facilityId.value,
    messagesCountBefore: messages.value.length,
    messagesBefore: messages.value
  })
  
  if (!facilityId.value || !message.trim()) {
    console.warn('[Chat.vue] handleMessageSubmit: バリデーションエラー', {
      facilityId: facilityId.value,
      message: message.trim()
    })
    return
  }

  // オフライン時のメッセージ送信をブロック
  if (isOffline.value) {
    error.value = '現在オフラインです。メッセージを送信できません。インターネット接続を確認してください。'
    console.warn('[Chat.vue] handleMessageSubmit: オフライン状態のため送信をブロック')
    return
  }

  try {
    error.value = null

    // ... 既存のコード ...

  } catch (err: any) {
    console.error('[Chat.vue] handleMessageSubmit: エラー', err, {
      messagesCount: messages.value.length,
      messages: messages.value
    })
    
    // オフライン時のエラーメッセージ
    if (isOffline.value || err.code === 'NETWORK_ERROR') {
      error.value = '現在オフラインです。インターネット接続を確認してください。'
    } else if (err.code === 'TIMEOUT_ERROR') {
      error.value = 'リクエストがタイムアウトしました。接続を確認して再度お試しください。'
    } else if (err.code === 'SERVER_ERROR') {
      error.value = 'サーバーエラーが発生しました。しばらくしてから再度お試しください。'
    } else {
      error.value = err.message || 'メッセージの送信に失敗しました'
    }
  }
}
```

---

## 3. 修正の効果

### 3.1 期待される効果

1. **オフライン時の適切なメッセージ表示**
   - オフライン時に「現在オフラインです。インターネット接続を確認してください。」と表示される
   - ユーザーがオフライン状態であることを理解できる

2. **ネットワークエラー時の適切なメッセージ表示**
   - ネットワークエラー時に「現在オフラインです。インターネット接続を確認してください。」と表示される
   - 汎用的なエラーメッセージではなく、具体的なメッセージが表示される

3. **サーバーエラー時の適切なメッセージ表示**
   - サーバーエラー時に「サーバーエラーが発生しました。しばらくしてから再度お試しください。」と表示される
   - エラーの種類に応じた適切なメッセージが表示される

4. **オフライン時のメッセージ送信ブロック**
   - オフライン時にメッセージ送信をブロックする
   - ユーザーに適切なエラーメッセージを表示する

5. **ユーザー体験の向上**
   - オフライン状態であることがユーザーに伝わる
   - 適切なエラーメッセージにより、ユーザーが次のアクションを理解できる

### 3.2 大原則への準拠

**根本解決 > 暫定解決**: ✅ **準拠**
- オフライン検出機能の実装により、根本的に解決する
- 一時的な回避策ではなく、根本的な解決

**シンプル構造 > 複雑構造**: ✅ **準拠**
- `useOffline.ts`コンポーザブルの実装はシンプル
- 既存のエラーハンドリングを活用する

**統一・同一化 > 特殊独自**: ✅ **準拠**
- 既存のエラーハンドリングパターンと統一
- 特殊な実装は不要

**具体的 > 一般**: ✅ **準拠**
- 具体的なエラーメッセージ（オフライン時、ネットワークエラー時、サーバーエラー時）を表示
- 抽象的な実装は不要

**安全は確保しながら拙速**: ✅ **準拠**
- 既存のエラーハンドリングを活用することで、安全性を確保
- シンプルな実装により、迅速に進める

---

## 4. バックアップファイル

### 4.1 バックアップファイル一覧

1. **`frontend/src/views/guest/Welcome.vue.bak_20251219_110231`**
   - 修正前の`Welcome.vue`のバックアップ

2. **`frontend/src/views/guest/Chat.vue.bak_20251219_110231`**
   - 修正前の`Chat.vue`のバックアップ

---

## 5. リンターエラー

**リンターエラー**: ✅ **エラーなし**

**確認ファイル**:
- `frontend/src/views/guest/Welcome.vue`
- `frontend/src/views/guest/Chat.vue`
- `frontend/src/composables/useOffline.ts`

---

## 6. 次のステップ

### 6.1 動作確認

**確認項目**:
1. オフライン時の適切なメッセージ表示
2. ネットワークエラー時の適切なメッセージ表示
3. サーバーエラー時の適切なメッセージ表示
4. オフライン時のメッセージ送信ブロック
5. オンライン復帰時の動作

**確認方法**:
1. プレビューサーバー（`localhost:4173`）で動作確認
2. 開発者ツールのNetworkタブで「Offline」にチェックを入れる
3. 各画面でオフライン時の動作を確認

### 6.2 ステージング環境での確認（推奨）

**確認項目**:
1. ステージング環境でのオフライン動作確認
2. 実際のデバイスでの動作確認

**確認方法**:
1. 変更をコミット・プッシュ
2. Render.comでのデプロイを待つ
3. ステージング環境（`https://yadopera-frontend-staging.onrender.com/`）で動作確認

---

## 7. まとめ

### 7.1 修正完了

**修正案1（オフライン検出機能の実装）**: ✅ **修正完了**

**修正内容**:
1. ✅ `useOffline.ts`コンポーザブルの実装（既に存在）
2. ✅ `Welcome.vue`でのオフライン検出機能の統合（既に実装済み）
3. ✅ `Chat.vue`でのオフライン検出機能の統合（既に実装済み）
4. ✅ エラーメッセージの改善（オフライン時、ネットワークエラー時、サーバーエラー時の区別）
5. ✅ オフライン時のメッセージ送信ブロック（追加実装）

### 7.2 期待される効果

- オフライン時に適切なメッセージが表示される
- ネットワークエラー時に適切なメッセージが表示される
- サーバーエラー時に適切なメッセージが表示される
- ユーザーがオフライン状態であることを理解できる
- ユーザー体験が向上する

### 7.3 大原則への準拠

**すべての大原則に準拠**: ✅

---

**修正完了日時**: 2025年12月19日 11時02分31秒  
**状態**: ✅ **修正完了**

