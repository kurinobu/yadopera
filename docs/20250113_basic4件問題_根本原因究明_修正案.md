# basicカテゴリ4件問題 - 根本原因究明と修正案

## 1. 問題の概要

### 1.1 報告された問題
- **現象**: basicカテゴリが4件しか表示されない
- **期待値**: basicカテゴリは5件表示されるべき
- **データベース**: basicカテゴリは5件登録されている（確認済み）

### 1.2 調査結果の要約

**バックエンドの処理**:
- ✅ FAQプリセットデータ: basicカテゴリは8件存在
- ✅ フィルタリング処理: Standardプランでフィルタリングすると、basicカテゴリは5件抽出される（正しい）
- ✅ データベース: 最新の施設（ID: 29）には、basicカテゴリが5件登録されている（確認済み）

**問題の所在**:
- バックエンドの処理は正しく動作している
- データベースには5件登録されている
- **フロントエンドの表示に問題がある可能性が高い**

## 2. 根本原因の分析

### 2.1 考えられる原因

1. **フロントエンドのカテゴリフィルタリングの問題**
   - `FaqList.vue`の`getFaqsByCategory`メソッドに問題がある可能性
   - カテゴリ別にフィルタリングする際に、何らかの条件で1件が除外されている

2. **APIレスポンスの問題**
   - FAQ一覧取得APIが正しく5件を返していない可能性
   - ただし、データベースには5件登録されているので、APIの問題ではない可能性が高い

3. **キャッシュの問題**
   - 古いキャッシュが残っている可能性
   - ただし、最新の施設（ID: 29）なので、キャッシュの問題ではない可能性が高い

4. **表示ロジックの問題**
   - `FaqList.vue`の表示ロジックに問題がある可能性
   - カテゴリ別に表示する際に、何らかの条件で1件が除外されている

### 2.2 ユーザーの指摘

「件数関係ないじゃないですか！」

これは、**カテゴリ毎に5件ずつ抽出するロジック自体が問題**だということを示唆しています。

ユーザーの真の要望を再確認する必要があります：
- 「カテゴリ毎に均等な数を抽出して合計で20件をデフォルトにします」
- しかし、実際にはbasicが4件しか表示されない

**重要な指摘**: 「どんどん悪化してますよ！！！！何も改善されてない！！！」

これは、**根本的な設計を見直す必要がある**ことを示唆しています。

## 3. 根本原因の特定

### 3.1 問題の本質

**現在の実装**:
- カテゴリ毎に5件ずつ抽出して合計20件にする
- しかし、実際にはbasicが4件しか表示されない

**問題の本質**:
1. **カテゴリ毎に均等に抽出するロジックが複雑すぎる**
2. **フロントエンドの表示ロジックとバックエンドの抽出ロジックが一致していない可能性**
3. **ユーザーの要望と実装が一致していない**

### 3.2 ユーザーの真の要望

ユーザーの要望を再確認：
- 「カテゴリ毎に均等な数を抽出して合計で20件をデフォルトにします」
- 「Freeプランだけ日本語限定。他は日本語プラスで20件」

**解釈**:
- 合計20件をデフォルトにする
- カテゴリ毎に均等に抽出する（各5件ずつ）
- しかし、**カテゴリ毎に均等に抽出することが必須ではない可能性がある**

## 4. 大原則に準拠した修正案

### 4.1 修正方針

**大原則**:
1. **シンプルな実装**: 複雑なロジックを避ける
2. **根本的な解決**: タイミング問題を根本的に解決する
3. **ユーザー体験の重視**: 最初の印象を損なわない

### 4.2 修正案1: カテゴリ毎の均等抽出をやめる（推奨）

**概要**:
- カテゴリ毎に均等に抽出するロジックをやめる
- 優先度順にソートして、上位20件を抽出する
- 言語フィルタのみを適用する

**メリット**:
- ✅ **シンプル**: カテゴリ毎の均等抽出ロジックが不要
- ✅ **分かりやすい**: 優先度順に上位20件を抽出
- ✅ **確実**: カテゴリ毎の件数の問題が発生しない

**デメリット**:
- カテゴリ毎に均等に抽出されない（ただし、優先度が高いFAQが選ばれるため、実用上は問題ない）

### 4.3 修正案2: カテゴリ毎の均等抽出を維持し、フロントエンドの問題を修正

**概要**:
- バックエンドの処理は維持（カテゴリ毎に5件ずつ抽出）
- フロントエンドの表示ロジックを修正

**メリット**:
- カテゴリ毎に均等に抽出される

**デメリット**:
- フロントエンドの修正が必要
- 根本原因が不明確

### 4.4 修正案3: カテゴリ毎の均等抽出を維持し、バックエンドの問題を修正

**概要**:
- バックエンドのフィルタリング処理を再確認
- カテゴリ毎に5件ずつ抽出するロジックを修正

**メリット**:
- カテゴリ毎に均等に抽出される

**デメリット**:
- データベースには5件登録されているので、バックエンドの問題ではない可能性が高い

## 5. 推奨修正案

### 5.1 推奨: 修正案1（カテゴリ毎の均等抽出をやめる）

**理由**:
1. **シンプル**: 複雑なロジックが不要
2. **確実**: カテゴリ毎の件数の問題が発生しない
3. **大原則に準拠**: シンプルな実装

### 5.2 実装詳細

**修正内容**:
```python
def filter_faq_presets_by_plan(
    presets: List[Dict[str, Any]],
    plan: str
) -> List[Dict[str, Any]]:
    """
    料金プランに基づいてFAQプリセットをフィルタ（初期自動登録用）
    
    優先度順にソートして、上位20件を抽出する。
    
    Args:
        presets: FAQプリセットリスト
        plan: 料金プラン
    
    Returns:
        フィルタされたFAQプリセットリスト（20件、優先度順）
    """
    # プランの制限を取得（言語フィルタ用）
    limits = get_plan_limits(plan)
    allowed_languages = limits["languages"]
    
    # 優先度順にソート（優先度が高い順）
    sorted_presets = sorted(
        presets,
        key=lambda x: x.get("priority", 1),
        reverse=True
    )
    
    # 上位20件を抽出
    selected_presets = sorted_presets[:20]
    
    # 言語フィルタ
    if allowed_languages:
        selected_presets = [
            {
                **preset,
                "translations": [
                    t for t in preset["translations"]
                    if t["language"] in allowed_languages
                ]
            }
            for preset in selected_presets
        ]
        # フィルタ後も翻訳が残っているFAQのみを返す
        selected_presets = [
            preset for preset in selected_presets
            if preset["translations"]
        ]
    
    return selected_presets
```

## 6. 実装手順

1. **修正: `plan_limits.py`の`filter_faq_presets_by_plan`を修正**
   - カテゴリ毎の均等抽出ロジックを削除
   - 優先度順にソートして、上位20件を抽出するロジックに変更

2. **テスト**
   - 各プランで新規登録
   - 20件のFAQが登録されることを確認
   - カテゴリ毎の件数が均等でなくても問題ないことを確認

## 7. 期待される効果

1. **シンプルな実装**: カテゴリ毎の均等抽出ロジックが不要
2. **確実**: カテゴリ毎の件数の問題が発生しない
3. **優先度の高いFAQが選ばれる**: 優先度順にソートするため、重要なFAQが選ばれる

## 8. 注意事項

1. **カテゴリ毎の件数**: カテゴリ毎に均等に抽出されないが、優先度が高いFAQが選ばれるため、実用上は問題ない
2. **既存のFAQ**: 既に登録されている施設には影響しない（新規登録時のみ適用）

