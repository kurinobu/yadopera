# 新規登録FAQ問題 統合修正案・ステップ計画

**作成日時**: 2025年1月13日  
**目的**: タイムアウトエラーと料金プラン制限違反を統合的に解決する大原則準拠の修正案  
**対象問題**:
1. ステージング環境タイムアウトエラー（FAQ自動投入処理が30秒を超える）
2. FreeプランのFAQ登録数・言語制限違反（20件・日本語のみの制限が未実装）

---

## 1. 問題の統合分析

### 1.1 問題の関連性

**共通点**:
- 両方とも新規登録時のFAQ自動投入処理に関連
- 現在の実装では料金プランを考慮せず、全プランで同じ処理を実行
- FAQ自動投入処理が同期的に実行され、embedding生成に時間がかかる

**相違点**:
- タイムアウトエラー: 処理時間の問題（60件のembedding生成）
- 料金プラン制限違反: 仕様違反の問題（Freeプランで30件・2言語登録）

### 1.2 根本原因の統合分析

**主原因**:
1. FAQ自動投入処理が同期的に実行されている
2. 料金プランに基づく制限チェックが実装されていない
3. フロントエンドのタイムアウト設定が短すぎる（30秒）

**副次的原因**:
- 料金プラン制限の定義ファイルが存在しない
- FAQ自動投入処理が料金プランを考慮していない

---

## 2. 大原則に基づく修正方針

### 2.1 大原則の確認

要約定義書（v0.3.9）より、以下の大原則を遵守：

1. **根本解決 > 暫定解決**
   - タイムアウトエラー: FAQ自動投入を非同期処理に変更（根本解決）
   - 料金プラン制限: プラン別制限を実装（根本解決）

2. **シンプル構造 > 複雑構造**
   - 料金プラン制限を定数として定義（シンプル）
   - BackgroundTasksを使用（FastAPI標準機能）

3. **統一・同一化 > 特殊独自**
   - 既存のパターンに従い、統一された実装
   - 標準的なアプローチを採用

4. **具体的 > 一般**
   - 具体的な実装方法と手順を明確化
   - 実行可能な具体的な内容を記載

5. **拙速 < 安全確実**
   - テストを省略せず、十分な検証を実施
   - Docker環境でテスト

6. **Docker環境必須 > ローカル直接実行**
   - すべての修正・テストはDocker環境で実行

### 2.2 修正方針の決定

**統合的な修正方針**:
1. **料金プラン制限の定義ファイル作成**（新規）
2. **FAQ自動投入を非同期処理に変更**（根本解決）
3. **料金プランに基づくFAQ件数・言語フィルタ実装**（根本解決）
4. **フロントエンドのタイムアウト時間延長**（暫定対応）

**修正の優先順位**:
1. 料金プラン制限の定義ファイル作成（基盤）
2. FAQ自動投入処理の修正（料金プラン制限適用 + 非同期化）
3. フロントエンドのタイムアウト時間延長（暫定対応）
4. テスト・検証

---

## 3. 修正案詳細（大原則準拠）

### 3.1 ステップ1: 料金プラン制限の定義ファイル作成

**目的**: 料金プラン別のFAQ登録数上限と対応言語リストを定義

**ファイル**: `backend/app/core/plan_limits.py`（新規作成）

**実装内容**:

```python
"""
料金プラン制限定義
各プランのFAQ登録数上限と対応言語リストを定義
"""

from typing import Optional, List, Dict

# 料金プラン別のFAQ登録数上限と対応言語リスト
PLAN_FAQ_LIMITS: Dict[str, Dict[str, Optional[int] | Optional[List[str]]]] = {
    "free": {
        "max_faqs": 20,  # FAQ登録数上限（インテント単位）
        "languages": ["ja"]  # 対応言語リスト（日本語のみ）
    },
    "mini": {
        "max_faqs": 30,
        "languages": ["ja", "en"]  # 日本語＋英語
    },
    "small": {
        "max_faqs": 50,
        "languages": ["ja", "en", "zh-TW"]  # 日本語＋英語＋中国語（繁体字）
    },
    "standard": {
        "max_faqs": 100,
        "languages": ["ja", "en", "zh-TW", "fr"]  # 日本語＋英語＋中国語＋フランス語
    },
    "premium": {
        "max_faqs": None,  # 無制限
        "languages": None  # 無制限（全言語対応）
    }
}


def get_plan_limits(plan: str) -> Dict[str, Optional[int] | Optional[List[str]]]:
    """
    料金プランの制限を取得
    
    Args:
        plan: 料金プラン（"free", "mini", "small", "standard", "premium"）
    
    Returns:
        プラン制限（max_faqs, languages）
    
    Raises:
        ValueError: 無効なプラン名の場合
    """
    if plan not in PLAN_FAQ_LIMITS:
        # デフォルトはsmallプラン
        plan = "small"
    
    return PLAN_FAQ_LIMITS[plan]


def filter_faq_presets_by_plan(
    presets: List[Dict],
    plan: str
) -> List[Dict]:
    """
    料金プランに基づいてFAQプリセットをフィルタ
    
    Args:
        presets: FAQプリセットリスト
        plan: 料金プラン
    
    Returns:
        フィルタされたFAQプリセットリスト
    """
    limits = get_plan_limits(plan)
    max_faqs = limits["max_faqs"]
    allowed_languages = limits["languages"]
    
    # FAQ件数制限
    filtered_presets = presets[:max_faqs] if max_faqs else presets
    
    # 言語フィルタ
    if allowed_languages:
        filtered_presets = [
            {
                **preset,
                "translations": [
                    t for t in preset["translations"]
                    if t["language"] in allowed_languages
                ]
            }
            for preset in filtered_presets
        ]
        # フィルタ後も翻訳が残っているFAQのみを返す
        filtered_presets = [
            preset for preset in filtered_presets
            if preset["translations"]
        ]
    
    return filtered_presets
```

**理由**:
- 料金プラン制限を一元管理（保守性向上）
- 既存コードへの影響を最小化
- テストが容易

---

### 3.2 ステップ2: FAQ自動投入処理の修正（料金プラン制限適用 + 非同期化）

**目的**: 
1. 料金プランに基づくFAQ件数・言語フィルタを適用
2. FAQ自動投入を非同期処理に変更（タイムアウトエラー解消）

**ファイル1**: `backend/app/services/auth_service.py`

**修正内容**:

```python
# 既存のimportに追加
from fastapi import BackgroundTasks
from app.core.plan_limits import filter_faq_presets_by_plan
import logging

logger = logging.getLogger(__name__)

# register_facilityメソッドを分割
@staticmethod
async def register_facility_sync(
    db: AsyncSession,
    request: FacilityRegisterRequest
) -> LoginResponse:
    """
    施設登録処理（同期部分：施設・ユーザー作成のみ）
    
    Args:
        db: データベースセッション
        request: 施設登録リクエスト
    
    Returns:
        ログインレスポンス（JWTトークン含む）
    
    Raises:
        HTTPException: 登録失敗時
    """
    # メールアドレス重複チェック
    result = await db.execute(
        select(User).where(User.email == request.email)
    )
    existing_user = result.scalar_one_or_none()
    if existing_user:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Email already registered"
        )
    
    # 施設作成
    facility = Facility(
        name=request.facility_name,
        slug=await AuthService._generate_unique_slug(db, request.facility_name),
        email=request.email,
        subscription_plan=request.subscription_plan
    )
    db.add(facility)
    await db.flush()  # facility_idを取得
    
    # ユーザー作成
    user = User(
        facility_id=facility.id,
        email=request.email,
        password_hash=hash_password(request.password),
        role="owner",
        full_name=None,
        is_active=True
    )
    db.add(user)
    await db.flush()  # user_idを取得
    
    # コミット（施設・ユーザー作成を確定）
    await db.commit()
    
    # JWTトークン生成
    access_token = create_access_token(
        data={"sub": str(user.id), "email": user.email}
    )
    
    # レスポンス作成
    return LoginResponse(
        access_token=access_token,
        token_type="bearer",
        expires_in=settings.access_token_expire_minutes * 60,
        user=UserResponse(
            id=user.id,
            email=user.email,
            full_name=user.full_name,
            role=user.role,
            facility_id=user.facility_id,
            is_active=user.is_active,
        )
    )

@staticmethod
async def register_facility_async_faqs(
    facility_id: int,
    user_id: int,
    subscription_plan: str
):
    """
    FAQ自動投入処理（バックグラウンド実行）
    
    Args:
        facility_id: 施設ID
        user_id: ユーザーID
        subscription_plan: 料金プラン
    """
    from app.database import AsyncSessionLocal
    from app.data.faq_presets import FAQ_PRESETS
    from app.schemas.faq import FAQRequest
    
    # 新しいデータベースセッションを作成
    async with AsyncSessionLocal() as db:
        try:
        try:
            # 料金プランに基づいてFAQプリセットをフィルタ
            filtered_presets = filter_faq_presets_by_plan(
                FAQ_PRESETS,
                subscription_plan
            )
            
            # プリセットFAQをFAQRequestに変換
            faq_requests = []
            for preset in filtered_presets:
                faq_request = FAQRequest(
                    category=preset["category"],
                    intent_key=preset["intent_key"],
                    translations=[
                        {
                            "language": t["language"],
                            "question": t["question"],
                            "answer": t["answer"]
                        } for t in preset["translations"]
                    ],
                    priority=preset["priority"],
                    is_active=True
                )
                faq_requests.append(faq_request)
            
            # FAQ一括作成
            await FAQService(db).bulk_create_faqs(facility_id, faq_requests, user_id)
            await db.commit()
            
            logger.info(
                f"Background FAQ creation completed: facility_id={facility_id}, "
                f"plan={subscription_plan}, count={len(faq_requests)}"
            )
        except Exception as e:
            logger.error(
                f"Background FAQ creation failed: facility_id={facility_id}, "
                f"plan={subscription_plan}, error={str(e)}",
                exc_info=True
            )
            # エラーが発生してもロールバックは不要（既に施設・ユーザーは作成済み）

@staticmethod
async def register_facility(
    db: AsyncSession,
    request: FacilityRegisterRequest,
    background_tasks: Optional[BackgroundTasks] = None
) -> LoginResponse:
    """
    施設登録処理（FAQ自動投入は非同期で実行）
    
    Args:
        db: データベースセッション
        request: 施設登録リクエスト
        background_tasks: バックグラウンドタスク（オプション）
    
    Returns:
        ログインレスポンス（JWTトークン含む）
    
    Raises:
        HTTPException: 登録失敗時
    """
    # 施設・ユーザー作成（同期処理）
    response = await AuthService.register_facility_sync(db, request)
    
    # FAQ自動投入をバックグラウンドで実行
    if background_tasks:
        background_tasks.add_task(
            AuthService.register_facility_async_faqs,
            response.user.facility_id,
            response.user.id,
            request.subscription_plan
        )
    else:
        # バックグラウンドタスクが利用できない場合は同期的に実行（後方互換性）
        logger.warning(
            "BackgroundTasks not available, running FAQ creation synchronously"
        )
        await AuthService.register_facility_async_faqs(
            response.user.facility_id,
            response.user.id,
            request.subscription_plan
        )
    
    return response
```

**ファイル2**: `backend/app/api/v1/auth.py`

**修正内容**:

```python
# 既存のimportに追加
from fastapi import BackgroundTasks

@router.post("/register", response_model=LoginResponse)
async def register_facility(
    request: FacilityRegisterRequest,
    background_tasks: BackgroundTasks,
    db: AsyncSession = Depends(get_db)
):
    """
    施設登録
    
    - **email**: 施設管理者メールアドレス
    - **password**: パスワード（最小8文字）
    - **facility_name**: 施設名
    - **subscription_plan**: 料金プラン（デフォルト: small）
    
    成功時は施設・ユーザー作成、JWTアクセストークンを返却
    FAQ自動投入はバックグラウンドで実行されます
    """
    try:
        return await AuthService.register_facility(db, request, background_tasks)
    except IntegrityError as e:
        # ... (既存の例外ハンドリング)
```

**理由**:
- 施設・ユーザー作成は即座に完了（2-3秒）
- FAQ自動投入はバックグラウンドで実行（タイムアウトエラー解消）
- 料金プランに基づく制限を適用（仕様違反解消）

---

### 3.3 ステップ3: フロントエンドのタイムアウト時間延長（暫定対応）

**目的**: バックグラウンド処理への移行が完了するまでの暫定対応

**ファイル**: `frontend/src/api/axios.ts`

**修正内容**:

```typescript
// Axiosインスタンス作成
const apiClient: AxiosInstance = axios.create({
  baseURL: `${API_BASE_URL}/api/v1`,
  timeout: 10000, // 10秒（施設・ユーザー作成のみを考慮）
  headers: {
    'Content-Type': 'application/json'
  }
})
```

**理由**:
- 施設・ユーザー作成のみを考慮（FAQ自動投入は非同期化）
- 10秒で十分（余裕を持たせる）
- 根本解決（非同期化）が完了したら、さらに短縮可能

---

## 4. 実装ステップ計画

### ステップ1: 料金プラン制限の定義ファイル作成

**作業内容**:
1. `backend/app/core/plan_limits.py`を新規作成
2. 料金プラン別のFAQ登録数上限と対応言語リストを定義
3. フィルタ関数を実装

**確認項目**:
- [ ] ファイルが正しく作成されている
- [ ] 各プランの制限が正しく定義されている
- [ ] フィルタ関数が正しく動作する

**推定時間**: 30分

---

### ステップ2: FAQ自動投入処理の修正

**作業内容**:
1. `backend/app/services/auth_service.py`を修正
   - `register_facility_sync`メソッドを追加
   - `register_facility_async_faqs`メソッドを追加
   - `register_facility`メソッドを修正
2. `backend/app/api/v1/auth.py`を修正
   - `BackgroundTasks`を追加
   - `register_facility`エンドポイントを修正

**確認項目**:
- [ ] 施設・ユーザー作成が同期的に実行される
- [ ] FAQ自動投入がバックグラウンドで実行される
- [ ] 料金プランに基づく制限が適用される
- [ ] エラーハンドリングが正しく動作する

**推定時間**: 2-3時間

---

### ステップ3: フロントエンドのタイムアウト時間延長

**作業内容**:
1. `frontend/src/api/axios.ts`を修正
2. タイムアウト時間を30秒 → 10秒に変更

**確認項目**:
- [ ] タイムアウト時間が正しく設定されている
- [ ] 新規登録が10秒以内に完了する

**推定時間**: 5分

---

### ステップ4: Docker環境でのテスト

**作業内容**:
1. Docker環境を起動
2. 各プランで新規登録をテスト
3. FAQが正しく作成されることを確認
4. タイムアウトエラーが発生しないことを確認

**テスト項目**:

**Freeプラン**:
- [ ] 新規登録が2-3秒で完了する
- [ ] FAQが20件（日本語のみ）登録される
- [ ] タイムアウトエラーが発生しない

**Miniプラン**:
- [ ] 新規登録が2-3秒で完了する
- [ ] FAQが30件（日本語＋英語）登録される
- [ ] タイムアウトエラーが発生しない

**Smallプラン**:
- [ ] 新規登録が2-3秒で完了する
- [ ] FAQが50件（日本語＋英語＋中国語）登録される
- [ ] タイムアウトエラーが発生しない

**Standardプラン**:
- [ ] 新規登録が2-3秒で完了する
- [ ] FAQが100件（日本語＋英語＋中国語＋フランス語）登録される
- [ ] タイムアウトエラーが発生しない

**Premiumプラン**:
- [ ] 新規登録が2-3秒で完了する
- [ ] FAQが30件（全言語）登録される
- [ ] タイムアウトエラーが発生しない

**推定時間**: 1-2時間

---

### ステップ5: ステージング環境へのデプロイ

**作業内容**:
1. 変更をコミット・プッシュ
2. ステージング環境にデプロイ
3. ステージング環境でテスト

**確認項目**:
- [ ] デプロイが成功する
- [ ] ステージング環境で新規登録が正常に動作する
- [ ] タイムアウトエラーが発生しない
- [ ] 各プランでFAQが正しく作成される

**推定時間**: 30分

---

## 5. リスクと対策

### 5.1 リスク

**リスク1**: バックグラウンドタスクが失敗した場合、FAQが作成されない

**対策**:
- エラーログを記録
- 管理者に通知（将来的に実装）
- 手動でFAQを再作成できる機能を提供

**リスク2**: データベースセッションの管理が複雑になる

**対策**:
- 新しいデータベースセッションを明示的に作成
- エラーハンドリングを適切に実装
- ログを充実させる

**リスク3**: 既存のコードとの互換性

**対策**:
- `background_tasks`をオプション引数として実装
- バックグラウンドタスクが利用できない場合は同期的に実行（後方互換性）

---

## 6. 期待される効果

### 6.1 タイムアウトエラーの解消

- 新規登録が2-3秒で完了（従来: 30秒以上）
- タイムアウトエラーが発生しない
- ユーザー体験の向上

### 6.2 料金プラン制限の遵守

- Freeプラン: 20件（日本語のみ）が正しく登録される
- 各プランで正しい件数・言語が登録される
- 仕様違反が解消される

### 6.3 保守性の向上

- 料金プラン制限を一元管理
- コードの可読性向上
- テストが容易

---

## 7. 結論

### 7.1 修正方針のまとめ

1. **料金プラン制限の定義ファイル作成**（基盤）
2. **FAQ自動投入を非同期処理に変更**（根本解決）
3. **料金プランに基づくFAQ件数・言語フィルタ実装**（根本解決）
4. **フロントエンドのタイムアウト時間延長**（暫定対応）

### 7.2 大原則への準拠

- ✅ **根本解決 > 暫定解決**: FAQ自動投入を非同期化、料金プラン制限を実装
- ✅ **シンプル構造 > 複雑構造**: 料金プラン制限を定数として定義
- ✅ **統一・同一化 > 特殊独自**: FastAPI標準機能（BackgroundTasks）を使用
- ✅ **具体的 > 一般**: 具体的な実装方法と手順を明確化
- ✅ **拙速 < 安全確実**: Docker環境でテスト、十分な検証を実施
- ✅ **Docker環境必須**: すべての修正・テストはDocker環境で実行

### 7.3 参照文書

- 要約定義書v0.3.9（大原則準拠）
- アーキテクチャ設計書v0.3.7
- 引き継ぎ書（2025-12-29）
- ステージング環境タイムアウトエラー完全調査分析報告書
- 料金プランとFAQ自動登録機能調査分析レポート

---

**指示があるまで修正を保留します。修正実施の指示をお待ちしております。**

