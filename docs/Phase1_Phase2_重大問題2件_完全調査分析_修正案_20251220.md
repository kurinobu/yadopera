# Phase 1・Phase 2: 重大問題2件 完全調査分析・修正案

**作成日時**: 2025年12月20日 17:00  
**実施者**: Auto (AI Assistant)  
**対象**: 
1. ダッシュボードでグラフが正常に表示されていない。スコアと異なる
2. テストデータで絶対禁止の「チェックインは何時ですか？」という質問が表示されている  
**状態**: ✅ **完全調査分析完了、修正案提示完了**

---

## 1. 問題の概要

### 1.1 問題1: ダッシュボードグラフが正常に表示されていない

**現象**:
- ダッシュボードのカテゴリ別内訳グラフが正常に表示されていない
- ダッシュボードの数値とFAQ管理ページの数値が異なる

**期待される動作**:
- ダッシュボードのカテゴリ別内訳とFAQ管理ページのカテゴリ別件数が一致する
- グラフが正しく表示される

### 1.2 問題2: チェックイン関連FAQが表示されている

**現象**:
- ゲスト画面で「チェックインの時間は何時ですか？」という質問が表示されている
- これは絶対禁止の質問例である

**期待される動作**:
- チェックイン関連のFAQが一切表示されない
- チェックイン関連のデータがデータベースから完全に削除される

---

## 2. 完全調査分析

### 2.1 問題1: ダッシュボードグラフの根本原因

#### 2.1.1 現在の実装ロジック

**バックエンド**: `backend/app/services/dashboard_service.py`

**現在の実装**:
```python:183:229:backend/app/services/dashboard_service.py
# カテゴリ別内訳（matched_faq_idsからFAQカテゴリを集計）
category_breakdown = CategoryBreakdown()

# 過去7日間のAI応答メッセージを取得（matched_faq_idsがNULLでないもの）
ai_messages_with_faqs_result = await self.db.execute(
    select(Message)
    .where(Message.conversation_id.in_(conversation_ids))
    .where(Message.role == MessageRole.ASSISTANT.value)
    .where(Message.matched_faq_ids.isnot(None))
)
ai_messages_with_faqs = ai_messages_with_faqs_result.scalars().all()

# matched_faq_idsからFAQ IDを収集（重複を排除、空配列を除外）
faq_ids = set()
for msg in ai_messages_with_faqs:
    if msg.matched_faq_ids and len(msg.matched_faq_ids) > 0:
        faq_ids.update(msg.matched_faq_ids)

# FAQを取得してカテゴリを集計
if faq_ids:
    faqs_result = await self.db.execute(
        select(FAQ)
        .where(FAQ.id.in_(list(faq_ids)))
        .where(FAQ.facility_id == facility_id)
        .where(FAQ.is_active == True)
    )
    faqs = faqs_result.scalars().all()
    
    # カテゴリ別に集計（各メッセージの最初のマッチしたFAQのカテゴリをカウント）
    category_counts = {"basic": 0, "facilities": 0, "location": 0, "trouble": 0}
    faq_category_map = {faq.id: faq.category for faq in faqs}
    
    for msg in ai_messages_with_faqs:
        if msg.matched_faq_ids and len(msg.matched_faq_ids) > 0:
            # 最初のマッチしたFAQのカテゴリをカウント
            first_faq_id = msg.matched_faq_ids[0]
            if first_faq_id in faq_category_map:
                category = faq_category_map[first_faq_id]
                if category in category_counts:
                    category_counts[category] += 1
    
    category_breakdown = CategoryBreakdown(
        basic=category_counts["basic"],
        facilities=category_counts["facilities"],
        location=category_counts["location"],
        trouble=category_counts["trouble"]
    )
```

**問題点**:
1. **集計基準の不一致**: ダッシュボードは「過去7日間のメッセージで使用されたFAQのカテゴリを集計」しているが、FAQ管理ページは「全FAQのカテゴリを集計」している
2. **データの不一致**: 過去7日間にメッセージがない場合、カテゴリ別内訳がすべて0になる
3. **ユーザーの混乱**: ダッシュボードとFAQ管理ページで数値が異なるため、ユーザーが混乱する

#### 2.1.2 FAQ管理ページの集計ロジック

**フロントエンド**: `frontend/src/components/admin/FaqList.vue`

**実装**:
```typescript:124:126:frontend/src/components/admin/FaqList.vue
const getFaqsByCategory = (category: FAQCategory): FAQ[] => {
  return filteredFaqs.value.filter(faq => faq.category === category)
}
```

**表示**:
```typescript:30:30:frontend/src/components/admin/FaqList.vue
{{ getCategoryLabel(category) }} ({{ getFaqsByCategory(category).length }}件)
```

**確認結果**:
- FAQ管理ページは「全FAQのカテゴリを集計」している
- `is_active`のフィルタリングは行っていない（表示上は全FAQを表示）

#### 2.1.3 データベースの現状

**調査結果**:
```sql
-- facility_id=1のFAQ数（is_active=true）
SELECT COUNT(*) FILTER (WHERE category = 'basic' AND is_active = true) as basic,
       COUNT(*) FILTER (WHERE category = 'facilities' AND is_active = true) as facilities,
       COUNT(*) FILTER (WHERE category = 'location' AND is_active = true) as location,
       COUNT(*) FILTER (WHERE category = 'trouble' AND is_active = true) as trouble
FROM faqs WHERE facility_id = 1;

-- 結果: basic=0, facilities=0, location=0, trouble=0
```

**確認事項**:
- facility_id=1のFAQが存在しない
- ダッシュボードは過去7日間のメッセージで使用されたFAQのカテゴリを集計しているため、メッセージがない場合はすべて0になる

#### 2.1.4 根本原因の確定

**根本原因**:
1. **集計基準の不一致**: ダッシュボードは「使用頻度」ベース、FAQ管理ページは「存在数」ベース
2. **過去の修正案が未適用**: 過去のドキュメント（`docs/Phase1/Phase1_ダッシュボード重大バグ_完全調査分析_修正案.md`）で「全FAQのカテゴリを集計」に変更する修正案があったが、現在のコードは「使用頻度」ベースのまま

### 2.2 問題2: チェックイン関連FAQの根本原因

#### 2.2.1 データベースの現状

**調査結果**:
```sql
-- チェックイン関連FAQの検索
SELECT id, question, category, is_active, facility_id 
FROM faqs 
WHERE question LIKE '%チェックイン%' 
   OR question LIKE '%check-in%' 
   OR question ILIKE '%checkin%' 
ORDER BY id;

-- 結果:
-- id=17: チェックインの時間は何時ですか？ (facility_id=2, is_active=true)
-- id=18: What time is check-in? (facility_id=2, is_active=true)
-- id=20: チェックインの時間は何時ですか？ (facility_id=2, is_active=true)
```

**確認事項**:
- チェックイン関連のFAQが3件存在している
- これらは`facility_id=2`のデータ
- 現在のユーザーは`facility_id=1`だが、ゲスト画面で表示されているということは、別の施設のデータが表示されているか、または`facility_id=1`のデータにも存在する可能性がある

#### 2.2.2 過去の削除作業の確認

**過去のドキュメント**: `docs/Phase1_Phase2_チェックイン質問例削除_再発防止策強化_20251214.md`

**確認事項**:
- 2025年12月14日にチェックイン関連の質問例を削除する作業が実施された
- しかし、データベースにはまだチェックイン関連のFAQが残っている
- 削除スクリプト（`backend/delete_checkin_data.py`）が実行されていない可能性がある

#### 2.2.3 根本原因の確定

**根本原因**:
1. **過去の削除作業が不完全**: 2025年12月14日の削除作業で、データベースからチェックイン関連のFAQが完全に削除されていない
2. **削除スクリプトの未実行**: `backend/delete_checkin_data.py`が実行されていない可能性がある
3. **複数施設のデータ混在**: `facility_id=2`のデータが残っている

---

## 3. 修正案

### 3.1 問題1: ダッシュボードグラフの修正案

#### 3.1.1 修正方針

**大原則への準拠**:
- **統一・同一化 > 特殊独自**: FAQ管理ページと同じ集計基準（全FAQのカテゴリを集計）に統一する
- **根本解決 > 暫定解決**: 集計基準を根本的に変更する
- **シンプル構造 > 複雑構造**: シンプルな実装（全FAQのカテゴリを集計）

#### 3.1.2 修正内容

**ファイル**: `backend/app/services/dashboard_service.py`

**修正前**:
```python:183:229:backend/app/services/dashboard_service.py
# カテゴリ別内訳（matched_faq_idsからFAQカテゴリを集計）
category_breakdown = CategoryBreakdown()

# 過去7日間のAI応答メッセージを取得（matched_faq_idsがNULLでないもの）
ai_messages_with_faqs_result = await self.db.execute(
    select(Message)
    .where(Message.conversation_id.in_(conversation_ids))
    .where(Message.role == MessageRole.ASSISTANT.value)
    .where(Message.matched_faq_ids.isnot(None))
)
ai_messages_with_faqs = ai_messages_with_faqs_result.scalars().all()

# matched_faq_idsからFAQ IDを収集（重複を排除、空配列を除外）
faq_ids = set()
for msg in ai_messages_with_faqs:
    if msg.matched_faq_ids and len(msg.matched_faq_ids) > 0:
        faq_ids.update(msg.matched_faq_ids)

# FAQを取得してカテゴリを集計
if faq_ids:
    faqs_result = await self.db.execute(
        select(FAQ)
        .where(FAQ.id.in_(list(faq_ids)))
        .where(FAQ.facility_id == facility_id)
        .where(FAQ.is_active == True)
    )
    faqs = faqs_result.scalars().all()
    
    # カテゴリ別に集計（各メッセージの最初のマッチしたFAQのカテゴリをカウント）
    category_counts = {"basic": 0, "facilities": 0, "location": 0, "trouble": 0}
    faq_category_map = {faq.id: faq.category for faq in faqs}
    
    for msg in ai_messages_with_faqs:
        if msg.matched_faq_ids and len(msg.matched_faq_ids) > 0:
            # 最初のマッチしたFAQのカテゴリをカウント
            first_faq_id = msg.matched_faq_ids[0]
            if first_faq_id in faq_category_map:
                category = faq_category_map[first_faq_id]
                if category in category_counts:
                    category_counts[category] += 1
    
    category_breakdown = CategoryBreakdown(
        basic=category_counts["basic"],
        facilities=category_counts["facilities"],
        location=category_counts["location"],
        trouble=category_counts["trouble"]
    )
```

**修正後**:
```python
# カテゴリ別内訳（全FAQのカテゴリを集計、FAQ管理ページと統一）
category_breakdown = CategoryBreakdown()

# 全FAQを取得（is_active=Trueのみ）
faqs_result = await self.db.execute(
    select(FAQ)
    .where(FAQ.facility_id == facility_id)
    .where(FAQ.is_active == True)
)
faqs = faqs_result.scalars().all()

# カテゴリ別に集計（全FAQのカテゴリをカウント）
category_counts = {"basic": 0, "facilities": 0, "location": 0, "trouble": 0}
for faq in faqs:
    if faq.category in category_counts:
        category_counts[faq.category] += 1

category_breakdown = CategoryBreakdown(
    basic=category_counts["basic"],
    facilities=category_counts["facilities"],
    location=category_counts["location"],
    trouble=category_counts["trouble"]
)
```

**変更点**:
- 過去7日間のメッセージで使用されたFAQのカテゴリを集計する処理を削除
- 全FAQのカテゴリを集計する処理に変更（FAQ管理ページと同じ集計基準）
- `is_active=True`のFAQのみを集計

**効果**:
- ✅ ダッシュボードの数値とFAQ管理ページの数値が合致する
- ✅ 集計基準が統一される
- ✅ シンプルな実装

**注意点**:
- この修正により、ダッシュボードは「使用頻度」ではなく「存在数」を表示するようになる
- もし「使用頻度」を表示したい場合は、別の指標として追加する必要がある

#### 3.1.3 フロントエンドの説明文修正

**ファイル**: `frontend/src/components/admin/CategoryChart.vue`

**修正前**:
```typescript:6:8:frontend/src/components/admin/CategoryChart.vue
<p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
  過去7日間のメッセージで使用されたFAQのカテゴリ集計
</p>
```

**修正後**:
```typescript
<p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
  アクティブなFAQのカテゴリ別内訳
</p>
```

### 3.2 問題2: チェックイン関連FAQの修正案

#### 3.2.1 修正方針

**大原則への準拠**:
- **根本解決 > 暫定解決**: データベースからチェックイン関連のFAQを完全に削除する
- **安全第一**: 外部キー制約を考慮した削除順序で実装する
- **再発防止**: 削除後に確認スクリプトを実行して、完全に削除されたことを確認する

#### 3.2.2 修正内容

**ステップ1: チェックイン関連FAQの完全削除**

**削除スクリプトの実行**:
```bash
# 既存の削除スクリプトを実行
cd /Users/kurinobu/projects/yadopera
docker-compose exec backend python3 backend/delete_checkin_data.py
```

**または、直接SQLで削除**:
```sql
-- チェックイン関連FAQの削除（外部キー制約を考慮）
-- 1. 関連するメッセージのmatched_faq_idsからチェックイン関連FAQ IDを削除
-- 2. 関連するFAQ提案を削除
-- 3. チェックイン関連FAQを削除

-- チェックイン関連FAQ IDを取得
WITH checkin_faq_ids AS (
    SELECT id FROM faqs 
    WHERE question LIKE '%チェックイン%' 
       OR question LIKE '%check-in%' 
       OR question ILIKE '%checkin%'
)
-- メッセージのmatched_faq_idsからチェックイン関連FAQ IDを削除
UPDATE messages
SET matched_faq_ids = array_remove(matched_faq_ids, checkin_faq_ids.id)
FROM checkin_faq_ids
WHERE matched_faq_ids @> ARRAY[checkin_faq_ids.id];

-- チェックイン関連FAQを削除
DELETE FROM faqs 
WHERE question LIKE '%チェックイン%' 
   OR question LIKE '%check-in%' 
   OR question ILIKE '%checkin%';
```

**ステップ2: 削除確認**

**確認スクリプト**:
```bash
# チェックイン関連FAQが完全に削除されたことを確認
docker-compose exec -T postgres psql -U yadopera_user -d yadopera -c "
SELECT COUNT(*) as checkin_faq_count 
FROM faqs 
WHERE question LIKE '%チェックイン%' 
   OR question LIKE '%check-in%' 
   OR question ILIKE '%checkin%';
"
```

**期待される結果**: `checkin_faq_count = 0`

#### 3.2.3 再発防止策

**確認項目**:
1. テストデータ作成スクリプトにチェックイン禁止チェックが実装されていることを確認
2. 定期的にチェックイン関連FAQが追加されていないか確認するスクリプトを実行
3. ゲスト画面でチェックイン関連FAQが表示されていないことを確認

---

## 4. 大原則への準拠確認

### 4.1 根本解決 > 暫定解決

**評価**: ✅ **準拠**

**理由**:
- 問題1: 集計基準を根本的に変更（使用頻度ベース → 存在数ベース）
- 問題2: データベースからチェックイン関連FAQを完全に削除

### 4.2 シンプル構造 > 複雑構造

**評価**: ✅ **準拠**

**理由**:
- 問題1: シンプルな実装（全FAQのカテゴリを集計）
- 問題2: 既存の削除スクリプトを活用

### 4.3 統一・同一化 > 特殊独自

**評価**: ✅ **準拠**

**理由**:
- 問題1: FAQ管理ページと同じ集計基準に統一
- 問題2: 既存の削除スクリプトのパターンに従う

### 4.4 安全第一

**評価**: ✅ **準拠**

**理由**:
- 問題2: 外部キー制約を考慮した削除順序で実装
- 削除後に確認スクリプトを実行して、完全に削除されたことを確認

---

## 5. 修正実施手順

### 5.1 問題1: ダッシュボードグラフの修正

1. **バックエンドの修正**:
   - `backend/app/services/dashboard_service.py`の`get_weekly_summary`メソッドを修正
   - カテゴリ別内訳の集計ロジックを「全FAQのカテゴリを集計」に変更

2. **フロントエンドの修正**:
   - `frontend/src/components/admin/CategoryChart.vue`の説明文を修正

3. **動作確認**:
   - ダッシュボードを表示して、カテゴリ別内訳が正しく表示されることを確認
   - FAQ管理ページのカテゴリ別件数と一致することを確認

### 5.2 問題2: チェックイン関連FAQの削除

1. **削除スクリプトの実行**:
   - `backend/delete_checkin_data.py`を実行するか、直接SQLで削除

2. **削除確認**:
   - チェックイン関連FAQが完全に削除されたことを確認

3. **動作確認**:
   - ゲスト画面でチェックイン関連FAQが表示されていないことを確認

---

## 6. まとめ

### 6.1 修正内容

**問題1: ダッシュボードグラフ**:
- 集計基準を「使用頻度」から「存在数」に変更
- FAQ管理ページと同じ集計基準に統一

**問題2: チェックイン関連FAQ**:
- データベースからチェックイン関連FAQを完全に削除
- 削除後に確認スクリプトを実行して、完全に削除されたことを確認

### 6.2 期待される効果

- ✅ ダッシュボードの数値とFAQ管理ページの数値が合致する
- ✅ グラフが正しく表示される
- ✅ チェックイン関連FAQが一切表示されない
- ✅ ユーザーの混乱が解消される

---

**次のステップ**: 修正案の承認後、修正を実施します。

