============================= test session starts ==============================
platform darwin -- Python 3.11.1, pytest-7.4.4, pluggy-1.5.0 -- /Users/kurinobu/.pyenv/versions/3.11.1/bin/python3.11
cachedir: .pytest_cache
metadata: {'Python': '3.11.1', 'Platform': 'macOS-15.5-arm64-arm-64bit', 'Packages': {'pytest': '7.4.4', 'pluggy': '1.5.0'}, 'Plugins': {'asyncio': '0.23.3', 'flask': '1.3.0', 'metadata': '3.1.1', 'cov': '4.1.0', 'html': '4.0.0', 'anyio': '3.7.0'}}
rootdir: /Users/kurinobu/projects/yadopera/backend
configfile: pytest.ini
plugins: asyncio-0.23.3, flask-1.3.0, metadata-3.1.1, cov-4.1.0, html-4.0.0, anyio-3.7.0
asyncio: mode=Mode.AUTO
collecting ... collected 30 items

tests/test_auth.py::TestLogin::test_login_success PASSED                 [  3%]
tests/test_auth.py::TestLogin::test_login_invalid_email FAILED           [  6%]
tests/test_auth.py::TestLogin::test_login_invalid_password FAILED        [ 10%]
tests/test_auth.py::TestLogin::test_login_inactive_user PASSED           [ 13%]
tests/test_auth.py::TestLogin::test_login_validation_error PASSED        [ 16%]
tests/test_auth.py::TestLogout::test_logout_success PASSED               [ 20%]
tests/test_auth.py::TestLogout::test_logout_without_token PASSED         [ 23%]
tests/test_auth.py::TestLogout::test_logout_invalid_token PASSED         [ 26%]
tests/test_integration.py::TestAuthFlow::test_login_and_access_protected_endpoint PASSED [ 30%]
tests/test_integration.py::TestAuthFlow::test_access_protected_endpoint_without_token PASSED [ 33%]
tests/test_integration.py::TestChatFlow::test_chat_message_flow SKIPPED  [ 36%]
tests/test_integration.py::TestChatFlow::test_chat_history_flow PASSED   [ 40%]
tests/test_integration.py::TestAdminFlow::test_dashboard_access PASSED   [ 43%]
tests/test_integration.py::TestAdminFlow::test_faq_list_access PASSED    [ 46%]
tests/test_integration.py::TestAdminFlow::test_faq_create_flow PASSED    [ 50%]
tests/test_integration.py::TestAdminFlow::test_faq_suggestions_access PASSED [ 53%]
tests/test_integration.py::TestAdminFlow::test_overnight_queue_access PASSED [ 56%]
tests/test_integration.py::TestAdminFlow::test_qr_code_generation_access PASSED [ 60%]
tests/test_integration.py::TestErrorHandling::test_invalid_endpoint PASSED [ 63%]
tests/test_integration.py::TestErrorHandling::test_invalid_json PASSED   [ 66%]
tests/test_integration.py::TestErrorHandling::test_unauthorized_access PASSED [ 70%]
tests/test_integration.py::TestResponseTime::test_dashboard_response_time FAILED [ 73%]
tests/test_integration.py::TestResponseTime::test_faq_list_response_time PASSED [ 76%]
tests/test_session_token.py::TestSessionTokenVerify::test_verify_token_success FAILED [ 80%]
tests/test_session_token.py::TestSessionTokenVerify::test_verify_token_invalid PASSED [ 83%]
tests/test_session_token.py::TestSessionTokenVerify::test_verify_token_expired FAILED [ 86%]
tests/test_session_token.py::TestSessionLink::test_link_session_success FAILED [ 90%]
tests/test_session_token.py::TestSessionLink::test_link_session_invalid_token FAILED [ 93%]
tests/test_session_token.py::TestSessionLink::test_link_session_expired_token FAILED [ 96%]
tests/test_session_token.py::TestSessionLink::test_link_session_wrong_facility FAILED [100%]

=================================== FAILURES ===================================
______________________ TestLogin.test_login_invalid_email ______________________
tests/test_auth.py:46: in test_login_invalid_email
    assert "error" in data
E   AssertionError: assert 'error' in {'detail': 'Incorrect email or password'}
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10f857a60>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
____________________ TestLogin.test_login_invalid_password _____________________
tests/test_auth.py:62: in test_login_invalid_password
    assert "error" in data
E   AssertionError: assert 'error' in {'detail': 'Incorrect email or password'}
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10fb31b70>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
________________ TestResponseTime.test_dashboard_response_time _________________
tests/test_integration.py:260: in test_dashboard_response_time
    assert elapsed_time < 3.0, f"Response time {elapsed_time:.2f}s exceeds 3s limit"
E   AssertionError: Response time 3.51s exceeds 3s limit
E   assert 3.5102651119232178 < 3.0
_______________ TestSessionTokenVerify.test_verify_token_success _______________
tests/test_session_token.py:19: in test_verify_token_success
    conversation = Conversation(
<string>:4: in __init__
    ???
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state.py:566: in _initialize_instance
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state.py:564: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/decl_base.py:2142: in _declarative_constructor
    raise TypeError(
E   TypeError: 'language' is an invalid keyword argument for Conversation
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x11c110400>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_______________ TestSessionTokenVerify.test_verify_token_expired _______________
tests/test_session_token.py:61: in test_verify_token_expired
    conversation = Conversation(
<string>:4: in __init__
    ???
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state.py:566: in _initialize_instance
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state.py:564: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/decl_base.py:2142: in _declarative_constructor
    raise TypeError(
E   TypeError: 'language' is an invalid keyword argument for Conversation
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x11c1dd4e0>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
__________________ TestSessionLink.test_link_session_success ___________________
tests/test_session_token.py:94: in test_link_session_success
    primary_conversation = Conversation(
<string>:4: in __init__
    ???
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state.py:566: in _initialize_instance
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state.py:564: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/decl_base.py:2142: in _declarative_constructor
    raise TypeError(
E   TypeError: 'language' is an invalid keyword argument for Conversation
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x11c1dd030>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_______________ TestSessionLink.test_link_session_invalid_token ________________
tests/test_session_token.py:140: in test_link_session_invalid_token
    new_conversation = Conversation(
<string>:4: in __init__
    ???
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state.py:566: in _initialize_instance
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state.py:564: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/decl_base.py:2142: in _declarative_constructor
    raise TypeError(
E   TypeError: 'language' is an invalid keyword argument for Conversation
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x11c1118a0>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_______________ TestSessionLink.test_link_session_expired_token ________________
tests/test_session_token.py:164: in test_link_session_expired_token
    new_conversation = Conversation(
<string>:4: in __init__
    ???
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state.py:566: in _initialize_instance
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state.py:564: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/decl_base.py:2142: in _declarative_constructor
    raise TypeError(
E   TypeError: 'language' is an invalid keyword argument for Conversation
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10fe64c70>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_______________ TestSessionLink.test_link_session_wrong_facility _______________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "idx_facilities_slug"
E   DETAIL:  Key (slug)=(other-hotel) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "idx_facilities_slug"
E   DETAIL:  Key (slug)=(other-hotel) already exists.

The above exception was the direct cause of the following exception:
tests/test_session_token.py:209: in test_link_session_wrong_facility
    await db_session.commit()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:1011: in commit
    await greenlet_spawn(self.sync_session.commit)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:202: in greenlet_spawn
    result = context.switch(value)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1969: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1256: in commit
    self._prepare_impl()
<string>:2: in _prepare_impl
    ???
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1231: in _prepare_impl
    self.session.flush()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4312: in flush
    self._flush(objects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4447: in _flush
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4408: in _flush
    flush_context.execute()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py:1227: in _emit_insert_statements
    result = connection.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2344: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "idx_facilities_slug"
E   DETAIL:  Key (slug)=(other-hotel) already exists.
E   [SQL: INSERT INTO facilities (name, slug, email, phone, address, wifi_ssid, wifi_password, check_in_time, check_out_time, house_rules, local_info, languages, timezone, subscription_plan, monthly_question_limit, is_active) VALUES ($1::VARCHAR, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR, $7::VARCHAR, $8::TIME WITHOUT TIME ZONE, $9::TIME WITHOUT TIME ZONE, $10::VARCHAR, $11::VARCHAR, $12::VARCHAR[], $13::VARCHAR, $14::VARCHAR, $15::INTEGER, $16::BOOLEAN) RETURNING facilities.id, facilities.created_at, facilities.updated_at]
E   [parameters: ('Other Hotel', 'other-hotel', 'other@example.com', None, None, None, None, datetime.time(15, 0), datetime.time(11, 0), None, None, ['en'], 'Asia/Tokyo', 'small', 200, True)]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10fe67b50>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
---------------------------- Captured log teardown -----------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception closing connection <AdaptedConnection <asyncpg.connection.Connection object at 0x11c1dd5d0>>
RuntimeError: Task <Task pending name='Task-210' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.finalizer.<locals>.async_finalizer() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:327> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 379, in _close_connection
    self._dialect.do_close(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 701, in do_close
    dbapi_connection.close()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 883, in close
    self.await_(self._connection.close())
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 649, in close
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/selector_events.py", line 819, in abort
    self._force_close(None)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/selector_events.py", line 870, in _force_close
    self._loop.call_soon(self._call_connection_lost, exc)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 761, in call_soon
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
=============================== warnings summary ===============================
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pydantic/_internal/_config.py:271: 20 warnings
  /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pydantic/_internal/_config.py:271: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/passlib/utils/__init__.py:854
  /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/passlib/utils/__init__.py:854: DeprecationWarning: 'crypt' is deprecated and slated for removal in Python 3.13
    from crypt import crypt as _crypt

tests/test_auth.py::TestLogin::test_login_success
  /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:654: DeprecationWarning: There is no current event loop
    old_loop = asyncio.get_event_loop()

tests/test_auth.py: 5 warnings
tests/test_integration.py: 11 warnings
tests/test_session_token.py: 7 warnings
  /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/_pytest/stash.py:104: RuntimeWarning: coroutine 'Connection._cancel' was never awaited
    del self._storage[key]
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_integration.py::TestAuthFlow::test_login_and_access_protected_endpoint
tests/test_integration.py::TestAdminFlow::test_dashboard_access
tests/test_integration.py::TestResponseTime::test_dashboard_response_time
  /Users/kurinobu/projects/yadopera/backend/app/services/dashboard_service.py:93: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    await set_cache(cache_key_str, dashboard_data.dict(), DASHBOARD_CACHE_TTL)

tests/test_integration.py::TestAuthFlow::test_login_and_access_protected_endpoint
tests/test_integration.py::TestAdminFlow::test_dashboard_access
tests/test_integration.py::TestResponseTime::test_dashboard_response_time
  /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pydantic/main.py:979: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    warnings.warn('The `dict` method is deprecated; use `model_dump` instead.', DeprecationWarning)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_auth.py::TestLogin::test_login_invalid_email - AssertionErr...
FAILED tests/test_auth.py::TestLogin::test_login_invalid_password - Assertion...
FAILED tests/test_integration.py::TestResponseTime::test_dashboard_response_time
FAILED tests/test_session_token.py::TestSessionTokenVerify::test_verify_token_success
FAILED tests/test_session_token.py::TestSessionTokenVerify::test_verify_token_expired
FAILED tests/test_session_token.py::TestSessionLink::test_link_session_success
FAILED tests/test_session_token.py::TestSessionLink::test_link_session_invalid_token
FAILED tests/test_session_token.py::TestSessionLink::test_link_session_expired_token
FAILED tests/test_session_token.py::TestSessionLink::test_link_session_wrong_facility
======= 9 failed, 20 passed, 1 skipped, 51 warnings in 441.76s (0:07:21) =======
