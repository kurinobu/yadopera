============================= test session starts ==============================
platform darwin -- Python 3.11.1, pytest-7.4.4, pluggy-1.5.0 -- /Users/kurinobu/.pyenv/versions/3.11.1/bin/python3.11
cachedir: .pytest_cache
metadata: {'Python': '3.11.1', 'Platform': 'macOS-15.5-arm64-arm-64bit', 'Packages': {'pytest': '7.4.4', 'pluggy': '1.5.0'}, 'Plugins': {'asyncio': '0.23.3', 'flask': '1.3.0', 'metadata': '3.1.1', 'cov': '4.1.0', 'html': '4.0.0', 'anyio': '3.7.0'}}
rootdir: /Users/kurinobu/projects/yadopera/backend
configfile: pytest.ini
plugins: asyncio-0.23.3, flask-1.3.0, metadata-3.1.1, cov-4.1.0, html-4.0.0, anyio-3.7.0
asyncio: mode=Mode.AUTO
collecting ... collected 71 items

tests/test_ai_engine.py::TestRAGEngine::test_process_message_success ERROR [  1%]
tests/test_ai_engine.py::TestRAGEngine::test_process_message_embedding_failure ERROR [  2%]
tests/test_ai_engine.py::TestRAGEngine::test_process_message_facility_not_found ERROR [  4%]
tests/test_ai_engine.py::TestRAGEngine::test_process_message_openai_error ERROR [  5%]
tests/test_auth.py::TestLogin::test_login_success ERROR                  [  7%]
tests/test_auth.py::TestLogin::test_login_invalid_email ERROR            [  8%]
tests/test_auth.py::TestLogin::test_login_invalid_password ERROR         [  9%]
tests/test_auth.py::TestLogin::test_login_inactive_user ERROR            [ 11%]
tests/test_auth.py::TestLogin::test_login_validation_error FAILED        [ 12%]
tests/test_auth.py::TestLogout::test_logout_success ERROR                [ 14%]
tests/test_auth.py::TestLogout::test_logout_without_token ERROR          [ 15%]
tests/test_auth.py::TestLogout::test_logout_invalid_token ERROR          [ 16%]
tests/test_chat_api.py::TestChatAPI::test_send_chat_message SKIPPED      [ 18%]
tests/test_chat_api.py::TestChatAPI::test_get_chat_history ERROR         [ 19%]
tests/test_chat_api.py::TestChatAPI::test_get_chat_history_not_found ERROR [ 21%]
tests/test_chat_service.py::TestChatService::test_process_chat_message_new_conversation ERROR [ 22%]
tests/test_chat_service.py::TestChatService::test_get_conversation_history ERROR [ 23%]
tests/test_chat_service.py::TestChatService::test_get_conversation_history_not_found FAILED [ 25%]
tests/test_confidence.py::TestConfidence::test_base_confidence ERROR     [ 26%]
tests/test_confidence.py::TestConfidence::test_short_response_penalty ERROR [ 28%]
tests/test_confidence.py::TestConfidence::test_uncertain_phrase_penalty ERROR [ 29%]
tests/test_confidence.py::TestConfidence::test_proper_noun_bonus FAILED  [ 30%]
tests/test_confidence.py::TestConfidence::test_number_bonus ERROR        [ 32%]
tests/test_confidence.py::TestConfidence::test_custom_faq_bonus ERROR    [ 33%]
tests/test_confidence.py::TestConfidence::test_confidence_clipping ERROR [ 35%]
tests/test_confidence.py::TestConfidence::test_multiple_penalties FAILED [ 36%]
tests/test_embeddings.py::TestEmbeddings::test_generate_embedding_success PASSED [ 38%]
tests/test_embeddings.py::TestEmbeddings::test_generate_embedding_failure PASSED [ 39%]
tests/test_embeddings.py::TestEmbeddings::test_generate_faq_embedding PASSED [ 40%]
tests/test_embeddings.py::TestEmbeddings::test_generate_faq_embedding_empty PASSED [ 42%]
tests/test_escalation.py::TestEscalation::test_safety_category_escalation ERROR [ 43%]
tests/test_escalation.py::TestEscalation::test_low_confidence_escalation ERROR [ 45%]
tests/test_escalation.py::TestEscalation::test_emergency_keyword_escalation ERROR [ 46%]
tests/test_escalation.py::TestEscalation::test_multiple_turns_escalation ERROR [ 47%]
tests/test_escalation.py::TestEscalation::test_no_escalation_needed ERROR [ 49%]
tests/test_escalation.py::TestEscalation::test_create_escalation ERROR   [ 50%]
tests/test_integration.py::TestAuthFlow::test_login_and_access_protected_endpoint ERROR [ 52%]
tests/test_integration.py::TestAuthFlow::test_access_protected_endpoint_without_token PASSED [ 53%]
tests/test_integration.py::TestChatFlow::test_chat_message_flow SKIPPED  [ 54%]
tests/test_integration.py::TestChatFlow::test_chat_history_flow ERROR    [ 56%]
tests/test_integration.py::TestAdminFlow::test_dashboard_access ERROR    [ 57%]
tests/test_integration.py::TestAdminFlow::test_faq_list_access ERROR     [ 59%]
tests/test_integration.py::TestAdminFlow::test_faq_create_flow ERROR     [ 60%]
tests/test_integration.py::TestAdminFlow::test_faq_suggestions_access ERROR [ 61%]
tests/test_integration.py::TestAdminFlow::test_overnight_queue_access ERROR [ 63%]
tests/test_integration.py::TestAdminFlow::test_qr_code_generation_access ERROR [ 64%]
tests/test_integration.py::TestErrorHandling::test_invalid_endpoint ERROR [ 66%]
tests/test_integration.py::TestErrorHandling::test_invalid_json ERROR    [ 67%]
tests/test_integration.py::TestErrorHandling::test_unauthorized_access PASSED [ 69%]
tests/test_integration.py::TestResponseTime::test_dashboard_response_time ERROR [ 70%]
tests/test_integration.py::TestResponseTime::test_faq_list_response_time ERROR [ 71%]
tests/test_overnight_queue.py::TestOvernightQueue::test_add_to_overnight_queue ERROR [ 73%]
tests/test_overnight_queue.py::TestOvernightQueue::test_get_overnight_queue ERROR [ 74%]
tests/test_overnight_queue.py::TestOvernightQueue::test_send_overnight_auto_reply ERROR [ 76%]
tests/test_safety_check.py::TestSafetyCheck::test_medical_keyword_detection PASSED [ 77%]
tests/test_safety_check.py::TestSafetyCheck::test_safety_keyword_detection FAILED [ 78%]
tests/test_safety_check.py::TestSafetyCheck::test_case_insensitive PASSED [ 80%]
tests/test_safety_check.py::TestSafetyCheck::test_keyword_list_completeness PASSED [ 81%]
tests/test_session_token.py::TestSessionTokenVerify::test_verify_token_success ERROR [ 83%]
tests/test_session_token.py::TestSessionTokenVerify::test_verify_token_invalid ERROR [ 84%]
tests/test_session_token.py::TestSessionTokenVerify::test_verify_token_expired ERROR [ 85%]
tests/test_session_token.py::TestSessionLink::test_link_session_success ERROR [ 87%]
tests/test_session_token.py::TestSessionLink::test_link_session_invalid_token ERROR [ 88%]
tests/test_session_token.py::TestSessionLink::test_link_session_expired_token ERROR [ 90%]
tests/test_session_token.py::TestSessionLink::test_link_session_wrong_facility ERROR [ 91%]
tests/test_vector_search.py::TestVectorSearch::test_search_similar_faqs_empty_embedding ERROR [ 92%]
tests/test_vector_search.py::TestVectorSearch::test_search_similar_faqs_no_db PASSED [ 94%]
tests/test_vector_search.py::TestVectorSearch::test_search_similar_faqs_with_data ERROR [ 95%]
tests/test_vector_search.py::TestVectorSearch::test_search_similar_patterns_empty_embedding ERROR [ 97%]
tests/test_vector_search.py::TestVectorSearch::test_search_similar_patterns_no_db PASSED [ 98%]
tests/test_vector_search.py::TestVectorSearch::test_search_similar_patterns_with_data FAILED [100%]

==================================== ERRORS ====================================
_________ ERROR at setup of TestRAGEngine.test_process_message_success _________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:522: in _prepare_and_execute
    prepared_stmt, attributes = await adapt_connection._prepare(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:773: in _prepare
    prepared_stmt = await self._connection.prepare(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:636: in prepare
    return await self._prepare(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:654: in _prepare
    stmt = await self._get_statement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:433: in _get_statement
    statement = await self._protocol.prepare(
asyncpg/protocol/protocol.pyx:166: in prepare
    ???
E   asyncpg.exceptions.UndefinedTableError: relation "facilities" does not exist

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.ProgrammingError: <class 'asyncpg.exceptions.UndefinedTableError'>: relation "facilities" does not exist

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:360: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:355: in setup
    res = await func(
tests/conftest.py:153: in test_facility
    await db_session.commit()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:1011: in commit
    await greenlet_spawn(self.sync_session.commit)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:202: in greenlet_spawn
    result = context.switch(value)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1969: in commit
    trans.commit(_to_root=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1256: in commit
    self._prepare_impl()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1231: in _prepare_impl
    self.session.flush()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4312: in flush
    self._flush(objects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4447: in _flush
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4408: in _flush
    flush_context.execute()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py:1227: in _emit_insert_statements
    result = connection.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2344: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.exc.ProgrammingError: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedTableError'>: relation "facilities" does not exist
E   [SQL: INSERT INTO facilities (name, slug, email, phone, address, wifi_ssid, wifi_password, check_in_time, check_out_time, house_rules, local_info, languages, timezone, subscription_plan, monthly_question_limit, is_active) VALUES ($1::VARCHAR, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR, $7::VARCHAR, $8::TIME WITHOUT TIME ZONE, $9::TIME WITHOUT TIME ZONE, $10::VARCHAR, $11::VARCHAR, $12::VARCHAR[], $13::VARCHAR, $14::VARCHAR, $15::INTEGER, $16::BOOLEAN) RETURNING facilities.id, facilities.created_at, facilities.updated_at]
E   [parameters: ('Test Hotel', 'test-hotel', 'test@example.com', '090-1234-5678', 'Test Address', None, None, datetime.time(15, 0), datetime.time(11, 0), None, None, ['en'], 'Asia/Tokyo', 'small', 200, True)]
E   (Background on this error at: https://sqlalche.me/e/20/f405)
____ ERROR at setup of TestRAGEngine.test_process_message_embedding_failure ____
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-6' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10e9114e0>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
___ ERROR at setup of TestRAGEngine.test_process_message_facility_not_found ____
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1068: in begin
    yield conn
tests/conftest.py:84: in db_session
    await conn.run_sync(Base.metadata.create_all)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:891: in run_sync
    return await greenlet_spawn(fn, self._proxied, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/schema.py:5832: in create_all
    bind._run_ddl_visitor(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2448: in _run_ddl_visitor
    visitorcallable(self.dialect, self, **kwargs).traverse_single(element)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py:671: in traverse_single
    return meth(obj, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:919: in visit_metadata
    self.traverse_single(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py:671: in traverse_single
    return meth(obj, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:957: in visit_table
    )._invoke_with(self.connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:315: in _invoke_with
    return bind.execute(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:181: in _execute_on_connection
    return connection._execute_ddl(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1528: in _execute_ddl
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2344: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.
E   [SQL: 
E   CREATE TABLE facilities (
E   	id SERIAL NOT NULL, 
E   	name VARCHAR(255) NOT NULL, 
E   	slug VARCHAR(100) NOT NULL, 
E   	email VARCHAR(255) NOT NULL, 
E   	phone VARCHAR(50), 
E   	address TEXT, 
E   	wifi_ssid VARCHAR(100), 
E   	wifi_password VARCHAR(100), 
E   	check_in_time TIME WITHOUT TIME ZONE, 
E   	check_out_time TIME WITHOUT TIME ZONE, 
E   	house_rules TEXT, 
E   	local_info TEXT, 
E   	languages VARCHAR[], 
E   	timezone VARCHAR(50), 
E   	subscription_plan VARCHAR(50), 
E   	monthly_question_limit INTEGER, 
E   	is_active BOOLEAN, 
E   	created_at TIMESTAMP WITH TIME ZONE DEFAULT now(), 
E   	updated_at TIMESTAMP WITH TIME ZONE DEFAULT now(), 
E   	PRIMARY KEY (id)
E   )
E   
E   ]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
______ ERROR at setup of TestRAGEngine.test_process_message_openai_error _______
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-9' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10ea53790>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
________________ ERROR at setup of TestLogin.test_login_success ________________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "ix_facilities_slug"
E   DETAIL:  Key (slug)=(test-hotel) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "ix_facilities_slug"
E   DETAIL:  Key (slug)=(test-hotel) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:360: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:355: in setup
    res = await func(
tests/conftest.py:153: in test_facility
    await db_session.commit()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:1011: in commit
    await greenlet_spawn(self.sync_session.commit)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:202: in greenlet_spawn
    result = context.switch(value)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1969: in commit
    trans.commit(_to_root=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1256: in commit
    self._prepare_impl()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1231: in _prepare_impl
    self.session.flush()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4312: in flush
    self._flush(objects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4447: in _flush
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4408: in _flush
    flush_context.execute()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py:1227: in _emit_insert_statements
    result = connection.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2344: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "ix_facilities_slug"
E   DETAIL:  Key (slug)=(test-hotel) already exists.
E   [SQL: INSERT INTO facilities (name, slug, email, phone, address, wifi_ssid, wifi_password, check_in_time, check_out_time, house_rules, local_info, languages, timezone, subscription_plan, monthly_question_limit, is_active) VALUES ($1::VARCHAR, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR, $7::VARCHAR, $8::TIME WITHOUT TIME ZONE, $9::TIME WITHOUT TIME ZONE, $10::VARCHAR, $11::VARCHAR, $12::VARCHAR[], $13::VARCHAR, $14::VARCHAR, $15::INTEGER, $16::BOOLEAN) RETURNING facilities.id, facilities.created_at, facilities.updated_at]
E   [parameters: ('Test Hotel', 'test-hotel', 'test@example.com', '090-1234-5678', 'Test Address', None, None, datetime.time(15, 0), datetime.time(11, 0), None, None, ['en'], 'Asia/Tokyo', 'small', 200, True)]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
_____________ ERROR at setup of TestLogin.test_login_invalid_email _____________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-24' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10ea527a0>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
___________ ERROR at setup of TestLogin.test_login_invalid_password ____________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1068: in begin
    yield conn
tests/conftest.py:84: in db_session
    await conn.run_sync(Base.metadata.create_all)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:891: in run_sync
    return await greenlet_spawn(fn, self._proxied, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/schema.py:5832: in create_all
    bind._run_ddl_visitor(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2448: in _run_ddl_visitor
    visitorcallable(self.dialect, self, **kwargs).traverse_single(element)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py:671: in traverse_single
    return meth(obj, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:919: in visit_metadata
    self.traverse_single(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py:671: in traverse_single
    return meth(obj, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:957: in visit_table
    )._invoke_with(self.connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:315: in _invoke_with
    return bind.execute(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:181: in _execute_on_connection
    return connection._execute_ddl(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1528: in _execute_ddl
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2344: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.
E   [SQL: 
E   CREATE TABLE facilities (
E   	id SERIAL NOT NULL, 
E   	name VARCHAR(255) NOT NULL, 
E   	slug VARCHAR(100) NOT NULL, 
E   	email VARCHAR(255) NOT NULL, 
E   	phone VARCHAR(50), 
E   	address TEXT, 
E   	wifi_ssid VARCHAR(100), 
E   	wifi_password VARCHAR(100), 
E   	check_in_time TIME WITHOUT TIME ZONE, 
E   	check_out_time TIME WITHOUT TIME ZONE, 
E   	house_rules TEXT, 
E   	local_info TEXT, 
E   	languages VARCHAR[], 
E   	timezone VARCHAR(50), 
E   	subscription_plan VARCHAR(50), 
E   	monthly_question_limit INTEGER, 
E   	is_active BOOLEAN, 
E   	created_at TIMESTAMP WITH TIME ZONE DEFAULT now(), 
E   	updated_at TIMESTAMP WITH TIME ZONE DEFAULT now(), 
E   	PRIMARY KEY (id)
E   )
E   
E   ]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
_____________ ERROR at setup of TestLogin.test_login_inactive_user _____________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-27' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10eae3a60>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_______________ ERROR at setup of TestLogout.test_logout_success _______________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-43' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10eae3b50>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
____________ ERROR at setup of TestLogout.test_logout_without_token ____________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1068: in begin
    yield conn
tests/conftest.py:84: in db_session
    await conn.run_sync(Base.metadata.create_all)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:891: in run_sync
    return await greenlet_spawn(fn, self._proxied, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/schema.py:5832: in create_all
    bind._run_ddl_visitor(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2448: in _run_ddl_visitor
    visitorcallable(self.dialect, self, **kwargs).traverse_single(element)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py:671: in traverse_single
    return meth(obj, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:919: in visit_metadata
    self.traverse_single(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py:671: in traverse_single
    return meth(obj, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:957: in visit_table
    )._invoke_with(self.connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:315: in _invoke_with
    return bind.execute(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:181: in _execute_on_connection
    return connection._execute_ddl(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1528: in _execute_ddl
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2344: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.
E   [SQL: 
E   CREATE TABLE facilities (
E   	id SERIAL NOT NULL, 
E   	name VARCHAR(255) NOT NULL, 
E   	slug VARCHAR(100) NOT NULL, 
E   	email VARCHAR(255) NOT NULL, 
E   	phone VARCHAR(50), 
E   	address TEXT, 
E   	wifi_ssid VARCHAR(100), 
E   	wifi_password VARCHAR(100), 
E   	check_in_time TIME WITHOUT TIME ZONE, 
E   	check_out_time TIME WITHOUT TIME ZONE, 
E   	house_rules TEXT, 
E   	local_info TEXT, 
E   	languages VARCHAR[], 
E   	timezone VARCHAR(50), 
E   	subscription_plan VARCHAR(50), 
E   	monthly_question_limit INTEGER, 
E   	is_active BOOLEAN, 
E   	created_at TIMESTAMP WITH TIME ZONE DEFAULT now(), 
E   	updated_at TIMESTAMP WITH TIME ZONE DEFAULT now(), 
E   	PRIMARY KEY (id)
E   )
E   
E   ]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
____________ ERROR at setup of TestLogout.test_logout_invalid_token ____________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-46' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10f1f4220>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_____________ ERROR at setup of TestChatAPI.test_get_chat_history ______________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:522: in _prepare_and_execute
    prepared_stmt, attributes = await adapt_connection._prepare(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:773: in _prepare
    prepared_stmt = await self._connection.prepare(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:636: in prepare
    return await self._prepare(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:654: in _prepare
    stmt = await self._get_statement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:433: in _get_statement
    statement = await self._protocol.prepare(
asyncpg/protocol/protocol.pyx:166: in prepare
    ???
E   asyncpg.exceptions.UndefinedTableError: relation "facilities" does not exist

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.ProgrammingError: <class 'asyncpg.exceptions.UndefinedTableError'>: relation "facilities" does not exist

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:360: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:355: in setup
    res = await func(
tests/conftest.py:153: in test_facility
    await db_session.commit()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:1011: in commit
    await greenlet_spawn(self.sync_session.commit)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:202: in greenlet_spawn
    result = context.switch(value)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1969: in commit
    trans.commit(_to_root=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1256: in commit
    self._prepare_impl()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1231: in _prepare_impl
    self.session.flush()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4312: in flush
    self._flush(objects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4447: in _flush
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4408: in _flush
    flush_context.execute()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py:1227: in _emit_insert_statements
    result = connection.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2344: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.exc.ProgrammingError: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedTableError'>: relation "facilities" does not exist
E   [SQL: INSERT INTO facilities (name, slug, email, phone, address, wifi_ssid, wifi_password, check_in_time, check_out_time, house_rules, local_info, languages, timezone, subscription_plan, monthly_question_limit, is_active) VALUES ($1::VARCHAR, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR, $7::VARCHAR, $8::TIME WITHOUT TIME ZONE, $9::TIME WITHOUT TIME ZONE, $10::VARCHAR, $11::VARCHAR, $12::VARCHAR[], $13::VARCHAR, $14::VARCHAR, $15::INTEGER, $16::BOOLEAN) RETURNING facilities.id, facilities.created_at, facilities.updated_at]
E   [parameters: ('Test Hotel', 'test-hotel', 'test@example.com', '090-1234-5678', 'Test Address', None, None, datetime.time(15, 0), datetime.time(11, 0), None, None, ['en'], 'Asia/Tokyo', 'small', 200, True)]
E   (Background on this error at: https://sqlalche.me/e/20/f405)
________ ERROR at setup of TestChatAPI.test_get_chat_history_not_found _________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-61' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10f1f5120>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_ ERROR at setup of TestChatService.test_process_chat_message_new_conversation _
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1068: in begin
    yield conn
tests/conftest.py:84: in db_session
    await conn.run_sync(Base.metadata.create_all)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:891: in run_sync
    return await greenlet_spawn(fn, self._proxied, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/schema.py:5832: in create_all
    bind._run_ddl_visitor(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2448: in _run_ddl_visitor
    visitorcallable(self.dialect, self, **kwargs).traverse_single(element)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py:671: in traverse_single
    return meth(obj, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:919: in visit_metadata
    self.traverse_single(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py:671: in traverse_single
    return meth(obj, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:957: in visit_table
    )._invoke_with(self.connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:315: in _invoke_with
    return bind.execute(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:181: in _execute_on_connection
    return connection._execute_ddl(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1528: in _execute_ddl
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2344: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.
E   [SQL: 
E   CREATE TABLE facilities (
E   	id SERIAL NOT NULL, 
E   	name VARCHAR(255) NOT NULL, 
E   	slug VARCHAR(100) NOT NULL, 
E   	email VARCHAR(255) NOT NULL, 
E   	phone VARCHAR(50), 
E   	address TEXT, 
E   	wifi_ssid VARCHAR(100), 
E   	wifi_password VARCHAR(100), 
E   	check_in_time TIME WITHOUT TIME ZONE, 
E   	check_out_time TIME WITHOUT TIME ZONE, 
E   	house_rules TEXT, 
E   	local_info TEXT, 
E   	languages VARCHAR[], 
E   	timezone VARCHAR(50), 
E   	subscription_plan VARCHAR(50), 
E   	monthly_question_limit INTEGER, 
E   	is_active BOOLEAN, 
E   	created_at TIMESTAMP WITH TIME ZONE DEFAULT now(), 
E   	updated_at TIMESTAMP WITH TIME ZONE DEFAULT now(), 
E   	PRIMARY KEY (id)
E   )
E   
E   ]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
_______ ERROR at setup of TestChatService.test_get_conversation_history ________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-64' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10f1f6110>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
____________ ERROR at setup of TestConfidence.test_base_confidence _____________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-70' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10f1f55d0>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_________ ERROR at setup of TestConfidence.test_short_response_penalty _________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1068: in begin
    yield conn
tests/conftest.py:84: in db_session
    await conn.run_sync(Base.metadata.create_all)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:891: in run_sync
    return await greenlet_spawn(fn, self._proxied, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/schema.py:5832: in create_all
    bind._run_ddl_visitor(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2448: in _run_ddl_visitor
    visitorcallable(self.dialect, self, **kwargs).traverse_single(element)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py:671: in traverse_single
    return meth(obj, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:919: in visit_metadata
    self.traverse_single(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py:671: in traverse_single
    return meth(obj, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:957: in visit_table
    )._invoke_with(self.connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:315: in _invoke_with
    return bind.execute(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:181: in _execute_on_connection
    return connection._execute_ddl(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1528: in _execute_ddl
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2344: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.
E   [SQL: 
E   CREATE TABLE facilities (
E   	id SERIAL NOT NULL, 
E   	name VARCHAR(255) NOT NULL, 
E   	slug VARCHAR(100) NOT NULL, 
E   	email VARCHAR(255) NOT NULL, 
E   	phone VARCHAR(50), 
E   	address TEXT, 
E   	wifi_ssid VARCHAR(100), 
E   	wifi_password VARCHAR(100), 
E   	check_in_time TIME WITHOUT TIME ZONE, 
E   	check_out_time TIME WITHOUT TIME ZONE, 
E   	house_rules TEXT, 
E   	local_info TEXT, 
E   	languages VARCHAR[], 
E   	timezone VARCHAR(50), 
E   	subscription_plan VARCHAR(50), 
E   	monthly_question_limit INTEGER, 
E   	is_active BOOLEAN, 
E   	created_at TIMESTAMP WITH TIME ZONE DEFAULT now(), 
E   	updated_at TIMESTAMP WITH TIME ZONE DEFAULT now(), 
E   	PRIMARY KEY (id)
E   )
E   
E   ]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
________ ERROR at setup of TestConfidence.test_uncertain_phrase_penalty ________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-73' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10ea517b0>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
______________ ERROR at setup of TestConfidence.test_number_bonus ______________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-79' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10f1f5a80>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
____________ ERROR at setup of TestConfidence.test_custom_faq_bonus ____________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1068: in begin
    yield conn
tests/conftest.py:84: in db_session
    await conn.run_sync(Base.metadata.create_all)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:891: in run_sync
    return await greenlet_spawn(fn, self._proxied, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/schema.py:5832: in create_all
    bind._run_ddl_visitor(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2448: in _run_ddl_visitor
    visitorcallable(self.dialect, self, **kwargs).traverse_single(element)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py:671: in traverse_single
    return meth(obj, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:919: in visit_metadata
    self.traverse_single(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py:671: in traverse_single
    return meth(obj, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:957: in visit_table
    )._invoke_with(self.connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:315: in _invoke_with
    return bind.execute(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:181: in _execute_on_connection
    return connection._execute_ddl(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1528: in _execute_ddl
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2344: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.
E   [SQL: 
E   CREATE TABLE facilities (
E   	id SERIAL NOT NULL, 
E   	name VARCHAR(255) NOT NULL, 
E   	slug VARCHAR(100) NOT NULL, 
E   	email VARCHAR(255) NOT NULL, 
E   	phone VARCHAR(50), 
E   	address TEXT, 
E   	wifi_ssid VARCHAR(100), 
E   	wifi_password VARCHAR(100), 
E   	check_in_time TIME WITHOUT TIME ZONE, 
E   	check_out_time TIME WITHOUT TIME ZONE, 
E   	house_rules TEXT, 
E   	local_info TEXT, 
E   	languages VARCHAR[], 
E   	timezone VARCHAR(50), 
E   	subscription_plan VARCHAR(50), 
E   	monthly_question_limit INTEGER, 
E   	is_active BOOLEAN, 
E   	created_at TIMESTAMP WITH TIME ZONE DEFAULT now(), 
E   	updated_at TIMESTAMP WITH TIME ZONE DEFAULT now(), 
E   	PRIMARY KEY (id)
E   )
E   
E   ]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
__________ ERROR at setup of TestConfidence.test_confidence_clipping ___________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-82' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10f1f7c40>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_______ ERROR at setup of TestEscalation.test_safety_category_escalation _______
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-92' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10f1f7a60>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_______ ERROR at setup of TestEscalation.test_low_confidence_escalation ________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1068: in begin
    yield conn
tests/conftest.py:84: in db_session
    await conn.run_sync(Base.metadata.create_all)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:891: in run_sync
    return await greenlet_spawn(fn, self._proxied, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/schema.py:5832: in create_all
    bind._run_ddl_visitor(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2448: in _run_ddl_visitor
    visitorcallable(self.dialect, self, **kwargs).traverse_single(element)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py:671: in traverse_single
    return meth(obj, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:919: in visit_metadata
    self.traverse_single(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py:671: in traverse_single
    return meth(obj, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:957: in visit_table
    )._invoke_with(self.connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:315: in _invoke_with
    return bind.execute(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:181: in _execute_on_connection
    return connection._execute_ddl(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1528: in _execute_ddl
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2344: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.
E   [SQL: 
E   CREATE TABLE facilities (
E   	id SERIAL NOT NULL, 
E   	name VARCHAR(255) NOT NULL, 
E   	slug VARCHAR(100) NOT NULL, 
E   	email VARCHAR(255) NOT NULL, 
E   	phone VARCHAR(50), 
E   	address TEXT, 
E   	wifi_ssid VARCHAR(100), 
E   	wifi_password VARCHAR(100), 
E   	check_in_time TIME WITHOUT TIME ZONE, 
E   	check_out_time TIME WITHOUT TIME ZONE, 
E   	house_rules TEXT, 
E   	local_info TEXT, 
E   	languages VARCHAR[], 
E   	timezone VARCHAR(50), 
E   	subscription_plan VARCHAR(50), 
E   	monthly_question_limit INTEGER, 
E   	is_active BOOLEAN, 
E   	created_at TIMESTAMP WITH TIME ZONE DEFAULT now(), 
E   	updated_at TIMESTAMP WITH TIME ZONE DEFAULT now(), 
E   	PRIMARY KEY (id)
E   )
E   
E   ]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
______ ERROR at setup of TestEscalation.test_emergency_keyword_escalation ______
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-95' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10f1f4400>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_______ ERROR at setup of TestEscalation.test_multiple_turns_escalation ________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "ix_facilities_slug"
E   DETAIL:  Key (slug)=(test-hotel) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "ix_facilities_slug"
E   DETAIL:  Key (slug)=(test-hotel) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:360: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:355: in setup
    res = await func(
tests/conftest.py:153: in test_facility
    await db_session.commit()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:1011: in commit
    await greenlet_spawn(self.sync_session.commit)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:202: in greenlet_spawn
    result = context.switch(value)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1969: in commit
    trans.commit(_to_root=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1256: in commit
    self._prepare_impl()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1231: in _prepare_impl
    self.session.flush()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4312: in flush
    self._flush(objects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4447: in _flush
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4408: in _flush
    flush_context.execute()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py:1227: in _emit_insert_statements
    result = connection.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2344: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "ix_facilities_slug"
E   DETAIL:  Key (slug)=(test-hotel) already exists.
E   [SQL: INSERT INTO facilities (name, slug, email, phone, address, wifi_ssid, wifi_password, check_in_time, check_out_time, house_rules, local_info, languages, timezone, subscription_plan, monthly_question_limit, is_active) VALUES ($1::VARCHAR, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR, $7::VARCHAR, $8::TIME WITHOUT TIME ZONE, $9::TIME WITHOUT TIME ZONE, $10::VARCHAR, $11::VARCHAR, $12::VARCHAR[], $13::VARCHAR, $14::VARCHAR, $15::INTEGER, $16::BOOLEAN) RETURNING facilities.id, facilities.created_at, facilities.updated_at]
E   [parameters: ('Test Hotel', 'test-hotel', 'test@example.com', '090-1234-5678', 'Test Address', None, None, datetime.time(15, 0), datetime.time(11, 0), None, None, ['en'], 'Asia/Tokyo', 'small', 200, True)]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
__________ ERROR at setup of TestEscalation.test_no_escalation_needed __________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-101' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10f1f4310>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
___________ ERROR at setup of TestEscalation.test_create_escalation ____________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1068: in begin
    yield conn
tests/conftest.py:84: in db_session
    await conn.run_sync(Base.metadata.create_all)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:891: in run_sync
    return await greenlet_spawn(fn, self._proxied, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/schema.py:5832: in create_all
    bind._run_ddl_visitor(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2448: in _run_ddl_visitor
    visitorcallable(self.dialect, self, **kwargs).traverse_single(element)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py:671: in traverse_single
    return meth(obj, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:919: in visit_metadata
    self.traverse_single(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py:671: in traverse_single
    return meth(obj, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:957: in visit_table
    )._invoke_with(self.connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:315: in _invoke_with
    return bind.execute(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:181: in _execute_on_connection
    return connection._execute_ddl(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1528: in _execute_ddl
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2344: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.
E   [SQL: 
E   CREATE TABLE facilities (
E   	id SERIAL NOT NULL, 
E   	name VARCHAR(255) NOT NULL, 
E   	slug VARCHAR(100) NOT NULL, 
E   	email VARCHAR(255) NOT NULL, 
E   	phone VARCHAR(50), 
E   	address TEXT, 
E   	wifi_ssid VARCHAR(100), 
E   	wifi_password VARCHAR(100), 
E   	check_in_time TIME WITHOUT TIME ZONE, 
E   	check_out_time TIME WITHOUT TIME ZONE, 
E   	house_rules TEXT, 
E   	local_info TEXT, 
E   	languages VARCHAR[], 
E   	timezone VARCHAR(50), 
E   	subscription_plan VARCHAR(50), 
E   	monthly_question_limit INTEGER, 
E   	is_active BOOLEAN, 
E   	created_at TIMESTAMP WITH TIME ZONE DEFAULT now(), 
E   	updated_at TIMESTAMP WITH TIME ZONE DEFAULT now(), 
E   	PRIMARY KEY (id)
E   )
E   
E   ]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
___ ERROR at setup of TestAuthFlow.test_login_and_access_protected_endpoint ____
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-104' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10f1f5d50>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
____________ ERROR at setup of TestChatFlow.test_chat_history_flow _____________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-120' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10f1f66b0>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
____________ ERROR at setup of TestAdminFlow.test_dashboard_access _____________
tests/test_integration.py:112: in auth_headers
    login_response = client.post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:593: in post
    return super().post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:468: in request
    return super().request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:344: in handle_request
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:341: in handle_request
    portal.call(self.app, scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:762: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:782: in app
    await route.handle(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:77: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:72: in app
    response = await func(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
tests/conftest.py:127: in override_get_db
    yield db_session
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:299: in app
    raise e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
app/api/v1/auth.py:29: in login
    return await AuthService.login(db, login_data)
app/services/auth_service.py:76: in login
    user = await AuthService.authenticate_user(db, login_data)
app/services/auth_service.py:39: in authenticate_user
    result = await db.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:455: in execute
    result = await greenlet_spawn(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2308: in execute
    return self._execute_internal(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2190: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/context.py:293: in orm_execute_statement
    result = conn.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2347: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:522: in _prepare_and_execute
    prepared_stmt, attributes = await adapt_connection._prepare(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:773: in _prepare
    prepared_stmt = await self._connection.prepare(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:636: in prepare
    return await self._prepare(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:654: in _prepare
    stmt = await self._get_statement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:433: in _get_statement
    statement = await self._protocol.prepare(
asyncpg/protocol/protocol.pyx:166: in prepare
    ???
E   RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:661]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
WARNING  passlib.handlers.bcrypt:bcrypt.py:622 (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
_____________ ERROR at setup of TestAdminFlow.test_faq_list_access _____________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-139' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10eae0d60>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_____________ ERROR at setup of TestAdminFlow.test_faq_create_flow _____________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1068: in begin
    yield conn
tests/conftest.py:84: in db_session
    await conn.run_sync(Base.metadata.create_all)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:891: in run_sync
    return await greenlet_spawn(fn, self._proxied, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/schema.py:5832: in create_all
    bind._run_ddl_visitor(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2448: in _run_ddl_visitor
    visitorcallable(self.dialect, self, **kwargs).traverse_single(element)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py:671: in traverse_single
    return meth(obj, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:919: in visit_metadata
    self.traverse_single(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py:671: in traverse_single
    return meth(obj, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:957: in visit_table
    )._invoke_with(self.connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:315: in _invoke_with
    return bind.execute(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:181: in _execute_on_connection
    return connection._execute_ddl(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1528: in _execute_ddl
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2344: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.
E   [SQL: 
E   CREATE TABLE facilities (
E   	id SERIAL NOT NULL, 
E   	name VARCHAR(255) NOT NULL, 
E   	slug VARCHAR(100) NOT NULL, 
E   	email VARCHAR(255) NOT NULL, 
E   	phone VARCHAR(50), 
E   	address TEXT, 
E   	wifi_ssid VARCHAR(100), 
E   	wifi_password VARCHAR(100), 
E   	check_in_time TIME WITHOUT TIME ZONE, 
E   	check_out_time TIME WITHOUT TIME ZONE, 
E   	house_rules TEXT, 
E   	local_info TEXT, 
E   	languages VARCHAR[], 
E   	timezone VARCHAR(50), 
E   	subscription_plan VARCHAR(50), 
E   	monthly_question_limit INTEGER, 
E   	is_active BOOLEAN, 
E   	created_at TIMESTAMP WITH TIME ZONE DEFAULT now(), 
E   	updated_at TIMESTAMP WITH TIME ZONE DEFAULT now(), 
E   	PRIMARY KEY (id)
E   )
E   
E   ]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
_________ ERROR at setup of TestAdminFlow.test_faq_suggestions_access __________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-142' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10ec75f30>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_________ ERROR at setup of TestAdminFlow.test_overnight_queue_access __________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "ix_facilities_slug"
E   DETAIL:  Key (slug)=(test-hotel) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "ix_facilities_slug"
E   DETAIL:  Key (slug)=(test-hotel) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:360: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:355: in setup
    res = await func(
tests/conftest.py:153: in test_facility
    await db_session.commit()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:1011: in commit
    await greenlet_spawn(self.sync_session.commit)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:202: in greenlet_spawn
    result = context.switch(value)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1969: in commit
    trans.commit(_to_root=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1256: in commit
    self._prepare_impl()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1231: in _prepare_impl
    self.session.flush()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4312: in flush
    self._flush(objects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4447: in _flush
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4408: in _flush
    flush_context.execute()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py:1227: in _emit_insert_statements
    result = connection.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2344: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "ix_facilities_slug"
E   DETAIL:  Key (slug)=(test-hotel) already exists.
E   [SQL: INSERT INTO facilities (name, slug, email, phone, address, wifi_ssid, wifi_password, check_in_time, check_out_time, house_rules, local_info, languages, timezone, subscription_plan, monthly_question_limit, is_active) VALUES ($1::VARCHAR, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR, $7::VARCHAR, $8::TIME WITHOUT TIME ZONE, $9::TIME WITHOUT TIME ZONE, $10::VARCHAR, $11::VARCHAR, $12::VARCHAR[], $13::VARCHAR, $14::VARCHAR, $15::INTEGER, $16::BOOLEAN) RETURNING facilities.id, facilities.created_at, facilities.updated_at]
E   [parameters: ('Test Hotel', 'test-hotel', 'test@example.com', '090-1234-5678', 'Test Address', None, None, datetime.time(15, 0), datetime.time(11, 0), None, None, ['en'], 'Asia/Tokyo', 'small', 200, True)]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
________ ERROR at setup of TestAdminFlow.test_qr_code_generation_access ________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-157' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10ec762f0>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
__________ ERROR at setup of TestErrorHandling.test_invalid_endpoint ___________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1068: in begin
    yield conn
tests/conftest.py:84: in db_session
    await conn.run_sync(Base.metadata.create_all)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:891: in run_sync
    return await greenlet_spawn(fn, self._proxied, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/schema.py:5832: in create_all
    bind._run_ddl_visitor(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2448: in _run_ddl_visitor
    visitorcallable(self.dialect, self, **kwargs).traverse_single(element)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py:671: in traverse_single
    return meth(obj, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:919: in visit_metadata
    self.traverse_single(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py:671: in traverse_single
    return meth(obj, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:957: in visit_table
    )._invoke_with(self.connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:315: in _invoke_with
    return bind.execute(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:181: in _execute_on_connection
    return connection._execute_ddl(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1528: in _execute_ddl
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2344: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.
E   [SQL: 
E   CREATE TABLE facilities (
E   	id SERIAL NOT NULL, 
E   	name VARCHAR(255) NOT NULL, 
E   	slug VARCHAR(100) NOT NULL, 
E   	email VARCHAR(255) NOT NULL, 
E   	phone VARCHAR(50), 
E   	address TEXT, 
E   	wifi_ssid VARCHAR(100), 
E   	wifi_password VARCHAR(100), 
E   	check_in_time TIME WITHOUT TIME ZONE, 
E   	check_out_time TIME WITHOUT TIME ZONE, 
E   	house_rules TEXT, 
E   	local_info TEXT, 
E   	languages VARCHAR[], 
E   	timezone VARCHAR(50), 
E   	subscription_plan VARCHAR(50), 
E   	monthly_question_limit INTEGER, 
E   	is_active BOOLEAN, 
E   	created_at TIMESTAMP WITH TIME ZONE DEFAULT now(), 
E   	updated_at TIMESTAMP WITH TIME ZONE DEFAULT now(), 
E   	PRIMARY KEY (id)
E   )
E   
E   ]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
____________ ERROR at setup of TestErrorHandling.test_invalid_json _____________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-160' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10ec755d0>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_______ ERROR at setup of TestResponseTime.test_dashboard_response_time ________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-182' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10ec76b60>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
________ ERROR at setup of TestResponseTime.test_faq_list_response_time ________
tests/test_integration.py:256: in auth_headers
    login_response = client.post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:593: in post
    return super().post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:468: in request
    return super().request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:344: in handle_request
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:341: in handle_request
    portal.call(self.app, scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:762: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:782: in app
    await route.handle(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:77: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:72: in app
    response = await func(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
tests/conftest.py:127: in override_get_db
    yield db_session
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:299: in app
    raise e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
app/api/v1/auth.py:29: in login
    return await AuthService.login(db, login_data)
app/services/auth_service.py:76: in login
    user = await AuthService.authenticate_user(db, login_data)
app/services/auth_service.py:39: in authenticate_user
    result = await db.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:455: in execute
    result = await greenlet_spawn(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2308: in execute
    return self._execute_internal(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2190: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/context.py:293: in orm_execute_statement
    result = conn.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2347: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:522: in _prepare_and_execute
    prepared_stmt, attributes = await adapt_connection._prepare(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:773: in _prepare
    prepared_stmt = await self._connection.prepare(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:636: in prepare
    return await self._prepare(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:654: in _prepare
    stmt = await self._get_statement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:433: in _get_statement
    statement = await self._protocol.prepare(
asyncpg/protocol/protocol.pyx:166: in prepare
    ???
E   RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:661]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
_______ ERROR at setup of TestOvernightQueue.test_add_to_overnight_queue _______
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-201' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10fb29c60>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
________ ERROR at setup of TestOvernightQueue.test_get_overnight_queue _________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1068: in begin
    yield conn
tests/conftest.py:84: in db_session
    await conn.run_sync(Base.metadata.create_all)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:891: in run_sync
    return await greenlet_spawn(fn, self._proxied, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/schema.py:5832: in create_all
    bind._run_ddl_visitor(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2448: in _run_ddl_visitor
    visitorcallable(self.dialect, self, **kwargs).traverse_single(element)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py:671: in traverse_single
    return meth(obj, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:919: in visit_metadata
    self.traverse_single(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py:671: in traverse_single
    return meth(obj, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:957: in visit_table
    )._invoke_with(self.connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:315: in _invoke_with
    return bind.execute(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:181: in _execute_on_connection
    return connection._execute_ddl(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1528: in _execute_ddl
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2344: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.
E   [SQL: 
E   CREATE TABLE facilities (
E   	id SERIAL NOT NULL, 
E   	name VARCHAR(255) NOT NULL, 
E   	slug VARCHAR(100) NOT NULL, 
E   	email VARCHAR(255) NOT NULL, 
E   	phone VARCHAR(50), 
E   	address TEXT, 
E   	wifi_ssid VARCHAR(100), 
E   	wifi_password VARCHAR(100), 
E   	check_in_time TIME WITHOUT TIME ZONE, 
E   	check_out_time TIME WITHOUT TIME ZONE, 
E   	house_rules TEXT, 
E   	local_info TEXT, 
E   	languages VARCHAR[], 
E   	timezone VARCHAR(50), 
E   	subscription_plan VARCHAR(50), 
E   	monthly_question_limit INTEGER, 
E   	is_active BOOLEAN, 
E   	created_at TIMESTAMP WITH TIME ZONE DEFAULT now(), 
E   	updated_at TIMESTAMP WITH TIME ZONE DEFAULT now(), 
E   	PRIMARY KEY (id)
E   )
E   
E   ]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
_____ ERROR at setup of TestOvernightQueue.test_send_overnight_auto_reply ______
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-204' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10fb2ad40>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
______ ERROR at setup of TestSessionTokenVerify.test_verify_token_success ______
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:522: in _prepare_and_execute
    prepared_stmt, attributes = await adapt_connection._prepare(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:773: in _prepare
    prepared_stmt = await self._connection.prepare(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:636: in prepare
    return await self._prepare(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:654: in _prepare
    stmt = await self._get_statement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:433: in _get_statement
    statement = await self._protocol.prepare(
asyncpg/protocol/protocol.pyx:166: in prepare
    ???
E   asyncpg.exceptions.UndefinedTableError: relation "facilities" does not exist

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.ProgrammingError: <class 'asyncpg.exceptions.UndefinedTableError'>: relation "facilities" does not exist

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:360: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:355: in setup
    res = await func(
tests/conftest.py:153: in test_facility
    await db_session.commit()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:1011: in commit
    await greenlet_spawn(self.sync_session.commit)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:202: in greenlet_spawn
    result = context.switch(value)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1969: in commit
    trans.commit(_to_root=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1256: in commit
    self._prepare_impl()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1231: in _prepare_impl
    self.session.flush()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4312: in flush
    self._flush(objects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4447: in _flush
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4408: in _flush
    flush_context.execute()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py:1227: in _emit_insert_statements
    result = connection.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2344: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.exc.ProgrammingError: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedTableError'>: relation "facilities" does not exist
E   [SQL: INSERT INTO facilities (name, slug, email, phone, address, wifi_ssid, wifi_password, check_in_time, check_out_time, house_rules, local_info, languages, timezone, subscription_plan, monthly_question_limit, is_active) VALUES ($1::VARCHAR, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR, $7::VARCHAR, $8::TIME WITHOUT TIME ZONE, $9::TIME WITHOUT TIME ZONE, $10::VARCHAR, $11::VARCHAR, $12::VARCHAR[], $13::VARCHAR, $14::VARCHAR, $15::INTEGER, $16::BOOLEAN) RETURNING facilities.id, facilities.created_at, facilities.updated_at]
E   [parameters: ('Test Hotel', 'test-hotel', 'test@example.com', '090-1234-5678', 'Test Address', None, None, datetime.time(15, 0), datetime.time(11, 0), None, None, ['en'], 'Asia/Tokyo', 'small', 200, True)]
E   (Background on this error at: https://sqlalche.me/e/20/f405)
______ ERROR at setup of TestSessionTokenVerify.test_verify_token_invalid ______
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-219' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10fb29d50>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
______ ERROR at setup of TestSessionTokenVerify.test_verify_token_expired ______
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1068: in begin
    yield conn
tests/conftest.py:84: in db_session
    await conn.run_sync(Base.metadata.create_all)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:891: in run_sync
    return await greenlet_spawn(fn, self._proxied, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/schema.py:5832: in create_all
    bind._run_ddl_visitor(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2448: in _run_ddl_visitor
    visitorcallable(self.dialect, self, **kwargs).traverse_single(element)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py:671: in traverse_single
    return meth(obj, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:919: in visit_metadata
    self.traverse_single(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py:671: in traverse_single
    return meth(obj, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:957: in visit_table
    )._invoke_with(self.connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:315: in _invoke_with
    return bind.execute(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:181: in _execute_on_connection
    return connection._execute_ddl(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1528: in _execute_ddl
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2344: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.
E   [SQL: 
E   CREATE TABLE facilities (
E   	id SERIAL NOT NULL, 
E   	name VARCHAR(255) NOT NULL, 
E   	slug VARCHAR(100) NOT NULL, 
E   	email VARCHAR(255) NOT NULL, 
E   	phone VARCHAR(50), 
E   	address TEXT, 
E   	wifi_ssid VARCHAR(100), 
E   	wifi_password VARCHAR(100), 
E   	check_in_time TIME WITHOUT TIME ZONE, 
E   	check_out_time TIME WITHOUT TIME ZONE, 
E   	house_rules TEXT, 
E   	local_info TEXT, 
E   	languages VARCHAR[], 
E   	timezone VARCHAR(50), 
E   	subscription_plan VARCHAR(50), 
E   	monthly_question_limit INTEGER, 
E   	is_active BOOLEAN, 
E   	created_at TIMESTAMP WITH TIME ZONE DEFAULT now(), 
E   	updated_at TIMESTAMP WITH TIME ZONE DEFAULT now(), 
E   	PRIMARY KEY (id)
E   )
E   
E   ]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
_________ ERROR at setup of TestSessionLink.test_link_session_success __________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-222' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10fb2b790>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
______ ERROR at setup of TestSessionLink.test_link_session_invalid_token _______
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "ix_facilities_slug"
E   DETAIL:  Key (slug)=(test-hotel) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "ix_facilities_slug"
E   DETAIL:  Key (slug)=(test-hotel) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:360: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:355: in setup
    res = await func(
tests/conftest.py:153: in test_facility
    await db_session.commit()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:1011: in commit
    await greenlet_spawn(self.sync_session.commit)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:202: in greenlet_spawn
    result = context.switch(value)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1969: in commit
    trans.commit(_to_root=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1256: in commit
    self._prepare_impl()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1231: in _prepare_impl
    self.session.flush()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4312: in flush
    self._flush(objects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4447: in _flush
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4408: in _flush
    flush_context.execute()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py:1227: in _emit_insert_statements
    result = connection.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2344: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "ix_facilities_slug"
E   DETAIL:  Key (slug)=(test-hotel) already exists.
E   [SQL: INSERT INTO facilities (name, slug, email, phone, address, wifi_ssid, wifi_password, check_in_time, check_out_time, house_rules, local_info, languages, timezone, subscription_plan, monthly_question_limit, is_active) VALUES ($1::VARCHAR, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR, $7::VARCHAR, $8::TIME WITHOUT TIME ZONE, $9::TIME WITHOUT TIME ZONE, $10::VARCHAR, $11::VARCHAR, $12::VARCHAR[], $13::VARCHAR, $14::VARCHAR, $15::INTEGER, $16::BOOLEAN) RETURNING facilities.id, facilities.created_at, facilities.updated_at]
E   [parameters: ('Test Hotel', 'test-hotel', 'test@example.com', '090-1234-5678', 'Test Address', None, None, datetime.time(15, 0), datetime.time(11, 0), None, None, ['en'], 'Asia/Tokyo', 'small', 200, True)]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
______ ERROR at setup of TestSessionLink.test_link_session_expired_token _______
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-237' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10fb289a0>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
______ ERROR at setup of TestSessionLink.test_link_session_wrong_facility ______
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1068: in begin
    yield conn
tests/conftest.py:84: in db_session
    await conn.run_sync(Base.metadata.create_all)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:891: in run_sync
    return await greenlet_spawn(fn, self._proxied, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/schema.py:5832: in create_all
    bind._run_ddl_visitor(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2448: in _run_ddl_visitor
    visitorcallable(self.dialect, self, **kwargs).traverse_single(element)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py:671: in traverse_single
    return meth(obj, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:919: in visit_metadata
    self.traverse_single(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py:671: in traverse_single
    return meth(obj, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:957: in visit_table
    )._invoke_with(self.connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:315: in _invoke_with
    return bind.execute(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py:181: in _execute_on_connection
    return connection._execute_ddl(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1528: in _execute_ddl
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2344: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
E   DETAIL:  Key (typname, typnamespace)=(facilities, 2200) already exists.
E   [SQL: 
E   CREATE TABLE facilities (
E   	id SERIAL NOT NULL, 
E   	name VARCHAR(255) NOT NULL, 
E   	slug VARCHAR(100) NOT NULL, 
E   	email VARCHAR(255) NOT NULL, 
E   	phone VARCHAR(50), 
E   	address TEXT, 
E   	wifi_ssid VARCHAR(100), 
E   	wifi_password VARCHAR(100), 
E   	check_in_time TIME WITHOUT TIME ZONE, 
E   	check_out_time TIME WITHOUT TIME ZONE, 
E   	house_rules TEXT, 
E   	local_info TEXT, 
E   	languages VARCHAR[], 
E   	timezone VARCHAR(50), 
E   	subscription_plan VARCHAR(50), 
E   	monthly_question_limit INTEGER, 
E   	is_active BOOLEAN, 
E   	created_at TIMESTAMP WITH TIME ZONE DEFAULT now(), 
E   	updated_at TIMESTAMP WITH TIME ZONE DEFAULT now(), 
E   	PRIMARY KEY (id)
E   )
E   
E   ]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
_ ERROR at setup of TestVectorSearch.test_search_similar_faqs_empty_embedding __
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-240' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10fb2ac50>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
____ ERROR at setup of TestVectorSearch.test_search_similar_faqs_with_data _____
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "ix_facilities_slug"
E   DETAIL:  Key (slug)=(test-hotel) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "ix_facilities_slug"
E   DETAIL:  Key (slug)=(test-hotel) already exists.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:360: in _async_fixture_wrapper
    return event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:355: in setup
    res = await func(
tests/conftest.py:153: in test_facility
    await db_session.commit()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:1011: in commit
    await greenlet_spawn(self.sync_session.commit)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:202: in greenlet_spawn
    result = context.switch(value)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1969: in commit
    trans.commit(_to_root=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1256: in commit
    self._prepare_impl()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1231: in _prepare_impl
    self.session.flush()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4312: in flush
    self._flush(objects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4447: in _flush
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4408: in _flush
    flush_context.execute()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py:1227: in _emit_insert_statements
    result = connection.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2344: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "ix_facilities_slug"
E   DETAIL:  Key (slug)=(test-hotel) already exists.
E   [SQL: INSERT INTO facilities (name, slug, email, phone, address, wifi_ssid, wifi_password, check_in_time, check_out_time, house_rules, local_info, languages, timezone, subscription_plan, monthly_question_limit, is_active) VALUES ($1::VARCHAR, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR, $7::VARCHAR, $8::TIME WITHOUT TIME ZONE, $9::TIME WITHOUT TIME ZONE, $10::VARCHAR, $11::VARCHAR, $12::VARCHAR[], $13::VARCHAR, $14::VARCHAR, $15::INTEGER, $16::BOOLEAN) RETURNING facilities.id, facilities.created_at, facilities.updated_at]
E   [parameters: ('Test Hotel', 'test-hotel', 'test@example.com', '090-1234-5678', 'Test Address', None, None, datetime.time(15, 0), datetime.time(11, 0), None, None, ['en'], 'Asia/Tokyo', 'small', 200, True)]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
_ ERROR at setup of TestVectorSearch.test_search_similar_patterns_empty_embedding _
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:337: in _asyncgen_fixture_wrapper
    result = event_loop.run_until_complete(setup())
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319: in setup
    res = await gen_obj.__anext__()
tests/conftest.py:80: in db_session
    async with test_engine.begin() as conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:204: in __aenter__
    return await anext(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:1066: in begin
    async with conn:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/base.py:125: in __aenter__
    return await self.start(is_ctxmanager=True)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/engine.py:270: in start
    await greenlet_spawn(self.sync_engine.connect)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='Task-247' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:319> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x10fb2bd30>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
=================================== FAILURES ===================================
____________________ TestLogin.test_login_validation_error _____________________
tests/test_auth.py:99: in test_login_validation_error
    assert "error" in data
E   AssertionError: assert 'error' in {'detail': [{'input': {'password': 'testpassword123'}, 'loc': ['body', 'email'], 'msg': 'Field required', 'type': 'missing', ...}]}
___________ TestChatService.test_get_conversation_history_not_found ____________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:522: in _prepare_and_execute
    prepared_stmt, attributes = await adapt_connection._prepare(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:773: in _prepare
    prepared_stmt = await self._connection.prepare(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:636: in prepare
    return await self._prepare(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:654: in _prepare
    stmt = await self._get_statement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:433: in _get_statement
    statement = await self._protocol.prepare(
asyncpg/protocol/protocol.pyx:166: in prepare
    ???
E   asyncpg.exceptions.UndefinedTableError: relation "conversations" does not exist

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.ProgrammingError: <class 'asyncpg.exceptions.UndefinedTableError'>: relation "conversations" does not exist

The above exception was the direct cause of the following exception:
tests/test_chat_service.py:122: in test_get_conversation_history_not_found
    history = await chat_service.get_conversation_history(
app/services/chat_service.py:254: in get_conversation_history
    result = await self.db.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:455: in execute
    result = await greenlet_spawn(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2308: in execute
    return self._execute_internal(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2190: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/context.py:293: in orm_execute_statement
    result = conn.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2344: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.exc.ProgrammingError: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedTableError'>: relation "conversations" does not exist
E   [SQL: SELECT conversations.id, conversations.facility_id, conversations.session_id, conversations.guest_language, conversations.location, conversations.user_agent, conversations.ip_address, conversations.started_at, conversations.last_activity_at, conversations.ended_at, conversations.is_escalated, conversations.total_messages, conversations.auto_resolved 
E   FROM conversations 
E   WHERE conversations.session_id = $1::VARCHAR AND conversations.facility_id = $2::INTEGER]
E   [parameters: ('non-existent-session', 1)]
E   (Background on this error at: https://sqlalche.me/e/20/f405)
____________________ TestConfidence.test_proper_noun_bonus _____________________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:430: in runtest
    super().runtest()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:887: in inner
    _loop.run_until_complete(task)
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/unittest/mock.py:1383: in patched
    with self.decoration_helper(patched,
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:137: in __enter__
    return next(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/unittest/mock.py:1348: in decoration_helper
    arg = exit_stack.enter_context(patching)
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:502: in enter_context
    result = _enter(cm)
../../../.pyenv/versions/3.11.1/lib/python3.11/unittest/mock.py:1437: in __enter__
    original, local = self.get_original()
../../../.pyenv/versions/3.11.1/lib/python3.11/unittest/mock.py:1410: in get_original
    raise AttributeError(
E   AttributeError: <module 'app.ai.confidence' from '/Users/kurinobu/projects/yadopera/backend/app/ai/confidence.py'> does not have the attribute 'search_similar_patterns'
____________________ TestConfidence.test_multiple_penalties ____________________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:430: in runtest
    super().runtest()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:887: in inner
    _loop.run_until_complete(task)
../../../.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:653: in run_until_complete
    return future.result()
../../../.pyenv/versions/3.11.1/lib/python3.11/unittest/mock.py:1383: in patched
    with self.decoration_helper(patched,
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:137: in __enter__
    return next(self.gen)
../../../.pyenv/versions/3.11.1/lib/python3.11/unittest/mock.py:1348: in decoration_helper
    arg = exit_stack.enter_context(patching)
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:502: in enter_context
    result = _enter(cm)
../../../.pyenv/versions/3.11.1/lib/python3.11/unittest/mock.py:1437: in __enter__
    original, local = self.get_original()
../../../.pyenv/versions/3.11.1/lib/python3.11/unittest/mock.py:1410: in get_original
    raise AttributeError(
E   AttributeError: <module 'app.ai.confidence' from '/Users/kurinobu/projects/yadopera/backend/app/ai/confidence.py'> does not have the attribute 'search_similar_patterns'
________________ TestSafetyCheck.test_safety_keyword_detection _________________
tests/test_safety_check.py:48: in test_safety_keyword_detection
    assert result == expected, f"Failed for: {question}"
E   AssertionError: Failed for: I need to evacuate
E   assert False == True
___________ TestVectorSearch.test_search_similar_patterns_with_data ____________
tests/test_vector_search.py:121: in test_search_similar_patterns_with_data
    pattern = QuestionPattern(
<string>:4: in __init__
    ???
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state.py:566: in _initialize_instance
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state.py:564: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/decl_base.py:2142: in _declarative_constructor
    raise TypeError(
E   TypeError: 'is_active' is an invalid keyword argument for QuestionPattern
=============================== warnings summary ===============================
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pydantic/_internal/_config.py:271: 20 warnings
  /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pydantic/_internal/_config.py:271: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/passlib/utils/__init__.py:854
  /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/passlib/utils/__init__.py:854: DeprecationWarning: 'crypt' is deprecated and slated for removal in Python 3.13
    from crypt import crypt as _crypt

tests/test_ai_engine.py: 2 warnings
tests/test_auth.py: 4 warnings
tests/test_chat_api.py: 1 warning
tests/test_chat_service.py: 1 warning
tests/test_confidence.py: 4 warnings
tests/test_escalation.py: 3 warnings
tests/test_integration.py: 7 warnings
tests/test_overnight_queue.py: 2 warnings
tests/test_session_token.py: 3 warnings
tests/test_vector_search.py: 2 warnings
  /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/_pytest/stash.py:104: RuntimeWarning: coroutine 'Connection._cancel' was never awaited
    del self._storage[key]
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_auth.py::TestLogin::test_login_validation_error - Assertion...
FAILED tests/test_chat_service.py::TestChatService::test_get_conversation_history_not_found
FAILED tests/test_confidence.py::TestConfidence::test_proper_noun_bonus - Att...
FAILED tests/test_confidence.py::TestConfidence::test_multiple_penalties - At...
FAILED tests/test_safety_check.py::TestSafetyCheck::test_safety_keyword_detection
FAILED tests/test_vector_search.py::TestVectorSearch::test_search_similar_patterns_with_data
ERROR tests/test_ai_engine.py::TestRAGEngine::test_process_message_success - ...
ERROR tests/test_ai_engine.py::TestRAGEngine::test_process_message_embedding_failure
ERROR tests/test_ai_engine.py::TestRAGEngine::test_process_message_facility_not_found
ERROR tests/test_ai_engine.py::TestRAGEngine::test_process_message_openai_error
ERROR tests/test_auth.py::TestLogin::test_login_success - sqlalchemy.exc.Inte...
ERROR tests/test_auth.py::TestLogin::test_login_invalid_email - RuntimeError:...
ERROR tests/test_auth.py::TestLogin::test_login_invalid_password - sqlalchemy...
ERROR tests/test_auth.py::TestLogin::test_login_inactive_user - RuntimeError:...
ERROR tests/test_auth.py::TestLogout::test_logout_success - RuntimeError: Tas...
ERROR tests/test_auth.py::TestLogout::test_logout_without_token - sqlalchemy....
ERROR tests/test_auth.py::TestLogout::test_logout_invalid_token - RuntimeErro...
ERROR tests/test_chat_api.py::TestChatAPI::test_get_chat_history - sqlalchemy...
ERROR tests/test_chat_api.py::TestChatAPI::test_get_chat_history_not_found - ...
ERROR tests/test_chat_service.py::TestChatService::test_process_chat_message_new_conversation
ERROR tests/test_chat_service.py::TestChatService::test_get_conversation_history
ERROR tests/test_confidence.py::TestConfidence::test_base_confidence - Runtim...
ERROR tests/test_confidence.py::TestConfidence::test_short_response_penalty
ERROR tests/test_confidence.py::TestConfidence::test_uncertain_phrase_penalty
ERROR tests/test_confidence.py::TestConfidence::test_number_bonus - RuntimeEr...
ERROR tests/test_confidence.py::TestConfidence::test_custom_faq_bonus - sqlal...
ERROR tests/test_confidence.py::TestConfidence::test_confidence_clipping - Ru...
ERROR tests/test_escalation.py::TestEscalation::test_safety_category_escalation
ERROR tests/test_escalation.py::TestEscalation::test_low_confidence_escalation
ERROR tests/test_escalation.py::TestEscalation::test_emergency_keyword_escalation
ERROR tests/test_escalation.py::TestEscalation::test_multiple_turns_escalation
ERROR tests/test_escalation.py::TestEscalation::test_no_escalation_needed - R...
ERROR tests/test_escalation.py::TestEscalation::test_create_escalation - sqla...
ERROR tests/test_integration.py::TestAuthFlow::test_login_and_access_protected_endpoint
ERROR tests/test_integration.py::TestChatFlow::test_chat_history_flow - Runti...
ERROR tests/test_integration.py::TestAdminFlow::test_dashboard_access - Runti...
ERROR tests/test_integration.py::TestAdminFlow::test_faq_list_access - Runtim...
ERROR tests/test_integration.py::TestAdminFlow::test_faq_create_flow - sqlalc...
ERROR tests/test_integration.py::TestAdminFlow::test_faq_suggestions_access
ERROR tests/test_integration.py::TestAdminFlow::test_overnight_queue_access
ERROR tests/test_integration.py::TestAdminFlow::test_qr_code_generation_access
ERROR tests/test_integration.py::TestErrorHandling::test_invalid_endpoint - s...
ERROR tests/test_integration.py::TestErrorHandling::test_invalid_json - Runti...
ERROR tests/test_integration.py::TestResponseTime::test_dashboard_response_time
ERROR tests/test_integration.py::TestResponseTime::test_faq_list_response_time
ERROR tests/test_overnight_queue.py::TestOvernightQueue::test_add_to_overnight_queue
ERROR tests/test_overnight_queue.py::TestOvernightQueue::test_get_overnight_queue
ERROR tests/test_overnight_queue.py::TestOvernightQueue::test_send_overnight_auto_reply
ERROR tests/test_session_token.py::TestSessionTokenVerify::test_verify_token_success
ERROR tests/test_session_token.py::TestSessionTokenVerify::test_verify_token_invalid
ERROR tests/test_session_token.py::TestSessionTokenVerify::test_verify_token_expired
ERROR tests/test_session_token.py::TestSessionLink::test_link_session_success
ERROR tests/test_session_token.py::TestSessionLink::test_link_session_invalid_token
ERROR tests/test_session_token.py::TestSessionLink::test_link_session_expired_token
ERROR tests/test_session_token.py::TestSessionLink::test_link_session_wrong_facility
ERROR tests/test_vector_search.py::TestVectorSearch::test_search_similar_faqs_empty_embedding
ERROR tests/test_vector_search.py::TestVectorSearch::test_search_similar_faqs_with_data
ERROR tests/test_vector_search.py::TestVectorSearch::test_search_similar_patterns_empty_embedding
= 6 failed, 11 passed, 2 skipped, 50 warnings, 52 errors in 893.12s (0:14:53) ==
