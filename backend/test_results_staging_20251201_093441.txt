============================= test session starts ==============================
platform darwin -- Python 3.11.1, pytest-7.4.4, pluggy-1.5.0
rootdir: /Users/kurinobu/projects/yadopera/backend
configfile: pytest.ini
plugins: asyncio-0.23.3, flask-1.3.0, metadata-3.1.1, cov-4.1.0, html-4.0.0, anyio-3.7.0
asyncio: mode=Mode.AUTO
collected 71 items

tests/test_ai_engine.py ..F.                                             [  5%]
tests/test_auth.py FFFF.F..                                              [ 16%]
tests/test_chat_api.py sFF                                               [ 21%]
tests/test_chat_service.py F..                                           [ 25%]
tests/test_confidence.py ........                                        [ 36%]
tests/test_embeddings.py ....                                            [ 42%]
tests/test_escalation.py ..F...                                          [ 50%]
tests/test_integration.py F.sFEEEEEE.F.EE                                [ 71%]
tests/test_overnight_queue.py ..F                                        [ 76%]
tests/test_safety_check.py ....                                          [ 81%]
tests/test_session_token.py F.FFFFF                                      [ 91%]
tests/test_vector_search.py ..F..F                                       [100%]

==================================== ERRORS ====================================
____________ ERROR at setup of TestAdminFlow.test_dashboard_access _____________
tests/test_integration.py:112: in auth_headers
    login_response = client.post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:593: in post
    return super().post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:468: in request
    return super().request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:344: in handle_request
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:341: in handle_request
    portal.call(self.app, scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:762: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:782: in app
    await route.handle(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:77: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:72: in app
    response = await func(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
tests/conftest.py:165: in override_get_db
    yield db_session
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:299: in app
    raise e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
app/api/v1/auth.py:29: in login
    return await AuthService.login(db, login_data)
app/services/auth_service.py:76: in login
    user = await AuthService.authenticate_user(db, login_data)
app/services/auth_service.py:39: in authenticate_user
    result = await db.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:455: in execute
    result = await greenlet_spawn(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2308: in execute
    return self._execute_internal(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2190: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/context.py:293: in orm_execute_statement
    result = conn.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2347: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:661]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
_____________ ERROR at setup of TestAdminFlow.test_faq_list_access _____________
tests/test_integration.py:112: in auth_headers
    login_response = client.post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:593: in post
    return super().post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:468: in request
    return super().request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:344: in handle_request
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:341: in handle_request
    portal.call(self.app, scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:762: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:782: in app
    await route.handle(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:77: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:72: in app
    response = await func(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
tests/conftest.py:165: in override_get_db
    yield db_session
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:299: in app
    raise e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
app/api/v1/auth.py:29: in login
    return await AuthService.login(db, login_data)
app/services/auth_service.py:76: in login
    user = await AuthService.authenticate_user(db, login_data)
app/services/auth_service.py:39: in authenticate_user
    result = await db.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:455: in execute
    result = await greenlet_spawn(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2308: in execute
    return self._execute_internal(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2190: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/context.py:293: in orm_execute_statement
    result = conn.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2347: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:661]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x11831dc60>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_____________ ERROR at setup of TestAdminFlow.test_faq_create_flow _____________
tests/test_integration.py:112: in auth_headers
    login_response = client.post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:593: in post
    return super().post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:468: in request
    return super().request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:344: in handle_request
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:341: in handle_request
    portal.call(self.app, scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:762: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:782: in app
    await route.handle(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:77: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:72: in app
    response = await func(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
tests/conftest.py:165: in override_get_db
    yield db_session
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:299: in app
    raise e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
app/api/v1/auth.py:29: in login
    return await AuthService.login(db, login_data)
app/services/auth_service.py:76: in login
    user = await AuthService.authenticate_user(db, login_data)
app/services/auth_service.py:39: in authenticate_user
    result = await db.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:455: in execute
    result = await greenlet_spawn(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2308: in execute
    return self._execute_internal(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2190: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/context.py:293: in orm_execute_statement
    result = conn.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2347: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:661]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x11f2462f0>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_________ ERROR at setup of TestAdminFlow.test_faq_suggestions_access __________
tests/test_integration.py:112: in auth_headers
    login_response = client.post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:593: in post
    return super().post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:468: in request
    return super().request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:344: in handle_request
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:341: in handle_request
    portal.call(self.app, scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:762: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:782: in app
    await route.handle(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:77: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:72: in app
    response = await func(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
tests/conftest.py:165: in override_get_db
    yield db_session
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:299: in app
    raise e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
app/api/v1/auth.py:29: in login
    return await AuthService.login(db, login_data)
app/services/auth_service.py:76: in login
    user = await AuthService.authenticate_user(db, login_data)
app/services/auth_service.py:39: in authenticate_user
    result = await db.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:455: in execute
    result = await greenlet_spawn(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2308: in execute
    return self._execute_internal(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2190: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/context.py:293: in orm_execute_statement
    result = conn.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2347: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:661]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x11f244310>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_________ ERROR at setup of TestAdminFlow.test_overnight_queue_access __________
tests/test_integration.py:112: in auth_headers
    login_response = client.post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:593: in post
    return super().post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:468: in request
    return super().request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:344: in handle_request
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:341: in handle_request
    portal.call(self.app, scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:762: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:782: in app
    await route.handle(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:77: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:72: in app
    response = await func(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
tests/conftest.py:165: in override_get_db
    yield db_session
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:299: in app
    raise e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
app/api/v1/auth.py:29: in login
    return await AuthService.login(db, login_data)
app/services/auth_service.py:76: in login
    user = await AuthService.authenticate_user(db, login_data)
app/services/auth_service.py:39: in authenticate_user
    result = await db.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:455: in execute
    result = await greenlet_spawn(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2308: in execute
    return self._execute_internal(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2190: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/context.py:293: in orm_execute_statement
    result = conn.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2347: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:661]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x11f245300>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
________ ERROR at setup of TestAdminFlow.test_qr_code_generation_access ________
tests/test_integration.py:112: in auth_headers
    login_response = client.post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:593: in post
    return super().post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:468: in request
    return super().request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:344: in handle_request
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:341: in handle_request
    portal.call(self.app, scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:762: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:782: in app
    await route.handle(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:77: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:72: in app
    response = await func(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
tests/conftest.py:165: in override_get_db
    yield db_session
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:299: in app
    raise e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
app/api/v1/auth.py:29: in login
    return await AuthService.login(db, login_data)
app/services/auth_service.py:76: in login
    user = await AuthService.authenticate_user(db, login_data)
app/services/auth_service.py:39: in authenticate_user
    result = await db.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:455: in execute
    result = await greenlet_spawn(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2308: in execute
    return self._execute_internal(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2190: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/context.py:293: in orm_execute_statement
    result = conn.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2347: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:661]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x11f244400>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_______ ERROR at setup of TestResponseTime.test_dashboard_response_time ________
tests/test_integration.py:256: in auth_headers
    login_response = client.post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:593: in post
    return super().post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:468: in request
    return super().request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:344: in handle_request
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:341: in handle_request
    portal.call(self.app, scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:762: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:782: in app
    await route.handle(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:77: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:72: in app
    response = await func(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
tests/conftest.py:165: in override_get_db
    yield db_session
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:299: in app
    raise e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
app/api/v1/auth.py:29: in login
    return await AuthService.login(db, login_data)
app/services/auth_service.py:76: in login
    user = await AuthService.authenticate_user(db, login_data)
app/services/auth_service.py:39: in authenticate_user
    result = await db.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:455: in execute
    result = await greenlet_spawn(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2308: in execute
    return self._execute_internal(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2190: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/context.py:293: in orm_execute_statement
    result = conn.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2347: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:661]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
________ ERROR at setup of TestResponseTime.test_faq_list_response_time ________
tests/test_integration.py:256: in auth_headers
    login_response = client.post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:593: in post
    return super().post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:468: in request
    return super().request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:344: in handle_request
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:341: in handle_request
    portal.call(self.app, scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:762: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:782: in app
    await route.handle(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:77: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:72: in app
    response = await func(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
tests/conftest.py:165: in override_get_db
    yield db_session
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:299: in app
    raise e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
app/api/v1/auth.py:29: in login
    return await AuthService.login(db, login_data)
app/services/auth_service.py:76: in login
    user = await AuthService.authenticate_user(db, login_data)
app/services/auth_service.py:39: in authenticate_user
    result = await db.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:455: in execute
    result = await greenlet_spawn(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2308: in execute
    return self._execute_internal(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2190: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/context.py:293: in orm_execute_statement
    result = conn.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2347: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:661]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x1183d7f10>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
=================================== FAILURES ===================================
____________ TestRAGEngine.test_process_message_facility_not_found _____________
tests/test_ai_engine.py:131: in test_process_message_facility_not_found
    with pytest.raises(ValueError, match="Facility not found"):
E   Failed: DID NOT RAISE <class 'ValueError'>
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x118057010>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
------------------------------ Captured log call -------------------------------
ERROR    app.ai.engine:engine.py:78 Facility not found: 99999
ERROR    app.ai.engine:engine.py:147 Error processing message: Facility not found: 99999
Traceback (most recent call last):
  File "/Users/kurinobu/projects/yadopera/backend/app/ai/engine.py", line 80, in process_message
    raise ValueError(f"Facility not found: {facility_id}")
ValueError: Facility not found: 99999
_________________________ TestLogin.test_login_success _________________________
tests/test_auth.py:16: in test_login_success
    response = client.post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:593: in post
    return super().post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:468: in request
    return super().request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:344: in handle_request
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:341: in handle_request
    portal.call(self.app, scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:762: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:782: in app
    await route.handle(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:77: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:72: in app
    response = await func(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
tests/conftest.py:165: in override_get_db
    yield db_session
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:299: in app
    raise e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
app/api/v1/auth.py:29: in login
    return await AuthService.login(db, login_data)
app/services/auth_service.py:76: in login
    user = await AuthService.authenticate_user(db, login_data)
app/services/auth_service.py:39: in authenticate_user
    result = await db.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:455: in execute
    result = await greenlet_spawn(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2308: in execute
    return self._execute_internal(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2190: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/context.py:293: in orm_execute_statement
    result = conn.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2347: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:661]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x11831d4e0>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
WARNING  passlib.handlers.bcrypt:bcrypt.py:622 (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
______________________ TestLogin.test_login_invalid_email ______________________
tests/test_auth.py:34: in test_login_invalid_email
    response = client.post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:593: in post
    return super().post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:468: in request
    return super().request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:344: in handle_request
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:341: in handle_request
    portal.call(self.app, scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:762: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:782: in app
    await route.handle(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:77: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:72: in app
    response = await func(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
tests/conftest.py:165: in override_get_db
    yield db_session
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:299: in app
    raise e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
app/api/v1/auth.py:29: in login
    return await AuthService.login(db, login_data)
app/services/auth_service.py:76: in login
    user = await AuthService.authenticate_user(db, login_data)
app/services/auth_service.py:39: in authenticate_user
    result = await db.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:455: in execute
    result = await greenlet_spawn(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2308: in execute
    return self._execute_internal(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2190: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/context.py:293: in orm_execute_statement
    result = conn.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2347: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:661]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x1183d4e50>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
____________________ TestLogin.test_login_invalid_password _____________________
tests/test_auth.py:49: in test_login_invalid_password
    response = client.post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:593: in post
    return super().post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:468: in request
    return super().request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:344: in handle_request
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:341: in handle_request
    portal.call(self.app, scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:762: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:782: in app
    await route.handle(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:77: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:72: in app
    response = await func(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
tests/conftest.py:165: in override_get_db
    yield db_session
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:299: in app
    raise e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
app/api/v1/auth.py:29: in login
    return await AuthService.login(db, login_data)
app/services/auth_service.py:76: in login
    user = await AuthService.authenticate_user(db, login_data)
app/services/auth_service.py:39: in authenticate_user
    result = await db.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:455: in execute
    result = await greenlet_spawn(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2308: in execute
    return self._execute_internal(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2190: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/context.py:293: in orm_execute_statement
    result = conn.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2347: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:661]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x1183d66b0>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
______________________ TestLogin.test_login_inactive_user ______________________
tests/test_auth.py:78: in test_login_inactive_user
    response = client.post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:593: in post
    return super().post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:468: in request
    return super().request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:344: in handle_request
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:341: in handle_request
    portal.call(self.app, scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:762: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:782: in app
    await route.handle(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:77: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:72: in app
    response = await func(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
tests/conftest.py:165: in override_get_db
    yield db_session
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:299: in app
    raise e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
app/api/v1/auth.py:29: in login
    return await AuthService.login(db, login_data)
app/services/auth_service.py:76: in login
    user = await AuthService.authenticate_user(db, login_data)
app/services/auth_service.py:39: in authenticate_user
    result = await db.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:455: in execute
    result = await greenlet_spawn(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2308: in execute
    return self._execute_internal(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2180: in _execute_internal
    conn = self._connection_for_bind(bind)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2047: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
<string>:2: in _connection_for_bind
    ???
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1143: in _connection_for_bind
    conn = bind.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3269: in connect
    return self._connection_cls(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:3293: in raw_connection
    return self.pool.connect()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:452: in connect
    return _ConnectionFairy._checkout(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1368: in _checkout
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py:1306: in _checkout
    result = pool._dialect._do_ping_w_event(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:709: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1142: in do_ping
    dbapi_connection.ping()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:818: in ping
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:816: in ping
    _ = self.await_(self._async_ping())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:825: in _async_ping
    await tr.start()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:350: in execute
    result = await self._protocol.query(query, timeout)
asyncpg/protocol/protocol.pyx:374: in query
    ???
E   RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:661]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x11831c220>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x11831f4c0>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 627, in close
RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:661]> got Future <Future pending> attached to a different loop
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1765 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 902, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
________________________ TestLogout.test_logout_success ________________________
tests/test_auth.py:116: in test_logout_success
    login_response = client.post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:593: in post
    return super().post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:468: in request
    return super().request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:344: in handle_request
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:341: in handle_request
    portal.call(self.app, scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:762: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:782: in app
    await route.handle(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:77: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:72: in app
    response = await func(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
tests/conftest.py:165: in override_get_db
    yield db_session
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:299: in app
    raise e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
app/api/v1/auth.py:29: in login
    return await AuthService.login(db, login_data)
app/services/auth_service.py:76: in login
    user = await AuthService.authenticate_user(db, login_data)
app/services/auth_service.py:39: in authenticate_user
    result = await db.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:455: in execute
    result = await greenlet_spawn(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2308: in execute
    return self._execute_internal(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2190: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/context.py:293: in orm_execute_statement
    result = conn.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2347: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:661]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x11831e110>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
______________________ TestChatAPI.test_get_chat_history _______________________
tests/test_chat_api.py:57: in test_get_chat_history
    assert response.status_code == status.HTTP_200_OK
E   assert 500 == 200
E    +  where 500 = <Response [500 Internal Server Error]>.status_code
E    +  and   200 = status.HTTP_200_OK
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x1183d6c50>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x118055d50>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 627, in close
RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:661]> got Future <Future pending> attached to a different loop
_________________ TestChatAPI.test_get_chat_history_not_found __________________
tests/test_chat_api.py:69: in test_get_chat_history_not_found
    assert response.status_code == status.HTTP_404_NOT_FOUND
E   assert 500 == 404
E    +  where 500 = <Response [500 Internal Server Error]>.status_code
E    +  and   404 = status.HTTP_404_NOT_FOUND
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x11831c5e0>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 627, in close
RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:661]> got Future <Future pending> attached to a different loop
__________ TestChatService.test_process_chat_message_new_conversation __________
tests/test_chat_service.py:68: in test_process_chat_message_new_conversation
    assert conversation is not None
E   assert None is not None
_______________ TestEscalation.test_emergency_keyword_escalation _______________
tests/test_escalation.py:109: in test_emergency_keyword_escalation
    assert escalation_info.trigger_type == "keyword"
E   AssertionError: assert 'safety_category' == 'keyword'
E     - keyword
E     + safety_category
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x11e642e30>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
____________ TestAuthFlow.test_login_and_access_protected_endpoint _____________
tests/test_integration.py:22: in test_login_and_access_protected_endpoint
    login_response = client.post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:593: in post
    return super().post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:468: in request
    return super().request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:344: in handle_request
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:341: in handle_request
    portal.call(self.app, scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:762: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:782: in app
    await route.handle(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:77: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:72: in app
    response = await func(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
tests/conftest.py:165: in override_get_db
    yield db_session
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:299: in app
    raise e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
app/api/v1/auth.py:29: in login
    return await AuthService.login(db, login_data)
app/services/auth_service.py:76: in login
    user = await AuthService.authenticate_user(db, login_data)
app/services/auth_service.py:39: in authenticate_user
    result = await db.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:455: in execute
    result = await greenlet_spawn(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2308: in execute
    return self._execute_internal(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2190: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/context.py:293: in orm_execute_statement
    result = conn.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2347: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:661]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x11f2466b0>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_____________________ TestChatFlow.test_chat_history_flow ______________________
tests/test_integration.py:98: in test_chat_history_flow
    assert response.status_code == status.HTTP_200_OK
E   assert 500 == 200
E    +  where 500 = <Response [500 Internal Server Error]>.status_code
E    +  and   200 = status.HTTP_200_OK
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x11831cc70>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 627, in close
RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:661]> got Future <Future pending> attached to a different loop
_____________________ TestErrorHandling.test_invalid_json ______________________
tests/test_integration.py:212: in test_invalid_json
    login_response = client.post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:593: in post
    return super().post(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:468: in request
    return super().request(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:344: in handle_request
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/testclient.py:341: in handle_request
    portal.call(self.app, scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.pyenv/versions/3.11.1/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:762: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:782: in app
    await route.handle(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:77: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/starlette/routing.py:72: in app
    response = await func(request)
../../../.pyenv/versions/3.11.1/lib/python3.11/contextlib.py:222: in __aexit__
    await self.gen.athrow(typ, value, traceback)
tests/conftest.py:165: in override_get_db
    yield db_session
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:299: in app
    raise e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
app/api/v1/auth.py:29: in login
    return await AuthService.login(db, login_data)
app/services/auth_service.py:76: in login
    user = await AuthService.authenticate_user(db, login_data)
app/services/auth_service.py:39: in authenticate_user
    result = await db.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:455: in execute
    result = await greenlet_spawn(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:200: in greenlet_spawn
    result = context.throw(*sys.exc_info())
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2308: in execute
    return self._execute_internal(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2190: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/context.py:293: in orm_execute_statement
    result = conn.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2347: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:799: in _handle_exception
    raise error
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/from_thread.py:217> cb=[TaskGroup._spawn.<locals>.task_done() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:661]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
______________ TestOvernightQueue.test_send_overnight_auto_reply _______________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   asyncpg.exceptions.ForeignKeyViolationError: insert or update on table "conversations" violates foreign key constraint "conversations_facility_id_fkey"
E   DETAIL:  Key (facility_id)=(1) is not present in table "facilities".

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.ForeignKeyViolationError'>: insert or update on table "conversations" violates foreign key constraint "conversations_facility_id_fkey"
E   DETAIL:  Key (facility_id)=(1) is not present in table "facilities".

The above exception was the direct cause of the following exception:
tests/test_overnight_queue.py:118: in test_send_overnight_auto_reply
    await db_session.commit()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:1011: in commit
    await greenlet_spawn(self.sync_session.commit)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:202: in greenlet_spawn
    result = context.switch(value)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1969: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1256: in commit
    self._prepare_impl()
<string>:2: in _prepare_impl
    ???
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1231: in _prepare_impl
    self.session.flush()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4312: in flush
    self._flush(objects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4447: in _flush
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4408: in _flush
    flush_context.execute()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py:1227: in _emit_insert_statements
    result = connection.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2344: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.ForeignKeyViolationError'>: insert or update on table "conversations" violates foreign key constraint "conversations_facility_id_fkey"
E   DETAIL:  Key (facility_id)=(1) is not present in table "facilities".
E   [SQL: INSERT INTO conversations (facility_id, session_id, guest_language, location, user_agent, ip_address, started_at, last_activity_at, ended_at, is_escalated, total_messages, auto_resolved) VALUES ($1::INTEGER, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6, $7::TIMESTAMP WITH TIME ZONE, $8::TIMESTAMP WITH TIME ZONE, $9::TIMESTAMP WITH TIME ZONE, $10::BOOLEAN, $11::INTEGER, $12::BOOLEAN) RETURNING conversations.id]
E   [parameters: (1, 'test-session-3', 'en', None, None, None, datetime.datetime(2025, 12, 1, 0, 45, 35, 808199), datetime.datetime(2025, 12, 1, 0, 45, 35, 808203), None, False, 0, False)]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x11f246c50>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_______________ TestSessionTokenVerify.test_verify_token_success _______________
tests/test_session_token.py:19: in test_verify_token_success
    conversation = Conversation(
<string>:4: in __init__
    ???
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state.py:566: in _initialize_instance
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state.py:564: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/decl_base.py:2142: in _declarative_constructor
    raise TypeError(
E   TypeError: 'language' is an invalid keyword argument for Conversation
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x11f244e50>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_______________ TestSessionTokenVerify.test_verify_token_expired _______________
tests/test_session_token.py:60: in test_verify_token_expired
    conversation = Conversation(
<string>:4: in __init__
    ???
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state.py:566: in _initialize_instance
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state.py:564: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/decl_base.py:2142: in _declarative_constructor
    raise TypeError(
E   TypeError: 'language' is an invalid keyword argument for Conversation
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x11857cf40>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
__________________ TestSessionLink.test_link_session_success ___________________
tests/test_session_token.py:93: in test_link_session_success
    primary_conversation = Conversation(
<string>:4: in __init__
    ???
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state.py:566: in _initialize_instance
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state.py:564: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/decl_base.py:2142: in _declarative_constructor
    raise TypeError(
E   TypeError: 'language' is an invalid keyword argument for Conversation
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x11857d5d0>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_______________ TestSessionLink.test_link_session_invalid_token ________________
tests/test_session_token.py:139: in test_link_session_invalid_token
    new_conversation = Conversation(
<string>:4: in __init__
    ???
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state.py:566: in _initialize_instance
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state.py:564: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/decl_base.py:2142: in _declarative_constructor
    raise TypeError(
E   TypeError: 'language' is an invalid keyword argument for Conversation
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x11857dd50>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_______________ TestSessionLink.test_link_session_expired_token ________________
tests/test_session_token.py:163: in test_link_session_expired_token
    new_conversation = Conversation(
<string>:4: in __init__
    ???
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state.py:566: in _initialize_instance
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state.py:564: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/decl_base.py:2142: in _declarative_constructor
    raise TypeError(
E   TypeError: 'language' is an invalid keyword argument for Conversation
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x1183d55d0>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_______________ TestSessionLink.test_link_session_wrong_facility _______________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:546: in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:241: in __bind_execute
    data, status, _ = await self.__do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/prepared_stmt.py:230: in __do_execute
    return await executor(protocol)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   asyncpg.exceptions.ForeignKeyViolationError: insert or update on table "session_tokens" violates foreign key constraint "fk_session_tokens_primary_session_id"
E   DETAIL:  Key (primary_session_id)=(other-session) is not present in table "conversations".

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.ForeignKeyViolationError'>: insert or update on table "session_tokens" violates foreign key constraint "fk_session_tokens_primary_session_id"
E   DETAIL:  Key (primary_session_id)=(other-session) is not present in table "conversations".

The above exception was the direct cause of the following exception:
tests/test_session_token.py:218: in test_link_session_wrong_facility
    await db_session.commit()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:1011: in commit
    await greenlet_spawn(self.sync_session.commit)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:202: in greenlet_spawn
    result = context.switch(value)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1969: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1256: in commit
    self._prepare_impl()
<string>:2: in _prepare_impl
    ???
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1231: in _prepare_impl
    self.session.flush()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4312: in flush
    self._flush(objects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4447: in _flush
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4408: in _flush
    flush_context.execute()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py:1227: in _emit_insert_statements
    result = connection.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2344: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.ForeignKeyViolationError'>: insert or update on table "session_tokens" violates foreign key constraint "fk_session_tokens_primary_session_id"
E   DETAIL:  Key (primary_session_id)=(other-session) is not present in table "conversations".
E   [SQL: INSERT INTO session_tokens (facility_id, token, primary_session_id, linked_session_ids, expires_at) VALUES ($1::INTEGER, $2::VARCHAR, $3::VARCHAR, $4::TEXT[], $5::TIMESTAMP WITH TIME ZONE) RETURNING session_tokens.id, session_tokens.created_at]
E   [parameters: (192, 'OTHER', 'other-session', [], datetime.datetime(2025, 12, 2, 0, 46, 41, 116526, tzinfo=datetime.timezone.utc))]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
------------------------------ Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x11857e4d0>>
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 377, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1109, in do_terminate
    dbapi_connection.terminate()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 892, in terminate
    self.await_(self._connection.close(timeout=2))
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 626, in close
  File "asyncpg/protocol/protocol.pyx", line 659, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1611, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 434, in create_task
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_____________ TestVectorSearch.test_search_similar_faqs_with_data ______________
tests/test_vector_search.py:82: in test_search_similar_faqs_with_data
    assert len(result) > 0
E   assert 0 > 0
E    +  where 0 = len([])
------------------------------ Captured log call -------------------------------
ERROR    app.ai.vector_search:vector_search.py:90 pgvector search error
Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 522, in _prepare_and_execute
    prepared_stmt, attributes = await adapt_connection._prepare(
                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 773, in _prepare
    prepared_stmt = await self._connection.prepare(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 636, in prepare
    return await self._prepare(
           ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 654, in _prepare
    stmt = await self._get_statement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 433, in _get_statement
    statement = await self._protocol.prepare(
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "asyncpg/protocol/protocol.pyx", line 166, in prepare
asyncpg.exceptions.UndefinedFunctionError: function cosine_distance(vector, character varying) does not exist
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1969, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 922, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 580, in execute
    self._adapt_connection.await_(
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 558, in _prepare_and_execute
    self._handle_exception(error)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 509, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 797, in _handle_exception
    raise translated_error from error
sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.ProgrammingError: <class 'asyncpg.exceptions.UndefinedFunctionError'>: function cosine_distance(vector, character varying) does not exist
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/kurinobu/projects/yadopera/backend/app/ai/vector_search.py", line 66, in search_similar_faqs
    result = await db.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py", line 455, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 200, in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2308, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2190, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 293, in orm_execute_statement
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1416, in execute
    return meth(
           ^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 517, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1639, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1848, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1988, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2344, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1969, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 922, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 580, in execute
    self._adapt_connection.await_(
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 558, in _prepare_and_execute
    self._handle_exception(error)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 509, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 797, in _handle_exception
    raise translated_error from error
sqlalchemy.exc.ProgrammingError: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: function cosine_distance(vector, character varying) does not exist
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT faqs.id, faqs.facility_id, faqs.category, faqs.language, faqs.question, faqs.answer, faqs.embedding, faqs.priority, faqs.is_active, faqs.created_by, faqs.created_at, faqs.updated_at, $1::INTEGER - cosine_distance(faqs.embedding, $2::VARCHAR) AS similarity 
FROM faqs 
WHERE faqs.facility_id = $3::INTEGER AND faqs.is_active = true AND faqs.embedding IS NOT NULL ORDER BY cosine_distance(faqs.embedding, $4::VARCHAR) ASC 
 LIMIT $5::INTEGER]
[parameters: (1, '[0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1, ... (5847 characters truncated) ... ,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1]', 193, '[0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1, ... (5847 characters truncated) ... ,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1]', 3)]
(Background on this error at: https://sqlalche.me/e/20/f405)
___________ TestVectorSearch.test_search_similar_patterns_with_data ____________
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:522: in _prepare_and_execute
    prepared_stmt, attributes = await adapt_connection._prepare(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:773: in _prepare
    prepared_stmt = await self._connection.prepare(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:636: in prepare
    return await self._prepare(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:654: in _prepare
    stmt = await self._get_statement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py:433: in _get_statement
    statement = await self._protocol.prepare(
asyncpg/protocol/protocol.pyx:166: in prepare
    ???
E   asyncpg.exceptions.GeneratedAlwaysError: cannot insert a non-DEFAULT value into column "resolution_rate"
E   DETAIL:  Column "resolution_rate" is a generated column.

The above exception was the direct cause of the following exception:
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.ProgrammingError: <class 'asyncpg.exceptions.GeneratedAlwaysError'>: cannot insert a non-DEFAULT value into column "resolution_rate"
E   DETAIL:  Column "resolution_rate" is a generated column.

The above exception was the direct cause of the following exception:
tests/test_vector_search.py:128: in test_search_similar_patterns_with_data
    await db_session.commit()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:1011: in commit
    await greenlet_spawn(self.sync_session.commit)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:202: in greenlet_spawn
    result = context.switch(value)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1969: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1256: in commit
    self._prepare_impl()
<string>:2: in _prepare_impl
    ???
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1231: in _prepare_impl
    self.session.flush()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4312: in flush
    self._flush(objects)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4447: in _flush
    with util.safe_reraise():
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4408: in _flush
    flush_context.execute()
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py:1227: in _emit_insert_statements
    result = connection.execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:517: in _execute_on_connection
    return connection._execute_clauseelement(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1639: in _execute_clauseelement
    ret = self._execute_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2344: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py:922: in do_execute
    cursor.execute(statement, parameters)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:130: in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py:195: in greenlet_spawn
    value = await result
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:509: in _handle_exception
    self._adapt_connection._handle_exception(error)
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:797: in _handle_exception
    raise translated_error from error
E   sqlalchemy.exc.ProgrammingError: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.GeneratedAlwaysError'>: cannot insert a non-DEFAULT value into column "resolution_rate"
E   DETAIL:  Column "resolution_rate" is a generated column.
E   [SQL: INSERT INTO question_patterns (facility_id, pattern_embedding, total_count, resolved_count, resolution_rate, last_asked_at) VALUES ($1::INTEGER, $2, $3::INTEGER, $4::INTEGER, $5::NUMERIC(3, 2), $6::TIMESTAMP WITH TIME ZONE) RETURNING question_patterns.id, question_patterns.created_at, question_patterns.updated_at]
E   [parameters: (194, '[0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1, ... (5847 characters truncated) ... ,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1]', 10, 8, None, None)]
E   (Background on this error at: https://sqlalche.me/e/20/f405)
---------------------------- Captured log teardown -----------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:381 Exception closing connection <AdaptedConnection <asyncpg.connection.Connection object at 0x11857e5c0>>
RuntimeError: Task <Task pending name='Task-595' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.finalizer.<locals>.async_finalizer() running at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:327> cb=[_run_until_complete_cb() at /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py:180]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 379, in _close_connection
    self._dialect.do_close(connection)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 701, in do_close
    dbapi_connection.close()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 883, in close
    self.await_(self._connection.close())
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 130, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 195, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/asyncpg/connection.py", line 1467, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 649, in close
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/selector_events.py", line 819, in abort
    self._force_close(None)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/selector_events.py", line 870, in _force_close
    self._loop.call_soon(self._call_connection_lost, exc)
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 761, in call_soon
    self._check_closed()
  File "/Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/asyncio/base_events.py", line 519, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
=============================== warnings summary ===============================
../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/pydantic/_internal/_config.py:271: 20 warnings
  /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pydantic/_internal/_config.py:271: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

../../../.pyenv/versions/3.11.1/lib/python3.11/site-packages/passlib/utils/__init__.py:854
  /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/passlib/utils/__init__.py:854: DeprecationWarning: 'crypt' is deprecated and slated for removal in Python 3.13
    from crypt import crypt as _crypt

tests/test_ai_engine.py::TestRAGEngine::test_process_message_success
  /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/pytest_asyncio/plugin.py:654: DeprecationWarning: There is no current event loop
    old_loop = asyncio.get_event_loop()

tests/test_ai_engine.py: 3 warnings
tests/test_auth.py: 6 warnings
tests/test_chat_api.py: 1 warning
tests/test_chat_service.py: 2 warnings
tests/test_confidence.py: 4 warnings
tests/test_escalation.py: 6 warnings
tests/test_integration.py: 10 warnings
tests/test_overnight_queue.py: 3 warnings
tests/test_session_token.py: 7 warnings
tests/test_vector_search.py: 2 warnings
  /Users/kurinobu/.pyenv/versions/3.11.1/lib/python3.11/site-packages/_pytest/stash.py:104: RuntimeWarning: coroutine 'Connection._cancel' was never awaited
    del self._storage[key]
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_ai_engine.py::TestRAGEngine::test_process_message_facility_not_found
FAILED tests/test_auth.py::TestLogin::test_login_success - RuntimeError: Task...
FAILED tests/test_auth.py::TestLogin::test_login_invalid_email - RuntimeError...
FAILED tests/test_auth.py::TestLogin::test_login_invalid_password - RuntimeEr...
FAILED tests/test_auth.py::TestLogin::test_login_inactive_user - RuntimeError...
FAILED tests/test_auth.py::TestLogout::test_logout_success - RuntimeError: Ta...
FAILED tests/test_chat_api.py::TestChatAPI::test_get_chat_history - assert 50...
FAILED tests/test_chat_api.py::TestChatAPI::test_get_chat_history_not_found
FAILED tests/test_chat_service.py::TestChatService::test_process_chat_message_new_conversation
FAILED tests/test_escalation.py::TestEscalation::test_emergency_keyword_escalation
FAILED tests/test_integration.py::TestAuthFlow::test_login_and_access_protected_endpoint
FAILED tests/test_integration.py::TestChatFlow::test_chat_history_flow - asse...
FAILED tests/test_integration.py::TestErrorHandling::test_invalid_json - Runt...
FAILED tests/test_overnight_queue.py::TestOvernightQueue::test_send_overnight_auto_reply
FAILED tests/test_session_token.py::TestSessionTokenVerify::test_verify_token_success
FAILED tests/test_session_token.py::TestSessionTokenVerify::test_verify_token_expired
FAILED tests/test_session_token.py::TestSessionLink::test_link_session_success
FAILED tests/test_session_token.py::TestSessionLink::test_link_session_invalid_token
FAILED tests/test_session_token.py::TestSessionLink::test_link_session_expired_token
FAILED tests/test_session_token.py::TestSessionLink::test_link_session_wrong_facility
FAILED tests/test_vector_search.py::TestVectorSearch::test_search_similar_faqs_with_data
FAILED tests/test_vector_search.py::TestVectorSearch::test_search_similar_patterns_with_data
ERROR tests/test_integration.py::TestAdminFlow::test_dashboard_access - Runti...
ERROR tests/test_integration.py::TestAdminFlow::test_faq_list_access - Runtim...
ERROR tests/test_integration.py::TestAdminFlow::test_faq_create_flow - Runtim...
ERROR tests/test_integration.py::TestAdminFlow::test_faq_suggestions_access
ERROR tests/test_integration.py::TestAdminFlow::test_overnight_queue_access
ERROR tests/test_integration.py::TestAdminFlow::test_qr_code_generation_access
ERROR tests/test_integration.py::TestResponseTime::test_dashboard_response_time
ERROR tests/test_integration.py::TestResponseTime::test_faq_list_response_time
= 22 failed, 39 passed, 2 skipped, 66 warnings, 8 errors in 761.23s (0:12:41) ==
